/**
 * ğŸ’£ ìì • í­íŒŒ ìˆ˜ë‹¤ë°© (SERVER / Code.gs)
 * - ì‹œíŠ¸ì—ëŠ” "ë°© ìƒì„±/í­íŒŒ" ê¸°ë¡ë§Œ ë‚¨ê¹€
 * - ì±„íŒ…/ì ‘ì†ì/ê³µì§€/BGM: Firebase Realtime DBì—ì„œ ì²˜ë¦¬(í´ë¼ì´ì–¸íŠ¸)
 *
 * âœ… FIX
 * 1) í´ë¼ì´ì–¸íŠ¸ê°€ joinOrPingìœ¼ë¡œ sessionIdë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ê³ ,
 *    ë°”ë€Œë©´ ìë™ ìƒˆë¡œê³ ì¹¨/ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ê°ˆì•„íƒ€ê²Œ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ìœ ì§€
 * 2) ë¹„ë°€ë²ˆí˜¸(PIN) ì…ë ¥ ì‹œ ì„¸ì…˜ ê°•ì œ ì´ˆê¸°í™”(resetSessionWithPin) ì¶”ê°€
 */

const APP_TITLE = 'ğŸ’£ ìì • í­íŒŒ ìˆ˜ë‹¤ë°©';
const TZ = 'Asia/Seoul';

// ì‹œíŠ¸ ë¡œê·¸(ë°© ìƒì„±/ì¢…ë£Œë§Œ)
const ROOM_LOG_SHEET = 'RoomLog';

// Script Properties keys
const KEY_SESSION_ID = 'VENT_ROOM_SESSION_ID_V1';
const KEY_SESSION_CREATED_AT = 'VENT_ROOM_CREATED_AT_V1';

// âœ… Admin PIN (ë¹„ë°€ë²ˆí˜¸) - Script Properties
const KEY_ADMIN_PIN = 'VENT_ROOM_ADMIN_PIN_V1';
// âœ… PIN ì‹¤íŒ¨ íšŸìˆ˜ ì œí•œ(í´ë¼ì´ì–¸íŠ¸ID ê¸°ì¤€)
const PIN_FAIL_CACHE_PREFIX = 'VENT_PIN_FAIL_';
const PIN_FAIL_MAX = 8;          // ìµœëŒ€ 8ë²ˆ ì‹¤íŒ¨
const PIN_FAIL_WINDOW_SEC = 10*60; // 10ë¶„

// ---------------------------
// WebApp
// ---------------------------
function doGet(e) {
  // âœ… api=active â†’ ì„œë²„ê°€ ê³„ì‚°í•œ 'í˜„ì¬ í™œì„± ì ‘ì†ì ìˆ˜'ë¥¼ JSONìœ¼ë¡œ ë°˜í™˜ (+ JSONP ì§€ì›)
  try {
    const api = e && e.parameter && e.parameter.api;
    if (api === 'active') {
      // ğŸ”¥ ë¦¬ë¡œ ìˆ˜ë‹¤ë°© ì›ë³¸ì€ ì´ í•¨ìˆ˜ë¥¼ ì´ë¯¸ ì“°ê³  ìˆìŒ
      const r = getActiveClients_(); // { count, names }

      const payload = {
        activeCount: r.count,
        activeNames: r.names
      };

      // âœ… JSONP ì§€ì› (CORS ìš°íšŒ): .../exec?api=active&callback=foo
      const cb = e && e.parameter ? String(e.parameter.callback || '').trim() : '';
      if (cb) {
        if (!/^[\w$.]+$/.test(cb)) {
          return ContentService.createTextOutput('/* bad callback */')
            .setMimeType(ContentService.MimeType.JAVASCRIPT);
        }
        return ContentService.createTextOutput(`${cb}(${JSON.stringify(payload)});`)
          .setMimeType(ContentService.MimeType.JAVASCRIPT);
      }

      // ê¸°ë³¸ JSON
      return ContentService.createTextOutput(JSON.stringify(payload))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    // fall through to HTML
  }

  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle(APP_TITLE)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}


// ---------------------------
// Session (room) management
// ---------------------------

/**
 * í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œ:
 * - sessionId ì œê³µ
 * - ìì • í­íŒŒë¡œ sessionIdê°€ ë°”ë€Œë©´ í´ë¼ëŠ” ìë™ reload í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŒ
 */
function joinOrPing(clientId, name) {
  // âœ… ì„œë²„ìª½ í™œì„± ì ‘ì†ì ì§‘ê³„(ì‹œíŠ¸ ì „ê´‘íŒ/ì™¸ë¶€ í´ë§ìš©)
  try { touchActive_(clientId, name); } catch (e) {}

  const sess = getOrCreateSession_('PING');
  return {
    ok: true,
    sessionId: sess.sessionId,
    createdAt: sess.createdAt,
    serverNow: Date.now(),
  };
}

/** (ì„ íƒ) ê´€ë¦¬ìš©: í˜„ì¬ ì„¸ì…˜ ê°•ì œ í­íŒŒ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€) */
function forceResetSession() {
  const sess = createNewSession_('MANUAL_FORCE_RESET');
  return { ok: true, sessionId: sess.sessionId, createdAt: sess.createdAt };
}

/**
 * âœ… ë¹„ë°€ë²ˆí˜¸ë¡œ ì„¸ì…˜ ê°•ì œ í­íŒŒ
 * - í´ë¼ì—ì„œ "/í­íŒŒ 1234" ê°™ì€ ì»¤ë§¨ë“œë¡œ í˜¸ì¶œí•˜ëŠ” ìš©ë„
 * - ì‹¤íŒ¨ íšŸìˆ˜ ì œí•œ(ë¸Œë£¨íŠ¸í¬ìŠ¤ ë°©ì§€)
 */
function resetSessionWithPin(pin, clientId, name) {
  const sp = PropertiesService.getScriptProperties();
  const saved = String(sp.getProperty(KEY_ADMIN_PIN) || '').trim();

  // PIN ë¯¸ì„¤ì •ì´ë©´ ë§‰ê¸°
  if (!saved) {
    return { ok: false, code: 'PIN_NOT_SET', message: 'ì„œë²„ì— ë¹„ë°€ë²ˆí˜¸(PIN)ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”.' };
    }
  const input = String(pin || '').trim();
  const cid = String(clientId || '').slice(0, 80) || 'no_client';
  const nm = String(name || 'ìµëª…').trim().slice(0, 12) || 'ìµëª…';

  // ì‹¤íŒ¨ ì œí•œ ì²´í¬
  const cache = CacheService.getScriptCache();
  const failKey = PIN_FAIL_CACHE_PREFIX + cid;
  const failRaw = cache.get(failKey);
  const failCnt = Number(failRaw || 0);

  if (failCnt >= PIN_FAIL_MAX) {
    return { ok: false, code: 'PIN_LOCKED', message: 'ë¹„ë°€ë²ˆí˜¸ ì‹œë„ íšŸìˆ˜ê°€ ì´ˆê³¼ëì–´ìš”(10ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„ ê°€ëŠ¥).' };
  }

  if (input !== saved) {
    cache.put(failKey, String(failCnt + 1), PIN_FAIL_WINDOW_SEC);
    return { ok: false, code: 'PIN_WRONG', message: 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”.' };
  }

  // ì„±ê³µ â†’ ì‹¤íŒ¨ ì¹´ìš´í„° ë¦¬ì…‹
  cache.remove(failKey);

  const sess = createNewSession_(`ADMIN_PIN_RESET by ${nm}`);
  return { ok: true, sessionId: sess.sessionId, createdAt: sess.createdAt };
}

/** âœ… ë¹„ë°€ë²ˆí˜¸ ì„¤ì •(ì„œë²„ì—ì„œ 1íšŒ ì‹¤í–‰) */
function setAdminPin(pin) {
  const p = String(pin || 'mama09mm').trim();
  if (!p || p.length < 4) {
    return { ok: false, message: 'PINì€ ìµœì†Œ 4ìë¦¬ ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ì¤˜!' };
  }
  PropertiesService.getScriptProperties().setProperty(KEY_ADMIN_PIN, p);
  return { ok: true, message: 'PIN ì„¤ì • ì™„ë£Œ!' };
}

/** íŠ¸ë¦¬ê±°ìš©: ë§¤ì¼ ìì • ê·¼ì²˜ì— ì‹¤í–‰ */
function midnightReset() {
  // "ìì • í­íŒŒ" ì»¨ì…‰ìƒ: ìƒˆ ì„¸ì…˜ ë§Œë“¤ê³  ë
  createNewSession_('MIDNIGHT_RESET');
}

/** ìµœì´ˆ 1íšŒ ì‹¤í–‰: ìì • ë¦¬ì…‹ íŠ¸ë¦¬ê±° ì„¤ì¹˜ */
function installMidnightResetTrigger() {
  // ì¤‘ë³µ ë°©ì§€: ê¸°ì¡´ íŠ¸ë¦¬ê±° ì œê±° í›„ ìƒˆë¡œ ìƒì„±
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => {
    if (t.getHandlerFunction() === 'midnightReset') ScriptApp.deleteTrigger(t);
  });

  // 00:01 ê·¼ì²˜(êµ¬ê¸€ íŠ¸ë¦¬ê±° íŠ¹ì„±ìƒ ì•½ê°„ì˜ ì§€ì—°ì€ ìˆì„ ìˆ˜ ìˆì–´)
  ScriptApp.newTrigger('midnightReset')
    .timeBased()
    .everyDays(1)
    .atHour(0)
    .nearMinute(1)
    .create();

  return { ok: true, message: 'ë§¤ì¼ 00:01 ê·¼ì²˜ ìì • í­íŒŒ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì¹˜í–ˆì–´ìš”.' };
}

// ---------------------------
// Internal helpers
// ---------------------------
function getOrCreateSession_(reason) {
  const sp = PropertiesService.getScriptProperties();
  const sessionId = sp.getProperty(KEY_SESSION_ID);
  const createdAt = Number(sp.getProperty(KEY_SESSION_CREATED_AT) || 0);

  // ì—†ìœ¼ë©´ ìƒì„±
  if (!sessionId || !createdAt) {
    return createNewSession_(reason || 'AUTO_CREATE');
  }
  return { sessionId, createdAt };
}

function createNewSession_(reason) {
  const sp = PropertiesService.getScriptProperties();

  const now = new Date();
  const dateKey = Utilities.formatDate(now, TZ, 'yyyyMMdd');
  const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
  const newSessionId = `${dateKey}-${rand}`;
  const createdAt = Date.now();

  const oldSessionId = sp.getProperty(KEY_SESSION_ID) || '';

  sp.setProperty(KEY_SESSION_ID, newSessionId);
  sp.setProperty(KEY_SESSION_CREATED_AT, String(createdAt));

  // ì‹œíŠ¸ì— ê¸°ë¡(OPEN/CLOSE)
  appendRoomLog_('CLOSE', oldSessionId || '-', reason);
  appendRoomLog_('OPEN', newSessionId, reason);

  return { sessionId: newSessionId, createdAt };
}

function appendRoomLog_(eventType, sessionId, reason) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ensureRoomLogSheet_(ss);

  const ts = new Date();
  const iso = Utilities.formatDate(ts, TZ, "yyyy-MM-dd HH:mm:ss");
  sh.appendRow([iso, eventType, sessionId, reason || '']);
}

function ensureRoomLogSheet_(ss) {
  let sh = ss.getSheetByName(ROOM_LOG_SHEET);
  if (!sh) sh = ss.insertSheet(ROOM_LOG_SHEET);

  const header = ['timestamp(KST)', 'event', 'sessionId', 'reason'];
  const r1 = sh.getRange(1, 1, 1, header.length).getValues()[0];
  const empty = r1.every(v => String(v || '').trim() === '');

  if (empty) {
    sh.getRange(1, 1, 1, header.length).setValues([header]);
    sh.setFrozenRows(1);
  }
  return sh;
}

// ---------------------------
// âœ… Active presence (server-side)
// - joinOrPing() í˜¸ì¶œ ê¸°ë°˜ìœ¼ë¡œ "ì‚´ì•„ìˆëŠ” ì ‘ì†ì"ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
// - ì‹œíŠ¸ì—ì„œ .../exec?api=active ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
// ---------------------------
const ACTIVE_CACHE_KEY = 'VENT_ACTIVE_MAP_V1';
const ACTIVE_STALE_MS  = 65 * 1000; // 65ì´ˆ ì´ìƒ ping ì—†ìœ¼ë©´ offline ì²˜ë¦¬

function touchActive_(clientId, name) {
  const cid = String(clientId || '').slice(0, 80);
  if (!cid) return;

  const nm = String(name || 'ìµëª…').trim().slice(0, 12) || 'ìµëª…';
  const now = Date.now();

  const cache = CacheService.getScriptCache();
  const raw = cache.get(ACTIVE_CACHE_KEY);
  let map = {};
  if (raw) {
    try { map = JSON.parse(raw) || {}; } catch (e) { map = {}; }
  }

  map[cid] = { ts: now, name: nm };
  pruneActiveMap_(map, now);

  // 30ë¶„ ì €ì¥(ê³„ì† ê°±ì‹ ë˜ë¯€ë¡œ ì‹¤ì§ˆì ìœ¼ë¡œ ìœ ì§€)
  cache.put(ACTIVE_CACHE_KEY, JSON.stringify(map), 60 * 30);
}

function getActiveClients_() {
  const now = Date.now();
  const cache = CacheService.getScriptCache();
  const raw = cache.get(ACTIVE_CACHE_KEY);
  let map = {};
  if (raw) {
    try { map = JSON.parse(raw) || {}; } catch (e) { map = {}; }
  }

  const alive = [];
  for (const cid of Object.keys(map)) {
    const v = map[cid];
    const ts = Number(v && v.ts);
    if (!ts) continue;
    if ((now - ts) <= ACTIVE_STALE_MS) {
      alive.push(String(v.name || 'ìµëª…').trim().slice(0, 12) || 'ìµëª…');
    }
  }

  // ë³´ê¸° ì¢‹ê²Œ ì •ë ¬
  alive.sort((a, b) => a.localeCompare(b, 'ko'));
  return { count: alive.length, names: alive };
}

function pruneActiveMap_(map, now) {
  // stale ì œê±°
  for (const cid of Object.keys(map)) {
    const ts = Number(map[cid] && map[cid].ts);
    if (!ts || (now - ts) > (ACTIVE_STALE_MS * 5)) {
      delete map[cid];
    }
  }
  // ê·¸ë˜ë„ ë§ìœ¼ë©´ ìµœê·¼ 500ê°œë§Œ ìœ ì§€(ì•ˆì „ì¥ì¹˜)
  const keys = Object.keys(map);
  if (keys.length <= 500) return;
  keys.sort((a, b) => (map[b].ts || 0) - (map[a].ts || 0));
  for (let i = 500; i < keys.length; i++) delete map[keys[i]];
}
