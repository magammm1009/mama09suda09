<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>üí£Boom!</title>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --line:#f2d7ea;
      --text:#2b2b2b;
      --muted:#777;
      --chatMsgPx: 15px; /* Ï±ÑÌåÖ(Î©îÏãúÏßÄ) Í∏ÄÏî® ÌÅ¨Í∏∞ */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg);
      color: var(--text);
      /* viewport ÏïàÏ†ïÌôî(Î™®Î∞îÏùº Ï£ºÏÜåÏ∞Ω/Î∞∞ÎÑà Î≥ÄÎèô Ìè¨Ìï®) */
      min-height: 100vh;
      min-height: calc(var(--vh, 1vh) * 100);
      overflow-x: hidden;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      min-width: 0;
    }
    .icon{
      width:34px;height:34px; display:grid; place-items:center;
      border-radius:12px; background:#ffd1e8;
    }
    .metaSmall{ font-size:12px; color: var(--muted); font-weight:700; margin-top:2px; }
    
    /* üìå Topbar notice pin */
    .brandInfo{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brandText{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .pinBtn{
      width:34px;height:34px; padding:0;
      display:grid; place-items:center;
      border-radius:12px;
      background: rgba(255, 209, 232, .35);
      border: 1px solid rgba(0,0,0,.10);
      font-size: 18px;
      position: relative;
    }
    .pinBtn:hover{ filter:brightness(0.98); }
    .pinBtn.pinNew::after{
      content:"";
      position:absolute;
      top:6px; right:6px;
      width:8px; height:8px;
      border-radius:999px;
      background:#ff4d6d;
      box-shadow: 0 0 0 3px rgba(255,77,109,.18);
    }
    @keyframes pinSwing{
      0%{ transform: rotate(0deg); }
      20%{ transform: rotate(-10deg); }
      40%{ transform: rotate(12deg); }
      60%{ transform: rotate(-8deg); }
      80%{ transform: rotate(8deg); }
      100%{ transform: rotate(0deg); }
    }
    .pinBtn.pinNew{
      transform-origin: 50% 0%;
      animation: pinSwing 1.2s ease-in-out infinite;
    }

    /* ü™ü Overlay resizable mode (for games) */
    .overlayCard.resizable{
      resize: both;
      overflow: auto;
      max-width: 95vw;
      max-height: 90vh;
      min-width: 340px;
      min-height: 460px;
    }

    .actions{ display:flex; gap:8px; align-items:center; position:relative; }
    button{
      border: 0;
      background:#fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ filter:brightness(0.99); }

    /* ‚úÖ DJ Ïû¨ÏÉùÎ™©Î°ù: ÌÅ∞ ÏûêÎèôÏû¨ÏÉù Î≤ÑÌäº */
    .bigPlayBtn{
      border: 1px dashed var(--line);
      background: rgba(255, 209, 232, .30);
      color: #5a2b44;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 1000;
      font-size: 15px;
    }
    .bigPlayBtn:hover{ filter: brightness(0.98); }

    .pill{
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      background:#fff;
    }
    .layout{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap: 12px;
    }
    
@media (max-width: 760px){
      :root{ --chatMsgPx: 14px; }
  /* ‚úÖ Î™®Î∞îÏùº: ÌôîÎ©¥ÏùÑ 'Ìïú ÌéòÏù¥ÏßÄ'Î°ú Í≥†Ï†ïÌïòÍ≥†, Ï±ÑÌåÖ(#log)Îßå Ïä§ÌÅ¨Î°§ÎêòÍ≤å */
  html, body{
    height: calc(var(--vh, 1vh) * 100);
  }
  body{
    overflow: hidden; /* ÌéòÏù¥ÏßÄ ÎäòÏñ¥Ïßê Î∞©ÏßÄ */
  }
  .wrap{
    height: 100%;
    max-width: 100%;
  }
  .layout{
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  /* ÏÇ¨Ïù¥Îìú Ïπ¥Îìú(Ï†ëÏÜçÏûê)Îäî Î™®Î∞îÏùºÏóêÏÑú Ìïú Ï§Ñ/Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§Î°ú Ïª¥Ìå©Ìä∏ÌïòÍ≤å */
  .side{
    padding: 10px 12px;
  }
  .onlineList{
    display:flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    max-height: 44px;
    padding-bottom: 2px;
  }
  .nameChip{ white-space: nowrap; }
  .side .hint{
    margin-top: 6px !important;
    font-size: 12px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Î©îÏù∏ Ï±ÑÌåÖ Ïπ¥ÎìúÍ∞Ä ÎÇ®ÏùÄ ÎÜíÏù¥Î•º ÍΩâ Ï±ÑÏö∞Í≥†, #logÎßå Ïä§ÌÅ¨Î°§ */
  .layout > .card:not(.side){
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  #log{
    flex: 1 1 auto;
    min-height: 0;
    height: auto;
  }

  /* ‚úÖ Î™®Î∞îÏùº Ï†ëÏÜçÏûê ÏúÑÏπò Ï°∞Ï†ï */
  .side{ margin-top: 0; }
  .side h3{ margin-bottom: 6px; }
  .onlineList{ max-height: 140px; }
  .wrap{ padding: 10px; padding-top: calc(10px + var(--chromeTop, 0px)); }
  .layout{ grid-template-columns: 1fr; }
  .side{ order: -1; }

  /* ‚úÖ Î™®Î∞îÏùº ÏïàÏ†ïÌôî */
  input, textarea{ font-size: 16px; } /* iOS ÏûêÎèô ÌôïÎåÄ Î∞©ÏßÄ */
  body{ padding-bottom: env(safe-area-inset-bottom); }
  #log{ -webkit-overflow-scrolling: touch; }
  .topbar{ position: sticky; top: var(--chromeTop, 0px); z-index: 60; padding-top: calc(10px + env(safe-area-inset-top)); }

  /* Ï±ÑÌåÖ ÏûÖÎ†•Ï∞Ω: ÏûêÎèô ÌôïÏû• Î∞©ÏßÄ(ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÎäòÎ¶¨ÏßÄ ÏïäÏúºÎ©¥ Í≥†Ï†ï) */
  #msg{
    height: 38px !important;
    max-height: 38px !important;
    overflow-y: auto !important;
    resize: none !important;
  }

  /* Î™®Î∞îÏùºÏóêÏÑ† Ï†ÑÏÜ° Î≤ÑÌäº Ï†úÍ±∞(Enter=Ï†ÑÏÜ°) */
  #sendBtn{ display:none !important; }
  .sendRow{ grid-template-columns: 1fr !important; }
}
    .card{
      position: relative;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 10px 28px rgba(0,0,0,.06);
      padding: 12px;
    }
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      outline:none;
      background:#fff;
    }
    textarea{ resize: vertical; }
    .nameRow{
      display:flex; align-items:center; gap:8px;
      flex-wrap: nowrap;
      margin-bottom: 10px;
      min-width: 0;
    }
    /* ‚úÖ nameRow: Ìïú Ï§Ñ Ï†ïÎ†¨(PC) */
    .nameRow .noticeBtn{
      height: 44px;
      padding: 0 12px;
      font-size: 14px;
      border-radius: 14px;
      flex: 0 0 auto;
    }
    .nameRow #btnRace,
    .nameRow #btnAcid,
    .nameRow #btnMarble,
    .nameRow #btnRummi{
      min-width: 136px;
    }
    .nameRow #user{
      height: 44px;
      padding: 0 10px;
      flex: 0 0 120px;
      width: 120px;
      border-radius: 14px;
    }
    @media (max-width: 760px){
      .nameRow{ flex-wrap: wrap; }
      .nameRow #btnRace, .nameRow #btnAcid, .nameRow #btnMarble, .nameRow #btnRummi{ min-width: 0; flex: 1 1 160px; }
      .nameRow #user{ flex: 1 1 140px; width: auto; }
    }

    #user{ width: 120px; flex: 0 0 120px; text-align:center; }
    #btnRace, #btnMarble, #btnRummi{ flex: 1 1 210px; min-width: 170px; }
    #btnRace{ }

    /* ‚úÖ ÎØ∏ÎãàÍ≤åÏûÑ Î≤ÑÌäº Ï†ïÎ¶¨ (v25)
       - Î∂ÄÎ£®ÎßàÎ∏î/Î£®ÎØ∏ÌÅêÎ∏å Î≤ÑÌäº Ïà®ÍπÄ
       - ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ Î≤ÑÌäº Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
    

/* ‚úÖ ÎØ∏ÎãàÍ≤åÏûÑ Î≤ÑÌäº 3Ï¢Ö: Í∞ÄÏù¥Îìú/Ï±ÑÌåÖÏ°∞Ï†à Î≤ÑÌäº ÌÜ§Í≥º ÌÜµÏùº */
.miniGameBtn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 10px 12px;
  height: 44px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2b44;
  font-weight: 900;
  font-size: 15px;
  letter-spacing: .1px;
  white-space: nowrap;
  user-select: none;
  cursor: pointer;
}
.miniGameBtn:hover{ filter: brightness(0.98); }
.miniGameBtn:active{ transform: translateY(1px); }

/* nameRowÏóêÏÑú 3Í∞ú Î≤ÑÌäºÏù¥ ÎÇòÎûÄÌûà(PC), Î™®Î∞îÏùºÏùÄ Ï§ÑÎ∞îÍøà */
.nameRow #btnRace,
.nameRow #btnAcid,
.nameRow #btnMarble{
  flex: 1 1 160px;
  min-width: 160px;
}
@media (max-width: 760px){
  .nameRow #btnRace,
  .nameRow #btnAcid,
  .nameRow #btnMarble{
    flex: 1 1 160px;
    min-width: 0;
  }
}

/* ‚úÖ Í≥µÏßÄ Î≤ÑÌäº(ÎΩÄÎ™® Ïù∏Îç±Ïä§ ÎäêÎÇå Í∑∏ÎåÄÎ°ú) */
#btnRace.noticeBtn, #btnMarble.noticeBtn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2b44;
  font-weight: 900;
  font-size: 15px;
  letter-spacing: .1px;
  white-space: nowrap;
  overflow: hidden;
  user-select: none;
  cursor: pointer;
}
#btnRace.noticeBtn:hover, #btnMarble.noticeBtn:hover:hover{ filter: brightness(0.98); }
#btnRace.noticeBtn:active, #btnMarble.noticeBtn:active:active{ transform: translateY(1px); }
#btnRace.noticeBtn .label, #btnMarble.noticeBtn .label .label{
  font-weight: 900;
  flex: 0 0 auto;
}
#btnRace.noticeBtn .preview, #btnMarble.noticeBtn .preview .preview{
  opacity: .75;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 0 1 auto;
  max-width: 70%;
  min-width: 0;
  text-align: left;
}

/* ‚úÖ ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ Î≤ÑÌäº ÌÜ§ */
#btnRace.raceBtn{
  background: rgba(186, 230, 253, .25);
  color: #1f3b52;
  border-style: dashed;
}
    

#btnRace.raceBtn:hover{ filter: brightness(0.985); }

/* ‚úÖ Rummikub button */
#btnRummi.rummiBtn{
  background: rgba(210, 230, 255, .28);
  color: #1f2d52;
  border-style: dashed;
}
#btnRummi.rummiBtn:hover{ filter: brightness(0.985); }


#btnMarble{ flex: 0 0 auto; min-width: 152px; min-height: 46px; }
#btnMarble.noticeBtn{
  background: rgba(255, 229, 153, .28);
  border: 1px dashed rgba(180, 140, 30, .35);
  color: #513b0b;
}
#btnMarble.noticeBtn:hover{ filter: brightness(0.985); }
#btnMarble.noticeBtn:active{ transform: translateY(1px); }
#btnMarble.noticeBtn .preview{ opacity: .85; }

/* ‚úÖ Race Start (ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù) ‚Äî ÍΩâ Ï∞¨ Î†àÏù¥Ïä§ ÎäêÎÇå */
.raceStartWrap{ text-align:left; }
.raceStartHero{
  border:1px solid rgba(0,0,0,.06);
  border-radius: 16px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(186,230,253,.20), rgba(255,209,232,.18));
  position: relative;
  overflow:hidden;
}
.raceStartHero:before{
  content:"";
  position:absolute; inset:-40px;
  background:
    radial-gradient(circle at 18% 28%, rgba(255,255,255,.75), transparent 55%),
    radial-gradient(circle at 78% 68%, rgba(255,255,255,.55), transparent 55%),
    repeating-linear-gradient(135deg, rgba(0,0,0,.04) 0 10px, transparent 10px 20px);
  transform: rotate(-2deg);
  opacity:.55;
}
.raceStartHeroInner{ position:relative; display:flex; gap:10px; align-items:center; }
.raceHeroBadge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius: 999px;
  background: rgba(255,255,255,.72);
  border:1px solid rgba(0,0,0,.06);
  font-weight: 950;
}
.raceHeroTrack{
  flex:1;
  border-radius: 14px;
  padding: 10px 10px;
  background: rgba(255,255,255,.74);
  border:1px solid rgba(0,0,0,.06);
}
.trackLane{
  display:flex; align-items:center; gap:10px;
  padding: 6px 8px;
  border-radius: 12px;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,.05) 0 8px, transparent 8px 16px);
  border: 1px dashed rgba(0,0,0,.09);
}
.trackCars{ font-size: 18px; letter-spacing: 2px; }
.trackMeta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.metaPill{
  font-weight: 900; font-size: 12px;
  padding: 6px 10px; border-radius: 999px;
  background: rgba(0,0,0,.04);
  border:1px solid rgba(0,0,0,.06);
}
.raceDiffGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: 12px;
}


.raceDiffPill{
  border: 1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.82);
  border-radius: 999px;
  padding: 8px 14px;
  font-weight: 950;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
}
.raceDiffPill:hover{ transform: translateY(-1px); }
.raceDiffCard{
  text-align:left;
  border-radius: 16px;
  padding: 12px 12px 10px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  cursor:pointer;
  transition: transform .12s ease, filter .12s ease;
}
.raceDiffCard:hover{ filter: brightness(0.99); transform: translateY(-1px); }
.raceDiffCard:active{ transform: translateY(0px); }
.raceDiffTop{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.raceDiffName{ font-weight: 950; font-size: 16px; }
.raceDiffTag{
  font-weight: 950; font-size: 12px;
  padding: 4px 8px; border-radius: 999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(0,0,0,.03);
}
.raceSample{
  margin-top: 8px;
  font-size: 12.5px;
  font-weight: 900;
  line-height: 1.35;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,.03);
  border:1px dashed rgba(0,0,0,.08);
  max-height: 82px;
  overflow:hidden;
}
.raceDiffHint{ margin-top: 8px; font-size: 12px; opacity: .82; font-weight: 850; line-height:1.35; }
.raceDiffCard.low{ background: rgba(255,255,255,.82); }
.raceDiffCard.mid{ background: rgba(255,255,255,.82); }
.raceDiffCard.high{ background: rgba(255,255,255,.82); }
.raceStartRules{
  margin-top: 10px;
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(255,255,255,.62);
  border:1px solid rgba(0,0,0,.06);
}
.raceStartRules ul{ margin: 0; padding-left: 18px; }
.raceStartRules li{ margin: 6px 0; font-weight: 900; opacity:.9; }
.raceStartFoot{
  margin-top: 8px;
  display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
}
.raceLastPick{ font-weight: 950; opacity:.8; }
.raceMiniNote{ font-size: 12px; font-weight: 900; opacity:.75; }

/* ‚úÖ Guide overlay */
.guideWrap{ text-align:left; }
.guideHead{ display:flex; align-items:center; gap:10px; margin-bottom: 10px; }
.guideBadge{
  font-weight: 950;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,209,232,.35);
  border: 1px solid rgba(0,0,0,.06);
}
.guideTitle{ font-weight: 950; font-size: 16px; }
.guidePre{ white-space:pre-wrap; font-size:13px; line-height:1.55; margin:0; }

/* ‚úÖ Rummikub (beta) */
.rkWrap{ text-align:left; }
.rkHead{ display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom: 10px; }
.rkTitle{ font-weight: 1000; font-size: 16px; }
.rkSub{ font-weight: 900; opacity:.82; font-size: 12.5px; }
.rkSetup{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0 6px; }
.rkLbl{ font-weight: 950; opacity:.85; }
.rkSetup select{ padding: 8px 10px; border-radius: 12px; border:1px solid rgba(0,0,0,.12); font-weight: 900; }
.rkCtrl{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0; }
.rkRack{ padding: 10px 12px; border-radius: 14px; background: rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.08); }
.rkRackTiles{ margin-top: 8px; display:flex; flex-wrap:wrap; gap:6px; }
.rkTile{
  display:inline-flex; align-items:center; justify-content:center;
  width: 32px; height: 40px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.92);
  font-weight: 1000;
  user-select:none;
}
.rkTile.joker{ background: rgba(0,0,0,.06); }
.rkTile.cR{ color: #b3242a; }
.rkTile.cB{ color: #1f5fbf; }
.rkTile.cG{ color: #197a4a; }
.rkTile.cK{ color: #111; }
.rkHint{ margin-top: 10px; font-weight: 900; opacity:.8; font-size: 12.5px; line-height:1.4; }


/* ‚úÖ Blue Marble overlay */
.marbleWrap{ text-align:left; }
.marbleTop{
  display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;
  margin-bottom: 10px;
}
.marbleHow{
  flex: 1 1 240px;
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(209,250,229,.34);
  border:1px solid rgba(0,0,0,.06);
  font-weight: 900;
  line-height: 1.45;
}
.marbleBtns{
  flex: 0 0 auto;
  display:flex; gap:8px; align-items:stretch;
}
.marbleBtns button{ white-space:nowrap; font-weight: 950; }
.marbleGrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 8px;
  margin-top: 8px;
}

    .marbleBanner{ display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 14px 0; }
    .turnRow{ display:flex; flex-wrap:wrap; gap:6px; }
    .turnChip{ padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.75); border:1px solid rgba(0,0,0,.08); font-size:13px; }
    .turnChip.cur{ box-shadow: 0 0 0 3px rgba(255,77,109,.18); }
    .turnChip.dead{ opacity:.45; filter: grayscale(1); text-decoration: line-through; }

.marbleTile{
  border-radius: 14px;
  padding: 8px 8px 6px;
  background: rgba(255,255,255,.78);
  border:1px solid rgba(0,0,0,.08);
  min-height: 66px;
  position: relative;
  overflow:hidden;
}
.marbleTile:before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.8), transparent 55%);
  opacity:.45;
  pointer-events:none;
}
.tileTop{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:6px; }
.tileIcon{ font-size: 16px; }
.tileName{ font-weight: 950; font-size: 12px; opacity:.92; }
.tileDesc{ font-weight: 950; font-size: 11px; opacity:.75; }
.tileTokens{ position:relative; margin-top: 6px; display:flex; flex-wrap:wrap; gap:4px; }
.tokenChip{
  display:inline-flex; align-items:center; justify-content:center;
  width: 22px; height: 22px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 950;
  color: #fff;
  border:1px solid rgba(255,255,255,.35);
}
.marblePanels{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap: 10px;
  margin-top: 10px;
}
.marblePanel{
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(0,0,0,.03);
  border:1px solid rgba(0,0,0,.06);
}
.marblePanel h4{ margin:0 0 8px; font-size: 13px; font-weight: 950; }
.rankRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0; font-weight: 950; }
.rankRow .nm{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 160px; }
.rankRow .val{ opacity:.8; }

/* ‚úÖ small screens: nameRow wrap to keep buttons alive */
@media (max-width: 420px){
  .nameRow{ flex-wrap:wrap; }
  #user{ width:100%; flex: 1 1 100%; }
  #btnRace, #btnMarble{ flex: 1 1 calc(50% - 6px); }
}

/* ‚úÖ ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ Î∞î */
.raceBar{
  display:none;
  border: 1px dashed var(--line);
  border-radius: 14px;
  padding: 10px 12px;
  margin: 8px 0 10px;
  background: rgba(186, 230, 253, .18);
}
.raceBar.show{ display:block; }

/* --- Typing Race: mini track + strict mode --- */
.raceMiniTrack{
  margin-top: 8px;
  border-radius: 999px;
  padding: 8px 10px;
  background: rgba(255,255,255,.72);
  border:1px solid rgba(0,0,0,.08);
  position: relative;
  overflow:hidden;
}
.raceMiniTrack:before{
  content:"";
  position:absolute; inset:0;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0 10px, rgba(0,0,0,0) 10px 20px);
  opacity:.28;
  pointer-events:none;
}
.raceLane{ position:relative; height: 22px; margin: 6px 0; }
.raceNamePill{
  position:absolute; left: 0; top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  font-weight: 950;
  padding: 2px 7px;
  border-radius: 999px;
  background: rgba(255,255,255,.88);
  border:1px solid rgba(0,0,0,.08);
  max-width: 44%;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.raceCar{
  position:absolute; top: 50%;
  transform: translate(-50%, -50%);
  transition: left .12s linear;
  font-size: 16px;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
}
.raceCar.medal1{ font-size: 18px; }
.raceCar.medal2{ opacity:.95; }
.raceCar.medal3{ opacity:.9; }

.raceStrictBtn{
  display:inline-flex; align-items:center; justify-content:center;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.85);
  font-weight: 950;
  cursor: pointer;
}
.raceStrictBtn.off{ opacity:.7; }
.raceStrictBtn:active{ transform: translateY(1px); }

#raceInput.eliminated{
  border-color: rgba(255, 0, 90, .35) !important;
  background: rgba(255, 0, 90, .06) !important;
}
.raceBar.eliminated{ animation: raceShake .28s ease-in-out; }
@keyframes raceShake{
  0%{ transform: translateX(0); }
  25%{ transform: translateX(-4px); }
  50%{ transform: translateX(4px); }
  75%{ transform: translateX(-3px); }
  100%{ transform: translateX(0); }
}

.raceTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.raceTitle{ flex:1; min-width:0; }
.raceTitle .tag{
  display:inline-flex; align-items:center; justify-content:center;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px dashed rgba(31,59,82,.25);
  font-weight: 950;
  font-size: 12px;
  background: rgba(255,255,255,.75);
  margin-right: 8px;
  white-space: nowrap;
}
.raceTitle .txt{
  font-weight: 950;
  font-size: 13px;
  color:#23394d;
  line-height: 1.25;
  word-break: keep-all;
}
.raceTools{ display:flex; align-items:center; gap:8px; flex: 0 0 auto; }
.raceTimer{
  font-weight: 950;
  font-size: 12px;
  opacity: .85;
  white-space: nowrap;
}
.raceMiniBtn{
  height: 34px;
  min-width: 34px;
  border-radius: 12px;
  border: 1px dashed var(--line);
  background: rgba(255,255,255,.65);
  font-weight: 950;
  cursor:pointer;
}
#raceInput{
  margin-top: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 950;
}

.raceDiffView{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.85);
  font-weight: 900;
  line-height: 1.35;
}
.raceDiffView .ok{ opacity:.9; }
.raceDiffView .bad{
  background: rgba(255, 59, 59, .18);
  border-bottom: 2px solid rgba(255, 59, 59, .65);
  border-radius: 6px;
  padding: 0 2px;
}
.raceDiffView .miss{
  background: rgba(255, 196, 0, .18);
  border-bottom: 2px solid rgba(255, 196, 0, .65);
  border-radius: 6px;
  padding: 0 2px;
}
.raceHint{
  margin-top: 8px;
  font-size: 12px;
  font-weight: 950;
  color: #7a2b2b;
  background: rgba(255, 236, 236, .8);
  border: 1px solid rgba(255, 120, 120, .25);
  padding: 8px 10px;
  border-radius: 12px;
  display:none;
}
.raceHint.show{ display:block; }
.raceBottom{ display:flex; align-items:center; gap:10px; margin-top: 8px; }
.raceProgress{
  flex: 1;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.7);
  border: 1px solid rgba(31,59,82,.10);
  overflow:hidden;
}
#raceProgBar{
  height:100%;
  width:0%;
  border-radius: 999px;
  background: rgba(31, 59, 82, .55);
  transition: width .12s linear;
}
.raceRank{
  flex: 0 0 auto;
  font-size: 12px;
  font-weight: 950;
  color:#1f3b52;
  opacity: .9;
  white-space: nowrap;
}
.raceScore{
  margin-top: 8px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
}
.raceChip{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px dashed rgba(31,59,82,.25);
  background: rgba(255,255,255,.75);
  font-weight: 950;
  font-size: 12px;
}
.raceChip .sub{ opacity:.75; font-weight: 900; }




/* üèÅ Race track UI */
.raceBar{
  background-image:
    linear-gradient(90deg, rgba(255,255,255,.65), rgba(255,255,255,.65)),
    repeating-linear-gradient(45deg, rgba(31,59,82,.06) 0 12px, rgba(255,255,255,.0) 12px 24px);
  background-blend-mode: normal, multiply;
}
.raceSteps{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px dashed rgba(31,59,82,.18);
  background: rgba(255,255,255,.65);
}
.stepDot{
  flex: 1 1 0;
  height: 16px;
  border-radius: 999px;
  border: 1px solid rgba(31,59,82,.18);
  background: rgba(31,59,82,.06);
  position: relative;
  overflow:hidden;
}
.stepDot::after{
  content:'';
  position:absolute;
  inset:0;
  background: rgba(31,59,82,.42);
  transform: scaleX(0);
  transform-origin: 0% 50%;
  transition: transform .16s ease;
}
.stepDot.done::after{ transform: scaleX(1); }
.stepDot.active{
  box-shadow: 0 0 0 3px rgba(31,59,82,.12);
  background: rgba(31,59,82,.10);
}
.stepDot.active::after{ transform: scaleX(.25); }
.stepFlag{
  flex: 0 0 auto;
  font-size: 14px;
  opacity: .85;
}
.raceHintLine{
  margin-top: 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size: 12px;
  font-weight: 950;
  color:#1f3b52;
  opacity:.9;
}
.raceHintLine .bad{ color:#b10053; }
    
.iconBtnSmall{
  flex: 0 0 auto;
  height: 44px;
  width: 44px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2f44;
  font-weight: 900;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.iconBtnSmall:hover{ transform: translateY(-1px); }

/* ‚úÖ Í≥µÏßÄ(Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© ÏûëÏÑ±) Ïò§Î≤ÑÎ†àÏù¥ UI (ÎΩÄÎ™® Ïä§ÌÉÄÏùº ÌÜ§) */
.noticeBox{ text-align:left; }
.noticeMeta{
  font-size:12px;
  color:#5a2b44;
  opacity:.85;
  font-weight:900;
  margin-bottom:6px;
}
.noticeText{
  white-space:pre-wrap;
  word-break:break-word;
  overflow-wrap:anywhere;
  background: rgba(255, 209, 232, .20);
  border: 1px dashed rgba(0,0,0,0.10);
  padding:10px 12px;
  border-radius:14px;
  line-height:1.55;
  font-weight:800;
  color:#3b2330;
}
.noticeActions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:8px;
  flex-wrap:wrap;
}
.noticeActions .miniBtn{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.08);
  background:#fff;
  color:#333;
  cursor:pointer;
  font-weight:900;
}
.noticeActions .miniBtn:hover{ filter: brightness(0.98); }
.noticeEditArea{
  width:100%;
  min-height:180px;
  resize:vertical;
  border-radius:14px;
  padding:10px 12px;
  border:1px solid rgba(0,0,0,0.12);
  background:#fff;
  color:#222;
  outline:none;
  box-sizing:border-box;
  font-weight:850;
}
.noticeHelp{
  font-size:12px;
  color:#5a2b44;
  opacity:.85;
  font-weight:800;
  margin-top:8px;
}

#noticePreview{
      opacity:.75;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      min-width:0; max-width:70%;
      text-align:left;
    }

    #log{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      height: 320px; /* Í∏∞Î≥∏Í∞í(Ïä¨ÎùºÏù¥ÎçîÎ°ú Ï°∞Ï†à) */
      overflow:auto;
    }

    .jumpBtn{
      position:absolute;
      left:50%;
      bottom: 84px; /* above composer */
      transform: translateX(-50%);
      z-index: 50;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 1000;
      background: rgba(255,255,255,.95);
      box-shadow: 0 14px 40px rgba(0,0,0,.16);
      display:none;
    }
    .jumpBtn.show{ display:inline-flex; align-items:center; gap:8px; }
    .jumpBtn .cnt{
      font-size:12px;
      opacity:.85;
      font-weight:1000;
    }
    .row{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .metaLine{ display:none; font-size:12px; color: var(--muted); font-weight:900; }
    .bubble{
      display:inline-block;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      font-size: var(--chatMsgPx, 15px);
      line-height:1.35;
      font-weight:850;
      box-shadow:none;
    }

    .bubbleRow{
      display:flex;
      align-items:flex-end;
      gap:6px;
      max-width:100%;
    }
    .msgTime{
      font-size:11px;
      color: var(--muted);
      font-weight:900;
      white-space:nowrap;
      opacity:.85;
      flex:0 0 auto;
    }
    .mine .bubbleRow{ justify-content:flex-end; }
    .theirs .bubbleRow{ justify-content:flex-start; }
    .system .bubbleRow{ justify-content:center; }
    .nickBadge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 4px 8px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: 12px;
  margin-right: 8px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.65);
  vertical-align: middle;
}
.nickEmoji{ font-size: 14px; line-height:1; }
.nickName{ font-weight: 1000; }
.msgText{ vertical-align: middle; }

    .mine{ align-items:flex-end; }
    .mine .bubble{ background: #dffaf3; }
    .theirs{ align-items:flex-start; }
    .theirs .bubble{ background: #ffe3ee; }
    .system{ align-items:center; }
    .system .bubble{ background:#fff4cc; border-style:dashed; font-weight:900; }

    .sendRow{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      align-items: end;
    }
    /* PCÏóêÏÑúÎèÑ Ï†ÑÏÜ° Î≤ÑÌäº Ïà®ÍπÄ(Enter=Ï†ÑÏÜ°) */
    #sendBtn{ display:none; }

    .hint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      line-height:1.35;
    }

    .side h3{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 1000;
    }
    .onlineList{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height: 340px;
      overflow:auto;
      padding-right: 4px;
      align-content:flex-start;
    }
    .nameChip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.8);
      font-weight: 900;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      width: fit-content;
      max-width: 100%;
      cursor: default;
      user-select:none;
    }
    .nameChip span{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .nameChip .nm{ max-width: 180px; }
    
    .muted{ color: var(--muted); font-weight:800; }

        .menuPanel{
      position:absolute;
      top: calc(100% + 10px);
      right: 0;
      width: min(360px, 92vw);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      padding: 10px;

      /* ‚úÖ Î©îÎâ¥Í∞Ä Í∏∏Ïñ¥Ï†∏ÎèÑ Î≤ÑÌäº/Í∏∞Îä• Ïïà Ï£ΩÍ≤å: Ìå®ÎÑê ÏûêÏ≤¥ Ïä§ÌÅ¨Î°§ */
      max-height: min(78vh, calc((var(--vh, 1vh) * 100) - 120px));
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scrollbar-gutter: stable;

      display:none;
      z-index: 999;
    }

    /* ‚úÖ Î©îÎâ¥ ÌïòÎã® Ïó¨Î∞±(ÎßàÏßÄÎßâ Î≤ÑÌäº Í∞ÄÎ¶º Î∞©ÏßÄ) */
    .menuPanel::after{ content:''; display:block; height: 8px; }

    .menuPanel.show{ display:block; }
        .menuHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 2px 8px;

      /* ‚úÖ Ïä§ÌÅ¨Î°§ Ï§ëÏóêÎèÑ Îã´Í∏∞ Î≤ÑÌäºÏù¥ Ìï≠ÏÉÅ Î≥¥Ïù¥ÎèÑÎ°ù Í≥†Ï†ï */
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--card);
      padding-top: 6px;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .menuTitle{ font-weight: 1000; }
    .menuClose{ border:0; background:transparent; font-size:18px; padding: 6px 8px; border-radius:10px; }
    .menuClose:hover{ background: rgba(0,0,0,.04); }

    .block{
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.015);
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
    }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .labelRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px; }
    .label{ font-weight: 1000; }
    .val{ font-weight: 1000; color: var(--muted); }
    input[type="range"]{ width: 100%; }

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }

    .overlayCard{
      width:min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      text-align:center;
      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .overlayCard.wide{ width: min(980px, 100%); max-width: min(980px, 100%); }
    .overlayTitle{ font-size:18px; font-weight:1000; margin:0 0 6px; }

    .overlayTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .overlayTools{ display:flex; gap:8px; align-items:center; }
    .overlayToolBtn{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 6px 10px;
      font-weight: 950;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .overlayToolBtn:hover{ transform: translateY(-1px); }
    .overlayMsg{
      font-size:13px; color:#444; font-weight:850; margin:0 0 10px; line-height:1.4;
      overflow:auto; -webkit-overflow-scrolling: touch; max-height: 60vh;
      white-space: pre-wrap;
      text-align:left;
      background: rgba(255,255,255,.9);
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.06);

    .overlayMsg.game{
      max-height: none;
      overflow: visible;
      background: transparent;
      border: 0;
      padding: 0;
      margin: 0;
    }

    }
    .overlayCard > button{ margin-top: 10px; flex: 0 0 auto; }

    .titleLine{
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.05;
    
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
    .roomTitle{ font-weight: 1000; }
    .boomDot{
      width:10px; height:10px;
      border-radius:999px;
      background:#ff3b30;
      box-shadow: 0 0 0 rgba(255,59,48,.55);
      animation: boomPulse 1.1s infinite;
      flex: 0 0 auto;
    }
    .boomText{
      font-size:12px;
      font-weight:1000;
      color:#ff3b30;
      letter-spacing:-0.2px;
    }
    @keyframes boomPulse{
      0%{ box-shadow: 0 0 0 0 rgba(255,59,48,.55); transform: scale(1); }
      70%{ box-shadow: 0 0 0 10px rgba(255,59,48,0); transform: scale(1.05); }
      100%{ box-shadow: 0 0 0 0 rgba(255,59,48,0); transform: scale(1); }
    }
    .icon{
      animation: iconJitter 3.2s infinite;
      transform-origin: 50% 50%;
    }
    @keyframes iconJitter{
      0%, 92%, 100% { transform: rotate(0deg); }
      94% { transform: rotate(-3deg); }
      96% { transform: rotate(3deg); }
      98% { transform: rotate(-2deg); }
    }

  
/* üéÜ Fireworks / Confetti FX */
.fxLayer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
  overflow: hidden;
}
.spark{
  position:absolute;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.2);
  animation: sparkPop 1200ms ease-out forwards;
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
}
@keyframes sparkPop{
  0%{ opacity:0; transform: translate(-50%,-50%) scale(0.2); }
  8%{ opacity:1; }
  100%{ opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.0); }
}
.fxTitle{
  position: fixed;
  left: 50%;
  top: 16px;
  transform: translateX(-50%);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 1000;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.92);
  box-shadow: 0 14px 40px rgba(0,0,0,.12);
  z-index: 10001;
  pointer-events:none;
  animation: fxTitleIn 1600ms ease-out forwards;
}
@keyframes fxTitleIn{
  0%{ opacity:0; transform: translateX(-50%) translateY(-8px) scale(.98); }
  12%{ opacity:1; }
  90%{ opacity:1; }
  100%{ opacity:0; transform: translateX(-50%) translateY(-10px) scale(1.0); }
}

  
/* üíó Heart FX (enter) */
.heartLayer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
  overflow: hidden;
}
.heart{
  position: absolute;
  font-size: 18px;
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.9);
  animation: heartFloat 1400ms ease-out forwards;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
  will-change: transform, opacity;
}
@keyframes heartFloat{
  0%   { opacity:0; transform: translate(-50%,-50%) scale(.9); }
  10%  { opacity:1; }
  100% { opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.25) rotate(var(--rot)); }
}

  

/* ‚ú® Extra command FX */

/* ‚ö†Ô∏è Screen shake (warning) */
body.shake{
  animation: screenShake 520ms ease-in-out;
}
@keyframes screenShake{
  0%, 100%{ transform: translateX(0); }
  12%{ transform: translateX(-6px); }
  24%{ transform: translateX(6px); }
  36%{ transform: translateX(-5px); }
  48%{ transform: translateX(5px); }
  60%{ transform: translateX(-3px); }
  72%{ transform: translateX(3px); }
  84%{ transform: translateX(-2px); }
}

.fxEmoji{
  position:absolute;
  opacity:0;
  transform: translate(-50%, -50%) scale(0.9) rotate(0deg);
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
  will-change: transform, opacity;
  pointer-events:none;
}
.fxEmoji.pop{
  animation: fxPop 1200ms ease-out forwards;
}
@keyframes fxPop{
  0%   { opacity:0; transform: translate(-50%,-50%) scale(.85) rotate(0deg); }
  12%  { opacity:1; }
  100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.25) rotate(var(--rot)); }
}
.fxEmoji.twinkle{
  animation: fxTwinkle 1500ms ease-out forwards;
}
@keyframes fxTwinkle{
  0%{ opacity:0; transform: translate(-50%,-50%) scale(.85) rotate(0deg); }
  15%{ opacity:1; }
  45%{ opacity:.25; }
  70%{ opacity:1; transform: translate(-50%,-50%) scale(1.15) rotate(var(--rot)); }
  100%{ opacity:0; transform: translate(-50%,-50%) scale(.95) rotate(var(--rot)); }
}
.fxEmoji.snow{
  animation: fxSnow 2200ms linear forwards;
}
@keyframes fxSnow{
  0%{ opacity:0; transform: translate(-50%,-50%) translateY(0) rotate(0deg); }
  10%{ opacity:1; }
  100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)); }
}



/* ‚å®Ô∏è Typing indicator + Picker anchor */
    .typingWrap{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      margin-bottom: 0px;
    }
    .typingWrap .pickerBtn{
      flex: 0 0 auto;
      width: 44px;
      height: 44px;
      padding: 0;
      display:grid;
      place-items:center;
    }
    .typingBar{
      flex: 1 1 auto;
      margin: 0;
      padding: 0 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.85);
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      min-height: 44px;
      display:none;
      align-items:center;
      overflow:hidden;
    }
    .typingBar.show{ display:flex; }
    .typingText{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .typingDot{
      display:inline-block;
      width: 18px;
      text-align:center;
      margin-right: 6px;
      flex: 0 0 auto;
    }
    .typingDot::before{ content:"‚å®Ô∏è"; }
    .typingDot::after{
      content: "‚Ä¶";
      animation: dots 1.2s infinite;
    }
    @keyframes dots{
      0%{ content:"."; }
      33%{ content:".."; }
      66%{ content:"..."; }
      100%{ content:"."; }
    }

    /* üì£ Shout ticker (overlay: no layout jump) */
.ticker{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 10005;

  /* ‚úÖ Î†àÏù¥ÏïÑÏõÉ/Î≤ÑÌäº ÏòÅÌñ• 0 */
  pointer-events: none;

  /* Î≥¥Ïù¥Í∏∞/Ïà®Í∏∞Í∏∞ */
  opacity:0;
  visibility:hidden;
  transition: opacity 160ms ease;

  /* Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  display:flex;
  align-items:center;
  justify-content:center;

  width: auto;
  max-width: calc(100vw - 18px);
}
.ticker.show{ opacity:1; visibility:visible; }

.tickerPill{
  display:inline-block;
  width: clamp(240px, 70vw, 720px);
  max-width: calc(100vw - 18px);
  overflow:hidden;

  /* ‚úÖ ÌÖçÏä§Ìä∏ Í∏∏Ïù¥Ïóê ÎßûÏ∂∞ ÎèôÍ∏ÄÎèôÍ∏Ä */
  border-radius: 999px;
  padding: 12px 16px;

  /* üíó Ï†ÑÍ¥ëÌåê: ÏÇ¨ÎûëÏä§Îü¨Ïö¥ Ïó∞ÌïëÌÅ¨ + ÌïòÌä∏ Ìå®ÌÑ¥ */
  background-color: rgba(255, 246, 251, .98);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Cpath d='M24 39s-13-8-13-19c0-6 3-9 8-9 3 0 5 2 5 2s2-2 5-2c5 0 8 3 8 9 0 11-13 19-13 19z' fill='%23ff4f93' fill-opacity='0.12'/%3E%3C/svg%3E"),
    radial-gradient(120% 180% at 10% 0%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%),
    radial-gradient(120% 180% at 90% 100%, rgba(255,255,255,.7), rgba(255,255,255,0) 55%);
  background-repeat: repeat, no-repeat, no-repeat;
  background-size: 48px 48px, cover, cover;
  background-blend-mode: multiply, normal, normal;

  border: 1px solid rgba(255, 88, 155, .14);
  box-shadow:
    0 16px 44px rgba(0,0,0,.16),
    inset 0 0 0 1px rgba(255,255,255,.35),
    inset 0 0 18px rgba(255, 88, 155, .08);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.tickerTrack{
  display:inline-flex;
  align-items:center;
  gap: 12px;
  white-space:nowrap;
  will-change: transform;
  animation: tickerMove linear forwards;
}

.tickerBadge{
  font-weight: 1000;
  font-size: 12px;
  letter-spacing: .4px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.65);
  color: #5a2b44;
  flex: 0 0 auto;
}

.tickerText{
  font-weight: 1000;
  font-size: 18px;
  letter-spacing: .6px;
  color: #b10053;
  text-shadow:
    0 0 6px rgba(255, 79, 147, .28),
    0 0 16px rgba(255, 79, 147, .18);
}


@media (max-width: 520px){
  .tickerPill{ padding: 10px 12px; }
  .tickerText{ font-size: 16px; }
}

/* Ïò§Î•∏Ï™ΩÏóêÏÑú Îì§Ïñ¥ÏôÄ ÏôºÏ™ΩÏúºÎ°ú Ï≠â (ÏÜçÎèÑÎäî JSÏóêÏÑú durationÏúºÎ°ú Ï°∞Ï†à) */
@keyframes tickerMove{
  from{ transform: translateX(110%); }
  to{ transform: translateX(-140%); }
}


/* =====================
 * PATCH: Topbar responsive + Mini BGM bar + Volume popover + Picker button
 * ===================== */
.topbar{
  flex-wrap: wrap;
  gap: 10px;
}
.actions{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap: 10px;
  flex-wrap: wrap;
  min-width: 0;
}

/* Mini BGM bar (left of menu) */
.miniBgmBar{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 8px 10px;
  border: 1px solid rgba(255, 105, 180, 0.20);
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(8px);
  border-radius: 999px;
  min-width: 0; /* ‚úÖ Í∏¥ Ï†úÎ™©ÏóêÎèÑ Ï§ÑÎ∞îÍøà Î∞©ÏßÄ(Ï∂ïÏÜå ÌóàÏö©) */
  min-inline-size: 0;
  
  max-width: 520px;
  flex: 1 1 220px;
  overflow: hidden;
}
.miniBgmBtns{
  display:flex;
  gap: 6px;
  align-items:center;
  flex: 0 0 auto;
}
.miniIconBtn{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 16px;
  user-select:none;
}
.miniIconBtn:hover{ filter: brightness(0.98); }
.miniIconBtn:active{ transform: translateY(1px); }

.noteDance{
  display:inline-block;
  transform-origin: 50% 70%;
}
.miniIconBtn.playing .noteDance{
  animation: noteDance 0.9s ease-in-out infinite;
}
@keyframes noteDance{
  0%{ transform: rotate(-10deg) translateY(0); }
  30%{ transform: rotate(12deg) translateY(-1px); }
  60%{ transform: rotate(-6deg) translateY(1px); }
  100%{ transform: rotate(-10deg) translateY(0); }
}

.miniBgmTitle{
  position: relative;
  min-width: 0;
  flex: 1 1 auto;
  font-weight: 800;
  font-size: 13px;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
}
.miniBgmTitle .marquee{
  display:block;
  padding-left: 10px;
  will-change: transform;
}
.miniBgmTitle.marqueeOn .marquee{
  animation: miniMarquee 12s linear infinite;
}
@keyframes miniMarquee{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-55%); }
}
.miniBgmTitle .sep{
  opacity: 0.45;
  margin: 0 6px;
}

/* Volume popover: fixed overlay (never hidden behind chat) */
.volPopover{
  position: fixed;
  z-index: 99999;
  width: 260px;
  max-width: min(320px, calc(100vw - 20px));
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.25);
  border-radius: 18px;
  padding: 12px 12px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.10);
  backdrop-filter: blur(10px);
  display:none;
}
.volPopover.show{ display:block; }
.volPopover .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 10px;
  font-weight: 900;
}
.volPopover input[type=range]{ width: 100%; }


/* Chat height popover: same layer as volume */
.logPopover{
  position: fixed;
  z-index: 99999;
  width: 280px;
  max-width: min(340px, calc(100vw - 20px));
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.25);
  border-radius: 18px;
  padding: 12px 12px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.10);
  backdrop-filter: blur(10px);
  display:none;
}
.logPopover.show{ display:block; }
.logPopover .labelRow{ margin-bottom: 10px; }
.logPopover input[type=range]{ width: 100%; }


/* Send row: picker button inside input line */
.sendRow{
  align-items: stretch;
  gap: 10px;
}
.pickerBtn{
  width: 44px;
  min-width: 44px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 18px;
}
.pickerBtn:hover{ filter: brightness(0.98); }
.pickerBtn:active{ transform: translateY(1px); }
#msg{ flex: 1 1 auto; }

/* Picker popover */
.pickerPopover{
  position: fixed;
  z-index: 100000;
  width: min(520px, calc(100vw - 18px));
  max-height: min(520px, calc(100vh - 160px));
  max-height: min(520px, calc((var(--vh, 1vh) * 100) - 160px));
  overflow: hidden;
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.26);
  border-radius: 18px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.12);
  backdrop-filter: blur(10px);
  display:none;
  flex-direction: column;
}
.pickerPopover.show{ display:flex; }
.pickerHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
.pickerTabs{
  display:flex;
  gap: 6px;
  flex-wrap: wrap;
  min-width: 0;
}
.pickerTab{
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: 12px;
  cursor:pointer;
  user-select:none;
}
.pickerTab.active{
  border-color: rgba(255,105,180,0.55);
  box-shadow: 0 0 0 3px rgba(255,105,180,0.12);
}
.pickerTools{
  display:flex;
  gap: 8px;
  align-items:center;
}
.pickerCloseBtn{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  font-weight: 900;
}
.pickerBody{
  padding: 10px 12px;
  overflow: auto;
  flex: 1 1 auto;
  max-height: none;
  -webkit-overflow-scrolling: touch;
}
.pickerGrid{
  display:grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 6px;
}
@media (max-width: 520px){
  .pickerGrid{ grid-template-columns: repeat(8, 1fr); }
}
.emoBtn{
  border: 1px solid rgba(0,0,0,0.06);
  background: #fff;
  border-radius: 12px;
  padding: 6px 0;
  cursor:pointer;
  font-size: 18px;
}
.emoBtn:hover{ filter: brightness(0.98); }
.emoBtn:active{ transform: translateY(1px); }
.cmdBtn{
  width:100%;
  text-align:left;
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor:pointer;
  font-weight: 800;
}
.cmdBtn:hover{ filter: brightness(0.98); }
.cmdBtn:active{ transform: translateY(1px); }
.cmdList{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
@media (max-width: 560px){
  .cmdList{ grid-template-columns: 1fr; }
}

/* Mobile viewport stability (vh/dvh hybrid: prevents mobile "ÎäòÏñ¥Ïßê") */
:root{ --vh: 1vh; --chromeTop: 0px; }

/* ‚úÖ Viewport height ÏïàÏ†ïÌôî (iOS Ï£ºÏÜåÏ∞Ω/ÌÇ§Î≥¥Îìú Ìè¨Ìï®)
   - JSÍ∞Ä --vh(px)Î•º ÏóÖÎç∞Ïù¥Ìä∏. Ïù¥ Í∞íÏùÑ Ïö∞ÏÑ† ÏÇ¨Ïö©Ìï¥ÏÑú Î™®Î∞îÏùº "ÎäòÏñ¥Ïßê/Ïó¨Î∞± Ïä§ÌÅ¨Î°§"ÏùÑ Î∞©ÏßÄ */
html{ min-height: calc(var(--vh, 1vh) * 100); }
body{
  min-height: calc(var(--vh, 1vh) * 100);
  height: auto;
  overflow-x: hidden;
}

/* DJ Playlist / Requests */
.playlistList, .reqList{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.plItem, .reqItem{
  border: 1px solid var(--line);
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.plItem.sel{
  outline: 2px solid rgba(255,105,180,.28);
}
.plMain, .reqMain{ flex:1; min-width:0; }
.plTitle, .reqTitle{
  font-weight:900;
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.plSub, .reqSub{
  font-size:12px;
  color: var(--muted);
  margin-top:2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.plBtns, .reqBtns{ display:flex; gap:6px; }
.tinyBtn{
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 10px;
  padding: 6px 8px;
  font-weight: 900;
  cursor:pointer;
}
.tinyBtn:hover{ filter: brightness(0.98); }
.tinyBtn:active{ transform: translateY(1px); }

/* =====================
 * PATCH: Mobile topbar fold
 * ===================== */
#btnTopbarToggle{ display:none; }
@media (max-width: 760px){
  #btnTopbarToggle{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width: 44px;
    height: 44px;
    padding: 0 10px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.08);
    background:#fff;
    font-weight: 1000;
    cursor:pointer;
    user-select:none;
  }
  #btnTopbarToggle:active{ transform: translateY(1px); }

  /* Ï†ëÌûå ÏÉÅÌÉú: ÎØ∏Îãà BGM Î∞î Ïà®Í≤®ÏÑú ÏÉÅÎã®Î∞î ÎÜíÏù¥ ÏµúÏÜåÌôî */
  body.tbCollapsed .miniBgmBar{ display:none !important; }
  /* Ï†ëÌûå ÏÉÅÌÉú: Ï†ëÏÜçÏûê Î™ÖÎã®(ÏÇ¨Ïù¥Îìú Ïπ¥Îìú)ÎèÑ Ìï®Íªò Ï†ëÍ∏∞ */
  body.tbCollapsed .side{ display:none !important; }

  body.tbCollapsed .topbar{
    padding: 8px 10px;
  }
  body.tbCollapsed .actions{
    gap: 8px;
  }
}

/* =====================
 * PATCH: Song play ticker (cute)
 * ===================== */
.tickerPill.songMode{
  border: 1px solid rgba(255, 88, 155, .22);
  box-shadow:
    0 16px 44px rgba(0,0,0,.16),
    inset 0 0 0 1px rgba(255,255,255,.40),
    inset 0 0 22px rgba(255, 88, 155, .10);
}
.tickerBadge.songMode{
  background: rgba(255,255,255,.75);
}
.tickerText.songMode{
  color:#8a0040;
  text-shadow:
    0 0 6px rgba(255, 79, 147, .24),
    0 0 16px rgba(255, 79, 147, .14);
}


    /* Í∏¥ ÎßÅÌÅ¨/Î¨∏ÏûêÏó¥Î°ú Î™®Î∞îÏùº Î†àÏù¥ÏïÑÏõÉÏù¥ 'ÎäòÏñ¥ÎÇòÎäî' Î¨∏Ï†ú Î∞©ÏßÄ */
    #log{ overflow-x: hidden; }
    .bubble, .bubble *{
      overflow-wrap: anywhere;
      word-break: break-word;
      min-width: 0;
      max-width: 100%;
    }
    .bubble a{
      word-break: break-all;
      overflow-wrap: anywhere;
    }

/* MOBILE_SCROLL_RESTORE_V4 */
@media (max-width: 760px){
  /* ‚úÖ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î°§ÏùÄ ÎßâÎêò, Ïπ¥Îìú ÎÇ¥Î∂Ä(#log) Ïä§ÌÅ¨Î°§ÏùÄ Î∞òÎìúÏãú ÏÇ¥ÏïÑÏûàÍ≤å */
  .wrap{ height: calc(var(--vh, 1vh) * 100); min-height: 0; }
  .layout{ flex: 1 1 auto; min-height: 0; }
  .layout > .card:not(.side){ flex: 1 1 auto; min-height: 0; display:flex; flex-direction:column; }
  /* ‚ö†Ô∏è ÏïÑÎûòÏùò Í∏∞Î≥∏ #log(height:320px)Í∞Ä Îí§ÏóêÏÑú ÎçÆÏñ¥Ïç®ÏÑú Ïä§ÌÅ¨Î°§Ïù¥ 'ÏÇ¨ÎùºÏßÑ Í≤ÉÏ≤òÎüº' Î≥¥Ïù¥Îäî Î¨∏Ï†úÎ•º Í∞ïÏ†úÎ°ú Î∞©ÏßÄ */
  #log{ flex: 1 1 auto; min-height: 0; height: auto !important; max-height: none !important; overflow: auto !important; -webkit-overflow-scrolling: touch; }
  /* ÏûÖÎ†•Ï§Ñ/ÌûåÌä∏Îäî ÌïòÎã®Ïóê Í≥†Ï†ïÎêòÎèÑÎ°ù */
  .sendRow, .typingWrap, .hint{ flex: 0 0 auto; }
}



    /* =====================
       üé≤ Writer Marble UI
       ===================== */
    .wmWrap{ display:flex; flex-direction:column; gap:12px; }
    .wmHeader{ display:flex; flex-direction:column; gap:4px; }
    .wmTitle{ font-size:20px; font-weight:950; }
    .wmSub{ font-size:12px; color:var(--muted); font-weight:800; }
    .wmTopRow{ display:flex; align-items:stretch; gap:10px; flex-wrap:wrap; }
    .wmControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .wmBtn{ border-radius:14px; }
    .wmBtn.ghost{ background: rgba(255, 209, 232, .22); }
    .wmBtn.disabled{ opacity:.5; pointer-events:none; }
    .wmTurn{ flex:1; min-width:180px; padding:10px 12px; border:1px solid rgba(0,0,0,.10); border-radius:16px; background: rgba(255,255,255,.8); }
    .wmTurnLabel{ font-size:12px; color:var(--muted); font-weight:900; }
    .wmTurnName{ font-size:16px; font-weight:950; margin-top:2px; }
    .wmWin{ padding:10px 12px; border-radius:16px; border:1px solid rgba(0,0,0,.12); background: rgba(255, 242, 201, .65); font-weight:950; }

    .wmBoardWrap{ display:grid; grid-template-columns: minmax(280px, 1fr) minmax(240px, 340px); gap:12px; align-items:start; }
    @media (max-width: 860px){
      .wmBoardWrap{ grid-template-columns: 1fr; }
    }
    .wmBoard{
      position:relative;
      display:grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(11, 1fr);
      aspect-ratio: 1/1;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,240,248,.85));
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }
    .wmCell{
      border: 1px solid rgba(0,0,0,.06);
      padding: 6px 6px 5px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:3px;
      font-size:11px;
      background: rgba(255,255,255,.7);
      position:relative;
    }
    .wmCell.owned{ box-shadow: inset 0 0 0 2px rgba(0,0,0,.05); }
    .wmCell.mine{ box-shadow: inset 0 0 0 3px rgba(0,0,0,.10); }
    .wmOwnStrip{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 8px;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      opacity: .95;
    }
    .wmLvl{
      position:absolute;
      top:6px; right:6px;
      font-size:10px;
      font-weight:1000;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      color: #1f1f1f;
      filter: saturate(1.05);
    }
    .wmToken{
      transition: transform .18s ease;
    }
    .wmMoveGhost{
      position:absolute;
      left:0; top:0;
      width: 34px; height: 34px;
      display:grid; place-items:center;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.15);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      pointer-events:none;
      z-index: 9;
      transform: translate(-9999px, -9999px);
    }

    .wmCell.start{ background: rgba(255, 242, 201, .75); }
    .wmCell.tax{ background: rgba(255, 220, 220, .75); }
    .wmCell.chance{ background: rgba(220, 245, 255, .75); }
    .wmCell.loan{ background: rgba(229, 255, 235, .75); }
    .wmCell.rest{ background: rgba(235, 235, 255, .75); }
    .wmCellTop{ display:flex; align-items:center; gap:4px; font-weight:950; }
    .wmIc{ font-size:13px; }
    .wmNm{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .wmDesc{ color: var(--muted); font-weight:800; font-size:10px; line-height:1.2; }
    .wmOwner{
      position:absolute; right:6px; bottom:6px;
      padding: 2px 6px;
      border-radius:999px;
      background: rgba(0,0,0,.06);
      font-size:10px;
      font-weight:950;
      max-width: 90%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .wmToken{
      position:relative;
      z-index: 3;
      display:grid;
      place-items:center;
      font-size:16px;
      pointer-events:none;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
    }

    .wmCenter{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 26px rgba(0,0,0,.05);
      position:sticky;
      top: 6px;
    }
    .wmDiceRow{ display:flex; align-items:center; gap:8px; justify-content:center; }
    .wmDice{
      width:56px; height:56px;
      display:grid; place-items:center;
      border-radius:16px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      font-size:32px;
      font-weight:950;
    }
    .wmDice.rolling{
      animation: wmShake .12s infinite;
    }
    .wmDiceSum{ font-weight:950; }
    .wmDiceHint{ text-align:center; font-size:12px; color:var(--muted); font-weight:850; margin-top:-2px; }

    @keyframes wmShake{
      0%{ transform: rotate(-2deg) translateY(0); }
      50%{ transform: rotate(2deg) translateY(-1px); }
      100%{ transform: rotate(-2deg) translateY(0); }
    }

    .wmCenterBox{ border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:10px; background: rgba(255,247,251,.65); }
    .wmCenterTitle{ font-weight:950; margin-bottom:8px; }
    .wmEmpty{ color:var(--muted); font-weight:850; font-size:12px; padding:4px 0; }

    .wmRanks{ display:flex; flex-direction:column; gap:6px; max-height: 220px; overflow:auto; padding-right: 6px; }
    .wmRankRow{ display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:14px; border:1px solid rgba(0,0,0,.07); background: rgba(255,255,255,.85); }
    .wmRankRow.turn{ outline: 2px solid rgba(255, 111, 180, .28); }
    .wmRankRow.dead{ opacity:.55; }
    .wmRankLeft{ display:flex; flex-direction:column; gap:2px; }
    .wmRankNo{ font-weight:950; font-size:12px; color:var(--muted); }
    .wmRankName{ font-weight:950; }
    .wmRankTag{ font-size:11px; color:var(--muted); font-weight:850; }
    .wmRankRight{ text-align:right; display:flex; flex-direction:column; gap:2px; }
    .wmRankMoney{ font-weight:950; }
    .wmRankSub{ font-size:11px; color:var(--muted); font-weight:850; }

    .wmLog{ max-height: 160px; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:4px; }
    .wmLogLine{ font-size:12px; font-weight:850; color:#3a3a3a; }

    .wmFoot{ display:flex; gap:8px; flex-wrap:wrap; }
    .wmRulePill{ padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background: rgba(255,255,255,.8); font-size:12px; font-weight:900; color:#444; }

/* ===== Writer Marble compact UI (v16) ===== */
.wmWrap.wmMini{ gap:10px; }
.wmWrap.wmMini .wmHeader{ text-align:left; }
.wmWrap.wmMini .wmTitle{ letter-spacing:-.2px; }
.wmHud{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; flex-wrap:wrap;
  position: sticky; top: 0;
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 16px;
  padding: 10px 10px;
  z-index: 5;
}
.wmTurnPill{
  display:flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255, 240, 248, .65);
  font-weight: 950;
}
.wmTurnLabel{ color: var(--muted); font-size: 12px; }
.wmTurnName{ font-size: 13px; }
.wmControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
.wmStrip{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.72);
}
.wmStripLeft{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.wmStripRight{ flex:1; text-align:right; font-weight:900; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.wmChip{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255, 209, 232, .22);
  font-weight: 950;
  font-size: 12px;
}
.wmChip.muted{ background: rgba(0,0,0,.04); color:#666; }
.wmDicePanel{
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.72);
}
.wmBoardArea{ display:flex; justify-content:center; }
.wmMiniBoard{
  width: 380px;
  max-width: 92vw;
  aspect-ratio: 1/1;
}
@media (max-width: 520px){
  .wmMiniBoard{ width: 330px; }
}
.wmCell{ position: relative; }
.wmCell .wmDesc{ display:none !important; } /* Ìà¥ÌåÅÏúºÎ°ú ÎåÄÏ≤¥ */
.wmCell::after{
  content: attr(data-tip);
  position:absolute;
  left:50%; bottom: 100%;
  transform: translate(-50%, -6px);
  opacity:0;
  pointer-events:none;
  min-width: 140px;
  max-width: 220px;
  white-space: pre-wrap;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.96);
  box-shadow: 0 10px 24px rgba(0,0,0,.10);
  font-size: 12px;
  line-height: 1.35;
  font-weight: 900;
  color:#333;
  z-index: 20;
}
.wmCell:hover::after{ opacity:1; transform: translate(-50%, -10px); }
.wmCell.wmOwned{
  box-shadow: inset 0 6px 0 var(--ownc);
}
.wmCell.wmMine{
  outline: 2px solid rgba(255, 105, 180, .55);
  outline-offset: -2px;
}
.wmLv{
  position:absolute; right:6px; bottom:6px;
  padding: 3px 6px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.85);
  font-size: 11px;
  font-weight: 950;
  color:#444;
}
.wmToken{
  width: 22px; height: 22px;
  border-radius: 999px;
  display:flex; align-items:center; justify-content:center;
  border: 1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.9);
  box-shadow: 0 8px 16px rgba(0,0,0,.08);
}
.wmCenterLogo{
  position:absolute;
  inset: 34% 18%;
  display:flex; align-items:center; justify-content:center;
  text-align:center;
  font-weight: 950;
  letter-spacing: .12em;
  color: rgba(0,0,0,.18);
  border: 1px dashed rgba(0,0,0,.10);
  border-radius: 18px;
  background: rgba(255,255,255,.35);
  pointer-events:none;
}



    /* ‚òî Acid Rain (ÏÇ∞ÏÑ±ÎπÑ) mini game */
    .acidWrap{ display:flex; flex-direction:column; gap:10px; }
    .acidTop{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .acidTop .pill{ background:#fff; border:1px solid rgba(0,0,0,.08); }
    .acidStage{
      position: relative;
      height: 340px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(180,255,210,.22), rgba(255,247,251,.85));
      overflow:hidden;
    }
    .acidWord{
      position:absolute;
      top:-30px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      font-weight: 950;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      user-select:none;
      pointer-events:none;
      white-space:nowrap;
    }
    .acidWord.miss{ opacity:.35; filter: blur(.3px); }

    .acidWord.bonus{
      border-color: rgba(255, 180, 0, .35);
      box-shadow: 0 8px 18px rgba(255,180,0,.12);
    }
        .acidWord.event{
      /* ‚ö†Ô∏è do NOT animate transform here (JS uses transform for falling) */
      animation: acidGlow_ 1.1s infinite ease-in-out;
      border-color: rgba(255, 215, 0, .55);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,245,210,.92));
    }
    .acidWord.bonus::after{
      content: "+" attr(data-pt);
      margin-left: 6px;
      font-size: 12px;
      font-weight: 1000;
      opacity: .8;
    }
    @keyframes acidGlow_{
      0%{ filter: brightness(1); box-shadow: 0 6px 16px rgba(0,0,0,.06), 0 0 0 rgba(255,215,0,0); }
      50%{ filter: brightness(1.18); box-shadow: 0 10px 24px rgba(0,0,0,.08), 0 0 18px rgba(255,215,0,.32); }
      100%{ filter: brightness(1); box-shadow: 0 6px 16px rgba(0,0,0,.06), 0 0 0 rgba(255,215,0,0); }
    }

.acidHud{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .acidBoard{ min-width: 220px; }
    .acidBoard .line{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.08); }
    .acidBoard .line:last-child{ border-bottom:0; }
    .acidInputRow{ display:flex; gap:8px; align-items:center; }
    .acidInputRow input{
      flex: 1 1 auto;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      font-weight: 900;
    }
    .acidMiniNote{ font-size: 12px; color: var(--muted); font-weight: 800; }

  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="icon">üí£</div>
      <div class="brandInfo">
        <div class="brandText">
          <div class="titleLine"><span class="roomTitle">Boom!</span><span class="boomDot" aria-hidden="true"></span><span id="boomText" class="boomText">00:00:00 Ìè≠Ìåå</span></div>
          <div class="metaSmall" id="sessLabel">SESSION: -</div>
        </div>
        <button class="pinBtn" id="btnNoticePin" type="button" title="Í≥µÏßÄ">üìå</button>
      </div>
    </div>

    <div class="actions">

      <!-- Mini BGM Bar (ÏÉÅÎã®ÏóêÏÑú Í∞ôÏù¥ Îì£Í∏∞) -->
      <div class="miniBgmBar" id="miniBgmBar" aria-label="BGM mini bar">
        <div class="miniBgmBtns">
          <button class="miniIconBtn" id="miniNote" type="button" title="BGM ÏÉÅÌÉú"><span class="noteDance">üéµ</span></button>
          <button class="miniIconBtn" id="miniPlay" type="button" title="Ïû¨ÏÉù">‚ñ∂Ô∏è</button>
          <button class="miniIconBtn" id="miniPause" type="button" title="ÏùºÏãúÏ†ïÏßÄ">‚è∏Ô∏è</button>
          <button class="miniIconBtn" id="miniAllow" type="button" title="BGM ÌóàÏö©(Í∞ôÏù¥ Îì£Í∏∞)">üé∂</button>
        </div>
        <div class="miniBgmTitle" id="miniBgmTitle"><span class="marquee" id="miniBgmMarquee">BGM Ï§ÄÎπÑ<span class="sep">‚Ä¢</span>BGM Ï§ÄÎπÑ</span></div>
        <div class="miniBgmBtns">
          <button class="miniIconBtn" id="miniVolBtn" type="button" title="Î≥ºÎ•®">üîä</button>
        </div>
      </div>

      <button id="btnTopbarToggle" type="button" title="ÏÉÅÎã®Î∞î Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ (Ï†ëÏÜçÏûê Î™ÖÎã®ÎèÑ Í∞ôÏù¥ Ï†ëÌûò)">‚¨ÜÔ∏è</button>
      <button id="btnMenu" type="button" title="Î©îÎâ¥">‚ò∞ Î©îÎâ¥</button>
      <button id="btnLeave" type="button" title="ÎÇòÍ∞ÄÍ∏∞">üèÉ‚Äç‚ôÇÔ∏èÎÇòÍ∞ÄÍ∏∞</button>

      <div class="menuPanel" id="menuPanel" aria-hidden="true">
        <div class="menuHeader">
          <div class="menuTitle">Î©îÎâ¥</div>
          <button class="menuClose" id="btnMenuClose" type="button" title="Îã´Í∏∞">‚úï</button>
        </div>
<div class="block">
          <div class="labelRow">
            <span class="label">üéµ BGM (Ïú†ÌäúÎ∏å)</span>
            <span class="val" id="bgmState">Ï§ÄÎπÑ</span>
          </div>
<div class="labelRow" style="margin-top:8px;">
  <span class="label">üéß DJ</span>
  <span class="val" id="djStatus">ÏóÜÏùå</span>
</div>
<div class="row2" style="margin-top:8px;">
  <button id="btnDjClaim" type="button" title="DJ Îß°Í∏∞">DJ Îß°Í∏∞</button>
  <button id="btnDjTransfer" type="button" title="DJ ÏñëÎèÑ">DJ ÏñëÎèÑ</button>
</div>
<div class="hint" style="margin-top:8px;">
  ‚Ä¢ DJÎßå BGM Ïû¨ÏÉù/Î≥ÄÍ≤Ω Í∞ÄÎä•Ìï¥Ïöî. (DJ Îß°Í∏∞=ÌïÑÏöîÌïòÎ©¥ Í∞ÄÏ†∏Ïò§Í∏∞ / DJ ÏñëÎèÑ=ÏßÄÏ†ïÌï¥ÏÑú ÎÑòÍ∏∞Í∏∞)
</div>
          <input id="bgmUrl" placeholder="Ïú†ÌäúÎ∏å ÎßÅÌÅ¨ Î∂ôÏó¨ÎÑ£Í∏∞ (Ïòà: https://youtu.be/VIDEOID)" />
          <div class="row2" style="margin-top:8px;">
            <button id="btnBgmPlay" type="button">Ïû¨ÏÉù</button>
            <button id="btnBgmPause" type="button">ÏùºÏãúÏ†ïÏßÄ</button>
          </div>
          <button id="btnQuickPlAdd" type="button" style="margin-top:8px; width:100%;">‚ûï DJ Ïû¨ÏÉùÎ™©Î°ùÏóê Ï∂îÍ∞Ä</button>
          <button id="btnBgmAllow" type="button" style="margin-top:8px; width:100%;">üé∂ BGM ÌóàÏö©(Í∞ôÏù¥ Îì£Í∏∞)</button>
          <div id="menuVolBlock" style="margin-top:10px; display:none;">
            <div class="labelRow">
              <span class="label">Î≥ºÎ•®</span>
              <span class="val" id="bgmVolVal">60</span>
            </div>
            <input id="bgmVol" type="range" min="0" max="100" value="60"/>
          </div>

          <div class="hint" style="margin-top:10px;">
            ‚ö†Ô∏è Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±Ö ÎïåÎ¨∏Ïóê ÏûêÎèôÏû¨ÏÉùÏùÄ ÎßâÌòÄÏÑú, Í∞ÅÏûê ‚ÄúBGM ÌóàÏö©‚ÄùÏùÑ Ìïú Î≤à ÎàåÎü¨Ïïº Í∞ôÏù¥ Îì§Î¶¥ Ïàò ÏûàÏñ¥Ïöî.
          </div>
        </div>


        <div class="block" id="djPlaylistBlock">
          <div class="labelRow">
            <span class="label">üéõÔ∏è DJ Ïû¨ÏÉùÎ™©Î°ù</span>
            <span class="val" id="plStatus">-</span>
          </div>
          <div class="hint" style="margin-top:8px;">
            ‚Ä¢ DJÍ∞Ä ÎßåÎì† Ïû¨ÏÉùÎ™©Î°ùÏù¥ ÏµúÏö∞ÏÑ†(=DJÍ∞Ä ÏïÑÎãå ÏÇ¨ÎûåÏùÄ Ïû¨ÏÉù/Î≥ÄÍ≤Ω Î∂àÍ∞Ä).<br/>
            ‚Ä¢ Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Îäî <b>ÌòÑÏû¨ ÏûÖÎ†•Ï∞Ω(bgmUrl)</b> Í∞íÏùÑ Í∑∏ÎåÄÎ°ú Ï∂îÍ∞ÄÌï¥Ïöî.
          </div>

          <!-- ‚úÖ ÌÅ∞ 'Ï†ÑÏ≤¥ ÏûêÎèô Ïû¨ÏÉù' Î≤ÑÌäº -->
          <button id="btnPlAutoAll" type="button" class="bigPlayBtn" style="margin-top:10px; width:100%;">‚ñ∂Ô∏è Ï†ÑÏ≤¥ ÏûêÎèô Ïû¨ÏÉù</button>

          <!-- ‚úÖ Ïû¨ÏÉùÎ™©Î°ùÏùÑ Î≤ÑÌäº Î∞îÎ°ú ÏïÑÎûòÎ°ú -->
          <div class="playlistList" id="playlistList" style="margin-top:10px;"></div>

          <!-- ‚úÖ Ïù¥Ï†Ñ/Îã§ÏùåÏùÄ Î™©Î°ù ÏïÑÎûòÏóê -->
          <div class="row2" style="margin-top:8px;">
            <button id="btnPlPrev" type="button">‚èÆÔ∏è Ïù¥Ï†Ñ</button>
            <button id="btnPlNext" type="button">‚è≠Ô∏è Îã§Ïùå</button>
          </div>

          <div class="hint" style="margin-top:8px;">‚Ä¢ Î™©Î°ùÏóêÏÑú Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ‚ÄúÏÑ†ÌÉù‚ÄùÎê©ÎãàÎã§. DJÎäî ÏÑ†ÌÉù Ìï≠Î™©ÏùÑ Î∞îÎ°ú Ïû¨ÏÉùÌïòÍ±∞ÎÇò ÏÇ≠Ï†úÌï† Ïàò ÏûàÏñ¥Ïöî.</div>

          <div class="row2" style="margin-top:8px;">
            <button id="btnPlPlayNow" type="button">‚ñ∂Ô∏è ÏÑ†ÌÉù Ïû¨ÏÉù</button>
            <button id="btnPlDeleteSel" type="button">üóëÔ∏è ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
          </div>

          <div class="row2" style="margin-top:8px;">
            <button id="btnPlClear" type="button">üßπ Î™©Î°ù ÎπÑÏö∞Í∏∞</button>
            <button id="btnPlSyncToInput" type="button">üìå ÌòÑÏû¨Í≥° ‚Üí ÏûÖÎ†•Ï∞Ω</button>
          </div>
        </div>

<div class="block" id="requestBlock">
          <div class="labelRow">
            <span class="label">üìù Ïã†Ï≤≠Í≥°</span>
            <span class="val" id="reqStatus">-</span>
          </div>

          <input id="reqUrl" placeholder="Ïú†ÌäúÎ∏å ÎßÅÌÅ¨(Ïã†Ï≤≠Í≥°) Î∂ôÏó¨ÎÑ£Í∏∞" />
          <input id="reqNote" placeholder="Ìïú Ï§Ñ Î©îÎ™®(ÏòµÏÖò)" />

          <div class="row2" style="margin-top:8px;">
            <button id="btnReqSend" type="button" style="grid-column:1/3;">Ïã†Ï≤≠</button>
          </div>
<div class="reqList" id="reqList"></div>

          <div class="hint" style="margin-top:10px;">
            ‚Ä¢ Ïã†Ï≤≠Í≥°ÏùÄ ‚ÄúÎåÄÍ∏∞Ïó¥‚ÄùÏóê ÏåìÏù¥Í≥†, DJÍ∞Ä ÏäπÏù∏ÌïòÎ©¥ DJ Ïû¨ÏÉùÎ™©Î°ùÏóê Îì§Ïñ¥Í∞ÄÏöî.<br/>
            ‚Ä¢ ÌòÑÏû¨Îäî <b>Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Îßå</b> Ïã†Ï≤≠ Í∞ÄÎä•Ìï¥Ïöî.
          </div>
        </div>
</div>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <div class="nameRow">
        <input id="user" placeholder="ÎãâÎÑ§ÏûÑ" maxlength="12"/>
        <button id="btnRace" class="miniGameBtn" type="button" title="ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ ÏãúÏûë" onclick="try{openRaceStart_();}catch(e){}">
          <span class="label">‚å®Ô∏èÌÉÄÏù¥ÌïëÎ†àÏù¥Ïä§</span>
        </button>
        <button id="btnAcid" class="miniGameBtn" type="button" title="ÏÇ∞ÏÑ±ÎπÑ(Îã®Ïñ¥ Îñ®Ïñ¥ÏßÄÍ∏∞) ÏãúÏûë" onclick="try{openAcidStart_();}catch(e){}">
          <span class="label">‚òîÏÇ∞ÏÑ±ÎπÑ</span>
        </button>
        <button id="btnMarble" class="miniGameBtn" type="button" title="Î∂ÄÎ£®ÎßàÎ∏î" onclick="try{openMarble_();}catch(e){}">
          <span class="label">üé≤Î∂ÄÎ£®ÎßàÎ∏î</span>
        </button>
        <button id="btnGuide" class="iconBtnSmall" type="button" title="Í∞ÄÏù¥Îìú" onclick="try{openGuide_();}catch(e){}">üß≠</button>
        <button id="btnLogPopover" class="iconBtnSmall" type="button" title="Ï±ÑÌåÖÏ∞Ω ÎÜíÏù¥ & Í∏ÄÏî® ÌÅ¨Í∏∞ Ï°∞Ï†à">‚ÜïÔ∏è</button>
      </div>
      <div id="ticker" class="ticker" aria-live="polite"></div>
<div id="raceBar" class="raceBar" aria-hidden="true">
  <div class="raceTop">
    <div class="raceTitle">
      <span class="tag" id="raceDiff">ÎÇúÏù¥ÎèÑ -</span>
      <span class="txt" id="raceText">ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ ÎåÄÍ∏∞ Ï§ë‚Ä¶</span>
    </div>
    <div class="raceTools">
      <span class="raceTimer" id="raceTimer">0.0s</span>
      <button id="btnRaceClear" class="raceMiniBtn" type="button" title="ÏûÖÎ†• ÏßÄÏö∞Í∏∞">‚§´</button>
    </div>
  </div>
  <input id="raceInput" placeholder="Ïó¨Í∏∞Ïóê Î¨∏Íµ¨Î•º Í∑∏ÎåÄÎ°ú ÌÉÄÏù¥Ìïë! (Ïù¥Î™®ÏßÄ ÏûêÎèô Î¨¥Ïãú / Í∏∞Ìò∏Îäî Í∑∏ÎåÄÎ°ú) ‚Äî Enter Ï†úÏ∂ú" disabled />
  <div class="raceDiffView" id="raceDiffView"></div>
  <div class="raceHint" id="raceHint"></div>

  <div class="raceBottom">
    <div class="raceProgress"><div id="raceProgBar"></div></div>
    <div class="raceRank" id="raceRank">‚Äî</div>
  </div>
    <div class="raceMiniTrack" id="raceMiniTrack" aria-label="Í≤ΩÏ£º Ìä∏Îûô"></div>

  <div class="raceSteps" id="raceSteps"></div>
<div class="raceScore" id="raceScore"></div>
</div>


      <div id="log"></div>      <button id="jumpBtn" class="jumpBtn" type="button">‚¨á ÏÉà Î©îÏãúÏßÄ <span class="cnt" id="jumpCnt">0</span></button>

            <div class="typingWrap" id="typingWrap">
        <button id="btnPicker" class="pickerBtn" type="button" title="Ïù¥Î™®ÏßÄ/Î™ÖÎ†πÏñ¥">üôÇ</button>
        <div id="typingBar" class="typingBar" aria-live="polite"><span id="typingText" class="typingText"></span></div>
      </div>
      <div class="sendRow">
        <textarea id="msg" rows="2" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• (Enter=Ï†ÑÏÜ° / Shift+Enter=Ï§ÑÎ∞îÍøà)"></textarea>
        <button id="sendBtn" type="button">Ï†ÑÏÜ°</button>
      </div>

      <div class="hint">
        ‚Ä¢ ÏûêÏ†ïÏóê Î∞©Ïù¥ ‚ÄúÌè≠Ìåå‚ÄùÎêòÎ©¥ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú ÏÉà Î∞©Ïù¥ Îê©ÎãàÎã§.<br/>
        ‚Ä¢ Ïö∞Î¶¨Ïùò ÏàòÎã§Îäî Ï†ÄÏû•ÎêòÏßÄ ÏïäÍ≥† ÏûêÏ†ïÏóê ÏÇ¨ÎùºÏßëÎãàÎã§ÏïÑÏïÑÏïÖ!üî•üî•
      </div>
    </div>

    <div class="card side">
      <h3>üë• Ï†ëÏÜçÏûê <span class="muted" id="onlineSub">-</span></h3>
      <div class="onlineList" id="onlineList"></div>
      <div class="hint" style="margin-top:10px;">
      üéß Í∞ôÏù¥ Îì£Í≥† Ïã∂ÏùÄ ÎÖ∏Îûò Ïû¨ÏÉùÌïòÎ©¥ÏÑú Ï†úÎåÄÎ°ú Ìú¥Ïãù Ï¶êÍ∏∞Í∏∞‚òï
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" aria-hidden="true">
  <div class="overlayCard" id="overlayCard" role="dialog" aria-modal="true">
    <div class="overlayTop">
      <p class="overlayTitle" id="ovTitle">ÏïåÎ¶º</p>
      <div class="overlayTools">
<button id="ovCloseBtn" class="overlayToolBtn" type="button" title="Îã´Í∏∞" onclick="try{event&&event.preventDefault&&event.preventDefault();event&&event.stopPropagation&&event.stopPropagation();}catch(e){};hideOverlay();">‚úï</button>
      </div>
    </div>
    <div class="overlayMsg" id="ovMsg"></div>
    <button id="ovOkBtn" type="button" onclick="try{event&&event.preventDefault&&event.preventDefault();event&&event.stopPropagation&&event.stopPropagation();}catch(e){};hideOverlay();">ÌôïÏù∏</button>
  </div>
</div>

<!-- =========================
     Firebase (Realtime DB)
     ========================= -->

  <!-- Volume Popover (fixed overlay) -->
  <div class="volPopover" id="volPopover" aria-hidden="true">
    <div class="row"><span>Î≥ºÎ•®</span><span id="volVal" style="font-weight:900;">60</span></div>
    <input id="volRange" type="range" min="0" max="100" value="60" />
  </div>

  <!-- Chat height popover -->
  <div class="logPopover" id="logPopover" aria-hidden="true">
    <div class="labelRow">
      <span class="label">Ï±ÑÌåÖÏ∞Ω ÎÜíÏù¥</span>
      <span class="val" id="logSizeVal">320px</span>
    </div>
    <input id="logSize" type="range" min="180" max="2400" value="320"/>
    <div class="labelRow" style="margin-top:10px;">
      <span class="label">Ï±ÑÌåÖ Í∏ÄÏî® ÌÅ¨Í∏∞</span>
      <span class="val" id="logFontVal">14px</span>
    </div>
    <input id="logFont" type="range" min="12" max="20" value="14"/>
  </div>

  <!-- Picker Popover (emoji/command) -->
  <div class="pickerPopover" id="pickerPopover" aria-hidden="true">
    <div class="pickerHeader">
      <div class="pickerTabs" id="pickerTabs"></div>
      <div class="pickerTools">
        <button id="pickerClose" class="pickerCloseBtn" type="button" title="Îã´Í∏∞">‚úï</button>
      </div>
    </div>
    <div class="pickerBody" id="pickerBody"></div>
  </div>

<script type="module">

// ===== merged module: firebase imports + helpers + app code =====



// ---- script 1 (type="module") ----
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getDatabase, ref, push, set, update, remove, get, runTransaction,
    query, limitToLast, onChildAdded, onValue, onDisconnect
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  import {
    getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  // ‚úÖ boomboom1009-ae518 (ÎÑ§ Í∞íÏúºÎ°ú ÍµêÏ≤¥ ÏôÑÎ£å)
  const firebaseConfig = {
    apiKey: "AIzaSyAQYp8_sfgHMnH7KsTOdGgpMc1niarZiSs",
    authDomain: "boomboom1009-ae518.firebaseapp.com",
    databaseURL: "https://boomboom1009-ae518-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "boomboom1009-ae518",
    storageBucket: "boomboom1009-ae518.firebasestorage.app",
    messagingSenderId: "954818391824",
    appId: "1:954818391824:web:477eb52436aafdb5d67f95"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const storage = getStorage(app);

  async function ensureAnonAuth(){
    if (!auth.currentUser) await signInAnonymously(auth);
    return auth.currentUser;
  }

  // module Î∞ñÏóêÏÑú Ïì∞Í∏∞ ÏúÑÌï¥ windowÎ°ú ÎÖ∏Ï∂ú
  window.FB = {
    app, auth, db, storage, ensureAnonAuth,

    // Realtime Database
    ref, push, set, update, remove, get, runTransaction,
    query, limitToLast, onChildAdded, onValue, onDisconnect,

    // Storage (MP3 Í≥µÏú† ÏóÖÎ°úÎìúÏö©)
    sRef, uploadBytesResumable, getDownloadURL, deleteObject
  };


// ---- script 2 (plain) ----
// Ïú†ÌäúÎ∏å ÌîåÎ†àÏù¥Ïñ¥Îäî iframe_api Î°úÎî© ÌõÑ ÏÉùÏÑ±
  let ytPlayer = null;
  let ytReady = false;

  function loadYouTubeApiOnce(){
    if (document.getElementById('yt_api')) return;
    const s = document.createElement('script');
    s.id = 'yt_api';
    s.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
  }

  window.onYouTubeIframeAPIReady = function(){
    ytReady = true;
    // Ïã§Ï†ú ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ±ÏùÄ "Ïû¨ÏÉù" ÎàÑÎ•º Îïå ÎßåÎì§Í≤å(Î∂àÌïÑÏöîÌïú iframe ÏµúÏÜåÌôî)
  };

  function ensureYtPlayer(videoId){
    if (!ytReady) return null;
    if (ytPlayer) return ytPlayer;

    // Ïà®ÏùÄ ÌîåÎ†àÏù¥Ïñ¥ Ïª®ÌÖåÏù¥ÎÑà
    let box = document.getElementById('yt_box');
    if (!box){
      box = document.createElement('div');
      box.id = 'yt_box';
      box.style.position = 'fixed';
      box.style.left = '-9999px';
      box.style.top = '0';
      document.body.appendChild(box);
    }

    ytPlayer = new YT.Player('yt_box', {
      height: '0',
      width: '0',
      videoId: videoId || '',
      playerVars: { autoplay: 1, controls: 0, loop: 0 },
      events: {
        onReady: () => {
          setBgmState('Ïû¨ÏÉù Ï§ÄÎπÑ');
          // ready
        },
        onStateChange: (e) => {
          // 0=ended, 1=playing, 2=paused
          if (e.data === 1) setBgmState('Ïû¨ÏÉù Ï§ë');
          if (e.data === 2) setBgmState('ÏùºÏãúÏ†ïÏßÄ');
          if (e.data === 0){
            try{ onYtEnded_(); }catch(err){}
          }
        }
      }
    });
    return ytPlayer;
  }


// ---- script 3 (plain) ----
// =====================
  // State
  // =====================
  let sessionId = null;

// =====================
// External mini-game links (separate web apps)
// - Keep everything in this index intact, but open games in new web apps.
// - Set these 3 URLs after you deploy each game web app.
// =====================
const GAME_URLS_ = {
  race:  'PUT_TYPING_RACE_WEBAPP_URL_HERE',
  marble:'PUT_MARBLE_WEBAPP_URL_HERE',
  rummi: 'PUT_RUMMIKUB_WEBAPP_URL_HERE'
};

function openGameLink_(key){
  try{
    const base = String((GAME_URLS_ && GAME_URLS_[key]) || '').trim();
    if (!base || base.includes('PUT_')){
      try{
        showOverlay('ÎØ∏ÎãàÍ≤åÏûÑ URL ÏÑ§Ï†ï ÌïÑÏöî',
          `ÏïÑÏßÅ ${key} ÏõπÏï± Ï£ºÏÜåÍ∞Ä ÎπÑÏñ¥ÏûàÏñ¥Ïöî.\n\nÏΩîÎìúÏóêÏÑú GAME_URLS_Ïóê Î∞∞Ìè¨ URLÏùÑ Î∂ôÏó¨ ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.`);
      }catch(e){}
      return;
    }
    if (!sessionId){
      try{ showOverlay('Ïó∞Í≤∞ Ï§ë', 'ÏÑ∏ÏÖò Ïó∞Í≤∞Ïù¥ ÏïÑÏßÅ ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî. Ïû†Íπê Îí§Ïóê Îã§Ïãú ÎàåÎü¨ Ï£ºÏÑ∏Ïöî!'); }catch(e){}
      return;
    }
    const u = (typeof myName === 'function') ? (myName() || '') : '';
    const url = base + (base.includes('?') ? '&' : '?')
      + 'sid=' + encodeURIComponent(sessionId)
      + '&u=' + encodeURIComponent(u);

    window.open(url, '_blank', 'noopener');
  }catch(e){ console.warn(e); }
}

  let createdAt = 0;
  let joinTs_ = 0; // join time cutoff for events (prevent replay)
  let playingFromPlaylist_ = false; // DJÎßå ÏÇ¨Ïö©: Ïû¨ÏÉùÎ™©Î°ù ÏûêÎèô ÎÑòÍπÄÏö©
  let isStopped = false;

  // Firebase chat/presence/notice
  let fbStarted = false;
  let presenceStarted = false;
  let presenceTimer = null;
  let presenceUid = null;
  let presenceConnKey = null;

  // live presence cache
  let presenceLiveVal = null;

  // typing
  let typingUnsub_ = null;
  let typingRef_ = null;
  let typingLastSent_ = 0;
  let typingIdleTimer_ = null;

  // log auto-scroll control
  let autoScroll_ = true;
  let unreadCount_ = 0;
  const SCROLL_BOTTOM_THRESHOLD_PX = 90;
  let presenceLiveUnsub = null;

  const CLIENT_ID = getClientId();
  const PRESENCE_STALE_MS = 60 * 1000; // 60Ï¥à Ïù¥ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏóÜÏúºÎ©¥ stale Ï≤òÎ¶¨

  // Notice
  const NOTICE_PATH_ = (roomId) => `rooms/${String(roomId)}/notice`;
  const NOTICE_LS_KEY_ = 'VENT_NOTICE_LASTSEEN_AT';
  let noticeUnsub_ = null;
  let noticeCache_ = { text:'', updatedAt:0, by:'' };

  // DJ
  let djUnsub_ = null;
  let djState_ = null; // { uid, name, ts }

  // BGM
  const LS_BGM_URL = 'VENT_BGM_URL';
  const LS_BGM_VOL = 'VENT_BGM_VOL';
  const LS_CHAT_FONT = 'VENT_CHAT_FONT_PX';


  // BGM sync (shared listening)
  let bgmUnsub_ = null;
  let bgmRemote_ = null;
  let bgmAllowed_ = false; // user gesture granted?
  let bgmLastAppliedKey_ = ''; // prevent redundant re-apply
  let bgmAnnouncedKey_ = ''; // prevent duplicate song ticker
  let audioPlayer_ = null;

  // DJ Playlist
  let plUnsub_ = null;
  let plRemote_ = null; // { items:[], curIndex:Number }
  let plSelIndex_ = -1;

  // Song Requests
  let reqUnsub_ = null;
  let reqRemote_ = {}; // {key: {..}}
  function $(id){ return document.getElementById(id); }

  function getClientId(){
    let id = sessionStorage.getItem('VENT_TAB_ID_V1');
    if (!id){
      id = 't_' + Math.random().toString(36).slice(2) + '_' + Date.now();
      sessionStorage.setItem('VENT_TAB_ID_V1', id);
    }
    return id;
  }

  function myName(){
    const v = ($('user').value || '').trim();
    return v || 'ÏùµÎ™Ö';
  }

  
  // =====================
  // Nickname confirm/validation
  // =====================
  const LS_LAST_NICK = 'VENT_LAST_NICK_V1';
  let nickConfirmed_ = false;
  let lastConfirmedNick_ = '';

  function sanitizeNick_(raw){
    let s = String(raw || '').replace(/[\r\n]+/g,' ').trim();
    s = s.replace(/\s{2,}/g,' ');
    return s.slice(0,12);
  }

  function validateNick_(nick){
    const s = sanitizeNick_(nick);
    if (!s) return false;
    if (s === 'ÏùµÎ™Ö') return false;
    if (s.length < 2) return false; // ‚úÖ '„Ñπ' Í∞ôÏùÄ 1Í∏ÄÏûê Î∞©ÏßÄ
    return true;
  }

  function serverName_(){
    const v = sanitizeNick_(($('user')?.value || ''));
    return (nickConfirmed_ && validateNick_(v)) ? v : 'ÏùµÎ™Ö';
  }

  function confirmNickname_(reason){
    const userEl = $('user');
    if (!userEl) return false;

    const raw = userEl.value || '';
    const nick = sanitizeNick_(raw);

    if (!nick){
      nickConfirmed_ = false;
      return false;
    }

    if (!validateNick_(nick)){
      nickConfirmed_ = false;
      showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÄ 2Í∏ÄÏûê Ïù¥ÏÉÅÏúºÎ°ú ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.');
      userEl.focus();
      try{ userEl.select(); }catch(e){}
      return false;
    }

    // Í∞ôÏùÄ ÎãâÎÑ§ÏûÑÏù¥Î©¥ Ïû¨ÌôïÏù∏ ÏÉùÎûµ
    if (nickConfirmed_ && nick === lastConfirmedNick_) return true;

    const ok = window.confirm(`ÎãâÎÑ§ÏûÑÏùÑ "${nick}"(Ïúº)Î°ú ÏÑ§Ï†ïÌï†ÍπåÏöî?`);
    if (!ok){
      nickConfirmed_ = false;
      userEl.focus();
      try{ userEl.select(); }catch(e){}
      return false;
    }

    userEl.value = nick;
    lastConfirmedNick_ = nick;
    nickConfirmed_ = true;
    try{ localStorage.setItem(LS_LAST_NICK, nick); }catch(e){}

    // ÌîÑÎ°úÌïÑ/ÌëúÏãú Í∞±Ïã† + (ÌïÑÏöî Ïãú) ÏûÖÏû• ÏïåÎ¶º
    try{ myProfile_(); }catch(e){}
    try{ setDjUi_(); }catch(e){}
    try{ maybeAnnounceEnter_(); }catch(e){}

    return true;
  }
function escapeHtml(s){
    return (s ?? '').toString().replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function escapeAttr(s){
    return (s ?? '').toString().replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function showOverlay(title, msg){
    try{ setOverlayResizable_(false); }catch(e){}
    $('ovTitle').textContent = title;
    $('ovMsg').textContent = msg;
    const ov = $('overlay');
    if (ov){
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');
    }
  }

  function hideOverlay(){
    try{ setOverlayResizable_(false); }catch(e){}
    const ov = $('overlay');
    if (ov){
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }
  }


  function bindOverlayUi_(){
    try{
      const ov = $('overlay');
      const card = document.querySelector('.overlayCard');
      if (!ov || ov.__bound) return;
      ov.__bound = true;

      // ‚úÖ Ïò§Î≤ÑÎ†àÏù¥ ÌÅ¥Î¶≠Ïù¥ Î¨∏ÏÑúÎ°ú Ï†ÑÌååÎêòÎ©¥ Î©îÎâ¥Í∞Ä Îã´ÌûàÎäî Î¨∏Ï†úÍ∞Ä ÏÉùÍπÄ ‚Üí Ïó¨Í∏∞ÏÑú Ï∞®Îã®
      ov.addEventListener('click', (e)=>{
        try{
          if (e.target === ov){
            try{
              // resizable(Í≤åÏûÑ) Ïò§Î≤ÑÎ†àÏù¥Îäî ÌÅ¨Í∏∞ Ï°∞Ï†à Ï§ë Î∞∞Í≤Ω ÌÅ¥Î¶≠Ïù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏñ¥ Îã´ÏßÄ ÏïäÏùå
              if (!(card && card.classList && card.classList.contains('resizable'))){
                hideOverlay();
              }
            }catch(_e){ hideOverlay(); }
          } // Î∞∞Í≤Ω ÌÅ¥Î¶≠Îßå Îã´Í∏∞
        }catch(err){}
        e.stopPropagation();
      }, false);

      if (card){
        card.addEventListener('click', (e)=> e.stopPropagation(), false);
      }


      // ‚úÖ Ïò§Î≤ÑÎ†àÏù¥ Ïïà Î≤ÑÌäºÏù¥ Î¨¥Î∞òÏùëÏù¥ ÎêòÎäî Î¨∏Ï†ú Î∞©ÏßÄ:
      // - Ïò§Î≤ÑÎ†àÏù¥Í∞Ä Î¨∏ÏÑú ÌÅ¥Î¶≠ÏúºÎ°ú Ï†ÑÌååÎêòÎ©¥ Î©îÎâ¥Í∞Ä Îã´ÌûàÎäî Í±∏ ÎßâÎêò,
      // - Ï∫°Ï≤ò Îã®Í≥ÑÏóêÏÑú ÎßâÏïÑÎ≤ÑÎ¶¨Î©¥ ÎÇ¥Î∂Ä Î≤ÑÌäº ÌÅ¥Î¶≠Ïù¥ ÏïÑÏòà targetÍπåÏßÄ Î™ª Í∞ÄÏÑú "Î≤ÑÌäº Ï£ΩÏùå"Ïù¥ Î∞úÏÉùÌï®.
      //   (Í∑∏ÎûòÏÑú ÏúÑÏóêÏÑú capture=falseÎ°ú Î∞îÍæ∏Í≥†, Ïó¨Í∏∞ÏÑú overlay content Î≤ÑÌäºÏùÑ ÏúÑÏûÑ Ï≤òÎ¶¨)
      const msgEl = $('ovMsg');
      if (msgEl && !msgEl.__actionBound){
        msgEl.__actionBound = true;
        msgEl.addEventListener('click', (ev)=>{
          try{
            const t = ev.target;
            if (!t) return;
            // ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ ÎÇúÏù¥ÎèÑ
            const diffBtn = t.closest?.('.raceDiffCard[data-diff], .raceDiffPill[data-diff]');
            if (diffBtn){
              const diff = diffBtn.getAttribute('data-diff') || 'low';
              try{ localStorage.setItem(RACE_LS_DIFF_, diff); }catch(e){}
              try{ hideOverlay(); }catch(e){}
              try{ startRace_(diff); }catch(e){}
              return;
            }
            // Î£®ÎØ∏ÌÅêÎ∏å(Î≤†ÌÉÄ)
            const actBtn = t.closest?.('[data-action]');
            if (!actBtn) return;
            const act = actBtn.getAttribute('data-action') || '';
            if (act === 'raceStrictToggle'){
              const on = setRaceStrict_(!loadRaceStrict_());
              try{ actBtn.classList.toggle('off', !on); }catch(e){}
              try{ actBtn.textContent = on ? '‚úÖ Ïò§ÌÉÄ 1Î≤à=ÌÉàÎùΩ: ON' : '‚òëÔ∏è Ïò§ÌÉÄ 1Î≤à=ÌÉàÎùΩ: OFF'; }catch(e){}
              return;
            }
            if (act === 'acidStart'){ try{ startAcidRain_(); }catch(e){}; try{ openAcidGame_(); }catch(e){}; return; }
            if (act === 'acidOpen'){ try{ openAcidGame_(); }catch(e){}; return; }
            if (act === 'rkStart'){ rkStartFromUi_(); return; }
            if (act === 'rkDraw'){ rkDraw_(); return; }
            if (act === 'rkNext'){ rkNextTurn_(); return; }
            if (act === 'rkReset'){ rkReset_(); return; }
          }catch(e){}
        }, false);
      }

      const close = (e)=>{
        try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(err){}
        hideOverlay();
      };

      const ok = $('ovOkBtn');
      const x = $('ovCloseBtn');
    }catch(e){}
  }

  function setBgmState(t){
    $('bgmState').textContent = t || 'Ï§ÄÎπÑ';
  }

  
  // =====================
  // Midnight countdown (Asia/Seoul)
  // =====================
  let boomTimer_ = null;
  let midnightReloaded_ = false;

  function seoulNow_(){
    // ‚úÖ ÌÉÄÏûÑÏ°¥ Í≥†Ï†ï: Ìò∏Ïä§Ìä∏/ÏÇ¨Ïö©Ïûê ÌôòÍ≤ΩÏù¥ Îã¨ÎùºÎèÑ ÌïúÍµ≠ ÏûêÏ†ï Í∏∞Ï§ÄÏúºÎ°ú Ïπ¥Ïö¥Ìä∏
    return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
  }

  function formatHms_(ms){
    const t = Math.max(0, Math.floor(ms / 1000));
    const hh = String(Math.floor(t / 3600)).padStart(2,'0');
    const mm = String(Math.floor((t % 3600) / 60)).padStart(2,'0');
    const ss = String(t % 60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  function msToNextMidnightSeoul_(){
    const now = seoulNow_();
    const next = new Date(now);
    next.setHours(24,0,0,0); // next midnight
    return next.getTime() - now.getTime();
  }

  function updateBoomCountdown_(){
    const el = $('boomText');
    if (!el) return;
    const ms = msToNextMidnightSeoul_();
    el.textContent = `${formatHms_(ms)} Ìè≠Ìåå`;

    // ÏûêÏ†ï Ï†ÑÌõÑ: ÏÑ∏ÏÖò Î°§Ïò§Î≤ÑÍ∞Ä ÎäêÎ¶¨Î©¥ ÌÅ¥ÎùºÏóêÏÑúÎèÑ 1Ìöå Î¶¨Î°úÎìúÎ°ú Î≥¥Ï°∞
    if (ms <= 1200 && !midnightReloaded_){
      midnightReloaded_ = true;
      setTimeout(()=>{ try{ location.reload(); }catch(e){} }, 1400);
    }
  }

  function startBoomCountdown_(){
    if (boomTimer_) clearInterval(boomTimer_);
    updateBoomCountdown_();
    boomTimer_ = setInterval(updateBoomCountdown_, 1000);
  }
// =====================
  // Menu UI
  // =====================
  function openMenu(){
    $('menuPanel').classList.add('show');
  }
  function closeMenu(){
    $('menuPanel').classList.remove('show');
  }
  function toggleMenu(){
    $('menuPanel').classList.toggle('show');
  }

  // =====================
  // Session join/ping
  // =====================
  let pingTimer = null;

  function schedulePing(ms){
    if (pingTimer) clearTimeout(pingTimer);
    pingTimer = setTimeout(()=> joinOrPing_(), ms);
  }

  // =====================
  // Session join/ping (RTDB-only, Apps Script Ï†úÍ±∞)
  // - sudaHub/currentSessionV1 Ïóê Ïò§ÎäòÏùò ÏÑ∏ÏÖòIDÎ•º Ï†ÄÏû•
  // - dayKey(ÏÑúÏö∏) Í∏∞Ï§ÄÏúºÎ°ú ÌïòÎ£® 1ÏÑ∏ÏÖò
  // =====================
  const SUDA_HUB_PATH_ = () => `sudaHub/currentSessionV1`;
  function dayKeySeoul_(){
    return new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' })
      .format(new Date());
  }
  function makeSessionId_(){
    // Ï∂©Îèå ÎÇÆÏ∂îÍ∏∞: ÎÇ†Ïßú + ÎûúÎç§
    const dk = dayKeySeoul_().replace(/-/g,'');
    const rnd = Math.random().toString(16).slice(2,10);
    return `suda_${dk}_${rnd}`;
  }
  async function getOrCreateSession_(){
    await window.FB.ensureAnonAuth();
    const hubRef = window.FB.ref(window.FB.db, SUDA_HUB_PATH_());
    const dk = dayKeySeoul_();
    const res = await window.FB.runTransaction(hubRef, (cur)=>{
      cur = cur || {};
      if (cur.dayKey !== dk || !cur.sessionId){
        cur = { dayKey: dk, sessionId: makeSessionId_(), createdAt: Date.now() };
      }
      // ping stamp
      cur.lastPingAt = Date.now();
      return cur;
    });
    const v = res && res.snapshot ? (res.snapshot.val()||{}) : {};
    return { sessionId: v.sessionId, createdAt: Number(v.createdAt||0), dayKey: v.dayKey||dk };
  }
  async function forceResetSession_(reason){
    await window.FB.ensureAnonAuth();
    const hubRef = window.FB.ref(window.FB.db, SUDA_HUB_PATH_());
    const dk = dayKeySeoul_();
    await window.FB.runTransaction(hubRef, (cur)=>{
      cur = cur || {};
      cur.dayKey = dk;
      cur.sessionId = makeSessionId_();
      cur.createdAt = Date.now();
      cur.resetReason = String(reason||'manual');
      cur.resetAt = Date.now();
      return cur;
    });
  }

  // =====================
  // Gate ticket (ÏïΩÌïú Î≥¥Ïïà) - ÎåÄÏãúÎ≥¥Îìú Î≤ÑÌäºÏúºÎ°úÎßå ÏûÖÏû•
  // - URL: ?gateRoom=<ÏûëÏóÖÎ∞©Î£∏>&ticket=<tid>
  // - rooms/{gateRoom}/access/sudaTickets/{tid} Î•º ÌôïÏù∏
  // =====================
  function __toRoomKey(v){return String(v||'').replace(/[.#$\[\]\/]/g,'_');}
  function getQs_(k){
    try{ return new URL(location.href).searchParams.get(k) || ''; }catch(e){ return ''; }
  }
  const TICKET_PATH_ = (gateRoomId, tid) => `rooms/${__toRoomKey(gateRoomId)}/access/sudaTickets/${String(tid)}`;
  async function verifyGateTicket_(){
    // prevent double-run / concurrent double boot
    if (window.__sudaGateVerified) return window.__sudaGateVerified;
    if (window.__sudaGateVerifyPromise) return await window.__sudaGateVerifyPromise;

    window.__sudaGateVerifyPromise = (async () => {

    const rawGate = getQs_('gateRoom') || getQs_('room') || '';
    const tid = getQs_('ticket') || '';
    if (!rawGate || !tid){
      showOverlay('Ï†ëÏÜç Ï†úÌïú', 'ÏûëÏóÖÎ∞© ÎåÄÏãúÎ≥¥Îìú Î≤ÑÌäºÏúºÎ°úÎßå ÏûÖÏû•Ìï† Ïàò ÏûàÏñ¥Ïöî.');
      throw new Error('missing gateRoom/ticket');
    }

    await window.FB.ensureAnonAuth();
    const myUid = window.FB.auth && window.FB.auth.currentUser ? String(window.FB.auth.currentUser.uid || '') : '';

    // ÌõÑÎ≥¥ gateRoom ÌÇ§Îì§(Î≤ÑÏ†Ñ/Î∞∞Ìè¨/Ïù¥Ï†Ñ ÎßÅÌÅ¨ ÌòºÏû¨Ïóê ÎåÄÎπÑ)
    const pathRoom = (()=>{ try{ return String(location.pathname.split('/').filter(Boolean)[0] || ''); }catch(e){ return ''; }})();
    const decodeGate = (()=>{ try{ return decodeURIComponent(String(rawGate)); }catch(e){ return String(rawGate); }})();
    const cands = [
      String(rawGate||'').trim(),
      String(decodeGate||'').trim(),
      __toRoomKey(String(rawGate||'').trim()),
      __toRoomKey(String(decodeGate||'').trim()),
      "magamm",
      __toRoomKey(pathRoom)
    ].filter(Boolean);

    // uniq preserve order
    const seen = new Set();
    const uniq = [];
    for (const c of cands){
      if (!c) continue;
      const k = String(c);
      if (seen.has(k)) continue;
      seen.add(k);
      uniq.push(k);
    }

    let foundRoomId = "";
    let ticketRef = null;

    // 1) Î®ºÏ†Ä "ÏûàÎäî Ìã∞Ïºì" Í≤ΩÎ°úÎ•º Ï∞æÎäîÎã§ (ÏóÜÏúºÎ©¥ transactionÏùÄ Ìï≠ÏÉÅ abortÎê®)
    for (const rid of uniq){
      const ref1 = window.FB.ref(window.FB.db, `rooms/${__toRoomKey(rid)}/access/sudaTickets/${String(tid)}`);
      const snap = await window.FB.get(ref1);
      if (snap && snap.exists && snap.exists()){
        foundRoomId = rid;
        ticketRef = ref1;
        break;
      }
    }

    if (!ticketRef){
      showOverlay('Ï†ëÏÜç Ï†úÌïú', 'ÏûÖÏû• Ìã∞ÏºìÏù¥ ÏóÜÍ±∞ÎÇò ÎßåÎ£åÎêòÏóàÏñ¥Ïöî. ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.');
      throw new Error('invalid/expired ticket (not found)');
    }

    // 2) Ï∞æÏùÄ Í≤ΩÎ°úÏóêÏÑú "1ÌöåÏö© ÏÜåÎπÑ" Ï≤òÎ¶¨ (Ï§ëÎ≥µ Î∂ÄÌä∏/Î¶¨Î°úÎìú Í∞ÄÎìú Ìè¨Ìï®)
    let res = null;
    try{
      res = await window.FB.runTransaction(ticketRef, (cur)=>{
        if (!cur) return; // abort
        const now = Date.now();
        const exp = Number(cur.expAtMs || cur.expAt || 0) || 0;
        if (exp && now > exp) return; // abort

        // Allow reload within grace window for the same user
        if (cur.usedAtMs){
          const graceMs = 60000;
          const usedBy = String(cur.usedByUid || cur.uid || cur.by || '');
          if (usedBy && myUid && usedBy === myUid && (now - Number(cur.usedAtMs || 0) <= graceMs)){
            return cur; // ok
          }
          return; // abort
        }

        cur.usedAtMs = now;
        const who = myUid || String(cur.uid || cur.by || '');
        if (who) cur.usedByUid = who;
        return cur;
      });
    }catch(txErr){
      // If rules block writes (PERMISSION_DENIED), fall back to read-only validation (weak gate).
      console.warn("ticket transaction failed, fallback to read-only validate:", txErr);
      try{
        const snap2 = await window.FB.get(ticketRef);
        if (snap2 && snap2.exists && snap2.exists()){
          const cur = snap2.val ? snap2.val() : null;
          const now = Date.now();
          const exp = Number(cur?.expAtMs || cur?.expAt || 0) || 0;
          if (!exp || now <= exp){
            // treat as ok without consuming
            res = { committed: true, snapshot: snap2 };
          }
        }
      }catch(e2){
        // ignore
      }
    }
if (!res || !res.committed){
      showOverlay('Ï†ëÏÜç Ï†úÌïú', 'ÏûÖÏû• Ìã∞ÏºìÏù¥ ÏóÜÍ±∞ÎÇò ÎßåÎ£åÎêòÏóàÏñ¥Ïöî. ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.');
      throw new Error('invalid/expired ticket');
    }

    return { gateRoomId: foundRoomId, tid };
  })().finally(() => { try{ window.__sudaGateVerifyPromise = null; }catch(e){} });

    const out = await window.__sudaGateVerifyPromise;
    window.__sudaGateVerified = out;
    return out;
  }


  
  async function joinOrPing_(){
    if (isStopped) return;
    try{
      if (!window.FB) { schedulePing(4000); return; }
      const info = await getOrCreateSession_();
      const newId = info.sessionId;
      if (!sessionId && newId){
        sessionId = newId;
        createdAt = Number(info.createdAt || 0);
        $('sessLabel').textContent = `SESSION: ${sessionId}`;
        await initFirebase_(sessionId);
      } else if (sessionId && newId && newId !== sessionId){
        // ‚úÖ ÏûêÏ†ï Ìè≠Ìåå(ÏÑ∏ÏÖò Î≥ÄÍ≤Ω) ‚Üí ÏûêÎèô Ïû¨Ïó∞Í≤∞
        stopAll_();
        showOverlay('üí£ ÏûêÏ†ï Ìè≠Ìåå!', 'ÏÑ∏ÏÖòÏù¥ ÏÉàÎ°ú Ïó¥Î†∏Ïñ¥Ïöî. ÏÉàÎ°ú Í≥†Ïπ® Ìïú Î≤à!');
        setTimeout(()=>{ location.reload(); }, 1500);
        return;
      }
      schedulePing(6000);
    }catch(e){
      schedulePing(6000);
    }
  }


  function stopAll_(){
    isStopped = true;
    try{ stopTyping_(); }catch(e){}
    try { if (pingTimer) clearTimeout(pingTimer); } catch(e){}
    pingTimer = null;
  }

  // =====================
  // Firebase paths
  // =====================
  function fbMessagesPath_(roomId){ return `rooms/${roomId}/messages`; }
  function fbPresenceConnPath_(roomId){ return `rooms/${roomId}/presenceConn`; }
  function fbBgmPath_(roomId){ return `rooms/${roomId}/bgm`; }
  function fbDjPath_(roomId){ return `rooms/${roomId}/dj`; }
  function fbTypingPath_(roomId){ return `rooms/${roomId}/typing`; }
  function fbPlaylistPath_(roomId){ return `rooms/${roomId}/djPlaylist`; }
  function fbRequestsPath_(roomId){ return `rooms/${roomId}/requests`; }

  // Mini game: Typing Race
  function fbRacePath_(roomId){ return `rooms/${roomId}/games/typingRace`; }
  function fbRaceCurrentPath_(roomId){ return `${fbRacePath_(roomId)}/current`; }
  function fbRacePlayersPath_(roomId){ return `${fbRacePath_(roomId)}/players`; }

  // Mini game: Acid Rain (ÏÇ∞ÏÑ±ÎπÑ)
  function fbAcidPath_(roomId){ return `rooms/${roomId}/games/acidRain`; }
  function fbAcidCurrentPath_(roomId){ return `${fbAcidPath_(roomId)}/current`; }
  function fbAcidPlayersPath_(roomId){ return `${fbAcidPath_(roomId)}/players`; }


  // =====================
  // Firebase init
  // =====================
  async function initFirebase_(roomId){
    if (!window.FB) throw new Error('Firebase not loaded');
    await window.FB.ensureAnonAuth();

    

    // ‚úÖ ÏÉàÎ°ú ÏûÖÏû•Ìïú ÏÇ¨ÎûåÏóêÍ≤å Í≥ºÍ±∞ Ïù¥Î≤§Ìä∏(Ïù¥ÌéôÌä∏/Ïô∏ÏπòÍ∏∞ Îì±)Í∞Ä ÌïúÍ∫ºÎ≤àÏóê Ïû¨ÏÉùÎêòÎäî ÌòÑÏÉÅ Î∞©ÏßÄ
    joinTs_ = Date.now();
initChat_(roomId);
    await startPresence_(roomId);
    initPresenceLive_(roomId);
    initDj_(roomId);
    initNotice_(roomId);
    initBgmSync_(roomId);
    initPlaylist_(roomId);
    initRequests_(roomId);
    initTyping_(roomId);
    initTypingRace_(roomId);
    initAcidRain_(roomId);

    // ÏûÖÏû• ÏïåÎ¶º + ÌïòÌä∏ Ïù¥ÌéôÌä∏(ÏÑ∏ÏÖò/ÌÉ≠Îãπ 1Ìöå)
    maybeAnnounceEnter_();

    // UI
    setTimeout(()=> refreshPresenceUi_(), 800);
  }

  // =====================
  // Chat
  // =====================
  function initChat_(roomId){
    if (fbStarted) return;
    fbStarted = true;

    const root = window.FB.ref(window.FB.db, fbMessagesPath_(roomId));
    const q = window.FB.query(root, window.FB.limitToLast(200));

    window.FB.onChildAdded(q, (snap)=>{
      if (!snap.exists()) return;
      const m = snap.val() || {};
      appendMessage_(m);
    });
  }

  async function sendChat_(){
    if (isStopped || !sessionId) return;

    const msgEl = $('msg');
    const text = (msgEl.value || '').trim();
    if (!text) return;

    
    // ‚úÖ ÏùµÎ™Ö ÏÉÅÌÉúÎ©¥ Î®ºÏ†Ä ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï
    if (!isNickConfigured_()){
      showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.');
      try{ $('user')?.focus(); }catch(e){}
      return;
    }
// typing off when sending
    try{ stopTyping_(); }catch(e){}



// üéÜ Commands (robust parse: trailing spaces OK)
// - Î™ÖÎ†πÏñ¥Îäî Ï±ÑÌåÖ(ÏùµÎ™Ö Ìè¨Ìï®)ÏúºÎ°ú ÎÇ®Í∏∞ÏßÄ ÏïäÍ≥†, ÏãúÏä§ÌÖú Î©îÏãúÏßÄ + Ïù¥ÌéôÌä∏Î°úÎßå Ï≤òÎ¶¨
// - Ïù¥ÌéôÌä∏Îäî pushEvent_Î°ú Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ÎêòÏñ¥ Î™®ÎëêÏóêÍ≤å ÎèôÏùºÌïòÍ≤å Î≥¥ÏûÑ
const parts = text.split(/\s+/).filter(Boolean);
const cmd = (parts[0] || '').trim();
const extra = text.slice(cmd.length).trim(); // ÏõêÎ¨∏ÏóêÏÑú cmd Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄ (Î©îÏãúÏßÄ ÏòµÏÖò)
const nm = myName().slice(0,12);

function sysLine_(base, extraText){
  return extraText ? `${base} ‚Äî ${extraText}` : base;
}

async function runFx2_(kind, sysMsg){
  msgEl.value = '';
  await pushSystem_(sysMsg);
  await pushEvent_({ type:'event', event:'fx2', kind, by:nm, ts: Date.now() });
  // NOTE: Î°úÏª¨ÏóêÏÑú Î∞îÎ°ú launchÌïòÏßÄ ÏïäÏùå(Ïù¥Î≤§Ìä∏ ÏàòÏã†ÏúºÎ°ú 1ÌöåÎßå Ïã§Ìñâ)
}

// --- force reset (PIN) ---
// ‚úÖ Ï±ÑÌåÖÏóê "ÎπÑÎ∞ÄÎ≤àÌò∏"Í∞Ä ÎÖ∏Ï∂úÎêòÏßÄ ÏïäÍ≤å, FirebaseÎ°úÎäî Î≥¥ÎÇ¥ÏßÄ ÏïäÍ≥† ÏÑúÎ≤ÑÏóêÎßå Ï†ÑÎã¨
if (cmd === '/Ìè≠Ìåå' || cmd === '/Ï¥àÍ∏∞Ìôî' || cmd === '/Î¶¨ÏÖã' || cmd === '/reset'){
  msgEl.value = '';
  const pin = String(parts[1] || '').trim();
  if (!pin){
    showOverlay('üí£ ÏÑ∏ÏÖò Ï¥àÍ∏∞Ìôî', 'ÎπÑÎ∞ÄÎ≤àÌò∏(ÏïÑÎ¨¥ Í∞í) ÏûÖÎ†•Ïù¥ ÌïÑÏöîÌï¥Ïöî. Ïòà) /Ìè≠Ìåå 1234');
    return;
  }

  const ok = window.confirm('üí£ Ï†ïÎßêÎ°ú ÏÑ∏ÏÖòÏùÑ Í∞ïÏ†úÎ°ú Ìè≠Ìåå(Ï¥àÍ∏∞Ìôî)Ìï†ÍπåÏöî?\n(Î™®ÎëêÍ∞Ä ÏÉà ÏÑ∏ÏÖòÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§)');
  if (!ok) return;

  try{
    stopAll_();
    showOverlay('üí£ Ï¥àÍ∏∞Ìôî Ï§ë...', 'ÏÉà ÏÑ∏ÏÖòÏùÑ Ïó¨Îäî Ï§ëÏù¥ÏóêÏöî. ÏÉàÎ°úÍ≥†Ïπ® Ìïú Î≤à!');
  }catch(e){}

  try{
    await forceResetSession_('chat_command');
  }catch(e){
    alert('Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + (e && e.message ? e.message : e));
  }
  try{ location.reload(); }catch(e){}
  return;
}



// --- fireworks ---
if (cmd === '/ÏôÑÍ≤∞'){
  msgEl.value = '';
  const msg = sysLine_(`üéÜ ${nm}ÎãòÏù¥ ÏôÑÍ≤∞ÏùÑ ÏÑ†Ïñ∏ÌïòÏÖ®ÏäµÎãàÎã§!`, extra);
  await pushSystem_(msg);
  await pushEvent_({ type:'event', event:'fireworks', kind:'complete', by:nm, ts: Date.now() });
  launchFireworks_('complete', nm);
  return;
}
if (cmd === '/Ï∂ïÌïò'){
  msgEl.value = '';
  const msg = sysLine_(`üéâ ${nm}Îãò, Ï∂ïÌïòÎìúÎ¶ΩÎãàÎã§!`, extra);
  await pushSystem_(msg);
  await pushEvent_({ type:'event', event:'fireworks', kind:'race', by:nm, ts: Date.now() });
  launchFireworks_('congrats', nm);
  return;
}

// --- help ---
if (cmd === '/Î™ÖÎ†πÏñ¥' || cmd === '/ÎèÑÏõÄÎßê'){
  msgEl.value = '';
  await pushSystem_(
    `üß≠ ${nm}Îãò, ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Î™ÖÎ†πÏñ¥ ÏïàÎÇ¥ÎìúÎ¶ΩÎãàÎã§.\n` +
    `‚Ä¢ /ÏôÑÍ≤∞ [Î©îÏãúÏßÄ] : ÏôÑÍ≤∞ Ìè≠Ï£Ω\n` +
    `‚Ä¢ /Ï∂ïÌïò [Î©îÏãúÏßÄ] : Ï∂ïÌïò Ìè≠Ï£Ω\n` +
    `‚Ä¢ /Ìè≠Ìåå [ÎπÑÎ∞ÄÎ≤àÌò∏] : ÏÑ∏ÏÖò Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî(Í¥ÄÎ¶¨Ïûê)\n` +
    `‚Ä¢ /Ï¥àÍ∏∞Ìôî [ÎπÑÎ∞ÄÎ≤àÌò∏] : (/Ìè≠ÌååÏôÄ ÎèôÏùº)\n` +
    `‚Ä¢ /ÌïòÌä∏ : ÌïòÌä∏ ÎøåÎ¶¨Í∏∞\n` +
    `‚Ä¢ /Î∞òÏßù : Î∞òÏßùÎ∞òÏßù Ïù¥ÌéôÌä∏\n` +
    `‚Ä¢ /ÎààÍΩÉ : ÎààÍΩÉ ÎÇ¥Î¶¨Í∏∞\n` +
    `‚Ä¢ /Î∞ïÏàò : Î∞ïÏàò Ïù¥ÌéôÌä∏\n` +
    `‚Ä¢ /ÌôòÏòÅ [Î©îÏãúÏßÄ] : ÌôòÏòÅ Î∞òÏßù\n` +
    `‚Ä¢ /Í≥†Ï∂î [Î©îÏãúÏßÄ] : Í≥†Ï∂îÎ†• Ìè≠Î∞ú\n` +
    `‚Ä¢ /ÎΩÄÎΩÄ [Î©îÏãúÏßÄ] : ÎΩÄÎΩÄ\n` +
    `‚Ä¢ /Î∂êÏóÖ [Î©îÏãúÏßÄ] : Î∂ÑÏúÑÍ∏∞ Î∂êÏóÖ\n` +
    `‚Ä¢ /Í≤ΩÍ≥† [Î©îÏãúÏßÄ] : Í≤ΩÍ≥†(ÌôîÎ©¥ ÌùîÎì§Î¶º)\n` +
    `‚Ä¢ /ÎåÑÏä§ [Î©îÏãúÏßÄ] : ÎåÑÏä§ÌÉÄÏûÑ\n` +
    `‚Ä¢ /ÎßàÍ∞ê [Î©îÏãúÏßÄ] : ÏõêÍ≥†Í±∞ÏßÄ(ÏÑúÎ•òÎπÑ)\n` +
    `‚Ä¢ /ÏïàÎÖï [Î©îÏãúÏßÄ] : Ïù∏ÏÇ¨\n` +
    `‚Ä¢ /ÍµøÎ∞îÏù¥ [Î©îÏãúÏßÄ] : ÍµøÎ∞îÏù¥\n` +
    `‚Ä¢ /ÎÅÑÎçï [Î©îÏãúÏßÄ] : ÎÅÑÎçï\n` +
    `‚Ä¢ /Ï†úÎ∞ú [Î©îÏãúÏßÄ] : Ï†úÎ∞ú\n` +
    `‚Ä¢ /ÏàòÏ§ç : ÏàòÏ§ç Ïù¥ÌéôÌä∏\n` +
    `‚Ä¢ /ÌòÑÌÉÄ : ÌòÑÌÉÄ Ïù¥ÌéôÌä∏\n` +
    `‚Ä¢ /Í∞ÅÏÑ± : Í∞ÅÏÑ± Ïù¥ÌéôÌä∏\n` +
    `‚Ä¢ /ÏòÅÍ∞ê [Î©îÏãúÏßÄ] : ÏòÅÍ∞ê Î≤àÏ©ç\n` +
    `‚Ä¢ /Ìá¥Í≥† [Î©îÏãúÏßÄ] : Ìá¥Í≥† Ïó∞ÌïÑÎπÑ\n` +
    `‚Ä¢ /Îñ°Î∞• [Î©îÏãúÏßÄ] : Îñ°Î∞• Ìà¨Ï≤ô\n` +
    `‚Ä¢ /Ï†ïÏ£ºÌñâ [Î©îÏãúÏßÄ] : Ï†ïÏ£ºÌñâ Í∞ÄÏÜç\n` +
    `‚Ä¢ /Ïó∞Ïû¨ [Î©îÏãúÏßÄ] : Ïó∞Ïû¨ Ï∂úÎ∞ú!`
  );
  return;
}

// --- base fx (already supported by appendMessage_) ---
if (cmd === '/ÌïòÌä∏'){
  msgEl.value = '';
  await pushSystem_(`üíó ${nm}ÎãòÏù¥ ÌïòÌä∏Î•º ÎøåÎ¶¨ÏÖ®ÏäµÎãàÎã§!`);
  await pushEvent_({ type:'event', event:'fx', kind:'hearts', by:nm, ts: Date.now() });
  launchFx_('hearts', nm);
  return;
}
if (cmd === '/Î∞òÏßù'){
  msgEl.value = '';
  await pushSystem_(`‚ú® ${nm}ÎãòÏù¥ Î∞òÏßù Ïù¥ÌéôÌä∏Î•º ÏÇ¨Ïö©ÌïòÏÖ®ÏäµÎãàÎã§!`);
  await pushEvent_({ type:'event', event:'fx', kind:'sparkles', by:nm, ts: Date.now() });
  launchFx_('sparkles', nm);
  return;
}
if (cmd === '/ÎààÍΩÉ'){
  msgEl.value = '';
  await pushSystem_(`‚ùÑÔ∏è ${nm}ÎãòÏù¥ ÎààÍΩÉÏùÑ ÎøåÎ¶¨ÏÖ®ÏäµÎãàÎã§!`);
  await pushEvent_({ type:'event', event:'fx', kind:'snow', by:nm, ts: Date.now() });
  launchFx_('snow', nm);
  return;
}
if (cmd === '/Î∞ïÏàò'){
  msgEl.value = '';
  await pushSystem_(`üëè ${nm}ÎãòÏù¥ Î∞ïÏàòÎ•º Î≥¥ÎÇ¥ÏÖ®ÏäµÎãàÎã§!`);
  await pushEvent_({ type:'event', event:'fx', kind:'clap', by:nm, ts: Date.now() });
  launchFx_('clap', nm);
  return;
}

// --- writer room fx2 presets ---
if (cmd === '/ÌôòÏòÅ'){
  await runFx2_('welcome', sysLine_(`üéÄ ${nm}ÎãòÏù¥ ÌôòÏòÅ Ïù∏ÏÇ¨Î•º Ï†ÑÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Í≥†Ï∂î'){
  await runFx2_('pepper', sysLine_(`üå∂Ô∏è ${nm}ÎãòÏù¥ Í≥†Ï∂îÎ†•ÏùÑ ÎÅåÏñ¥Ïò¨Î¶¨ÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/ÎΩÄÎΩÄ'){
  await runFx2_('kiss', sysLine_(`üíã ${nm}ÎãòÏù¥ ÎΩÄÎΩÄÎ•º ÎÇ†Î¶¨ÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Î∂êÏóÖ'){
  await runFx2_('boomup', sysLine_(`üì£ ${nm}ÎãòÏù¥ Î∂ÑÏúÑÍ∏∞Î•º Î∂êÏóÖÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Í≤ΩÍ≥†'){
  await runFx2_('warning', sysLine_(`‚ö†Ô∏è ${nm}ÎãòÏù¥ Í≤ΩÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§.`, extra));
  return;
}
if (cmd === '/ÎåÑÏä§'){
  await runFx2_('dance', sysLine_(`üï∫ ${nm}ÎãòÏù¥ ÎåÑÏä§ÌÉÄÏûÑÏùÑ Ïó¨ÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/ÎßàÍ∞ê' || cmd === '/ÏõêÍ≥†Í±∞ÏßÄ'){
  const base = `üßæ ${nm}ÎãòÏù¥ ÎßàÍ∞êÏùÑ Ïô∏ÏπòÏÖ®ÏäµÎãàÎã§‚Ä¶ (ÏõêÍ≥†Í±∞ÏßÄ Î™®Îìú)`;
  await runFx2_('deadline', sysLine_(base, extra));
  return;
}
if (cmd === '/ÏïàÎÖï'){
  await runFx2_('hello', sysLine_(`üëã ${nm}ÎãòÏù¥ Ïù∏ÏÇ¨ÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/ÍµøÎ∞îÏù¥'){
  await runFx2_('bye', sysLine_(`üåô ${nm}ÎãòÏù¥ ÍµøÎ∞îÏù¥ Ïù∏ÏÇ¨Î•º ÎÇ®Í∏∞ÏÖ®ÏäµÎãàÎã§.`, extra));
  return;
}
if (cmd === '/ÎÅÑÎçï'){
  await runFx2_('nod', sysLine_(`üëç ${nm}ÎãòÏù¥ ÎÅÑÎçïÏù¥ÏÖ®ÏäµÎãàÎã§.`, extra));
  return;
}
if (cmd === '/Ï†úÎ∞ú'){
  await runFx2_('please', sysLine_(`üôè ${nm}ÎãòÏù¥ Í∞ÑÏ†àÌïòÍ≤å Î∂ÄÌÉÅÌïòÏÖ®ÏäµÎãàÎã§‚Ä¶`, extra));
  return;
}

// --- extra trio ---
if (cmd === '/ÏàòÏ§ç'){
  msgEl.value = '';
  await pushSystem_(`üôà ${nm}ÎãòÏù¥ ÏàòÏ§çÏñ¥ÌïòÏã≠ÎãàÎã§‚Ä¶`);
  await pushEvent_({ type:'event', event:'fx2', kind:'shy', by:nm, ts: Date.now() });
  return;
}
if (cmd === '/ÌòÑÌÉÄ'){
  msgEl.value = '';
  await pushSystem_(`ü´• ${nm}ÎãòÏù¥ ÌòÑÌÉÄÎ•º ÎßûÏúºÏÖ®ÏäµÎãàÎã§‚Ä¶`);
  await pushEvent_({ type:'event', event:'fx2', kind:'reality', by:nm, ts: Date.now() });
  return;
}
if (cmd === '/Í∞ÅÏÑ±'){
  msgEl.value = '';
  await pushSystem_(`‚ö° ${nm}ÎãòÏù¥ Í∞ÅÏÑ±ÌïòÏÖ®ÏäµÎãàÎã§!`);
  await pushEvent_({ type:'event', event:'fx2', kind:'awaken', by:nm, ts: Date.now() });
  return;
}



// --- new writer-fun presets (shared) ---
if (cmd === '/ÏòÅÍ∞ê'){
  await runFx2_('inspire', sysLine_(`üí° ${nm}ÎãòÏù¥ ÏòÅÍ∞êÏùÑ Î≤àÏ©ç! ÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Ìá¥Í≥†'){
  await runFx2_('revise', sysLine_(`‚úèÔ∏è ${nm}ÎãòÏù¥ Ìá¥Í≥†Ïóê Îì§Ïñ¥Í∞ÄÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Îñ°Î∞•'){
  await runFx2_('bait', sysLine_(`üß© ${nm}ÎãòÏù¥ Îñ°Î∞•ÏùÑ Ìà¨Ï≤ôÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Ï†ïÏ£ºÌñâ'){
  await runFx2_('binge', sysLine_(`üöÄ ${nm}ÎãòÏù¥ Ï†ïÏ£ºÌñâ ÏóîÏßÑÏùÑ ÏºúÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}
if (cmd === '/Ïó∞Ïû¨'){
  await runFx2_('serialize', sysLine_(`üñãÔ∏è ${nm}ÎãòÏù¥ Ïó∞Ïû¨Î•º ÏãúÏûëÌïòÏÖ®ÏäµÎãàÎã§!`, extra));
  return;
}

// --- shout ticker ---
if (cmd === '/Ïô∏ÏπòÍ∏∞'){
  msgEl.value = '';
  const msg = (extra || '').trim();
  if (!msg){
    await pushSystem_(`üì£ ${nm}Îãò, /Ïô∏ÏπòÍ∏∞ Îí§Ïóê Î¨∏Ïû•ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.`);
    return;
  }
  await pushSystem_(sysLine_(`üì£ ${nm}ÎãòÏù¥ Ïô∏ÏπòÏÖ®ÏäµÎãàÎã§!`, msg));
  await pushEvent_({ type:'event', event:'shout', by:nm, text: msg, ts: Date.now() });
  return;
}

// --- naked shower (cute) ---
if (cmd === '/ÎÇòÏ≤¥ÏÉ§Ïõå'){
  msgEl.value = '';
  const msg = (extra || '').trim() || 'ÎÇòÏ≤¥ÏÉ§ÏõåÌïòÍ≥† ÏòµÎãàÎã§!';
  await pushSystem_(sysLine_(`üöø ${nm}ÎãòÏù¥ ÎÇòÏ≤¥ÏÉ§ÏõåÌïòÎü¨ Í∞ÄÏã≠ÎãàÎã§!`, msg));
  // ticker + bubbly fx
  await pushEvent_({ type:'event', event:'shout', by:nm, text: msg, ts: Date.now() });
  await pushEvent_({ type:'event', event:'fx2', kind:'naked', by:nm, ts: Date.now() });
  return;
}

    const name = myName();
    msgEl.value = '';

    try{
      await window.FB.ensureAnonAuth();
      const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
      const msgRef = window.FB.push(root);

      await window.FB.set(msgRef, {
        uid: myUid_() || '',
        name: name.slice(0,12),
        emoji: (myProfile_().emoji || ''),
        color: (myProfile_().color || ''),
        text: text.slice(0, 2000),
        ts: Date.now(),
        type: 'chat'
      });
    }catch(e){
      alert('Ï†ÑÏÜ° Ïã§Ìå®! ÎÑ§Ìä∏ÏõåÌÅ¨/Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï§ò.');
    }
  }

  function appendMessage_(m){
    const log = $('log');

    const name = String(m.name || 'ÏùµÎ™Ö');
    const text = String(m.text || '');
    const ts = Number(m.ts || 0);
    const type = String(m.type || 'chat');


    // ‚úÖ Í≥ºÍ±∞ Ïù¥Î≤§Ìä∏ Ïû¨ÏÉù Î∞©ÏßÄ(Ïû¨ÏûÖÏû• Ïãú Ìè≠Ï£º Î∞©ÏßÄ)
    if (type === 'event' && joinTs_ && ts && (ts < joinTs_ - 500)) return;


    // event: fireworks
    if (type === 'event' && String(m.event||'') === 'fireworks'){
      const kind = String(m.kind || 'congrats');
      const by = String(m.by || m.name || '');
      launchFireworks_(kind, by);
      return;
    }

    // event: fx (hearts/sparkles/snow/clap)
    if (type === 'event' && String(m.event||'') === 'fx'){
      const kind = String(m.kind || '');
      const by = String(m.by || m.name || '');
      launchFx_(kind, by);
      return;
    }
    

// event: fx2 (emoji burst preset)
if (type === 'event' && String(m.event||'') === 'fx2'){
  const kind = String(m.kind || '');
  const by = String(m.by || m.name || '');
  launchFx2_(kind, by);
  return;
}



// event: shout (ticker)
if (type === 'event' && String(m.event||'') === 'shout'){
  const by = String(m.by || m.name || '');
  const msg = String(m.text || '');
  showTicker_(by, msg);
  return;
}

    const row = document.createElement('div');
    row.className = 'row ' + (type === 'system' ? 'system' : ((String(m.uid||'') && String(m.uid||'') === String(myUid_()||'')) || (name === myName()) ? 'mine' : 'theirs'));

    const meta = document.createElement('div');
    meta.className = 'metaLine';
    meta.textContent = type === 'system'
      ? 'SYSTEM'
      : `${name}`;

    
const bubble = document.createElement('div');
bubble.className = 'bubble';

if (type === 'system'){
  bubble.textContent = text;
}else{
  const prof = {
    emoji: String(m.emoji || ''),
    color: String(m.color || '')
  };
  const fallback = getNickProfile_(name, false);
  const emoji = prof.emoji || fallback.emoji;
  const color = prof.color || fallback.color;

  const badge = document.createElement('span');
  badge.className = 'nickBadge';
  badge.style.borderColor = color;
  badge.style.background = hexToRgba_(color, 0.14);

  const eSpan = document.createElement('span');
  eSpan.className = 'nickEmoji';
  eSpan.textContent = emoji;

  const nSpan = document.createElement('span');
  nSpan.className = 'nickName';
  nSpan.textContent = name;

  badge.appendChild(eSpan);
  badge.appendChild(nSpan);

  const tSpan = document.createElement('span');
  tSpan.className = 'msgText';
  tSpan.textContent = text;

  bubble.appendChild(badge);
  bubble.appendChild(tSpan);
}
const bubbleRow = document.createElement('div');
bubbleRow.className = 'bubbleRow';

if (type === 'system'){
  bubbleRow.appendChild(bubble);
}else{
  const time = document.createElement('span');
  time.className = 'msgTime';
  time.textContent = fmtTime_(ts);

  // ÎÇ¥ Î©îÏãúÏßÄ: ÏãúÍ∞Ñ-ÎßêÌíçÏÑ† / ÏÉÅÎåÄ: ÎßêÌíçÏÑ†-ÏãúÍ∞Ñ
  if (row.classList.contains('mine')){
    bubbleRow.appendChild(time);
    bubbleRow.appendChild(bubble);
  }else{
    bubbleRow.appendChild(bubble);
    bubbleRow.appendChild(time);
  }
}

row.appendChild(meta);
row.appendChild(bubbleRow);
log.appendChild(row);

// ENTRY_HEARTS_V1: ÏûÖÏû• ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï£ºÎ≥Ä ÌïòÌä∏
try{
  
  // Í≥ºÍ±∞ Î°úÍ∑∏ Ïû¨ÏÉùÏúºÎ°ú Ïù∏Ìïú ÌïòÌä∏ Ìè≠Ï£º Î∞©ÏßÄ
  if (joinTs_ && ts && (Number(ts) < joinTs_ - 500)) { /* skip */ }
  else if (type === 'system'){
    const t = String(text||'');
    if (t.startsWith('üíó ') && (t.includes('ÎãòÏù¥ ÏûÖÏû•ÌïòÏÖ®ÏäµÎãàÎã§') || t.includes('ÎãòÏù¥ ÏûÖÏû•ÌïòÏÖ®Ïñ¥Ïöî'))){
      launchHeartsNearEl_(bubble);
    }
  }
}catch(e){}

// Ïä§ÌÅ¨Î°§ Ï†ïÏ±Ö:
// - ÏÇ¨Ïö©ÏûêÍ∞Ä Î∞îÎã• Í∑ºÏ≤òÎ•º Î≥¥Í≥† ÏûàÏùÑ ÎïåÎßå ÏûêÎèô Ïä§ÌÅ¨Î°§
// - ÏúÑÎ°ú Ïò¨Î†§ÏÑú ÏùΩÎäî Ï§ëÏù¥Î©¥ Í≥†Ï†ï + "ÏÉà Î©îÏãúÏßÄ" Î≤ÑÌäº ÌëúÏãú
if (autoScroll_){
  log.scrollTop = log.scrollHeight;
}else{
  unreadCount_ = Math.min(999, unreadCount_ + 1);
  showJumpBtn_(true);
}}


function showJumpBtn_(show){
  const btn = $('jumpBtn');
  const cnt = $('jumpCnt');
  if (!btn || !cnt) return;
  cnt.textContent = String(unreadCount_);
  if (show && unreadCount_ > 0){
    btn.classList.add('show');
  }else{
    btn.classList.remove('show');
  }
}

function updateAutoScrollState_(){
  const log = $('log');
  if (!log) return;
  const dist = (log.scrollHeight - log.scrollTop - log.clientHeight);
  const nearBottom = dist < SCROLL_BOTTOM_THRESHOLD_PX;
  autoScroll_ = nearBottom;
  if (nearBottom){
    unreadCount_ = 0;
    showJumpBtn_(false);
  }
}

  function fmtTime_(ms){
    if (!ms) return '';
    const d = new Date(ms);
    const h = d.getHours();
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ampm = h >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
    const hh = (h % 12) || 12;
    return `${ampm} ${hh}:${mm}`;
  }

  // =====================
  // Presence (Realtime)
  // =====================
  async function startPresence_(roomId){
    if (presenceStarted) return;

    await window.FB.ensureAnonAuth();
    const user = window.FB.auth.currentUser;
    if (!user) return;

    presenceUid = user.uid;
    const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';

    const connRoot = window.FB.ref(window.FB.db, `${fbPresenceConnPath_(roomId)}/${presenceUid}`);
    const connRef = window.FB.push(connRoot);
    presenceConnKey = connRef.key;

    try { window.FB.onDisconnect(connRef).remove(); } catch(e){}

    await window.FB.set(connRef, { name: nm, ts: Date.now(), cid: CLIENT_ID });

    // heartbeat: 15Ï¥àÎßàÎã§ Í∞±Ïã†
    presenceTimer = setInterval(async ()=>{
      try{
        const nm2 = myName().slice(0,12) || 'ÏùµÎ™Ö';
        await window.FB.update(connRef, { name: nm2, ts: Date.now() });
      }catch(e){}
    }, 15000);

    presenceStarted = true;
  }

  function stopPresence_(){
    try { if (presenceTimer) clearInterval(presenceTimer); } catch(e){}
    presenceTimer = null;
    presenceStarted = false;

    try{
      if (presenceLiveUnsub) presenceLiveUnsub();
    }catch(e){}
    presenceLiveUnsub = null;
    presenceLiveVal = null;
  }

  function initPresenceLive_(roomId){
    // rooms/<roomId>/presenceConn Ï†ÑÏ≤¥Î•º Íµ¨ÎèÖÌï¥ÏÑú Ïã§ÏãúÍ∞Ñ Î™©Î°ù Íµ¨ÏÑ±
    try{
      const root = window.FB.ref(window.FB.db, fbPresenceConnPath_(roomId));
      presenceLiveUnsub = window.FB.onValue(root, (snap)=>{
        presenceLiveVal = snap.exists() ? (snap.val() || {}) : {};
        refreshPresenceUi_();
      });
    }catch(e){
      console.warn('presence live subscribe failed', e);
    }
  }

  function refreshPresenceUi_(){
    const r = computePresenceFromConn_(presenceLiveVal);
    $('onlineSub').textContent = `${r.count}Î™Ö`;

    const box = $('onlineList');
    box.innerHTML = '';
    r.names.forEach(n=>{
      const div = document.createElement('div');
      div.className = 'nameChip';
      div.innerHTML = `<span class="nm">${escapeHtml(n)}</span><span class="muted">‚óè</span>`;
      box.appendChild(div);
    });

    // DJ UI may depend on online list
    try{ setDjUi_(); }catch(e){}
  }


// =====================
// Typing indicator (shared)
// =====================
function initTyping_(roomId){
  try{
    const root = window.FB.ref(window.FB.db, fbTypingPath_(roomId));
    typingUnsub_ = window.FB.onValue(root, (snap)=>{
      const val = snap.exists() ? (snap.val() || {}) : {};
      renderTyping_(val);
    });

    const uid = myUid_();
    if (uid){
      typingRef_ = window.FB.ref(window.FB.db, `${fbTypingPath_(roomId)}/${uid}`);
      try{ window.FB.onDisconnect(typingRef_).remove(); }catch(e){}
    }
    bindTypingInput_();
  }catch(e){
    console.warn('initTyping failed', e);
  }
}

function bindTypingInput_(){
  const el = $('msg');
  if (!el || el.__typingBound) return;
  el.__typingBound = true;

  const onAct = ()=>{
    const v = (el.value || '');
    if (!v.trim()){
      stopTyping_();
      return;
    }
    startTyping_();
    clearTimeout(typingIdleTimer_);
    typingIdleTimer_ = setTimeout(()=> stopTyping_(), 1600);
  };

  el.addEventListener('input', onAct);
  el.addEventListener('focus', onAct);
  el.addEventListener('blur', ()=> stopTyping_());
}

async function startTyping_(){
  if (!sessionId || !typingRef_) return;
  const now = Date.now();
  if (now - typingLastSent_ < 800) return; // throttle
  typingLastSent_ = now;

  try{
    await window.FB.ensureAnonAuth();
    await window.FB.set(typingRef_, { name: myName().slice(0,12), ts: now });
  }catch(e){}
}

async function stopTyping_(){
  try{
    clearTimeout(typingIdleTimer_);
    typingIdleTimer_ = null;
    if (typingRef_) await window.FB.remove(typingRef_);
  }catch(e){}
}

function renderTyping_(val){
  const bar = $('typingBar');
  if (!bar) return;
  const txt = $('typingText');
  const target = txt || bar;

  const now = Date.now();
  const my = myName().slice(0,12);
  const names = [];
  const obj = val || {};
  for (const uid of Object.keys(obj)){
    const v = obj[uid];
    if (!v || !v.ts) continue;
    if ((now - Number(v.ts)) > 2500) continue;
    const nm = String(v.name || 'ÏùµÎ™Ö').trim().slice(0,12);
    if (!nm || nm === my) continue;
    names.push(nm);
  }

  if (!names.length){
    bar.classList.remove('show');
    if (target) target.innerHTML = '';
    return;
  }

  const uniq = Array.from(new Set(names)).slice(0,3);
  const more = names.length - uniq.length;
  const who = (uniq.length === 1) ? `${uniq[0]}Îãò` : `${uniq.join('Îãò, ')}Îãò`;
  const tail = more > 0 ? ` Ïô∏ ${more}Î™Ö` : '';
  bar.classList.add('show');
  if (target){
    target.innerHTML = `<span class="typingDot"></span>${escapeHtml(who)}ÍªòÏÑú ÌÉÄÏù¥Ìïë Ï§ëÏûÖÎãàÎã§${tail}‚Ä¶`;
  }
}


// =====================
// Mini Game: Typing Race
// =====================
let raceCur_ = null;
let racePlayers_ = {};
let raceCurUnsub_ = null;
let racePlayersUnsub_ = null;
let raceTick_ = null;
let raceLastSentAt_ = 0;
let raceLastProg_ = -1;
let raceCelebratedId_ = '';
let racePrevStatus_ = '';
let racePrevId_ = '';
let raceMeElim_ = false;
let raceLocalEnabled_ = false;

const RACE_LS_DIFF_ = 'VENT_RACE_DIFF_V1';

const RACE_LS_STRICT_ = 'VENT_RACE_STRICT_V1'; // Ïò§ÌÉÄ Ï¶âÏãú ÌÉàÎùΩ Î™®Îìú
let raceStrict_ = true;
let raceElimAnnouncedFor_ = ''; // raceIdÎ≥Ñ 1ÌöåÎßå ÏïàÎÇ¥

function loadRaceStrict_(){
  try{
    const v = localStorage.getItem(RACE_LS_STRICT_);
    // default: ON
    raceStrict_ = (v === null) ? true : (v !== '0');
  }catch(e){
    raceStrict_ = true;
  }
  return raceStrict_;
}
function setRaceStrict_(on){
  raceStrict_ = !!on;
  try{ localStorage.setItem(RACE_LS_STRICT_, raceStrict_ ? '1' : '0'); }catch(e){}
  return raceStrict_;
}

const RACE_LIMIT_MS_ = 120000; // 120Ï¥à Ï†úÌïú
const RACE_ALLOWED_RE_ = /[0-9A-Za-zÍ∞Ä-Ìû£„Ñ±-„Öé„Öè-„Ö£ !@#$%^&*(),./?]/g; // Ïù¥Î™®ÏßÄ Ï†úÏô∏(ÌóàÏö©: !@#$%^&*(),./?)

// --- Sentence pool builder (‚â•200 per difficulty) ---
let _racePoolCache_ = { low:null, mid:null, high:null };

function hash32_(s){
  s = String(s||'');
  let h = 2166136261 >>> 0;
  for (let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32_(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function shuffleWithRng_(arr, rng){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(rng() * (i + 1));
    const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
  }
  return arr;
}


// ‚úÖ Í≥µÏú† Î¨∏Ïû• ÌíÄ(ÎíπÍµ¥Ïã† 1000Í∞úÏùò Î¨∏Ïû•) Í∏∞Î∞ò
const SHARED_SENTENCES_ = [
  "Ï£ΩÎäî ÎÇ†ÍπåÏßÄ ÌïòÎäòÏùÑ Ïö∞Îü¨Îü¨ Ìïú Ï†ê Î∂ÄÎÅÑÎüºÏù¥ ÏóÜÍ∏∞Î•º, ÏûéÏÉàÏóê Ïù¥Îäî Î∞îÎûåÏóêÎèÑ ÎÇòÎäî Í¥¥Î°úÏõåÌñàÎã§.",
  "Î≥ÑÏùÑ ÎÖ∏ÎûòÌïòÎäî ÎßàÏùåÏúºÎ°ú Î™®Îì† Ï£ΩÏñ¥Í∞ÄÎäî Í≤ÉÏùÑ ÏÇ¨ÎûëÌï¥ÏïºÏßÄ Í∑∏Î¶¨Í≥† ÎÇòÌïúÌÖå Ï£ºÏñ¥ÏßÑ Í∏∏ÏùÑ Í±∏Ïñ¥Í∞ÄÏïºÍ≤†Îã§.",
  "Ïò§Îäò Î∞§ÏóêÎèÑ Î≥ÑÏù¥ Î∞îÎûåÏóê Ïä§ÏπòÏö¥Îã§.",
  "ÎÇò Î≥¥Í∏∞Í∞Ä Ïó≠Í≤®Ïõå Í∞ÄÏã§ ÎïåÏóêÎäî ÎßêÏóÜÏù¥ Í≥†Ïù¥ Î≥¥ÎÇ¥ ÎìúÎ¶¨Ïò§Î¶¨Îã§.",
  "ÏòÅÎ≥ÄÏóê ÏïΩÏÇ∞ ÏßÑÎã¨ÎûòÍΩÉ ÏïÑÎ¶Ñ Îî∞Îã§ Í∞ÄÏã§ Í∏∏Ïóê ÎøåÎ¶¨Ïò§Î¶¨Îã§.",
  "Í∞ÄÏãúÎäî Í±∏Ïùå Í±∏Ïùå ÎÜìÏù∏ Í∑∏ ÍΩÉÏùÑ ÏÇ¨ÎøêÌûà Ï¶àÎ†§Î∞üÍ≥† Í∞ÄÏãúÏòµÏÜåÏÑú.",
  "ÎÇò Î≥¥Í∏∞Í∞Ä Ïó≠Í≤®Ïõå Í∞ÄÏã§ ÎïåÏóêÎäî Ï£ΩÏñ¥ÎèÑ ÏïÑÎãà ÎààÎ¨º ÌùòÎ¶¨Ïò§Î¶¨Îã§.",
  "ÏûêÏÑ∏Ìûà Î≥¥ÏïÑÏïº ÏòàÏÅòÎã§.",
  "Ïò§Îûò Î≥¥ÏïÑÏïº ÏÇ¨ÎûëÏä§ÎüΩÎã§.",
  "ÎÑàÎèÑ Í∑∏Î†áÎã§.",
  "ÎÇ¥Í∞Ä Í∑∏Ïùò Ïù¥Î¶ÑÏùÑ Î∂àÎü¨ Ï£ºÍ∏∞ Ï†ÑÏóêÎäî Í∑∏Îäî Îã§Îßå ÌïòÎÇòÏùò Î™∏ÏßìÏóê ÏßÄÎÇòÏßÄ ÏïäÏïòÎã§.",
  "ÎÇ¥Í∞Ä Í∑∏Ïùò Ïù¥Î¶ÑÏùÑ Î∂àÎü¨ Ï£ºÏóàÏùÑ Îïå Í∑∏Îäî ÎÇòÏóêÍ≤åÎ°ú ÏôÄÏÑú ÍΩÉÏù¥ ÎêòÏóàÎã§.",
  "ÎÇ¥Í∞Ä Í∑∏Ïùò Ïù¥Î¶ÑÏùÑ Î∂àÎü¨ Ï§Ä Í≤ÉÏ≤òÎüº ÎÇòÏùò Ïù¥ ÎπõÍπîÍ≥º Ìñ•Í∏∞Ïóê ÏïåÎßûÏùÄ ÎàÑÍ∞Ä ÎÇòÏùò Ïù¥Î¶ÑÏùÑ Î∂àÎü¨ Îã§Ïò§.",
  "Í∑∏ÏóêÍ≤åÎ°ú Í∞ÄÏÑú ÎÇòÎèÑ Í∑∏Ïùò ÍΩÉÏù¥ ÎêòÍ≥† Ïã∂Îã§.",
  "Ïö∞Î¶¨Îì§ÏùÄ Î™®Îëê Î¨¥ÏóáÏù¥ ÎêòÍ≥† Ïã∂Îã§.",
  "ÎÑàÎäî ÎÇòÏóêÍ≤å ÎÇòÎäî ÎÑàÏóêÍ≤å ÏûäÌòÄÏßÄÏßÄ ÏïäÎäî ÌïòÎÇòÏùò ÎààÏßìÏù¥ ÎêòÍ≥† Ïã∂Îã§.",
  "ÎÇò ÌïòÎäòÎ°ú ÎèåÏïÑÍ∞ÄÎ¶¨Îùº.",
  "ÏÉàÎ≤ΩÎπõ ÏôÄ ÎãøÏúºÎ©¥ Ïä§Îü¨ÏßÄÎäî Ïù¥Ïä¨ ÎçîÎ∂àÏñ¥ ÏÜêÏóê Ïû°Í≥†, ÎÇò ÌïòÎäòÎ°ú ÎèåÏïÑÍ∞ÄÎ¶¨Îùº.",
  "ÎÖ∏ÏùÑÎπõ Ìï®Íªò Îã®ÎëòÏù¥ÏÑú Í∏∞Ïä≠ÏóêÏÑú ÎÜÄÎã§Í∞Ä Íµ¨Î¶Ñ ÏÜêÏßìÌïòÎ©¥ÏùÄ, ÎÇò ÌïòÎäòÎ°ú ÎèåÏïÑÍ∞ÄÎ¶¨Îùº.",
  "ÏïÑÎ¶ÑÎã§Ïö¥ Ïù¥ ÏÑ∏ÏÉÅ ÏÜåÌíç ÎÅùÎÇ¥Îäî ÎÇ†, Í∞ÄÏÑú, ÏïÑÎ¶ÑÎã§Ïõ†ÎçîÎùºÍ≥† ÎßêÌïòÎ¶¨Îùº.",
  "ÎÇ¥ Í∑∏ÎåÄÎ•º ÏÉùÍ∞ÅÌï®ÏùÄ Ìï≠ÏÉÅ Í∑∏ÎåÄÍ∞Ä ÏïâÏïÑ ÏûàÎäî Î∞∞Í≤ΩÏóêÏÑú Ìï¥Í∞Ä ÏßÄÍ≥† Î∞îÎûåÏù¥ Î∂ÄÎäî ÏùºÏ≤òÎüº ÏÇ¨ÏÜåÌïú ÏùºÏùº Í≤ÉÏù¥ÎÇò Ïñ∏Ï††Í∞Ä Í∑∏ÎåÄÍ∞Ä ÌïúÏóÜÏù¥ Í¥¥Î°úÏõÄ ÏÜçÏùÑ Ìó§Îß§Ïùº ÎïåÏóê Ïò§Îû´ÎèôÏïà Ï†ÑÌï¥ Ïò§Îçò Í∑∏ ÏÇ¨ÏÜåÌï®ÏúºÎ°ú Í∑∏ÎåÄÎ•º Î∂àÎü¨Î≥¥Î¶¨Îùº.",
  "ÏßÑÏã§Î°ú ÏßÑÏã§Î°ú ÎÇ¥Í∞Ä Í∑∏ÎåÄÎ•º ÏÇ¨ÎûëÌïòÎäî ÍπåÎã≠ÏùÄ ÎÇ¥ ÎÇòÏùò ÏÇ¨ÎûëÏùÑ ÌïúÎÇ± Í¥¥Î°úÏõÄÏúºÎ°ú Î∞îÍæ∏Ïñ¥ Î≤ÑÎ¶∞ Îç∞ ÏûàÏßÄ ÏïäÍ≥† Î∞§Ïù¥ ÎÇÆÏúºÎ°ú Î≥ÄÌïòÍ≥† ÎÇÆÏù¥ Î∞§ÏúºÎ°ú Î≥ÄÌïòÎäî Ïó¥Î†§ ÏûàÎäî ÏãúÍ∞Ñ ÎïåÎ¨∏Ïùº Í≤ÉÏù¥Îùº.",
  "Í∑∏ÎåÄÍ∞Ä ÌïúÏóÜÏù¥ Ïñ¥Îë† ÏÜçÏùÑ Ìó§Îß§Ïùº ÎïåÏóê ÎÇ¥Í∞Ä Í∞ÄÏ°åÎçò ÎßåÎÇ®Ïùò ÏãúÍ∞ÑÏúºÎ°ú Í∑∏ÎåÄÎ•º Î∂àÎü¨Î≥¥Î¶¨Îùº.",
  "Í≥ÑÏ†àÏù¥ ÏßÄÎÇòÍ∞ÄÎäî ÌïòÎäòÏóêÎäî Í∞ÄÏùÑÎ°ú Í∞ÄÎìù Ï∞® ÏûàÏäµÎãàÎã§.",
  "ÎÇòÎäî ÏïÑÎ¨¥ Í±±Ï†ïÎèÑ ÏóÜÏù¥ Í∞ÄÏùÑ ÏÜçÏùò Î≥ÑÎì§ÏùÑ Îã§ Ìó§Ïùº ÎìØÌï©ÎãàÎã§.",
  "Í∞ÄÏä¥ÏÜçÏóê ÌïòÎÇò Îëò ÏÉàÍ≤®ÏßÄÎäî Î≥ÑÏùÑ Ïù¥Ï†ú Îã§ Î™ª Ìó§Îäî Í≤ÉÏùÄ Ïâ¨Ïù¥ ÏïÑÏπ®Ïù¥ Ïò§Îäî ÍπåÎã≠Ïù¥Ïöî, ÎÇ¥Ïùº Î∞§Ïù¥ ÎÇ®ÏùÄ ÍπåÎã≠Ïù¥Ïöî, ÏïÑÏßÅ ÎÇòÏùò Ï≤≠Ï∂òÏù¥ Îã§ÌïòÏßÄ ÏïäÏùÄ ÍπåÎã≠ÏûÖÎãàÎã§.",
  "Î≥Ñ ÌïòÎÇòÏóê Ï∂îÏñµÍ≥º Î≥Ñ ÌïòÎÇòÏóê ÏÇ¨ÎûëÍ≥º Î≥Ñ ÌïòÎÇòÏóê Ïì∏Ïì∏Ìï®Í≥º Î≥Ñ ÌïòÎÇòÏóê ÎèôÍ≤ΩÍ≥º Î≥Ñ ÌïòÎÇòÏóê ÏãúÏôÄ Î≥Ñ ÌïòÎÇòÏóê Ïñ¥Î®∏Îãà, Ïñ¥Î®∏Îãà.",
  "ÎãòÏùÄ Í∞îÏäµÎãàÎã§.",
  "ÏïÑÏïÑ ÏÇ¨ÎûëÌïòÎäî ÎÇòÏùò ÎãòÏùÄ Í∞îÏäµÎãàÎã§.",
  "Ìë∏Î•∏ ÏÇ∞ÎπõÏùÑ Íπ®ÏπòÍ≥† Îã®ÌíçÎÇòÎ¨¥ Ïà≤ÏùÑ Ìñ•ÌïòÏó¨ ÎÇú ÏûëÏùÄ Í∏∏ÏùÑ Í±∏Ïñ¥ÏÑú Ï∞®Îßà Îñ®ÏπòÍ≥† Í∞îÏäµÎãàÎã§.",
  "Ìô©Í∏àÏùò ÍΩÉÍ∞ôÏù¥ Íµ≥Í≥† ÎπõÎÇòÎçò Ïòõ ÎßπÏÑ∏Îäî Ï∞®ÎîîÏ∞¨ Ìã∞ÎÅåÏù¥ ÎêòÏñ¥ÏÑú ÌïúÏà®Ïùò ÎØ∏ÌíçÏóê ÎÇ†ÏïÑÍ∞îÏäµÎãàÎã§.",
  "ÎÇ†Ïπ¥Î°úÏö¥ Ï≤´ ÌÇ§Ïä§Ïùò Ï∂îÏñµÏùÄ ÎÇòÏùò Ïö¥Î™ÖÏùò ÏßÄÏπ®ÏùÑ ÎèåÎ†§ÎÜìÍ≥† Îí∑Í±∏ÏùåÏ≥êÏÑú ÏÇ¨ÎùºÏ°åÏäµÎãàÎã§.",
  "ÎÑìÏùÄ Î≤å ÎèôÏ™Ω ÎÅùÏúºÎ°ú ÏòõÏù¥ÏïºÍ∏∞ ÏßÄÏ§ÑÎåÄÎäî Ïã§Í∞úÏ≤úÏù¥ ÌúòÎèåÏïÑ ÎÇòÍ∞ÄÍ≥†, ÏñºÎ£©Î∞±Ïù¥ Ìô©ÏÜåÍ∞Ä Ìï¥ÏÑ§Ìîº Í∏àÎπõ Í≤åÏúºÎ•∏ Ïö∏ÏùåÏùÑ Ïö∞Îäî Í≥≥, Í∑∏Í≥≥Ïù¥ Ï∞®Îßà ÍøàÏóîÎì§ ÏûäÌûê Î¶¨Ïïº.",
  "ÏßàÌôîÎ°úÏóê Ïû¨Í∞Ä ÏãùÏñ¥ÏßÄÎ©¥ ÎπÑÏù∏ Î∞≠Ïóê Î∞§Î∞îÎûå ÏÜåÎ¶¨ ÎßêÏùÑ Îã¨Î¶¨Í≥†, Ïó∑ÏùÄ Ï°∏ÏùåÏóê Í≤®Ïö¥ ÎäôÏúºÏã† ÏïÑÎ≤ÑÏßÄÍ∞Ä ÏßöÎ≤†Í∞úÎ•º ÎèãÏïÑ Í≥†Ïù¥ÏãúÎäî Í≥≥, Í∑∏Í≥≥Ïù¥ Ï∞®Îßà ÍøàÏóîÎì§ ÏûäÌûê Î¶¨Ïïº.",
  "Ìïú ÏÜ°Ïù¥Ïùò Íµ≠ÌôîÍΩÉÏùÑ ÌîºÏö∞Í∏∞ ÏúÑÌï¥ Î¥ÑÎ∂ÄÌÑ∞ ÏÜåÏ©çÏÉàÎäî Í∑∏Î†áÍ≤å Ïö∏ÏóàÎÇò Î≥¥Îã§.",
  "Ìïú ÏÜ°Ïù¥Ïùò Íµ≠ÌôîÍΩÉÏùÑ ÌîºÏö∞Í∏∞ ÏúÑÌï¥ Ï≤úÎë•ÏùÄ Î®πÍµ¨Î¶Ñ ÏÜçÏóêÏÑú Îòê Í∑∏Î†áÍ≤å Ïö∏ÏóàÎÇò Î≥¥Îã§.",
  "Í∑∏Î¶¨ÏõÄÏóê ÏßÄÏ≥ê Î®º Î®º Ï†äÏùåÏùò Îí§ÏïàÍ∏∏ÏóêÏÑú Ïù¥Ï†úÎäî ÎèåÏïÑÏôÄ Í±∞Ïö∏ ÏïûÏóê ÏÑ† ÎÇ¥ ÎàÑÎãòÍ∞ôÏù¥ ÏÉùÍ∏¥ ÍΩÉÏù¥Ïó¨.",
  "ÎÖ∏ÎûÄ ÎÑ§ ÍΩÉÏûéÏù¥ ÌîºÎ†§Í≥† Í∞ÑÎ∞§Ïóî Î¨¥ÏÑúÎ¶¨Í∞Ä Ï†ÄÎ¶¨ ÎÇ¥Î¶¨Í≥† ÎÇ¥Í≤åÎäî Ïû†ÎèÑ Ïò§ÏßÄ ÏïäÏïòÎÇò Î≥¥Îã§.",
  "ÌùîÎì§Î¶¨ÏßÄ ÏïäÍ≥† ÌîºÎäî ÍΩÉÏù¥ Ïñ¥Îîî ÏûàÏúºÎû¥.",
  "Ïù¥ ÏÑ∏ÏÉÅ Í∑∏ Ïñ¥Îñ§ ÏïÑÎ¶ÑÎã§Ïö¥ ÍΩÉÎì§ÎèÑ Îã§ ÌùîÎì§Î¶¨Î©¥ÏÑú ÌîºÏóàÎÇòÎãà ÌùîÎì§Î¶¨Î©¥ÏÑú Ï§ÑÍ∏∞Î•º Í≥ßÍ≤å ÏÑ∏Ïõ†ÎÇòÎãà ÌùîÎì§Î¶¨ÏßÄ ÏïäÍ≥† Í∞ÄÎäî ÏÇ¨ÎûëÏù¥ Ïñ¥Îîî ÏûàÏúºÎû¥.",
  "Ï†ñÏßÄ ÏïäÍ≥† ÌîºÎäî ÍΩÉÏù¥ Ïñ¥Îîî ÏûàÏúºÎû¥.",
  "Ïù¥ ÏÑ∏ÏÉÅ Í∑∏ Ïñ¥Îñ§ ÎπõÎÇòÎäî ÍΩÉÎì§ÎèÑ Îã§ Ï†ñÏúºÎ©∞ Ï†ñÏúºÎ©∞ ÌîºÏóàÎÇòÎãà Î∞îÎûåÍ≥º ÎπÑÏóê Ï†ñÏúºÎ©∞ ÍΩÉÏûé Îî∞ÎúªÌïòÍ≤å ÌîºÏõ†ÎÇòÎãà Ï†ñÏßÄ ÏïäÍ≥† Í∞ÄÎäî ÏÇ∂Ïù¥ Ïñ¥Îîî ÏûàÏúºÎû¥.",
  "Ïó∞ÌÉÑÏû¨ Ìï®Î∂ÄÎ°ú Î∞úÎ°ú Ï∞®ÏßÄ ÎßàÎùº.",
  "ÎÑàÎäî ÎàÑÍµ¨ÏóêÍ≤å Ìïú Î≤àÏù¥ÎùºÎèÑ Îú®Í±∞Ïö¥ ÏÇ¨ÎûåÏù¥ÏóàÎäêÎÉê.",
  "ÏÇ¨ÎûåÏù¥ Ïò®Îã§Îäî Í±¥ Ïã§ÏùÄ Ïñ¥ÎßàÏñ¥ÎßàÌïú ÏùºÏù¥Îã§.",
  "Í∑∏Îäî Í∑∏Ïùò Í≥ºÍ±∞ÏôÄ ÌòÑÏû¨ÏôÄ Í∑∏Î¶¨Í≥† Í∑∏Ïùò ÎØ∏ÎûòÏôÄ Ìï®Íªò Ïò§Í∏∞ ÎïåÎ¨∏Ïù¥Îã§.",
  "Ìïú ÏÇ¨ÎûåÏùò ÏùºÏÉùÏù¥ Ïò§Í∏∞ ÎïåÎ¨∏Ïù¥Îã§.",
  "Î∂ÄÏÑúÏßÄÍ∏∞ Ïâ¨Ïö¥ Í∑∏ÎûòÏÑú Î∂ÄÏÑúÏßÄÍ∏∞ÎèÑ ÌñàÏùÑ ÎßàÏùåÏù¥ Ïò§Îäî Í≤ÉÏù¥Îã§.",
  "Í∑∏ Í∞àÌîºÎ•º ÏïÑÎßà Î∞îÎûåÏùÄ ÎçîÎì¨Ïñ¥Î≥º Ïàò ÏûàÏùÑ ÎßàÏùå, ÎÇ¥ ÎßàÏùåÏù¥ Í∑∏Îü∞ Î∞îÎûåÏùÑ ÌùâÎÇ¥ ÎÇ∏Îã§Î©¥ ÌïÑÍ≤Ω ÌôòÎåÄÍ∞Ä Îê† Í≤ÉÏù¥Îã§.",
  "Í∞ÄÎÇúÌïòÎã§Í≥† Ìï¥ÏÑú Ïô∏Î°úÏõÄÏùÑ Î™®Î•¥Í≤†ÎäîÍ∞Ä.",
  "ÎÑàÏôÄ Ìó§Ïñ¥Ï†∏ ÎèåÏïÑÏò§Îäî Îàà ÏåìÏù∏ Í≥®Î™©Í∏∏Ïóê ÏÉàÌïòÏñóÍ≤å Îã¨Ïù¥ Îú®ÎäîÎç∞.",
  "Í∞ÄÎÇúÌïòÎã§Í≥† Ìï¥ÏÑú ÎëêÎ†§ÏõÄÏù¥ ÏóÜÍ≤†ÎäîÍ∞Ä.",
  "Îëê Ï†êÏùÑ ÏπòÎäî ÏÜåÎ¶¨ Î∞©Î≤îÎåÄÏõêÏùò Ìò∏Í∞ÅÏÜåÎ¶¨ Î©îÎ∞ÄÎ¨µ ÏÇ¨Î†§ ÏÜåÎ¶¨Ïóê ÎààÏùÑ Îú®Î©¥ Î©ÄÎ¶¨ Ïú°Ï§ëÌïú Í∏∞Í≥Ñ Íµ¥Îü¨Í∞ÄÎäî ÏÜåÎ¶¨.",
  "Í∞ÄÎÇúÌïòÎã§Í≥† Ìï¥ÏÑú ÏÇ¨ÎûëÏùÑ Î™®Î•¥Í≤†ÎäîÍ∞Ä.",
  "ÎÇ¥ Î≥ºÏóê ÏôÄ ÎãøÎçò ÎÑ§ ÏûÖÏà†Ïùò Îú®Í±∞ÏõÄ, ÏÇ¨ÎûëÌïúÎã§Í≥† ÏÇ¨ÎûëÌïúÎã§Í≥† ÏÜçÏÇ≠Ïù¥Îçò ÎÑ§ Ïà®Í≤∞, ÎèåÏïÑÏÑúÎäî ÎÇ¥ Îì± Îí§Ïóê ÌÑ∞ÏßÄÎçò ÎÑ§ Ïö∏Ïùå.",
  "Í∞ÄÏïº Ìï† ÎïåÍ∞Ä Ïñ∏Ï†úÏù∏Í∞ÄÎ•º Î∂ÑÎ™ÖÌûà ÏïåÍ≥† Í∞ÄÎäî Ïù¥Ïùò Îí∑Î™®ÏäµÏùÄ ÏñºÎßàÎÇò ÏïÑÎ¶ÑÎã§Ïö¥Í∞Ä.",
  "Î¥Ñ Ìïú Ï≤† Í≤©Ï†ïÏùÑ Ïù∏ÎÇ¥Ìïú ÎÇòÏùò ÏÇ¨ÎûëÏùÄ ÏßÄÍ≥† ÏûàÎã§.",
  "Î∂ÑÎ∂ÑÌïú ÎÇôÌôî, Í≤∞Î≥ÑÏù¥ Ïù¥Î£©ÌïòÎäî Ï∂ïÎ≥µÏóê Ïã∏Ïó¨ ÏßÄÍ∏àÏùÄ Í∞ÄÏïº Ìï† Îïå.",
  "Î¨¥ÏÑ±Ìïú ÎÖπÏùåÍ≥º Í∑∏Î¶¨Í≥† Î®∏ÏßÄÏïäÏïÑ Ïó¥Îß§ Îß∫Îäî Í∞ÄÏùÑÏùÑ Ìñ•ÌïòÏó¨ ÎÇòÏùò Ï≤≠Ï∂òÏùÄ ÍΩÉÎãµÍ≤å Ï£ΩÎäîÎã§.",
  "Î®º ÌõÑÏùº ÎãπÏã†Ïù¥ Ï∞æÏúºÏãúÎ©¥ Í∑∏ÎïåÏóê ÎÇ¥ ÎßêÏù¥ \"ÏûäÏóàÎÖ∏Îùº\".",
  "ÎãπÏã†Ïù¥ ÏÜçÏúºÎ°ú ÎÇòÎ¨¥ÎùºÎ©¥ \"Î¨¥Ï≤ô Í∑∏Î¶¨Îã§Í∞Ä ÏûäÏóàÎÖ∏Îùº\".",
  "Í∑∏ÎûòÎèÑ ÎãπÏã†Ïù¥ ÎÇòÎ¨¥ÎùºÎ©¥ \"ÎØøÍ∏∞ÏßÄ ÏïäÏïÑÏÑú ÏûäÏóàÎÖ∏Îùº\".",
  "Ïò§ÎäòÎèÑ Ïñ¥Ï†úÎèÑ ÏïÑÎãà ÏûäÍ≥† Î®º ÌõÑÏùº Í∑∏ÎïåÏóê \"ÏûäÏóàÎÖ∏Îùº\".",
  "ÏÇ¨ÎûëÌïòÎäî Í≤ÉÏùÄ ÏÇ¨ÎûëÏùÑ Î∞õÎäêÎãàÎ≥¥Îã§ ÌñâÎ≥µÌïòÎÇòÎãàÎùº.",
  "Ïò§ÎäòÎèÑ ÎÇòÎäî ÏóêÎ©îÎûÑÎìúÎπõ ÌïòÎäòÏù¥ ÌôòÌûà ÎÇ¥Îã§ÎµàÎäî Ïö∞Ï≤¥Íµ≠ Ï∞ΩÎ¨∏ ÏïûÏóê ÏôÄÏÑú ÎÑàÏóêÍ≤å Ìé∏ÏßÄÎ•º Ïì¥Îã§.",
  "ÌñâÍ∏∏ÏùÑ Ìñ•Ìï¥ ÎÇú Î¨∏ÏúºÎ°ú ÏàòÏóÜÏù¥ ÎßéÏùÄ ÏÇ¨ÎûåÎì§Ïù¥ Ï†úÍ∞ÅÍ∏∞ Ìïú Í∞ÄÏßÄÏî© ÏÉùÍ∞ÅÏóê Ï†ñÏñ¥ Ïò§Í≥† Í∞ÄÍ≥†, ÎÇ¥Í∞Ä Ï†ÄÎì§ÏùÑ Î∂ÄÎ•º Í∏∞ÏïΩ ÏóÜÎäî Ïù∏Ïó∞Ïù¥ÎùºÍ≥† ÏÉùÍ∞ÅÌï† Îïå, ÎÑàÏóêÍ≤å Î≥¥ÎÇ¥Îäî ÎÇòÏùò Ìé∏ÏßÄÎäî ÎçîÏö± Îú®Í±∞Ïö¥ ÏÇ¨ÎûëÏùò Í≥†Î∞±Ïù¥ Îê†ÏßÄÎèÑ Î™®Î•∏Îã§.",
  "ÎÇòÎëêÏïº Í∞ÑÎã§.",
  "ÎÇòÏùò Ïù¥ Ï†äÏùÄ ÎÇòÏù¥Î•º ÎààÎ¨ºÎ°úÏïº Î≥¥ÎÇº Í±∞ÎÉê.",
  "ÎÇòÎëêÏïº Í∞ÄÎ†®Îã§.",
  "ÏïÑÎäëÌïú Ïù¥ Ìï≠Íµ¨Ïù∏Îì§ ÏÜêÏâΩÍ≤åÏïº Î≤ÑÎ¶¥ Í±∞ÎÉê.",
  "ÏïàÍ∞úÍ∞ôÏù¥ ÏûêÏö±Ìïú Î∂ÑÎÖ∏Í∞Ä Í∞ÄÎ°úÎßâÏïÑÎèÑ ÎÇòÎëêÏïº Í∞ÄÎ†®Îã§.",
  "Î™®Í∞ÄÏßÄÍ∞Ä Í∏∏Ïñ¥ÏÑú Ïä¨Ìîà ÏßêÏäπÏù¥Ïó¨, Ïñ∏Ï†úÎÇò Ï†êÏûñÏùÄ Ìé∏ ÎßêÏù¥ ÏóÜÍµ¨ÎÇò.",
  "Í¥Ä(ÂÜ†)Ïù¥ Ìñ•Í∏∞Î°úÏö¥ ÎÑàÎäî Î¨¥Ï≤ô ÎÜíÏùÄ Ï°±ÏÜçÏù¥ÏóàÎÇò Î≥¥Îã§.",
  "Î¨ºÏÜçÏùò Ï†ú Í∑∏Î¶ºÏûêÎ•º Îì§Ïó¨Îã§Î≥¥Í≥† ÏûÉÏóàÎçò Ï†ÑÏÑ§ÏùÑ ÏÉùÍ∞ÅÌï¥ ÎÇ¥Í≥†Îäî Ïñ¥Ï∞åÌï† Ïàò ÏóÜÎäî Ìñ•ÏàòÏóê Ïä¨Ìîà Î™®Í∞ÄÏßÄÎ•º ÌïòÍ≥† Î®º Îç∞ ÌïòÎäòÏùÑ Î∞îÎùºÎ≥∏Îã§.",
  "ÌååÎèÑÏïº Ïñ¥Ï©åÎûÄ ÎßêÏù¥ÎÉê, ÌååÎèÑÏïº Ïñ¥Ï©åÎûÄ ÎßêÏù¥ÎÉê.",
  "ÏûÑÏùÄ Î≠çÍ∞ôÏù¥ ÍπåÎî± ÏïäÎäîÎç∞, ÌååÎèÑÏïº Ïñ¥Ï©åÎûÄ ÎßêÏù¥ÎÉê.",
  "ÎÇ† Ïñ¥Ï©åÎûÄ ÎßêÏù¥ÎÉê.",
  "Ìï¥Ïïº ÏÜüÏïÑÎùº, Ìï¥Ïïº ÏÜüÏïÑÎùº.",
  "ÎßêÍ∞õÍ≤å ÏîªÏùÄ ÏñºÍµ¥ Í≥†Ïö¥ Ìï¥Ïïº ÏÜüÏïÑÎùº.",
  "ÏÇ∞ ÎÑòÏñ¥ ÏÇ∞ ÎÑòÏñ¥ÏÑú Ïñ¥Îë†ÏùÑ ÏÇ¥Îùº Î®πÍ≥†, ÏÇ∞ ÎÑòÏñ¥ Î∞§ÏÉàÎèÑÎ°ù Ïñ¥Îë†ÏùÑ ÏÇ¥Îùº Î®πÍ≥†, Ïù¥Í∏ÄÏù¥Í∏Ä Ïï†Îù≥ ÏñºÍµ¥ Í≥†Ïö¥ Ìï¥Ïïº ÏÜüÏïÑÎùº.",
  "Îã¨Î∞§Ïù¥ Ïã´Ïñ¥, Îã¨Î∞§Ïù¥ Ïã´Ïñ¥, ÎààÎ¨º Í∞ôÏùÄ Í≥®ÏßúÍ∏∞Ïóê Îã¨Î∞§Ïù¥ Ïã´Ïñ¥, ÏïÑÎ¨¥ÎèÑ ÏóÜÎäî Îú∞Ïóê Îã¨Î∞§Ïù¥ ÎÇòÎäî Ïã´Ïñ¥.",
  "Ï†ÄÍ≤ÉÏùÄ Î≤Ω Ïñ¥Ï©î Ïàò ÏóÜÎäî Î≤ΩÏù¥ÎùºÍ≥† Ïö∞Î¶¨Í∞Ä ÎäêÎÇÑ Îïå, Í∑∏Îïå Îã¥ÏüÅÏù¥Îäî ÎßêÏóÜÏù¥ Í∑∏ Î≤ΩÏùÑ Ïò§Î•∏Îã§.",
  "Î¨º Ìïú Î∞©Ïö∏ ÏóÜÍ≥† Ïî®Ïïó Ìïú ÌÜ® ÏÇ¥ÏïÑÎÇ®ÏùÑ Ïàò ÏóÜÎäî Ï†ÄÍ≤ÉÏùÄ Ï†àÎßùÏùò Î≤ΩÏù¥ÎùºÍ≥† ÎßêÌï† Îïå Îã¥ÏüÅÏù¥Îäî ÏÑúÎëêÎ•¥ÏßÄ ÏïäÍ≥† ÏïûÏúºÎ°ú ÎÇòÏïÑÍ∞ÑÎã§.",
  "Ìïú ÎºòÏù¥ÎùºÎèÑ Íº≠ Ïó¨ÎüøÏù¥ Ìï®Íªò ÏÜêÏùÑ Ïû°Í≥† Ïò¨ÎùºÍ∞ÑÎã§.",
  "Ìë∏Î•¥Í≤å Ï†àÎßùÏùÑ Îã§ ÎçÆÏùÑ ÎïåÍπåÏßÄ Î∞îÎ°ú Í∑∏ Ï†àÎßùÏùÑ Ïû°Í≥† ÎÜìÏßÄ ÏïäÎäîÎã§.",
  "Í∞ÄÎ¨∏ ÏÑ¨ÏßÑÍ∞ï ÏïÑÏù¥Îì§ÏïÑ, ÎÑàÌù¨Îì§ÏùÄ ÏïÑÎäêÎÉê.",
  "ÍµΩÏù¥ÍµΩÏù¥ ÌùêÎ•¥Îäî Ï†Ä Î¨ºÍ∏∏Ïù¥ Ïñ¥ÎîîÎ°ú Í∞ÄÎäîÏßÄ.",
  "ÌùêÎ•¥Îã§ ÌùêÎ•¥Îã§ ÏßÄÏ≥êÏÑú Î©àÏ∂îÎäî Í≥≥Ïù¥ Ïñ¥ÎîîÏù∏ÏßÄ ÎÑàÌù¨Îì§ÏùÄ ÏïÑÎäêÎÉê.",
  "Í∞ÄÎèÑ Í∞ÄÎèÑ ÎÅùÏóÜÎäî Ï†Ä ÏÇ∞ ÏûêÎùΩÎì§Ïù¥ Ïôú Ï†ÄÎ†áÍ≤å Ìë∏Î•∏ÏßÄ ÎÑàÌù¨Îì§ÏùÄ ÏïÑÎäêÎÉê.",
  "Í∑∏ÎåÄ Ïò§ÏãúÎäî Í∏∏Ïóê ÍΩÉ Ìïú ÏÜ°Ïù¥ ÌîºÏö∞Í≥† Ïã∂Ïñ¥, Î∞úÏûêÍµ≠ ÏÜåÎ¶¨ Îì§Î¶¨Îäî Í≥≥ÎßàÎã§ ÍΩÉÎì§Ïù¥ Î®ºÏ†Ä ÎßàÏ§ë ÎÇòÍ∞ÄÎäî Í∑∏Îü∞ Î¥ÑÎÇ†Ïù¥Í≥† Ïã∂ÏäµÎãàÎã§.",
  "ÎÇ¥ ÎßàÏùåÏÜçÏóê ÎãπÏã†Ïù¥ÎùºÎäî Ïù¥Î¶ÑÏù¥ ÍΩÉÏ≤òÎüº ÌîºÏñ¥ÎÇ† Îïå, ÏÑ∏ÏÉÅÏùÄ Ïò®ÌÜµ ÎãπÏã†Ïùò Ìñ•Í∏∞Î°ú Í∞ÄÎìùÌï©ÎãàÎã§.",
  "Ìë∏Î•∏ ÌïòÎäòÏùÑ Ï†úÏïïÌïòÎäî ÎÖ∏Í≥†ÏßÄÎ¶¨Í∞Ä ÏûêÏú†Î°úÏôîÎã§Í≥† Î∂ÄÎü¨ÏõåÌïòÎçò Ïñ¥Îäê ÏãúÏù∏Ïùò ÎßêÏùÄ ÏàòÏ†ïÎêòÏñ¥Ïïº ÌïúÎã§.",
  "ÏûêÏú†Î•º ÏúÑÌï¥ÏÑú ÎπÑÏÉÅÌïòÏó¨ Î≥∏ ÏùºÏù¥ ÏûàÎäî ÏÇ¨ÎûåÏù¥Î©¥ ÏïåÏßÄ.",
  "ÎÖ∏Í≥†ÏßÄÎ¶¨Í∞Ä Î¨¥ÏóáÏùÑ Î≥¥Í≥† ÎÖ∏ÎûòÌïòÎäîÍ∞ÄÎ•º.",
  "Ïñ¥Ïß∏ÏÑú ÏûêÏú†ÏóêÎäî ÌîºÏùò ÎÉÑÏÉàÍ∞Ä ÏÑûÏó¨ ÏûàÎäîÍ∞ÄÎ•º.",
  "ÌòÅÎ™ÖÏùÄ Ïôú Í≥†ÎèÖÌï¥Ïïº ÌïòÎäîÍ∞ÄÎ•º.",
  "Ìñ•Îã®ÏïÑ Í∑∏ÎÑ§Ï§ÑÏùÑ Î∞ÄÏñ¥Îùº.",
  "Î®∏Ïñ∏ Î∞îÎã§Î°ú Î∞∞Î•º ÎÇ¥Ïñ¥ Î∞Ä ÎìØÏù¥, Ìñ•Îã®ÏïÑ.",
  "Ïù¥ Îã§ÏÜåÍ≥≥Ïù¥ ÌùîÎì§Î¶¨Îäî ÏàòÏñëÎ≤ÑÎì§ ÎÇòÎ¨¥ÏôÄ Î≤†Í∞ØÎ™®Ïóê ÎÜìÏù∏ Í∏àÏã§ ÏõêÏïôÏÉàÎ•º Í±¥ÎÑàÏÑú, Ìñ•Îã®ÏïÑ.",
  "ÏÇ∞Ìò∏ÎèÑ ÏÑ¨ÎèÑ ÏóÜÎäî Ï†Ä ÌïòÎäòÎ°ú ÎÇòÎ•º Î∞ÄÏñ¥ Ïò¨Î†§Îã§Ïò§.",
  "Ï±ÑÏÉâÌïú Íµ¨Î¶ÑÍ∞ôÏù¥ ÎÇòÎ•º Î∞ÄÏñ¥ Ïò¨Î†§Îã§Ïò§.",
  "Ïù¥ Ïö∏Î†ÅÏù¥Îäî Í∞ÄÏä¥ÏùÑ Î∞ÄÏñ¥ Ïò¨Î†§Îã§Ïò§!",
  "ÏÇ∞ÏóêÎäî ÍΩÉ ÌîºÎÑ§, ÍΩÉÏù¥ ÌîºÎÑ§.",
  "Í∞à Î¥Ñ Ïó¨Î¶Ñ ÏóÜÏù¥ ÍΩÉÏù¥ ÌîºÎÑ§.",
  "ÏÇ∞Ïóê ÏÇ∞Ïóê ÌîºÎäî ÍΩÉÏùÄ Ï†ÄÎßåÏπò ÌòºÏûêÏÑú ÌîºÏñ¥ ÏûàÎÑ§.",
  "ÏÇ∞ÏóêÏÑú Ïö∞Îäî ÏûëÏùÄ ÏÉàÏó¨, ÍΩÉÏù¥ Ï¢ãÏïÑ ÏÇ∞ÏóêÏÑú ÏÇ¨ÎÖ∏ÎùºÎÑ§.",
  "ÏÇ∞ÏóêÎäî ÍΩÉ ÏßÄÎÑ§, ÍΩÉÏù¥ ÏßÄÎÑ§.",
  "Í∞à Î¥Ñ Ïó¨Î¶Ñ ÏóÜÏù¥ ÍΩÉÏù¥ ÏßÄÎÑ§.",
  "ÏÑ±Î∂ÅÎèô ÏÇ∞Ïóê Î≤àÏßÄÍ∞Ä ÏÉàÎ°ú ÏÉùÍ∏∞Î©¥ÏÑú Î≥∏Îûò ÏÇ¥Îçò ÏÑ±Î∂ÅÎèô ÎπÑÎëòÍ∏∞ÎßåÏù¥ Î≤àÏßÄÍ∞Ä ÏóÜÏñ¥Ï°åÎã§.",
  "ÏÉàÎ≤ΩÎ∂ÄÌÑ∞ Îèå Íπ®Îäî ÏÇ∞Ïö∏Î¶ºÏóê Îñ®Îã§Í∞Ä Í∞ÄÏä¥Ïóê Í∏àÏù¥ Í∞îÎã§.",
  "Í∑∏ÎûòÎèÑ ÏÑ±Î∂ÅÎèô ÎπÑÎëòÍ∏∞Îäî ÌïòÎäêÎãòÏùò Í¥ëÏû• Í∞ôÏùÄ ÏÉàÌååÎûÄ ÏïÑÏπ® ÌïòÎäòÏóê ÏÑ±Î∂ÅÎèô Ï£ºÎØºÏóêÍ≤å Ï∂ïÎ≥µÏùò Î©îÏãúÏßÄÎÇò Ï†ÑÌïòÎìØ ÏÑ±Î∂ÅÎèô ÌïòÎäòÏùÑ Ìïú Î∞îÌÄ¥ ÌúòÎèàÎã§.",
  "Ïù¥Ï†ú ÏÇ∞ÎèÑ ÏûÉÍ≥† ÏÇ¨ÎûåÎèÑ ÏûÉÍ≥† ÏÇ¨ÎûëÍ≥º ÌèâÌôîÏùò ÏÇ¨ÏÉÅÍπåÏßÄ ÎÇ≥ÏßÄ Î™ªÌïòÎäî Ï´ìÍ∏∞Îäî ÏÉàÍ∞Ä ÎêòÏóàÎã§.",
  "Í∞ÄÏùÑÏóêÎäî Í∏∞ÎèÑÌïòÍ≤å ÌïòÏÜåÏÑú.",
  "ÎÇôÏóΩÎì§Ïù¥ ÏßÄÎäî ÎïåÎ•º Í∏∞Îã§Î†§ ÎÇ¥Í≤å Ï£ºÏã† Í≤∏ÌóàÌïú Î™®Íµ≠Ïñ¥Î°ú ÎÇòÎ•º Ï±ÑÏö∞Í≤å ÌïòÏÜåÏÑú.",
  "Í∞ÄÏùÑÏóêÎäî ÏÇ¨ÎûëÌïòÍ≤å ÌïòÏÜåÏÑú.",
  "Ïò§ÏßÅ Ìïú ÏÇ¨ÎûåÏùÑ ÌÉùÌïòÍ≤å ÌïòÏÜåÏÑú.",
  "Í∞ÄÏû• ÏïÑÎ¶ÑÎã§Ïö¥ Ïó¥Îß§Î•º ÏúÑÌïòÏó¨ Ïù¥ ÎπÑÏò•Ìïú ÏãúÍ∞ÑÏùÑ Í∞ÄÍæ∏Í≤å ÌïòÏÜåÏÑú.",
  "Í∞ÄÏùÑÏóêÎäî Ìò∏Ïò¨Î°ú ÏûàÍ≤å ÌïòÏÜåÏÑú.",
  "ÎÇòÏùò ÏòÅÌòº, ÍµΩÏù¥ÏπòÎäî Î∞îÎã§ÏôÄ Ïó¨Ïù∏ Í≥®ÏßúÍ∏∞Î•º ÏßÄÎÇò ÎßàÎ•∏ ÎÇòÎ≠áÍ∞ÄÏßÄ ÏúÑÏóê Îã§Îã§Î•∏ ÍπåÎßàÍ∑ÄÍ∞ôÏù¥.",
  "ÍªçÎç∞Í∏∞Îäî Í∞ÄÎùº.",
  "ÏÇ¨ÏõîÎèÑ ÏïåÎßπÏù¥Îßå ÎÇ®Í≥† ÍªçÎç∞Í∏∞Îäî Í∞ÄÎùº.",
  "ÎèôÌïôÎÖÑ Í≥∞ÎÇòÎ£®Ïùò, Í∑∏ ÏïÑÏö∞ÏÑ±Îßå ÏÇ¥Í≥† ÍªçÎç∞Í∏∞Îäî Í∞ÄÎùº.",
  "Í∑∏Î¶¨ÌïòÏó¨, Îã§Ïãú ÍªçÎç∞Í∏∞Îäî Í∞ÄÎùº.",
  "Ïù¥Í≥≥ÏóêÏÑ†, Îëê Í∞ÄÏä¥Í≥º Í∑∏Í≥≥ÍπåÏßÄ ÎÇ¥ÎÖº ÏïÑÏÇ¨Îã¨ ÏïÑÏÇ¨ÎÖÄÍ∞Ä Ï§ëÎ¶ΩÏùò Ï¥àÎ°ÄÏ≤≠ ÏïûÏóê ÏÑúÏÑú Î∂ÄÎÅÑÎüº ÎπõÎÇ¥Î©∞ ÎßûÏ†àÌï†ÏßÄÎãà.",
  "Ïï†ÎπÑÎäî Ï¢ÖÏù¥ÏóàÎã§.",
  "Î∞§Ïù¥ ÍπäÏñ¥ÎèÑ Ïò§ÏßÄ ÏïäÏïòÎã§.",
  "ÌååÎøåÎ¶¨Í∞ôÏù¥ ÎäôÏùÄ Ìï†Î®∏ÎãàÏôÄ ÎåÄÏ∂îÎÇòÎ¨¥ ÍΩÉÏù¥ ÏåìÏù¥Îäî ÎßàÎãπ ÏïÑÎûòÏÑú ÎÇ¥ Ïñ¥Î®∏ÎãàÎäî Îã¨ÏùÑ ÎëêÍ≥† ÎÇòÎ•º ÎÇ≥ÏïòÎã§.",
  "Ïä§Î¨ºÏÑ∏ Ìï¥ ÎèôÏïà ÎÇòÎ•º ÌÇ§Ïö¥ Í±¥ ÌåîÌï†Ïù¥ Î∞îÎûåÏù¥Îã§.",
  "ÏÑ∏ÏÉÅÏùÄ ÎÇòÎ•º Í∞ÄÎ•¥Ï≥êÎèÑ Îäò Î∂ÄÎÅÑÎü¨Ïõ†Îã§.",
  "Ïñ¥Îñ§ Ïù¥Îäî ÎÇ¥ ÎààÏóêÏÑú Ï£ÑÏù∏ÏùÑ ÏùΩÍ≥† Í∞ÄÍ≥† Ïñ¥Îñ§ Ïù¥Îäî ÎÇ¥ ÏûÖÏóêÏÑú Ï≤úÏπòÎ•º ÏùΩÍ≥† Í∞ÄÎÇò ÎÇòÎäî ÏïÑÎ¨¥Í≤ÉÎèÑ ÎâòÏö∞ÏπòÏßÑ ÏïäÏùÑÎ†®Îã§.",
  "ÍπåÎßàÎìùÌïú ÎÇ†Ïóê ÌïòÎäòÏù¥ Ï≤òÏùå Ïó¥Î¶¨Í≥† Ïñ¥Îîî Îã≠ Ïö∞Îäî ÏÜåÎ¶¨ Îì§Î†∏ÏúºÎû¥.",
  "Î™®Îì† ÏÇ∞Îß•Îì§Ïù¥ Î∞îÎã§Î•º Ïó∞Î™®Ìï¥ ÌúòÎã¨Î¶¥ ÎïåÎèÑ Ï∞®Îßà Ïù¥Í≥≥ÏùÑ Î≤îÌïòÎçò Î™ªÌïòÏòÄÏúºÎ¶¨Îùº.",
  "ÎÅäÏûÑÏóÜÎäî Í¥ëÏùåÏùÑ Î∂ÄÏßÄÎü∞Ìïú Í≥ÑÏ†àÏù¥ ÌîºÏñ¥ÏÑ† ÏßÄÍ≥† ÌÅ∞ Í∞ïÎ¨ºÏù¥ ÎπÑÎ°úÏÜå Í∏∏ÏùÑ Ïó¥ÏóàÎã§.",
  "ÏßÄÍ∏à Îàà ÎÇ¥Î¶¨Í≥† Îß§Ìôî Ìñ•Í∏∞ ÌôÄÎ°ú ÏïÑÎìùÌïòÎãà ÎÇ¥ Ïó¨Í∏∞ Í∞ÄÎÇúÌïú ÎÖ∏ÎûòÏùò Ïî®Î•º ÎøåÎ†§Îùº.",
  "Îã§Ïãú Ï≤úÍ≥†Ïùò Îí§Ïóê Î∞±Îßà ÌÉÄÍ≥† Ïò§Îäî Ï¥àÏù∏Ïù¥ ÏûàÏñ¥ Ïù¥ Í¥ëÏïºÏóêÏÑú Î™©ÎÜìÏïÑ Î∂ÄÎ•¥Í≤å ÌïòÎ¶¨Îùº.",
  "ÎÇ¥ Í≥†Ïû• Ïπ†ÏõîÏùÄ Ï≤≠Ìè¨ÎèÑÍ∞Ä ÏùµÏñ¥ Í∞ÄÎäî ÏãúÏ†à.",
  "Ïù¥ ÎßàÏùÑ Ï†ÑÏÑ§Ïù¥ Ï£ºÏ†ÄÎ¶¨Ï£ºÏ†ÄÎ¶¨ Ïó¥Î¶¨Í≥† Î®º Îç∞ ÌïòÎäòÏù¥ ÍøàÍæ∏Î©∞ ÏïåÏïåÏù¥ Îì§Ïñ¥ÏôÄ Î∞ïÌòÄ ÌïòÎäò Î∞ë Ìë∏Î•∏ Î∞îÎã§Í∞Ä Í∞ÄÏä¥ÏùÑ Ïó¥Í≥† Ìù∞ Îèõ Îã® Î∞∞Í∞Ä Í≥±Í≤å Î∞ÄÎ†§ÏÑú Ïò§Î©¥ ÎÇ¥Í∞Ä Î∞îÎùºÎäî ÏÜêÎãòÏùÄ Í≥†Îã¨Ìîà Î™∏ÏúºÎ°ú Ï≤≠Ìè¨Î•º ÏûÖÍ≥† Ï∞æÏïÑÏò®Îã§Í≥† ÌñàÏúºÎãà ÎÇ¥ Í∑∏Î•º ÎßûÏïÑ Ïù¥ Ìè¨ÎèÑÎ•º Îî∞ Î®πÏúºÎ©¥ Îëê ÏÜêÏùÄ Ìï®Îøç Ï†ÅÏÖîÎèÑ Ï¢ãÏúºÎ†®.",
  "ÏïÑÏù¥Ïïº Ïö∞Î¶¨ ÏãùÌÉÅÏóî ÏùÄÏüÅÎ∞òÏóê ÌïòÏù¥ÏñÄ Î™®Ïãú ÏàòÍ±¥ÏùÑ ÎßàÎ†®Ìï¥ ÎëêÎ†¥.",
  "ÏÇ∞ÏÇ∞Ïù¥ Î∂ÄÏÑúÏßÑ Ïù¥Î¶ÑÏù¥Ïó¨!",
  "ÌóàÍ≥µ Ï§ëÏóê Ìó§Ïñ¥ÏßÑ Ïù¥Î¶ÑÏù¥Ïó¨!",
  "Î∂àÎü¨ÎèÑ Ï£ºÏù∏ ÏóÜÎäî Ïù¥Î¶ÑÏù¥Ïó¨!",
  "Î∂ÄÎ•¥Îã§Í∞Ä ÎÇ¥Í∞Ä Ï£ΩÏùÑ Ïù¥Î¶ÑÏù¥Ïó¨!",
  "Ïã¨Ï§ëÏóê ÎÇ®ÏïÑ ÏûàÎäî Îßê ÌïúÎßàÎîîÎäî ÎÅùÎÅùÎÇ¥ ÎßàÏ†Ä ÌïòÏßÄ Î™ªÌïòÏòÄÍµ¨ÎÇò.",
  "ÏÇ¨ÎûëÌïòÎçò Í∑∏ ÏÇ¨ÎûåÏù¥Ïó¨!",
  "Î∂âÏùÄ Ìï¥Îäî ÏÑúÏÇ∞ÎßàÎ£®Ïóê Í±∏Î†∏Îã§.",
  "ÏÇ¨Ïä¥Ïùò Î¨¥Î¶¨ÎèÑ Ïä¨Ìîº Ïö¥Îã§.",
  "Îñ®Ïñ¥Ï†∏ ÎÇòÍ∞Ä ÏïâÏùÄ ÏÇ∞ ÏúÑÏóêÏÑú ÎÇòÎäî Í∑∏ÎåÄÏùò Ïù¥Î¶ÑÏùÑ Î∂ÄÎ•¥ÎÖ∏Îùº.",
  "Îß§Ïö¥ Í≥ÑÏ†àÏùò Ï±ÑÏ∞çÏóê Í∞àÍ≤® ÎßàÏπ®ÎÇ¥ Î∂ÅÎ∞©ÏúºÎ°ú Ìú©Ïì∏Î†§ Ïò§Îã§.",
  "ÌïòÎäòÎèÑ Í∑∏Îßå ÏßÄÏ≥ê ÎÅùÎÇú Í≥†Ïõê ÏÑúÎ¶øÎ∞ú ÏπºÎÇ†ÏßÑ Í∑∏ ÏúÑÏóê ÏÑúÎã§.",
  "Ïñ¥ÎîîÎã§ Î¨¥Î¶éÏùÑ ÍøáÏñ¥Ïïº ÌïòÎÇò Ìïú Î∞ú Ïû¨Í≤® ÎîîÎîú Í≥≥Ï°∞Ï∞® ÏóÜÎã§.",
  "Ïù¥Îü¨Îß§ Îàà Í∞êÏïÑ ÏÉùÍ∞ÅÌï¥ Î≥ºÎ∞ñÏóê Í≤®Ïö∏ÏùÄ Í∞ïÏ≤†Î°ú Îêú Î¨¥ÏßÄÍ∞úÏù∏Í∞Ä Î≥¥Îã§.",
  "ÏïÑÎ¨¥ÎèÑ Í∑∏ÏóêÍ≤å ÏàòÏã¨ÏùÑ ÏùºÎü¨ Ï§Ä ÏùºÏù¥ ÏóÜÍ∏∞Ïóê Ìù∞ ÎÇòÎπÑÎäî ÎèÑÎ¨¥ÏßÄ Î∞îÎã§Í∞Ä Î¨¥ÏÑ≠ÏßÄ ÏïäÎã§.",
  "Ï≤≠Î¨¥Ïö∞Î∞≠Ïù∏Í∞Ä Ìï¥ÏÑú ÎÇ¥Î†§Í∞îÎã§Í∞ÄÎäî Ïñ¥Î¶∞ ÎÇ†Í∞úÍ∞Ä Î¨ºÍ≤∞Ïóê Ï†àÏñ¥ÏÑú Í≥µÏ£ºÏ≤òÎüº ÏßÄÏ≥êÏÑú ÎèåÏïÑÏò®Îã§.",
  "ÏÇºÏõîÎã¨ Î∞îÎã§Í∞Ä ÍΩÉÏù¥ ÌîºÏßÄ ÏïäÏïÑÏÑú ÏÑúÍ∏ÄÌîà ÎÇòÎπÑ ÌóàÎ¶¨Ïóê ÏÉàÌååÎûÄ Ï¥àÏÉùÎã¨Ïù¥ ÏãúÎ¶¨Îã§.",
  "Ïú†Î¶¨Ïóê Ï∞®Í≥† Ïä¨Ìîà Í≤ÉÏù¥ Ïñ¥Î•∏Í±∞Î¶∞Îã§.",
  "Ïó¥ÏóÜÏù¥ Î∂ôÏñ¥ ÏÑúÏÑú ÏûÖÍπÄÏùÑ ÌùêÎ¶¨Ïö∞Îãà Í∏∏Îì§ÏùÄ Ïñë Ïñ∏ ÎÇ†Í∞úÎ•º ÌååÎã•Í±∞Î¶∞Îã§.",
  "ÏßÄÏö∞Í≥† Î≥¥Í≥† ÏßÄÏö∞Í≥† Î≥¥ÏïÑÎèÑ ÏÉàÏπ¥Îßå Î∞§ÏùÄ Î∞ÄÎ†§ ÎÇòÍ∞ÄÍ≥† Î∞ÄÎ†§ÏôÄ Î∂ÄÎî™ÏπòÍ≥†, Î¨ºÎ®πÏùÄ Î≥ÑÏù¥ Î∞òÏßù Î≥¥ÏÑùÏ≤òÎüº Î∞ïÌûåÎã§.",
  "Î∞§Ïóê ÌôÄÎ°ú Ïú†Î¶¨Î•º Îã¶Îäî Í≤ÉÏùÄ Ïô∏Î°úÏö¥ Ìô©ÌôÄÌïú Ïã¨ÏÇ¨Ïù¥Ïñ¥Îãà, Í≥†Ïö¥ ÌèêÌòàÍ¥ÄÏù¥ ÌÑ∞ÏßÑ Ï±ÑÎ°ú ÏïÑÏïÑ ÎÑàÎäî ÏÇ∞ÏÉàÏ≤òÎüº ÎÇ†ÏïÑÍ∞îÍµ¨ÎÇò!",
  "ÌïòÏù¥ÏñÄ Î™®ÏÉâ ÏÜçÏóê ÌîºÏñ¥ ÏûàÎäî ÏÇ∞ÌòëÏ¥åÏùò Í≥†ÎèÖÌïú Í∑∏Î¶ºÎèôÎÑ§.",
  "Ïñ¥ÎäêÎçß Ï∞®Í∞ÄÏö¥ Îì±Î∂àÏùÑ ÏºúÍ≥† ÎπÑÏù∏ Î¨òÏßÄ ÎÅùÏóê ÏÑú ÏûàÎäî ÎØ∏Ìíç ÏÜçÏóê Ï¢ÖÏÜåÎ¶¨Ï°∞Ï∞® Îì§Î¶¨ÏßÄ ÏïäÎäî Ï†ÄÎÖÅÎïåÍ∞Ä ÏôîÎã§.",
  "Í≥†Ï∏µ ÎπåÎî© Ïú†Î¶¨Ï∞ΩÏóê Ïù¥Ïä¨Ïù¥ Îß∫ÌûàÍ≥† Ïñ¥ÎîîÏÑ†Í∞Ä ÌôÄÎ°ú ÏÑú ÏûàÎäî Ï†ÑÏã†Ï£ºÍ∞Ä Î∞§Ïùò ÌïúÎ≥µÌåêÏúºÎ°ú Í±∏Ïñ¥Í∞ÑÎã§.",
  "ÎààÏùÄ ÏÇ¥ÏïÑ ÏûàÎã§.",
  "Îñ®Ïñ¥ÏßÑ ÎààÏùÄ ÏÇ¥ÏïÑ ÏûàÎã§.",
  "ÎßàÎãπ ÏúÑÏóê Îñ®Ïñ¥ÏßÑ ÎààÏùÄ ÏÇ¥ÏïÑ ÏûàÎã§.",
  "Í∏∞Ïπ®ÏùÑ ÌïòÏûê.",
  "Ï†äÏùÄ ÏãúÏù∏Ïù¥Ïó¨ Í∏∞Ïπ®ÏùÑ ÌïòÏûê.",
  "Îàà ÏúÑÏóê ÎåÄÍ≥† Í∏∞Ïπ®ÏùÑ ÌïòÏûê.",
  "ÎààÎçîÎü¨ Î≥¥ÎùºÍ≥† ÎßàÏùåÎÜìÍ≥† ÎßàÏùåÎÜìÍ≥† Í∏∞Ïπ®ÏùÑ ÌïòÏûê.",
  "Ï£ΩÏùåÏùÑ ÏûäÏñ¥Î≤ÑÎ¶∞ ÏòÅÌòºÍ≥º Ïú°Ï≤¥Î•º ÏúÑÌïòÏó¨ ÎààÏùÄ ÏÉàÎ≤ΩÏù¥ ÏßÄÎÇòÎèÑÎ°ù ÏÇ¥ÏïÑ ÏûàÎã§.",
  "Ìè≠Ìè¨Îäî Í≥ßÏùÄ Ï†àÎ≤ΩÏùÑ Î¨¥ÏÑúÏö¥ Í∏∞ÏÉâÎèÑ ÏóÜÏù¥ Îñ®Ïñ¥ÏßÑÎã§.",
  "Í∑úÏ†ïÌï† Ïàò ÏóÜÎäî Î¨ºÍ≤∞Ïù¥ Î¨¥ÏóáÏùÑ Ìñ•ÌïòÏó¨ Îñ®Ïñ¥ÏßÑÎã§Îäî ÏùòÎØ∏ÎèÑ ÏóÜÏù¥ Í≥ÑÏ†àÍ≥º Ï£ºÏïºÎ•º Í∞ÄÎ¶¨ÏßÄ ÏïäÍ≥† Í≥†Îß§Ìïú Ï†ïÏã†Ï≤òÎüº Ïâ¥ ÏÇ¨Ïù¥ ÏóÜÏù¥ Îñ®Ïñ¥ÏßÑÎã§.",
  "Í∏àÏûîÌôîÎèÑ Ïù∏Í∞ÄÎèÑ Î≥¥Ïù¥ÏßÄ ÏïäÎäî Î∞§Ïù¥ ÎêòÎ©¥ Ìè≠Ìè¨Îäî Í≥ßÏùÄ ÏÜåÎ¶¨Î•º ÎÇ¥Î©∞ Îñ®Ïñ¥ÏßÑÎã§.",
  "Í≥†Î¶ΩÏùÑ ÎëêÎ†§ÏõåÌïòÏßÄ ÏïäÍ≥† Îñ®Ïñ¥ÏßÑÎã§.",
  "Î®∏Î¶øÍ≥†Í∞ú ÎÑàÎ®∏ ÎèôÌôî ÏÜç Í∞ôÏùÄ Ï¥àÍ∞ÄÏßë Ìïú Ï±Ñ.",
  "Ïö∏ÌÉÄÎ¶¨ Î∞ñÏóêÎäî Ï±ÑÏÜ°ÌôîÍ∞Ä ÌîºÍ≥† ÏïÑÍ∏∞ Ï±ÑÏÜ°ÌôîÍ∞Ä ÌïÄÎã§.",
  "Î®∏Î¶¨Ïóê ÏàòÍ±¥ÏùÑ Ïì¥ ÏïÑÏ£ºÎ®∏ÎãàÍ∞Ä Ï±ÑÏÜåÎ∞≠ÏùÑ Îß§Í≥† Î®º Îç∞ÏÑú ÎªêÍæ∏Í∏∞ ÏÜåÎ¶¨Í∞Ä Îì§Î†§Ïò®Îã§.",
  "ÎßàÏùÑÏùÄ Í∑∏Î†áÍ≤å ÌèâÌôîÎ°≠Í≥† ÎÇòÎ•∏Ìïú Ïò§ÌõÑÎ•º ÏßÄÎÇòÍ∞ÑÎã§.",
  "ÎÇòÎäî ÎÇòÎ£ªÎ∞∞ ÎãπÏã†ÏùÄ ÌñâÏù∏.",
  "ÎãπÏã†ÏùÄ ÌùôÎ∞úÎ°ú ÎÇòÎ•º ÏßìÎ∞üÏäµÎãàÎã§.",
  "ÎÇòÎäî ÎãπÏã†ÏùÑ ÏïàÍ≥† Î¨ºÏùÑ Í±¥ÎÑàÍ∞ëÎãàÎã§.",
  "ÎÇòÎäî ÎãπÏã†ÏùÑ ÏïàÏúºÎ©¥ ÍπäÏúºÎÇò ÏñïÏúºÎÇò Í∏âÌïú Ïó¨Ïö∏Ïù¥ÎÇò Í±¥ÎÑàÍ∞ëÎãàÎã§.",
  "ÎßåÏùº ÎãπÏã†Ïù¥ ÏïÑÎãà Ïò§ÏãúÎ©¥ ÎÇòÎäî Î∞îÎûåÏùÑ Ïê¨Í≥† ÎààÎπÑÎ•º ÎßûÏúºÎ©∞ Î∞§ÏóêÏÑú ÎÇÆÍπåÏßÄ ÎãπÏã†ÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§.",
  "ÎãπÏã†ÏùÄ ÌñâÏù∏Ïù¥ÎùºÏÑú Í±¥ÎÑàÍ∞ÄÏãúÎ©¥ Îí§ÎèÑ ÎèåÏïÑÎ≥¥ÏßÄ ÏïäÍ≥† Í∞ÄÏã≠ÎãàÎã§Í∑∏Î†§.",
  "Í∑∏Îü¨ÎÇò ÎãπÏã†Ïù¥ Ïñ∏Ï†úÎì†ÏßÄ Ïò§Ïã§ Ï§ÑÎßåÏùÄ ÏïåÏïÑÏöî.",
  "ÎÇòÎäî ÎãπÏã†ÏùÑ Í∏∞Îã§Î¶¨Î©¥ÏÑú ÎÇ†ÎßàÎã§ ÎÇ†ÎßàÎã§ ÎÇ°ÏïÑ Í∞ëÎãàÎã§.",
  "Ïò•ÏàòÏàò ÏûéÏóê ÎπóÎ∞©Ïö∏Ïù¥ ÎÇ¥Î¶ΩÎãàÎã§.",
  "Ïò§ÎäòÎèÑ Îòê ÌïòÎ£®Î•º ÏÇ¥ÏïòÏäµÎãàÎã§.",
  "ÎÇôÏóΩÏù¥ ÏßÄÍ≥† Ï∞¨Î∞îÎûåÏù¥ Î∂ÄÎäî ÎïåÍπåÏßÄ Ïö∞Î¶¨ÏóêÍ≤å ÎÇ®ÏïÑ ÏûàÎäî ÎÇ†Îì§ÏùÄ ÏñºÎßàÎÇò Îê†ÍπåÏöî.",
  "ÎãπÏã†ÏùÑ ÏÇ¨ÎûëÌï©ÎãàÎã§.",
  "ÎÇ¥ Î™∏ Ï†ÑÏ≤¥Í∞Ä ÎãπÏã†Ïùò ÏÇ¨ÎûëÏúºÎ°ú Í∞ÄÎìù Ï∞® Ïò§Î•º ÎïåÍπåÏßÄ ÎÇòÎäî ÎãπÏã†Ïùò Í≥ÅÏùÑ Îñ†ÎÇòÏßÄ ÏïäÍ≤†ÏäµÎãàÎã§.",
  "Ïö∞Î¶¨Í∞Ä Ìï®ÍªòÌñàÎçò ÏãúÍ∞ÑÎì§Ïù¥ Ï†ÄÎ¨¥Îäî ÎÖ∏ÏùÑÏ≤òÎüº ÏïÑÎ¶ÑÎãµÍ≤å Í∏∞ÏñµÎêòÍ∏∏ Î∞îÎûçÎãàÎã§.",
  "ÎÇòÎäî Í∑∏ÎäòÏù¥ ÏóÜÎäî ÏÇ¨ÎûåÏùÑ ÏÇ¨ÎûëÌïòÏßÄ ÏïäÎäîÎã§.",
  "ÎÇòÎäî ÎààÎ¨ºÏù¥ ÏóÜÎäî ÏÇ¨ÎûåÏùÑ ÏÇ¨ÎûëÌïòÏßÄ ÏïäÎäîÎã§.",
  "ÎÇòÎäî ÎààÎ¨ºÏùÑ ÌùòÎ¶¨Î©∞ Í±∏Ïñ¥Í∞ÄÎäî ÏÇ¨ÎûåÏùò Îí∑Î™®ÏäµÏùÑ ÏÇ¨ÎûëÌïúÎã§.",
  "ÎÇòÎ¨¥Ïóê Í∑∏ÎäòÏù¥ ÏûàÏñ¥ ÎÇòÎ¨¥Í∞Ä ÎêòÎìØ ÎààÎ¨ºÏù¥ ÏûàÏñ¥ ÏÇ¨ÎûåÏù¥ ÎêòÎäî Í≤ÉÏù¥Îã§.",
  "Ï†ïÏûë Ïä¨Ìîà Í≤ÉÏùÄ ÎààÎ¨ºÏù¥ ÏóÜÎäî Í≤ÉÏù¥ ÏïÑÎãàÎùº ÎààÎ¨ºÏùÑ ÌùòÎ¶¥ Ï§Ñ Î™®Î•¥Îäî Í≤ÉÏù¥Îã§.",
  "ÎÇòÎ¨¥ÎèÑ ÏÉÅÏ≤òÎ•º ÏûÖÏúºÎ©¥ Îã®Îã®Ìï¥ÏßÑÎã§.",
  "Í∑∏ ÏÉÅÏ≤ò ÏûêÍµ≠Ïù¥ ÏòπÏù¥Í∞Ä ÎêòÏñ¥ Îã®Îã®Ìïú ÎÇòÎ¨¥Î•º ÎßåÎì†Îã§.",
  "ÏÇ¨ÎûåÎèÑ ÏÉÅÏ≤òÎ•º ÏûÖÏñ¥Ïïº ÎπÑÎ°úÏÜå ÏÇ¨ÎûåÏù¥ ÎêúÎã§.",
  "ÏÉÅÏ≤ò ÏóÜÎäî ÏÇ¨ÎûëÏù¥ Ïñ¥Îîî ÏûàÏúºÎû¥.",
  "Î∞îÎûåÏóê ÌùîÎì§Î¶¨Í≥† ÎπÑÏóê Ï†ñÏúºÎ©∞ Ïö∞Î¶¨Îäî Í∑∏Î†áÍ≤å Ï°∞Í∏àÏî© ÍπäÏñ¥ÏßÄÎäî Í≤ÉÏù¥Îã§.",
  "ÏßïÏù¥ Ïö∏Î¶∞Îã§ ÎßâÏù¥ ÎÇ¥Î†∏Îã§.",
  "Ïò§ÎèôÎÇòÎ¨¥Ïóê Ï†ÑÎì±Ïù¥ Îß§Ïñ¥Îã¨Î¶∞ Í∞ÄÏÑ§Î¨¥ÎåÄ, Íµ¨Í≤ΩÍæºÏù¥ Î∞îÏßÑ Ïö¥ÎèôÏû• Ï£ºÏúÑÏóî Ï£ºÏ†ÄÏïâÏïÑ Î≤ΩÏóê Í∏∞ÎåÄÏñ¥ ÏÜåÏ£ºÎ•º ÎßàÏã†Îã§.",
  "ÎãµÎãµÌïòÍ≥† Í≥†Îã¨ÌîÑÍ≤å ÏÇ¨Îäî Í≤ÉÏù¥ ÏõêÌÜµÌïòÎã§.",
  "ÍΩπÍ≥ºÎ¶¨Î•º ÏïûÏû•ÏÑ∏Ïõå Ïû•Í±∞Î¶¨Î°ú ÎÇòÏÑúÎ©¥ Îî∞ÎùºÎ∂ôÏñ¥ ÏïÖÏùÑ Ïì∞Îäî Í±¥ Ï°∞Î¨¥ÎûòÍ∏∞Îì§Îøê Ï≤òÎÖÄÏï†Îì§ÏùÄ Îã¥Î≤ΩÏóê Î∂ôÏñ¥ ÏÑúÏÑú Ï≤†ÏóÜÏù¥ ÎÇÑÎÇÑÍ±∞Î¶¨ÎäîÍµ¨ÎÇò.",
  "Î≥¥Î¶ÑÎã¨ÏùÄ Î∞ùÏïÑ Ïñ¥Îñ§ ÎÖÄÏÑùÏùÄ Í∫ΩÏ†ïÏù¥Ï≤òÎüº Ïö∏Î∂ÄÏßñÍ≥† Îòê Ïñ¥Îñ§ ÎÖÄÏÑùÏùÄ ÏÑúÎ¶ºÏù¥Ï≤òÎüº Ìï¥Ìï¥ÎåÄÏßÄÎßå Ïù¥ÍπåÏßì ÏÇ∞ Íµ¨ÏÑùÏóê Ï≤òÎ∞ïÌòÄ Î∞úÎ≤ÑÎë•ÏπúÎì§ Î¨¥ÏóáÌïòÎû¥.",
  "ÌíÄÏù¥ ÎàïÎäîÎã§.",
  "ÎπÑÎ•º Î™∞ÏïÑÏò§Îäî Î∞îÎûåÏóê ÎÇòÎ∂ÄÍª¥ ÌíÄÏùÄ ÎàïÍ≥† ÎìúÎîîÏñ¥ Ïö∏ÏóàÎã§.",
  "ÎÇ†Ïù¥ ÌùêÎ†§ÏÑú Îçî Ïö∏Îã§Í∞Ä Îã§Ïãú ÎàÑÏõ†Îã§.",
  "Î∞îÎûåÎ≥¥Îã§ÎèÑ Îçî Îπ®Î¶¨ ÎàïÎäîÎã§.",
  "Î∞îÎûåÎ≥¥Îã§ÎèÑ Îçî Îπ®Î¶¨ Ïö∏Í≥† Î∞îÎûåÎ≥¥Îã§ Î®ºÏ†Ä ÏùºÏñ¥ÎÇúÎã§.",
  "ÎÇ†Ïù¥ ÌùêÎ¶¨Í≥† ÌíÄÎøåÎ¶¨Í∞Ä ÎàïÎäîÎã§.",
  "ÎßâÏ∞®Îäî Ï¢ÄÏ≤òÎüº Ïò§ÏßÄ ÏïäÏïòÎã§.",
  "ÎåÄÌï©Ïã§ Î∞ñÏóêÎäî Î∞§ÏÉà ÏÜ°Ïù¥ÎààÏù¥ ÏåìÏù¥Í≥† Ìù∞ Î≥¥Îùº ÏàòÏÑ†Ìôî ÎãÆÏùÄ Ï∞®Í∞ÄÏö¥ Ïú†Î¶¨Ï∞ΩÎßàÎã§ ÌÜ±Î∞• ÎÇúÎ°úÍ∞Ä ÏßÄÌé¥ÏßÄÍ≥† ÏûàÏóàÎã§.",
  "Í∑∏ÎØêÌåî ÏïÑÎ¶∞ Ïô∏Î°úÏõÄÎì§Ïù¥ Ïú†Î†πÏ≤òÎüº Ï†ïÍ±∞Ïû•Ïóê Î™∞Î†§ÏôÄ ÏïâÏïÑÎèÑ, ÎàÑÍµ¨ ÌïòÎÇò ÏÑ£Î∂àÎ¶¨ ÎßêÏùÑ Í±¥ÎÑ§ÏßÄ Î™ªÌñàÎã§.",
  "Ïö∞Î¶¨Îäî Ï†ÄÎßàÎã§Ïùò ÏÜêÎ∞îÎã•Ïóê Î¨ªÏùÄ ÏÇ∂Ïùò ÎïåÎ•º Î∂àÎπõÏóê ÎßêÎ¶¨Î©∞, Í∑∏Î¶¨Ïö¥ Ïù¥Îì§Ïùò Ïù¥Î¶ÑÏùÑ Í∞ÄÏä¥ ÍπäÏù¥ ÏÉàÍ≤ºÎã§.",
  "Ïö∏ÏßÄ ÎßàÎùº.",
  "Ïô∏Î°úÏö∞ÎãàÍπå ÏÇ¨ÎûåÏù¥Îã§.",
  "ÏÇ¥ÏïÑÍ∞ÑÎã§Îäî Í≤ÉÏùÄ Ïô∏Î°úÏõÄÏùÑ Í≤¨ÎîîÎäî ÏùºÏù¥Îã§.",
  "Í≥µÏó∞Ìûà Ïò§ÏßÄ ÏïäÎäî Ï†ÑÌôîÎ•º Í∏∞Îã§Î¶¨ÏßÄ ÎßàÎùº.",
  "ÎààÏù¥ Ïò§Î©¥ ÎààÍ∏∏ÏùÑ Í±∏Ïñ¥Í∞ÄÍ≥† ÎπÑÍ∞Ä Ïò§Î©¥ ÎπóÍ∏∏ÏùÑ Í±∏Ïñ¥Í∞ÄÎùº.",
  "Í∞àÎåÄÏà≤ÏóêÏÑú Í∞ÄÏä¥ Í≤ÄÏùÄ ÎèÑÏöîÏÉàÎèÑ ÎÑàÎ•º Î≥¥Í≥† ÏûàÎã§.",
  "Í∞ÄÎÅîÏùÄ ÌïòÎäêÎãòÎèÑ Ïô∏Î°úÏõåÏÑú ÎààÎ¨ºÏùÑ ÌùòÎ¶¨Ïã†Îã§.",
  "ÏÇ∞Í∑∏Î¶ºÏûêÎèÑ Ïô∏Î°úÏõåÏÑú ÌïòÎ£®Ïóê Ìïú Î≤àÏî© ÎßàÏùÑÎ°ú ÎÇ¥Î†§Ïò®Îã§.",
  "Ï¢ÖÏÜåÎ¶¨ÎèÑ Ïô∏Î°úÏõåÏÑú Ïö∏Î†§ ÌçºÏßÑÎã§.",
  "ÍπåÎã≠ ÏóÜÏù¥ ÎßàÏùå Ïô∏Î°úÏõåÏßÄÎäî ÎÇ†ÏùÄ ÎÖ∏ÎûÄ ÎØºÎì§Î†à ÍΩÉ Ìïú ÏÜ°Ïù¥ ÌîºÏñ¥ ÏûàÎäî Í∏∏ÏùÑ Í±∑Í≥† Ïã∂Îã§.",
  "ÌïòÎäòÏùÄ Ï†ÄÎ†áÍ≤å Ìë∏Î•¥Í≥† Íµ¨Î¶ÑÏùÄ Ï†ÄÎ†áÍ≤å ÌïòÏñÄÎç∞, ÎÇòÎäî Ïôú Ïù¥Î¶¨ ÌòºÏûêÏùºÍπå ÏÉùÍ∞ÅÌïòÎ©∞ Í±∑Îã§ Î≥¥Î©¥ Î∞úÎÅùÏóê ÎãøÎäî ÏûëÏùÄ ÍΩÉÎßùÏö∏Ïù¥ ÎßêÏùÑ Í±¥ÎÑ®Îã§.",
  "ÎÑàÎèÑ ÌòºÏûêÍµ¨ÎÇò, ÎÇòÎèÑ ÌòºÏûêÎûÄÎã§.",
  "Ïö∞Î¶¨Îäî Í∑∏Î†áÍ≤å ÏÑúÎ°úÏùò Ïô∏Î°úÏõÄÏùÑ ÎèÑÎã•Ïù¥Î©∞ Ìï¥ Ï†ÄÎ¨¥Îäî Îì§ÌåêÏùÑ Ìï®Íªò ÏßÄÌÇ®Îã§.",
  "Ï†ÄÍ≤å Ï†ÄÏ†àÎ°ú Î∂âÏñ¥Ïßà Î¶¨Îäî ÏóÜÎã§.",
  "Ï†Ä ÏïàÏóê ÌÉúÌíç Î™á Í∞ú, Ï†Ä ÏïàÏóê Ï≤úÎë• Î™á Í∞ú, Ï†Ä ÏïàÏóê Î≤ºÎùΩ Î™á Í∞úÍ∞Ä Îì§Ïñ¥ ÏûàÏñ¥ÏÑú Î∂âÍ≤å ÏùµÌûàÎäî Í≤ÉÏùº Í≤åÎã§.",
  "Ï†ÄÍ≤å Ï†Ä ÌòºÏûê Îë•Í∏ÄÏñ¥Ïßà Î¶¨Îäî ÏóÜÎã§.",
  "Ï†Ä ÏïàÏóê Î¨¥ÏÑúÎ¶¨ ÎÇ¥Î¶¨Îäî Î™á Î∞§, Ï†Ä ÏïàÏóê Îï°Î≥ï ÎëêÏñ¥ Îã¨, Ï†Ä ÏïàÏóê Ï¥àÏäπÎã¨ Î™á ÎÇ†Ïù¥ Îì§Ïñ¥ÏÑúÏÑú Îë•Í∏ÄÍ≤å ÎßåÎìúÎäî Í≤ÉÏùº Í≤åÎã§.",
  "ÎåÄÏ∂îÏïº, ÎÑàÎäî ÏÑ∏ÏÉÅÍ≥º Ïã∏Ïõå Ïù¥Í≤ºÍµ¨ÎÇò.",
  "ÎÜíÏùÄ Í∞ÄÏßÄÎ•º ÌùîÎìúÎäî Îß§ÎØ∏ ÏÜåÎ¶¨Ïóê Î¨ªÌòÄ ÎÇ¥ Ïö∏ÏùåÏÜåÎ¶¨Îäî ÏïÑÏßÅ ÎÖ∏ÎûòÍ∞Ä ÏïÑÎãàÎã§.",
  "Ï∞®Í∞ÄÏö¥ Î∞îÎã• ÏúÑÏóê ÌÜ†ÌïòÎäî Ïö∏Ïùå, ÌíÄÏûé ÏóÜÍ≥† Ïù¥Ïä¨ Ìïú Î∞©Ïö∏ ÎÇ¥Î¶¨ÏßÄ ÏïäÎäî ÏßÄÌïòÎèÑ ÏΩòÌÅ¨Î¶¨Ìä∏Î≤Ω Ï¢ÅÏùÄ ÌãàÏóêÏÑú Ïà®ÎßâÌûê ÎìØ ÎÇ¥Ïâ¨Îäî Í∏∞Ïπ® ÏÜåÎ¶¨Îã§.",
  "Í∑∏Îü¨ÎÇò ÎàÑÍµ∞Í∞ÄÏóêÍ≤å ÎÇ¥ Ïö∏ÏùåÏùÄ Í∞ÄÏùÑÏùÑ Î∂ÄÎ•¥Îäî Ïã†Ìò∏Í∞Ä ÎêòÎ¶¨Îùº.",
  "ÏßÄÍ∏àÏùÄ ÎπÑÎ°ù Îß§ÎØ∏ ÏÜåÎ¶¨Ïóê Í∞ÄÎ†§ Îì§Î¶¨ÏßÄ ÏïäÏßÄÎßå, Î®∏ÏßÄÏïäÏïÑ ÎåÄÏßÄÎäî ÎÇ¥ ÎÖ∏ÎûòÎ°ú ÍπäÏñ¥Í∞à Í≤ÉÏù¥Îã§.",
  "ÎÇ¥Î†§Í∞à Îïå Î≥¥ÏïòÎÑ§.",
  "Ïò¨ÎùºÍ∞à Îïå Î™ª Î≥∏ Í∑∏ ÍΩÉ.",
  "Ïñ¥ÎîòÍ∞Ä ÎÇ¥Í∞Ä Î™®Î•¥Îäî Í≥≥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÍΩÉÏ≤òÎüº ÏõÉÍ≥† ÏûàÎäî, ÎÑà Ìïú ÏÇ¨ÎûåÏúºÎ°ú ÌïòÏó¨ ÏÑ∏ÏÉÅÏùÄ Îã§Ïãú Ìïú Î≤à ÎààÎ∂ÄÏã† ÏïÑÏπ®Ïù¥ ÎêòÍ≥†, Ïñ¥ÎîòÍ∞Ä ÎÑ§Í∞Ä Î™®Î•¥Îäî Í≥≥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÌíÄÏûéÏ≤òÎüº ÏÑú ÏûàÎäî, ÎÇò Ìïú ÏÇ¨ÎûåÏúºÎ°ú ÌïòÏó¨ ÏÑ∏ÏÉÅÏùÄ Îã§Ïãú Ìïú Î≤à Í≥†ÏöîÌïú Ï†ÄÎÖÅÏù¥ ÎêúÎã§.",
  "Í∞ÄÏùÑÏù¥Îã§, Î∂ÄÎîî ÏïÑÌîÑÏßÄ ÎßàÎùº.",
  "Í∏∏Ïù¥ ÎÅùÎÇòÎäî Í≥≥ÏóêÏÑúÎèÑ Í∏∏Ïù¥ ÏûàÎã§.",
  "Í∏∏Ïù¥ ÎÅùÎÇòÎäî Í≥≥ÏóêÏÑúÎèÑ Í∏∏Ïù¥ ÎêòÎäî ÏÇ¨ÎûåÏù¥ ÏûàÎã§.",
  "Ïä§Ïä§Î°ú ÏÇ¨ÎûëÏù¥ ÎêòÏñ¥ ÌïúÏóÜÏù¥ Î¥ÑÍ∏∏ÏùÑ Í±∏Ïñ¥Í∞ÄÎäî ÏÇ¨ÎûåÏù¥ ÏûàÎã§.",
  "Í∞ïÎ¨ºÏùÄ ÌùêÎ•¥Îã§Í∞Ä Î©àÏ∂îÍ≥† ÏÉàÎì§ÏùÄ ÎÇ†ÏïÑÍ∞Ä ÎèåÏïÑÏò§ÏßÄ ÏïäÍ≥† ÌïòÎäòÍ≥º ÎïÖ ÏÇ¨Ïù¥Ïùò Î™®Îì† ÍΩÉÏûéÏùÄ Ìù©Ïñ¥Ï†∏ÎèÑ, Î≥¥Îùº ÏÇ¨ÎûëÏùÑ ÎÅùÎÇ∏ ÏÇ¨ÎûåÎ≥¥Îã§ ÏÇ¨ÎûëÏùÑ ÏãúÏûëÌïòÎäî ÏÇ¨ÎûåÏùò Îí∑Î™®ÏäµÏùÄ ÏñºÎßàÎÇò ÏïÑÎ¶ÑÎã§Ïö¥Í∞Ä.",
  "ÎÑ§Í∞Ä Ïò§Í∏∞Î°ú Ìïú Í∑∏ ÏûêÎ¶¨Ïóê, ÎÇ¥Í∞Ä ÎØ∏Î¶¨ Í∞ÄÏÑú ÎÑàÎ•º Í∏∞Îã§Î¶¨Îäî ÎèôÏïà Îã§Í∞ÄÏò§Îäî Î™®Îì† Î∞úÏûêÍµ≠ÏùÄ ÎÇ¥ Í∞ÄÏä¥Ïóê ÏøµÏøµÍ±∞Î¶∞Îã§.",
  "Î∞îÏä§ÎùΩÍ±∞Î¶¨Îäî ÎÇòÎ≠áÏûé ÌïòÎÇòÎèÑ Îã§ ÎÇ¥Í≤åÎ°ú Ïò§Îäî ÎÑàÏùò Î∞úÏÜåÎ¶¨ Í∞ôÎã§.",
  "Í∏∞Îã§Î†§ Î≥∏ Ï†ÅÏù¥ ÏûàÎäî ÏÇ¨ÎûåÏùÄ ÏïàÎã§.",
  "ÏÑ∏ÏÉÅÏóêÏÑú Í∏∞Îã§Î¶¨Îäî ÏùºÏ≤òÎüº Í∞ÄÏä¥ ÏïÑÌîà ÏùºÏùÄ ÏóÜÎã§Îäî Í≤ÉÏùÑ.",
  "ÎÑ§Í∞Ä Ïò§ÏßÄ ÏïäÎäî Í∑∏ ÏãúÍ∞ÑÍπåÏßÄÎèÑ ÎÇòÎäî ÎÑàÎ•º Í∏∞Îã§Î¶¨Í≥† ÏûàÎã§.",
  "ÏÇ¨ÎûëÏùÑ ÏûÉÍ≥† ÎÇòÎäî Ïì∞ÎÑ§.",
  "Ïûò ÏûàÍ±∞Îùº, ÏßßÏïòÎçò Î∞§Îì§ÏïÑ.",
  "Ï∞ΩÎ∞ñÏùÑ Îñ†ÎèåÎçò Í≤®Ïö∏ ÏïàÍ∞úÎì§ÏïÑ.",
  "ÏïÑÎ¨¥Í≤ÉÎèÑ Î™®Î•¥Îçò Ï¥õÎ∂àÎì§ÏïÑ, Ïûò ÏûàÍ±∞Îùº.",
  "Í≥µÌè¨Î•º Í∏∞Îã§Î¶¨Îçò Ìù∞ Ï¢ÖÏù¥Îì§ÏïÑ.",
  "ÎßùÏÑ§ÏûÑÏùÑ ÎåÄÏã†ÌïòÎçò ÎààÎ¨ºÎì§ÏïÑ.",
  "Ïûò ÏûàÍ±∞Îùº, Îçî Ïù¥ÏÉÅ ÎÇ¥ Í≤ÉÏù¥ ÏïÑÎãå Ïó¥ÎßùÎì§ÏïÑ.",
  "Ïû•ÎãòÏ≤òÎüº ÎÇò Ïù¥Ï†ú ÎçîÎì¨Í±∞Î¶¨Î©∞ Î¨∏ÏùÑ Ïû†Í∑∏ÎÑ§.",
  "Í∞ÄÏóæÏùÄ ÎÇ¥ ÏÇ¨Îûë ÎπàÏßëÏóê Í∞áÌòîÎÑ§.",
  "Ïó¥Î¨¥ ÏÇºÏã≠ Îã®ÏùÑ Ïù¥Í≥† ÏãúÏû•Ïóê Í∞Ñ Ïö∞Î¶¨ ÏóÑÎßà Ïïà Ïò§ÏãúÎÑ§.",
  "Ìï¥Îäî ÏãúÎì† ÏßÄ Ïò§Îûò, ÎÇòÎäî Ï∞¨Î∞•Ï≤òÎüº Î∞©Ïóê Îã¥Í≤® ÏïÑÎ¨¥Î¶¨ Ï≤úÏ≤úÌûà ÏàôÏ†úÎ•º Ìï¥ÎèÑ ÏóÑÎßà Ïïà Ïò§ÏãúÎÑ§.",
  "Î∞∞Ï∂îÏûé Í∞ôÏùÄ Î∞úÏÜåÎ¶¨ ÌÉÄÎ∞ïÌÉÄÎ∞ï Ïïà Îì§Î¶¨ÎÑ§.",
  "Ïñ¥Îë°Í≥† Î¨¥ÏÑúÏõå Í∏àÍ∞Ñ Ï∞Ω ÌãàÏúºÎ°ú Í≥†ÏöîÌûà ÎπóÏÜåÎ¶¨ ÎπàÎ∞©Ïóê ÌòºÏûê ÏóéÎìúÎ†§ ÌõåÏ©çÍ±∞Î¶¨Îçò ÏïÑÏ£º Î®º ÏòõÎÇ†.",
  "ÏßÄÍ∏àÎèÑ ÎÇ¥ ÎààÏãúÏö∏ÏùÑ Îú®Í≤ÅÍ≤å ÌïòÎäî Í∑∏ ÏãúÏ†à, ÎÇ¥ Ïú†ÎÖÑÏùò ÏúóÎ™©.",
  "ÌùîÎì§Î¶¨Îäî ÎÇòÎ≠áÍ∞ÄÏßÄÏóê ÍΩÉ ÌïúÎ≤à ÌîºÏö∞Î†§Í≥† ÎààÏùÄ ÏñºÎßàÎÇò ÎßéÏùÄ ÎèÑÏ†ÑÏùÑ Î©àÏ∂îÏßÄ ÏïäÏïòÏúºÎû¥.",
  "Ïã∏Í∑∏ÎùΩ Ïã∏Í∑∏ÎùΩ ÎÇ®Î∞îÎûå ÏïûÏÑ∏Ïö∞Í≥† ÏôîÎã§Í∞Ä Ìô∞Ìô∞ Îí§Ï≤ôÏù¥Î©∞ Î∞ÄÎ†§Í∞ÄÎäî ÎààÎ≥¥Îùº.",
  "Í∑∏ Î≥¥ÎìúÎùºÏö¥ ÎßàÏùåÏùÑ Îã§Ìï¥ ÎßàÏπ®ÎÇ¥ ÌîºÏõå ÎÇ∏ Ï†Ä Ìô©ÌôÄÌïú ÍΩÉ Ìïú ÏÜ°Ïù¥ Î≥¥ÏïÑÎùº.",
  "Î¥ÑÏù¥Î©¥ Í∞ÄÏßÄÎäî Í∑∏ Ìïú Î≤à Îç¥ ÏûêÎ¶¨Ïóê ÏÑ∏ÏÉÅÏóêÏÑú Í∞ÄÏû• ÏïÑÎ¶ÑÎã§Ïö¥ ÏÉÅÏ≤òÎ•º ÌÑ∞Îú®Î¶∞Îã§.",
  "Ï†Ä ÏßÄÎ∂ï ÏïÑÎûò Ï†Ä Î∞∞Í≥†Ìîà Ïñ¥Î®∏ÎãàÎäî Ïñ¥ÎñªÍ≤å Ïû†ÏùÑ ÏûêÎäîÍ∞Ä.",
  "Î™ª ÌïòÎÇòÏóê ÏùòÏßÄÌï¥ Ïû†ÏùÑ Ï≤≠ÌïòÎäî Ï†Ä Í∞ÄÎÖÄÎ¶∞ ÏÉùÏï†Î•º Î≥¥ÏïÑÎùº.",
  "Î∞îÎûåÏù¥ Î∂àÎ©¥ ÌùîÎì§Î¶¨Í≥† ÎπÑÍ∞Ä Ïò§Î©¥ Ï†ñÏúºÎ©¥ÏÑúÎèÑ Í≤∞ÏΩî ÎÜìÏßÄ ÏïäÎäî Í∑∏ Î™ª ÌïòÎÇò.",
  "Ïö∞Î¶¨Î•º ÌÇ§Ïö¥ Í≤ÉÏùÄ Ïñ¥Î®∏ÎãàÏùò Îã®Ïû†Ïù¥ ÏïÑÎãàÎùº Í∑∏ ÏúÑÌÉúÎ°úÏö¥ Ïû†Ïùò Ìïú ÏûêÎùΩÏù¥ÏóàÏùåÏùÑ, Ïù¥Ï†úÏïº ÎÇ°ÏùÄ Î™ª ÏûêÍµ≠ÏùÑ Î≥¥Î©∞ Íπ®Îã´ÎäîÎã§.",
  "ÏÇ∞Î™®ÌâÅÏù¥Î•º ÎèåÏïÑ ÎÖºÍ∞Ä Ïô∏Îî¥ Ïö∞Î¨ºÏùÑ ÌôÄÎ°ú Ï∞æÏïÑÍ∞ÄÏÑ† Í∞ÄÎßåÌûà Îì§Ïó¨Îã§Î¥ÖÎãàÎã§.",
  "Ïö∞Î¨º ÏÜçÏóêÎäî Îã¨Ïù¥ Î∞ùÍ≥† Íµ¨Î¶ÑÏù¥ ÌùêÎ•¥Í≥† ÌïòÎäòÏù¥ ÌéºÏπòÍ≥† ÌååÎûÄ Î∞îÎûåÏù¥ Î∂àÍ≥† Í∞ÄÏùÑÏù¥ ÏûàÏäµÎãàÎã§.",
  "Í∑∏Î¶¨Í≥† Ìïú ÏÇ¨ÎÇòÏù¥Í∞Ä ÏûàÏäµÎãàÎã§.",
  "Ïñ¥Ï©êÏßÄ Í∑∏ ÏÇ¨ÎÇòÏù¥Í∞Ä ÎØ∏ÏõåÏ†∏ ÎèåÏïÑÍ∞ëÎãàÎã§.",
  "ÎèåÏïÑÍ∞ÄÎã§ ÏÉùÍ∞ÅÌïòÎãà Í∑∏ ÏÇ¨ÎÇòÏù¥Í∞Ä Í∞ÄÏóæÏñ¥ÏßëÎãàÎã§.",
  "ÎèÑÎ°ú Í∞Ä Îì§Ïó¨Îã§Î≥¥Îãà ÏÇ¨ÎÇòÏù¥Îäî Í∑∏ÎåÄÎ°ú ÏûàÏäµÎãàÎã§.",
  "Îã§Ïãú Í∑∏ ÏÇ¨ÎÇòÏù¥Í∞Ä ÎØ∏ÏõåÏ†∏ ÎèåÏïÑÍ∞ëÎãàÎã§.",
  "ÎèåÏïÑÍ∞ÄÎã§ ÏÉùÍ∞ÅÌïòÎãà Í∑∏ ÏÇ¨ÎÇòÏù¥Í∞Ä Í∑∏Î¶¨ÏõåÏßëÎãàÎã§.",
  "Ïö∞Î¨º ÏÜçÏóêÎäî Îã¨Ïù¥ Î∞ùÍ≥† Íµ¨Î¶ÑÏù¥ ÌùêÎ•¥Í≥† ÌïòÎäòÏù¥ ÌéºÏπòÍ≥† ÌååÎûÄ Î∞îÎûåÏù¥ Î∂àÍ≥† Í∞ÄÏùÑÏù¥ ÏûàÍ≥† Ï∂îÏñµÏ≤òÎüº ÏÇ¨ÎÇòÏù¥Í∞Ä ÏûàÏäµÎãàÎã§.",
  "Ï†ÄÎ†áÍ≤å ÎßéÏùÄ Ï§ëÏóêÏÑú Î≥Ñ ÌïòÎÇòÍ∞Ä ÎÇòÎ•º ÎÇ¥Î†§Îã§Î≥∏Îã§.",
  "Ïù¥Î†áÍ≤å ÎßéÏùÄ ÏÇ¨Îûå Ï§ëÏóêÏÑú Í∑∏ Î≥Ñ ÌïòÎÇòÎ•º Ï≥êÎã§Î≥∏Îã§.",
  "Î∞§Ïù¥ ÍπäÏùÑÏàòÎ°ù Î≥ÑÏùÄ Î∞ùÏùå ÏÜçÏóê ÏÇ¨ÎùºÏßÄÍ≥† ÎÇòÎäî Ïñ¥Îë† ÏÜçÏúºÎ°ú ÏÇ¨ÎùºÏßÑÎã§.",
  "Ïù¥Î†áÍ≤å Ï†ïÎã§Ïö¥ ÎÑà ÌïòÎÇò ÎÇò ÌïòÎÇòÎäî Ïñ¥ÎîîÏÑú Î¨¥ÏóáÏù¥ ÎêòÏñ¥ Îã§Ïãú ÎßåÎÇòÎû¥.",
  "Í∞ïÎÇòÎ£® Í±¥ÎÑàÏÑú Î∞ÄÎ∞≠ Í∏∏ÏùÑ Íµ¨Î¶ÑÏóê Îã¨ Í∞ÄÎìØÏù¥ Í∞ÄÎäî ÎÇòÍ∑∏ÎÑ§.",
  "Í∏∏ÏùÄ Ïô∏Ï§ÑÍ∏∞ ÎÇ®ÎèÑ ÏÇºÎ∞± Î¶¨, Ïà† ÏùµÎäî ÎßàÏùÑÎßàÎã§ ÌÉÄÎäî Ï†ÄÎÖÅ ÎÜÄ.",
  "Íµ¨Î¶ÑÏóê Îã¨ Í∞ÄÎìØÏù¥ Í∞ÄÎäî ÎÇòÍ∑∏ÎÑ§.",
  "ÏñáÏùÄ ÏÇ¨ ÌïòÏù¥ÏñÄ Í≥†ÍπîÏùÄ Í≥†Ïù¥ Ï†ëÏñ¥ÏÑú ÎÇòÎπÑ Ïû†ÏûêÎ¶¨.",
  "ÌååÎ•¥ÎùºÎãà ÍπéÏùÄ Î®∏Î¶¨ Î∞ïÏÇ¨Í≥†ÍπîÏóê Í∞ÄÎ†§ÏßÄÏö∞Í≥†, Îëê Î≥ºÏóê ÌùêÎ•¥Îäî ÎπõÏù¥ Ï†ïÏûëÏúºÎ°ú Í≥†ÏôÄÏÑú ÏÑúÎü¨ÏõåÎùº.",
  "Îπà ÎåÄÏóê Ìô©Ï¥â Î∂àÏù¥ ÎßêÏóÜÏù¥ ÎÖπÎäî Î∞§Ïóê Ïò§ÎèôÏûé ÏûéÏÉàÎßàÎã§ Îã¨Ïù¥ ÏßÄÎäîÎç∞, ÏÜåÎß§Îäî Í∏∏Ïñ¥ÏÑú ÌïòÎäòÏùÄ ÎÑìÍ≥†, ÍπåÏπòÎ∞ú ÎèãÏö∞Í≥†ÏÑú Í∞ÄÎ≥çÍ≤å ÏóêÏõåÏÑúÎùº.",
  "ÌúòÏñ¥Ï†∏ Í∞êÍ∏∞Ïö∞Í≥† Îã§Ïãú Ï†ëÏñ¥ ÎªóÎäî ÏÜêÏù¥ ÍπäÏùÄ ÎßàÏùå ÏÜç Í±∞Î£©Ìïú Ìï©Ïû•Ïù∏ ÏñëÌïòÍ≥†, Ïù¥ Î∞§ÏÇ¨ Í∑ÄÎòêÎ¶¨ÎèÑ ÏßÄÏÉàÏö∞Îäî ÏÇºÍ≤ΩÏù∏Îç∞, ÏñáÏùÄ ÏÇ¨ ÌïòÏù¥ÏñÄ Í≥†ÍπîÏùÄ Í≥†Ïù¥ Ï†ëÏñ¥ÏÑú ÎÇòÎπÑ Ïû†ÏûêÎ¶¨.",
  "ÎçîÎü¨Îäî Ïò•ÌÜ†Ïóê Îñ®Ïñ¥ÏßÄÎäî ÏûëÏùÄ ÏÉùÎ™ÖÏù¥Í≥†Ï†Ä.",
  "Ìù†ÎèÑ Ìã∞ÎèÑ ÏóÜÎäî ÎÇòÏùò Ï†ÑÏ≤¥Îäî Ïò§ÏßÅ Ïù¥Îøê.",
  "ÎçîÏö± Í∞íÏßÑ Í≤ÉÏúºÎ°ú ÎìúÎ¶¨Îùº ÌïòÏò¨ Ï†ú, ÎÇòÏùò Í∞ÄÏû• ÎÇòÏïÑÏ¢Ö ÏßÄÎãàÏù∏ Í≤ÉÎèÑ Ïò§ÏßÅ Ïù¥Îøê.",
  "ÏïÑÎ¶ÑÎã§Ïö¥ ÎÇòÎ¨¥Ïùò ÍΩÉÏù¥ ÏãúÎì¶ÏùÑ Î≥¥ÏãúÍ≥† Ïó¥Îß§Î•º Îß∫Í≤å ÌïòÏã† ÎãπÏã†ÏùÄ, ÎÇòÏùò ÏõÉÏùåÏùÑ ÎßåÎìúÏã† ÌõÑÏóê ÏÉàÎ°úÏù¥ ÎÇòÏùò ÎààÎ¨ºÏùÑ ÏßÄÏñ¥ Ï£ºÏãúÎã§.",
  "ÏÇ∞ÏùÄ Íµ¨Í∞ïÏÇ∞ Î≥¥ÎûèÎπõ ÏÑùÏÇ∞.",
  "ÏÇ∞ÎèÑÌôî ÎëêÏñ¥ ÏÜ°Ïù¥ ÏÜ°Ïù¥ÏÜ°Ïù¥ ÌîºÏóàÎäîÎç∞, Î¥ÑÎàà ÎÖπÏïÑ ÌùêÎ•¥Îäî Ïò• Í∞ôÏùÄ Î¨ºÏóê ÏÇ¨Ïä¥ÏùÄ ÏïîÏÇ¨Ïä¥ Î∞úÏùÑ ÏîªÎäîÎã§.",
  "ÎÇôÏóΩÏùÄ Ìè¥ÎûÄÎìú ÎßùÎ™Ö Ï†ïÎ∂ÄÏùò ÏßÄÌèê, Ìè¨ÌôîÏóê Ïù¥ÏßÄÎü¨ÏßÑ ÎèÑÎ£¨ ÏãúÏùò Í∞ÄÏùÑ ÌïòÎäòÏùÑ ÏÉùÍ∞ÅÏºÄ ÌïúÎã§.",
  "Í∏∏ÏùÄ Ìïú Ï§ÑÍ∏∞ Íµ¨Í≤®ÏßÑ ÎÑ•ÌÉÄÏù¥Ï≤òÎüº ÌíÄÏñ¥Ï†∏ ÏùºÍ¥ëÏùò Ìè≠Ìè¨ ÏÜçÏúºÎ°ú ÏÇ¨ÎùºÏßÄÍ≥†, Ï°∞Í∑∏Îßå Îã¥Î∞∞ Ïó∞Í∏∞Î•º ÎÇ¥ÎøúÏúºÎ©∞ ÏÉàÎ°ú Îëê ÏãúÏùò Í∏âÌñâÏó¥Ï∞®Í∞Ä ÏßÄÏó¥ÏùÑ Ï∞®Í≥† Í∞ÑÎã§.",
  "Ìè¨ÌîåÎü¨ ÎÇòÎ¨¥Ïùò Í∑ºÍ≥® ÏÇ¨Ïù¥Î°ú Í≥µÏû•Ïùò ÏßÄÎ∂ïÏùÄ Ìù∞ Ïù¥Îπ®ÏùÑ ÎìúÎü¨ÎÇ∏ Ï±Ñ Ìïú Í∞ÄÎã• Íµ¨Î∂ÄÎü¨ÏßÑ Ï≤†Ï±ÖÏù¥ Î∞îÎûåÏóê ÏùºÎ†ÅÏù¥Í≥†, Í∑∏ ÏúÑÏóê ÏÖÄÎ°úÌåêÏßÄÎ°ú ÎßåÎì† Íµ¨Î¶ÑÏù¥ Ìïú Ïû• Î∂ôÏñ¥ ÏûàÎã§.",
  "ÏÇ¨ÎûåÎì§ ÏÇ¨Ïù¥Ïóê ÏÑ¨Ïù¥ ÏûàÎã§.",
  "Í∑∏ ÏÑ¨Ïóê Í∞ÄÍ≥† Ïã∂Îã§.",
  "Î≤ºÎäî ÏÑúÎ°ú Ïñ¥Ïö∞Îü¨Ï†∏ Í∏∞ÎåÄÍ≥† ÏÇ∞Îã§.",
  "ÌñáÏÇ¥ Îî∞Í∞ÄÏõåÏßàÏàòÎ°ù ÍπäÏù¥ ÏùµÏñ¥ Ïä§Ïä§Î°úÎ•º ÏïÑÎÅºÍ≥† Ïù¥ÏõÉÎì§ÏóêÍ≤å Ï†ÄÎ•º Îß°Í∏¥Îã§.",
  "ÏÑúÎ°úÍ∞Ä ÏÑúÎ°úÏùò Î™∏ÏùÑ Î¨∂Ïñ¥ Îçî ÌäºÌäºÌï¥ÏßÑ Î∞±ÏÑ±Îì§ÏùÑ Î≥¥ÏïÑÎùº.",
  "Ï£Ñ ÏóÜÎäî Ï†ÄÌï≠Ïùò Ï∂§ÏùÑ Î≥¥ÏïÑÎùº.",
  "Î≤ºÍ∞Ä Îñ†ÎÇòÍ∞ÄÎ©∞ Î∞îÏπòÎäî Ïù¥ ÎÑìÎîîÎÑìÏùÄ ÏÇ¨ÎûëÏùÑ Î≥¥ÏïÑÎùº.",
  "Ïù¥ ÏÑ∏ÏÉÅ ÏÇ¨ÎûåÎì§ Î™®Îëê Ïû†Îì§Í≥† Ïñ¥Îë† ÏÜçÏóê Í∞áÌòÄÏÑú ÍøàÍøÄ Îïå ÌôÄÎ°ú ÏùºÏñ¥ÎÇú ÏÉàÎ≤ΩÏùÑ ÎëêÎ†§Ïõå ÎßêÍ≥† Î≥ÑÏùÑ Î≥¥Í≥† Í±∏Ïñ¥Í∞ÄÎäî ÏÇ¨ÎûåÏù¥ ÎêòÎùº.",
  "Ìù¨ÎßùÏùÑ ÎßåÎìúÎäî ÏÇ¨ÎûåÏù¥ ÎêòÎùº.",
  "Í≤®Ïö∏Î∞§ÏùÄ ÍπäÏñ¥ÏÑú ÎààÎßå ÎÇ¥Î¶¨Ïñ¥ Ïö∞Î¶¨Îì§ ÏÇ¨ÎûëÌïòÎäî ÏûêÍ∑∏Îßå ÏßëÏ∞ΩÍ∞ÄÎßàÎã§ ÎààÏù¥ ÏåìÏó¨ÎèÑ Î∂âÏùÄ ÎßàÏùå ÌïòÎÇòÎ°ú Ïû†Îì§ÏßÄ ÎßêÍ≥† Î≥ÑÏùÑ Î≥¥Í≥† Í±∏Ïñ¥Í∞ÄÎäî ÏÇ¨ÎûåÏù¥ ÎêòÎùº.",
  "Í∞ÄÎ≥¥ÏßÄ Î™ªÌïú Í≥≥ÏùÑ Í∑∏Î¶¨ÏõåÌïòÎäî ÎßàÏùåÏù¥ ÏÇ¨ÎûëÏù¥ ÏïÑÎãàÎ©¥ Î¨¥ÏóáÏù∏Í∞Ä.",
  "Í∞ÄÎ≥¥ÏßÄ Î™ªÌïú Í≥≥ÏùÑ ÏÇ¨ÎûëÌïòÎäî ÎßàÏùåÏù¥ Í∑∏Î¶¨ÏõÄÏù¥ ÏïÑÎãàÎ©¥ Î¨¥ÏóáÏù∏Í∞Ä.",
  "ÏÑúÌï¥, ÎãπÏã†Ïùò ÎààÎèôÏûê ÏÜçÏóê Ïû†Í∏∞Îäî ÎÖ∏ÏùÑÏùÑ Î≥¥Î©∞ ÎÇòÎäî Ìïú Î≤àÎèÑ Í∞ÄÎ≥¥ÏßÄ Î™ªÌïú ÎãπÏã†Ïùò ÎßàÏùåÏÜçÏùÑ Í±∑ÎäîÎã§.",
  "Í≤®Ïö∏ Î∞îÎã§Ïóê Í∞Ä Î≥¥ÏïòÏßÄ.",
  "ÎØ∏ÏßÄÏùò ÏÉà, Î≥¥Í≥† Ïã∂Îçò ÏÉàÎì§ÏùÄ Ï£ΩÍ≥† ÏóÜÏóàÎÑ§.",
  "Í∑∏ÎåÄ ÏÉùÍ∞ÅÏùÑ ÌÉùÌñàÎçîÎãà Îß§Ïö¥ Ìï¥ÌíçÏóê Í∑∏ÎßàÏ†Ä Í∞ÄÎ≤ÑÎ¶¨Í≥†, ÌóàÎ¨¥Ïùò Î∂àÏùÑ ÌîºÏõå Ï∞®Í∞ÄÏö¥ ÏàòÏã¨ÏúÑÏóê ÎçòÏ†∏ Ï£ºÏóàÎÑ§.",
  "ÎÇòÎ•º Í∞ÄÎ•¥ÏπòÎäî Í±¥ Ïñ∏Ï†úÎÇò ÏãúÍ∞Ñ, ÎÅÑÎçïÏù¥Î©∞ ÎÅÑÎçïÏù¥Î©∞ Í≤®Ïö∏ Î∞îÎã§Ïóê ÏÑ∞ÏóàÎÑ§.",
  "ÎÇ®ÏùÄ ÎÇ†ÏùÄ Ï†ÅÏßÄÎßå Í∏∞ÎèÑÎäî ÎÅùÎÇú Îã§ÏùåÎ≥¥Îã§ Îú®Í±∞Ïö¥ Í∏∞ÎèÑÏùò ÏãúÏûëÏûÑÏùÑ ÎØøÎÖ∏Îùº.",
  "Î∞îÎûåÏù¥ ÏÑúÎäòÎèÑ ÌïòÏó¨ Îú∞ ÏïûÏóê ÎÇòÏÑ∞ÎçîÎãà, ÏÑúÏÇ∞ Î®∏Î¶¨Ïóê ÌïòÎäòÏùÄ Íµ¨Î¶ÑÏùÑ Î≤óÏñ¥ÎÇòÍ≥†, ÏÇ∞ÎúªÌïú Ï¥àÏäπÎã¨Ïù¥ Î≥ÑÎπõÏùÑ Îç∞Î¶¨Í≥† ÏòµÎãàÎã§.",
  "Î≥ÑÏïÑ, Ï†Ä Î≥ÑÏïÑ, ÎÑàÎäî Ïñ¥Ïù¥ Í∑∏Î¶¨ÎèÑ Î∞ùÏúºÎÉê.",
  "ÎÇ¥ ÎßàÏùåÏÜçÏóê Í∞ÄÎìùÌïú Ïñ¥Îë†ÏùÑ ÎÑ§Í∞Ä Îã§ Í∞ÄÏ†∏Í∞îÎäêÎÉê.",
  "Î™©Î†®ÍΩÉ ÏßÄÎäî Î™®Ïäµ ÏßÄÏ†ÄÎ∂ÑÌïòÎã§Í≥† ÎßêÌïòÏßÄ ÎßêÎùº.",
  "Í≥ÅÏóê ÏûàÏùÑ Îïå ÌôòÌïòÎçò Î™®ÏäµÎßåÌÅºÏù¥ÎÇò Îñ†ÎÇ† ÎïåÏùò Î™®ÏäµÎèÑ Î¨µÏßÅÌïú Î≤ïÏù¥Îã§.",
  "Ìù∞ ÎπõÏùÑ Îã§ ÎÇ¥Ïñ¥Ï£ºÍ≥† Ïä§Ïä§Î°ú ÎàÑÎü∞ ÌùôÎπõÏúºÎ°ú ÎèåÏïÑÍ∞ÄÎäî Ï†Ä Îã®Ìò∏Ìï®ÏùÑ Î≥¥Îùº.",
  "ÏÇ¨ÎûëÎèÑ Í∑∏ÏôÄ Í∞ôÏïÑÏÑú Îú®Í±∞Ïõ†Îçò ÎßåÌÅº ÏãùÏñ¥Í∞ÄÎäî ÏãúÍ∞ÑÎèÑ ÏïÑÎ¶ÑÎã§ÏõåÏïº ÌïòÎ¶¨Îãà.",
  "Î≥ëÏõêÏóê Í∞à Ï±ÑÎπÑÎ•º ÌïòÎ©∞ Ïñ¥Î®∏ÎãàÍªòÏÑú Ìïú ÎßêÏîÄ ÌïòÏã†Îã§.",
  "ÌóàÎ¶¨Í∞Ä ÏïÑÌîÑÎãàÍπå ÏÑ∏ÏÉÅÏù¥ Îã§ ÏùòÏûêÎ°ú Î≥¥Ïó¨Ïïº.",
  "ÍΩÉÎèÑ Ïó¥Îß§ÎèÑ Í∑∏Í≤å Îã§ ÏùòÏûêÏóê ÏïâÏïÑ Ïâ¨Îäî Í≤ÉÏù¥Ïó¨.",
  "Ïã∏Ïö∞ÏßÄ ÎßàÎùº, Îã§Îì§ ÏïâÏùÑ ÏûêÎ¶¨Í∞Ä ÌïòÎÇòÏî©ÏùÄ ÏûàÎäî Î≤ïÏù¥Ïó¨.",
  "Îã§Î¶¨Í∞Ä ÏïÑÌîÑÎ©¥ Ïû†Ïãú ÏïâÏïÑ Ïâ¨Ïñ¥ Í∞ÄÎùºÍ≥† ÏÑ∏ÏÉÅÏù¥ ÎÑìÏùÄ Í≤ÉÏù¥Ïó¨.",
  "Î™®ÎûÄÏù¥ ÌîºÍ∏∞ÍπåÏßÄÎäî ÎÇòÎäî ÏïÑÏßÅ ÎÇòÏùò Î¥ÑÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏùÑ ÌÖåÏöî.",
  "Î™®ÎûÄÏù¥ ÎöùÎöù Îñ®Ïñ¥Ï†∏ Î≤ÑÎ¶∞ ÎÇ†, ÎÇòÎäî ÎπÑÎ°úÏÜå Î¥ÑÏùÑ Ïó¨Ïùú ÏÑ§ÏõÄÏóê Ïû†Í∏∏ ÌÖåÏöî.",
  "Ïò§Ïõî Ïñ¥Îäê ÎÇ† Í∑∏ ÌïòÎ£® Î¨¥Îç•Îçò ÎÇ†, Îñ®Ïñ¥Ï†∏ ÎàÑÏö¥ ÍΩÉÏûéÎßàÏ†Ä ÏãúÎì§Ïñ¥ Î≤ÑÎ¶¨Í≥†Îäî Ï≤úÏßÄÏóê Î™®ÎûÄÏùÄ ÏûêÏ∑®ÎèÑ ÏóÜÏñ¥ÏßÄÍ≥†, ÎªóÏ≥ê Ïò§Î•¥Îçò ÎÇ¥ Î≥¥Îûå ÏÑúÏö¥ÏºÄ Î¨¥ÎÑàÏ°åÎäêÎãà, Î™®ÎûÄÏù¥ ÏßÄÍ≥† ÎßàÎ©¥ Í∑∏Îøê ÎÇ¥ Ìïú Ìï¥Îäî Îã§ Í∞ÄÍ≥† ÎßêÏïÑ ÏÇºÎ∞± ÏòàÏàú ÎÇ† ÌïúÍ≤∞Í∞ôÏù¥ ÏÑ≠ÏÑ≠Ìï¥ Ïö∞ÏòµÎÇ¥Îã§.",
  "Î™®ÎûÄÏù¥ ÌîºÍ∏∞ÍπåÏßÄÎäî ÎÇòÎäî ÏïÑÏßÅ Í∏∞Îã§Î¶¨Í≥† ÏûàÏùÑ ÌÖåÏöî, Ï∞¨ÎûÄÌïú Ïä¨ÌîîÏùò Î¥ÑÏùÑ.",
  "ÏßÄÍ∏àÏùÄ ÎÇ®Ïùò ÎïÖ, ÎπºÏïóÍ∏¥ Îì§ÏóêÎèÑ Î¥ÑÏùÄ Ïò§ÎäîÍ∞Ä?",
  "ÎÇòÎäî Ïò®Î™∏Ïóê ÌñáÏÇ¥ÏùÑ Î∞õÍ≥† Ìë∏Î•∏ ÌïòÎäò Ìë∏Î•∏ Îì§Ïù¥ ÎßûÎ∂ôÏùÄ Í≥≥ÏúºÎ°ú Í∞ÄÎ•¥Îßà Í∞ôÏùÄ ÎÖºÍ∏∏ÏùÑ Îî∞Îùº ÍøàÏÜçÏùÑ Í∞ÄÎìØ Í±∏Ïñ¥Îßå Í∞ÑÎã§.",
  "ÏûÖÏà†ÏùÑ Îã§Î¨∏ ÌïòÎäòÏïÑ Îì§ÏïÑ, ÎÇ¥ ÎßòÏóêÎäî ÎÇò ÌòºÏûê Ïò® Í≤É Í∞ôÏßÄÎäî ÏïäÍµ¨ÎÇò.",
  "ÎÑ§Í∞Ä ÎÅåÏóàÎäêÎÉê ÎàÑÍ∞Ä Î∂ÄÎ•¥ÎçîÎÉê, ÎãµÎãµÌï¥Îùº ÎßêÏùÑ Ìï¥ Îã§Ïò§.",
  "Î∞îÎûåÏùÄ ÎÇ¥ Í∑ÄÏóê ÏÜçÏÇ≠Ïù¥Î©∞ Ìïú ÏûêÏö±ÎèÑ ÏÑúÏßÄ ÎßàÎùº Ïò∑ÏûêÎùΩÏùÑ ÌùîÎì§Í≥†, Ï¢ÖÎã§Î¶¨Îäî Ïö∏ÌÉÄÎ¶¨ ÎÑàÎ®∏ ÏïÑÏî®Í∞ôÏù¥ Íµ¨Î¶Ñ Îí§ÏóêÏÑú Î∞òÍ∞ëÍ≤å ÏõÉÎÑ§.",
  "Í≥†ÎßôÍ≤å Ïûò ÏûêÎûÄ Î≥¥Î¶¨Î∞≠ÏïÑ, Í∞ÑÎ∞§ ÏûêÏ†ï ÎÑòÍ≤® ÎÇ¥Î¶¨Îçò Í≥†Ïö¥ ÎπÑÎ°ú ÎÑàÎäî ÏÇºÎã® Í∞ôÏùÄ Î®∏Î¶¨Î•º Í∞êÏïòÍµ¨ÎÇò.",
  "ÎÇ¥ Î®∏Î¶¨Ï°∞Ï∞® Í∞ÄÎøêÌïòÎã§.",
  "ÏßÄÍ∏à Í∑∏ ÏÇ¨ÎûåÏùò Ïù¥Î¶ÑÏùÄ ÏûäÏóàÏßÄÎßå Í∑∏Ïùò ÎààÎèôÏûê ÏûÖÏà†ÏùÄ ÎÇ¥ Í∞ÄÏä¥Ïóê ÏûàÏñ¥.",
  "Î∞îÎûåÏù¥ Î∂àÍ≥† ÎπÑÍ∞Ä Ïò¨ ÎïåÎèÑ ÎÇòÎäî Ï†Ä Ïú†Î¶¨Ï∞Ω Î∞ñ Í∞ÄÎ°úÎì± Í∑∏ÎäòÏùò Î∞§ÏùÑ ÏûäÏßÄ Î™ªÌïòÏßÄ.",
  "ÏÇ¨ÎûëÏùÄ Í∞ÄÍ≥† Í≥ºÍ±∞Îäî ÎÇ®Îäî Í≤É, Ïó¨Î¶ÑÎÇ†Ïùò Ìò∏Ïà´Í∞Ä Í∞ÄÏùÑÏùò Í≥µÏõê, Í∑∏ Î≤§Ïπò ÏúÑÏóê ÎÇòÎ≠áÏûéÏùÄ Îñ®Ïñ¥ÏßÄÍ≥† ÎÇòÎ≠áÏûéÏùÄ ÌùôÏù¥ ÎêòÍ≥† ÎÇòÎ≠áÏûéÏóê ÎçÆÏó¨ÏÑú Ïö∞Î¶¨Îì§Ïùò ÏÇ¨ÎûëÏù¥ ÏÇ¨ÎùºÏßÑÎã§ Ìï¥ÎèÑ.",
  "ÏßÄÍ∏à Í∑∏ ÏÇ¨Îûå Ïù¥Î¶ÑÏùÄ ÏûäÏóàÏßÄÎßå Í∑∏Ïùò ÎààÎèôÏûê ÏûÖÏà†ÏùÄ ÎÇ¥ Í∞ÄÏä¥Ïóê ÏûàÏñ¥ ÎÇ¥ ÏÑúÎäòÌïú Í∞ÄÏä¥Ïóê ÏûàÎÑ§.",
  "Í≤®Ïö∏ ÎÇòÎ¨¥ÏôÄ Î∞îÎûå, Î®∏Î¶¨ÌïÄ ÍΩÇÏùÄ ÏòàÏÅú Ï†êÎì§Ïù¥ ÎπÑÎëòÍ∏∞Ï≤òÎüº ÏÇ∞ÏùÑ ÎÇ¥Î†§Í∞ÄÎÑ§.",
  "Ïò® ÏÑ∏ÏÉÅÏù¥ ÎààÏùò Ïò∑ÏùÑ ÏûÖÏóàÏúºÎãà, Ïö∞Î¶¨Îì§ ÏÇ¨ÎûëÌïòÏßÄ ÏïäÏùÑ Ïàò ÏóÜÎÑ§.",
  "ÎàÑÍµ¨ÏùºÍπå, Ïù¥ÌÜ†Î°ù ÎààÎ∂ÄÏã† Ïπ®Î¨µÏùÑ Î≥¥ÎÇ¥Îäî Ïù¥Îäî.",
  "ÎßàÏùåÏÜçÏóê Í∞ÄÎìùÌûà Ï∞¨ Í∏∞ÎèÑÎ•º Ïò¨Î¶¨Í≥†, ÎààÏù¥ ÎÖπÍ∏∞ Ï†ÑÏóê ÎÇ¥ ÏÇ¨ÎûëÏùÄ Í∑∏ÎåÄÏóêÍ≤å ÎãøÍ∏∞Î•º.",
  "ÏïÑÏ£º Ïò§Îûú ÏÑ∏ÏõîÏù¥ ÌùêÎ•∏ Îí§Ïóê ÌûòÏóÜÎäî Ï±ÖÍ∞àÌîºÏôÄ Ïù¥ Ï¢ÖÏù¥Í∞Ä ÎÇòÎ•º Ï∞æÏïÑÏò¨ Ï§Ñ ÏïåÏïòÏßÄ.",
  "Í∑∏Îïå ÎÇ¥ ÎßàÏùåÏùÄ ÎÑàÎ¨¥ÎÇò ÎßéÏùÄ Í≥µÏû•ÏùÑ ÏÑ∏Ïõ†ÏúºÎãà, Ïñ¥Î¶¨ÏÑùÍ≤åÎèÑ Í∑∏ÌÜ†Î°ù Í∏∞Î°ùÌï† Í≤ÉÏù¥ ÎßéÏïòÍµ¨ÎÇò.",
  "Íµ¨Î¶Ñ Î∞ëÏùÑ Ï≤úÏ≤úÌûà Í∞ÄÎäî Í∞úÏ≤òÎüº ÏßÄÏπ† Ï§Ñ Î™®Î•¥Îäî ÎÇòÏùò Ïó¥ÎßùÏùÄ, Îã® Ìïú Î≤àÎèÑ ÎÇòÎ•º ÏÇ¨ÎûëÌïòÏßÄ ÏïäÏïòÎçò ÎÇòÎ•º Ï∞æÏïÑ ÎèåÏïÑÏò®Îã§.",
  "ÎÇòÏùò ÏÉùÏùÄ ÎØ∏Ïπú ÎìØÏù¥ ÏÇ¨ÎûëÏùÑ Ï∞æÏïÑ Ìó§Îß§ÏóàÏúºÎÇò Îã® Ìïú Î≤àÎèÑ Ïä§Ïä§Î°úÎ•º ÏÇ¨ÎûëÌïòÏßÄ ÏïäÏïòÎÖ∏Îùº.",
  "ÍΩÉÍ≤åÍ∞Ä Í∞ÑÏû• ÏÜçÏóê Î∞òÏØ§ Î™∏ÏùÑ Îã¥Í∑∏Í≥† ÏóéÎìúÎ†§ ÏûàÎã§.",
  "Îì±ÌåêÏóê Í∞ÑÏû•Ïù¥ Ïö∏Ïª•Ïö∏Ïª• ÏèüÏïÑÏßà Îïå ÍΩÉÍ≤åÎäî Î±ÉÏÜçÏùò ÏïåÏùÑ Íª¥ÏïàÏúºÎ†§Í≥† ÍøàÌãÄÍ±∞Î¶¨Îã§Í∞Ä Îçî ÎÇÆÍ≤å Îçî Î∞îÎã• Ï™ΩÏúºÎ°ú ÏõÖÌÅ¨Î†∏ÏúºÎ¶¨Îùº.",
  "Î≤ÑÎë•Í±∞Î¶ºÏùÑ Î©àÏ∂îÍ≥† Ï†ú Î™∏ÏÜçÏóê ÏïåÏùÑ Îã§ÏπòÏßÄ ÏïäÍ≤å ÌïòÎ†§Í≥† Ïñ¥Îë†ÏùÑ Î∞õÏïÑÎì§ÏòÄÏúºÎ¶¨Îùº.",
  "ÏïåÎì§ÏïÑ Í±±Ï†ï ÎßàÎùº, Ïù¥Ï†ú Í≥ß Í∞ÑÏû•Ïù¥ Îì§Ïñ¥Ïò®Îã§.",
  "Î∂àÏùÑ ÎÅÑÍ≥† Ïñ¥Îë† ÏÜçÏóêÏÑú Ï°∞Ïö©Ìûà Ïà®ÏùÑ Ï£ΩÏòÄÏúºÎ¶¨Îùº.",
  "ÎèåÎã¥Ïóê ÏÜçÏÇ≠Ïù¥Îäî ÌñáÎ∞úÍ∞ôÏù¥, ÌíÄ ÏïÑÎûò ÏõÉÏùå ÏßìÎäî ÏÉòÎ¨ºÍ∞ôÏù¥, ÎÇ¥ ÎßàÏùå Í≥†ÏöîÌûà Í≥†Ïö¥ Î¥Ñ Í∏∏ ÏúÑÏóê Ïò§Îäò ÌïòÎ£® ÌïòÎäòÏùÑ Ïö∞Îü¨Î•¥Í≥† Ïã∂Îã§.",
  "ÏÉàÏïÖÏãú Î≥ºÏóê Î∂âÏùÄ Î∂ÄÎÅÑÎüºÍ∞ôÏù¥, ÏãúÏùò Í∞ÄÏä¥Ïóê ÏÇ¥Ìè¨Ïãú Ï†ñÎäî Î¨ºÍ≤∞Í∞ôÏù¥, Î≥¥ÎìúÎ†àÌïú ÏóêÎ®∏ÎûÑÎìú ÏñáÍ≤å ÌùêÎ•¥Îäî Ïã§ÎπÑÎã® ÌïòÎäòÏùÑ Î∞îÎùºÎ≥¥Í≥† Ïã∂Îã§.",
  "ÏÇ∞ÏïÑ ÏÇ∞ÏïÑ Ìë∏Î•∏ ÏÇ∞ÏïÑ, ÎÑ§ Í∞ÄÏä¥Ïóê ÎÇòÎ•º Î¨ªÏñ¥ Îã§Ïò§.",
  "ÎªêÍæ∏Í∏∞ ÎÖ∏ÎûòÌïòÎäî Íµ¨Î¶Ñ ÏïÑÎûò, ÍΩÉÎì§Ïù¥ ÏõÉÍ≥† ÏÉàÎì§Ïù¥ ÎÖ∏ÎûòÌïòÎäî ÎÑ§ ÌíàÏÜçÏúºÎ°ú ÎÇòÎ•º Î∞õÏïÑ Îã§Ïò§.",
  "ÎÇ¥Í∞Ä Ï£ΩÏñ¥ ÌùôÏù¥ ÎêòÍ≥† ÌíÄÏù¥ ÎêòÏñ¥ÎèÑ, ÎÑàÏùò Ìë∏Î•∏ Í∑∏Îäò ÏïÑÎûòÏÑú ÏòÅÏõêÌûà Ïû†Îì§Í≥† Ïã∂Îã§.",
  "ÌùêÎ•¥Îäî Í≤ÉÏù¥ Î¨ºÎøêÏù¥Îû¥.",
  "Ïö∞Î¶¨Í∞Ä Ï†ÄÎ¨∏ Í∞ïÏ∞ΩÏóê ÏÇΩÏùÑ ÏîªÏúºÎ©∞ Í±∞Í∏∞ Ïä¨ÌîîÎèÑ ÌçºÎã§ Î≤ÑÎ¶∞Îã§.",
  "ÏùºÏù¥ ÎÅùÎÇò Ï†ÄÎ¨ºÏñ¥, Ïä§Ïä§Î°ú ÍπäÏñ¥ Í∞ÄÎäî Í∞ïÏùÑ Î≥¥Î©∞ Ï≠àÍ∑∏Î†§ ÏïâÏïÑ Îã¥Î∞∞ÎÇò ÌîºÏö∞Í≥† ÎÇòÎäî ÎèåÏïÑÍ∞à ÎøêÏù¥Îã§.",
  "ÏÇΩÏûêÎ£®Ïóê Îß°Í∏¥ Ìïú ÏÉùÏï†Í∞Ä Ïù¥Î†áÍ≤å Ï†ÄÎ¨ºÍ≥† Ï†ÄÎ¨ºÏñ¥ÏÑú, ÏÉâÍ∞ï Î∞îÎã• Ïç©ÏùÄ Î¨ºÏóê Îã¨Ïù¥ Îú®ÎäîÍµ¨ÎÇò.",
  "Ïö∞Î¶¨Í∞Ä Ï†ÄÎ¨∏ Í∞ïÏ∞ΩÏóê ÏÇΩÏùÑ ÏîªÏúºÎ©∞ Î®πÏùÑ Í≤É ÏóÜÎäî ÏÇ¨ÎûåÎì§Ïùò ÎßàÏùÑÎ°ú Îã§Ïãú Ïñ¥ÎëêÏõå ÎèåÏïÑÍ∞ÄÏïº ÌïúÎã§.",
  "Ïô∏Î°≠Í≤å ÏÇ¥Îã§ Ïô∏Î°≠Í≤å Ï£ΩÏùÑ ÎÇ¥ ÏòÅÌòºÏùò ÎπàÌÑ∞Ïóê ÏÉàÍ∞Ä Ìïú ÎßàÎ¶¨ ÎÇ†ÏïÑÏôÄ ÏïâÎäîÎã§.",
  "Ïù¥Î¶ÑÎèÑ Î™®Î•¥Îäî ÏûëÏùÄ ÏÉà, Í∑∏ ÏûëÏùÄ Î∂ÄÎ¶¨Î°ú ÎÇ¥ ÎßàÏùåÏùò ÏÉÅÏ≤òÎ•º Ï™ºÏïÑ Î®πÎäîÎã§.",
  "ÏïÑÌîîÎèÑ Ïä¨ÌîîÎèÑ Îã§ Í∞ÄÏ†∏Í∞ÄÎã§Ïò§.",
  "Í∑∏Î¶¨Í≥† ÌïòÎäò ÎÜíÏù¥ ÎÇ†ÏïÑÍ∞Ä ÏïÑÎ¶ÑÎã§Ïö¥ ÎÖ∏ÎûòÎ°ú ÏÑ∏ÏÉÅÏùÑ Ï±ÑÏõå Îã§Ïò§.",
  "ÎπÑÍ∞Ä Ïò§Î©¥ ÎπÑÎ•º ÎßûÍ≥† Î∞îÎûåÏù¥ Î∂àÎ©¥ Î∞îÎûåÏùÑ ÎßûÏúºÎ©∞, Ïö∞Î¶¨Îäî Í∑∏Î†áÍ≤å ÏÑúÎ°úÏùò Í≥ÅÏùÑ ÏßÄÌÇ§Îäî ÎÇòÎ¨¥Í∞Ä ÎêòÏûê.",
  "Ïñ¥Îäê ÎÇ† Î¨∏Îìù ÎÑ§Í∞Ä Í∑∏Î¶¨ÏõåÏßÄÎ©¥, ÎÇòÎäî Í∞ÄÎßåÌûà ÎààÏùÑ Í∞êÍ≥† ÎÑ§ Ïù¥Î¶ÑÏùÑ Î∂àÎü¨ Î≥¥Î¶¨Îùº.",
  "Ï†Ä Î©ÄÎ¶¨ÏÑú Îì§Î†§Ïò§Îäî ÎÇòÎ≠áÏûé ÏÜåÎ¶¨Í∞Ä ÎÑ§ ÎåÄÎãµÏù∏ Ïñë ÏÉùÍ∞ÅÌïòÎ©∞, ÎÇòÎäî Îã§Ïãú Í∏∏ÏùÑ Îñ†ÎÇòÎ¶¨Îùº.",
  "Ï†ÄÎÖÅÏùÑ Î®πÍ≥† ÎÇòÎ©¥ ÌóàÎ¨ºÏóÜÏù¥ Ï∞æÏïÑÍ∞Ä Ï∞® Ìïú ÏûîÏùÑ ÎßàÏãúÍ≥† Ïã∂Îã§Í≥† ÎßêÌï† Ïàò ÏûàÎäî ÏπúÍµ¨Í∞Ä ÏûàÏóàÏúºÎ©¥ Ï¢ãÍ≤†Îã§.",
  "ÏûÖÏùÄ Ïò∑ÏùÑ Í∞àÏïÑÏûÖÏßÄ ÏïäÍ≥† ÍπÄÏπò ÎÉÑÏÉàÍ∞Ä ÎÇòÎèÑ ÌùâÎ≥¥ÏßÄ ÏïäÏùÑ Í∑∏Îü∞ ÏπúÍµ¨, Î∞§Îä¶ÎèÑÎ°ù Ïù¥ÏïºÍ∏∞Í∞Ä ÎÅäÏù¥ÏßÄ ÏïäÏïÑÎèÑ ÏßÄÎ£®ÌïòÏßÄ ÏïäÏùÄ ÏπúÍµ¨.",
  "Í∑∏Îü∞ ÏπúÍµ¨ÏôÄ Ìï®ÍªòÎùºÎ©¥ Ïù∏ÏÉùÏùò ÌóòÌïú Í∏∏ÎèÑ ÎëêÎ†µÏßÄ ÏïäÏúºÎ¶¨Îùº.",
  "ÎÇòÎäî Ìïú ÏûéÏùò Ïó¨ÏûêÏôÄ ÏÇ¥Í≥† Ïã∂Îã§.",
  "Í∞ÄÏùÑÏù¥Î©¥ ÎÇôÏóΩÏù¥ ÎêòÏñ¥ ÎÇ¥ Í∞ÄÏä¥Ïóê ÏåìÏù¥Í≥†, Î¥ÑÏù¥Î©¥ ÏÉàÏàúÏù¥ ÎêòÏñ¥ ÎÇ¥ ÌíàÏóêÏÑú ÎèãÏïÑÎÇòÎäî Í∑∏Îü∞ Ïó¨ÏûêÏôÄ.",
  "Î∞îÎûåÏù¥ Î∂àÎ©¥ ÌùîÎì§Î¶¨Îäî ÎÇòÎ≠áÏûéÏ≤òÎüº ÎÇ¥ ÎßàÏùåÎèÑ Ìï®Íªò ÌùîÎì§Î¶¥ Ïàò ÏûàÎäî, Ìà¨Î™ÖÌïòÍ≥† Í≥†ÏöîÌïú ÏòÅÌòºÏùÑ Í∞ÄÏßÑ Ïó¨ÏûêÏôÄ ÏÇ¥Í≥† Ïã∂Îã§.",
  "ÎÇ¥ Í≥†ÌÜµÏùÄ ÏûëÏïòÎã§.",
  "Í∑∏Îü¨ÎÇò Í∑∏ Í≥†ÌÜµÏùò ÎÅùÏóêÏÑú ÎÇòÎäî ÎπÑÎ°úÏÜå ÏÑ∏ÏÉÅÏùÑ Î≥¥ÏïòÎã§.",
  "Ìè≠ÌíçÏö∞Í∞Ä ÏßÄÎÇòÍ∞Ñ Îí§Ïùò ÌïòÎäòÏ≤òÎüº, Îú®Í±∞Ïõ†Îçò Ïó¨Î¶ÑÏù¥ Í∞ÄÍ≥† ÎÇú Îí§Ïùò Îì§ÌåêÏ≤òÎüº, ÎÇ¥ ÎßàÏùåÎèÑ Ïù¥Ï†úÎäî ÌèâÏò®ÏùÑ Ï∞æÏïòÎã§.",
  "Ïì∞Îü¨ÏßÑ Î∞∞Î°±ÎÇòÎ¨¥ ÍΩÉÎì§Ïù¥ Îã§Ïãú ÌîºÏñ¥ÎÇòÎäî Í≤ÉÏùÑ Î≥¥Î©∞, ÎÇòÎäî ÏÇ∂Ïùò ÎÅàÏßàÍ∏¥ ÏïÑÎ¶ÑÎã§ÏõÄÏùÑ Î∞∞Ïö¥Îã§.",
  "ÎãπÏã†ÏùÑ Î≥¥ÎÇ¥Í≥† ÎèåÏïÑÏò§Îäî Í∏∏Ïóê ÎÇòÎäî Î≥¥ÏïòÎÑ§.",
  "Í∏∏Í∞ÄÏóê ÌïÄ Ïù¥Î¶Ñ ÏóÜÎäî ÍΩÉ Ìïú ÏÜ°Ïù¥Í∞Ä ÏñºÎßàÎÇò ÏúÑÌÉúÎ°≠Í≤å ÌùîÎì§Î¶¨Í≥† ÏûàÎäîÏßÄÎ•º.",
  "ÏÇ¨ÎûëÌïúÎã§Îäî Í≤ÉÏùÄ Í≤∞Íµ≠ Ïù¥Î≥ÑÏùÑ Ï§ÄÎπÑÌïòÎäî Í≥ºÏ†ïÏù¥ÏóàÏùåÏùÑ, Îñ†ÎÇòÍ∞ÄÎäî ÎãπÏã†Ïùò Îí∑Î™®ÏäµÏùÑ Î≥¥Î©∞ Ïù¥Ï†úÏïº Íπ®Îã´ÎÑ§.",
  "Ïö∞Î¶¨Í∞Ä ÎààÎ∞úÏù¥ÎùºÎ©¥ ÌóàÍ≥µÏóêÏÑú Ï≠àÎπóÏ≠àÎπó Ìï®Î∞ïÎààÏù¥ ÎêòÏûê.",
  "Ïö∞Î¶¨Í∞Ä ÎààÎ∞úÏù¥ÎùºÎ©¥ Ïû† Î™ª Îì† Ïù¥Ïùò Ï∞ΩÍ∞ÄÏóêÏÑú Ìé∏ÏßÄÍ∞Ä ÎêòÍ≥† Í∑∏Ïù¥Ïùò ÍπäÍ≥† Î∂âÏùÄ ÏÉÅÏ≤ò ÏúÑÏóê ÎèãÎäî ÏÉàÏÇ¥Ïù¥ ÎêòÏûê.",
  "Ïö∞Î¶¨Í∞Ä ÎààÎ∞úÏù¥ÎùºÎ©¥ ÏßÑÎààÍπ®ÎπÑÎäî ÎêòÏßÄ ÎßêÏûê.",
  "ÏÑ∏ÏÉÅÏù¥ Ïñ¥ÏßÄÎü¨Ïö∏ÏàòÎ°ù Ïö∞Î¶¨Îäî ÏÑúÎ°úÏùò ÏãúÎ¶∞ ÏÜêÏùÑ Ïû°ÏïÑÏ£ºÎäî Îî∞ÎúªÌïú Ìï®Î∞ïÎààÏù¥ ÎêòÏñ¥ ÎÇ¥Î¶¨Ïûê.",
  "Îã¨Ïù¥ Îñ¥Îã§Í≥† Ï†ÑÌôîÎ•º Ï£ºÏãúÎã§ÎãàÏöî Ïù¥ Î∞§ ÎÑàÎ¨¥ Ïã†ÎÇòÍ≥† ÏïÑÎ¶ÑÎãµÏäµÎãàÎã§.",
  "ÎÇ¥ ÎßàÏùåÏóêÎèÑ ÏÉùÏ†Ñ Î≥¥ÏßÄ Î™ªÌïú ÌôòÌïú Îã¨Ïù¥ Îñ†Ïò§Î•¥Í≥† Îã¨ÎπõÏù¥ Ï†ÑÌôîÎ•º ÌÉÄÍ≥† ÌùòÎü¨ÏôÄ Ïò® Î∞©ÏïàÏùÑ Í∞ÄÎìù Ï±ÑÏõÅÎãàÎã§.",
  "ÏÑ∏ÏÉÅÏóê, ÎãπÏã†Ïù¥ÎùºÎäî ÏÇ¨ÎûåÏù¥ ÏûàÎã§Îäî Í≤ÉÎßåÏúºÎ°úÎèÑ ÎÇòÎäî Ïù¥Î†áÍ≤å Îã§Ïãú ÌÉúÏñ¥ÎÇú ÎìØ ÌñâÎ≥µÌï¥ÏßëÎãàÎã§.",
  "Ïö¥Ï£ºÏÇ¨ ÏôÄÎ∂àÎãòÏùÑ ÎµôÍ≥† ÎèåÏïÑÏò§Îäî Í∏∏Ïóê Í∑∏ÎåÄ Í∞ÄÏä¥Ïùò Ï≤òÎßà ÎÅùÏóê ÌíçÍ≤ΩÏùÑ Îã¨Í≥† ÎèåÏïÑÏôîÎã§.",
  "Î®º Îç∞ÏÑú Î∞îÎûåÏù¥ Î∂àÏñ¥ÏôÄ ÌíçÍ≤Ω ÏÜåÎ¶¨Í∞Ä Îì§Î¶¨Î©¥ ÎÇòÎ•º ÏÉùÍ∞ÅÌï¥Ï£ºÍ∏∞Î•º Î∞îÎùºÎäî ÎßàÏùåÏúºÎ°ú.",
  "ÎπÑÎ∞îÎûåÏù¥ ÏπòÍ≥† ÎààÎ≥¥ÎùºÍ∞Ä Ï≥êÎèÑ Í∑∏ÎåÄ Í∞ÄÏä¥ÏÜçÏóê Îß§Îã¨Î¶∞ ÎÇ¥ ÎßàÏùåÏùÄ ÎßëÏùÄ ÏÜåÎ¶¨Î•º ÎÇ¥Î©∞ ÌùîÎì§Î¶¨Í≥† ÏûàÏùÑ Í≤ÉÏù¥Îã§.",
  "Í≤¨Ïö∞ÏßÅÎÖÄÎèÑ Ïù¥ ÎÇ†ÎßåÏùÄ ÎßåÎÇòÍ≤å ÌïòÎäî Ïπ†ÏÑùÎÇ†, ÎÇòÎäî ÎãπÏã†ÏùÑ ÎïÖÏóê Î¨ªÍ≥† ÎèåÏïÑÏôîÏäµÎãàÎã§.",
  "ÏÇ∞Î®∏Î¶¨Ïóê Îú¨ Î≥ÑÏùÑ Î≥¥Î©∞ ÎãπÏã†Ïù¥ ÏûàÎäî Í≥≥ÍπåÏßÄ ÎÇ¥ ÎßàÏùåÏù¥ ÎãøÏùÑ Ïàò ÏûàÏùÑÏßÄ Î¨ªÍ≥† Îòê Î¨ºÏóàÏäµÎãàÎã§.",
  "ÎãπÏã†ÏùÑ Î≥¥ÎÇ¥Í≥† ÎèåÏïÑÏò§Îäî Í∏∏Ïóê ÎÇ¥ Î∞úÍ∏∏Ïóê Ï±ÑÏù¥Îäî Ìùô Ìïú Ï§åÏ°∞Ï∞® ÎãπÏã†Ïùò ÏÇ¥Í≤∞Ïù∏ Ïñë ÏÜåÏ§ëÌïòÏó¨ Ï∞®Îßà Î∞üÏßÄ Î™ªÌñàÏäµÎãàÎã§.",
  "Í∑∏Î¶¨Ïö¥ Í∑∏Ïùò ÏñºÍµ¥ Îã§Ïãú Ï∞æÏùÑ Í∏∏ ÏóÜÏñ¥ÎèÑ ÌôîÏÇ¨Ìïú Í∑∏Ïùò ÍΩÉ ÏÇ∞Ïóê Ïñ∏ÎçïÏóê ÌîºÏñ¥ÎÇ†ÏßÄÏñ¥Ïù¥.",
  "Î¥ÑÏù¥ Ïò§Î©¥ Îì§Ìåê Í∞ÄÎìù Ìë∏Î•∏ Ïà®Í≤∞Î°ú ÎêòÏÇ¥ÏïÑÎÇòÎäî Í∑∏ÎåÄ Ïù¥Î¶ÑÏùÑ ÎÇòÎäî ÎÇòÏßÄÎßâÏù¥ Î∂àÎü¨Î¥ÖÎãàÎã§.",
  "Í∞ÄÎ≤ÑÎ¶∞ Í≤ÉÎì§ÏùÄ Îã§Ïãú Ïò§ÏßÄ ÏïäÏúºÎÇò Ïö∞Î¶¨Îì§ Í∞ÄÏä¥ÏÜçÏóê ÌîºÏñ¥ÎÇú ÍΩÉÏûéÏúºÎ°ú ÏòÅÏõêÌûà ÏãúÎì§ÏßÄ ÏïäÎäî Í∑∏Î¶¨ÏõÄÏù¥ ÎêòÎ¶¨Îùº.",
  "ÏûÉÏñ¥Î≤ÑÎ†∏ÏäµÎãàÎã§.",
  "Î¨¥Ïñº Ïñ¥ÎîîÎã§ ÏûÉÏóàÎäîÏßÄ Î™∞Îùº Îëê ÏÜêÏù¥ Ï£ºÎ®∏ÎãàÎ•º ÎçîÎì¨Ïñ¥ Í∏∏Î°ú ÎÇòÍ∞ëÎãàÎã§.",
  "ÎèåÍ≥º Îèå ÏÇ¨Ïù¥Î•º ÌùêÎ•¥Îäî Î¨ºÏÜåÎ¶¨Ïóê Í∑Ä Í∏∞Ïö∏Ïù¥Î©∞ ÎÇ¥ ÏûÉÏñ¥Î≤ÑÎ¶∞ ÏûêÏïÑÎ•º Ï∞æÏïÑ ÎÅùÏóÜÏù¥ Í±∑ÏäµÎãàÎã§.",
  "ÎÇ¥Í∞Ä Í±∑Îäî Ïù¥ Í∏∏Ïù¥ ÏïÑÏπ®ÏóêÏÑú Ï†ÄÎÖÅÏúºÎ°ú Ï†ÄÎÖÅÏóêÏÑú ÏïÑÏπ®ÏúºÎ°ú ÌÜµÌñàÏúºÎ©¥ Ï¢ãÍ≤†ÏäµÎãàÎã§.",
  "Î≥¥ÎèÑÎ∏îÎ°ù ÌãàÏóê ÎøåÎ¶¨ ÎÇ¥Î¶∞ ÎØºÎì§Î†àÍ∞Ä ÍΩÉÏùÑ ÌîºÏö∏ Îïå ÎÇòÎ•º Î©àÏ∂îÍ≤å ÌïúÎã§.",
  "ÍµâÏùåÏùÑ ÎÇ¥Î©∞ ÏßàÏ£ºÌïòÎäî ÏûêÎèôÏ∞® ÏÇ¨Ïù¥Î°ú Ïó∞ÏïΩÌïú Ï¥àÎ°ùÏù¥ Í≥†Í∞úÎ•º Îì§ Îïå ÏÑ∏ÏÉÅÏùÄ Ïû†Ïãú Ïà®ÏùÑ Ï£ΩÏù¥Í≥† ÎÇòÎ•º ÎèåÏïÑÎ≥¥Í≤å ÌïúÎã§.",
  "Î∞îÏÅòÍ≤å ÎèåÏïÑÍ∞ÄÎäî ÏãúÍ≥Ñ Î∞îÎäòÏùÑ Ïû†Ïãú Î©àÏ∂îÍ≥† ÎÇ¥ Î∞úÎ∞ëÏóê ÏÇ¥ÏïÑÏûàÎäî ÏûëÏùÄ ÏÉùÎ™ÖÎì§Ïùò ÏÜçÏÇ≠ÏûÑÏóê Í∑ÄÎ•º Í∏∞Ïö∏Ïù∏Îã§.",
  "Í∑ÄÎöúÎùºÎØ∏ÏôÄ ÎÇòÏôÄ ÏûîÎîîÎ∞≠ÏóêÏÑú Ïù¥ÏïºÍ∏∞ÌñàÎã§.",
  "Í∑ÄÎö§Í∑ÄÎö§ Í∑ÄÎö§Í∑ÄÎö§ ÏïÑÎ¨¥ÏóêÍ≤åÎèÑ Ïïà Îì§ÌÇ§Í≤å Ïù¥ÏïºÍ∏∞ÌñàÎã§.",
  "Îã¨ÎπõÏù¥ ÏÜåÎ¶¨ ÏóÜÏù¥ ÎÇ¥Î†§ÏïâÎäî Î∞§, Ïö∞Î¶¨Îäî ÏûëÏùÄ Ï°¥Ïû¨Îì§Ïùò Ïä¨ÌîîÏóê ÎåÄÌï¥ ÏÜçÏÇ≠ÏòÄÎã§.",
  "ÎÜíÏùÄ ÌïòÎäòÏóê Îñ† ÏûàÎäî Î≥ÑÎì§ÎèÑ Ïö∞Î¶¨Ïùò ÎÇÆÏùÄ Î™©ÏÜåÎ¶¨Î•º Îì§ÏúºÎ†§ÎäîÏßÄ Î∞òÏßùÏù¥Î©∞ Ïà®ÏùÑ Ï£ΩÏòÄÎã§.",
  "Ïö∞Î¶¨Îì§Ïùò ÏÇ¨ÎûëÎèÑ Ïù¥Î†áÍ≤å ÍπäÏñ¥ Í∞ÄÎ©¥ Ï¢ãÍ≤†ÎÑ§.",
  "ÏñºÏùåÏû• Î∞ëÏúºÎ°ú ÏÜåÎ¶¨ Ï£ΩÏó¨ ÌùêÎ•¥Îäî Î¨ºÏÜåÎ¶¨Ï≤òÎüº, Í≤âÏúºÎ°úÎäî Ï∞®Í∞ÄÏõå Î≥¥Ïó¨ÎèÑ ÏÜçÏúºÎ°úÎäî Îî∞ÎúªÌïú Ïò®Í∏∞Î•º ÌíàÍ≥† ÌùêÎ•¥Îäî Ï†Ä Í≤®Ïö∏ Í∞ïÎ¨ºÏ≤òÎüº.",
  "Îàà ÎÇ¥Î¶¨Îäî Î∞§, Í∞ïÍ∞ÄÏóê ÏÑúÏÑú Ïö∞Î¶¨Í∞Ä Ìï®Íªò Í∞à ÍπäÍ≥† Ìë∏Î•∏ ÎÇ¥ÏùºÏùÑ ÍøàÍæ∏Ïñ¥ Î≥∏Îã§.",
  "Ïò§Îäò Ï†ÄÎÖÅ Ïù¥ Ï¢ÅÎã§ÎûÄ Î∞©Ïùò Ìù∞ Î∞îÎûåÎ≤ΩÏóê Ïñ¥Ï©êÏßÄ Ïì∏Ïì∏Ìïú Í≤ÉÎì§Ïù¥ Ïò§Í≥† Í∞ÑÎã§.",
  "Ïù¥ Ìù∞ Î∞îÎûåÎ≤ΩÏóê Ìù¨ÎØ∏Ìïú Ïã≠Ïò§Ï¥â Ï†ÑÎì±Ïù¥ ÏßÄÏπú ÏñºÍµ¥ÏùÑ ÎπÑÏ∂îÍ≥†, ÎÇòÎäî ÎÇ¥ Í∞ÄÎÇúÌïú ÏÇ¨ÎûëÍ≥º Í≥†ÎèÖÏùÑ ÏùΩÎäîÎã§.",
  "ÌïòÎäòÏù¥ Ïù¥ ÏÑ∏ÏÉÅÏùÑ ÎÇ¥Ïùº Ï†ÅÏóê Í∑∏Í∞Ä Í∞ÄÏû• Í∑ÄÌï¥ÌïòÍ≥† ÏÇ¨ÎûëÌïòÎäî Í≤ÉÎì§ÏùÄ Î™®Îëê Í∞ÄÎÇúÌïòÍ≥† Ïô∏Î°≠Í≥† ÎÜíÍ≥† Ïì∏Ïì∏ÌïòÎãà ÏÇ¥ÏïÑÍ∞ÄÎèÑÎ°ù ÎßåÎì§ÏóàÎã§Îäî Í≤ÉÏùÑ ÏÉùÍ∞ÅÌïúÎã§.",
  "ÎààÏù¥ ÎßéÏù¥ ÏôÄÏÑú ÏÇ∞Í≥†Îûë Ïô∏Îî¥ÏßëÏóê ÎààÏù¥ ÏåìÏù¥Îäî Î∞§, ÌèâÏïàÎèÑ Ïñ¥Îäê ÎßàÏùÑÏóêÎäî Íµ≠ÏàòÎ•º ÎàÑÎ•¥Îäî ÏÜåÎ¶¨Í∞Ä Îì§Î¶∞Îã§.",
  "Ìà¨Î∞ïÌïòÍ≥† Ï†ïÍ≤®Ïö¥ Ïö∞Î¶¨ÎÑ§ ÏÇ∂Ïùò ÎÉÑÏÉàÍ∞Ä Î¨ºÏî¨ ÌíçÍ∏∞Îäî Í∑∏ Îî∞ÎúªÌïú Ìïú Í∑∏Î¶áÏùò ÏúÑÎ°úÎ•º ÏÉùÍ∞ÅÌïúÎã§.",
  "ÎßàÏùÑ ÏÇ¨ÎûåÎì§Ïù¥ ÏòπÍ∏∞Ï¢ÖÍ∏∞ Î™®Ïó¨ ÏïâÏïÑ ÏãúÏãúÏΩúÏΩúÌïú Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎàÑÎ©∞ ÎÇòÎà† Î®πÎçò Í∑∏ Íµ¨ÏàòÌïú Íµ≠Ïàò Ìïú ÏÇ¨Î∞úÏù¥ Í∑∏Î¶ΩÎã§.",
  "ÎÇòÎäî Ïù¥Ï†ú ÎÑàÏóêÍ≤åÎèÑ Ïä¨ÌîîÏùÑ Ï£ºÍ≤†Îã§.",
  "ÏÇ¨ÎûëÎ≥¥Îã§ ÏÜåÏ§ëÌïú Ïä¨ÌîîÏùÑ Ï£ºÍ≤†Îã§.",
  "Ï∂îÏúÑÏóê Îñ®Í≥† ÏûàÎäî ÏÇ¨ÎûåÎì§ÏóêÍ≤å Îàà ÎåÄÏã† Î≥¥Î¶¨Ï∞® Ìïú ÏûîÏùò Ïò®Í∏∞Î•º Í±¥ÎÑ¨ Ïàò ÏûàÎäî Í∑∏Îü∞ ÎßàÏùåÏùò ÍπäÏù¥Î•º Ï£ºÍ≥† Ïã∂Îã§.",
  "ÎÇ®Ïùò ÎààÎ¨ºÏùÑ Îã¶ÏïÑÏ£ºÍ∏∞ Ï†ÑÏóê ÎÇ¥ ÎààÎ¨ºÏùò ÏùòÎØ∏Î•º Î®ºÏ†Ä ÏïÑÎäî ÏÇ¨ÎûåÏù¥ ÎêòÍ∏∞Î•º Î∞îÎûÄÎã§.",
  "ÏÇ∞Í∑∏Îäò ÎÇ¥Î¶∞ Î∞≠Í∞ÄÏóê ÏïâÏïÑ Ï∞∏Íπ®Î•º ÌÑ∏ÎäîÎã§.",
  "Î≥¥ÎìúÎùºÏö¥ ÏÜêÍ∏∏Î°ú ÌÜ°ÌÜ° Í±¥ÎìúÎ†§ÎèÑ Ï∞∏Íπ®Îäî ÏèüÏïÑÏßÄÎäîÎç∞, ÏÑ∏ÏÉÅÏùÑ ÎÑàÎ¨¥ ÏÑúÎëêÎ•¥Î©∞ ÏÇ¥ÏïÑÏò® Í≤ÉÏùÄ ÏïÑÎãåÏßÄ Î¨∏Îìù Îí§Î•º ÎèåÏïÑÎ≥¥Í≤å ÎêúÎã§.",
  "Ìïú Î≤àÏùò ÌúòÎëêÎ¶ÑÏúºÎ°ú Î™®Îì† Í≤ÉÏùÑ ÏñªÏúºÎ†§ ÌñàÎçò ÎÇ¥ ÏöïÏã¨Ïù¥ Î∂ÄÎÅÑÎü¨Ïõå Ï∞∏Íπ® ÏÜ°Ïù¥ ÏïûÏóêÏÑú Í≥†Í∞úÎ•º ÏàôÏù∏Îã§.",
  "Ïö∞Î¶¨ Ïßë Î®∏Ïä¥ ÎåÄÍ∏∏Ïù¥Îäî ÎÇòÎ•º ÏóÖÍ≥† ÌïôÍµêÏóê Îç∞Î†§Îã§Ï£ºÍ≥§ ÌñàÎã§.",
  "ÏÑ∏ÏÉÅÏóêÏÑú Í∞ÄÏû• ÎÇÆÏùÄ Í≥≥Ïóê ÏÇ¥Î©¥ÏÑúÎèÑ ÏÑ∏ÏÉÅÏóêÏÑú Í∞ÄÏû• ÌôòÌïú ÏõÉÏùåÏùÑ ÏßÄÏóàÎçò Í∑∏ ÏÇ¨ÎûåÏùò ÎßàÏùåÏù¥ ÎÇ¥ Ïú†ÎÖÑÏùò ÎπõÏù¥ÏóàÎã§.",
  "Ïù¥Ï†úÎäî Ï†ÑÏÑ§Ïù¥ ÎêòÏñ¥Î≤ÑÎ¶∞ Í∑∏Ïùò Îí∑Î™®ÏäµÏùÑ ÏÉùÍ∞ÅÌïòÎ©∞ ÎÇòÎäî ÏÇ¨ÎûåÏùÑ ÏÇ¨ÎûëÌïòÎäî Î≤ïÏùÑ Îã§Ïãú Î∞∞Ïö¥Îã§.",
  "Í∞ÄÏùÑ Î∞îÎã§Îäî ÎÇ¥Í≤å ÏôÄÏÑú ÏûäÌòÄÏßÑ ÏïΩÏÜçÏùÑ Î¨ªÎäîÎã§.",
  "ÌïòÏñóÍ≤å Î∂ÄÏÑúÏßÄÎäî ÌååÎèÑ ÏÜçÏóê ÎÇ¥Í∞Ä ÎëêÍ≥† Ïò® ÍøàÎì§Ïù¥ ÏûàÏóàÎäêÎÉêÍ≥†, Ïù¥Ï†úÎäî ÎèåÏïÑÍ∞ÄÏïº Ìï† ÏãúÍ∞ÑÏù¥ ÏïÑÎãàÎÉêÍ≥† Ìë∏Î•∏ Î™©ÏÜåÎ¶¨Î°ú ÏÜçÏÇ≠Ïù∏Îã§.",
  "ÏàòÌèâÏÑ† ÎÑàÎ®∏Î°ú Ï†ÄÎ¨ºÏñ¥Í∞ÄÎäî ÎÖ∏ÏùÑÏùÑ Î≥¥Î©∞ ÎÇòÎäî ÎåÄÎãµ ÎåÄÏã† ÍπäÏùÄ Ïπ®Î¨µ ÌïòÎÇòÎ•º Î∞îÎã§Ïóê ÎçòÏßÑÎã§."
];


function injectRaceSymbols_(s, diff, seedKey){
  // ‚úÖ PATCH(v14): 'Íπ®ÏßÑ Í∏∞Ìò∏' Ï£ºÏûÖ Ï†úÍ±∞. ÎÇúÏù¥ÎèÑÎäî ÏÜçÎèÑ/Ï†úÌïúÏãúÍ∞Ñ/ÏóÑÍ≤©Î™®ÎìúÎ°úÎßå Ï°∞Ï†à.
  return String(s||'').replace(/\s{2,}/g,' ').trim();
}

function buildRacePool_(diff){
  // diff: low/mid/high
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';

  const base = Array.isArray(SHARED_SENTENCES_) ? SHARED_SENTENCES_ : [];
  const low = [], mid = [], high = [];

  for (let i=0;i<base.length;i++){
    const raw = String(base[i]||'').trim();
    const n = raceNormalize_(raw);
    if (!n) continue;
    const L = n.length;

    if (L <= 18) low.push(n);
    else if (L <= 38) mid.push(n);
    else high.push(n);
  }

  // Î≤ÑÌÇ∑Ïù¥ Î™®ÏûêÎùºÎ©¥ Ïú†Ïó∞ÌïòÍ≤å Î≥¥Í∞ï
  const sortByLen = (a,b)=> a.length - b.length;
  low.sort(sortByLen);
  mid.sort(sortByLen);
  high.sort(sortByLen);

  const needMin = 240; // ÎÇ¥Î∂ÄÏóêÏÑú 240Í∞ú Ï∫êÏãú
  const fillFrom = (dst, src, maxLen)=>{
    for (let i=0;i<src.length && dst.length < maxLen;i++) dst.push(src[i]);
  };

  if (low.length < 220) fillFrom(low, mid, 260);
  if (mid.length < 220) {
    // Ï§ë ÎÇúÏù¥ÎèÑÎäî ÎÑàÎ¨¥ ÏßßÏùÄ Î¨∏Ïû•Îßå Î™∞Î¶¨ÏßÄ ÏïäÍ≤å, low+high ÏÑûÏñ¥ÏÑú Î≥¥Í∞ï
    fillFrom(mid, low.slice().reverse(), 260);
    fillFrom(mid, high, 260);
  }
  if (high.length < 220) {
    // ÏÉÅ ÎÇúÏù¥ÎèÑÎäî Í∏¥ Î¨∏Ïû• Ïö∞ÏÑ†, Î∂ÄÏ°±ÌïòÎ©¥ midÏùò Í∏¥ Í≤ÉÎì§Î°ú Î≥¥Í∞ï
    fillFrom(high, mid.slice().reverse(), 280);
  }

  let bucket = (d === 'high') ? high : (d === 'mid') ? mid : low;

  // ÎÇúÏù¥ÎèÑÎ≥Ñ Í∏∞Ìò∏ ÏÑûÍ∏∞
  const out = [];
  for (let i=0;i<bucket.length;i++){
    const s = bucket[i];
    const key = `${sessionId||'noSession'}|${d}|SYM|${i}|${s}`;
    const mixed = injectRaceSymbols_(s, d, key);
    const norm = raceNormalize_(mixed);
    if (!norm) continue;
    out.push(norm);
  }

  // ÏÖîÌîå(ÏÑ∏ÏÖò+ÎÇúÏù¥ÎèÑ Í≥†Ï†ï ÏãúÎìú)
  const seed = hash32_(`${sessionId||'noSession'}|${d}|POOL_SHARED`);
  const rng = mulberry32_(seed);
  shuffleWithRng_(out, rng);

  // Ï†ÅÎãπÌûà ÏÉÅÌïú
  return out.slice(0, needMin);
}


function getRacePool_(diff){
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  if (_racePoolCache_[d] && Array.isArray(_racePoolCache_[d]) && _racePoolCache_[d].length >= 200){
    return _racePoolCache_[d];
  }
  _racePoolCache_[d] = buildRacePool_(d);
  return _racePoolCache_[d];
}

function buildRaceSet_(diff, count, salt){
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  const pool = (getRacePool_(d) || []).slice();
  const seed = hash32_(`${sessionId||'noSession'}|${d}|${salt||Date.now()}`);
  const rng = mulberry32_(seed);
  shuffleWithRng_(pool, rng);
  const out = [];
  const used = new Set();
  for (let i=0; i<pool.length && out.length < count; i++){
    const s = raceNormalize_(String(pool[i]||'')).trim();
    if (!s || used.has(s)) continue;
    used.add(s);
    out.push(s);
  }
  return out;
}

function raceDiffLabel_(d){
  return (d === 'high') ? 'ÏÉÅ' : (d === 'mid') ? 'Ï§ë' : 'Ìïò';
}

function raceNormalize_(s){
  const m = String(s || '').match(RACE_ALLOWED_RE_);
  return m ? m.join('') : '';
}

function racePrefixLen_(target, typed){
  const a = String(target || '');
  const b = String(typed || '');
  const n = Math.min(a.length, b.length);
  let i = 0;
  for (; i < n; i++){
    if (a[i] !== b[i]) break;
  }
  return i;
}


function raceEscape_(s){
  return escapeHtml(String(s||''))
    .replace(/\n/g,'<br/>');
}

// ‚úÖ ÏûÖÎ†•/Ï†ïÎãµ ÎπÑÍµêÎ•º ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú Î≥¥Ïó¨Ï£ºÍ∏∞ (ÌãÄÎ¶∞ Í≥≥ Îπ®Í∞õÍ≤å + ÏàòÏ†ï ÌûåÌä∏)
function updateRaceDiffView_(targetRaw, typedRaw){
  const box = $('raceDiffView');
  const hint = $('raceHint');
  if (!box) return;

  const target = raceNormalize_(targetRaw);
  const typed  = raceNormalize_(typedRaw);

  const first = racePrefixLen_(target, typed);
  const okPrefix = target.slice(0, first);
  const expChar = (first < target.length) ? target[first] : '';
  const gotChar = (first < typed.length) ? typed[first] : '';

  const restTarget = (first < target.length) ? target.slice(first+1) : '';
  const restTyped  = (first < typed.length) ? typed.slice(first+1) : '';

  const tHtml = [
    `<span class="ok">${raceEscape_(okPrefix)}</span>`,
    (expChar ? `<span class="${(first < typed.length && gotChar!==expChar) ? 'bad' : 'miss'}">${raceEscape_(expChar)}</span>` : ''),
    `<span>${raceEscape_(restTarget)}</span>`
  ].join('');

  const uHtml = [
    `<span class="ok">${raceEscape_(typed.slice(0, first))}</span>`,
    (first < typed.length ? `<span class="${(first < target.length && gotChar!==expChar) ? 'bad' : 'bad'}">${raceEscape_(gotChar)}</span>` : ''),
    `<span>${raceEscape_(restTyped)}</span>`
  ].join('');

  box.innerHTML = `
    <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
      <div style="min-width:64px; opacity:.8; font-weight:1000;">Î™©Ìëú</div>
      <div style="flex:1; word-break:break-word;">${tHtml || '<span style="opacity:.6;">(Î¨∏Íµ¨ Î∂àÎü¨Ïò§Îäî Ï§ë)</span>'}</div>
    </div>
    <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; margin-top:8px;">
      <div style="min-width:64px; opacity:.8; font-weight:1000;">ÏûÖÎ†•</div>
      <div style="flex:1; word-break:break-word;">${uHtml || '<span style="opacity:.6;">(ÏûÖÎ†• ÎåÄÍ∏∞)</span>'}</div>
    </div>
  `;

  if (!hint) return;

  // hint
  let msg = '';
  if (!typed){
    msg = '';
  }else if (typed === target){
    msg = '';
  }else if (typed.length > target.length && typed.startsWith(target)){
    const extra = typed.slice(target.length);
    msg = `Ï¥àÍ≥º ÏûÖÎ†•! Îí§Ïùò ‚Äú${extra}‚Äù Î•º ÏßÄÏõå Ï£ºÏÑ∏Ïöî.`;
  }else if (first < target.length){
    if (first >= typed.length){
      msg = `ÎàÑÎùΩ! ${first+1}Î≤àÏß∏ Í∏ÄÏûê ‚Äú${expChar}‚Äù Î•º Ï∂îÍ∞ÄÌï¥ Ï£ºÏÑ∏Ïöî.`;
    }else{
      msg = `Ïò§ÌÉÄ! ${first+1}Î≤àÏß∏ Í∏ÄÏûê: ‚Äú${gotChar}‚Äù ‚Üí ‚Äú${expChar}‚Äù Î°ú Í≥†Ï≥ê Ï£ºÏÑ∏Ïöî.`;
    }
  }else{
    msg = `Í±∞Ïùò Îã§ ÏôîÏñ¥Ïöî! ÎÇ®ÏùÄ Î¨∏Íµ¨Î•º Ïù¥Ïñ¥ÏÑú ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.`;
  }

  if (msg){
    hint.textContent = msg;
    hint.classList.add('show');
  }else{
    hint.textContent = '';
    hint.classList.remove('show');
  }
}

function renderRaceBar_(){
  const bar = $('raceBar');
  const input = $('raceInput');
  const txtEl = $('raceText');
  const diffEl = $('raceDiff');
  const rankEl = $('raceRank');
  const scoreEl = $('raceScore');
  const progEl = $('raceProgBar');
  const stepsEl = $('raceSteps');
  const trackEl = $('raceMiniTrack');

  if (!bar || !input || !txtEl || !diffEl || !rankEl || !scoreEl || !progEl) return;

  const cur = raceCur_;
  if (!cur || !cur.id || cur.status !== 'running'){
    bar.classList.remove('show');
    bar.setAttribute('aria-hidden','true');
    input.disabled = true;
    input.value = '';
    try{ $('raceDiffView') && ($('raceDiffView').innerHTML=''); }catch(e){}
    try{ $('raceHint') && ($('raceHint').textContent=''); $('raceHint') && $('raceHint').classList.remove('show'); }catch(e){}
    progEl.style.width = '0%';
    rankEl.textContent = '‚Äî';
    scoreEl.innerHTML = '';
    if (stepsEl) stepsEl.innerHTML = '';
    try{ if (trackEl) trackEl.innerHTML = ''; }catch(e){}
    stopRaceTimer_();
    raceLocalEnabled_ = false;
    return;
  }

  bar.classList.add('show');
  bar.setAttribute('aria-hidden','false');

  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];
  const uid = myUid_();
  const me = (uid && racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;
  const myMis = Number(me.mistakes || 0) || 0;
  const myIdx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[myIdx] || texts[0] || '');

  diffEl.textContent = `üèÅ ${Math.min(myDone+1, total)}/${total} ¬∑ ÎÇúÏù¥ÎèÑ ${raceDiffLabel_(cur.difficulty)}`;
  txtEl.textContent = target;
  input.disabled = false;

  // reset input when race id changed
  if (input.dataset.raceId !== String(cur.id)){
    input.dataset.raceId = String(cur.id);
    input.value = '';
    progEl.style.width = '0%';
    rankEl.textContent = '‚Äî';
    raceLastProg_ = -1;
    try{ input.focus(); }catch(e){}
  }

  // Steps UI (my progress)
  if (stepsEl){
    let h = '<span class="stepFlag">üö©</span>';
    for (let i=0;i<total;i++){
      const cls = (i < myDone) ? 'stepDot done' : (i === myDone ? 'stepDot active' : 'stepDot');
      h += `<span class="${cls}"></span>`;
    }
    h += '<span class="stepFlag">üèÅ</span>';
    stepsEl.innerHTML = h;
  }

  // scoreboard
  const items = [];
  const now = Date.now();
  const players = racePlayers_ || {};
  for (const puid of Object.keys(players)){
    const p = players[puid] || {};
    const nm = String(p.name || 'ÏùµÎ™Ö').trim().slice(0,12);
    const doneCount = Number(p.doneCount || p.idx || 0) || 0;
    const prog = Number(p.p || 0) || 0;
    const done = !!p.done;
    const eliminated = !!p.eliminated;
    const mis = Number(p.mistakes || 0) || 0;
    const timeMs = Number(p.timeMs || 0) || 0;
    const ts = Number(p.ts || 0);
    if (ts && (now - ts) > 180000) continue; // stale 3m
    items.push({ uid: puid, nm, doneCount, prog, done, eliminated, mis, timeMs });
  }

  items.sort((a,b)=>{
    const aPerfect = a.done && a.mis === 0;
    const bPerfect = b.done && b.mis === 0;
    if (aPerfect && bPerfect) return a.timeMs - b.timeMs;
    if (aPerfect) return -1;
    if (bPerfect) return 1;
    if (a.doneCount !== b.doneCount) return b.doneCount - a.doneCount;
    if (a.prog !== b.prog) return b.prog - a.prog;
    if (a.mis !== b.mis) return a.mis - b.mis;
    return a.nm.localeCompare(b.nm);
  });

  // my rank
  if (uid){
    const r = items.findIndex(x=> x.uid === uid);
    rankEl.textContent = (r >= 0) ? `#${r+1}` : '‚Äî';
  }else{
    rankEl.textContent = '‚Äî';
  }

  // mini track (top 5)
  try{
    if (trackEl){
      const top = items.slice(0,5);
      let h = '';
      for (let i=0;i<top.length;i++){
        const it = top[i];
        const idx = Math.max(0, Math.min(total-1, Number(it.doneCount||0)));
        const t = String(texts[idx] || texts[texts.length-1] || '');
        const L = Math.max(1, t.length);
        const p = Math.max(0, Math.min(L, Number(it.prog||0)));
        let pct = it.done ? 100 : (((idx / total) + ((p / L) / total)) * 100);
        pct = Math.max(0, Math.min(100, pct));
        const icon = it.done ? 'üèÅ' : (it.eliminated ? 'üí•' : (i===0 ? 'üèéÔ∏è' : i===1 ? 'üöó' : i===2 ? 'üöô' : 'üöò'));
        const medalCls = (i===0?'medal1':i===1?'medal2':i===2?'medal3':'');
        h += `<div class="raceLane"><div class="raceNamePill">${escapeHtml(it.nm)}</div><div class="raceCar ${medalCls}" style="left:${pct.toFixed(1)}%">${icon}</div></div>`;
      }
      trackEl.innerHTML = h;
    }
  }catch(e){}

  // UI
  scoreEl.innerHTML = '';
  const hint = document.createElement('div');
  hint.className = 'raceHintLine';
  const myStateText = raceMeElim_ ? 'üö´ ÌÉàÎùΩ(Ïò§ÌÉÄ)' : `ÎÇ¥ Ïã§Ïàò: ${myMis}Ìöå`;
  hint.innerHTML = `<span>Enter=Ï†úÏ∂ú ¬∑ <b>Î¨¥Ïã§Ïàò 10Î¨∏Ïû•</b> Ïö∞Ïäπ</span><span class="${(raceMeElim_||myMis>0)?'bad':''}">${myStateText}</span>`;
  scoreEl.appendChild(hint);

  items.slice(0,8).forEach((it)=>{
    const chip = document.createElement('div');
    chip.className = 'raceChip';
    const doneText = it.done ? ` ¬∑ ${(it.timeMs/1000).toFixed(2)}s` : '';
    chip.innerHTML = `
      <div class="top"><span>${escapeHtml(it.nm)}</span><span class="sub">${it.doneCount}/${total}${doneText}</span></div>
      <div class="sub">Ïò§ÌÉÄ ${it.mis} ¬∑ ÏßÑÌñâ ${it.prog}</div>
    `;
    scoreEl.appendChild(chip);
  });

  startRaceTimer_();
  bindRaceInput_();
  raceLocalEnabled_ = true;

  try{
    if (document.activeElement !== input) input.focus();
  }catch(e){}
}


async function celebrateRaceEnd_(){
  try{
    const cur = raceCur_;
    if (!cur || !cur.id) return;
    const rid = String(cur.id);
    if (raceCelebratedId_ === rid) return;
    raceCelebratedId_ = rid;

    const items = [];
    const players = racePlayers_ || {};
    for (const puid of Object.keys(players)){
      const p = players[puid] || {};
      const nm = String(p.name || 'ÏùµÎ™Ö').trim().slice(0,12);
      const done = !!p.done;
      const mis = Number(p.mistakes || 0) || 0;
      const timeMs = Number(p.timeMs || 0) || 0;
      const doneCount = Number(p.doneCount || p.idx || 0) || 0;
      const prog = Number(p.p || 0) || 0;
      items.push({ nm, done, mis, timeMs, doneCount, prog });
    }

    items.sort((a,b)=>{
      const aPerfect = a.done && a.mis === 0;
      const bPerfect = b.done && b.mis === 0;
      if (aPerfect && bPerfect) return a.timeMs - b.timeMs;
      if (aPerfect) return -1;
      if (bPerfect) return 1;
      if (a.doneCount !== b.doneCount) return b.doneCount - a.doneCount;
      if (a.prog !== b.prog) return b.prog - a.prog;
      if (a.mis !== b.mis) return a.mis - b.mis;
      return a.nm.localeCompare(b.nm);
    });

    const podium = items.filter(it=> it.done && it.mis===0).slice(0,3);
    // ü•àü•âÏóêÍ≤åÎèÑ ÏûëÏùÄ Ï∂ïÌïò(Î∞© Ï†ÑÏ≤¥Ïóê 1ÌöåÎßå)
    for (let i=1;i<Math.min(3, podium.length);i++){
      const by = podium[i].nm;
      try{ await pushEvent_({ type:'event', event:'fx2', kind:'confetti', by, ts: Date.now() }); }catch(e){}
    }
  }catch(e){}
}

function initTypingRace_(roomId){
  try{
    // current
    const curRef = window.FB.ref(window.FB.db, fbRaceCurrentPath_(roomId));
    if (raceCurUnsub_) raceCurUnsub_();
    raceCurUnsub_ = window.FB.onValue(curRef, (snap)=>{
      raceCur_ = snap.exists() ? (snap.val() || null) : null;
      const nid = String(raceCur_?.id || '');
      const nst = String(raceCur_?.status || '');
      // status transition: running -> ended
      try{
        if (racePrevId_ && (racePrevId_ === nid) && racePrevStatus_ === 'running' && nst === 'ended'){
          celebrateRaceEnd_();
        }
      }catch(e){}
      racePrevId_ = nid;
      racePrevStatus_ = nst;
      renderRaceBar_();
    });

    // players
    const plRef = window.FB.ref(window.FB.db, fbRacePlayersPath_(roomId));
    if (racePlayersUnsub_) racePlayersUnsub_();
    racePlayersUnsub_ = window.FB.onValue(plRef, (snap)=>{
      racePlayers_ = snap.exists() ? (snap.val() || {}) : {};
      renderRaceBar_();
    });

    bindRaceInput_();
  }catch(e){
    console.warn('initTypingRace failed', e);
  }
}

function startRaceTimer_(){
  if (raceTick_) return;
  let timeoutSent_ = false;

  raceTick_ = setInterval(()=> {
    const t = $('raceTimer');
    const cur = raceCur_;
    if (!t || !cur || cur.status !== 'running' || !cur.startedAt){
      stopRaceTimer_();
      return;
    }

    const endsAt = Number(cur.endsAt || 0) || (Number(cur.startedAt) + RACE_LIMIT_MS_);
    const remainMs = Math.max(0, endsAt - Date.now());
    const remainSec = remainMs / 1000;

    t.textContent = `${remainSec.toFixed(1)}s`;

    // ‚è±Ô∏è time over ‚Üí winner ÏóÜÏúºÎ©¥ Ï¢ÖÎ£å Ï≤òÎ¶¨(Ìïú Î≤àÎßå)
    if (remainMs <= 0 && !timeoutSent_){
      timeoutSent_ = true;
      (async ()=>{
        try{
          await window.FB.ensureAnonAuth();
          const root = window.FB.ref(window.FB.db, fbRacePath_(sessionId) + '/current');
          await window.FB.runTransaction(root, (cur2)=>{
            if (!cur2) return cur2;
            if (cur2.status !== 'running') return cur2;
            if (cur2.winnerUid) return cur2;
            cur2.status = 'ended';
            cur2.endedReason = 'timeout';
            cur2.endedAt = Date.now();
            return cur2;
          });
          await pushSystem_(`‚è±Ô∏è ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ ÏãúÍ∞Ñ Ï¢ÖÎ£å! (120Ï¥à) ‚Äî Ïù¥Î≤à ÌåêÏùÄ Ïö∞ÏäπÏûêÍ∞Ä ÏóÜÏñ¥Ïöî.`);
        }catch(e){}
      })();
    }
  }, 120);
}
function stopRaceTimer_(){
  try{ if (raceTick_) clearInterval(raceTick_); }catch(e){}
  raceTick_ = null;
}

function bindRaceInput_(){
  const el = $('raceInput');
  if (!el || el.__raceBound) return;
  el.__raceBound = true;

  el.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      submitRaceLine_();
    }
  });

  el.addEventListener('input', ()=> onRaceInput_());
}

async function submitRaceLine_(){
  if (!sessionId || !raceCur_ || raceCur_.status !== 'running') return;
  const el = $('raceInput');
  if (!el) return;

  const cur = raceCur_;
  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];

  const uid = myUid_();
  if (!uid) return;

  const me = (racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;
  const myMis = Number(me.mistakes || 0) || 0;

  const idx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[idx] || '');
  const typed = String(el.value || '');

  // ‚úÖ ÎπÑÍµê Ïãú Ïù¥Î™®ÏßÄ(ÌóàÏö© Ï†úÏô∏) ÏûêÎèô Î¨¥Ïãú
  const targetN = raceNormalize_(target);
  const typedN  = raceNormalize_(typed);

  // Require exact match on submit (normalized)
  if (typedN !== targetN){
    try{
      el.classList.add('shake');
      setTimeout(()=> el.classList.remove('shake'), 320);
    }catch(e){}

    try{
      await window.FB.ensureAnonAuth();
      const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
      const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';
      await window.FB.runTransaction(pRef, (p)=>{
        p = p || {};
        const mis = Number(p.mistakes||0) + 1;
        return Object.assign({}, p, {
          name: nm,
          idx: Number(p.idx||0),
          doneCount: Number(p.doneCount||0),
          p: Number(p.p||0),
          mistakes: mis,
          done: !!p.done,
          ts: Date.now()
        });
      });
    }catch(e){}
    return;
  }

  // Correct: advance sentence
  const nextDone = idx + 1;
  const now = Date.now();
  const doneAll = nextDone >= total;
  const timeMs = Math.max(0, now - Number(cur.startedAt || now));

  try{
    await window.FB.ensureAnonAuth();
    const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
    const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';

    await window.FB.runTransaction(pRef, (p)=>{
      p = p || {};
      const mis = Number(p.mistakes||0);
      return Object.assign({}, p, {
        name: nm,
        idx: nextDone,
        doneCount: nextDone,
        p: 0,
        mistakes: mis,
        done: doneAll,
        finishedAt: doneAll ? now : (p.finishedAt||0),
        timeMs: doneAll ? timeMs : (p.timeMs||0),
        ts: now
      });
    });

    el.value = '';
    raceLastProg_ = -1;
    const progEl = $('raceProgBar');
    if (progEl) progEl.style.width = '0%';

    if (doneAll){
      if (myMis === 0){
        await trySetWinner_(uid, nm, timeMs);
      }else{
        await pushSystem_(`üèÅ ${nm}Îãò ÏôÑÏ£º! (10Î¨∏Ïû•, Ïã§Ïàò ${myMis}Ìöå, ${(timeMs/1000).toFixed(2)}s)`);
      }
    }
  }catch(e){}
}


async function raceEliminate_(reason){
  try{
    if (!raceCur_ || !raceCur_.id) return;
    raceMeElim_ = true;

    const inp = $('raceInput');
    if (inp){
      inp.disabled = true;
      inp.classList.add('eliminated');
    }
    const bar = $('raceBar');
    if (bar){
      bar.classList.add('eliminated');
      setTimeout(()=>{ try{ bar.classList.remove('eliminated'); }catch(e){} }, 360);
    }

    // ÎÇ¥ ÏÉÅÌÉú Í≥µÏú†(Îã§Î•∏ ÏÇ¨Îûå Ìä∏Îûô/ÏàúÏúÑ ÌëúÏãúÏö©)
    try{
      const uid = myUid_();
      if (uid){
        const pRef = window.FB.ref(window.FB.db, fbRacePlayerPath_(sessionId, raceCur_.id, uid));
        await window.FB.update(pRef, { eliminated:true, elimReason:String(reason||'typo'), elimAt: Date.now() });
      }
    }catch(e){}

    // Î°úÏª¨ ÏïàÎÇ¥(Î∞© Ï†ÑÏ≤¥ Ïä§Ìå∏ Î∞©ÏßÄ)
    try{
      const box = $('raceScore');
      if (box) box.textContent = 'üö´ Ïò§ÌÉÄ! ÌÉàÎùΩ(ÏûÖÎ†• Ïû†Í∏à)';
    }catch(e){}
  }catch(e){}
}

async function onRaceInput_(){
  if (!sessionId || !raceCur_ || raceCur_.status !== 'running') return;
  const el = $('raceInput');
  if (!el) return;

  const cur = raceCur_;
  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];

  const uid = myUid_();
  const me = (uid && racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;

  const idx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[idx] || '');
  const typed = String(el.value || '');

  const prog = racePrefixLen_(raceNormalize_(target), raceNormalize_(typed));
  const pct = target.length ? Math.floor((prog / target.length) * 100) : 0;
  const progEl = $('raceProgBar');
  if (progEl) progEl.style.width = `${Math.max(0, Math.min(100, pct))}%`;

  try{ updateRaceDiffView_(target, typed); }catch(e){}

  // throttle + only when changed
  const now = Date.now();
  if (prog === raceLastProg_ && (now - raceLastSentAt_) < 900) return;
  if ((now - raceLastSentAt_) < 220) return;

  raceLastSentAt_ = now;
  raceLastProg_ = prog;

  if (!uid) return;
  try{
    await window.FB.ensureAnonAuth();
    const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
    const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';
    await window.FB.update(pRef, { name: nm, idx: idx, doneCount: myDone, p: prog, done: false, ts: now });
  }catch(e){}
}

async function trySetWinner_(uid, name, timeMs){
  try{
    const curRef = window.FB.ref(window.FB.db, fbRaceCurrentPath_(sessionId));
    const res = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur || cur.status !== 'running') return cur;
      if (cur.winnerUid) return cur;
      return Object.assign({}, cur, {
        status: 'ended',
        endedAt: Date.now(),
        winnerUid: uid,
        winnerName: String(name || '').slice(0,12),
        winnerTimeMs: Number(timeMs || 0)
      });
    });

    if (res && res.committed){
      const sec = (Number(timeMs||0)/1000).toFixed(2);
      await pushSystem_(`üèÜ ${String(name||'').slice(0,12)}ÎãòÏù¥ ‚å®Ô∏è ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ Ïö∞Ïäπ! (Î¨¥Ïã§Ïàò 10Î¨∏Ïû•, ${sec}s)`);
      // "ÏóÑÏ≤≠ ÌôîÎ†§ÌïòÍ≤å" = fireworks + sparkles + boomup
      await pushEvent_({ type:'event', event:'fireworks', kind:'race', by:String(name||'').slice(0,12), ts: Date.now() });
      await pushEvent_({ type:'event', event:'fx', name:'sparkle', by:String(name||'').slice(0,12), ts: Date.now() });
      await pushEvent_({ type:'event', event:'fx', name:'boomup', by:String(name||'').slice(0,12), ts: Date.now() });
    }
  }catch(e){}
}

async function startRace_(diff){
  if (!sessionId) return;
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  try{ localStorage.setItem(RACE_LS_DIFF_, d); }catch(e){}
  try{ raceMeElim_ = false; }catch(e){}
  try{ const inp=$('raceInput'); if(inp){ inp.disabled=false; inp.classList.remove('eliminated'); } }catch(e){}

  const texts = buildRaceSet_(d, 10, `SET:${Date.now()}`);
  if (!texts || !texts.length) return;

  const cur = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
    status: 'running',
    difficulty: d,
    texts: texts,
    idx: 0,
    total: 10,
    startedAt: Date.now(),
    endsAt: Date.now() + RACE_LIMIT_MS_,
    limitMs: RACE_LIMIT_MS_,
    startedBy: myName().slice(0,12),
    winnerUid: '',
    winnerName: '',
    winnerTimeMs: 0
  };

  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbRacePath_(sessionId));
    await window.FB.set(root, { current: cur, players: {} });

    

    // ‚úÖ PATCH: immediately reflect running state locally so input enables right away
    acidCur_ = cur;
    acidPlayers_ = acidPlayers_ || {};
    try{
      const uid = myUid_();
      if (uid){
        acidPlayers_[uid] = acidPlayers_[uid] || { name: myName().slice(0,12) || 'ÏùµÎ™Ö', score: 0, ts: Date.now() };
      }
    }catch(e){}
await pushSystem_(`üèÅ ‚å®Ô∏è ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! (ÎÇúÏù¥ÎèÑ: ${raceDiffLabel_(d)}) ‚Äî <Î¨¥Ïã§Ïàò 10Î¨∏Ïû•> Ïö∞Ïäπ! ‚è±Ô∏è 120Ï¥à Ï†úÌïú (Ïù¥Î™®ÏßÄ ÏûêÎèô Î¨¥Ïãú / Í∏∞Ìò∏Îäî Í∑∏ÎåÄÎ°ú)`);
  }catch(e){
    showOverlay('Ïò§Î•ò', 'Î†àÏù¥Ïä§Î•º ÏãúÏûëÌï† Ïàò ÏóÜÏñ¥Ïöî. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
  }
}

function openRaceStart_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const last = (localStorage.getItem(RACE_LS_DIFF_) || 'low');
  const strictOn = loadRaceStrict_();

  // ‚úÖ compact UI (no inner scroll) ‚Äî difficulty buttons on top
  const html = `
    <div class="raceStartWrap compact">
      <div class="raceStartTopRow" style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:8px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button class="raceDiffPill" type="button" data-diff="low"  aria-label="ÎÇúÏù¥ÎèÑ Ìïò">Ìïò</button>
          <button class="raceDiffPill" type="button" data-diff="mid"  aria-label="ÎÇúÏù¥ÎèÑ Ï§ë">Ï§ë</button>
          <button class="raceDiffPill" type="button" data-diff="high" aria-label="ÎÇúÏù¥ÎèÑ ÏÉÅ">ÏÉÅ</button>
          <span class="metaPill" style="padding:6px 10px;">ÏµúÍ∑º: ${raceDiffLabel_(last)}</span>
        </div>
        <button class="raceStrictBtn ${strictOn ? '' : 'off'}" type="button" data-action="raceStrictToggle">
          ${strictOn ? '‚úÖ Ïò§ÌÉÄ 1Î≤à=ÌÉàÎùΩ: ON' : '‚òëÔ∏è Ïò§ÌÉÄ 1Î≤à=ÌÉàÎùΩ: OFF'}
        </button>
      </div>

      <div class="raceStartHero" style="margin-bottom:0;">
        <div class="raceStartHeroInner">
          <div class="raceHeroBadge">üèÅ 10Î¨∏Ïû• Ïä§ÌîÑÎ¶∞Ìä∏</div>
          <div class="raceHeroTrack">
            <div class="trackLane">
              <div class="trackCars">üèéÔ∏èüí® üöóüí® üöôüí® üõµüí®</div>
              <div style="margin-left:auto; font-weight:950;">FINISH üèÅ</div>
            </div>
            <div class="trackMeta">
              <span class="metaPill">Enter=Ï†úÏ∂ú</span>
              <span class="metaPill">Ïò§ÌÉÄ=Ï¶âÏãú Ïã§Ìå®</span>
              <span class="metaPill">120Ï¥à Ï†úÌïú</span>
              <span class="metaPill">1Îì±: Ìè≠Ï£Ω+Î∞òÏßù‚ú®</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  showOverlayHtml('‚å®Ô∏è ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ üèÅ', html, false);
}

window.openRaceStart_ = openRaceStart_;
window.raceStartWith_ = function(diff){
  try{ hideOverlay(); }catch(e){}
  startRace_(diff);
};



// =====================
// ‚òî Mini game: Acid Rain (ÏÇ∞ÏÑ±ÎπÑ) ‚Äî 120Ï¥à
// - ÎàÑÍ∞Ä ÏãúÏûëÌïòÎ©¥, Í∞ôÏùÄ ÏÑ∏ÏÖò(room)ÏóêÏÑú "seed/startedAt"ÏùÑ Í≥µÏú†Ìï©ÎãàÎã§.
// - Îã®Ïñ¥ ÎÇôÌïòÎäî Í∞Å ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä ÎèôÏùºÌïú seedÎ°ú 'Í≤∞Ï†ïÎ°†Ï†Å'ÏúºÎ°ú ÏÉùÏÑ±(ÎèôÍ∏∞Ìôî Ïâ¨ÏõÄ).
// - Ï†êÏàòÎäî Í∞ÅÏûê players/{uid}.score Î°úÎßå Ïò¨Î¶ΩÎãàÎã§(Îã®Ïñ¥Îäî Í≥µÏö© Ï†úÍ±∞ X).
// =====================
let acidCur_ = null;
let acidPlayers_ = {};
let acidCurUnsub_ = null;
let acidPlayersUnsub_ = null;

let acidUi_ = { open:false, raf: null, lastNow:0, schedule: [], active: new Map(), misses:0, hits:0 };
const ACID_LIMIT_MS_ = 120000;
const ACID_SPAWN_MS_ = 900;
const ACID_FALL_MS_  = 13000;
const ACID_MAX_ACTIVE_ = 15;
const ACID_FALL_MIN_MS_ = 5200;
const ACID_FALL_MAX_MS_ = 9000;
const ACID_EVENT_PROB_ = 0.12; // ÌôïÎ•†
const ACID_EVENT_POINTS_ = 3;
const ACID_EVENT_FALL_MIN_MS_ = 2600;
const ACID_EVENT_FALL_MAX_MS_ = 4200;
const ACID_POOL_ = [
  'ÏÇ¨Îûë','Í≥†Î∞±','ÌõÑÌöå','Íµ¨Ïõê','Ïπ®Î¨µ','Î∂àÍΩÉ','Í∑∏Î¶ºÏûê','Îπõ','Îã¨','ÎπÑ','ÏÉàÎ≤Ω','Í≥†Ïöî',
  'ÌÉë','Î¨∏','Ïó¥Ïá†','ÎπÑÎ∞Ä','Í≥ÑÏïΩ','Í∞ÅÏù∏','ÎßùÍ∞Å','ÌôòÏÉÅ','ÏßÑÏã§','Ïö¥Î™Ö','Ïã¨Ïû•','Ïà®',
  'ÌååÎèÑ','Ïà≤','Î∞§','Íøà','ÏÉÅÏ≤ò','ÏÜêÎÅù','Ïò®Í∏∞','Ï†àÎßù','Ìù¨Îßù','Ïò§Ìï¥','ÏïΩÏÜç','Í±∞Î¶¨',
  'Í∞ÄÎ©¥','Ï¥àÎåÄ','ÎèÑÎßù','Ï∂îÍ≤©','ÎØ∏ÏÜå','ÎààÎ¨º','Ìè≠Ìíç','Í≤Ä','ÎßàÎ≤ï','Ï†ÄÏ£º','Í∏∞ÎèÑ','ÏÑ±Ï¢å',
  'ÏïÑÏù¥Îèå','Î¨¥ÎåÄ','Ïó∞Ïäµ','Îç∞Î∑î','Ïπ¥Î©îÎùº','Ïª∑','Ïî¨','Ìé∏Ïßë','ÏÑúÏÇ¨','ÌÅ¥Î¶¨ÏÖ∞','Î∞òÏ†Ñ'
];
const ACID_BONUS_POOL_ = [
  '‚ú®Î≥¥ÎÑàÏä§','‚ö°Ïä§ÌîºÎìú','üíéÏû≠Ìåü','üî•ÏΩ§Î≥¥','üåüÏù¥Î≤§Ìä∏','üéØÏ†ïÎãµ','üß™ÏÇ∞ÏÑ±','‚òîÌè≠Ïö∞'
];


function fbAcidPlayerPath_(roomId, uid){ return `${fbAcidPlayersPath_(roomId)}/${uid}`; }

const mulberry32_acid_ = (a)=>{
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
};

function buildAcidSchedule_(cur){
  try{
    const startedAt = Number(cur.startedAt||0) || Date.now();
    const seed = Number(cur.seed||0) || (startedAt % 2147483647);
    const rng = mulberry32_acid_(seed >>> 0);

    const duration = Number(cur.limitMs||0) || ACID_LIMIT_MS_;
    const spawnMs = Number(cur.spawnMs||0) || ACID_SPAWN_MS_;

    const total = Math.ceil(duration / spawnMs) + 6;
    const arr = [];
    for (let i=0;i<total;i++){
      const w = ACID_POOL_[Math.floor(rng()*ACID_POOL_.length)] || 'Îã®Ïñ¥';
      const x = 6 + Math.floor(rng()*84); // 6~90%
      const spawnAt = startedAt + i*spawnMs;
      arr.push({ id: i, w, xPct: x, spawnAt });
    }
    return arr;
  }catch(e){
    return [];
  }
}

function initAcidRain_(roomId){
  try{
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(roomId));
    if (acidCurUnsub_) acidCurUnsub_();
    acidCurUnsub_ = window.FB.onValue(curRef, (snap)=>{
      acidCur_ = snap.exists() ? (snap.val() || null) : null;

      // Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÎ©¥ Ïä§ÏºÄÏ§Ñ Ïû¨Íµ¨Ï∂ï
      try{
        if (acidCur_ && acidCur_.status === 'running'){
          // (wave-based) no fixed schedule needed
          acidUi_.schedule = null;
          }
      }catch(e){}

      // Ïò§Î≤ÑÎ†àÏù¥Í∞Ä Ïó¥Î†§ÏûàÏúºÎ©¥ UI Í∞±Ïã†
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('ÏÇ∞ÏÑ±ÎπÑ')) acidRender_();
      }catch(e){}
    });

    const plRef = window.FB.ref(window.FB.db, fbAcidPlayersPath_(roomId));
    if (acidPlayersUnsub_) acidPlayersUnsub_();
    acidPlayersUnsub_ = window.FB.onValue(plRef, (snap)=>{
      acidPlayers_ = snap.exists() ? (snap.val() || {}) : {};
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('ÏÇ∞ÏÑ±ÎπÑ')) acidRender_();
      }catch(e){}
    });
  }catch(e){
    console.warn('initAcidRain failed', e);
  }
}

function openAcidStart_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const running = !!(acidCur_ && acidCur_.status === 'running');
  const btn = running
    ? `<button class="bigPlayBtn" type="button" data-action="acidOpen">‚òî ÏÇ∞ÏÑ±ÎπÑ Ïó¥Í∏∞</button>`
    : `<button class="bigPlayBtn" type="button" data-action="acidStart">‚òî ÏÇ∞ÏÑ±ÎπÑ ÏãúÏûë (120Ï¥à)</button>`;

  // ‚úÖ compact UI (no inner scroll) ‚Äî start button on top, keep only the background hero layer
  const html = `
    <div class="acidWrap compact">
      <div style="display:flex; justify-content:flex-start; margin-bottom:8px;">
        ${btn}
      </div>

      <div class="raceStartHero" style="margin-bottom:0;">
        <div class="raceStartHeroInner">
          <div class="raceHeroBadge">‚òî Îã®Ïñ¥Í∞Ä ÎπÑÏ≤òÎüº Îñ®Ïñ¥ÏßÑÎã§</div>
          <div class="raceHeroTrack">
            <div class="trackLane">
              <div class="trackCars">‚òî‚òî‚òî  ‚å®Ô∏è  ‚òî‚òî‚òî</div>
              <div style="margin-left:auto; font-weight:950;">SCORE üéØ</div>
            </div>
            <div class="trackMeta">
              <span class="metaPill">Enter/Space=Ï†úÏ∂ú</span>
              <span class="metaPill">120Ï¥à Ï†úÌïú</span>
              <span class="metaPill">ÏôÑÎ≤Ω ÏûÖÎ†•=+1</span>
              <span class="metaPill">Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  showOverlayHtml('‚òî ÏÇ∞ÏÑ±ÎπÑ', html, false);
}

function openAcidGame_(){
  acidRender_();
  // ‚úÖ PATCH: focus input so typing works immediately
  try{ setTimeout(()=>{ document.getElementById('acidInput')?.focus(); }, 60); }catch(e){}
}

function acidRender_(){
  const cur = acidCur_;
  const meUid = myUid_();
  const me = (meUid && acidPlayers_ && acidPlayers_[meUid]) ? (acidPlayers_[meUid]||{}) : {};
  const myScore = Number(me.score||0) || 0;

  const now = Date.now();
  const running = !!(cur && cur.status === 'running');
  const startedAt = Number(cur?.startedAt||0) || now;
  const endsAt = Number(cur?.endsAt||0) || (startedAt + ACID_LIMIT_MS_);
  const remainMs = Math.max(0, endsAt - now);

  // ‚úÖ When the game is running and overlay is already open,
  // update only small UI parts (do NOT rebuild overlay ‚Üí prevents words from disappearing)
  try{
    const title = String($('ovTitle')?.textContent || '');
    const stage = document.getElementById('acidStage');
    if (running && stage && title.includes('ÏÇ∞ÏÑ±ÎπÑ')){
      const remainEl = document.getElementById('acidRemain');
      const myEl = document.getElementById('acidMyScore');
      const hmEl = document.getElementById('acidHM');
      const board = document.getElementById('acidBoard');
      const inp = document.getElementById('acidInput');

      if (remainEl) remainEl.textContent = `${(remainMs/1000).toFixed(1)}s`;
      if (myEl) myEl.textContent = String(myScore);
      if (hmEl) hmEl.textContent = `${acidUi_.hits}/${acidUi_.misses}`;
      if (board) board.innerHTML = acidRankHtml_();
      if (inp) inp.disabled = false;

      // keep loop alive
      acidStartLoop_();
      return;
    }
  }catch(e){}

  const rankHtml = acidRankHtml_();

  const html = `
    <div class="acidWrap">
      <div class="acidTop">
        <span class="pill">ÏÉÅÌÉú: <b>${running ? 'ÏßÑÌñâ Ï§ë' : (cur ? 'Ï¢ÖÎ£å' : 'ÎåÄÍ∏∞')}</b></span>
        <span class="pill">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: <b id="acidRemain">${(remainMs/1000).toFixed(1)}s</b></span>
        <span class="pill">ÎÇ¥ Ï†êÏàò: <b id="acidMyScore">${myScore}</b></span>
        <span class="pill">ÎÇ¥ ÌûàÌä∏/ÎØ∏Ïä§: <b id="acidHM">${acidUi_.hits}/${acidUi_.misses}</b></span>
        ${running ? '' : `<button class="bigPlayBtn" type="button" data-action="acidStart">‚òî ÏÉà Í≤åÏûÑ ÏãúÏûë</button>`}
      </div>

      <div class="acidStage" id="acidStage" aria-label="ÏÇ∞ÏÑ±ÎπÑ Ïä§ÌÖåÏù¥ÏßÄ"></div>

      <div class="acidHud">
        <div class="acidInputRow" style="flex: 1 1 340px;">
          <input id="acidInput" placeholder="Îã®Ïñ¥ ÏûÖÎ†• ÌõÑ Enter/Space" ${running ? '' : 'disabled'} />
          <button id="acidClear" type="button">ÏßÄÏö∞Í∏∞</button>
        </div>
        <div class="acidBoard">
          <div style="font-weight: 1000; margin-bottom:6px;">üèÜ ÏàúÏúÑ</div>
          <div id="acidBoard">${rankHtml}</div>
        </div>
      </div>

      <div class="acidMiniNote">ÌåÅ: Ïò§Î≤ÑÎ†àÏù¥ ÌÅ¨Í∏∞Î•º ÌÇ§Ïö∞Î©¥ Îã®Ïñ¥Í∞Ä Îçî Ïûò Î≥¥Ïó¨Ïöî üëÄ</div>
    </div>
  `;
  showOverlayHtml('‚òî ÏÇ∞ÏÑ±ÎπÑ', html, false);

  // bind UI
  try{ acidBindUi_(); }catch(e){}
  // start loop if running
  if (running) acidStartLoop_(); else acidStopLoop_();
}

function acidRankHtml_(){
  try{
    const items = [];
    for (const uid of Object.keys(acidPlayers_||{})){
      const p = acidPlayers_[uid] || {};
      items.push({
        nm: String(p.name||'ÏùµÎ™Ö').slice(0,12),
        score: Number(p.score||0) || 0,
        ts: Number(p.ts||0) || 0
      });
    }
    items.sort((a,b)=> (b.score - a.score) || (b.ts - a.ts) || a.nm.localeCompare(b.nm));
    const top = items.slice(0, 12);
    if (!top.length) return `<div class="line"><span>‚Äî</span><span>0</span></div>`;
    return top.map((it, i)=> `<div class="line"><span>${i+1}. ${escapeHtml(it.nm)}</span><span>${it.score}</span></div>`).join('');
  }catch(e){
    return `<div class="line"><span>‚Äî</span><span>0</span></div>`;
  }
}

function acidBindUi_(){
  const inp = document.getElementById('acidInput');
  const clear = document.getElementById('acidClear');
  const stage = document.getElementById('acidStage');
  if (!stage) return;

  // idempotent bind
  if (stage.__acidBound) return;
  stage.__acidBound = true;

  if (clear){
    clear.addEventListener('click', (e)=>{
      try{ e.preventDefault(); }catch(err){}
      if (inp) inp.value = '';
      try{ inp?.focus(); }catch(err){}
    }, false);
  }

  if (inp){
    // IME composition guard (Korean typing etc.)
    inp.__acidComposing = false;
    inp.addEventListener('compositionstart', ()=>{ inp.__acidComposing = true; }, false);
    inp.addEventListener('compositionend', ()=>{ inp.__acidComposing = false; }, false);

    inp.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        acidSubmit_();
      }
    }, false);

    // ‚úÖ Auto-clear on typo: if current input is not a prefix of any live word, wipe it + apply penalty
    inp.addEventListener('input', (e)=>{
      try{
        if (inp.__acidComposing) return;
        const cur = acidCur_;
        if (!cur || cur.status !== 'running') return;
        const vRaw = String(inp.value||'').trim();
        if (!vRaw) return;

        const v = acidNormAcid_(vRaw);
        if (!v) return;

        let okPrefix = false;
        acidUi_.active.forEach((it, id)=>{
          if (okPrefix) return;
          if (!it || it.state !== 'live') return;
          const tw = acidNormAcid_(String(it.w||''));
          if (!tw) return;
          if (tw.startsWith(v)) okPrefix = true;
        });

        if (!okPrefix){
          // typo -> clear and penalty
          inp.value = '';
          acidUi_.misses++;
          try{ inp.classList.add('shake'); setTimeout(()=> inp.classList.remove('shake'), 260); }catch(err){}
          // score penalty (clamped at >=0)
          acidIncScore_(-1);
        }
      }catch(err){}
    }, false);
  }

  // focus
  try{ setTimeout(()=>{ try{ inp?.focus(); }catch(e){} }, 0); }catch(e){}
}


function acidStartLoop_(){
  if (acidUi_.raf) return;
  acidUi_.open = true;
  acidUi_.active = new Map();
  acidUi_.lastNow = 0;
  acidUi_.waveId = 0;
  acidUi_.schedKey = '';
  acidUi_.nextEventAt = 0;

  const spawnWave_ = (stage, cur, now)=>{
    const baseFall = (Number(cur.fallMs||0) || ACID_FALL_MS_) * 2;
    const maxN = ACID_MAX_ACTIVE_;
    const n = Math.max(6, Math.min(maxN, 10 + Math.floor(Math.random()*6))); // 10~15 (min 6)
    // x positions with overlap avoidance
    const xs = [];
    const minGap = 6; // percent
    for (let i=0;i<n;i++){
      let tries = 0;
      while (tries++ < 60){
        const x = 6 + Math.floor(Math.random()*84); // 6~90
        if (xs.every(v=> Math.abs(v-x) >= minGap)){ xs.push(x); break; }
      }
      if (xs.length < i+1) xs.push(6 + Math.floor(Math.random()*84));
    }
    xs.sort((a,b)=>a-b);

    acidUi_.waveId = (acidUi_.waveId||0) + 1;
    for (let i=0;i<n;i++){
      if (acidUi_.active.size >= maxN) break;
      const w = ACID_POOL_[Math.floor(Math.random()*ACID_POOL_.length)] || 'Îã®Ïñ¥';
      const fallMs = Math.max(2600, Math.round(baseFall * (0.75 + Math.random()*0.95))); // ÎäêÎ¶º~Îπ†Î¶Ñ
      const id = `w${acidUi_.waveId}_${i}_${now}`;
      const it = { id, w, xPct: xs[i], spawnAt: now, fallMs, points: 1, isEvent:false, state:'live' };
      acidUi_.active.set(id, it);
      acidAddWordEl_(stage, id, it.w, it.xPct, it.points, it.isEvent);
    }
  };

  const spawnEvent_ = (stage, cur, now)=>{
    if (acidUi_.active.size >= ACID_MAX_ACTIVE_) return;
    // Ïù¥Î≤§Ìä∏ Îã®Ïñ¥Îäî Ï†ÑÏ≤¥ ÏÜçÎèÑ(2Î∞∞ ÎäêÎ¶º) ÏòÅÌñ•ÏùÑ Î∞õÏßÄ ÏïäÍ≤å ÏõêÎûò Ï≤¥Í∞ê ÏÜçÎèÑÎ°ú
    const baseFall = (Number(cur.fallMs||0) || ACID_FALL_MS_);
    const w = ACID_BONUS_POOL_[Math.floor(Math.random()*ACID_BONUS_POOL_.length)] || 'BONUS';
    const x = 8 + Math.floor(Math.random()*80);
    const fallMs = Math.max(1600, Math.round(baseFall * (0.40 + Math.random()*0.20))); // Îπ†Î•¥Í≤å
    const points = 3;
    const id = `e_${now}_${Math.floor(Math.random()*9999)}`;
    const it = { id, w, xPct:x, spawnAt: now, fallMs, points, isEvent:true, state:'live' };
    acidUi_.active.set(id, it);
    acidAddWordEl_(stage, id, it.w, it.xPct, it.points, it.isEvent);
  };

  const scheduleNextEvent_ = (now)=>{
    // 6~12Ï¥à Í∞ÑÍ≤©ÏúºÎ°ú Ïù¥Î≤§Ìä∏ Îã®Ïñ¥ Îì±Ïû•
    const gap = 6000 + Math.floor(Math.random()*6000);
    acidUi_.nextEventAt = now + gap;
  };

  const tick = ()=>{
    if (!acidUi_.open) { acidStopLoop_(); return; }
    const cur = acidCur_;
    const stage = document.getElementById('acidStage');
    const remainEl = document.getElementById('acidRemain');
    const hmEl = document.getElementById('acidHM');
    if (!cur || cur.status !== 'running' || !stage){
      acidStopLoop_();
      return;
    }

    const now = Date.now();
    const startedAt = Number(cur.startedAt||0) || now;
    const endsAt = Number(cur.endsAt||0) || (startedAt + ACID_LIMIT_MS_);
    const remainMs = Math.max(0, endsAt - now);

    // new game session -> reset local stage and spawn immediately
    const curKey = String(cur.id||'');
    if (acidUi_.schedKey !== curKey){
      acidUi_.schedKey = curKey;
      acidUi_.active = new Map();
      try{ stage.innerHTML = ''; }catch(e){}
      acidUi_.hits = 0; acidUi_.misses = 0;
      acidUi_.waveId = 0;
      acidUi_.nextEventAt = 0;
      // Ï¶âÏãú Ï≤´ Ïõ®Ïù¥Î∏å ÏÉùÏÑ±(Í≤åÏûÑ ÏãúÏûëÌïòÏûêÎßàÏûê Îã®Ïñ¥ ÎÇ¥Î†§Ïò§Í∏∞)
      spawnWave_(stage, cur, now);
      // Ïù¥Î≤§Ìä∏ Îã®Ïñ¥Îäî 4~8Ï¥à ÌõÑ Ï≤´ Îì±Ïû•
      acidUi_.nextEventAt = now + (4000 + Math.floor(Math.random()*4000));
    }

    if (remainEl) remainEl.textContent = `${(remainMs/1000).toFixed(1)}s`;
    if (hmEl) hmEl.textContent = `${acidUi_.hits}/${acidUi_.misses}`;

    // Ïù¥Î≤§Ìä∏ Îã®Ïñ¥: ÏßÑÌñâ Ï§ë Ï§ëÍ∞ÑÏ§ëÍ∞Ñ Îπ†Î•¥Í≤å Îì±Ïû•
    if (acidUi_.nextEventAt && now >= acidUi_.nextEventAt){
      spawnEvent_(stage, cur, now);
      scheduleNextEvent_(now);
    }

    // Ìè¨ÏßÄÏÖò ÏóÖÎç∞Ïù¥Ìä∏ + ÎØ∏Ïä§ Ï≤òÎ¶¨ (px Í∏∞Î∞ò)
    const stageH = Math.max(1, stage.clientHeight || 340);
    acidUi_.active.forEach((it, id)=>{
      const el = stage.querySelector?.(`.acidWord[data-id="${id}"]`);
      if (!el) return;
      const age = now - it.spawnAt;
      const fallMsIt = Number(it.fallMs||0) || Number(cur.fallMs||0) || ACID_FALL_MS_;
      const travel = stageH + 80; // top(-30)~bottom(+50)
      const yPx = (age / fallMsIt) * travel;
      el.style.transform = `translate(-50%, ${yPx}px)`;
      if (yPx >= (stageH + 50) && it.state === 'live'){
        it.state = 'miss';
        acidUi_.misses++;
        try{ el.classList.add('miss'); }catch(e){}
        setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 350);
        acidUi_.active.delete(id);
      }
    });

    // Ïõ®Ïù¥Î∏å Í∑úÏπô: ÌôîÎ©¥(Ïä§ÌÖåÏù¥ÏßÄ)Ïóê Î≥¥Ïù¥Îäî Îã®Ïñ¥Í∞Ä Ï†ÑÎ∂Ä ÏÇ¨ÎùºÏßÄÎ©¥(=Ï†ÑÎ∂Ä ÌÅ¥Î¶¨Ïñ¥/ÎØ∏Ïä§) Îã§Ïùå Ïõ®Ïù¥Î∏å
    if (acidUi_.active.size === 0 && remainMs > 0){
      spawnWave_(stage, cur, now);
    }

    // time over ‚Üí end
    if (remainMs <= 0){
      acidTryEnd_();
    }

    acidUi_.raf = requestAnimationFrame(tick);
  };

  acidUi_.raf = requestAnimationFrame(tick);
}


function acidStopLoop_(){
  acidUi_.open = false;
  try{ if (acidUi_.raf) cancelAnimationFrame(acidUi_.raf); }catch(e){}
  acidUi_.raf = null;
  // do not wipe scores; only stage nodes cleanup
  try{
    const stage = document.getElementById('acidStage');
    if (stage) stage.innerHTML = '';
  }catch(e){}
  try{ acidUi_.active = new Map(); }catch(e){}
}

function acidAddWordEl_(stage, id, word, xPct, points, isEvent){
  try{
    const el = document.createElement('div');
    const pt = Number(points||1)||1;
    const ev = !!isEvent;
    el.className = 'acidWord' + ((pt>1) ? ' bonus' : '') + (ev ? ' event' : '');
    el.setAttribute('data-pt', String(Number(points||1)||1));
    el.setAttribute('data-id', String(id));
    el.setAttribute('data-word', String(word));
    el.textContent = word;
    el.style.left = `${xPct}%`;
    el.style.transform = 'translate(-50%, 0%)';
    stage.appendChild(el);
  }catch(e){}
}

function acidNormAcid_(s){
  // Normalize for matching: allow users to type without leading emoji/symbols
  const str = String(s||'').trim();
  // remove leading non word (keep Hangul/Latin/number)
  const cleaned = str.replace(/^[^0-9A-Za-zÍ∞Ä-Ìû£]+/g,'').trim();
  return cleaned;
}

function acidSubmit_(){
  try{
    const cur = acidCur_;
    if (!cur || cur.status !== 'running') return;
    const inp = document.getElementById('acidInput');
    const stage = document.getElementById('acidStage');
    if (!inp || !stage) return;

    const raw = String(inp.value || '').trim();
    if (!raw) return;

    // find matching live word (closest to bottom for fairness)
    let matchId = null;
    let bestY = -1;
    acidUi_.active.forEach((it, id)=>{
      if (!it || it.state !== 'live') return;
      const w0 = String(it.w||'');
      if (w0 !== raw && acidNormAcid_(w0) !== acidNormAcid_(raw)) return;
      const now = Date.now();
      const fallMsIt = Number(it.fallMs||0) || Number(cur.fallMs||0) || ACID_FALL_MS_;
      const age = now - it.spawnAt;
      const y = (age / fallMsIt) * 100;
      if (y > bestY){
        bestY = y;
        matchId = id;
      }
    });

    if (matchId == null){
      // miss input feedback + auto-clear + penalty
      try{ inp.classList.add('shake'); setTimeout(()=> inp.classList.remove('shake'), 260); }catch(e){}
      try{ inp.value = ''; }catch(e){}
      acidUi_.misses++;
      // score penalty (clamped >=0)
      acidIncScore_(-1);
      return;
    }

    // remove local word + score++
    const it = acidUi_.active.get(matchId);
    const pts = Number(it?.points||1) || 1;

    if (it) it.state = 'hit';
    acidUi_.hits++;
    try{
      const el = stage.querySelector?.(`.acidWord[data-id="${matchId}"]`);
      if (el) el.remove();
    }catch(e){}
    acidUi_.active.delete(matchId);

    inp.value = '';

    // update my score in firebase
    acidIncScore_(pts);
  }catch(e){}
}

async function acidIncScore_(delta){
  try{
    await window.FB.ensureAnonAuth();
    const uid = myUid_();
    if (!uid) return;

    const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';
    const pRef = window.FB.ref(window.FB.db, fbAcidPlayerPath_(sessionId, uid));

    const dd = Math.round(Number(delta||0) || 0);
    if (!dd) return;

    await window.FB.runTransaction(pRef, (p)=>{
      p = p || {};
      const score0 = Number(p.score||0) || 0;
      const score = Math.max(0, score0 + dd);
      return Object.assign({}, p, { name: nm, score, ts: Date.now() });
    });

    // reflect quickly in UI (optimistic)
    try{
      const el = document.getElementById('acidMyScore');
      if (el){
        const me = acidPlayers_ && acidPlayers_[uid] ? (acidPlayers_[uid]||{}) : {};
        const score0 = Number(me.score||0) || 0;
        const sc = Math.max(0, score0 + dd);
        el.textContent = String(sc);
      }
    }catch(e){}
  }catch(e){}
}

async function acidTryEnd_(){
  try{
    await window.FB.ensureAnonAuth();
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(sessionId));
    const res = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur) return cur;
      if (cur.status !== 'running') return cur;
      // ensure time really over
      const endsAt = Number(cur.endsAt||0) || 0;
      if (endsAt && Date.now() < endsAt) return cur;
      cur.status = 'ended';
      cur.endedAt = Date.now();
      return cur;
    });

    if (res && res.committed){
      try{ await pushSystem_(`‚òî ÏÇ∞ÏÑ±ÎπÑ Ï¢ÖÎ£å! (120Ï¥à) ‚Äî Ï†êÏàòÌåêÏùÑ ÌôïÏù∏Ìï¥ Î≥¥ÏÑ∏Ïöî üéØ`); }catch(e){}
      try{ await acidPublishPodium_(); }catch(e){}
    }
  }catch(e){}
}

async function acidPublishPodium_(){
  try{
    if (!sessionId) return;
    await window.FB.ensureAnonAuth();

    // 1) read players once
    const plRef = window.FB.ref(window.FB.db, fbAcidPlayersPath_(sessionId));
    const snap = await window.FB.get(plRef);
    const players = (snap && snap.exists()) ? (snap.val() || {}) : {};

    const items = [];
    for (const puid of Object.keys(players||{})){
      const p = players[puid] || {};
      const nm = String(p.name || 'ÏùµÎ™Ö').trim().slice(0,12);
      const score = Number(p.score || 0) || 0;
      const ts = Number(p.ts || 0) || 0;
      items.push({ uid:puid, nm, score, ts });
    }

    // sort: score desc, ts asc(earlier first), name
    items.sort((a,b)=>{
      if (a.score !== b.score) return b.score - a.score;
      if (a.ts !== b.ts) return a.ts - b.ts;
      return a.nm.localeCompare(b.nm);
    });

    const top = items.slice(0,3);

    // 2) claim "podium posted" atomically so it's broadcast once
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(sessionId));
    const claim = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur) return cur;
      if (cur.podiumPostedAt) return cur; // already posted
      cur.podiumPostedAt = Date.now();
      cur.podium = top.map((t, i)=>({ rank:i+1, name:t.nm, score:t.score }));
      return cur;
    });

    if (!claim || !claim.committed) return;

    // 3) system message + fanfare
    const line = top.map((t,i)=> `${i+1}Îì± ${t.nm}(${t.score})`).join(' ¬∑ ');
    const msg = top.length ? `üèÜ ÏÇ∞ÏÑ±ÎπÑ Í≤∞Í≥º TOP${top.length}: ${line} üé∫üéâ` : `üèÜ ÏÇ∞ÏÑ±ÎπÑ Í≤∞Í≥º: Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏóàÏñ¥Ïöî üòø`;
    try{ await pushSystem_(msg); }catch(e){}

    // fireworks for #1 (or generic)
    const winner = top[0]?.nm || '';
    try{ await pushEvent_({ type:'event', event:'fireworks', kind:'acid', by:winner || (myName().slice(0,12)||'SYSTEM'), ts: Date.now() }); }catch(e){}

    // small confetti for #2/#3
    for (let i=1;i<Math.min(3, top.length);i++){
      try{ await pushEvent_({ type:'event', event:'fx2', kind:'confetti', by: top[i].nm, ts: Date.now() }); }catch(e){}
    }
  }catch(e){}
}


async function startAcidRain_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const cur = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
    status: 'running',
    startedAt: Date.now(),
    endsAt: Date.now() + ACID_LIMIT_MS_,
    limitMs: ACID_LIMIT_MS_,
    spawnMs: ACID_SPAWN_MS_,
    fallMs: ACID_FALL_MS_,
    seed: Math.floor(Math.random()*2147483647),
    startedBy: myName().slice(0,12) || 'ÏùµÎ™Ö'
  };

  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbAcidPath_(sessionId));
    await window.FB.set(root, { current: cur, players: {} });

    // local prep
    acidUi_.hits = 0;
    acidUi_.misses = 0;
    acidUi_.schedule = buildAcidSchedule_(cur);

    await pushSystem_(`‚òî ${cur.startedBy}ÎãòÏù¥ ÏÇ∞ÏÑ±ÎπÑÎ•º ÏãúÏûëÌñàÏäµÎãàÎã§! ‚è±Ô∏è 120Ï¥à ‚Äî Îã®Ïñ¥Î•º ÏôÑÎ≤ΩÌïòÍ≤å ÏπòÍ≥† Enter/Space!`);
    openAcidGame_();
  }catch(e){
    showOverlay('Ïò§Î•ò', 'ÏÇ∞ÏÑ±ÎπÑÎ•º ÏãúÏûëÌï† Ïàò ÏóÜÏñ¥Ïöî. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
  }
}

window.openAcidStart_ = openAcidStart_;
window.openAcidGame_ = openAcidGame_;
window.startAcidRain_ = startAcidRain_;

// =====================

// =====================
// =====================
// üß© Mini game: Rummikub (Î≤†ÌÉÄ / Ïã§ÏãúÍ∞Ñ Í≥µÏú†)
// - Í∞ôÏùÄ ÏÑ∏ÏÖò(room) ÏïàÏóêÏÑú ÏÉÅÌÉúÎ•º FirebaseÎ°ú Í≥µÏú†Ìï©ÎãàÎã§.
// - ÎìúÎ°úÏö∞/ÌÑ¥ ÎÑòÍ∏∞Í∏∞ Îì±ÏùÄ Ìä∏ÎûúÏû≠ÏÖòÏúºÎ°ú Í∞±Ïã†(Ï∂©Îèå ÏµúÏÜåÌôî)
// =====================
let rkState_ = null;
let rkUnsub_ = null;

function fbRKPath_(roomId){ return `rooms/${roomId}/games/rummikub`; }
function fbRKStatePath_(roomId){ return `${fbRKPath_(roomId)}/state`; }

function rkEnsureSub_(){
  try{
    if (rkUnsub_) return;
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    rkUnsub_ = window.FB.onValue(sRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      rkState_ = v;
      // Ïò§Î≤ÑÎ†àÏù¥Í∞Ä Ïó¥Î†§ÏûàÏúºÎ©¥ UI Í∞±Ïã†
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('Î£®ÎØ∏ÌÅêÎ∏å')) rkRender_();
      }catch(e){}
    });
  }catch(e){}
}

function openRummi_(){
  try{ rkEnsureSub_(); }catch(e){}
  try{ rkRender_(); }catch(e){}
}

async function rkReset_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.remove(sRef);
  }catch(e){}
  try{ rkState_ = null; }catch(e){}
  try{ hideOverlay(); }catch(e){}
}

async function rkStartFromUi_(){
  try{ rkEnsureSub_(); }catch(e){}
  try{
    const n = Math.max(2, Math.min(5, parseInt(document.getElementById('rkPlayers')?.value || '2',10) || 2));
    const st = rkNewGame_(n);
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.set(sRef, st);
  }catch(e){}
}

function rkNewGame_(nPlayers){
  const colors = ['R','B','G','K'];
  const tiles = [];
  let id = 0;
  // 1~13, 4ÏÉâ, 2ÏÑ∏Ìä∏
  for (let set=0; set<2; set++){
    for (const c of colors){
      for (let num=1; num<=13; num++){
        tiles.push({ id: (++id), c, num, j:false });
      }
    }
  }
  // jokers x2
  tiles.push({ id: (++id), c:'J', num:0, j:true });
  tiles.push({ id: (++id), c:'J', num:0, j:true });

  // shuffle
  for (let i=tiles.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    const tmp = tiles[i]; tiles[i]=tiles[j]; tiles[j]=tmp;
  }

  const players = [];
  for (let p=0;p<nPlayers;p++){
    players.push({ name:`P${p+1}`, rack:[] });
  }
  // deal 14 each
  for (let k=0;k<14;k++){
    for (let p=0;p<nPlayers;p++){
      const t = tiles.pop();
      if (t) players[p].rack.push(t);
    }
  }

  return {
    nPlayers,
    players,
    pool: tiles,
    table: [],
    turn: 0,
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
}

function rkTileHtml_(t){
  if (!t) return '';
  const cls = t.j ? 'rkTile joker' : ('rkTile c'+t.c);
  const label = t.j ? 'üÉè' : String(t.num);
  const sub = t.j ? 'J' : t.c;
  return `<span class="${cls}" title="${sub}">${label}</span>`;
}

function rkSetupHtml_(){
  return `
    <div class="rkWrap">
      <div class="rkHead">
        <div class="rkTitle">üß© Î£®ÎØ∏ÌÅêÎ∏å (Î≤†ÌÉÄ)</div>
        <div class="rkSub">2~5Î™Ö ¬∑ <b>Ïã§ÏãúÍ∞Ñ Í≥µÏú†</b></div>
      </div>

      <div class="rkSetup">
        <label class="rkLbl">ÌîåÎ†àÏù¥Ïñ¥ Ïàò</label>
        <select id="rkPlayers">
          <option value="2">2Î™Ö</option>
          <option value="3">3Î™Ö</option>
          <option value="4">4Î™Ö</option>
          <option value="5">5Î™Ö</option>
        </select>
        <button class="btn" type="button" data-action="rkStart">ÏÉà Í≤åÏûÑ ÏãúÏûë</button>
        <button class="btn ghost" type="button" data-action="rkReset">Îã´Í∏∞</button>
      </div>

      <div class="rkHint">
        ‚Ä¢ ÌòÑÏû¨Îäî <b>Í∏∞Î≥∏ Íµ¨Ï°∞</b>(ÏÖîÌîå/Îîú/ÎìúÎ°úÏö∞/ÌÑ¥)Îßå Íµ¨ÌòÑÎêòÏñ¥ ÏûàÏñ¥Ïöî.<br/>
        ‚Ä¢ Í∞ôÏùÄ ÏÑ∏ÏÖòÏóê Îì§Ïñ¥Ïò® ÏÇ¨ÎûåÎì§Ïù¥ <b>Í∞ôÏùÄ ÏÉÅÌÉúÎ•º Í≥µÏú†</b>Ìï¥ÏÑú Í∞ôÏù¥ ÌîåÎ†àÏù¥Ìï† Ïàò ÏûàÏäµÎãàÎã§.
      </div>
    </div>
  `;
}

function rkRender_(){
  try{
    if (!rkState_){
      showOverlayHtml('üß© Î£®ÎØ∏ÌÅêÎ∏å(Î≤†ÌÉÄ)', rkSetupHtml_(), true);
      return;
    }
    const st = rkState_;
    const me = (st.players||[])[st.turn] || (st.players||[])[0] || {name:'P1', rack:[]};
    const poolN = (st.pool||[]).length;

    const rack = (me.rack||[]).slice().sort((a,b)=>{
      const ca = (a.c||'').charCodeAt(0), cb = (b.c||'').charCodeAt(0);
      if (ca!==cb) return ca-cb;
      return (a.num||0)-(b.num||0);
    });

    const rackHtml = rack.map(rkTileHtml_).join('');

    const html = `
      <div class="rkWrap">
        <div class="rkHead">
          <div class="rkTitle">üß© Î£®ÎØ∏ÌÅêÎ∏å (Î≤†ÌÉÄ)</div>
          <div class="rkSub">ÌòÑÏû¨ ÌÑ¥: <b>${escapeHtml(me.name||'P')}</b> ¬∑ ÎÇ®ÏùÄ ÌÉÄÏùº: <b>${poolN}</b></div>
        </div>

        <div class="rkCtrl">
          <button class="btn" type="button" data-action="rkDraw">ÎìúÎ°úÏö∞(1Ïû•)</button>
          <button class="btn ghost" type="button" data-action="rkNext">ÌÑ¥ ÎÑòÍ∏∞Í∏∞</button>
          <button class="btn ghost" type="button" data-action="rkReset">Ï¢ÖÎ£å</button>
        </div>

        <div class="rkRack">
          <div class="rkLbl">ÌòÑÏû¨ ÌÑ¥Ïùò Ìå®(Ï†ïÎ†¨)</div>
          <div class="rkRackTiles">${rackHtml || '<span class="muted">Ìå®Í∞Ä ÎπÑÏóàÏñ¥Ïöî</span>'}</div>
        </div>

        <div class="rkHint">
          ‚Ä¢ Îã§Ïùå ÌôïÏû•: ÌÉÄÏùº ÎìúÎûòÍ∑∏/ÏÑ†ÌÉù ‚Üí ÌÖåÏù¥Î∏îÏóê Îü∞/Í∑∏Î£πÏúºÎ°ú ÎÇ¥Î†§ÎÜìÍ∏∞, Í∑úÏπô Í≤ÄÏ¶ù, ÏäπÎ¶¨ ÌåêÏ†ï, ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ/ÏûêÎ¶¨ Ïó∞Í≤∞
        </div>
      </div>
    `;
    showOverlayHtml('üß© Î£®ÎØ∏ÌÅêÎ∏å(Î≤†ÌÉÄ)', html, true);
  }catch(e){}
}

async function rkDraw_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.runTransaction(sRef, (cur)=>{
      if (!cur || !cur.players || !cur.pool) return cur;
      const t = (cur.pool||[]).pop();
      const idx = Number(cur.turn||0) || 0;
      cur.players[idx] = cur.players[idx] || {name:`P${idx+1}`, rack:[]};
      cur.players[idx].rack = cur.players[idx].rack || [];
      if (t) cur.players[idx].rack.push(t);
      cur.updatedAt = Date.now();
      return cur;
    });
  }catch(e){}
}

async function rkNextTurn_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.runTransaction(sRef, (cur)=>{
      if (!cur || !cur.players) return cur;
      const n = (cur.players||[]).length || 1;
      cur.turn = ((Number(cur.turn||0)||0) + 1) % n;
      cur.updatedAt = Date.now();
      return cur;
    });
  }catch(e){}
}

// =====================
// =====================

// ‚úÖ WriterMarble: fit board to overlay width (no weird font jumping)
function wmFitBoard_(){
  try{
    const wrap = document.querySelector('.wmBoardWrap');
    const board = document.querySelector('.wmBoard.wmBoardScaled');
    if (!wrap || !board) return;

    // reset (measure at 1x)
    board.style.transform = 'scale(1)';
    board.style.transformOrigin = '50% 50%';

    // natural size
    const naturalW = board.scrollWidth || board.getBoundingClientRect().width || 1;
    const availW = wrap.clientWidth || 1;

    // leave some padding
    const pad = 8;
    const base = Math.max(0.5, Math.min(1, (availW - pad) / naturalW));
    board.dataset.baseScale = String(base);

    const zoom = (typeof wmWheelScale_ === 'number' && isFinite(wmWheelScale_)) ? wmWheelScale_ : 1;
    const finalScale = Math.max(0.35, Math.min(2.8, base * zoom));

    board.style.transform = `scale(${finalScale})`;

    // keep wrap tall enough so center area doesn't overlap
    const naturalH = board.scrollHeight || board.getBoundingClientRect().height || 1;
    wrap.style.minHeight = Math.ceil(naturalH * finalScale) + 'px';
  }catch(e){}
}

// ‚úÖ Î∂ÄÎ£®ÎßàÎ∏î Î≥¥Îìú: ÎßàÏö∞Ïä§ Ïò¨Î¶¨Í≥† Ïä§ÌÅ¨Î°§Î°ú ÌôïÎåÄ/Ï∂ïÏÜå (Ìú† Ï§å)
let wmWheelScale_ = (()=>{
  try{
    const v = parseFloat(localStorage.getItem('WM_WHEEL_ZOOM_V1')||'1');
    return (isFinite(v) && v>0) ? v : 1;
  }catch(e){ return 1; }
})();

function wmBindWheelZoom_(){
  try{
    const wrap = document.querySelector('.wmBoardWrap');
    const board = document.querySelector('.wmBoard.wmBoardScaled');
    if (!wrap || !board) return;
    if (wrap.__wheelZoomBound) return;
    wrap.__wheelZoomBound = true;

    // initial apply (fit + saved zoom)
    try{ wmFitBoard_(); }catch(e){}

    wrap.addEventListener('wheel', (e)=>{
      try{
        if (!board) return;
        // prevent page scroll while zooming the board
        e.preventDefault();

        const rect = wrap.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / Math.max(1, rect.width)) * 100;
        const y = ((e.clientY - rect.top) / Math.max(1, rect.height)) * 100;
        board.style.transformOrigin = `${Math.max(0,Math.min(100,x))}% ${Math.max(0,Math.min(100,y))}%`;

        const step = 1.07;
        if (e.deltaY < 0) wmWheelScale_ *= step;      // wheel up ‚Üí zoom in
        else wmWheelScale_ /= step;                   // wheel down ‚Üí zoom out

        wmWheelScale_ = Math.max(0.6, Math.min(2.2, wmWheelScale_));
        try{ localStorage.setItem('WM_WHEEL_ZOOM_V1', String(wmWheelScale_)); }catch(err){}
        try{ wmFitBoard_(); }catch(err){}
      }catch(err){}
    }, { passive:false });

    // resize safe
    window.addEventListener('resize', ()=>{ try{ wmFitBoard_(); }catch(e){} }, { passive:true });
  }catch(e){}
}



// Mini Game: Writer Marble (Î∂ÄÎ£®ÎßàÎ∏î: Í∏ÄÏûêÏàò Î≤ÑÏ†Ñ)
// ‚úÖ Î™©Ìëú: 10Î∞îÌÄ¥ ÏÑ†Ï∞© ÎòêÎäî ÎßàÏßÄÎßâ ÏÉùÏ°¥
// ‚úÖ ÌÜµÌôî: Í∏ÄÏûêÏàò(Í∏∞Î≥∏ 15,000Ïûê)
// ‚úÖ ÎåÄÏ∂ú: 2ÌöåÍπåÏßÄ(Ìïú Î≤à 5,000Ïûê, ÏÉÅÌôò 5,500Ïûê)
// ‚úÖ Ï£ºÏÇ¨ÏúÑ Ïó∞Ï∂ú: 2Ï¥à Íµ¥Î¶º(ÏÉÅÌÉú Í≥µÏú†)
// =====================
const WM_START_MONEY_ = 15000;
const WM_PASS_START_BONUS_ = 1200;
const WM_LOAN_AMOUNT_ = 5000;
const WM_LOAN_REPAY_ = 5500;
const WM_MAX_LOANS_ = 2;
const WM_DICE_ANIM_MS_ = 2000;

let wmPlayers_ = {};
let wmPlayersUnsub_ = null;
let wmState_ = null;
let wmStateUnsub_ = null;

function fbWMPath_(roomId){ return `rooms/${roomId}/games/writerMarble`; }
function fbWMPlayersPath_(roomId){ return `${fbWMPath_(roomId)}/players`; }
function fbWMStatePath_(roomId){ return `${fbWMPath_(roomId)}/state`; }

function wmDefaultState_(){
  return {
    started:false,
    ended:false,
    winner:null,
    createdAt: Date.now(),
    turnOrder:[],
    turnIdx:0,
    pending:null, // {by, d1, d2, total, startedAt, resolveAt, fromPos}
    lastMove:null, // {uid, from, to, steps, at, token}
    lastLog:[],
    tiles:{} // pos -> {ownerId, ownerName, price, rent}
  };
}

function wmDiceChar_(n){
  const map = {1:'‚öÄ',2:'‚öÅ',3:'‚öÇ',4:'‚öÉ',5:'‚öÑ',6:'‚öÖ'};
  return map[n] || 'üé≤';
}

function wmBoard_(){
  // 40Ïπ∏(11x11 Ïô∏Í≥Ω) ‚Äî ‚ÄúÎ™®ÎëêÏùòÎßàÎ∏î ÎäêÎÇå‚ÄùÎßå ÏÇ¥Î¶∞ ÎùºÏù¥Ìä∏ Î≤ÑÏ†Ñ
  // pos: 0(START) ‚Üí ÏãúÍ≥ÑÎ∞©Ìñ•
  // type: start, land, chance, tax, loan, rest
  const lands = [
    ['Îã¨ÎπõÏÑúÏ†ê','üìö'],['Ìé∏ÏßëÏã§','üìù'],['ÌîºÎìúÎ∞±Î∞©','üí¨'],['ÎßàÍ∞êÏπ¥Ìéò','‚òï'],
    ['ÏûëÏóÖÏã§A','üñ•Ô∏è'],['ÏûëÏóÖÏã§B','‚å®Ô∏è'],['ÏßëÌïÑÎèôÍµ¥','üï≥Ô∏è'],['ÏòÅÍ∞êÏãúÏû•','üõí'],
    ['Ìá¥Í≥†ÏùòÏà≤','üå≤'],['Í≥†Ï¶ùÎèÑÏÑúÍ¥Ä','üèõÔ∏è'],['Ïó∞Ïû¨Í¥ëÏû•','üèüÔ∏è'],['ÌëúÏßÄÏä§ÌäúÎîîÏò§','üé®'],
    ['Ìè¨Ïä§ÌÑ∞Í±∞Î¶¨','ü™ß'],['ÎèÖÏûêÎßàÏùÑ','üèòÔ∏è'],['Î¶¨ÎîîÏó≠','üöâ'],['ÌîåÎû´ÌèºÌÉÄÏõå','üóº'],
    ['Í∏∞ÌöçÌöåÏùòÏã§','üìã'],['ÏãúÎÜâÍ≥µÎ∞©','üß©'],['ÏÑ∏Í≥ÑÍ¥ÄÌï≠Íµ¨','‚öì'],['Ï∫êÎ¶≠ÌÑ∞Í≥µÏõê','üé°'],
    ['Í∞êÏ†ïÏÑ†Í∞Ä','üé≠'],['Ï†ÑÍ∞úÎèÑÎ°ú','üõ£Ô∏è'],['Îñ°Î∞•Ï∞ΩÍ≥†','üì¶'],['Î∞òÏ†ÑÌÑ∞ÎÑê','üåÄ'],
    ['ÌõÑÍ∏∞Í¥ëÏû•','üó£Ô∏è'],['ÍµøÏ¶àÏÉÅÏ†ê','üß∏'],['Ïã†ÏûëÍ±∞Î¶¨','üÜï'],['Î≤†Ïä§Ìä∏Ï°¥','üèÜ'],
  ];
  // Í∞ÄÍ≤©/Î†åÌä∏Îäî ‚ÄúÎ™áÎ∞±Ïûê‚Äù Îã®ÏúÑÎ°ú
  const priceBase = [450,520,600,680,760,840,920,1000];
  const rentBase  = [220,260,300,340,380,420,460,520];

  // Í≥†Ï†ï Ïù¥Î≤§Ìä∏ Ïπ∏ Î∞∞Ïπò(ÎäêÎÇåÏö©)
  const special = {
    0:{type:'start', name:'START', icon:'üèÅ', desc:`+${WM_PASS_START_BONUS_} (ÌÜµÍ≥º)`},
    5:{type:'chance', name:'Ìè¨Ï∂ò', icon:'üéÅ', desc:'ÎûúÎç§'},
    10:{type:'tax', name:'ÏÑ∏Í∏à', icon:'üßæ', desc:'-900'},
    15:{type:'loan', name:'ÏùÄÌñâ', icon:'üè¶', desc:`ÎåÄÏ∂ú(${WM_LOAN_AMOUNT_})/ÏÉÅÌôò(${WM_LOAN_REPAY_})`},
    20:{type:'rest', name:'Ìú¥Ïãù', icon:'üõãÔ∏è', desc:'ÌïúÏà® ÎèåÎ¶¨Í∏∞'},
    25:{type:'chance', name:'Ìè¨Ï∂ò', icon:'üéÅ', desc:'ÎûúÎç§'},
    30:{type:'tax', name:'ÏÑ∏Í∏à', icon:'üßæ', desc:'-1200'},
    35:{type:'loan', name:'ÏùÄÌñâ', icon:'üè¶', desc:`ÎåÄÏ∂ú(${WM_LOAN_AMOUNT_})/ÏÉÅÌôò(${WM_LOAN_REPAY_})`},
  };

  const out = [];
  let landIdx=0;
  for (let pos=0; pos<40; pos++){
    if (special[pos]){
      out.push({pos, ...special[pos]});
    }else{
      const [nm, ic] = lands[landIdx % lands.length];
      const tier = landIdx % priceBase.length;
      const price = priceBase[tier];
      const rent = rentBase[tier];
      out.push({pos, type:'land', name:nm, icon:ic, price, rent, desc:`${price}Ïûê / ÌÜµÌñâÎ£å ${rent}Ïûê`});
      landIdx++;
    }
  }
  return out;
}

const WM_BOARD_ = wmBoard_();

// grid position mapping for 11x11 perimeter (pos 0..39)
function wmPosToGrid_(pos){
  const n = 11;
  const max = n-1; // 10
  // corners: 0=top-left, 10=top-right, 20=bottom-right, 30=bottom-left
  if (pos<=10){
    return {r:1, c:1+pos}; // top row left->right
  }else if (pos<=19){
    return {r:1+(pos-10), c:11}; // right col top->bottom (rows 2..10)
  }else if (pos<=30){
    // bottom row right->left
    return {r:11, c:11-(pos-20)}; // pos20..30 => c 11..1
  }else{
    // left col bottom->top
    return {r:11-(pos-30), c:1}; // pos31..39 => r 10..2
  }
}


function wmMeId_(){
  try{
    return ((window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || '').trim();
  }catch(e){ return wmMeId_(); }
}
function wmColorFor_(id){
  const hues = [330,320,305,285,265,245,220,200,180,160,140,120];
  const h = hues[Math.abs(hash32_(String(id||''))) % hues.length];
  return `hsl(${h} 85% 78%)`;
}
function wmMyPlayer_(){
  const me = wmMeId_();
  if (!me) return null;
  return { id: me, ...(wmPlayers_[me]||{}) };
}

function wmAddLog_(msg){
  try{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      const arr = Array.isArray(cur.lastLog) ? cur.lastLog.slice(-10) : [];
      arr.push({ts:Date.now(), msg:String(msg||'')});
      cur.lastLog = arr.slice(-12);
      return cur;
    });
  }catch(e){}
}

function wmEnsureInit_(roomId){
  return (async ()=>{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(roomId));
    const snap = await window.FB.get(sRef);
    if (!snap.exists()){
      await window.FB.set(sRef, wmDefaultState_());
    }
  })();
}

function initWriterMarble_(roomId){
  try{ if (wmPlayersUnsub_) wmPlayersUnsub_(); }catch(e){}
  try{ if (wmStateUnsub_) wmStateUnsub_(); }catch(e){}
  wmPlayersUnsub_ = null;
  wmStateUnsub_ = null;

  const pRef = window.FB.ref(window.FB.db, fbWMPlayersPath_(roomId));
  wmPlayersUnsub_ = window.FB.onValue(pRef, (snap)=>{
    wmPlayers_ = snap.val() || {};
    renderWriterMarbleOverlay_();
  });

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(roomId));
  wmStateUnsub_ = window.FB.onValue(sRef, (snap)=>{
    wmState_ = snap.val() || wmDefaultState_();
    // pending resolve attempt
    try{ wmResolvePending_(); }catch(e){}
    renderWriterMarbleOverlay_();
  });
}

async function wmJoin_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ÎãâÎÑ§ÏûÑ', 'ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }
  try{ await window.FB.ensureAnonAuth(); window.__presenceId = (window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || ''; }catch(e){}
  const meId = wmMeId_();
  if (!meId) return;

  const nick = (getNick_() || 'ÏùµÎ™Ö').trim();
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${meId}`);
  const payload = {
    id: meId,
    name: nick,
    joinedAt: Date.now(),
    money: WM_START_MONEY_,
    pos: 0,
    lap: 0,
    loans: 0,
    debt: 0,
    bankrupt: false,
    token: wmPickToken_(meId),
  };
  try{
    await window.FB.set(pRef, payload);
    wmAddLog_(`üèÅ ${nick} Ï∞∏Í∞Ä! (ÏãúÏûë ${WM_START_MONEY_}Ïûê)`);
  }catch(e){}
}

function wmPickToken_(seed){
  const tokens = ['ü¶ä','üêº','üêØ','üê∞','üê∏','üêµ','üêß','üê£','üêô','ü¶Ñ','üê±','üê∂','üêπ','ü¶ñ','ü¶ï','üê≤'];
  const idx = Math.abs(hash32_(String(seed||''))) % tokens.length;
  return tokens[idx];
}

async function wmLeaveMe_(){
  try{
    const meId = wmMeId_();
    if (!meId) return;
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${meId}`);
    await window.FB.remove(pRef);
    wmAddLog_(`üëã ${(getNick_()||'ÎàÑÍµ∞Í∞Ä')} Ìá¥Ïû•`);
  }catch(e){}
}

function wmAliveIds_(){
  const ids = Object.keys(wmPlayers_||{});
  return ids.filter(id=> !(wmPlayers_[id]||{}).bankrupt);
}

async function wmStartGame_(){
  if (!sessionId) return;
  const ids = Object.keys(wmPlayers_||{});
  if (ids.length < 2){
    showOverlay('Î∂ÄÎ£®ÎßàÎ∏î', '2Î™Ö Ïù¥ÏÉÅ Ï∞∏Í∞ÄÌï¥Ïïº ÏãúÏûëÌï† Ïàò ÏûàÏñ¥Ïöî!');
    return;
  }
  const order = ids
    .map(id=>({id, t:(wmPlayers_[id]||{}).joinedAt || 0}))
    .sort((a,b)=>a.t-b.t)
    .map(x=>x.id);

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    cur.started = true;
    cur.ended = false;
    cur.winner = null;
    cur.turnOrder = order;
    cur.turnIdx = 0;
    cur.pending = null;
    cur.tiles = {}; // reset ownership
    cur.lastLog = [{ts:Date.now(), msg:'üèÅ Í≤åÏûÑ ÏãúÏûë! (10Î∞îÌÄ¥ ÏÑ†Ï∞© / ÎßàÏßÄÎßâ ÏÉùÏ°¥)'}];
    return cur;
  });

  // reset players stats
  for (const id of ids){
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${id}`);
    await window.FB.update(pRef, { money: WM_START_MONEY_, pos:0, lap:0, loans:0, debt:0, bankrupt:false });
  }
}

async function wmEndGame_(){
  if (!sessionId) return;
  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    cur.started = false;
    cur.ended = true;
    cur.winner = null;
    cur.pending = null;
    cur.turnOrder = [];
    cur.turnIdx = 0;
    cur.tiles = {};
    cur.lastLog = [{ts:Date.now(), msg:'üßπ Í≤åÏûÑ Ï¢ÖÎ£å/Î¶¨ÏÖã'}];
    return cur;
  });
}

function wmIsMyTurn_(){
  const me = wmMyPlayer_();
  if (!me || !wmState_ || !wmState_.started || wmState_.ended) return false;
  const curId = (wmState_.turnOrder||[])[wmState_.turnIdx||0];
  return curId && curId === me.id;
}

function wmCurrentTurnId_(){
  if (!wmState_ || !wmState_.started) return null;
  const curId = (wmState_.turnOrder||[])[wmState_.turnIdx||0];
  return curId || null;
}

async function wmRoll_(){
  if (!sessionId) return;
  if (!wmState_ || !wmState_.started || wmState_.ended) return;

  const me = wmMyPlayer_();
  if (!me) return;
  if (!wmIsMyTurn_()){
    showOverlay('Î∂ÄÎ£®ÎßàÎ∏î', 'ÏßÄÍ∏àÏùÄ ÎÇ¥ Ï∞®Î°ÄÍ∞Ä ÏïÑÎãàÏóêÏöî!');
    return;
  }
  // pending exists
  if (wmState_.pending){
    showOverlay('Î∂ÄÎ£®ÎßàÎ∏î', 'Ï£ºÏÇ¨ÏúÑÍ∞Ä Íµ¥Îü¨Í∞ÄÎäî Ï§ëÏù¥ÏóêÏöî!');
    return;
  }
  const d1 = 1 + Math.floor(Math.random()*6);
  const d2 = 1 + Math.floor(Math.random()*6);
  const total = d1 + d2;
  const now = Date.now();

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    if (!cur.started || cur.ended) return cur;
    if (cur.pending) return cur;
    const curId = (cur.turnOrder||[])[cur.turnIdx||0];
    if (curId !== me.id) return cur;
    cur.pending = { by: me.id, d1, d2, total, startedAt: now, resolveAt: now + WM_DICE_ANIM_MS_, fromPos: (me.pos||0) };
    return cur;
  });
}

function wmResolvePending_(){
  if (!sessionId) return;
  if (!wmState_ || !wmState_.pending || !wmState_.started || wmState_.ended) return;
  const p = wmState_.pending;
  const now = Date.now();
  if (now < (p.resolveAt||0)) return;

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    if (!cur.started || cur.ended) return cur;
    if (!cur.pending) return cur;
    const pend = cur.pending;
    if (Date.now() < (pend.resolveAt||0)) return cur;

    const pid = pend.by;
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt){
      cur.pending = null;
      return cur;
    }

    const steps = pend.total || 0;
    const from = pl.pos || 0;
    let to = (from + steps) % 40;
    let lapAdd = 0;
    if (from + steps >= 40) lapAdd = Math.floor((from + steps)/40);
    const newLap = (pl.lap||0) + lapAdd;

    // movement broadcast (for animation)
    cur.lastMove = { uid: pid, from, to, steps, at: Date.now(), token: (pl.token||'üôÇ') };

    // apply move (write player update outside transaction via queued update)
    setTimeout(()=>{ try{
      const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
      window.FB.update(pRef, { pos: to, lap: newLap });
      if (lapAdd>0){
        window.FB.update(pRef, { money: (pl.money||0) + (WM_PASS_START_BONUS_ * lapAdd) });
      }
    }catch(e){} }, 0);

    // log dice
    const nm = pl.name || 'ÎàÑÍµ∞Í∞Ä';
    const arr = Array.isArray(cur.lastLog) ? cur.lastLog.slice(-10) : [];
    arr.push({ts:Date.now(), msg:`üé≤ ${nm}: ${pend.d1}+${pend.d2} = ${steps}`});
    cur.lastLog = arr.slice(-12);

    // land effect: compute using snapshot-ish (best effort)
    const tile = WM_BOARD_[to] || null;
    if (tile){
      // resolve effects in microtask
      setTimeout(()=>{ try{ wmApplyTileEffect_(pid, tile, cur.tiles||{}); }catch(e){} }, 0);
    }

    // win check (10 laps)
    if (newLap >= 10){
      cur.ended = true;
      cur.winner = pid;
      cur.lastLog = (cur.lastLog||[]).concat([{ts:Date.now(), msg:`üèÜ ${nm} 10Î∞îÌÄ¥ ÏôÑÏ£º! Ïö∞Ïäπ!`}]).slice(-12);
    }

    // advance turn (unless game ended)
    if (!cur.ended){
      const alive = (cur.turnOrder||[]).filter(id=>{
        const pl2 = (wmPlayers_||{})[id];
        return pl2 && !pl2.bankrupt;
      });
      if (alive.length <= 1){
        cur.ended = true;
        cur.winner = alive[0] || pid;
      }else{
        // rotate to next alive
        const curId = (cur.turnOrder||[])[cur.turnIdx||0];
        let idx = cur.turnIdx||0;
        for (let k=0;k<alive.length+2;k++){
          idx = (idx+1) % (cur.turnOrder||[]).length;
          const nid = (cur.turnOrder||[])[idx];
          const pl3 = (wmPlayers_||{})[nid];
          if (pl3 && !pl3.bankrupt){
            cur.turnIdx = idx;
            break;
          }
        }
      }
    }

    cur.pending = null;
    return cur;
  });
}

function wmTileKey_(pos){ return String(pos); }

function wmRentFor_(tile, owned){
  const base = Number((owned && owned.baseRent) || (owned && owned.rent) || tile.rent || 300);
  const lvl = Number((owned && owned.level) || 0);
  return Math.max(50, Math.floor(base * (1 + lvl * 0.75)));
}
function wmUpgradeCost_(tile, nextLvl){
  const p = Number(tile.price || 0);
  // nextLvl: 1..3
  const mul = [0, 0.45, 0.55, 0.70][nextLvl] || 0.6;
  return Math.max(200, Math.floor(p * mul));
}
function wmSellValue_(tile, owned){
  const p = Number(tile.price || (owned && owned.price) || 0);
  const lvl = Number((owned && owned.level) || 0);
  return Math.max(100, Math.floor(p * (0.7 + lvl*0.12)));
}

function wmReleaseAllProps_(pid){
  try{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      cur.tiles = cur.tiles || {};
      for (const k of Object.keys(cur.tiles)){
        const o = cur.tiles[k];
        if (o && o.ownerId === pid) cur.tiles[k] = { ...o, ownerId:null, ownerName:null, level:0, visits:null };
      }
      return cur;
    });
  }catch(e){}
}

function wmTryCoverDeficit_(pid, tilesState, reason){
  try{
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt) return;
    let money = Number(pl.money||0);
    if (money >= 0) return;

    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
    const nm = pl.name || 'ÎàÑÍµ∞Í∞Ä';

    // 1) auto-loan up to limit
    if ((pl.loans||0) < WM_MAX_LOANS_){
      const loanAmt = WM_LOAN_AMOUNT_;
      window.FB.update(pRef, { money: money + loanAmt, loans: (pl.loans||0)+1, debt: (pl.debt||0)+loanAmt });
      money += loanAmt;
      wmAddLog_(`üÜò ${nm} ÌååÏÇ∞ ÏßÅÏ†Ñ! ÏûêÎèô ÎåÄÏ∂ú +${loanAmt}Ïûê (ÎåÄÏ∂ú ${((pl.loans||0)+1)}/${WM_MAX_LOANS_})`);
    }

    // 2) forced sales if still negative
    if (money < 0){
      const props = [];
      for (const t of WM_BOARD_){
        if (t.type !== 'land') continue;
        const key = wmTileKey_(t.pos);
        const o = (tilesState||{})[key];
        if (o && o.ownerId === pid){
          props.push({pos:t.pos, tile:t, owned:o, val: wmSellValue_(t,o)});
        }
      }
      props.sort((a,b)=>b.val-a.val);
      for (const pr of props){
        if (money >= 0) break;
        const gain = pr.val;
        money += gain;
        // release tile ownership
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const k = wmTileKey_(pr.pos);
          const curO = cur.tiles[k];
          if (curO && curO.ownerId === pid){
            cur.tiles[k] = { ...curO, ownerId:null, ownerName:null, level:0, visits:null };
          }
          return cur;
        });
        window.FB.update(pRef, { money });
        wmAddLog_(`üí• ${nm} Í∞ïÏ†ú Îß§Í∞Å! <${pr.tile.icon}${pr.tile.name}> +${gain}Ïûê`);
      }
    }

    // 3) still negative => bankrupt
    if (money < 0){
      window.FB.update(pRef, { bankrupt:true, money:0 });
      wmReleaseAllProps_(pid);
      wmAddLog_(`üíÄ ${nm} ${reason || 'ÌååÏÇ∞'}‚Ä¶ (Î≥¥Ïú† ÎïÖ Î™®Îëê ÏïïÎ•ò)`);
    }
  }catch(e){}
}

function wmApplyTileEffect_(pid, tile, tilesState){
  const pl = (wmPlayers_||{})[pid];
  if (!pl || pl.bankrupt) return;

  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
  const nm = pl.name || 'ÎàÑÍµ∞Í∞Ä';
  const money = Number(pl.money||0);

  if (tile.type === 'tax'){
    const delta = (tile.pos===30) ? -1200 : -900;
    const nmoney = money + delta;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`üßæ ${nm} ÏÑ∏Í∏à ${-delta}Ïûê`);
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'ÏÑ∏Í∏àÏúºÎ°ú ÌååÏÇ∞');
    return;
  }
  if (tile.type === 'chance'){
    const rng = Math.abs(hash32_(`${Date.now()}|${pid}|${tile.pos}`)) % 6;
    const events = [
      {d:+900, t:'‚ú® ÏòÅÍ∞ê Ìè≠Î∞ú! +900Ïûê'},
      {d:+1200,t:'üî• ÏßëÏ§ëÎ™®Îìú ÏÑ±Í≥µ! +1200Ïûê'},
      {d:-700, t:'ü•± Ï°∏Ïùå Í≥µÍ≤©‚Ä¶ -700Ïûê'},
      {d:-900, t:'üìµ Î©òÌÉà ÏôÄÏû•‚Ä¶ -900Ïûê'},
      {d:+600, t:'‚òï Ïπ¥ÌéòÏù∏ Ï£ºÏûÖ! +600Ïûê'},
      {d:-600, t:'üßº ÏÉùÌôúÎ†• ÏÜåÎ™® -600Ïûê'},
    ];
    const ev = events[rng];
    const nmoney = money + ev.d;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`üéÅ ${nm} ${ev.t}`);
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'Ìè¨Ï∂òÏúºÎ°ú ÌååÏÇ∞');
    return;
  }
  if (tile.type === 'loan'){
    wmAddLog_(`üè¶ ${nm} ÏùÄÌñâ Ïπ∏`);
    return;
  }
  if (tile.type === 'rest'){
    wmAddLog_(`üõãÔ∏è ${nm} Ìú¥Ïãù! (ÏïÑÎ¨¥ ÏùºÎèÑ ÏóÜÏùå)`);
    return;
  }

  if (tile.type === 'land'){
    const key = wmTileKey_(tile.pos);
    const owned = (tilesState||{})[key] || null;

    if (!owned || !owned.ownerId){
      if (money >= tile.price){
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const nowOwned = cur.tiles[key];
          if (nowOwned && nowOwned.ownerId) return cur;
          cur.tiles[key] = { ownerId: pid, ownerName: nm, price: tile.price, baseRent: tile.rent, level: 0, visits: { [pid]: 1 } };
          return cur;
        });
        window.FB.update(pRef, { money: money - tile.price });
        wmAddLog_(`üèóÔ∏è ${nm} <${tile.icon}${tile.name}> Íµ¨Îß§! (-${tile.price}Ïûê)`);
      }else{
        wmAddLog_(`üòµ ${nm} <${tile.icon}${tile.name}> ÏÇ¥ ÎèàÏù¥ Î∂ÄÏ°±‚Ä¶`);
      }
      return;
    }

    if (owned.ownerId === pid){
      // visit + possible auto-upgrade (2~4Î≤àÏß∏ Î∞©Î¨∏)
      const prevV = (owned.visits && owned.visits[pid]) ? Number(owned.visits[pid]) : 0;
      const v = prevV + 1;
      const lvl = Number(owned.level||0);
      const wantUp = (v>=2 && lvl<1) || (v>=3 && lvl<2) || (v>=4 && lvl<3);
      if (wantUp){
        const nextLvl = Math.min(3, lvl+1);
        const cost = wmUpgradeCost_(tile, nextLvl);
        if (money >= cost){
          const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
          window.FB.runTransaction(sRef, (cur)=>{
            cur = cur || wmDefaultState_();
            cur.tiles = cur.tiles || {};
            const curO = cur.tiles[key];
            if (curO && curO.ownerId === pid){
              const vv = (curO.visits||{});
              vv[pid] = (vv[pid]||0) + 1;
              cur.tiles[key] = { ...curO, level: Math.min(3, Number(curO.level||0)+1), visits: vv };
            }
            return cur;
          });
          window.FB.update(pRef, { money: money - cost });
          wmAddLog_(`üèôÔ∏è ${nm} <${tile.icon}${tile.name}> ÎûúÎìúÎßàÌÅ¨ ÏóÖ! Lv.${nextLvl} (-${cost}Ïûê)`);
        }else{
          // still record visit
          const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
          window.FB.runTransaction(sRef, (cur)=>{
            cur = cur || wmDefaultState_();
            cur.tiles = cur.tiles || {};
            const curO = cur.tiles[key];
            if (curO && curO.ownerId === pid){
              const vv = (curO.visits||{});
              vv[pid] = (vv[pid]||0) + 1;
              cur.tiles[key] = { ...curO, visits: vv };
            }
            return cur;
          });
          wmAddLog_(`üè† ${nm} ÎÇ¥ ÎïÖ <${tile.icon}${tile.name}> (ÏóÖÍ∑∏Î†àÏù¥Îìú ÏûêÍ∏à Î∂ÄÏ°±)`);
        }
      }else{
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const curO = cur.tiles[key];
          if (curO && curO.ownerId === pid){
            const vv = (curO.visits||{});
            vv[pid] = (vv[pid]||0) + 1;
            cur.tiles[key] = { ...curO, visits: vv };
          }
          return cur;
        });
        wmAddLog_(`üè† ${nm} ÎÇ¥ ÎïÖ <${tile.icon}${tile.name}>`);
      }
      return;
    }

    // pay rent
    const rent = wmRentFor_(tile, owned);
    const nmoney = money - rent;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`üí∏ ${nm} ÌÜµÌñâÎ£å ${rent}Ïûê ÏßÄÎ∂à ‚Üí ${owned.ownerName||'ÏÉÅÎåÄ'}ÏóêÍ≤å`);

    // give owner
    if (owned.ownerId){
      const oRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${owned.ownerId}`);
      const o = (wmPlayers_||{})[owned.ownerId];
      if (o && !o.bankrupt){
        window.FB.update(oRef, { money: Number(o.money||0) + rent });
      }
    }
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'ÌÜµÌñâÎ£åÎ°ú ÌååÏÇ∞');
    return;
  }
}

function wmBankrupt_(pid, reason){
  try{
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt) return;
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
    window.FB.update(pRef, { bankrupt:true, money:0 });
    wmAddLog_(`üí• ${pl.name||'ÎàÑÍµ∞Í∞Ä'} ÌååÏÇ∞! (${reason||'ÌååÏÇ∞'})`);
    // release owned tiles
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      cur.tiles = cur.tiles || {};
      for (const k of Object.keys(cur.tiles)){
        if (cur.tiles[k] && cur.tiles[k].ownerId === pid){
          cur.tiles[k] = null;
        }
      }
      // winner check
      const alive = (cur.turnOrder||[]).filter(id=>{
        const p2 = (wmPlayers_||{})[id];
        return p2 && !p2.bankrupt && id !== pid;
      });
      if (cur.started && !cur.ended && alive.length === 1){
        cur.ended = true;
        cur.winner = alive[0];
        cur.lastLog = (cur.lastLog||[]).concat([{ts:Date.now(), msg:`üèÜ ${ (wmPlayers_||{})[alive[0]]?.name || 'ÎàÑÍµ∞Í∞Ä'} ÎßàÏßÄÎßâ ÏÉùÏ°¥! Ïö∞Ïäπ!` }]).slice(-12);
      }
      return cur;
    });
  }catch(e){}
}

async function wmLoan_(){
  if (!wmIsMyTurn_()) return showOverlay('Î∂ÄÎ£®ÎßàÎ∏î','ÎÇ¥ Ï∞®Î°ÄÏóêÏÑúÎßå ÎåÄÏ∂úÌï† Ïàò ÏûàÏñ¥Ïöî!');
  const me = wmMyPlayer_(); if (!me) return;
  if ((me.loans||0) >= WM_MAX_LOANS_) return showOverlay('Î∂ÄÎ£®ÎßàÎ∏î', `ÎåÄÏ∂úÏùÄ ÏµúÎåÄ ${WM_MAX_LOANS_}ÌöåÍπåÏßÄ!`);
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${me.id}`);
  await window.FB.update(pRef, {
    loans: (me.loans||0) + 1,
    debt: (me.debt||0) + WM_LOAN_REPAY_,
    money: (me.money||0) + WM_LOAN_AMOUNT_
  });
  wmAddLog_(`üè¶ ${(me.name||'ÎÇò')} ÎåÄÏ∂ú +${WM_LOAN_AMOUNT_}Ïûê (ÏÉÅÌôò ${WM_LOAN_REPAY_}Ïûê)`);
}

async function wmRepay_(){
  if (!wmIsMyTurn_()) return showOverlay('Î∂ÄÎ£®ÎßàÎ∏î','ÎÇ¥ Ï∞®Î°ÄÏóêÏÑúÎßå ÏÉÅÌôòÌï† Ïàò ÏûàÏñ¥Ïöî!');
  const me = wmMyPlayer_(); if (!me) return;
  if ((me.debt||0) <= 0) return showOverlay('Î∂ÄÎ£®ÎßàÎ∏î','ÏÉÅÌôòÌï† ÎåÄÏ∂úÏù¥ ÏóÜÏñ¥Ïöî!');
  if ((me.money||0) < (me.debt||0)) return showOverlay('Î∂ÄÎ£®ÎßàÎ∏î','ÏÉÅÌôòÌï† Îèà(Í∏ÄÏûêÏàò)Ïù¥ Î∂ÄÏ°±Ìï¥Ïöî!');
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${me.id}`);
  await window.FB.update(pRef, { money: (me.money||0) - (me.debt||0), debt: 0 });
  wmAddLog_(`‚úÖ ${(me.name||'ÎÇò')} ÎåÄÏ∂ú ÏÉÅÌôò ÏôÑÎ£å!`);
}

function wmFmt_(n){
  const v = Math.round(Number(n||0));
  return v.toLocaleString('ko-KR');
}


let wmDiceAnimTimer_ = null;
let wmDiceAnimKey_ = null;

function wmKickDiceAnim_(){
  try{
    const st = wmState_;
    if (!st || !st.pending){
      if (wmDiceAnimTimer_) clearInterval(wmDiceAnimTimer_);
      wmDiceAnimTimer_ = null;
      wmDiceAnimKey_ = null;
      return;
    }
    const p = st.pending;
    const key = `${p.by||''}|${p.startedAt||0}`;
    if (wmDiceAnimKey_ === key) return;
    wmDiceAnimKey_ = key;

    if (wmDiceAnimTimer_) clearInterval(wmDiceAnimTimer_);
    const endAt = p.resolveAt || (Date.now() + WM_DICE_ANIM_MS_);
    wmDiceAnimTimer_ = setInterval(()=>{
      try{
        const a = document.getElementById('wmDiceA');
        const b = document.getElementById('wmDiceB');
        if (!a || !b) return;
        const r1 = 1 + Math.floor(Math.random()*6);
        const r2 = 1 + Math.floor(Math.random()*6);
        a.textContent = wmDiceChar_(r1);
        b.textContent = wmDiceChar_(r2);
        if (Date.now() >= endAt){
          a.textContent = wmDiceChar_(p.d1||1);
          b.textContent = wmDiceChar_(p.d2||1);
          clearInterval(wmDiceAnimTimer_);
          wmDiceAnimTimer_ = null;
        }
      }catch(e){}
    }, 90);
  }catch(e){}
}

let wmLastMoveSeenKey_ = null;
function wmAnimateLastMove_(){
  try{
    const st = wmState_ || {};
    const mv = st.lastMove;
    if (!mv || !mv.uid) return;
    const key = `${mv.uid}|${mv.at||0}|${mv.from}|${mv.to}`;
    if (wmLastMoveSeenKey_ === key) return;
    wmLastMoveSeenKey_ = key;

    const board = document.querySelector('#wmBoard');
    if (!board) return;

    // create / reuse ghost
    let ghost = board.querySelector('.wmMoveGhost');
    if (!ghost){
      ghost = document.createElement('div');
      ghost.className = 'wmMoveGhost';
      ghost.textContent = mv.token || 'üôÇ';
      board.appendChild(ghost);
    }else{
      ghost.textContent = mv.token || 'üôÇ';
    }

    const steps = Math.max(0, Math.min(20, Number(mv.steps||0)));
    const path = [];
    for (let i=0;i<=steps;i++){
      path.push((Number(mv.from||0) + i) % 40);
    }
    const rectB = board.getBoundingClientRect();
    const toXY = (pos)=>{
      const cell = board.querySelector(`.wmCell[data-pos="${pos}"]`);
      if (!cell) return {x:-9999,y:-9999};
      const r = cell.getBoundingClientRect();
      return { x: (r.left - rectB.left) + r.width/2, y: (r.top - rectB.top) + r.height/2 };
    };

    let i = 0;
    const hop = ()=>{
      const p = path[i];
      const xy = toXY(p);
      ghost.style.transform = `translate(${xy.x-17}px, ${xy.y-17}px)`;
      i++;
      if (i <= steps){
        setTimeout(hop, 120);
      }else{
        // fade out quickly
        setTimeout(()=>{ try{ ghost.style.transform = 'translate(-9999px,-9999px)'; }catch(e){} }, 240);
      }
    };
    hop();
  }catch(e){}
}

function renderWriterMarbleOverlay_(){
  const me = wmMyPlayer_();
  const st = wmState_ || wmDefaultState_();

  const players = Object.keys(wmPlayers_||{}).map(id=>wmPlayers_[id]).filter(Boolean);
  players.sort((a,b)=> (b.money||0) - (a.money||0));

  const turnId = wmCurrentTurnId_();
  const turnPl = turnId ? (wmPlayers_||{})[turnId] : null;
  const pending = st.pending;

  const myTurn = wmIsMyTurn_();
  const meId = wmMeId_();

  // --- helpers
  const tollFor = (pos, owned, tile)=>{
    try{
      if (!tile) tile = (WM_BOARD_||[]).find(x=>x.pos===pos);
      if (!tile) return 0;
      let base = Number(tile.rent || 0);
      const lv = Number((owned && owned.level) || 0);
      // 0:Í∏∞Î≥∏, 1:ÎûúÎìúÎßàÌÅ¨1, 2:ÎûúÎìúÎßàÌÅ¨2, 3:ÎûúÎìúÎßàÌÅ¨3 (Ï†êÏ†ê Îπ°ÏÑ∏Í≤å)
      const mult = [1, 1.6, 2.3, 3.2][Math.max(0, Math.min(3, lv))];
      return Math.round(base * mult);
    }catch(e){ return 0; }
  };

  const tipFor = (tile, owned)=>{
    if (!tile) return '';
    const lines = [];
    lines.push(`${tile.icon||''} ${tile.name||''}`.trim());
    if (tile.type==='land'){
      const lv = Number((owned && owned.level) || 0);
      const price = Number(tile.price||0);
      const toll = tollFor(tile.pos, owned, tile);
      lines.push(`Íµ¨Îß§: ${wmFmt_(price)}Ïûê`);
      lines.push(`ÌÜµÌñâÎ£å: ${wmFmt_(toll)}Ïûê (Lv.${lv})`);
      if (owned && owned.ownerName) lines.push(`ÏÜåÏú†Ï£º: ${owned.ownerName}`);
    }else{
      if (tile.desc) lines.push(tile.desc);
    }
    return lines.join('\n');
  };

  // --- build board cells
  let cellsHtml = '';
  for (const t of WM_BOARD_){
    const g = wmPosToGrid_(t.pos);
    const owned = (st.tiles||{})[String(t.pos)];
    const isOwned = owned && owned.ownerId;
    const isMine = isOwned && meId && (String(owned.ownerId)===String(meId));
    const ownColor = isOwned ? wmColorFor_(owned.ownerId) : 'transparent';
    const lv = Number((owned && owned.level) || 0);
    const badge = (t.type==='land' && isOwned) ? `<div class="wmLv">Lv.${lv}</div>` : '';
    cellsHtml += `
      <div class="wmCell ${t.type} ${isOwned?'wmOwned':''} ${isMine?'wmMine':''}" 
           style="grid-row:${g.r}; grid-column:${g.c}; --ownc:${ownColor};"
           data-pos="${t.pos}" data-tip="${escapeAttr(tipFor(t, owned))}">
        <div class="wmCellTop">
          <span class="wmIc">${t.icon||''}</span>
          <span class="wmNm">${escapeHtml(t.name||'')}</span>
        </div>
        ${badge}
      </div>
    `;
  }

  // tokens
  const tokenHtml = players.filter(p=>!p.bankrupt).map(p=>{
    const g = wmPosToGrid_(p.pos||0);
    const c = wmColorFor_(p.id);
    return `<div class="wmToken" style="grid-row:${g.r}; grid-column:${g.c}; --tokc:${c}" title="${escapeAttr(p.name||'')}">${p.token||'üôÇ'}</div>`;
  }).join('');

  // dice ui
  const diceUI = pending ? `
    <div class="wmDiceRow">
      <div class="wmDice rolling">${wmDiceChar_(pending.d1)}</div>
      <div class="wmDice rolling">${wmDiceChar_(pending.d2)}</div>
      <div class="wmDiceSum">= ${pending.total}</div>
    </div>
    <div class="wmDiceHint">Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Îäî Ï§ë‚Ä¶ (2Ï¥à)</div>
  ` : `
    <div class="wmDiceRow">
      <div class="wmDice">${wmDiceChar_(1)}</div>
      <div class="wmDice">${wmDiceChar_(6)}</div>
      <div class="wmDiceSum">üé≤</div>
    </div>
    <div class="wmDiceHint">${myTurn ? 'ÎÇ¥ Ï∞®Î°Ä! Íµ¥Î¶¨Í∏∞ GO' : 'ÎåÄÍ∏∞ Ï§ë‚Ä¶'}</div>
  `;

  // controls (safe wrappers: auth+init)
  const startBtn = (!st.started || st.ended) ? `<button class="btn wmBtn" onclick="marbleStartSafe_()">Í≤åÏûÑ ÏãúÏûë</button>` : '';
  const endBtn   = (st.started && !st.ended) ? `<button class="btn wmBtn ghost" onclick="marbleEndSafe_()">Î¶¨ÏÖã</button>` : '';
  const joinBtn  = (!me) ? `<button class="btn wmBtn" onclick="marbleJoinSafe_()">Ï∞∏Ïó¨ÌïòÍ∏∞</button>` : `<button class="btn wmBtn ghost" onclick="marbleLeaveSafe_()">ÎÇòÍ∞ÄÍ∏∞</button>`;
  const rollBtn  = (st.started && !st.ended) ? `<button class="btn wmBtn ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="marbleRollSafe_()">üé≤ Íµ¥Î¶¨Í∏∞</button>` : '';
  const loanBtns = (st.started && !st.ended) ? `
      <button class="btn wmBtn ghost ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="wmLoanSafe_()">üè¶ ÎåÄÏ∂ú</button>
      <button class="btn wmBtn ghost ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="wmRepaySafe_()">‚úÖ ÏÉÅÌôò</button>
  ` : '';

  // strip: top3 + last log
  const top3 = players.slice(0,3).map((p,i)=>`<span class="wmChip">${i+1}ÏúÑ ${p.token||'üôÇ'} ${escapeHtml(p.name||'')}</span>`).join('');
  const lastLog = (st.lastLog||[]).slice(-1)[0]?.msg || '';
  const strip = `
    <div class="wmStrip">
      <div class="wmStripLeft">${top3 || '<span class="wmChip muted">Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏñ¥Ïöî</span>'}</div>
      <div class="wmStripRight">${lastLog ? ('üóíÔ∏è '+escapeHtml(lastLog)) : '<span class="muted">Î°úÍ∑∏Í∞Ä ÏïÑÏßÅ ÏóÜÏñ¥Ïöî</span>'}</div>
    </div>
  `;

  const winBanner = st.ended && st.winner ? (()=>{ 
    const w = (wmPlayers_||{})[st.winner];
    const wn = w ? (w.name||'Ïö∞ÏäπÏûê') : 'Ïö∞ÏäπÏûê';
    return `<div class="wmWin">üèÜ ${escapeHtml(wn)} Ïö∞Ïäπ!</div>`;
  })() : '';

  const html = `
    <div class="wmWrap wmMini">
      <div class="wmHeader">
        <div class="wmTitle">üé≤ Î∂ÄÎ£®ÎßàÎ∏î(Í∏ÄÏûêÏàò) üèÅ</div>
        <div class="wmSub">10Î∞îÌÄ¥ ÏÑ†Ï∞© ÎòêÎäî ÎßàÏßÄÎßâ ÏÉùÏ°¥! ¬∑ ÏãúÏûë ${wmFmt_(WM_START_MONEY_)}Ïûê</div>
      </div>

      ${winBanner}

      <div class="wmHud">
        <div class="wmTurnPill">
          <span class="wmTurnLabel">ÌòÑÏû¨ ÌÑ¥</span>
          <span class="wmTurnName">${turnPl ? `${escapeHtml(turnPl.name||'')} ${turnPl.token||''}` : 'ÎåÄÍ∏∞'}</span>
        </div>
        <div class="wmControls">
          ${joinBtn}
          ${startBtn}
          ${rollBtn}
          ${loanBtns}
          ${endBtn}
        </div>
      </div>

      ${strip}

      <div class="wmDicePanel">${diceUI}</div>

      <div class="wmBoardArea">
        <div class="wmBoard wmBoardScaled wmMiniBoard">
          ${cellsHtml}
          ${tokenHtml}
          <div class="wmCenterLogo">BOOM MARBLE</div>
        </div>
      </div>

      <div class="wmFoot">
        <div class="wmRulePill">üìå ÎÇ¥ Ï∞®Î°ÄÏóêÎßå Íµ¥Î¶¨Í∏∞</div>
        <div class="wmRulePill">üèÅ START ÌÜµÍ≥º +${wmFmt_(WM_PASS_START_BONUS_)}Ïûê</div>
        <div class="wmRulePill">üè¶ ÎåÄÏ∂ú ${WM_MAX_LOANS_}Ìöå</div>
        <div class="wmRulePill">üèóÔ∏è Í∞ôÏùÄ ÎïÖ 2~3Î≤à Î∞üÏúºÎ©¥ ÎûúÎìúÎßàÌÅ¨ ÏóÖ!</div>
      </div>
    </div>
  `;

  showOverlayHtml('üé≤ Î∂ÄÎ£®ÎßàÎ∏î(Í∏ÄÏûêÏàò) üèÅ', html, true);
  try{ wmBindWheelZoom_(); }catch(e){}
  try{ wmFitBoard_(); }catch(e){}
  try{ wmKickDiceAnim_(); }catch(e){}
}

function openMarble_(){
  if(!sessionId) return;

  // ‚úÖ Í∞ôÏùÄ ÏàòÎã§Î∞©(sessionId)ÏóêÏÑú Î™®Îëê Ìïú Î∞©ÏúºÎ°ú ÏûÖÏû• (ÏÉàÏ∞Ω/ÏÉàÌÉ≠)
  // ‚úÖ GitHub Pages(Ï†ïÏ†Å Ìò∏Ïä§ÌåÖ)Î°ú Ïó¥Ïñ¥ÏÑú GAS/Drive Í∂åÌïú Î¨∏Ï†úÎ•º Ï†úÍ±∞
  const MARBLE_URL_ = 'https://magammm1009.github.io/mmaabbbb1009/'; // ÎÅùÏóê / Ïú†ÏßÄ Í∂åÏû•
  const sid = String(sessionId || '').trim();
  const gs  = 'G' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).slice(2,8).toUpperCase();

  // Ìï≠ÏÉÅ ÏÉà Ìåê: sid/room + gs(Í≤åÏûÑÏÑ∏ÏÖò) Ìè¨Ìï®
  const src = `${MARBLE_URL_}?sid=${encodeURIComponent(sid)}&room=${encodeURIComponent(sid)}&gs=${encodeURIComponent(gs)}`;

  // üîî ÏãúÏûë ÏãúÏä§ÌÖú Î©îÏãúÏßÄ(Î≤ÑÌäº ÌÅ¥Î¶≠ ÏàúÍ∞Ñ)
  try{ pushSystem_(`üé≤ Î∂ÄÎ£®ÎßàÎ∏îÏù¥ ÏãúÏûëÎêêÏñ¥Ïöî! (Î∞©: ${sid})`); }catch(e){}

  // ÌåùÏóÖ Ï∞®Îã® ÎåÄÎπÑ: ÏÉàÏ∞ΩÏù¥ ÎßâÌûàÎ©¥ Î™®Îã¨Î°ú ÎßÅÌÅ¨ ÏïàÎÇ¥
  const w = window.open(src, '_blank', 'noopener,noreferrer');
  if(!w){
    showOverlayHtml('üé≤ Î∂ÄÎ£®ÎßàÎ∏î', `
      <div class="hint" style="margin:8px 0 10px;">
        Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏÉàÏ∞ΩÏù¥ Ï∞®Îã®ÎêòÏñ¥ ÎßÅÌÅ¨Î°ú ÏïàÎÇ¥Ìï†Í≤åÏöî. (ÌåùÏóÖ ÌóàÏö©ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú ÏÉàÏ∞ΩÏù¥ Ïó¥Î†§Ïöî!)
      </div>
      <a href="${src}" target="_blank" rel="noopener noreferrer"
         class="btn" style="display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px dashed var(--line);border-radius:999px;background:var(--chip);text-decoration:none;">
        üé≤ Î∂ÄÎ£®ÎßàÎ∏î ÏÉàÏ∞Ω Ïó¥Í∏∞
      </a>
    `, true);
  }
}


// =====================
// Writer Marble: window ‚Üî window bridge (postMessage)
// - Í≤åÏûÑÏ∞Ω(index.html)ÏóêÏÑú GAME_OVERÎ•º Î≥¥ÎÇ¥Î©¥, ÏàòÎã§Î∞©Ïóê ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ°ú Í∏∞Î°ù
// =====================
(function installMarbleBridge_(){
  if (window.__marbleBridgeInstalled) return;
  window.__marbleBridgeInstalled = true;

  window.addEventListener('message', (ev)=>{
    try{
      const d = ev && ev.data;
      if (!d || d.source !== 'WRITER_MARBLE') return;

      if (d.type === 'GAME_OVER'){
        const winner = (d.winnerName || d.winnerId || 'Ïïå Ïàò ÏóÜÏùå');
        const emoji  = (d.winnerEmoji || 'üèÜ');
        const reason = (d.reason || 'Í≤åÏûÑ Ï¢ÖÎ£å');
        try{ pushSystem_(`${emoji} Î∂ÄÎ£®ÎßàÎ∏î Ï¢ÖÎ£å! ÏäπÏûê: ${winner} (${reason})`); }catch(e){}
      }
    }catch(e){}
  });
})();




// --- Safe wrappers: auth + init Î≥¥Ïû•
async function marbleEnsure_(){
  if (!sessionId) throw new Error('no session');
  await window.FB.ensureAnonAuth();
  try{ window.__presenceId = (window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || ''; }catch(e){}
  if (!wmPlayersUnsub_ || !wmStateUnsub_) initWriterMarble_(sessionId);
  await wmEnsureInit_(sessionId);
}

async function marbleJoinSafe_(){ try{ await marbleEnsure_(); await wmJoin_(); renderWriterMarbleOverlay_(); }catch(e){} }
async function marbleLeaveSafe_(){ try{ await marbleEnsure_(); await wmLeaveMe_(); renderWriterMarbleOverlay_(); }catch(e){} }
async function marbleRollSafe_(){ try{ await marbleEnsure_(); await wmRoll_(); }catch(e){} }
async function marbleStartSafe_(){ try{ await marbleEnsure_(); await wmStartGame_(); }catch(e){} }
async function marbleEndSafe_(){ try{ await marbleEnsure_(); await wmEndGame_(); }catch(e){} }
async function wmLoanSafe_(){ try{ await marbleEnsure_(); await wmLoan_(); }catch(e){} }
async function wmRepaySafe_(){ try{ await marbleEnsure_(); await wmRepay_(); }catch(e){} }

window.openMarble_ = openMarble_;
window.marbleJoinSafe_ = marbleJoinSafe_;
window.marbleLeaveSafe_ = marbleLeaveSafe_;
window.marbleRollSafe_ = marbleRollSafe_;
window.marbleStartSafe_ = marbleStartSafe_;
window.marbleEndSafe_ = marbleEndSafe_;
window.wmLoanSafe_ = wmLoanSafe_;
window.wmRepaySafe_ = wmRepaySafe_;


const GUIDE_TEXT_ = `üí£ÏûêÏ†ïÏóê Ìè≠ÌååÎêòÎäî ÏàòÎã§Î∞©ÏûÖÎãàÎã§üí£

24ÏãúÍ∞ÑÏùò ÎåÄÌôî Í∏∞Î°ùÎßå Ïú†ÏßÄÎêòÎã§Í∞Ä Î¶¨ÏÖãÎêòÎäî Î∞©Ïù¥ÏóêÏöî

üìåÍ≥µÏßÄ ÏòÜÏóê ÏüàÍ∑º Î≤ÑÌäºÎì§ÏùÑ ÎàÑÎ•¥Î©¥ Í∞ÄÏù¥Îìú ÌôïÏù∏ Í∞ÄÎä•ÌïòÍ≥†,
Ï±óÏ∞Ω Í∏∏Ïù¥ÏôÄ Í∏ÄÏî® Ï°∞Ï†àÎèÑ Í∞ÄÎä•Ìï©ÎãàÎã§.

!‚ò∞Î©îÎâ¥ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏãúÎ©¥ÏàòÎã§Î∞©Ïóê Í≥ÑÏã† ÏûëÍ∞ÄÎãòÎì§Í≥º 
üéµBGMÏùÑ Í∞ôÏù¥ Îì§ÏùÑ Ïàò ÏûàÏñ¥Ïöî!
üéß DJÎäî ÎàÑÍµ¨ÎÇò Í∞ÄÎÑù!
ÎåÄÏã† BGM Í∞ôÏù¥ Îì£Í∏∞Î•º ÌóàÏö©Ìï¥Ïïº ÎÖ∏ÎûòÍ∞Ä Îì§Î¶ΩÎãàÎã§ ><

üìåÏûëÏóÖÌïòÏãúÎã§Í∞Ä Ïâ¨Í≥† Ïã∂Í±∞ÎÇò, 
üìåÏó¨Ïú†Í∞Ä ÏûàÏñ¥ÏÑú ÏûëÍ∞ÄÎãòÎì§Ïù¥Îûë ÏÜåÌÜµÌïòÍ≥† Ïã∂Í±∞ÎÇò,
üìåÍ∞ÄÎ≥çÍ≤å ÏïÑÏ†êÏ†ÄÎ©îÏ∂î Í∞ôÏùÄ Í≤å Î∞õÍ≥† Ïã∂ÏùÑ ÎïåÎÇò!
üìåÍΩâ ÎßâÌòÄÏÑú ÏàòÎã§Î•º Ï¢Ä Îñ®Í≥† Ïã∂ÏùÑÎïå Îì±Îì±Îì±Îì± 
üìåÏûêÏú†Î°≠Í≤å Î™®Ïó¨ÏÑú ÏàòÎã§Î•º Îñ†ÏãúÎ©¥ Îê©ÎãàÎã§.

üö´Ïïà ÎêòÎäî Í≤Éüö´
üìåÎö±Ï≠ùÌïú Î∂àÌñâÎ∞∞ÌãÄ
üìåÏïàÎ¨ºÏïàÍ∂Å TMI
üìåÍ≥ºÎèÑÌïú Ïã†ÏÉÅÏ∫êÎ¨ªÍ∏∞
üìåÎ∂àÎ™ÖÌôïÌïú Ïπ¥ÎçîÎùº ÌÜµÏã† Ï†ÑÌåå

üå∏Í∑∏ Ïô∏ÏóêÎäî ÏûêÏú†Î°≠Í≤å ÏÜåÌÜµÌïòÏãúÎ©¥ Îê©ÎãàÎã§üå∏
üìåPC/Î™®Î∞îÏùº ÏÉÅÍ¥Ä ÏóÜÏù¥ ÏÇ¨Ïö© Í∞ÄÎä•
üìåÎ∂àÌé∏Ìïú Ï†êÏù¥ ÏûàÍ±∞ÎÇò Í∏∞Îä•ÏùÑ ÏÉàÎ°ú ÎÑ£Í≥† Ïã∂ÏùÄ Í≤å ÏûàÎã§Î©¥
üìåÍµ¨ÌòÑ Í∞ÄÎä•Ìïú ÏÑ†ÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÄÎä•ÌïòÎãà
üìåÎ∞îÎ°ú ÎßêÏîÄÌï¥ Ï£ºÏãúÍ∏∞~

üå∏Ìé∏ÌïòÍ≤å Í∞†ÌÜ° Ï£ºÏã≠ÏÖî!üå∏


üí° ÏÇ¨Ïö©Î≤ï Îπ†Î•∏ Í∞ÄÏù¥Îìú

 1) Ï±ÑÌåÖ
‚Ä¢ Enter = Ï†ÑÏÜ° / Shift+Enter = Ï§ÑÎ∞îÍøà
‚Ä¢ ÎãâÎÑ§ÏûÑ Î®ºÏ†Ä ÏÑ§Ï†ï!
      
2) Î™ÖÎ†πÏñ¥
‚Ä¢ /Î™ÖÎ†πÏñ¥ ÎòêÎäî /ÎèÑÏõÄÎßê : Ï†ÑÏ≤¥ Î™©Î°ù
 ‚Ä¢ /ÏôÑÍ≤∞, /Ï∂ïÌïò, /ÌïòÌä∏, /Î∞òÏßù, /ÎààÍΩÉ, /Î∞ïÏàò ‚Ä¶ (Ïù¥ÌéôÌä∏!)
      
3) ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§

‚Ä¢ ÏÉÅÎã®Ïùò ‚å®Ô∏è Î†àÏù¥Ïä§ Î≤ÑÌäº ‚Üí ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù ‚Üí ÏãúÏûë!
‚Ä¢ Î¨∏Íµ¨Í∞Ä Îú®Î©¥, ÏïÑÎûò Î†àÏù¥Ïä§ ÏûÖÎ†•Ïπ∏Ïóê Í∑∏ÎåÄÎ°ú ÌÉÄÏù¥ÌïëÌïòÏÑ∏Ïöî.
‚Ä¢ 1Îì±ÏóêÍ≤åÎäî Ìè≠Ï£Ω + Î∞òÏßù + Î∂êÏóÖÏù¥ ÌÑ∞ÏßëÎãàÎã§‚ú®

üìåÏù¥ Î∞©ÏùÄ ÏûêÏ†ï Ìè≠Ìåå Ïãú ÏÉà ÏÑ∏ÏÖòÏúºÎ°ú Î∞îÎÄåÍ≥†, ÎåÄÌôîÎäî Ï†ÄÏû•ÎêòÏßÄ ÏïäÏïÑÏöî.`;

function showGuide_(){
  const html = `
    <div class="guideWrap">
      <div class="guideHead">
        <div class="guideBadge">üß≠ GUIDE</div>
        <div class="guideTitle">ÏàòÎã§Î∞© Í∞ÄÏù¥Îìú</div>
      </div>
      <pre class="guidePre">${escapeHtml(GUIDE_TEXT_)}</pre>
    </div>
  `;
  showOverlayHtml('üß≠ Í∞ÄÏù¥Îìú', html, true);
}
function computePresenceFromConn_(val){
    const now = Date.now();
    const items = [];
    const obj = val || {};
    for (const uid of Object.keys(obj)){
      const conns = obj[uid] || {};
      let best = null;
      for (const cid of Object.keys(conns)){
        const v = conns[cid];
        if (!v || !v.ts) continue;
        const ts = Number(v.ts);
        if (!Number.isFinite(ts)) continue;
        if ((now - ts) > PRESENCE_STALE_MS) continue;
        if (!best || ts > best.ts){
          best = { uid, name: String(v.name || 'ÏùµÎ™Ö').trim().slice(0,12), ts };
        }
      }
      if (best) items.push(best);
    }
    // Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ disambiguate
    const counts = {};
    items.forEach(it => counts[it.name] = (counts[it.name]||0) + 1);
    const names = items.map(it => (counts[it.name] > 1) ? `${it.name}¬∑${String(it.uid).slice(-4)}` : it.name);
    return { count: names.length, names };
  }

  // =====================
  // Notice (Firebase)
  // =====================
  function initNotice_(roomId){
    // rooms/<roomId>/notice = { text, updatedAt, by }
    try{
      if (noticeUnsub_) noticeUnsub_();
    }catch(e){}
    noticeUnsub_ = null;

    const p = NOTICE_PATH_(roomId);
    const noticeRef = window.FB.ref(window.FB.db, p);

    noticeUnsub_ = window.FB.onValue(noticeRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || {}) : {};
      noticeCache_ = {
        text: String(v.text || ''),
        updatedAt: Number(v.updatedAt || 0),
        by: String(v.by || '')
      };
      updateNoticePreview_();
      maybePopupNotice_();
    });
  }

  function firstLine_(t){
    const s = String(t || '').replace(/\r/g,'').trim();
    if (!s) return '';
    return s.split('\n')[0].trim();
  }

  function updateNoticePreview_(){
    const t = (noticeCache_.text || '').trim();
    const pv = $('noticePreview');
    if (pv) pv.textContent = t ? firstLine_(t) : 'Í≥µÏßÄ ÏóÜÏùå';
    const ts = $('noticeTs');
    if (ts) ts.textContent = fmtNoticeTs_(noticeCache_.updatedAt);
  }

  function maybePopupNotice_(){
    const t = (noticeCache_.text || '').trim();
    if (!t){
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      return;
    }

    const lastSeen = Number(localStorage.getItem(NOTICE_LS_KEY_) || 0);
    const updatedAt = Number(noticeCache_.updatedAt || 0);

    // ‚úÖ ÏÉà Í≥µÏßÄ: ÏûêÎèô ÌåùÏóÖ ÎåÄÏã† "ÌïÄ Îã¨ÎûëÎã¨Îûë"
    if (updatedAt && updatedAt > lastSeen){
      try{ $('btnNoticePin')?.classList.add('pinNew'); }catch(e){}
    }else{
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
    }
  }

  
  // =====================
  // Notice (Firebase) + Admin-only edit
  // =====================
  // ‚úÖ Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏(Ìï¥Ïãú) ÏÑ§Ï†ï:
  // 1) ÏïÑÎûò NOTICE_ADMIN_PW_SHA256_ Ïóê SHA-256 Ìï¥Ïãú(ÏÜåÎ¨∏Ïûê 64ÏûêÎ¶¨)Î•º ÎÑ£Ïñ¥ Ï£ºÏÑ∏Ïöî.
  // 2) Ìï¥ÏãúÎäî Î∏åÎùºÏö∞Ï†Ä ÏΩòÏÜîÏóêÏÑú:  await sha256Hex_('ÏõêÌïòÎäîÎπÑÎ≤à')  Î°ú ÏâΩÍ≤å ÏñªÏùÑ Ïàò ÏûàÏñ¥Ïöî.
  const NOTICE_ADMIN_PW_SHA256_ = '5d6d5393f040bd92c36b7a791f80b1c8827125715a392c57725f74df89458df7'; // <- Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞
  const NOTICE_ADMIN_SS_KEY_ = 'VENT_NOTICE_ADMIN_OK_V1';

  async function sha256Hex_(str){
    const enc = new TextEncoder().encode(String(str ?? ''));
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,'0')).join('');
  }
  // ‚úÖ ÏΩòÏÜî/Îã§Î•∏ Ìï∏Îì§Îü¨ÏóêÏÑú Ïì∞ÎèÑÎ°ù Ï†ÑÏó≠ ÎÖ∏Ï∂ú
  window.sha256Hex_ = sha256Hex_;
  window.makeNoticeHash = async function(pw){
    const h = await sha256Hex_(pw);
    console.log(h);
    return h;
  };


  function isNoticeAdmin_(){
    try{ return localStorage.getItem(NOTICE_ADMIN_SS_KEY_) === '1'; }catch(e){ return false; }
  }

  async function noticeEnsureAdmin_(){
    if (isNoticeAdmin_()) return true;

    // Ìï¥ÏãúÍ∞Ä ÎπÑÏñ¥ ÏûàÏúºÎ©¥(ÏÑ§Ï†ï Ï†Ñ), Ìé∏ÏßëÏùÑ ÎßâÏäµÎãàÎã§.
    if (!NOTICE_ADMIN_PW_SHA256_){
      alert('‚ö†Ô∏è Í≥µÏßÄ Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏(Ìï¥Ïãú)Í∞Ä ÏïÑÏßÅ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\nÏΩîÎìúÏùò NOTICE_ADMIN_PW_SHA256_ Í∞íÏùÑ Î®ºÏ†Ä Ï±ÑÏõå Ï£ºÏÑ∏Ïöî.');
      return false;
    }

    const pw = prompt('üîí Í≥µÏßÄ ÏûëÏÑ±ÏùÄ Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.\nÍ¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.');
    if (pw == null) return false;

    try{
      const h = await sha256Hex_(pw);
      if (h === NOTICE_ADMIN_PW_SHA256_){
        try{ localStorage.setItem(NOTICE_ADMIN_SS_KEY_, '1'); }catch(e){}
        alert('‚úÖ Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§.');
        return true;
      }
    }catch(e){}

    alert('‚ùå ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÎßûÏßÄ ÏïäÏäµÎãàÎã§.');
    return false;
  }

  function fmtNoticeTs_(ms){
    const n = Number(ms || 0);
    if (!n) return '‚Äî';
    try{
      const d = new Date(n);
      // ÌïúÍµ≠Ïãù Î≥¥Í∏∞ Ï¢ãÍ≤å
      return d.toLocaleString('ko-KR', { hour12:false });
    }catch(e){
      return String(n);
    }
  }

  function noticeViewHtml_(){
    const t = (noticeCache_.text || '').trim();
    const meta = `ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${fmtNoticeTs_(noticeCache_.updatedAt)} ¬∑ ÏûëÏÑ±Ïûê: ${escapeHtml((noticeCache_.by || '')) || '‚Äî'}`;
    const body = escapeHtml(t || 'Í≥µÏßÄ ÏóÜÏùå');
    const adminHint = isNoticeAdmin_()
      ? `<button class="miniBtn" type="button" onclick="window.noticeStartEdit_()">‚úèÔ∏è Í≥µÏßÄ ÏàòÏ†ï</button>`
      : `<button class="miniBtn" type="button" onclick="window.noticeStartEdit_()">üîí Í¥ÄÎ¶¨Ïûê Í≥µÏßÄ ÏûëÏÑ±</button>`;

    return `
      <div class="noticeBox">
        <div class="noticeMeta">${meta}</div>
        <div class="noticeText">${body}</div>
        <div class="noticeActions">
          ${adminHint}
        </div>
      </div>
    `;
  }

  function noticeEditHtml_(initial){
    const safe = escapeHtml(String(initial ?? ''));
    return `
      <div class="noticeBox">
        <div class="noticeMeta">Í¥ÄÎ¶¨Ïûê Î™®Îìú ¬∑ Í≥µÏßÄÎ•º ÏûëÏÑ±/ÏàòÏ†ïÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</div>
        <textarea id="noticeEditArea" class="noticeEditArea" placeholder="Í≥µÏßÄ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.\n(Ï§ÑÎ∞îÍøà Í∞ÄÎä•)">${safe}</textarea>
        <div class="noticeActions">
          <button class="miniBtn" type="button" onclick="window.noticeSave_()">üíæ Ï†ÄÏû•</button>
          <button class="miniBtn" type="button" onclick="window.noticeCancelEdit_()">Ï∑®ÏÜå</button>
        </div>
        <div class="noticeHelp">‚Äª Ï†ÄÏû•ÌïòÎ©¥ Î™®Îì† Ï†ëÏÜçÏûêÏóêÍ≤å ‚ÄòÏÉà Í≥µÏßÄ‚ÄôÎ°ú ÌëúÏãúÎêòÍ≥†, Îã§ÏùåÏóê Îì§Ïñ¥Ïò® Î∂ÑÎèÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</div>
      </div>
    `;
  }

  async function noticeStartEdit_(){
    const ok = await noticeEnsureAdmin_();
    if (!ok) return;
    showOverlayHtml('üìå Í≥µÏßÄ (Í¥ÄÎ¶¨Ïûê)', noticeEditHtml_((noticeCache_.text || '').trim()));
  }

  async function noticeSave_(){
    const ta = document.getElementById('noticeEditArea');
    if (!ta) return;
    const textVal = String(ta.value || '').replace(/\r/g,'').trim();
    try{
      if (!sessionId) return;
      await window.FB.ensureAnonAuth();
      const ref_ = window.FB.ref(window.FB.db, NOTICE_PATH_(sessionId));
      const payload = { text: textVal, updatedAt: Date.now(), by: serverName_().slice(0,12) };
      await window.FB.set(ref_, payload);
      // Ï†ÄÏû• ÏÑ±Í≥µ -> Î≥¥Í∏∞Î°ú
      showOverlayHtml('üìå Í≥µÏßÄ', noticeViewHtml_());
    }catch(e){
      console.warn('noticeSave failed', e);
      alert('Í≥µÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨/Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.');
    }
  }

  function noticeCancelEdit_(){
    showOverlayHtml('üìå Í≥µÏßÄ', noticeViewHtml_());
  }

  // Ï†ÑÏó≠ Î∞îÏù∏Îî©(Ïò§Î≤ÑÎ†àÏù¥Ïùò inline onclickÏóêÏÑú ÏÇ¨Ïö©)
  window.noticeStartEdit_ = noticeStartEdit_;
  window.noticeSave_ = noticeSave_;
  window.noticeCancelEdit_ = noticeCancelEdit_;

  function showNoticeManual_(){
    openNotice_();
  }

  function openNotice_(){
    const t = (noticeCache_.text || '').trim();
    const updatedAt = Number(noticeCache_.updatedAt || 0);
    if (!t){
      showOverlay('üìå', 'Îì±Î°ùÎêú Í≥µÏßÄÍ∞Ä ÏóÜÏñ¥Ïöî.');
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      return;
    }

    // Ïó¥ ÎïåÎäî ÏûêÎèô "ÏùΩÏùå" Ï≤òÎ¶¨ X ‚Üí Îã´ÏùÑ Îïå Ï≤òÎ¶¨
    showOverlayHtml('üìå', noticeViewHtml_());

    // Îã´Îäî ÏàúÍ∞Ñ ÏùΩÏùå Ï≤òÎ¶¨ + ÌïÄ ÌùîÎì§Î¶º Ï¢ÖÎ£å
    const oldHide = window.hideOverlay;
    window.hideOverlay = function(){
      try{
        if (updatedAt) localStorage.setItem(NOTICE_LS_KEY_, String(updatedAt));
      }catch(e){}
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      window.hideOverlay = oldHide;
      oldHide();
    };
  }
// =====================
// Identity (nickname -> emoji/color)
// =====================
const LS_PROFILE_PREFIX = 'VENT_NICK_PROFILE_V1:';
const NICK_EMOJIS = ['üê£','üê∞','üê±','üê∂','ü¶ä','üêº','üêØ','üê∏','üêµ','üêª','üêπ','ü¶Å','ü¶Ñ','üêô','ü¶ã','üß∏','üçÄ','üåô','‚≠ê','üî•','üí´','üéÄ','üçì','üçë','üçã','üçá','üçâ','ü•ê','üçô','üçú','‚òï','üéß','üéÆ','üìö','‚úçÔ∏è','üé¨'];
const NICK_COLORS = ['#ff4d6d','#ff7a00','#ffb703','#38b000','#00b4d8','#1d4ed8','#6d28d9','#b5179e','#ef476f','#06d6a0','#118ab2','#ffd166'];

function hashStr_(s){
  const str = String(s || '');
  let h = 2166136261;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
  }
  return h >>> 0;
}

function randPick_(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getNickProfile_(name, createIfMissing){
  const nm = String(name || '').trim().slice(0,12) || 'ÏùµÎ™Ö';
  const key = LS_PROFILE_PREFIX + nm;
  try{
    const raw = localStorage.getItem(key);
    if (raw){
      const obj = JSON.parse(raw);
      if (obj && obj.emoji && obj.color) return obj;
    }
  }catch(e){}

  // fallback deterministic (if not creating)
  if (!createIfMissing){
    const h = hashStr_(nm);
    return { emoji: NICK_EMOJIS[h % NICK_EMOJIS.length], color: NICK_COLORS[h % NICK_COLORS.length] };
  }

  const prof = { emoji: randPick_(NICK_EMOJIS), color: randPick_(NICK_COLORS) };
  try{ localStorage.setItem(key, JSON.stringify(prof)); }catch(e){}
  return prof;
}

function myUid_(){ return window.FB?.auth?.currentUser?.uid || null; }
function myProfile_(){ return getNickProfile_(myName(), true); }

function hexToRgba_(hex, a){
  const h = String(hex || '').replace('#','').trim();
  if (h.length !== 6) return `rgba(0,0,0,${a})`;
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

// =====================
// System message helper
// =====================

async function pushEvent_(payload){
  if (!sessionId) return;
  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
    const msgRef = window.FB.push(root);
    const p = payload || {};
    p.ts = p.ts || Date.now();
    if (!p.type) p.type = 'event';
    await window.FB.set(msgRef, p);
  }catch(e){
    console.warn('pushEvent failed', e);
  }
}

function launchFireworks_(kind, byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const title = document.createElement('div');
  title.className = 'fxTitle';
  const who = byName ? ` ¬∑ ${byName}` : '';
  title.textContent = (kind === 'complete') ? `üéÜ ÏôÑÍ≤∞!${who}` : (kind === 'race') ? `‚å®Ô∏è ÌÉÄÏù¥Ìïë Î†àÏù¥Ïä§ üèÅ${who}` : (kind === 'acid') ? `‚òî ÏÇ∞ÏÑ±ÎπÑ TOP3!${who}` : `üéâ Ï∂ïÌïò!${who}`;
  document.body.appendChild(title);

  const W = window.innerWidth;
  const H = window.innerHeight;

  function rand(min, max){ return min + Math.random() * (max - min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const colors = ['#ff4d6d','#ff7a00','#ffb703','#38b000','#00b4d8','#1d4ed8','#6d28d9','#b5179e','#06d6a0','#ffd166'];

  const bursts = 6;
  const sparksPer = 26;

  for (let b=0;b<bursts;b++){
    const cx = rand(W*0.18, W*0.82);
    const cy = rand(H*0.20, H*0.55);

    for (let i=0;i<sparksPer;i++){
      const sp = document.createElement('div');
      sp.className = 'spark';
      sp.style.left = cx + 'px';
      sp.style.top = cy + 'px';
      sp.style.background = pick(colors);

      const ang = rand(0, Math.PI*2);
      const dist = rand(80, 240);
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist;

      sp.style.setProperty('--dx', `${dx}px`);
      sp.style.setProperty('--dy', `${dy}px`);

      sp.style.animationDelay = `${rand(0, 220)}ms`;
      sp.style.animationDuration = `${rand(900, 1400)}ms`;

      layer.appendChild(sp);
    }
  }

  setTimeout(()=>{
    try{ layer.remove(); }catch(e){}
    try{ title.remove(); }catch(e){}
  }, 1700);
}


function launchHearts_(byName){
  const layer = document.createElement('div');
  layer.className = 'heartLayer';
  document.body.appendChild(layer);

  // small title pill (reuse fxTitle styling if exists)
  const title = document.createElement('div');
  title.className = 'fxTitle';
  const who = byName ? ` ¬∑ ${byName}` : '';
  title.textContent = `üíó ÏûÖÏû•!${who}`;
  document.body.appendChild(title);

  const W = window.innerWidth;
  const H = window.innerHeight;

  function rand(min, max){ return min + Math.random() * (max - min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const hearts = ['üíó','üíñ','üíò','üíï','üíû','üíì','üíù'];
  const bursts = 28;

  for (let i=0;i<bursts;i++){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = pick(hearts);

    const cx = W * 0.5 + rand(-W*0.18, W*0.18);
    const cy = H * 0.78 + rand(-40, 40);
    h.style.left = cx + 'px';
    h.style.top  = cy + 'px';

    const ang = rand(-Math.PI*0.85, -Math.PI*0.15); // upward-ish
    const dist = rand(120, 320);
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    const rot = rand(-18, 18);

    h.style.setProperty('--dx', `${dx}px`);
    h.style.setProperty('--dy', `${dy}px`);
    h.style.setProperty('--rot', `${rot}deg`);
    h.style.animationDelay = `${rand(0, 220)}ms`;
    h.style.animationDuration = `${rand(1100, 1600)}ms`;
    h.style.fontSize = `${rand(16, 26)}px`;

    layer.appendChild(h);
  }

  setTimeout(()=>{
    try{ layer.remove(); }catch(e){}
    try{ title.remove(); }catch(e){}
  }, 1700);
}



function launchHeartsNearEl_(el){
  try{
    if (!el) return;
    const rect = el.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + Math.min(rect.height, 64) / 2;

    const layer = document.createElement('div');
    layer.className = 'heartLayer';
    document.body.appendChild(layer);

    function rand(min, max){ return min + Math.random() * (max - min); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    const hearts = ['üíó','üíñ','üíò','üíï','üíû','üíì','üíù','‚ù§Ô∏è'];
    const bursts = 18;

    for (let i=0;i<bursts;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      h.textContent = pick(hearts);

      h.style.left = (cx + rand(-28, 28)) + 'px';
      h.style.top  = (cy + rand(-10, 10)) + 'px';

      const ang = rand(-Math.PI*0.95, -Math.PI*0.10);
      const dist = rand(60, 160);
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist;
      const rot = rand(-22, 22);

      h.style.setProperty('--dx', `${dx}px`);
      h.style.setProperty('--dy', `${dy}px`);
      h.style.setProperty('--rot', `${rot}deg`);
      h.style.animationDelay = `${rand(0, 140)}ms`;
      h.style.animationDuration = `${rand(900, 1200)}ms`;
      h.style.fontSize = `${rand(14, 24)}px`;

      layer.appendChild(h);
    }

    setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1400);
  }catch(e){
    console.warn('launchHeartsNearEl failed', e);
  }
}





// =====================
// FX2 preset mapping (shared for everyone)
// =====================
function launchFx2_(kind, byName){
  const k = String(kind || '').trim();

  const presets = {
    // new + existing
    welcome:  { emojis:['üéÄ','‚ú®','üíó','üåô','‚≠ê'], mode:'twinkle', title:'üéÄ ÌôòÏòÅ' },
    pepper:   { emojis:['üå∂Ô∏è','üî•','üí•','‚ú®'], mode:'pop',     title:'üå∂Ô∏è Í≥†Ï∂îÎ†•' },
    kiss:     { emojis:['üíã','üíó','üíò','üíï','üòò'], mode:'pop', title:'üíã ÎΩÄÎΩÄ' },
    boomup:   { emojis:['üì£','üî•','üí•','‚ú®','üéâ'], mode:'pop', title:'üì£ Î∂êÏóÖ' },
    confetti: { emojis:['üéâ','üéä','‚ú®','‚≠ê','üíó'], mode:'pop', title:'üéä Ï∂ïÌïò' },
    warning:  { emojis:['‚ö†Ô∏è','üö®','üí•'], mode:'twinkle',     title:'‚ö†Ô∏è Í≤ΩÍ≥†', shake:true },
    dance:    { emojis:['üï∫','üíÉ','üéµ','üé∂','‚ú®'], mode:'pop', title:'üï∫ ÎåÑÏä§' },
    deadline: { emojis:['üìù','üìÑ','üßæ','üí∏','üòµ‚Äçüí´','‚åõ'], mode:'rain', title:'üßæ ÎßàÍ∞ê' },
    hello:    { emojis:['üëã','‚ú®','üíó'], mode:'twinkle',      title:'üëã ÏïàÎÖïÌïòÏÑ∏Ïöî' },
    bye:      { emojis:['üåô','‚≠ê','‚ú®','üëã'], mode:'twinkle',  title:'üåô ÍµøÎ∞îÏù¥' },
    nod:      { emojis:['üëç','üëå','‚úÖ','‚ú®'], mode:'pop',      title:'üëç ÎÅÑÎçï' },
    please:   { emojis:['üôè','ü•∫','üíó','‚ú®'], mode:'twinkle',  title:'üôè Ï†úÎ∞ú' },

    // added now
    shy:      { emojis:['üò≥','üôà','üíó','‚ú®','ü´∂'], mode:'twinkle', title:'üôà ÏàòÏ§ç' },
    reality:  { emojis:['üòÆ‚Äçüí®','ü´•','üå´Ô∏è','üí≠','üóø'], mode:'twinkle', title:'ü´• ÌòÑÌÉÄ' },
    awaken:   { emojis:['‚ö°','‚ú®','üî•','üí´','üåÄ'], mode:'pop', title:'‚ö° Í∞ÅÏÑ±' },
    inspire:  { emojis:['üí°','‚ú®','üß†','üåü','‚ö°'], mode:'twinkle', title:'üí° ÏòÅÍ∞ê' },
    revise:   { emojis:['‚úèÔ∏è','üìé','üìù','üîç','‚ú®'], mode:'rain', title:'‚úèÔ∏è Ìá¥Í≥†' },
    bait:     { emojis:['üß©','ü´¥','üé£','üëÄ','üí¨'], mode:'pop', title:'üß© Îñ°Î∞•' },
    binge:    { emojis:['üöÄ','üìö','üí®','üî•','‚≠ê'], mode:'twinkle', title:'üöÄ Ï†ïÏ£ºÌñâ' },
    serialize:{ emojis:['üñãÔ∏è','üìÜ','‚ú®','üìå','üíó'], mode:'twinkle', title:'üñãÔ∏è Ïó∞Ïû¨' },
    naked:    { emojis:['üöø','ü´ß','üí¶','‚ú®','üôà'], mode:'rain', title:'üöø ÎÇòÏ≤¥ÏÉ§Ïõå' },
  };

  const p = presets[k];
  if (!p){
    // unknown kind -> small sparkle fallback
    launchEmojiBurst_(['‚ú®','üí´','‚≠ê'], 'twinkle', '‚ú®');
    return;
  }
  if (p.shake) shakeScreen_(700);
  launchEmojiBurst_(p.emojis, p.mode, p.title + (byName ? ` ¬∑ ${byName}` : ''));
}

// =====================
// Emoji Burst FX (for new commands)
// =====================
function launchEmojiBurst_(emojis, mode, titleText){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const list = Array.isArray(emojis) && emojis.length ? emojis : ['‚ú®'];
  const kind = String(mode || 'pop');

  // optional title pill
  let title = null;
  if (titleText){
    title = document.createElement('div');
    title.className = 'fxTitle';
    title.textContent = String(titleText);
    document.body.appendChild(title);
  }

  if (kind === 'rain'){
    const n = 34;
    for (let i=0;i<n;i++){
      const e = document.createElement('div');
      e.className = 'fxEmoji snow';
      e.textContent = pick(list);

      const x = rand(10, W-10);
      e.style.left = x + 'px';
      e.style.top  = rand(-60, -10) + 'px';
      e.style.setProperty('--dx', `${rand(-140,140)}px`);
      e.style.setProperty('--dy', `${H + rand(160, 320)}px`);
      e.style.setProperty('--rot', `${rand(-110,110)}deg`);
      e.style.animationDelay = `${rand(0, 560)}ms`;
      e.style.animationDuration = `${rand(2000, 3000)}ms`;
      e.style.fontSize = `${rand(14, 30)}px`;
      layer.appendChild(e);
    }
    setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 3400);
    return;
  }

  if (kind === 'twinkle'){
    const n = 36;
    for (let i=0;i<n;i++){
      const e = document.createElement('div');
      e.className = 'fxEmoji twinkle';
      e.textContent = pick(list);
      e.style.left = rand(20, W-20) + 'px';
      e.style.top  = rand(H*0.25, H*0.8) + 'px';
      e.style.setProperty('--rot', `${rand(-35,35)}deg`);
      e.style.animationDelay = `${rand(0, 420)}ms`;
      e.style.fontSize = `${rand(16, 32)}px`;
      layer.appendChild(e);
    }
    setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 1800);
    return;
  }

  // default: pop
  const n = 26;
  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji pop';
    e.textContent = pick(list);
    e.style.left = rand(30, W-30) + 'px';
    e.style.top  = rand(H*0.35, H*0.78) + 'px';
    e.style.setProperty('--dx', `${rand(-180,180)}px`);
    e.style.setProperty('--dy', `${rand(-240,-60)}px`);
    e.style.setProperty('--rot', `${rand(-40,40)}deg`);
    e.style.animationDelay = `${rand(0, 260)}ms`;
    e.style.animationDuration = `${rand(900, 1400)}ms`;
    e.style.fontSize = `${rand(18, 36)}px`;
    layer.appendChild(e);
  }
  setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 1700);
}

// simple screen shake (for warning)
function shakeScreen_(ms){
  const dur = Math.max(300, Math.min(1200, Number(ms||700)));
  document.body.classList.add('shake');
  setTimeout(()=>{ try{ document.body.classList.remove('shake'); }catch(e){} }, dur);
}


// =====================
// Shout ticker (shared)
// =====================// =====================
// Ticker placement (overlay under topbar)
// =====================
function ensureTickerPlaced_(){
  const t = $('ticker');
  if (!t) return;

  // ‚úÖ Ï†ÑÍ¥ëÌåê: ÌôîÎ©¥ Ï§ëÏïô Ïò§Î≤ÑÎ†àÏù¥ (Î†àÏù¥ÏïÑÏõÉ ÏòÅÌñ• 0, Î≤ÑÌäº/ÏûÖÎ†• Ïïà ÎßâÏùå)
  t.style.position = 'fixed';
  t.style.left = '50%';
  t.style.top = '50%';
  t.style.transform = 'translate(-50%, -50%)';
  t.style.width = 'auto';
  t.style.maxWidth = 'calc(100vw - 18px)';
  t.style.pointerEvents = 'none';
}


window.addEventListener('resize', ()=>{ try{ ensureTickerPlaced_(); }catch(e){} }, { passive:true });


function showTicker_(byName, text){
  ensureTickerPlaced_();

  const box = $('ticker');
  if (!box) return;

  const by = String(byName || '').trim().slice(0,12) || 'ÏùµÎ™Ö';
  const msg = String(text || '').trim().slice(0, 140);
  if (!msg) return;

  box.classList.add('show');
  box.innerHTML = '';

  const track = document.createElement('div');
  track.className = 'tickerTrack';

  const badge = document.createElement('span');
  badge.className = 'tickerBadge';
  badge.textContent = `üì£ ${by}Îãò`;

  const t = document.createElement('span');
  t.className = 'tickerText';
  t.textContent = msg;

  track.appendChild(badge);
  track.appendChild(t);
  const pill = document.createElement('div');
  pill.className = 'tickerPill';
  pill.appendChild(track);
  box.appendChild(pill);

  const base = 10; // seconds (Ï°∞Í∏à Îçî Ï≤úÏ≤úÌûà)
  const extra = Math.min(14, Math.max(0, msg.length / 10));
  const dur = base + extra;
  track.style.animationDuration = `${dur}s`;

  setTimeout(()=>{ 
    try{ box.classList.remove('show'); box.innerHTML=''; }catch(e){}
  }, (dur * 1000) + 250);
}


function showSongTicker_(djName){
  // Ï±ÑÌåÖ ÏÉÅÎã® Ïù¥ÌéôÌä∏: "DJÍ∞Ä ÎÖ∏Îûò Ïû¨ÏÉù"Îßå ÌëúÏãú(ÎßÅÌÅ¨/Ï†úÎ™© ÎÖ∏Ï∂ú X)
  ensureTickerPlaced_();
  const box = $('ticker');
  if (!box) return;

  const dj = String(djName || '').trim().slice(0,12) || 'DJ';

  box.classList.add('show');
  box.innerHTML = '';

  const track = document.createElement('div');
  track.className = 'tickerTrack';

  const badge = document.createElement('span');
  badge.className = 'tickerBadge songMode';
  badge.textContent = `üéß DJ ${dj}`;

  const t = document.createElement('span');
  t.className = 'tickerText songMode';
  t.textContent = 'ÎÖ∏Îûò Ïû¨ÏÉù ÏãúÏûë! üé∂';

  track.appendChild(badge);
  track.appendChild(t);

  const pill = document.createElement('div');
  pill.className = 'tickerPill songMode';
  pill.appendChild(track);
  box.appendChild(pill);

  // Ï°∞Í∏à Îçî ÏßßÍ≥† ÌôïÏã§ÌïòÍ≤å
  const dur = 6.5;
  track.style.animationDuration = `${dur}s`;

  setTimeout(()=>{ 
    try{ box.classList.remove('show'); box.innerHTML=''; }catch(e){}
  }, (dur * 1000) + 250);
}

// =====================
// Extra FX commands
// =====================
function launchFx_(kind, byName){
  switch(String(kind||'')){
    case 'hearts': return launchHeartsAll_(byName);
    case 'sparkles': return launchSparkles_(byName);
    case 'snow': return launchSnow_(byName);
    case 'clap': return launchClap_(byName);
    default: return;
  }
}

function launchHeartsAll_(byName){
  const layer = document.createElement('div');
  layer.className = 'heartLayer';
  document.body.appendChild(layer);

  function rand(min,max){ return min + Math.random()*(max-min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const hearts = ['üíó','üíñ','üíò','üíï','üíû','üíì','üíù','‚ù§Ô∏è'];
  const bursts = 42;
  const W = window.innerWidth, H = window.innerHeight;

  for (let i=0;i<bursts;i++){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = pick(hearts);

    const cx = rand(40, W-40);
    const cy = rand(H*0.35, H*0.78);

    h.style.left = cx + 'px';
    h.style.top  = cy + 'px';

    const ang = rand(-Math.PI*1.05, -Math.PI*0.05);
    const dist = rand(80, 220);
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    const rot = rand(-28, 28);

    h.style.setProperty('--dx', `${dx}px`);
    h.style.setProperty('--dy', `${dy}px`);
    h.style.setProperty('--rot', `${rot}deg`);
    h.style.animationDelay = `${rand(0, 220)}ms`;
    h.style.animationDuration = `${rand(950, 1300)}ms`;
    h.style.fontSize = `${rand(16, 28)}px`;

    layer.appendChild(h);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1500);
}

function launchSparkles_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const n = 36;

  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji twinkle';
    e.textContent = '‚ú®';
    e.style.left = rand(20, W-20) + 'px';
    e.style.top  = rand(H*0.25, H*0.8) + 'px';
    e.style.setProperty('--rot', `${rand(-35,35)}deg`);
    e.style.animationDelay = `${rand(0, 420)}ms`;
    e.style.fontSize = `${rand(16, 30)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1700);
}

function launchSnow_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const flakes = 34;
  const snowChars = ['‚ùÑÔ∏è','‚ùÑÔ∏è','‚ùÑÔ∏è','‚ú≥Ô∏è','‚ú¥Ô∏è','‚ú®'];

  for (let i=0;i<flakes;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji snow';
    e.textContent = snowChars[Math.floor(Math.random()*snowChars.length)];
    const x = rand(10, W-10);
    e.style.left = x + 'px';
    e.style.top  = rand(-40, -10) + 'px';
    e.style.setProperty('--dx', `${rand(-120,120)}px`);
    e.style.setProperty('--dy', `${H + rand(120, 260)}px`);
    e.style.setProperty('--rot', `${rand(-90,90)}deg`);
    e.style.animationDelay = `${rand(0, 520)}ms`;
    e.style.animationDuration = `${rand(1800, 2600)}ms`;
    e.style.fontSize = `${rand(14, 28)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 3000);
}

function launchClap_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const n = 22;

  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji pop';
    e.textContent = 'üëè';
    e.style.left = rand(30, W-30) + 'px';
    e.style.top  = rand(H*0.35, H*0.75) + 'px';
    e.style.setProperty('--dx', `${rand(-160,160)}px`);
    e.style.setProperty('--dy', `${rand(-220,-60)}px`);
    e.style.setProperty('--rot', `${rand(-35,35)}deg`);
    e.style.animationDelay = `${rand(0, 260)}ms`;
    e.style.animationDuration = `${rand(900, 1300)}ms`;
    e.style.fontSize = `${rand(18, 34)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1600);
}


async function pushSystem_(text){
  if (!sessionId) return;
  const t = String(text || '').trim();
  if (!t) return;
  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
    const msgRef = window.FB.push(root);
    await window.FB.set(msgRef, { name:'SYSTEM', text: t.slice(0,2000), ts: Date.now(), type:'system' });
  }catch(e){
    console.warn('pushSystem failed', e);
  }
}


// =====================
// Enter announcement (after nickname is set)
// =====================
let enterAnnounced_ = false;

function isNickConfigured_(){
  const v = ($('user')?.value || '').trim();
  if (!v) return false;
  if (v === 'ÏùµÎ™Ö') return false;
  if (!nickConfirmed_) return false;
  if (!validateNick_(v)) return false;
  return true;
}

function maybeAnnounceEnter_(){
  if (enterAnnounced_) return;
  if (!sessionId) return;
  if (!isNickConfigured_()) return; // ÏùµÎ™Ö ÏÉÅÌÉúÎ©¥ ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï Ïù¥ÌõÑÏóê ÏïåÎ¶º
  enterAnnounced_ = true;
  announceEnter_();
}

async function announceEnter_(){
  if (!sessionId) return;

  try{
    await window.FB.ensureAnonAuth();
    const uid = myUid_() || '';
    const nm  = myName().slice(0,12);

    // ÏÑ∏ÏÖò/ÌÉ≠ Îã®ÏúÑÎ°ú 1Î≤àÎßå
    const key = `VENT_ENTER_SENT_V1:${sessionId}:${uid || CLIENT_ID}`;
    if (sessionStorage.getItem(key)) return;
    sessionStorage.setItem(key, '1');

    const msg = `üíó ${nm}ÎãòÏù¥ ÏûÖÏû•ÌïòÏÖ®ÏäµÎãàÎã§!`;
    await pushSystem_(msg);
  }catch(e){
    console.warn('announceEnter failed', e);
  }
}


// =====================
// DJ (shared BGM permission)
// =====================
function activePresenceItems_(){
  const now = Date.now();
  const items = [];
  const obj = presenceLiveVal || {};
  for (const uid of Object.keys(obj)){
    const conns = obj[uid] || {};
    let best = null;
    for (const cid of Object.keys(conns)){
      const v = conns[cid];
      if (!v || !v.ts) continue;
      const ts = Number(v.ts);
      if (!Number.isFinite(ts)) continue;
      if ((now - ts) > PRESENCE_STALE_MS) continue;
      if (!best || ts > best.ts){
        best = { uid, name: String(v.name || 'ÏùµÎ™Ö').trim().slice(0,12), ts };
      }
    }
    if (best) items.push(best);
  }
  items.sort((a,b)=> b.ts - a.ts);
  return items;
}

function isUidOnline_(uid){
  if (!uid) return false;
  return activePresenceItems_().some(it => it.uid === uid);
}

function isDj_(){
  const uid = myUid_();
  return !!(uid && djState_ && djState_.uid && djState_.uid === uid);
}

function djTakeoverAllowed_(){
  if (!djState_ || !djState_.uid) return true;
  return !isUidOnline_(djState_.uid);
}

function setDjUi_(){
  const el = $('djStatus');
  if (!el) return;
  if (!djState_ || !djState_.uid){
    el.textContent = 'ÏóÜÏùå';
  }else{
    el.textContent = `${djState_.name || 'ÏùµÎ™Ö'}${isUidOnline_(djState_.uid) ? '' : ' (Ïò§ÌîÑÎùºÏù∏)'}`;
  }

  const claimBtn = $('btnDjClaim');
  const transferBtn = $('btnDjTransfer');
  if (claimBtn){
    claimBtn.disabled = false; // ÎàÑÍµ¨ÎÇò "DJ Îß°Í∏∞(Í∞ÄÏ†∏Ïò§Í∏∞)" Í∞ÄÎä•
}
  if (transferBtn){
    transferBtn.disabled = !isDj_();
  }
}

function setOverlayResizable_(on){
  try{
    const card = document.querySelector('.overlayCard');
    if (!card) return;
    if (on) card.classList.add('resizable');
    else card.classList.remove('resizable');
  }catch(e){}
}

function showOverlayHtml(title, html, resizable){
  // ‚úÖ game overlays: no inner scroll + hide bottom OK button
  const isGame = /ÌÉÄÏù¥Ìïë\s*Î†àÏù¥Ïä§|‚å®Ô∏è|ÏÇ∞ÏÑ±ÎπÑ|‚òî/i.test(String(title||''));
  try{ setOverlayResizable_(!!resizable && !isGame); }catch(e){}
  try{
    const card = $('overlayCard');
    if (card){
      card.classList.remove('wide');
      if (!isGame){
        if (/Î∂ÄÎ£®ÎßàÎ∏î|writer\s*marble|boom\s*marble/i.test(String(title||''))) card.classList.add('wide');
        if (/Î£®ÎØ∏ÌÅêÎ∏å/i.test(String(title||''))) card.classList.add('wide');
      }
    }
  }catch(e){}
  try{
    const msg = $('ovMsg');
    if (msg){
      msg.classList.toggle('game', !!isGame);
    }
    const ok = $('ovOkBtn');
    if (ok){
      ok.style.display = isGame ? 'none' : '';
    }
  }catch(e){}

  $('ovTitle').textContent = title;
  $('ovMsg').innerHTML = html;
  $('overlay').style.display = 'flex';

  // post-render hooks for games (fit/zoom)
  try{
    setTimeout(()=>{
      try{ if (document.querySelector('.wmBoardWrap')){ wmBindWheelZoom_(); wmFitBoard_(); } }catch(e){}
    }, 0);
  }catch(e){}
}

function initDj_(roomId){
  try{ if (djUnsub_) djUnsub_(); }catch(e){}
  djUnsub_ = null;
  djState_ = null;

  try{
    const djRef = window.FB.ref(window.FB.db, fbDjPath_(roomId));
    djUnsub_ = window.FB.onValue(djRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      if (v && v.uid){
        djState_ = { uid: String(v.uid), name: String(v.name || 'ÏùµÎ™Ö').slice(0,12), ts: Number(v.ts || 0) };
      }else{
        djState_ = null;
      }
      setDjUi_();
    });
  }catch(e){
    console.warn('DJ subscribe failed', e);
  }
}

async function setDj_(uid, name, announceText){
  if (!sessionId) return;
  await window.FB.ensureAnonAuth();
  const djRef = window.FB.ref(window.FB.db, fbDjPath_(sessionId));
  await window.FB.set(djRef, { uid, name, ts: Date.now() });
  if (announceText) await pushSystem_(announceText);
}

async function claimDj_(auto){
  const uid = myUid_();
  if (!uid) return;

  const nm = myName().slice(0,12);

  // DJÍ∞Ä Ïò®ÎùºÏù∏ÏúºÎ°ú Ï°¥Ïû¨Ìï† ÎïåÎäî "Í∞ÄÏ†∏Ïò§Í∏∞" ÌôïÏù∏ÏùÑ Î∞õÎäîÎã§
  if (djState_ && djState_.uid && isUidOnline_(djState_.uid) && !isDj_()){
    const cur = (djState_?.name || 'ÏùµÎ™Ö');
    showOverlay('DJ Í∞ÄÏ†∏Ïò§Í∏∞', `ÌòÑÏû¨ DJ: ${cur}

DJÎ•º Í∞ÄÏ†∏Ïò§Î©¥ ÌòÑÏû¨ DJÏùò Í∂åÌïúÏù¥ Ï¶âÏãú Î≥∏Ïù∏ÏóêÍ≤å ÎÑòÏñ¥ÏòµÎãàÎã§.
Í∞ÄÏ†∏Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?`);

    // overlayÏùò ÌôïÏù∏ Î≤ÑÌäºÏùÑ "Í∞ÄÏ†∏Ïò§Í∏∞"Î°ú ÏûÑÏãú Î≥ÄÍ≤Ω
    const ov = $('overlay');
    const btn = ov ? ov.querySelector('button') : null;
    if (btn){
      const oldOnclick = btn.onclick;
      const oldText = btn.textContent;
      btn.textContent = 'Í∞ÄÏ†∏Ïò§Í∏∞';
      btn.onclick = async ()=>{
        try{
          await setDj_(uid, nm, `üéß DJÍ∞Ä ${cur} ‚Üí ${nm}ÎãòÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. (Í∞ÄÏ†∏Ïò§Í∏∞)`);
        }finally{
          btn.textContent = oldText || 'ÌôïÏù∏';
          btn.onclick = oldOnclick;
          hideOverlay();
        }
      };
    }
    return;
  }

  // DJÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Ïò§ÌîÑÎùºÏù∏Ïù¥Î©¥ Î∞îÎ°ú Îß°Í∏∞
  const msg = auto
    ? `üéß ${nm}ÎãòÏù¥ DJÎ•º Îß°ÏúºÏÖ®ÏäµÎãàÎã§. (DJÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Ïò§ÌîÑÎùºÏù∏Ïù¥Îùº ÏûêÎèô ÏäπÍ≥ÑÎêòÏóàÏäµÎãàÎã§.)`
    : `üéß ${nm}ÎãòÏù¥ DJÎ•º Îß°ÏúºÏÖ®ÏäµÎãàÎã§!`;
  await setDj_(uid, nm, msg);
}

async function transferDjPick_(){
  if (!isDj_()){
    showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Îã§Î•∏ ÏÇ¨ÎûåÏóêÍ≤å ÏñëÎèÑÌï† Ïàò ÏûàÏñ¥. (Î®ºÏ†Ä DJÎ•º Îß°ÏïÑÏ§ò!)');
    return;
  }

  const items = activePresenceItems_().filter(it => it.uid !== myUid_());
  if (!items.length){
    showOverlay('ÏñëÎèÑ Î∂àÍ∞Ä', 'ÏßÄÍ∏à Ï†ëÏÜçÏûê Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò, ÏñëÎèÑÌï† ÏÇ¨ÎûåÏù¥ ÏóÜÏñ¥.');
    return;
  }

  const html = items.map(it => {
    const nm = escapeHtml(it.name);
    const uid = escapeHtml(it.uid);
    return `<button style="width:100%; margin:6px 0; padding:10px 12px; border-radius:12px;" onclick="window.__djTo('${uid}')">üéß ${nm} ÏóêÍ≤å DJ ÏñëÎèÑ</button>`;
  }).join('');

  window.__djTo = async (uid)=>{
    try{
      const to = items.find(x => x.uid === uid);
      if (!to) return;
      const fromName = myName().slice(0,12);
      await setDj_(uid, to.name, `üéß DJÍ∞Ä ${fromName} ‚Üí ${to.name} Î°ú Î≥ÄÍ≤ΩÎêêÏñ¥!`);
      hideOverlay();
    }catch(e){
      console.warn(e);
    }
  };

  showOverlayHtml('DJ ÏñëÎèÑ', html + '<div class="hint" style="margin-top:8px;">‚Ä¢ Î™©Î°ùÏùÄ ÌòÑÏû¨ Ï†ëÏÜçÏûê Í∏∞Ï§ÄÏù¥Ïïº.</div>');
}

// =====================
// BGM Sync (Firebase)
// =====================
function initBgmSync_(roomId){
  try{ if (bgmUnsub_) bgmUnsub_(); }catch(e){}
  bgmUnsub_ = null;
  bgmRemote_ = null;
  bgmLastAppliedKey_ = '';

  try{
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(roomId));
    bgmUnsub_ = window.FB.onValue(bgmRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      bgmRemote_ = v;

      // ‚úÖ ÎÖ∏Îûò Ïû¨ÏÉù ÏãúÏä§ÌÖú Î©îÏãúÏßÄ ÎåÄÏã†: Ï±ÑÌåÖ ÏÉÅÎã® Ïù¥ÌéôÌä∏(Ïã†Í∑ú Ïû¨ÏÉùÎßå)
      try{
        if (v && String(v.kind||'yt') !== 'file' && String(v.state||'') === 'playing'){
          const at = Number(v.startedAt || 0);
          const key = `${String(v.videoId||v.url||'')}-${at}-${String(v.by||'')}`;
          if (at && at >= joinTs_ && key !== bgmAnnouncedKey_){
            bgmAnnouncedKey_ = key;
            showSongTicker_(v.by || 'DJ');
          }
        }
      }catch(e){}

      if (!v){
        setBgmState('Ï§ÄÎπÑ');
        return;
      }

      // UI reflect
      if (v.url && !$('bgmUrl').value) $('bgmUrl').value = v.url;

      // if not allowed yet, show pending
      if (!bgmAllowed_){
        const who = v.by ? ` ¬∑ ${v.by}` : '';
        setBgmState('ÎåÄÍ∏∞Ï§ë(ÌóàÏö© ÌïÑÏöî)' + who);
        return;
      }

      applyRemoteBgm_(v, false);
    });
  }catch(e){
    console.warn('bgm sync subscribe failed', e);
  }
}

function remoteKey_(v){
  const kind = String(v?.kind || 'yt');

  // ‚úÖ Ïû¨ÏÉùÎ™©Î°ùÏóêÏÑú Ïò® Ïû¨ÏÉùÏù∏ÏßÄ(ÏûêÎèô ÎÑòÍπÄ)
  playingFromPlaylist_ = !!v?.fromPlaylist;
  const vid = String(v?.videoId || '');
  const fileUrl = String(v?.fileUrl || v?.url || '');
  const at = Number(v?.startedAt || 0);
  const st = String(v?.state || '');
  const pp = (v && typeof v.pausedPos === 'number') ? String(v.pausedPos) : '';
  return `${kind}|${vid}|${fileUrl}|${at}|${st}|${pp}`;
}

function ensureAudioPlayer_(){
  if (audioPlayer_) return audioPlayer_;
  const a = $('audioPlayer') || document.createElement('audio');
  if (!a.id) a.id = 'audioPlayer';
  a.preload = 'auto';
  a.crossOrigin = 'anonymous';
  a.style.display = 'none';
  if (!a.parentNode) document.body.appendChild(a);

  a.addEventListener('loadedmetadata', ()=>{
    try{
      const pend = a.__pendingSeek;
      if (typeof pend === 'number' && isFinite(pend) && pend >= 0){
        const dur = isFinite(a.duration) ? a.duration : 0;
        const to = dur > 0 ? Math.min(dur - 0.25, Math.max(0, pend)) : Math.max(0, pend);
        try{ a.currentTime = to; }catch(e){}
      }
    }catch(e){}
    a.__pendingSeek = null;
  });

  audioPlayer_ = a;
  return a;
}

function stopAudio_(){
  try{
    const a = ensureAudioPlayer_();
    a.pause();
    // do not clear src: allow quick resume
  }catch(e){}
}

function stopYouTube_(){
  try{ if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo(); }catch(e){}
}

function applyRemoteBgm_(v, force){
  const kind = String(v?.kind || 'yt');

  const k = remoteKey_(v);
  if (!force && k === bgmLastAppliedKey_) return;
  bgmLastAppliedKey_ = k;

  const state = String(v?.state || 'playing');
  const who = v?.by ? ` ¬∑ ${v.by}` : '';

  // if not allowed yet, we still reflect title/status but don't autoplay
  if (!bgmAllowed_){
    setBgmState('ÎåÄÍ∏∞Ï§ë(ÌóàÏö© ÌïÑÏöî)' + who);
    try{
      if (kind === 'file'){
        setMiniTitle_(v.title || v.fileName || 'MP3');
      }
    }catch(e){}
    return;
  }

  if (kind === 'file'){
    // MP3 Í≥µÏú† Í∏∞Îä• ÏÇ≠Ï†úÎê® (Ïú†ÌäúÎ∏åÎßå ÏßÄÏõê)
    try{ stopYouTube_(); }catch(e){}
    try{ stopAudio_(); }catch(e){}
    setBgmState('MP3 ÎØ∏ÏßÄÏõê' + who);
    try{ setMiniTitle_(v.title || v.fileName || 'MP3'); }catch(e){}
    return;
  }

  // default: YouTube
  stopAudio_();

  const vid = String(v.videoId || '');
  if (!vid) return;

  loadYouTubeApiOnce();

  const p = ensureYtPlayer(vid);
  if (!p){
    setBgmState('Ïú†ÌäúÎ∏å Î°úÎî© Ï§ë...');
    setTimeout(()=> applyRemoteBgm_(v, true), 600);
    return;
  }

  // Keep volume as local preference
  const vol = Number($('bgmVol').value || 60);
  try{ p.setVolume(vol); }catch(e){}

  try{
    // load
    p.loadVideoById(vid);

    // seek
    let target = null;
    if (state === 'paused' && typeof v.pausedPos === 'number'){
      target = Math.max(0, Number(v.pausedPos || 0));
    }else{
      const startedAt = Number(v.startedAt || 0);
      if (startedAt){
        target = Math.max(0, (Date.now() - startedAt) / 1000);
      }
    }
    if (typeof target === 'number' && isFinite(target)){
      p.seekTo(target, true);
    }

    if (state === 'paused'){
      p.pauseVideo();
      setBgmState('ÏùºÏãúÏ†ïÏßÄ' + who);
    }else{
      p.playVideo();
      setBgmState('Í∞ôÏù¥ Îì£Îäî Ï§ë' + who);
    }
  }catch(e){
    setBgmState('Ïû¨ÏÉù Ïã§Ìå®');
  }
}

// =====================
  // BGM (YouTube)
  // =====================
  function parseYouTubeId(url){
    const s = String(url || '').trim();
    if (!s) return '';
    // youtu.be/VIDEOID
    let m = s.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    // v=VIDEOID
    m = s.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    // shorts/VIDEOID
    m = s.match(/shorts\/([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    return '';
  }

  // ‚úÖ Ïû¨ÏÉùÎ™©Î°ù ÏûêÎèô Ïû¨ÏÉù (DJÎßå Ïã§Ìñâ)
  function onYtEnded_(){
    try{
      // Ïû¨ÏÉùÎ™©Î°ù ÏûêÎèô ÎÑòÍπÄÏùÄ DJÎßå
      if (playingFromPlaylist_){
        if (!isDj_()) return;
        try{ setTimeout(()=>{ plPrevNext_(+1); }, 0); }catch(e){}
        return;
      }

      // ÏùºÎ∞ò Ïû¨ÏÉùÏù¥Î©¥ Î™®ÎëêÍ∞Ä Î°úÏª¨ÏóêÏÑú Í∞ôÏùÄ Í≥° Î∞òÎ≥µ(Í∏∞Ï°¥ loop ÎåÄÏ≤¥)
      if (ytPlayer){
        try{ ytPlayer.seekTo(0, true); }catch(e){}
        try{ ytPlayer.playVideo(); }catch(e){}
      }
    }catch(e){}
  }



  async function bgmPlay_(){
  // ÏûÖÎ†•Ï∞ΩÏóêÏÑú ÏßÅÏ†ë Ïû¨ÏÉù = Ïû¨ÏÉùÎ™©Î°ù Î™®Îìú Ìï¥Ï†ú
  playingFromPlaylist_ = false;
  loadYouTubeApiOnce();

  const url = $('bgmUrl').value;
  const vid = parseYouTubeId(url);
  if (!vid){
    alert('Ïú†ÌäúÎ∏å ÎßÅÌÅ¨ÏóêÏÑú ÏòÅÏÉÅ IDÎ•º Î™ª Ï∞æÏïòÏñ¥. ÎßÅÌÅ¨Î•º Ìïú Î≤àÎßå Îçî ÌôïÏù∏Ìï¥Ï§ò!');
    return;
  }

  // DJ guard: only DJ can control BGM
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ Í∂åÌïú ÌïÑÏöî', `ÌòÑÏû¨ DJ: ${(djState_?.name || 'ÏóÜÏùå')}
DJÎßå ÎÖ∏ÎûòÎ•º ÌãÄ/Î∞îÍøÄ Ïàò ÏûàÏñ¥!`);
      return;
    }
  }

  // user gesture granted
  bgmAllowed_ = true;
  localStorage.setItem(LS_BGM_URL, url);

  const vol = Number($('bgmVol').value || 60);
  localStorage.setItem(LS_BGM_VOL, String(vol));

  // Write shared state -> everyone follows
  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.set(bgmRef, {
      kind: 'yt',
      fromPlaylist: false,
      url,
      videoId: vid,
      startedAt: Date.now(),
      pausedPos: null,
      by: myName().slice(0,12),
      state: 'playing'
    });
    // (ÎÖ∏Îûò Ïû¨ÏÉù ÏïåÎ¶ºÏùÄ Ï±ÑÌåÖ ÏÉÅÎã® Ïù¥ÌéôÌä∏Î°ú ÌëúÏãú)

    // Local immediate apply
    applyRemoteBgm_({ kind:'yt', url, videoId: vid, startedAt: Date.now(), by: myName().slice(0,12), state:'playing', fromPlaylist:false }, true);
  }catch(e){
    console.warn(e);
    alert('BGM Í≥µÏú† Ï†ÄÏû• Ïã§Ìå®! (Firebase Rules / Î°úÍ∑∏Ïù∏ ÏÑ§Ï†ï ÌôïÏù∏)');
  }
}

function getLocalPlayPosSec_(){
  try{
    const kind = String(bgmRemote_?.kind || 'yt');
    if (kind === 'file'){
      const a = ensureAudioPlayer_();
      return Number(a.currentTime || 0);
    }
    if (ytPlayer && ytPlayer.getCurrentTime) return Number(ytPlayer.getCurrentTime() || 0);
  }catch(e){}
  return 0;
}

async function bgmPause_(){
  if (!sessionId) return;

  // DJ guard: only DJ can pause
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ Í∂åÌïú ÌïÑÏöî', `ÌòÑÏû¨ DJ: ${(djState_?.name || 'ÏóÜÏùå')}
DJÎßå ÏùºÏãúÏ†ïÏßÄÌï† Ïàò ÏûàÏñ¥!`);
      return;
    }
  }

  // user gesture granted
  bgmAllowed_ = true;

  const pos = getLocalPlayPosSec_();

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.update(bgmRef, {
      state:'paused',
      pausedPos: pos,
      by: myName().slice(0,12)
    });
    // (BGM ÏùºÏãúÏ†ïÏßÄ Î©îÏãúÏßÄ Ï†úÍ±∞: ÏÉÅÎã®Î∞î ÏÉÅÌÉúÎ°úÎßå ÌëúÏãú)
  }catch(e){
    // fallback local
    try{ if (ytPlayer) ytPlayer.pauseVideo(); }catch(_){}
    try{ const a = ensureAudioPlayer_(); a.pause(); }catch(_){}
  }
}

async function bgmResume_(){
  if (!sessionId) return;

  // DJ guard: only DJ can resume
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ Í∂åÌïú ÌïÑÏöî', `ÌòÑÏû¨ DJ: ${(djState_?.name || 'ÏóÜÏùå')}
DJÎßå Ïû¨ÏÉù/Ïû¨Í∞úÌï† Ïàò ÏûàÏñ¥!`);
      return;
    }
  }

  bgmAllowed_ = true;

  if (!bgmRemote_){
    showOverlay('Ïû¨Í∞ú Î∂àÍ∞Ä', 'ÌòÑÏû¨ Í≥µÏú† Ï§ëÏù∏ BGMÏù¥ ÏóÜÏñ¥.');
    return;
  }

  const pos = (typeof bgmRemote_.pausedPos === 'number') ? Number(bgmRemote_.pausedPos || 0) : getLocalPlayPosSec_();
  const startedAt = Date.now() - Math.max(0, pos) * 1000;

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.update(bgmRef, {
      state:'playing',
      startedAt,
      pausedPos: null,
      by: myName().slice(0,12)
    });
    // (BGM Ïû¨Í∞ú Î©îÏãúÏßÄ Ï†úÍ±∞: ÏÉÅÎã®Î∞î ÏÉÅÌÉú + Ïû¨ÏÉù Ïù¥ÌéôÌä∏Î°ú ÌëúÏãú)
  }catch(e){
    console.warn(e);
  }
}

async function setBgmFromTrack_(track, announcePrefix){
  if (!sessionId) return;

  // ‚úÖ DJ/Ïû¨ÏÉùÎ™©Î°ùÏóêÏÑú Î∞îÎ°ú Ïû¨ÏÉùÎêòÎèÑÎ°ù: ÏûêÎèôÏû¨ÏÉù Í∂åÌïú + YT API ÌîÑÎ¶¨Î°úÎìú
  // (Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±ÖÏÉÅ Í∞ÅÏûê 1Ìöå ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤òÍ∞Ä ÌïÑÏöîÌïòÏßÄÎßå, DJÍ∞Ä ÎàÑÎ•¥Îäî Î≤ÑÌäº ÏûêÏ≤¥Îäî Ï†úÏä§Ï≤òÎùºÏÑú Ïó¨Í∏∞ÏÑú ÌóàÏö© Ï≤òÎ¶¨)
  try{
    bgmAllowed_ = true;
    setBgmState('BGM ÌóàÏö©Îê®');
    loadYouTubeApiOnce();
  }catch(e){}

  // DJ guard
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ Í∂åÌïú ÌïÑÏöî', `ÌòÑÏû¨ DJ: ${(djState_?.name || 'ÏóÜÏùå')}
DJÎßå ÎÖ∏ÎûòÎ•º ÌãÄ/Î∞îÍøÄ Ïàò ÏûàÏñ¥!`);
      return;
    }
  }

  const nm = myName().slice(0,12);

  const payload = {
    kind: track.kind || 'yt',
    fromPlaylist: true,
    state: 'playing',
    startedAt: Date.now(),
    pausedPos: null,
    by: nm
  };

  if (payload.kind === 'file'){
    payload.fileUrl = String(track.fileUrl || track.url || '');
    payload.fileName = String(track.fileName || track.title || 'MP3');
    payload.title = String(track.title || track.fileName || 'MP3');
    payload.url = payload.fileUrl;
  }else{
    payload.url = String(track.url || '');
    payload.videoId = String(track.videoId || parseYouTubeId(payload.url) || '');
    payload.title = String(track.title || '');
  }

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.set(bgmRef, payload);
    // (ÎÖ∏Îûò Ïû¨ÏÉù ÏïåÎ¶ºÏùÄ Ï±ÑÌåÖ ÏÉÅÎã® Ïù¥ÌéôÌä∏Î°ú ÌëúÏãú)

    applyRemoteBgm_(payload, true);
  }catch(e){
    console.warn(e);
    alert('BGM Í≥µÏú† Ï†ÄÏû• Ïã§Ìå®! (Firebase Rules / Î°úÍ∑∏Ïù∏ ÏÑ§Ï†ï ÌôïÏù∏)');
  }
}



// =====================
// MP3 Upload (Firebase Storage)
// =====================
function safeFileName_(name){
  return String(name || 'audio').replace(/[^\w\-.Í∞Ä-Ìû£]+/g, '_').slice(0, 80);
}

async function uploadAudioFile_(file, purpose){
  if (!file) throw new Error('no file');
  await window.FB.ensureAnonAuth();

  const uid = myUid_() || 'anon';
  const fname = safeFileName_(file.name || 'audio.mp3');
  const ts = Date.now();
  const folder = purpose || 'uploads';
  const path = `rooms/${sessionId}/${folder}/${uid}/${ts}_${fname}`;

  const sref = window.FB.sRef(window.FB.storage, path);
  const meta = { contentType: file.type || 'audio/mpeg' };

  return await new Promise((resolve, reject)=>{
    const task = window.FB.uploadBytesResumable(sref, file, meta);

    // simple progress overlay
    showOverlay('ÏóÖÎ°úÎìú Ï§ë', 'MP3 ÏóÖÎ°úÎìú Ï§ë... (Ïû†ÍπêÎßå!)');

    task.on('state_changed',
      (snap)=>{
        const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
        const msg = `MP3 ÏóÖÎ°úÎìú Ï§ë... ${pct}%`;
        const el = $('ovMsg'); if (el) el.textContent = msg;
      },
      (err)=>{
        hideOverlay();
        reject(err);
      },
      async ()=>{
        try{
          const url = await window.FB.getDownloadURL(task.snapshot.ref);
          hideOverlay();
          resolve({ url, path, fileName: file.name || fname, size: file.size || 0, contentType: file.type || '' });
        }catch(e){
          hideOverlay();
          reject(e);
        }
      }
    );
  });
}

// =====================
// DJ Playlist (Firebase RTDB)
// =====================
function normalizePlaylist_(pl){
  const out = pl && typeof pl === 'object' ? pl : {};
  const items = Array.isArray(out.items) ? out.items : [];
  const curIndex = Number.isFinite(Number(out.curIndex)) ? Number(out.curIndex) : 0;
  return { items, curIndex };
}

function trackLabel_(t){
  const kind = String(t?.kind || 'yt');
  if (kind === 'file') return `üéß MP3 ¬∑ ${t.fileName || t.title || 'MP3'}`;
  return `üéµ YT ¬∑ ${t.url || ''}`;
}

function trackSub_(t){
  const kind = String(t?.kind || 'yt');
  const by = t?.by ? ` ¬∑ ${t.by}` : '';
  const note = t?.note ? ` ¬∑ ${t.note}` : '';
  if (kind === 'file') return `${t.fileName || 'MP3'}${by}${note}`;
  return `${t.url || ''}${by}${note}`;
}

function renderPlaylistUi_(){
  const box = $('playlistList');
  const st = $('plStatus');
  if (!box || !st) return;

  const pl = normalizePlaylist_(plRemote_);
  const items = pl.items || [];
  const cur = pl.curIndex || 0;

  st.textContent = items.length ? `${items.length}Í≥° ¬∑ ÌòÑÏû¨ ${cur+1}/${items.length}` : 'ÎπÑÏñ¥ÏûàÏùå';

  box.innerHTML = '';
  if (!items.length){
    box.innerHTML = '<div class="hint">Ïû¨ÏÉùÎ™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏñ¥Ïöî. (DJÍ∞Ä Ï∂îÍ∞ÄÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÏåìÏó¨Ïöî!)</div>';
    return;
  }

  items.forEach((t, idx)=>{
    const row = document.createElement('div');
    row.className = 'plItem' + (idx === plSelIndex_ ? ' sel' : '');
    row.addEventListener('click', ()=>{ plSelIndex_ = idx; renderPlaylistUi_(); });

    const main = document.createElement('div');
    main.className = 'plMain';

    const title = document.createElement('div');
    title.className = 'plTitle';
    title.textContent = (idx === cur ? '‚ñ∂Ô∏è ' : '') + trackLabel_(t);

    const sub = document.createElement('div');
    sub.className = 'plSub';
    sub.textContent = trackSub_(t);

    main.appendChild(title);
    main.appendChild(sub);

    const btns = document.createElement('div');
    btns.className = 'plBtns';

    if (isDj_()){
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'tinyBtn';
      del.textContent = 'üóë';
      del.title = 'ÏÇ≠Ï†ú';
      del.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        await plDeleteIndex_(idx);
      });
      btns.appendChild(del);
    }

    row.appendChild(main);
    row.appendChild(btns);
    box.appendChild(row);
  });
}

async function getPlaylistFromDb_(){
  const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(sessionId));
  const snap = await window.FB.get(plRef);
  const v = snap.exists() ? snap.val() : null;
  return normalizePlaylist_(v);
}

async function savePlaylistToDb_(pl){
  const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(sessionId));
  await window.FB.set(plRef, { ...pl, updatedAt: Date.now(), by: myName().slice(0,12) });
}

async function plAddTrack_(track){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Ïû¨ÏÉùÎ™©Î°ùÏùÑ Ìé∏ÏßëÌï† Ïàò ÏûàÏñ¥Ïöî.');
    return;
  }
  await window.FB.ensureAnonAuth();
  const pl = await getPlaylistFromDb_();
  pl.items = Array.isArray(pl.items) ? pl.items : [];
  pl.items.push({ ...track, ts: Date.now(), by: myName().slice(0,12) });
  if (!Number.isFinite(pl.curIndex)) pl.curIndex = 0;
  await savePlaylistToDb_(pl);
  plSelIndex_ = pl.items.length - 1;
}

async function plDeleteIndex_(idx){
  if (!isDj_()) return;
  const pl = await getPlaylistFromDb_();
  if (!pl.items || idx < 0 || idx >= pl.items.length) return;
  pl.items.splice(idx, 1);
  if (pl.curIndex >= pl.items.length) pl.curIndex = Math.max(0, pl.items.length - 1);
  await savePlaylistToDb_(pl);
  if (plSelIndex_ >= pl.items.length) plSelIndex_ = pl.items.length - 1;
}

async function plClear_(){
  if (!isDj_()){
    showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Ïû¨ÏÉùÎ™©Î°ùÏùÑ ÎπÑÏö∏ Ïàò ÏûàÏñ¥Ïöî.');
    return;
  }
  await savePlaylistToDb_({ items:[], curIndex:0 });
  plSelIndex_ = -1;
}

async function plPlayIndex_(idx){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Ïû¨ÏÉùÎ™©Î°ùÏùÑ Ïû¨ÏÉùÌï† Ïàò ÏûàÏñ¥Ïöî.');
    return;
  }
  const pl = await getPlaylistFromDb_();
  if (!pl.items || idx < 0 || idx >= pl.items.length) return;

  pl.curIndex = idx;
  await savePlaylistToDb_(pl);
  await setBgmFromTrack_(pl.items[idx], 'üé∂');
}

async function plPrevNext_(dir){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Ïù¥Ï†Ñ/Îã§ÏùåÏúºÎ°ú ÎÑòÍ∏∏ Ïàò ÏûàÏñ¥Ïöî.');
    return;
  }
  const pl = await getPlaylistFromDb_();
  const n = pl.items?.length || 0;
  if (!n) return;

  let next = Number(pl.curIndex || 0) + (dir || 0);
  if (next < 0) next = n - 1;
  if (next >= n) next = 0;

  pl.curIndex = next;
  await savePlaylistToDb_(pl);
  plSelIndex_ = next;
  await setBgmFromTrack_(pl.items[next], 'üé∂');
}

function initPlaylist_(roomId){
  try{ if (plUnsub_) plUnsub_(); }catch(e){}
  plUnsub_ = null;
  plRemote_ = null;
  plSelIndex_ = -1;

  try{
    const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(roomId));
    plUnsub_ = window.FB.onValue(plRef, (snap)=>{
      plRemote_ = snap.exists() ? snap.val() : null;
      renderPlaylistUi_();
    });
  }catch(e){
    console.warn('playlist subscribe failed', e);
  }
}

// =====================
// Requests (Firebase RTDB)
// =====================
function renderRequestsUi_(){
  const box = $('reqList');
  const st = $('reqStatus');
  if (!box || !st) return;

  const obj = reqRemote_ && typeof reqRemote_ === 'object' ? reqRemote_ : {};
  const keys = Object.keys(obj).sort((a,b)=> (obj[a]?.ts||0) - (obj[b]?.ts||0));
  st.textContent = keys.length ? `${keys.length}Í±¥` : 'ÏóÜÏùå';

  box.innerHTML = '';
  if (!keys.length){
    box.innerHTML = '<div class="hint">Ïã†Ï≤≠Í≥°Ïù¥ ÏïÑÏßÅ ÏóÜÏñ¥Ïöî üôÇ</div>';
    return;
  }

  keys.forEach((k)=>{
    const r = obj[k] || {};
    const row = document.createElement('div');
    row.className = 'reqItem';

    const main = document.createElement('div');
    main.className = 'reqMain';

    const title = document.createElement('div');
    title.className = 'reqTitle';
    title.textContent = (r.kind === 'file') ? `üéß MP3 Ïã†Ï≤≠ ¬∑ ${r.fileName || 'MP3'}` : `üéµ Ïã†Ï≤≠ ¬∑ ${r.url || ''}`;

    const sub = document.createElement('div');
    sub.className = 'reqSub';
    const from = r.fromName ? `from ${r.fromName}` : 'from ÏùµÎ™Ö';
    const note = r.note ? ` ¬∑ ${r.note}` : '';
    sub.textContent = `${from}${note}`;

    main.appendChild(title);
    main.appendChild(sub);

    const btns = document.createElement('div');
    btns.className = 'reqBtns';

    if (isDj_()){
      const ok = document.createElement('button');
      ok.type = 'button';
      ok.className = 'tinyBtn';
      ok.textContent = '‚úÖ';
      ok.title = 'Ïû¨ÏÉùÎ™©Î°ùÏóê Ï∂îÍ∞Ä';
      ok.addEventListener('click', async ()=>{
        await approveRequest_(k, r);
      });

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'tinyBtn';
      del.textContent = 'üóë';
      del.title = 'Í±∞Ï†à/ÏÇ≠Ï†ú';
      del.addEventListener('click', async ()=>{
        await deleteRequest_(k);
      });

      btns.appendChild(ok);
      btns.appendChild(del);
    }

    row.appendChild(main);
    row.appendChild(btns);
    box.appendChild(row);
  });
}

function initRequests_(roomId){
  try{ if (reqUnsub_) reqUnsub_(); }catch(e){}
  reqUnsub_ = null;
  reqRemote_ = {};

  try{
    const reqRef = window.FB.ref(window.FB.db, fbRequestsPath_(roomId));
    reqUnsub_ = window.FB.onValue(reqRef, (snap)=>{
      reqRemote_ = snap.exists() ? (snap.val() || {}) : {};
      renderRequestsUi_();
    });
  }catch(e){
    console.warn('request subscribe failed', e);
  }
}

async function pushRequest_(payload){
  if (!sessionId) return;

  const nm = myName().slice(0,12) || 'ÏùµÎ™Ö';
  await window.FB.ensureAnonAuth();

  const reqRef = window.FB.ref(window.FB.db, fbRequestsPath_(sessionId));
  const item = {
    ...payload,
    fromUid: myUid_() || '',
    fromName: nm,
    ts: Date.now()
  };

  await window.FB.push(reqRef, item);
  $('reqUrl').value = '';
  $('reqNote').value = '';
  showOverlay('Ïã†Ï≤≠ ÏôÑÎ£å', 'Ïã†Ï≤≠Í≥°Ïù¥ Ï†ëÏàòÎêêÏñ¥! DJÍ∞Ä ÏäπÏù∏ÌïòÎ©¥ Ïû¨ÏÉùÎ™©Î°ùÏóê Îì§Ïñ¥Í∞ÄÏöî.');
}

async function deleteRequest_(key){
  if (!isDj_()) return;
  const rRef = window.FB.ref(window.FB.db, `${fbRequestsPath_(sessionId)}/${key}`);
  await window.FB.remove(rRef);
}

async function approveRequest_(key, r){
  if (!isDj_()) return;

  const track = (r.kind === 'file')
    ? { kind:'file', fileUrl: r.fileUrl || r.url || '', fileName: r.fileName || 'MP3', title: r.fileName || 'MP3', note: r.note || '' }
    : { kind:'yt', url: r.url || '', videoId: parseYouTubeId(r.url || ''), title:'', note: r.note || '' };

  await plAddTrack_(track);
  await deleteRequest_(key);
  showOverlay('ÏäπÏù∏ ÏôÑÎ£å', 'Ïã†Ï≤≠Í≥°ÏùÑ DJ Ïû¨ÏÉùÎ™©Î°ùÏóê ÎÑ£ÏóàÏñ¥!');
}

// =====================
// UI wiring for playlist/requests
// =====================
function wirePlaylistAndRequestsUi_(){
  // =====================
  // DJ playlist (Ïú†ÌäúÎ∏åÎßå)
  // =====================
  $('btnPlAddYt')?.addEventListener('click', async ()=>{
    const url = ($('bgmUrl')?.value || '').trim();
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('Ï∂îÍ∞Ä Ïã§Ìå®', 'Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Í∞Ä ÌïÑÏöîÌï¥Ïöî. (BGM ÏûÖÎ†•Ï∞ΩÏóê ÎßÅÌÅ¨Î•º ÎÑ£Í≥† ‚ÄúDJ Ïû¨ÏÉùÎ™©Î°ùÏóê Ï∂îÍ∞Ä‚ÄùÎ•º ÎàåÎü¨Ï§ò)');
      return;
    }
    await plAddTrack_({ kind:'yt', url, videoId: vid });
  });

  // BGM Î∏îÎ°ùÏóêÏÑú Î∞îÎ°ú ‚ÄúÎ™©Î°ùÏ∂îÍ∞Ä‚Äù (Í∞ÄÍπåÏõåÏÑú Ìó∑Í∞àÎ¶º Î∞©ÏßÄ)
  $('btnQuickPlAdd')?.addEventListener('click', async ()=>{
    const url = ($('bgmUrl')?.value || '').trim();
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('Ï∂îÍ∞Ä Ïã§Ìå®', 'Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Í∞Ä ÌïÑÏöîÌï¥Ïöî. (BGM ÏûÖÎ†•Ï∞ΩÏóê ÎßÅÌÅ¨Î•º ÎÑ£Í≥† ‚Äú‚ûï DJ Ïû¨ÏÉùÎ™©Î°ùÏóê Ï∂îÍ∞Ä‚ÄùÎ•º ÎàåÎü¨Ï§ò)');
      return;
    }
    await plAddTrack_({ kind:'yt', url, videoId: vid });
  });

  $('btnPlPrev')?.addEventListener('click', ()=> plPrevNext_(-1));
  $('btnPlNext')?.addEventListener('click', ()=> plPrevNext_(+1));

  $('btnPlAutoAll')?.addEventListener('click', async ()=>{
    // ‚úÖ Ïû¨ÏÉùÎ™©Î°ù Ï†ÑÏ≤¥ ÏûêÎèôÏû¨ÏÉù ÏãúÏûë(ÌòÑÏû¨ curIndexÎ∂ÄÌÑ∞)
    const pl = normalizePlaylist_(plRemote_);
    const items = pl.items || [];
    if (!items.length){
      showOverlay('Ïû¨ÏÉùÎ™©Î°ù ÎπÑÏñ¥ÏûàÏùå', 'DJ Ïû¨ÏÉùÎ™©Î°ùÏóê Í≥°ÏùÑ Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï§ò!');
      return;
    }
    // DJÎßå (plPlayIndex_ ÎÇ¥Î∂ÄÏóêÏÑúÎèÑ Ï≤¥ÌÅ¨ÌïòÏßÄÎßå, UXÎ•º ÏúÑÌï¥)
    if (!isDj_()){
      showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå Ïû¨ÏÉùÎ™©Î°ù Ï†ÑÏ≤¥ ÏûêÎèô Ïû¨ÏÉùÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏñ¥Ïöî.');
      return;
    }
    const startIdx = Number.isFinite(pl.curIndex) ? Number(pl.curIndex) : 0;
    plSelIndex_ = Math.max(0, Math.min(startIdx, items.length - 1));
    await plPlayIndex_(plSelIndex_);
    renderPlaylistUi_();
  });


  $('btnPlPlayNow')?.addEventListener('click', async ()=>{
    if (plSelIndex_ < 0){
      showOverlay('ÏÑ†ÌÉù ÏóÜÏùå', 'Ïû¨ÏÉùÌï† Í≥°ÏùÑ Î™©Î°ùÏóêÏÑú ÌïòÎÇò ÏÑ†ÌÉùÌï¥Ï§ò!');
      return;
    }
    await plPlayIndex_(plSelIndex_);
  });

  $('btnPlDeleteSel')?.addEventListener('click', async ()=>{
    if (!isDj_()){
      showOverlay('DJÎßå Í∞ÄÎä•', 'DJÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏñ¥Ïöî.');
      return;
    }
    if (plSelIndex_ < 0){
      showOverlay('ÏÑ†ÌÉù ÏóÜÏùå', 'ÏÇ≠Ï†úÌï† Í≥°ÏùÑ Î™©Î°ùÏóêÏÑú ÌïòÎÇò ÏÑ†ÌÉùÌï¥Ï§ò!');
      return;
    }
    await plDeleteIndex_(plSelIndex_);
    renderPlaylistUi_();
  });

  $('btnPlClear')?.addEventListener('click', async ()=>{
    await plClear_();
  });

  $('btnPlSyncToInput')?.addEventListener('click', ()=>{
    try{
      if (!bgmRemote_) return;
      $('bgmUrl').value = String(bgmRemote_.url || '');
      showOverlay('Î≥µÏÇ¨ ÏôÑÎ£å', 'ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ ÎßÅÌÅ¨Î•º ÏûÖÎ†•Ï∞ΩÏóê Î≥µÏÇ¨ÌñàÏñ¥!');
    }catch(e){}
  });

  // =====================
  // Song requests (Ïú†ÌäúÎ∏åÎßå)
  // =====================
  $('btnReqSend')?.addEventListener('click', async ()=>{
    const url = ($('reqUrl')?.value || '').trim();
    const note = ($('reqNote')?.value || '').trim();
    if (!url){
      showOverlay('Ïã†Ï≤≠ Ïã§Ìå®', 'Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Î•º ÎÑ£Ïñ¥Ï§ò!');
      return;
    }
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('Ïã†Ï≤≠ Ïã§Ìå®', 'ÏßÄÍ∏àÏùÄ Ïú†ÌäúÎ∏å ÎßÅÌÅ¨Îßå Ïã†Ï≤≠ Í∞ÄÎä•Ìï¥!');
      return;
    }
    await pushRequest_({ kind:'yt', url, note });
    try{ $('reqUrl').value = ''; }catch(e){}
    try{ $('reqNote').value = ''; }catch(e){}
  });
}


// mobile topbar fold (safe: only toggles CSS class)
function toggleTopbarMobile_(force){
  const isMobile = window.matchMedia && window.matchMedia('(max-width: 760px)').matches;
  if (!isMobile) return;

  const body = document.body;
  const willCollapse = (typeof force === 'boolean') ? force : !body.classList.contains('tbCollapsed');
  body.classList.toggle('tbCollapsed', willCollapse);
  try{ const side = document.querySelector('.card.side'); if(side){ side.setAttribute('aria-hidden', willCollapse ? 'true' : 'false'); } }catch(e){}

  const btn = $('btnTopbarToggle');
  if (btn) btn.textContent = willCollapse ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
  try{ localStorage.setItem('VENT_TOPBAR_COLLAPSED_V1', willCollapse ? '1' : '0'); }catch(e){}
  try{ window.syncMobileLogFit_(true); }catch(e){}
}

  // =====================
  // UI events
  // =====================
  function initUi_(){
    try{ bindOverlayUi_(); }catch(e){}
    // menu
    $('btnMenu')?.addEventListener('click', toggleMenu);
    $('btnMenuClose')?.addEventListener('click', closeMenu); 
    document.addEventListener('click', (e)=>{
      const mp = $('menuPanel');
      if (!mp) return;
      if (!mp.classList.contains('show')) return;
      if (e.target.closest('#menuPanel') || e.target.closest('#btnMenu')) return;
      closeMenu();
    });


// topbar fold (mobile only)
const tbBtn = $('btnTopbarToggle');
if (tbBtn){
  tbBtn.addEventListener('click', ()=> toggleTopbarMobile_());
  // restore
  try{
    const v = localStorage.getItem('VENT_TOPBAR_COLLAPSED_V1');
    if (v === '1') toggleTopbarMobile_(true);
  }catch(e){}
}


    // leave
    $('btnLeave')?.addEventListener('click', ()=>{
      stopAll_();
      stopPresence_();
      showOverlay('ÎÇòÍ∞ÄÍ∏∞', 'Ï∞ΩÏùÑ Îã´ÏïÑÎèÑ ÎêòÍ≥†, Îã§Ïãú Îì§Ïñ¥Ïò§Î©¥ ÏÉàÎ°ú Ï†ëÏÜçÌï¥.');
    });

    // chat send
    $('sendBtn')?.addEventListener('click', sendChat_);
    $('msg')?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendChat_();
      }
    });

    // notice (menu + topbar pin)
    // ‚úÖ Í≥µÏßÄ Î≥¥Í∏∞ Î≤ÑÌäºÏùÄ ÏÉÅÎã® üìå(btnNoticePin)ÏúºÎ°ú Ïù¥Îèô ‚Üí Î©îÎâ¥ Î≤ÑÌäºÏùÄ Ï†úÍ±∞
    $('btnNoticePin')?.addEventListener('click', openNotice_);

    // guide / typing race
    $('btnGuide')?.addEventListener('click', showGuide_);
$('btnAcid')?.addEventListener('click', (e)=>{ try{ e.preventDefault(); e.stopPropagation(); }catch(_e){}; try{ openAcidStart_(); }catch(_e){} });
    $('btnRace')?.addEventListener('click', ()=>{ try{ openRaceStart_(); }catch(e){} }); 
    $('btnRaceClear')?.addEventListener('click', ()=>{ try{ const i=$('raceInput'); if(i){ i.value=''; i.focus(); } }catch(e){} });

    // nickname profile
    const userEl = $('user');

    // restore saved nick (optional)
    try{
      const saved = localStorage.getItem(LS_LAST_NICK) || '';
      if (saved && validateNick_(saved)){
        userEl.value = saved;
        lastConfirmedNick_ = saved;
        nickConfirmed_ = true;
      }
    }catch(e){}

    const onNickInput = ()=>{
      try{ myProfile_(); }catch(e){}
      try{ setDjUi_(); }catch(e){}
    };

    // ‚úÖ ÌÉÄÏù¥Ìïë Ï§ëÏóê ÏûÖÏû• Î©îÏãúÏßÄ Îú®Îäî Î¨∏Ï†ú Î∞©ÏßÄ: ÌôïÏ†ï(ÌôïÏù∏) ÌõÑÏóêÎßå announce
    userEl.addEventListener('input', onNickInput);
    userEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        confirmNickname_('enter');
        $('msg')?.focus();
      }
    });
    userEl.addEventListener('change', ()=> confirmNickname_('change'));
    userEl.addEventListener('blur', ()=> confirmNickname_('blur'));
// log scroll tracking (ÏûêÎèô Ïä§ÌÅ¨Î°§ Ï†úÏñ¥)
$('log')?.addEventListener('scroll', updateAutoScrollState_, { passive:true });
$('jumpBtn')?.addEventListener('click', ()=>{
  const log = $('log');
  autoScroll_ = true;
  unreadCount_ = 0;
  showJumpBtn_(false);
  log.scrollTop = log.scrollHeight;
});

// log size slider (desktop: height / mobile: maxHeight)
    window.isMobile_ = window.isMobile_ || (()=> (window.matchMedia && window.matchMedia('(max-width: 760px)').matches));
    const isMobile_ = window.isMobile_;

    window.syncMobileLogFit_ = function syncMobileLogFit_(forceMax){
      if(!isMobile_()) return;
      const log = $('log');
      const slider = $('logSize');
      const valEl = $('logSizeVal');
      if(!log || !slider || !valEl) return;

      // flex Î†àÏù¥ÏïÑÏõÉÏóêÏÑú ÏûêÏó∞Ïä§ÎüΩÍ≤å Ìï†ÎãπÎêòÎäî ÎÜíÏù¥Î•º Ï∏°Ï†ï
      const prevMaxH = log.style.maxHeight;
      const prevH = log.style.height;
      log.style.maxHeight = '';
      log.style.height = '';

      requestAnimationFrame(()=>{
        const rect = log.getBoundingClientRect();
        let fitH = Math.floor(rect.height || 0);
        if(!fitH || fitH < 180) fitH = 180;

        slider.max = String(Math.max(180, fitH));
        const cur = Number(slider.value || 320);

        // Ïù¥Ï†ÑÏóê 'ÏûêÎèôÎßûÏ∂§'(=ÏµúÎåÄÍ∞í) ÏÉÅÌÉúÏòÄÍ±∞ÎÇò, forceMaxÎ©¥ ÏµúÎåÄÏóê ÎßûÏ∂§
        const wasAuto = forceMax || slider.dataset.auto === '1' || Math.abs(cur - Number(slider.max)) <= 2;
        const newVal = wasAuto ? fitH : Math.min(cur, fitH);

        slider.value = String(newVal);
        log.style.maxHeight = newVal + 'px';
        valEl.textContent = newVal + 'px';
        slider.dataset.auto = (newVal === fitH) ? '1' : '0';

        // Î≥µÍµ¨Í∞Ä ÌïÑÏöîÌïú Í≤ΩÏö∞(ÌäπÌûà Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑú) ÎåÄÎπÑ
        if(!isMobile_()){
          log.style.maxHeight = prevMaxH;
          log.style.height = prevH;
        }
      });
    }

    $('logSize')?.addEventListener('input', ()=>{
      const slider = $('logSize');
      const v0 = Number(slider.value || 320);
      const log = $('log');
      if(!log) return;

      if(isMobile_()){
        const max = Number(slider.max || v0);
        const v = Math.min(v0, max);
        log.style.maxHeight = v + 'px';
        $('logSizeVal').textContent = v + 'px';
        slider.dataset.auto = (v === max) ? '1' : '0';
      }else{
        log.style.height = v0 + 'px';
        $('logSizeVal').textContent = v0 + 'px';
      }
    });

    // chat font slider (message bubbles)
    try{
      const fontEl = $('logFont');
      if(fontEl){
        fontEl.addEventListener('input', ()=>{
          const v = Number(fontEl.value || (isMobile_()?14:15));
          $('logFontVal').textContent = v + 'px';
          document.documentElement.style.setProperty('--chatMsgPx', v + 'px');
          localStorage.setItem(LS_CHAT_FONT, String(v));
        });
      }
    }catch(e){}

    // BGM
    $('btnBgmPlay')?.addEventListener('click', bgmPlay_);
    $('btnBgmPause')?.addEventListener('click', bgmPause_);
    $('btnBgmAllow')?.addEventListener('click', ()=>{
      bgmAllowed_ = true;
      setBgmState('BGM ÌóàÏö©Îê®');
      if (bgmRemote_) applyRemoteBgm_(bgmRemote_, true);
    });

    // DJ
    $('btnDjClaim')?.addEventListener('click', ()=> claimDj_(false));
    $('btnDjTransfer')?.addEventListener('click', transferDjPick_);

    $('bgmVol')?.addEventListener('input', ()=>{
      const v = Number($('bgmVol').value || 60);
      $('bgmVolVal').textContent = String(v);
      localStorage.setItem(LS_BGM_VOL, String(v));
      try{ if (ytPlayer) ytPlayer.setVolume(v); }catch(e){}
      try{ const a = ensureAudioPlayer_(); a.volume = clamp_(v/100, 0, 1); }catch(e){}
    });

    // restore BGM settings
    const savedUrl = localStorage.getItem(LS_BGM_URL) || '';
    const savedVol = Number(localStorage.getItem(LS_BGM_VOL) || 60);
    $('bgmUrl').value = savedUrl;
    $('bgmVol').value = String(savedVol);
    $('bgmVolVal').textContent = String(savedVol);

    
    // restore chat font (message bubbles only)
    try{
      const savedFont = localStorage.getItem(LS_CHAT_FONT);
      let font = savedFont ? Number(savedFont) : (isMobile_()?14:15);
      if(!font || isNaN(font)) font = (isMobile_()?14:15);
      if($('logFont')) $('logFont').value = String(font);
      if($('logFontVal')) $('logFontVal').textContent = font + 'px';
      document.documentElement.style.setProperty('--chatMsgPx', font + 'px');
    }catch(e){}
// restore log height
    updateAutoScrollState_();
    const v = Number($('logSize').value || 320);
    $('log').style.height = v + 'px';
    $('logSizeVal').textContent = v + 'px';

    // PATCH: viewport/vh ÏïàÏ†ïÌôî
    setVhVar_();
    try{ window.syncMobileLogFit_(true); }catch(e){}
    window.addEventListener('resize', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
    window.addEventListener('orientationchange', ()=> setTimeout(()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(true); }catch(e){} }, 200));
    // iOS SafariÏóêÏÑú Ï£ºÏÜåÏ∞Ω/ÌÇ§Î≥¥Îìú Î≥ÄÌôîÎ°ú resizeÍ∞Ä Ïïà Îú®Îäî Í≤ΩÏö∞ ÎåÄÎπÑ
    if (window.visualViewport){
      try{
        window.visualViewport.addEventListener('resize', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
        window.visualViewport.addEventListener('scroll', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
      }catch(e){}
    }

// PATCH: mini BGM + picker (Ïã§Ìå®Ìï¥ÎèÑ Í∏∞Î≥∏ Í∏∞Îä•ÏùÄ ÏÇ¥ÏïÑÏïº Ìï®)
    try{ initMiniBgmBar_(); }catch(e){ console.error(e); }
    try{ initLogPopover_(); }catch(e){ console.error(e); }
    try{ wirePlaylistAndRequestsUi_(); }catch(e){ console.error(e); }
    try{ initPicker_(); }catch(e){ console.error(e); }

    // YouTube API preload(Í∞ÄÎ≥çÍ≤å)
    loadYouTubeApiOnce();
  }


  // =====================
  // PATCH: Mobile viewport stability (vh)
  // =====================
  function setVhVar_(){
  try{
    // ‚úÖ Mobile Ï£ºÏÜåÏ∞Ω/ÌÇ§Î≥¥Îìú Î≥ÄÌôîÏóê Îçî Í∞ïÌïú ÎÜíÏù¥ Í≥ÑÏÇ∞
    const vv = window.visualViewport;
    const h = (vv && vv.height) ? vv.height : (window.innerHeight || 0);
    const vh = (h || 0) * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');

    // ‚úÖ script.google.com Î™®Î∞îÏùº ÏÉÅÎã® ÏïàÎÇ¥ Î∞∞ÎÑà(Í≥†Ï†ï)Î°ú Í∞ÄÎ†§ÏßÄÎäî Î¨∏Ï†ú Î≥¥Ï†ï
    //    - ÌôîÎ©¥ (10,10) ÏßÄÏ†êÏóê ÏûàÎäî "Í≥†Ï†ï ÏÉÅÎã® ÏöîÏÜå"Ïùò ÎÜíÏù¥Î•º Ï∂îÏ†ïÌï¥ÏÑú --chromeTopÏúºÎ°ú Î∞òÏòÅ
    let topH = 0;
    try{
      const hit = document.elementFromPoint(10, 10);
      if(hit){
        let n = hit;
        for(let i=0;i<8 && n && n !== document.body && n !== document.documentElement; i++){
          if(n.closest && n.closest('.topbar')) { break; } // Ïö∞Î¶¨ ÏÉÅÎã®Î∞îÎäî Ï†úÏô∏
          if(n.id === 'overlay' || (n.classList && n.classList.contains('overlay'))) { break; }
          const cs = window.getComputedStyle(n);
          const rect = n.getBoundingClientRect();
          const looksFixedTop = (cs.position === 'fixed' || cs.position === 'sticky')
            && rect.top <= 0.5
            && rect.height >= 44
            && rect.width >= (window.innerWidth * 0.80);
          if(looksFixedTop){
            topH = Math.round(rect.height);
            break;
          }
          n = n.parentElement;
        }
      }
    }catch(e2){}
    document.documentElement.style.setProperty('--chromeTop', (topH || 0) + 'px');
  }catch(e){}
}
// =====================
  // PATCH: Mini BGM Bar + Volume popover
  // =====================
  function clamp_(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function showVolPopover_(){
    const pop = $('volPopover');
    const btn = $('miniVolBtn');
    if (!pop || !btn) return;
    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || 260;
    const left = clamp_(r.left + r.width/2 - w/2, 10, window.innerWidth - w - 10);
    const top = r.bottom + 8;
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');
  }

  function hideVolPopover_(){
    const pop = $('volPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }

  function toggleVolPopover_(){
    const pop = $('volPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hideVolPopover_();
    else showVolPopover_();
  }

  // Chat height popover
  function showLogPopover_(){
    const pop = $('logPopover');
    const btn = $('btnLogPopover');
    if (!pop || !btn) return;
    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || 280;
    const left = clamp_(r.left + r.width/2 - w/2, 10, window.innerWidth - w - 10);
    const top = r.bottom + 8;
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');
  }

  function hideLogPopover_(){
    const pop = $('logPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }

  function toggleLogPopover_(){
    const pop = $('logPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hideLogPopover_();
    else showLogPopover_();
  }

  function initLogPopover_(){
    const btn = $('btnLogPopover');
    if (!btn) return;

    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleLogPopover_();
    });

    document.addEventListener('click', (e)=>{
      try{
        const pop = $('logPopover');
        if (!pop || !btn) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        hideLogPopover_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('logPopover')?.classList.contains('show')) showLogPopover_(); });
  }

  function setMiniTitle_(t){
    const title = $('miniBgmTitle');
    const m = $('miniBgmMarquee');
    if (!title || !m) return;
    const safe = String(t || 'BGM Ï§ÄÎπÑ').trim() || 'BGM Ï§ÄÎπÑ';
    m.textContent = safe + ' ‚Ä¢ ' + safe;
    requestAnimationFrame(()=>{
      try{
        title.classList.toggle('marqueeOn', m.scrollWidth > title.clientWidth + 6);
      }catch(e){}
    });
  }

  function syncMiniPlaying_(){
    try{
      const note = $('miniNote');
      if (!note) return;

      const kind = String(bgmRemote_?.kind || 'yt');

      let playing = false;
      if (kind === 'file'){
        try{
          const a = ensureAudioPlayer_();
          playing = !a.paused && !a.ended;
        }catch(e){ playing = false; }
      }else{
        playing = (typeof ytPlayer !== 'undefined' && ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === 1);
      }

      note.classList.toggle('playing', !!playing);

      if (playing){
        if (kind === 'file'){
          const t = bgmRemote_?.title || bgmRemote_?.fileName;
          if (t) setMiniTitle_(t);
        }else{
          try{
            const data = ytPlayer.getVideoData ? ytPlayer.getVideoData() : null;
            const t = data && data.title ? data.title : '';
            if (t) setMiniTitle_(t);
          }catch(e){}
        }
      }
    }catch(e){}
  }

  function initMiniBgmBar_(){
    const bar = $('miniBgmBar');
    if (!bar) return;

    // Wire mini buttons to existing menu buttons (no new logic: ÏïàÏ†Ñ!)
    $('miniPlay')?.addEventListener('click', ()=>{ try{ if (bgmRemote_ && String(bgmRemote_.state||'')==='paused') bgmResume_(); else $('btnBgmPlay').click(); }catch(e){} });
    $('miniPause')?.addEventListener('click', ()=>{ try{ $('btnBgmPause').click(); }catch(e){} });
    $('miniAllow')?.addEventListener('click', ()=>{ try{ $('btnBgmAllow').click(); }catch(e){} });

    // Volume range sync (popover -> existing range)
    const vRange = $('volRange');
    const vVal = $('volVal');

    function applyVol_(v){
      const vv = clamp_(Number(v||0),0,100);
      if (vRange) vRange.value = String(vv);
      if (vVal) vVal.textContent = String(vv);
      try{
        const base = $('bgmVol');
        if (base){
          base.value = String(vv);
          base.dispatchEvent(new Event('input', { bubbles:true }));
        }
      }catch(e){}
    }

    try{ applyVol_(Number($('bgmVol')?.value || 60)); }catch(e){}

    vRange?.addEventListener('input', ()=> applyVol_(Number(vRange.value||0)));

    $('miniVolBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggleVolPopover_(); });

    document.addEventListener('click', (e)=>{
      try{
        const pop = $('volPopover');
        const btn = $('miniVolBtn');
        if (!pop || !btn) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        hideVolPopover_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('volPopover')?.classList.contains('show')) showVolPopover_(); });

    // mini title initial
    setMiniTitle_($('bgmState')?.textContent || 'BGM Ï§ÄÎπÑ');

    // periodically sync playing state + title
    setInterval(syncMiniPlaying_, 900);
  }

  // =====================
  // PATCH: Unified Picker (emoji/command)
  // =====================
  const PICKER_EMOJI = {"ÌëúÏ†ï": ["üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô", "ü´¢", "ü§≠", "ü§ó", "üòù", "ü§™", "üòú", "üòõ", "üòã", "üòè", "ü•≤", "ü´£", "ü§´", "ü§î", "ü´°", "ü§§", "ü§†", "ü•≥", "ü•∏", "üòé", "ü§ì", "ü´•", "üò∂", "üòë", "üòê", "ü§®", "ü§ê", "ü´†", "üôÉ", "üßê", "üòí", "üôÑ", "üò¨", "üòÆ‚Äçüí®", "ü§•", "ü´®", "üòå", "üòî", "ü•∂", "ü•µ", "ü§ß", "ü§Æ", "ü§¢", "ü§ï", "ü§í", "üò∑", "üò¥", "üò™", "ü•¥", "üòµ", "üòµ‚Äçüí´", "ü§Ø", "ü•±", "üòï", "ü´§", "üòü", "üôÅ", "üò∞", "üò®", "üòß", "üò¶", "ü•π", "ü•∫", "üò≥", "üò≤", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "üòΩ", "üôÄ", "üòø", "üòæ", "üôà", "üôâ", "üôä", "üß¨", "ü¶ç", "ü¶ß", "ü¶Æ", "ü¶ä", "ü¶ù", "ü¶Å", "ü´é", "ü´è", "ü¶Ñ", "ü¶ì", "ü¶å", "ü¶¨", "ü¶â", "ü¶©", "ü¶ö", "ü¶ï", "ü¶ñ", "ü¶Ä", "ü™º", "ü¶ê", "ü¶ë", "ü¶ã", "ü™∑", "ü•Ä", "ü™ª", "ü™µ", "ü™ê", "üòØ", "üòÆ", "üò•", "üò¢", "üò≠", "üò±", "üòñ", "üò£", "üòû", "üòì", "üò©", "üò´", "üò§", "üò°", "üò†", "ü§¨", "üòà", "ü•≠", "ü´ê", "ü•ù", "ü´í", "ü••", "ü•¶", "ü•¨", "ü•í", "ü´ë", "ü•ï", "ü•î", "ü•ë", "üßÑ", "üßÖ", "ü•ú", "ü´ò", "ü´ö", "ü´õ", "ü•ê", "ü•©", "üßÄ", "üßá", "ü•û", "ü•Ø", "ü•®", "ü´ì", "ü•ñ", "ü•ì", "ü•™", "ü•ô", "üßÜ", "ü•ö", "ü•ò", "ü´ï", "ü•£", "ü•ó", "üßà", "ü•´", "üßÇ", "ü•Æ", "ü•ü", "ü•†", "ü•°", "ü•ß", "üßÅ", "ü•õ", "ü´ñ", "üßã", "ü•§", "ü´ó", "ü•É", "ü•Ç", "ü•º", "ü¶∫", "ü™Æ", "ü™ì", "ü™õ", "ü™†", "üß∫", "üß¥", "ü™í", "ü©π", "ü©º", "üßº", "ü™£", "ü´ß", "ü™•", "üßΩ", "üßØ", "ü©µ", "ü©∑", "ü©∂"], "ÌïòÌä∏": ["‚ò∫Ô∏è", "üò∂‚Äçüå´Ô∏è", "üôÇ‚Äç‚ÜîÔ∏è", "üôÇ‚Äç‚ÜïÔ∏è", "‚òπÔ∏è", "üêª‚Äç‚ùÑÔ∏è", "üèµÔ∏è", "‚òÄÔ∏è", "‚òÅÔ∏è", "‚õàÔ∏è", "üå§Ô∏è", "üå•Ô∏è", "üå¶Ô∏è", "üåßÔ∏è", "üå®Ô∏è", "üå©Ô∏è", "üå™Ô∏è", "‚ùÑÔ∏è", "‚õ±Ô∏è", "‚òÇÔ∏è", "üå¨Ô∏è", "üå´Ô∏è", "‚òÉÔ∏è", "‚òÑÔ∏è", "üå∂Ô∏è", "üíç", "üíé", "‚úèÔ∏è", "‚úíÔ∏è", "‚úÇÔ∏è", "‚õèÔ∏è", "‚öíÔ∏è", "üõ†Ô∏è", "üó°Ô∏è", "‚öîÔ∏è", "üíå", "üíò", "üíù", "üíñ", "üíó", "üíì", "üíû", "üíï", "üíü", "‚ù£Ô∏è", "üíô", "üíö", "üíõ", "üß°", "‚ù§Ô∏è", "‚ù§Ô∏è‚Äçü©π", "‚ù§Ô∏è‚Äçüî•", "üíî", "üíú", "ü§é", "üñ§", "ü§ç", "üóØÔ∏è", "üó®Ô∏è", "üëÅÔ∏è‚Äçüó®Ô∏è", "üï≥Ô∏è", "‚ö†Ô∏è", "‚ÅâÔ∏è", "„Ä∞Ô∏è", "‚ÄºÔ∏è"], "ÏÇ¨Î¨º": ["üëÄ", "üëÑ", "üíÆ", "üíß", "üëø", "üíÄ", "üí©", "üëª", "üëΩ", "üëì", "üëî", "üëô", "üë†", "üëë", "üëí", "üíÑ", "üì¢", "üìª", "üì∫", "üì∑", "üí£", "üíâ", "üíã", "üíØ", "üí¢", "üí•", "üí¶", "üí§", "üí≠", "üí¨", "üí®", "üìµ", "üì∂"], "ÎèôÎ¨º": ["üêµ", "üêí", "üê∂", "üêï", "üêï‚Äçü¶∫", "üê©", "üê∫", "üê±", "üêà", "üêà‚Äç‚¨õ", "üêØ", "üêÖ", "üêÜ", "üê¥", "üêé", "üêÆ", "üêÇ", "üêÉ", "üêÑ", "üê∑", "üêñ", "üêó", "üêΩ", "üêè", "üêê", "üê™", "üêò", "üê≠", "üêπ", "üê∞", "üêº", "üêª", "üê®", "üêî", "üê£", "üê§", "üê•", "üêß", "üê∏", "üê≥", "üêã"], "ÏûêÏó∞": ["üå∏", "üåπ", "üå∫", "üåª", "üåº", "üå∑", "üçÄ", "üçÅ", "üçÇ", "üçÑ", "üçá", "üçà", "üçâ", "üçä", "üçã", "üçã‚Äçüü©", "üçå", "üçç", "üçé", "üçè", "üçê", "üçë", "üçí", "üçì", "üçÖ", "üåΩ", "üçÜ", "üå∞", "üçÑ‚Äçüü´", "üçû", "üçó", "üçñ", "üçî", "üçü", "üçï", "üç≥", "üç≤", "üçø", "üç†", "üçú", "üçõ", "üçö", "üçô", "üçò", "üç±", "üçù", "üç¢", "üç£", "üç§", "üç•", "üç°", "üç¶", "üç¨", "üç´", "üç∞", "üç™", "üç©", "üç®", "üçß", "üç≠", "üçØ", "üçº", "üçµ", "üç∂", "üçæ", "üç∫", "üçπ", "üç∑"], "ÎÇ†Ïî®/Ï≤úÏ≤¥": ["üåô", "üåõ", "üåú", "üåù", "üåû", "üåü", "üå†", "üåå", "‚õÖ", "‚ö°", "‚òî", "üåÇ", "üåà", "üåÄ", "‚õÑ", "üåä", "üå≠", "üåØ", "üåÆ", "‚òï", "‚õî"], "Í∏∞ÌÉÄ": ["‚≠ê", "üî•", "üî™", "‚è∞", "üîë", "üî®", "üöΩ", "üöø", "üõí", "üü†", "üî¥", "üîò", "üõó", "üö∏", "üö´", "üîû", "üö∑", "üö±", "üöØ", "üö≠", "üö≥", "üîÖ"], "ÌñâÏÇ¨": ["üéÇ", "üéÄ", "üéí", "üéº", "üé§", "üéß", "üéπ"], "Í∏∞Ìò∏": ["‚ùì", "‚ùî", "‚ùï", "‚ùó", "‚ùå"]};
  const PICKER_CMDS = ["/ÏôÑÍ≤∞", "/Ï∂ïÌïò", "/ÌïòÌä∏", "/Î∞òÏßù", "/ÎààÍΩÉ", "/Î∞ïÏàò", "/ÌôòÏòÅ", "/Í≥†Ï∂î", "/ÎΩÄÎΩÄ", "/Î∂êÏóÖ", "/Í≤ΩÍ≥†", "/ÎåÑÏä§", "/ÎßàÍ∞ê", "/ÏïàÎÖï", "/ÍµøÎ∞îÏù¥", "/ÎÅÑÎçï", "/Ï†úÎ∞ú", "/ÏàòÏ§ç", "/ÌòÑÌÉÄ", "/Í∞ÅÏÑ±", "/ÏòÅÍ∞ê", "/Ìá¥Í≥†", "/Îñ°Î∞•", "/Ï†ïÏ£ºÌñâ", "/Ïó∞Ïû¨"];
  const LS_PICKER_FAV = 'SUDABANG_PICKER_FAV_V1';

  function safeGetLS_(k, defVal){
    try{ return localStorage.getItem(k) ?? defVal; }catch(e){ return defVal; }
  }
  function safeSetLS_(k, v){ try{ localStorage.setItem(k, v); }catch(e){} }

  function getFav_(){
    try{
      const raw = safeGetLS_(LS_PICKER_FAV, '[]');
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) return arr.slice(0, 80);
    }catch(e){}
    return [];
  }
  function setFav_(arr){ safeSetLS_(LS_PICKER_FAV, JSON.stringify(arr || [])); }

  function insertAtCursor_(ta, text){
    if (!ta) return;
    ta.focus();
    const start = (ta.selectionStart ?? ta.value.length);
    const end = (ta.selectionEnd ?? ta.value.length);
    const before = ta.value.slice(0, start);
    const after = ta.value.slice(end);
    ta.value = before + text + after;
    const pos = start + text.length;
    ta.setSelectionRange(pos, pos);
    ta.dispatchEvent(new Event('input', { bubbles:true }));
  }

  let pickerActiveTab_ = 'Ïù¥Î™®ÏßÄ';

  function toggleFav_(e){
    const fav = getFav_();
    const idx = fav.indexOf(e);
    if (idx >= 0) fav.splice(idx, 1);
    else fav.unshift(e);
    setFav_(fav);
  }

  function renderPicker_(){
    const tabs = $('pickerTabs');
    const body = $('pickerBody');
    if (!tabs || !body) return;

    // ‚úÖ Î≤ÑÌäº 3Í∞úÎßå: Ï¶êÍ≤®Ï∞æÍ∏∞ / Î™ÖÎ†πÏñ¥ / Ïù¥Î™®ÏßÄ(Ï†ÑÏ≤¥)
    const keys = ['Ï¶êÍ≤®Ï∞æÍ∏∞','Î™ÖÎ†πÏñ¥','Ïù¥Î™®ÏßÄ'];
    tabs.innerHTML = '';
    keys.forEach((k)=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'pickerTab' + (k === pickerActiveTab_ ? ' active' : '');
      b.textContent = k;
      b.addEventListener('click', ()=>{ pickerActiveTab_ = k; renderPicker_(); });
      tabs.appendChild(b);
    });

    // ‚úÖ Ï†ÑÏ≤¥ Ïù¥Î™®ÏßÄ(Ïπ¥ÌÖåÍ≥†Î¶¨ Ìï©ÏπòÍ≥† Ï§ëÎ≥µ Ï†úÍ±∞)
    const allEmoji = (() => {
      const seen = new Set();
      const out = [];
      Object.values(PICKER_EMOJI || {}).forEach(arr=>{
        (arr || []).forEach(e=>{
          const key = String(e);
          if (seen.has(key)) return;
          seen.add(key);
          out.push(e);
        });
      });
      return out;
    })();

    body.innerHTML = '';

    if (pickerActiveTab_ === 'Î™ÖÎ†πÏñ¥'){
      const wrap = document.createElement('div');
      wrap.className = 'cmdList';
      PICKER_CMDS.forEach((c)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'cmdBtn';
        b.textContent = c;
        b.addEventListener('click', ()=>{
          insertAtCursor_($('msg'), c + ' ');
          hidePicker_();
        });
        wrap.appendChild(b);
      });
      body.appendChild(wrap);
      return;
    }

    const list = (pickerActiveTab_ === 'Ï¶êÍ≤®Ï∞æÍ∏∞') ? getFav_() : allEmoji;
    const grid = document.createElement('div');
    grid.className = 'pickerGrid';

    (list || []).forEach((e)=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'emoBtn';
      b.textContent = e;
      b.title = 'ÌÅ¥Î¶≠=ÏÇΩÏûÖ ¬∑ Ïö∞ÌÅ¥Î¶≠=Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä';
      b.addEventListener('click', ()=>{
        insertAtCursor_($('msg'), e);
        hidePicker_();
      });
      b.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        toggleFav_(e);
        renderPicker_();
      });
      grid.appendChild(b);
    });
    body.appendChild(grid);
  }
function placePicker_(){
    const pop = $('pickerPopover');
    const btn = $('btnPicker');
    if (!pop || !btn) return;

    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || Math.min(520, window.innerWidth - 18);
    const h = pop.offsetHeight || 420;

    const idealTop = r.top - h - 10;
    let top = (idealTop > 10) ? idealTop : (r.bottom + 10);
    // ‚úÖ keep inside viewport (ÌÅ∞ ÌôîÎ©¥/ÏûëÏùÄ ÌôîÎ©¥ Î™®Îëê)
    top = clamp_(top, 10, Math.max(10, window.innerHeight - h - 10));

    const left = clamp_(r.left, 10, window.innerWidth - w - 10);
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
  }

  function showPicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;

    renderPicker_();
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');

    // ‚úÖ DOM layout Î∞òÏòÅ ÌõÑ ÏúÑÏπò Í≥ÑÏÇ∞(Î∞∞Ìè¨ ÌôòÍ≤ΩÏóêÏÑú ÎÜíÏù¥ 0 Î¨∏Ï†ú Î∞©ÏßÄ)
    requestAnimationFrame(()=>{
      placePicker_();
      
    });
  }
  function hidePicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }
  function togglePicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hidePicker_();
    else showPicker_();
  }

  function initPicker_(){
    const btn = $('btnPicker');
    if (!btn) return;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); togglePicker_(); });
    $('pickerClose')?.addEventListener('click', (e)=>{ e.preventDefault(); hidePicker_(); });
    document.addEventListener('click', (e)=>{
      try{
        const pop = $('pickerPopover');
        const btn2 = $('btnPicker');
        if (!pop || !btn2) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn2.contains(e.target)) return;
        hidePicker_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('pickerPopover')?.classList.contains('show')) placePicker_(); });

    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        hideVolPopover_();
        hideLogPopover_();
        hidePicker_();
      }
    });

    pickerActiveTab_ = 'Î™ÖÎ†πÏñ¥';
  }



// ‚úÖ SAFETY: delegate overlay tool buttons even if some bindings fail
document.addEventListener('click', (e)=>{
  try{
    const t = e.target;
    if (!t) return;
    if (t.id === 'ovCloseBtn' || t.closest?.('#ovCloseBtn')){
      e.preventDefault(); e.stopPropagation(); hideOverlay(); return;
    }
    if (t.id === 'ovOkBtn' || t.closest?.('#ovOkBtn')){
      e.preventDefault(); e.stopPropagation(); hideOverlay(); return;
    }
  }catch(err){}
}, true);


  // =====================
  // Boot
  // =====================
  (function boot(){
    const run = async ()=>{
      try{ initUi_(); }catch(e){ console.error(e); }
      try{ startBoomCountdown_(); }catch(e){ console.error(e); }
      try{ await verifyGateTicket_(); }catch(e){ console.error(e); stopAll_(); return; }
      try{ schedulePing(200); }catch(e){ console.error(e); }
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
    else run();
  })();


</script>

</body>
</html>
