<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ğŸ’£Boom!</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%92%A3%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --line:#f2d7ea;
      --text:#2b2b2b;
      --muted:#777;
      --chatMsgPx: 15px; /* ì±„íŒ…(ë©”ì‹œì§€) ê¸€ì”¨ í¬ê¸° */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg);
      color: var(--text);
      /* viewport ì•ˆì •í™”(ëª¨ë°”ì¼ ì£¼ì†Œì°½/ë°°ë„ˆ ë³€ë™ í¬í•¨) */
      min-height: 100vh;
      min-height: calc(var(--vh, 1vh) * 100);
      overflow-x: hidden;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      min-width: 0;
    }
    .icon{
      width:34px;height:34px; display:grid; place-items:center;
      border-radius:12px; background:#ffd1e8;
    }
    .metaSmall{ font-size:12px; color: var(--muted); font-weight:700; margin-top:2px; }
    
    /* ğŸ“Œ Topbar notice pin */
    .brandInfo{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brandText{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .pinBtn{
      width:34px;height:34px; padding:0;
      display:grid; place-items:center;
      border-radius:12px;
      background: rgba(255, 209, 232, .35);
      border: 1px solid rgba(0,0,0,.10);
      font-size: 18px;
      position: relative;
    }
    .pinBtn:hover{ filter:brightness(0.98); }
    .pinBtn.pinNew::after{
      content:"";
      position:absolute;
      top:6px; right:6px;
      width:8px; height:8px;
      border-radius:999px;
      background:#ff4d6d;
      box-shadow: 0 0 0 3px rgba(255,77,109,.18);
    }
    @keyframes pinSwing{
      0%{ transform: rotate(0deg); }
      20%{ transform: rotate(-10deg); }
      40%{ transform: rotate(12deg); }
      60%{ transform: rotate(-8deg); }
      80%{ transform: rotate(8deg); }
      100%{ transform: rotate(0deg); }
    }
    .pinBtn.pinNew{
      transform-origin: 50% 0%;
      animation: pinSwing 1.2s ease-in-out infinite;
    }

    /* ğŸªŸ Overlay resizable mode (for games) */
    .overlayCard.resizable{
      resize: both;
      overflow: auto;
      max-width: 95vw;
      max-height: 90vh;
      min-width: 340px;
      min-height: 460px;
    }

    .actions{ display:flex; gap:8px; align-items:center; position:relative; }
    button{
      border: 0;
      background:#fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ filter:brightness(0.99); }

    /* âœ… DJ ì¬ìƒëª©ë¡: í° ìë™ì¬ìƒ ë²„íŠ¼ */
    .bigPlayBtn{
      border: 1px dashed var(--line);
      background: rgba(255, 209, 232, .30);
      color: #5a2b44;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 1000;
      font-size: 15px;
    }
    .bigPlayBtn:hover{ filter: brightness(0.98); }

    .pill{
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      background:#fff;
    }
    .layout{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap: 12px;
    }
    
@media (max-width: 760px){
      :root{ --chatMsgPx: 14px; }
  /* âœ… ëª¨ë°”ì¼: í™”ë©´ì„ 'í•œ í˜ì´ì§€'ë¡œ ê³ ì •í•˜ê³ , ì±„íŒ…(#log)ë§Œ ìŠ¤í¬ë¡¤ë˜ê²Œ */
  html, body{
    height: calc(var(--vh, 1vh) * 100);
  }
  body{
    overflow: hidden; /* í˜ì´ì§€ ëŠ˜ì–´ì§ ë°©ì§€ */
  }
  .wrap{
    height: 100%;
    max-width: 100%;
  }
  .layout{
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  /* ì‚¬ì´ë“œ ì¹´ë“œ(ì ‘ì†ì)ëŠ” ëª¨ë°”ì¼ì—ì„œ í•œ ì¤„/ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ ì»´íŒ©íŠ¸í•˜ê²Œ */
  .side{
    padding: 10px 12px;
  }
  .onlineList{
    display:flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    max-height: 44px;
    padding-bottom: 2px;
  }
  .nameChip{ white-space: nowrap; }
  .side .hint{
    margin-top: 6px !important;
    font-size: 12px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ë©”ì¸ ì±„íŒ… ì¹´ë“œê°€ ë‚¨ì€ ë†’ì´ë¥¼ ê½‰ ì±„ìš°ê³ , #logë§Œ ìŠ¤í¬ë¡¤ */
  .layout > .card:not(.side){
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  #log{
    flex: 1 1 auto;
    min-height: 0;
    height: auto;
  }

  /* âœ… ëª¨ë°”ì¼ ì ‘ì†ì ìœ„ì¹˜ ì¡°ì • */
  .side{ margin-top: 0; }
  .side h3{ margin-bottom: 6px; }
  .onlineList{ max-height: 140px; }
  .wrap{ padding: 10px; padding-top: calc(10px + var(--chromeTop, 0px)); }
  .layout{ grid-template-columns: 1fr; }
  .side{ order: -1; }

  /* âœ… ëª¨ë°”ì¼ ì•ˆì •í™” */
  input, textarea{ font-size: 16px; } /* iOS ìë™ í™•ëŒ€ ë°©ì§€ */
  body{ padding-bottom: env(safe-area-inset-bottom); }
  #log{ -webkit-overflow-scrolling: touch; }
  .topbar{ position: sticky; top: var(--chromeTop, 0px); z-index: 60; padding-top: calc(10px + env(safe-area-inset-top)); }

  /* ì±„íŒ… ì…ë ¥ì°½: ìë™ í™•ì¥ ë°©ì§€(ì‚¬ìš©ìê°€ ì§ì ‘ ëŠ˜ë¦¬ì§€ ì•Šìœ¼ë©´ ê³ ì •) */
  #msg{
    height: 38px !important;
    max-height: 38px !important;
    overflow-y: auto !important;
    resize: none !important;
  }

  /* ëª¨ë°”ì¼ì—ì„  ì „ì†¡ ë²„íŠ¼ ì œê±°(Enter=ì „ì†¡) */
  #sendBtn{ display:none !important; }
  .sendRow{ grid-template-columns: 1fr !important; }
}
    .card{
      position: relative;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 10px 28px rgba(0,0,0,.06);
      padding: 12px;
    }
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      outline:none;
      background:#fff;
    }
    textarea{ resize: vertical; }
    .nameRow{
      display:flex; align-items:center; gap:8px;
      flex-wrap: nowrap;
      margin-bottom: 10px;
      min-width: 0;
    }
    /* âœ… nameRow: í•œ ì¤„ ì •ë ¬(PC) */
    .nameRow .noticeBtn{
      height: 44px;
      padding: 0 12px;
      font-size: 14px;
      border-radius: 14px;
      flex: 0 0 auto;
    }
    .nameRow #btnRace,
    .nameRow #btnAcid,
    .nameRow #btnMarble,
    .nameRow #btnRummi{
      min-width: 136px;
    }
    .nameRow #user{
      height: 44px;
      padding: 0 10px;
      flex: 0 0 120px;
      width: 120px;
      border-radius: 14px;
    }
    @media (max-width: 760px){
      .nameRow{ flex-wrap: wrap; }
      .nameRow #btnRace, .nameRow #btnAcid, .nameRow #btnMarble, .nameRow #btnRummi{ min-width: 0; flex: 1 1 160px; }
      .nameRow #user{ flex: 1 1 140px; width: auto; }
    }

    #user{ width: 120px; flex: 0 0 120px; text-align:center; }
    #btnRace, #btnMarble, #btnRummi{ flex: 1 1 210px; min-width: 170px; }
    #btnRace{ }

    /* âœ… ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ ì •ë¦¬ (v25)
       - ë¶€ë£¨ë§ˆë¸”/ë£¨ë¯¸íë¸Œ ë²„íŠ¼ ìˆ¨ê¹€
       - íƒ€ì´í•‘ ë ˆì´ìŠ¤ ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
    

/* âœ… ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ 3ì¢…: ê°€ì´ë“œ/ì±„íŒ…ì¡°ì ˆ ë²„íŠ¼ í†¤ê³¼ í†µì¼ */
.miniGameBtn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 10px 12px;
  height: 44px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2b44;
  font-weight: 900;
  font-size: 15px;
  letter-spacing: .1px;
  white-space: nowrap;
  user-select: none;
  cursor: pointer;
}
.miniGameBtn:hover{ filter: brightness(0.98); }
.miniGameBtn:active{ transform: translateY(1px); }

/* nameRowì—ì„œ 3ê°œ ë²„íŠ¼ì´ ë‚˜ë€íˆ(PC), ëª¨ë°”ì¼ì€ ì¤„ë°”ê¿ˆ */
.nameRow #btnRace,
.nameRow #btnAcid,
.nameRow #btnMarble{
  flex: 1 1 160px;
  min-width: 160px;
}
@media (max-width: 760px){
  .nameRow #btnRace,
  .nameRow #btnAcid,
  .nameRow #btnMarble{
    flex: 1 1 160px;
    min-width: 0;
  }
}

/* âœ… ê³µì§€ ë²„íŠ¼(ë½€ëª¨ ì¸ë±ìŠ¤ ëŠë‚Œ ê·¸ëŒ€ë¡œ) */
#btnRace.noticeBtn, #btnMarble.noticeBtn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2b44;
  font-weight: 900;
  font-size: 15px;
  letter-spacing: .1px;
  white-space: nowrap;
  overflow: hidden;
  user-select: none;
  cursor: pointer;
}
#btnRace.noticeBtn:hover, #btnMarble.noticeBtn:hover:hover{ filter: brightness(0.98); }
#btnRace.noticeBtn:active, #btnMarble.noticeBtn:active:active{ transform: translateY(1px); }
#btnRace.noticeBtn .label, #btnMarble.noticeBtn .label .label{
  font-weight: 900;
  flex: 0 0 auto;
}
#btnRace.noticeBtn .preview, #btnMarble.noticeBtn .preview .preview{
  opacity: .75;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 0 1 auto;
  max-width: 70%;
  min-width: 0;
  text-align: left;
}

/* âœ… íƒ€ì´í•‘ ë ˆì´ìŠ¤ ë²„íŠ¼ í†¤ */
#btnRace.raceBtn{
  background: rgba(186, 230, 253, .25);
  color: #1f3b52;
  border-style: dashed;
}
    

#btnRace.raceBtn:hover{ filter: brightness(0.985); }

/* âœ… Rummikub button */
#btnRummi.rummiBtn{
  background: rgba(210, 230, 255, .28);
  color: #1f2d52;
  border-style: dashed;
}
#btnRummi.rummiBtn:hover{ filter: brightness(0.985); }


#btnMarble{ flex: 0 0 auto; min-width: 152px; min-height: 46px; }
#btnMarble.noticeBtn{
  background: rgba(255, 229, 153, .28);
  border: 1px dashed rgba(180, 140, 30, .35);
  color: #513b0b;
}
#btnMarble.noticeBtn:hover{ filter: brightness(0.985); }
#btnMarble.noticeBtn:active{ transform: translateY(1px); }
#btnMarble.noticeBtn .preview{ opacity: .85; }

/* âœ… Race Start (ë‚œì´ë„ ì„ íƒ) â€” ê½‰ ì°¬ ë ˆì´ìŠ¤ ëŠë‚Œ */
.raceStartWrap{ text-align:left; }
.raceStartHero{
  border:1px solid rgba(0,0,0,.06);
  border-radius: 16px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(186,230,253,.20), rgba(255,209,232,.18));
  position: relative;
  overflow:hidden;
}
.raceStartHero:before{
  content:"";
  position:absolute; inset:-40px;
  background:
    radial-gradient(circle at 18% 28%, rgba(255,255,255,.75), transparent 55%),
    radial-gradient(circle at 78% 68%, rgba(255,255,255,.55), transparent 55%),
    repeating-linear-gradient(135deg, rgba(0,0,0,.04) 0 10px, transparent 10px 20px);
  transform: rotate(-2deg);
  opacity:.55;
}
.raceStartHeroInner{ position:relative; display:flex; gap:10px; align-items:center; }
.raceHeroBadge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius: 999px;
  background: rgba(255,255,255,.72);
  border:1px solid rgba(0,0,0,.06);
  font-weight: 950;
}
.raceHeroTrack{
  flex:1;
  border-radius: 14px;
  padding: 10px 10px;
  background: rgba(255,255,255,.74);
  border:1px solid rgba(0,0,0,.06);
}
.trackLane{
  display:flex; align-items:center; gap:10px;
  padding: 6px 8px;
  border-radius: 12px;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,.05) 0 8px, transparent 8px 16px);
  border: 1px dashed rgba(0,0,0,.09);
}
.trackCars{ font-size: 18px; letter-spacing: 2px; }
.trackMeta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.metaPill{
  font-weight: 900; font-size: 12px;
  padding: 6px 10px; border-radius: 999px;
  background: rgba(0,0,0,.04);
  border:1px solid rgba(0,0,0,.06);
}
.raceDiffGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: 12px;
}


.raceDiffPill{
  border: 1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.82);
  border-radius: 999px;
  padding: 8px 14px;
  font-weight: 950;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
}
.raceDiffPill:hover{ transform: translateY(-1px); }
.raceDiffCard{
  text-align:left;
  border-radius: 16px;
  padding: 12px 12px 10px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.78);
  cursor:pointer;
  transition: transform .12s ease, filter .12s ease;
}
.raceDiffCard:hover{ filter: brightness(0.99); transform: translateY(-1px); }
.raceDiffCard:active{ transform: translateY(0px); }
.raceDiffTop{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.raceDiffName{ font-weight: 950; font-size: 16px; }
.raceDiffTag{
  font-weight: 950; font-size: 12px;
  padding: 4px 8px; border-radius: 999px;
  border:1px solid rgba(0,0,0,.08);
  background: rgba(0,0,0,.03);
}
.raceSample{
  margin-top: 8px;
  font-size: 12.5px;
  font-weight: 900;
  line-height: 1.35;
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,.03);
  border:1px dashed rgba(0,0,0,.08);
  max-height: 82px;
  overflow:hidden;
}
.raceDiffHint{ margin-top: 8px; font-size: 12px; opacity: .82; font-weight: 850; line-height:1.35; }
.raceDiffCard.low{ background: rgba(255,255,255,.82); }
.raceDiffCard.mid{ background: rgba(255,255,255,.82); }
.raceDiffCard.high{ background: rgba(255,255,255,.82); }
.raceStartRules{
  margin-top: 10px;
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(255,255,255,.62);
  border:1px solid rgba(0,0,0,.06);
}
.raceStartRules ul{ margin: 0; padding-left: 18px; }
.raceStartRules li{ margin: 6px 0; font-weight: 900; opacity:.9; }
.raceStartFoot{
  margin-top: 8px;
  display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
}
.raceLastPick{ font-weight: 950; opacity:.8; }
.raceMiniNote{ font-size: 12px; font-weight: 900; opacity:.75; }

/* âœ… Guide overlay */
.guideWrap{ text-align:left; }
.guideHead{ display:flex; align-items:center; gap:10px; margin-bottom: 10px; }
.guideBadge{
  font-weight: 950;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,209,232,.35);
  border: 1px solid rgba(0,0,0,.06);
}
.guideTitle{ font-weight: 950; font-size: 16px; }
.guidePre{ white-space:pre-wrap; font-size:13px; line-height:1.55; margin:0; }

/* âœ… Rummikub (beta) */
.rkWrap{ text-align:left; }
.rkHead{ display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom: 10px; }
.rkTitle{ font-weight: 1000; font-size: 16px; }
.rkSub{ font-weight: 900; opacity:.82; font-size: 12.5px; }
.rkSetup{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0 6px; }
.rkLbl{ font-weight: 950; opacity:.85; }
.rkSetup select{ padding: 8px 10px; border-radius: 12px; border:1px solid rgba(0,0,0,.12); font-weight: 900; }
.rkCtrl{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0; }
.rkRack{ padding: 10px 12px; border-radius: 14px; background: rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.08); }
.rkRackTiles{ margin-top: 8px; display:flex; flex-wrap:wrap; gap:6px; }
.rkTile{
  display:inline-flex; align-items:center; justify-content:center;
  width: 32px; height: 40px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.92);
  font-weight: 1000;
  user-select:none;
}
.rkTile.joker{ background: rgba(0,0,0,.06); }
.rkTile.cR{ color: #b3242a; }
.rkTile.cB{ color: #1f5fbf; }
.rkTile.cG{ color: #197a4a; }
.rkTile.cK{ color: #111; }
.rkHint{ margin-top: 10px; font-weight: 900; opacity:.8; font-size: 12.5px; line-height:1.4; }


/* âœ… Blue Marble overlay */
.marbleWrap{ text-align:left; }
.marbleTop{
  display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;
  margin-bottom: 10px;
}
.marbleHow{
  flex: 1 1 240px;
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(209,250,229,.34);
  border:1px solid rgba(0,0,0,.06);
  font-weight: 900;
  line-height: 1.45;
}
.marbleBtns{
  flex: 0 0 auto;
  display:flex; gap:8px; align-items:stretch;
}
.marbleBtns button{ white-space:nowrap; font-weight: 950; }
.marbleGrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 8px;
  margin-top: 8px;
}

    .marbleBanner{ display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 14px 0; }
    .turnRow{ display:flex; flex-wrap:wrap; gap:6px; }
    .turnChip{ padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.75); border:1px solid rgba(0,0,0,.08); font-size:13px; }
    .turnChip.cur{ box-shadow: 0 0 0 3px rgba(255,77,109,.18); }
    .turnChip.dead{ opacity:.45; filter: grayscale(1); text-decoration: line-through; }

.marbleTile{
  border-radius: 14px;
  padding: 8px 8px 6px;
  background: rgba(255,255,255,.78);
  border:1px solid rgba(0,0,0,.08);
  min-height: 66px;
  position: relative;
  overflow:hidden;
}
.marbleTile:before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.8), transparent 55%);
  opacity:.45;
  pointer-events:none;
}
.tileTop{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:6px; }
.tileIcon{ font-size: 16px; }
.tileName{ font-weight: 950; font-size: 12px; opacity:.92; }
.tileDesc{ font-weight: 950; font-size: 11px; opacity:.75; }
.tileTokens{ position:relative; margin-top: 6px; display:flex; flex-wrap:wrap; gap:4px; }
.tokenChip{
  display:inline-flex; align-items:center; justify-content:center;
  width: 22px; height: 22px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 950;
  color: #fff;
  border:1px solid rgba(255,255,255,.35);
}
.marblePanels{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap: 10px;
  margin-top: 10px;
}
.marblePanel{
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(0,0,0,.03);
  border:1px solid rgba(0,0,0,.06);
}
.marblePanel h4{ margin:0 0 8px; font-size: 13px; font-weight: 950; }
.rankRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0; font-weight: 950; }
.rankRow .nm{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 160px; }
.rankRow .val{ opacity:.8; }

/* âœ… small screens: nameRow wrap to keep buttons alive */
@media (max-width: 420px){
  .nameRow{ flex-wrap:wrap; }
  #user{ width:100%; flex: 1 1 100%; }
  #btnRace, #btnMarble{ flex: 1 1 calc(50% - 6px); }
}

/* âœ… íƒ€ì´í•‘ ë ˆì´ìŠ¤ ë°” */
.raceBar{
  display:none;
  border: 1px dashed var(--line);
  border-radius: 14px;
  padding: 10px 12px;
  margin: 8px 0 10px;
  background: rgba(186, 230, 253, .18);
}
.raceBar.show{ display:block; }

/* --- Typing Race: mini track + strict mode --- */
.raceMiniTrack{
  margin-top: 8px;
  border-radius: 999px;
  padding: 8px 10px;
  background: rgba(255,255,255,.72);
  border:1px solid rgba(0,0,0,.08);
  position: relative;
  overflow:hidden;
}
.raceMiniTrack:before{
  content:"";
  position:absolute; inset:0;
  background: repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0 10px, rgba(0,0,0,0) 10px 20px);
  opacity:.28;
  pointer-events:none;
}
.raceLane{ position:relative; height: 22px; margin: 6px 0; }
.raceNamePill{
  position:absolute; left: 0; top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  font-weight: 950;
  padding: 2px 7px;
  border-radius: 999px;
  background: rgba(255,255,255,.88);
  border:1px solid rgba(0,0,0,.08);
  max-width: 44%;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.raceCar{
  position:absolute; top: 50%;
  transform: translate(-50%, -50%);
  transition: left .12s linear;
  font-size: 16px;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
}
.raceCar.medal1{ font-size: 18px; }
.raceCar.medal2{ opacity:.95; }
.raceCar.medal3{ opacity:.9; }

.raceStrictBtn{
  display:inline-flex; align-items:center; justify-content:center;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.85);
  font-weight: 950;
  cursor: pointer;
}
.raceStrictBtn.off{ opacity:.7; }
.raceStrictBtn:active{ transform: translateY(1px); }

#raceInput.eliminated{
  border-color: rgba(255, 0, 90, .35) !important;
  background: rgba(255, 0, 90, .06) !important;
}
.raceBar.eliminated{ animation: raceShake .28s ease-in-out; }
@keyframes raceShake{
  0%{ transform: translateX(0); }
  25%{ transform: translateX(-4px); }
  50%{ transform: translateX(4px); }
  75%{ transform: translateX(-3px); }
  100%{ transform: translateX(0); }
}

.raceTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.raceTitle{ flex:1; min-width:0; }
.raceTitle .tag{
  display:inline-flex; align-items:center; justify-content:center;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px dashed rgba(31,59,82,.25);
  font-weight: 950;
  font-size: 12px;
  background: rgba(255,255,255,.75);
  margin-right: 8px;
  white-space: nowrap;
}
.raceTitle .txt{
  font-weight: 950;
  font-size: 13px;
  color:#23394d;
  line-height: 1.25;
  word-break: keep-all;
}
.raceTools{ display:flex; align-items:center; gap:8px; flex: 0 0 auto; }
.raceTimer{
  font-weight: 950;
  font-size: 12px;
  opacity: .85;
  white-space: nowrap;
}
.raceMiniBtn{
  height: 34px;
  min-width: 34px;
  border-radius: 12px;
  border: 1px dashed var(--line);
  background: rgba(255,255,255,.65);
  font-weight: 950;
  cursor:pointer;
}
#raceInput{
  margin-top: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 950;
}

.raceDiffView{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.85);
  font-weight: 900;
  line-height: 1.35;
}
.raceDiffView .ok{ opacity:.9; }
.raceDiffView .bad{
  background: rgba(255, 59, 59, .18);
  border-bottom: 2px solid rgba(255, 59, 59, .65);
  border-radius: 6px;
  padding: 0 2px;
}
.raceDiffView .miss{
  background: rgba(255, 196, 0, .18);
  border-bottom: 2px solid rgba(255, 196, 0, .65);
  border-radius: 6px;
  padding: 0 2px;
}
.raceHint{
  margin-top: 8px;
  font-size: 12px;
  font-weight: 950;
  color: #7a2b2b;
  background: rgba(255, 236, 236, .8);
  border: 1px solid rgba(255, 120, 120, .25);
  padding: 8px 10px;
  border-radius: 12px;
  display:none;
}
.raceHint.show{ display:block; }
.raceBottom{ display:flex; align-items:center; gap:10px; margin-top: 8px; }
.raceProgress{
  flex: 1;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.7);
  border: 1px solid rgba(31,59,82,.10);
  overflow:hidden;
}
#raceProgBar{
  height:100%;
  width:0%;
  border-radius: 999px;
  background: rgba(31, 59, 82, .55);
  transition: width .12s linear;
}
.raceRank{
  flex: 0 0 auto;
  font-size: 12px;
  font-weight: 950;
  color:#1f3b52;
  opacity: .9;
  white-space: nowrap;
}
.raceScore{
  margin-top: 8px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
}
.raceChip{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px dashed rgba(31,59,82,.25);
  background: rgba(255,255,255,.75);
  font-weight: 950;
  font-size: 12px;
}
.raceChip .sub{ opacity:.75; font-weight: 900; }




/* ğŸ Race track UI */
.raceBar{
  background-image:
    linear-gradient(90deg, rgba(255,255,255,.65), rgba(255,255,255,.65)),
    repeating-linear-gradient(45deg, rgba(31,59,82,.06) 0 12px, rgba(255,255,255,.0) 12px 24px);
  background-blend-mode: normal, multiply;
}
.raceSteps{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px dashed rgba(31,59,82,.18);
  background: rgba(255,255,255,.65);
}
.stepDot{
  flex: 1 1 0;
  height: 16px;
  border-radius: 999px;
  border: 1px solid rgba(31,59,82,.18);
  background: rgba(31,59,82,.06);
  position: relative;
  overflow:hidden;
}
.stepDot::after{
  content:'';
  position:absolute;
  inset:0;
  background: rgba(31,59,82,.42);
  transform: scaleX(0);
  transform-origin: 0% 50%;
  transition: transform .16s ease;
}
.stepDot.done::after{ transform: scaleX(1); }
.stepDot.active{
  box-shadow: 0 0 0 3px rgba(31,59,82,.12);
  background: rgba(31,59,82,.10);
}
.stepDot.active::after{ transform: scaleX(.25); }
.stepFlag{
  flex: 0 0 auto;
  font-size: 14px;
  opacity: .85;
}
.raceHintLine{
  margin-top: 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size: 12px;
  font-weight: 950;
  color:#1f3b52;
  opacity:.9;
}
.raceHintLine .bad{ color:#b10053; }
    
.iconBtnSmall{
  flex: 0 0 auto;
  height: 44px;
  width: 44px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: rgba(255, 209, 232, .25);
  color: #5a2f44;
  font-weight: 900;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.iconBtnSmall:hover{ transform: translateY(-1px); }

/* âœ… ê³µì§€(ê´€ë¦¬ì ì „ìš© ì‘ì„±) ì˜¤ë²„ë ˆì´ UI (ë½€ëª¨ ìŠ¤íƒ€ì¼ í†¤) */
.noticeBox{ text-align:left; }
.noticeMeta{
  font-size:12px;
  color:#5a2b44;
  opacity:.85;
  font-weight:900;
  margin-bottom:6px;
}
.noticeText{
  white-space:pre-wrap;
  word-break:break-word;
  overflow-wrap:anywhere;
  background: rgba(255, 209, 232, .20);
  border: 1px dashed rgba(0,0,0,0.10);
  padding:10px 12px;
  border-radius:14px;
  line-height:1.55;
  font-weight:800;
  color:#3b2330;
}
.noticeActions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:8px;
  flex-wrap:wrap;
}
.noticeActions .miniBtn{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.08);
  background:#fff;
  color:#333;
  cursor:pointer;
  font-weight:900;
}
.noticeActions .miniBtn:hover{ filter: brightness(0.98); }
.noticeEditArea{
  width:100%;
  min-height:180px;
  resize:vertical;
  border-radius:14px;
  padding:10px 12px;
  border:1px solid rgba(0,0,0,0.12);
  background:#fff;
  color:#222;
  outline:none;
  box-sizing:border-box;
  font-weight:850;
}
.noticeHelp{
  font-size:12px;
  color:#5a2b44;
  opacity:.85;
  font-weight:800;
  margin-top:8px;
}

#noticePreview{
      opacity:.75;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      min-width:0; max-width:70%;
      text-align:left;
    }

    #log{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      height: 320px; /* ê¸°ë³¸ê°’(ìŠ¬ë¼ì´ë”ë¡œ ì¡°ì ˆ) */
      overflow:auto;
    }

    .jumpBtn{
      position:absolute;
      left:50%;
      bottom: 84px; /* above composer */
      transform: translateX(-50%);
      z-index: 50;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 1000;
      background: rgba(255,255,255,.95);
      box-shadow: 0 14px 40px rgba(0,0,0,.16);
      display:none;
    }
    .jumpBtn.show{ display:inline-flex; align-items:center; gap:8px; }
    .jumpBtn .cnt{
      font-size:12px;
      opacity:.85;
      font-weight:1000;
    }
    .row{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .metaLine{ display:none; font-size:12px; color: var(--muted); font-weight:900; }
    .bubble{
      display:inline-block;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      font-size: var(--chatMsgPx, 15px);
      line-height:1.35;
      font-weight:850;
      box-shadow:none;
    }

    .bubbleRow{
      display:flex;
      align-items:flex-end;
      gap:6px;
      max-width:100%;
    }
    .msgTime{
      font-size:11px;
      color: var(--muted);
      font-weight:900;
      white-space:nowrap;
      opacity:.85;
      flex:0 0 auto;
    }
    .mine .bubbleRow{ justify-content:flex-end; }
    .theirs .bubbleRow{ justify-content:flex-start; }
    .system .bubbleRow{ justify-content:center; }
    .nickBadge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 4px 8px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: 12px;
  margin-right: 8px;
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.65);
  vertical-align: middle;
}
.nickEmoji{ font-size: 14px; line-height:1; }
.nickName{ font-weight: 1000; }
.msgText{ vertical-align: middle; }

    .mine{ align-items:flex-end; }
    .mine .bubble{ background: #dffaf3; }
    .theirs{ align-items:flex-start; }
    .theirs .bubble{ background: #ffe3ee; }
    .system{ align-items:center; }
    .system .bubble{ background:#fff4cc; border-style:dashed; font-weight:900; }

    .sendRow{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      align-items: end;
    }
    /* PCì—ì„œë„ ì „ì†¡ ë²„íŠ¼ ìˆ¨ê¹€(Enter=ì „ì†¡) */
    #sendBtn{ display:none; }

    .hint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      line-height:1.35;
    }

    .side h3{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 1000;
    }
    .onlineList{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height: 340px;
      overflow:auto;
      padding-right: 4px;
      align-content:flex-start;
    }
    .nameChip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.8);
      font-weight: 900;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      width: fit-content;
      max-width: 100%;
      cursor: default;
      user-select:none;
    }
    .nameChip span{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .nameChip .nm{ max-width: 180px; }
    
    .muted{ color: var(--muted); font-weight:800; }

        .menuPanel{
      position:absolute;
      top: calc(100% + 10px);
      right: 0;
      width: min(360px, 92vw);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      padding: 10px;

      /* âœ… ë©”ë‰´ê°€ ê¸¸ì–´ì ¸ë„ ë²„íŠ¼/ê¸°ëŠ¥ ì•ˆ ì£½ê²Œ: íŒ¨ë„ ìì²´ ìŠ¤í¬ë¡¤ */
      max-height: min(78vh, calc((var(--vh, 1vh) * 100) - 120px));
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scrollbar-gutter: stable;

      display:none;
      z-index: 999;
    }

    /* âœ… ë©”ë‰´ í•˜ë‹¨ ì—¬ë°±(ë§ˆì§€ë§‰ ë²„íŠ¼ ê°€ë¦¼ ë°©ì§€) */
    .menuPanel::after{ content:''; display:block; height: 8px; }

    .menuPanel.show{ display:block; }
        .menuHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 4px 2px 8px;

      /* âœ… ìŠ¤í¬ë¡¤ ì¤‘ì—ë„ ë‹«ê¸° ë²„íŠ¼ì´ í•­ìƒ ë³´ì´ë„ë¡ ê³ ì • */
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--card);
      padding-top: 6px;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .menuTitle{ font-weight: 1000; }
    .menuClose{ border:0; background:transparent; font-size:18px; padding: 6px 8px; border-radius:10px; }
    .menuClose:hover{ background: rgba(0,0,0,.04); }

    .block{
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.015);
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
    }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .labelRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px; }
    .label{ font-weight: 1000; }
    .val{ font-weight: 1000; color: var(--muted); }
    input[type="range"]{ width: 100%; }

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }

    .overlayCard{
      width:min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      text-align:center;
      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .overlayCard.wide{ width: min(980px, 100%); max-width: min(980px, 100%); }
    .overlayTitle{ font-size:18px; font-weight:1000; margin:0 0 6px; }

    .overlayTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .overlayTools{ display:flex; gap:8px; align-items:center; }
    .overlayToolBtn{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 6px 10px;
      font-weight: 950;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .overlayToolBtn:hover{ transform: translateY(-1px); }
    .overlayMsg{
      font-size:13px; color:#444; font-weight:850; margin:0 0 10px; line-height:1.4;
      overflow:auto; -webkit-overflow-scrolling: touch; max-height: 60vh;
      white-space: pre-wrap;
      text-align:left;
      background: rgba(255,255,255,.9);
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.06);

    .overlayMsg.game{
      max-height: none;
      overflow: visible;
      background: transparent;
      border: 0;
      padding: 0;
      margin: 0;
    }

    }
    .overlayCard > button{ margin-top: 10px; flex: 0 0 auto; }

    .titleLine{
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.05;
    
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
    .roomTitle{ font-weight: 1000; }
    .boomDot{
      width:10px; height:10px;
      border-radius:999px;
      background:#ff3b30;
      box-shadow: 0 0 0 rgba(255,59,48,.55);
      animation: boomPulse 1.1s infinite;
      flex: 0 0 auto;
    }
    .boomText{
      font-size:12px;
      font-weight:1000;
      color:#ff3b30;
      letter-spacing:-0.2px;
    }
    @keyframes boomPulse{
      0%{ box-shadow: 0 0 0 0 rgba(255,59,48,.55); transform: scale(1); }
      70%{ box-shadow: 0 0 0 10px rgba(255,59,48,0); transform: scale(1.05); }
      100%{ box-shadow: 0 0 0 0 rgba(255,59,48,0); transform: scale(1); }
    }
    .icon{
      animation: iconJitter 3.2s infinite;
      transform-origin: 50% 50%;
    }
    @keyframes iconJitter{
      0%, 92%, 100% { transform: rotate(0deg); }
      94% { transform: rotate(-3deg); }
      96% { transform: rotate(3deg); }
      98% { transform: rotate(-2deg); }
    }

  
/* ğŸ† Fireworks / Confetti FX */
.fxLayer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
  overflow: hidden;
}
.spark{
  position:absolute;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.2);
  animation: sparkPop 1200ms ease-out forwards;
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
}
@keyframes sparkPop{
  0%{ opacity:0; transform: translate(-50%,-50%) scale(0.2); }
  8%{ opacity:1; }
  100%{ opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.0); }
}
.fxTitle{
  position: fixed;
  left: 50%;
  top: 16px;
  transform: translateX(-50%);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 1000;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255,255,255,.92);
  box-shadow: 0 14px 40px rgba(0,0,0,.12);
  z-index: 10001;
  pointer-events:none;
  animation: fxTitleIn 1600ms ease-out forwards;
}
@keyframes fxTitleIn{
  0%{ opacity:0; transform: translateX(-50%) translateY(-8px) scale(.98); }
  12%{ opacity:1; }
  90%{ opacity:1; }
  100%{ opacity:0; transform: translateX(-50%) translateY(-10px) scale(1.0); }
}

  
/* ğŸ’— Heart FX (enter) */
.heartLayer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
  overflow: hidden;
}
.heart{
  position: absolute;
  font-size: 18px;
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.9);
  animation: heartFloat 1400ms ease-out forwards;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
  will-change: transform, opacity;
}
@keyframes heartFloat{
  0%   { opacity:0; transform: translate(-50%,-50%) scale(.9); }
  10%  { opacity:1; }
  100% { opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.25) rotate(var(--rot)); }
}

  

/* âœ¨ Extra command FX */

/* âš ï¸ Screen shake (warning) */
body.shake{
  animation: screenShake 520ms ease-in-out;
}
@keyframes screenShake{
  0%, 100%{ transform: translateX(0); }
  12%{ transform: translateX(-6px); }
  24%{ transform: translateX(6px); }
  36%{ transform: translateX(-5px); }
  48%{ transform: translateX(5px); }
  60%{ transform: translateX(-3px); }
  72%{ transform: translateX(3px); }
  84%{ transform: translateX(-2px); }
}

.fxEmoji{
  position:absolute;
  opacity:0;
  transform: translate(-50%, -50%) scale(0.9) rotate(0deg);
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
  will-change: transform, opacity;
  pointer-events:none;
}
.fxEmoji.pop{
  animation: fxPop 1200ms ease-out forwards;
}
@keyframes fxPop{
  0%   { opacity:0; transform: translate(-50%,-50%) scale(.85) rotate(0deg); }
  12%  { opacity:1; }
  100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.25) rotate(var(--rot)); }
}
.fxEmoji.twinkle{
  animation: fxTwinkle 1500ms ease-out forwards;
}
@keyframes fxTwinkle{
  0%{ opacity:0; transform: translate(-50%,-50%) scale(.85) rotate(0deg); }
  15%{ opacity:1; }
  45%{ opacity:.25; }
  70%{ opacity:1; transform: translate(-50%,-50%) scale(1.15) rotate(var(--rot)); }
  100%{ opacity:0; transform: translate(-50%,-50%) scale(.95) rotate(var(--rot)); }
}
.fxEmoji.snow{
  animation: fxSnow 2200ms linear forwards;
}
@keyframes fxSnow{
  0%{ opacity:0; transform: translate(-50%,-50%) translateY(0) rotate(0deg); }
  10%{ opacity:1; }
  100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)); }
}



/* âŒ¨ï¸ Typing indicator + Picker anchor */
    .typingWrap{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      margin-bottom: 0px;
    }
    .typingWrap .pickerBtn{
      flex: 0 0 auto;
      width: 44px;
      height: 44px;
      padding: 0;
      display:grid;
      place-items:center;
    }
    .typingBar{
      flex: 1 1 auto;
      margin: 0;
      padding: 0 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.85);
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      min-height: 44px;
      display:none;
      align-items:center;
      overflow:hidden;
    }
    .typingBar.show{ display:flex; }
    .typingText{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .typingDot{
      display:inline-block;
      width: 18px;
      text-align:center;
      margin-right: 6px;
      flex: 0 0 auto;
    }
    .typingDot::before{ content:"âŒ¨ï¸"; }
    .typingDot::after{
      content: "â€¦";
      animation: dots 1.2s infinite;
    }
    @keyframes dots{
      0%{ content:"."; }
      33%{ content:".."; }
      66%{ content:"..."; }
      100%{ content:"."; }
    }

    /* ğŸ“£ Shout ticker (overlay: no layout jump) */
.ticker{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 10005;

  /* âœ… ë ˆì´ì•„ì›ƒ/ë²„íŠ¼ ì˜í–¥ 0 */
  pointer-events: none;

  /* ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° */
  opacity:0;
  visibility:hidden;
  transition: opacity 160ms ease;

  /* ê°€ìš´ë° ì •ë ¬ */
  display:flex;
  align-items:center;
  justify-content:center;

  width: auto;
  max-width: calc(100vw - 18px);
}
.ticker.show{ opacity:1; visibility:visible; }

.tickerPill{
  display:inline-block;
  width: clamp(240px, 70vw, 720px);
  max-width: calc(100vw - 18px);
  overflow:hidden;

  /* âœ… í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë§ì¶° ë™ê¸€ë™ê¸€ */
  border-radius: 999px;
  padding: 12px 16px;

  /* ğŸ’— ì „ê´‘íŒ: ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì—°í•‘í¬ + í•˜íŠ¸ íŒ¨í„´ */
  background-color: rgba(255, 246, 251, .98);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Cpath d='M24 39s-13-8-13-19c0-6 3-9 8-9 3 0 5 2 5 2s2-2 5-2c5 0 8 3 8 9 0 11-13 19-13 19z' fill='%23ff4f93' fill-opacity='0.12'/%3E%3C/svg%3E"),
    radial-gradient(120% 180% at 10% 0%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%),
    radial-gradient(120% 180% at 90% 100%, rgba(255,255,255,.7), rgba(255,255,255,0) 55%);
  background-repeat: repeat, no-repeat, no-repeat;
  background-size: 48px 48px, cover, cover;
  background-blend-mode: multiply, normal, normal;

  border: 1px solid rgba(255, 88, 155, .14);
  box-shadow:
    0 16px 44px rgba(0,0,0,.16),
    inset 0 0 0 1px rgba(255,255,255,.35),
    inset 0 0 18px rgba(255, 88, 155, .08);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.tickerTrack{
  display:inline-flex;
  align-items:center;
  gap: 12px;
  white-space:nowrap;
  will-change: transform;
  animation: tickerMove linear forwards;
}

.tickerBadge{
  font-weight: 1000;
  font-size: 12px;
  letter-spacing: .4px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.65);
  color: #5a2b44;
  flex: 0 0 auto;
}

.tickerText{
  font-weight: 1000;
  font-size: 18px;
  letter-spacing: .6px;
  color: #b10053;
  text-shadow:
    0 0 6px rgba(255, 79, 147, .28),
    0 0 16px rgba(255, 79, 147, .18);
}


@media (max-width: 520px){
  .tickerPill{ padding: 10px 12px; }
  .tickerText{ font-size: 16px; }
}

/* ì˜¤ë¥¸ìª½ì—ì„œ ë“¤ì–´ì™€ ì™¼ìª½ìœ¼ë¡œ ì­‰ (ì†ë„ëŠ” JSì—ì„œ durationìœ¼ë¡œ ì¡°ì ˆ) */
@keyframes tickerMove{
  from{ transform: translateX(110%); }
  to{ transform: translateX(-140%); }
}


/* =====================
 * PATCH: Topbar responsive + Mini BGM bar + Volume popover + Picker button
 * ===================== */
.topbar{
  flex-wrap: wrap;
  gap: 10px;
}
.actions{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap: 10px;
  flex-wrap: wrap;
  min-width: 0;
}

/* Mini BGM bar (left of menu) */
.miniBgmBar{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 8px 10px;
  border: 1px solid rgba(255, 105, 180, 0.20);
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(8px);
  border-radius: 999px;
  min-width: 0; /* âœ… ê¸´ ì œëª©ì—ë„ ì¤„ë°”ê¿ˆ ë°©ì§€(ì¶•ì†Œ í—ˆìš©) */
  min-inline-size: 0;
  
  max-width: 520px;
  flex: 1 1 220px;
  overflow: hidden;
}
.miniBgmBtns{
  display:flex;
  gap: 6px;
  align-items:center;
  flex: 0 0 auto;
}
.miniIconBtn{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 16px;
  user-select:none;
}
.miniIconBtn:hover{ filter: brightness(0.98); }
.miniIconBtn:active{ transform: translateY(1px); }

.noteDance{
  display:inline-block;
  transform-origin: 50% 70%;
}
.miniIconBtn.playing .noteDance{
  animation: noteDance 0.9s ease-in-out infinite;
}
@keyframes noteDance{
  0%{ transform: rotate(-10deg) translateY(0); }
  30%{ transform: rotate(12deg) translateY(-1px); }
  60%{ transform: rotate(-6deg) translateY(1px); }
  100%{ transform: rotate(-10deg) translateY(0); }
}

.miniBgmTitle{
  position: relative;
  min-width: 0;
  flex: 1 1 auto;
  font-weight: 800;
  font-size: 13px;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
}
.miniBgmTitle .marquee{
  display:block;
  padding-left: 10px;
  will-change: transform;
}
.miniBgmTitle.marqueeOn .marquee{
  animation: miniMarquee 12s linear infinite;
}
@keyframes miniMarquee{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-55%); }
}
.miniBgmTitle .sep{
  opacity: 0.45;
  margin: 0 6px;
}

/* Volume popover: fixed overlay (never hidden behind chat) */
.volPopover{
  position: fixed;
  z-index: 99999;
  width: 260px;
  max-width: min(320px, calc(100vw - 20px));
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.25);
  border-radius: 18px;
  padding: 12px 12px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.10);
  backdrop-filter: blur(10px);
  display:none;
}
.volPopover.show{ display:block; }
.volPopover .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 10px;
  font-weight: 900;
}
.volPopover input[type=range]{ width: 100%; }


/* Chat height popover: same layer as volume */
.logPopover{
  position: fixed;
  z-index: 99999;
  width: 280px;
  max-width: min(340px, calc(100vw - 20px));
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.25);
  border-radius: 18px;
  padding: 12px 12px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.10);
  backdrop-filter: blur(10px);
  display:none;
}
.logPopover.show{ display:block; }
.logPopover .labelRow{ margin-bottom: 10px; }
.logPopover input[type=range]{ width: 100%; }


/* Send row: picker button inside input line */
.sendRow{
  align-items: stretch;
  gap: 10px;
}
.pickerBtn{
  width: 44px;
  min-width: 44px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 18px;
}
.pickerBtn:hover{ filter: brightness(0.98); }
.pickerBtn:active{ transform: translateY(1px); }
#msg{ flex: 1 1 auto; }

/* Picker popover */
.pickerPopover{
  position: fixed;
  z-index: 100000;
  width: min(520px, calc(100vw - 18px));
  max-height: min(520px, calc(100vh - 160px));
  max-height: min(520px, calc((var(--vh, 1vh) * 100) - 160px));
  overflow: hidden;
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(255,105,180,0.26);
  border-radius: 18px;
  box-shadow: 0 14px 30px rgba(0,0,0,0.12);
  backdrop-filter: blur(10px);
  display:none;
  flex-direction: column;
}
.pickerPopover.show{ display:flex; }
.pickerHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
.pickerTabs{
  display:flex;
  gap: 6px;
  flex-wrap: wrap;
  min-width: 0;
}
.pickerTab{
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: 12px;
  cursor:pointer;
  user-select:none;
}
.pickerTab.active{
  border-color: rgba(255,105,180,0.55);
  box-shadow: 0 0 0 3px rgba(255,105,180,0.12);
}
.pickerTools{
  display:flex;
  gap: 8px;
  align-items:center;
}
.pickerCloseBtn{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #fff;
  cursor:pointer;
  font-weight: 900;
}
.pickerBody{
  padding: 10px 12px;
  overflow: auto;
  flex: 1 1 auto;
  max-height: none;
  -webkit-overflow-scrolling: touch;
}
.pickerGrid{
  display:grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 6px;
}
@media (max-width: 520px){
  .pickerGrid{ grid-template-columns: repeat(8, 1fr); }
}
.emoBtn{
  border: 1px solid rgba(0,0,0,0.06);
  background: #fff;
  border-radius: 12px;
  padding: 6px 0;
  cursor:pointer;
  font-size: 18px;
}
.emoBtn:hover{ filter: brightness(0.98); }
.emoBtn:active{ transform: translateY(1px); }
.cmdBtn{
  width:100%;
  text-align:left;
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor:pointer;
  font-weight: 800;
}
.cmdBtn:hover{ filter: brightness(0.98); }
.cmdBtn:active{ transform: translateY(1px); }
.cmdList{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
@media (max-width: 560px){
  .cmdList{ grid-template-columns: 1fr; }
}

/* Mobile viewport stability (vh/dvh hybrid: prevents mobile "ëŠ˜ì–´ì§") */
:root{ --vh: 1vh; --chromeTop: 0px; }

/* âœ… Viewport height ì•ˆì •í™” (iOS ì£¼ì†Œì°½/í‚¤ë³´ë“œ í¬í•¨)
   - JSê°€ --vh(px)ë¥¼ ì—…ë°ì´íŠ¸. ì´ ê°’ì„ ìš°ì„  ì‚¬ìš©í•´ì„œ ëª¨ë°”ì¼ "ëŠ˜ì–´ì§/ì—¬ë°± ìŠ¤í¬ë¡¤"ì„ ë°©ì§€ */
html{ min-height: calc(var(--vh, 1vh) * 100); }
body{
  min-height: calc(var(--vh, 1vh) * 100);
  height: auto;
  overflow-x: hidden;
}

/* DJ Playlist / Requests */
.playlistList, .reqList{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.plItem, .reqItem{
  border: 1px solid var(--line);
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.plItem.sel{
  outline: 2px solid rgba(255,105,180,.28);
}
.plMain, .reqMain{ flex:1; min-width:0; }
.plTitle, .reqTitle{
  font-weight:900;
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.plSub, .reqSub{
  font-size:12px;
  color: var(--muted);
  margin-top:2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.plBtns, .reqBtns{ display:flex; gap:6px; }
.tinyBtn{
  border: 1px solid rgba(0,0,0,0.08);
  background:#fff;
  border-radius: 10px;
  padding: 6px 8px;
  font-weight: 900;
  cursor:pointer;
}
.tinyBtn:hover{ filter: brightness(0.98); }
.tinyBtn:active{ transform: translateY(1px); }

/* =====================
 * PATCH: Mobile topbar fold
 * ===================== */
#btnTopbarToggle{ display:none; }
@media (max-width: 760px){
  #btnTopbarToggle{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width: 44px;
    height: 44px;
    padding: 0 10px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.08);
    background:#fff;
    font-weight: 1000;
    cursor:pointer;
    user-select:none;
  }
  #btnTopbarToggle:active{ transform: translateY(1px); }

  /* ì ‘íŒ ìƒíƒœ: ë¯¸ë‹ˆ BGM ë°” ìˆ¨ê²¨ì„œ ìƒë‹¨ë°” ë†’ì´ ìµœì†Œí™” */
  body.tbCollapsed .miniBgmBar{ display:none !important; }
  /* ì ‘íŒ ìƒíƒœ: ì ‘ì†ì ëª…ë‹¨(ì‚¬ì´ë“œ ì¹´ë“œ)ë„ í•¨ê»˜ ì ‘ê¸° */
  body.tbCollapsed .side{ display:none !important; }

  body.tbCollapsed .topbar{
    padding: 8px 10px;
  }
  body.tbCollapsed .actions{
    gap: 8px;
  }
}

/* =====================
 * PATCH: Song play ticker (cute)
 * ===================== */
.tickerPill.songMode{
  border: 1px solid rgba(255, 88, 155, .22);
  box-shadow:
    0 16px 44px rgba(0,0,0,.16),
    inset 0 0 0 1px rgba(255,255,255,.40),
    inset 0 0 22px rgba(255, 88, 155, .10);
}
.tickerBadge.songMode{
  background: rgba(255,255,255,.75);
}
.tickerText.songMode{
  color:#8a0040;
  text-shadow:
    0 0 6px rgba(255, 79, 147, .24),
    0 0 16px rgba(255, 79, 147, .14);
}


    /* ê¸´ ë§í¬/ë¬¸ìì—´ë¡œ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒì´ 'ëŠ˜ì–´ë‚˜ëŠ”' ë¬¸ì œ ë°©ì§€ */
    #log{ overflow-x: hidden; }
    .bubble, .bubble *{
      overflow-wrap: anywhere;
      word-break: break-word;
      min-width: 0;
      max-width: 100%;
    }
    .bubble a{
      word-break: break-all;
      overflow-wrap: anywhere;
    }

/* MOBILE_SCROLL_RESTORE_V4 */
@media (max-width: 760px){
  /* âœ… í˜ì´ì§€ ìŠ¤í¬ë¡¤ì€ ë§‰ë˜, ì¹´ë“œ ë‚´ë¶€(#log) ìŠ¤í¬ë¡¤ì€ ë°˜ë“œì‹œ ì‚´ì•„ìˆê²Œ */
  .wrap{ height: calc(var(--vh, 1vh) * 100); min-height: 0; }
  .layout{ flex: 1 1 auto; min-height: 0; }
  .layout > .card:not(.side){ flex: 1 1 auto; min-height: 0; display:flex; flex-direction:column; }
  /* âš ï¸ ì•„ë˜ì˜ ê¸°ë³¸ #log(height:320px)ê°€ ë’¤ì—ì„œ ë®ì–´ì¨ì„œ ìŠ¤í¬ë¡¤ì´ 'ì‚¬ë¼ì§„ ê²ƒì²˜ëŸ¼' ë³´ì´ëŠ” ë¬¸ì œë¥¼ ê°•ì œë¡œ ë°©ì§€ */
  #log{ flex: 1 1 auto; min-height: 0; height: auto !important; max-height: none !important; overflow: auto !important; -webkit-overflow-scrolling: touch; }
  /* ì…ë ¥ì¤„/íŒíŠ¸ëŠ” í•˜ë‹¨ì— ê³ ì •ë˜ë„ë¡ */
  .sendRow, .typingWrap, .hint{ flex: 0 0 auto; }
}



    /* =====================
       ğŸ² Writer Marble UI
       ===================== */
    .wmWrap{ display:flex; flex-direction:column; gap:12px; }
    .wmHeader{ display:flex; flex-direction:column; gap:4px; }
    .wmTitle{ font-size:20px; font-weight:950; }
    .wmSub{ font-size:12px; color:var(--muted); font-weight:800; }
    .wmTopRow{ display:flex; align-items:stretch; gap:10px; flex-wrap:wrap; }
    .wmControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .wmBtn{ border-radius:14px; }
    .wmBtn.ghost{ background: rgba(255, 209, 232, .22); }
    .wmBtn.disabled{ opacity:.5; pointer-events:none; }
    .wmTurn{ flex:1; min-width:180px; padding:10px 12px; border:1px solid rgba(0,0,0,.10); border-radius:16px; background: rgba(255,255,255,.8); }
    .wmTurnLabel{ font-size:12px; color:var(--muted); font-weight:900; }
    .wmTurnName{ font-size:16px; font-weight:950; margin-top:2px; }
    .wmWin{ padding:10px 12px; border-radius:16px; border:1px solid rgba(0,0,0,.12); background: rgba(255, 242, 201, .65); font-weight:950; }

    .wmBoardWrap{ display:grid; grid-template-columns: minmax(280px, 1fr) minmax(240px, 340px); gap:12px; align-items:start; }
    @media (max-width: 860px){
      .wmBoardWrap{ grid-template-columns: 1fr; }
    }
    .wmBoard{
      position:relative;
      display:grid;
      grid-template-columns: repeat(11, 1fr);
      grid-template-rows: repeat(11, 1fr);
      aspect-ratio: 1/1;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,240,248,.85));
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }
    .wmCell{
      border: 1px solid rgba(0,0,0,.06);
      padding: 6px 6px 5px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:3px;
      font-size:11px;
      background: rgba(255,255,255,.7);
      position:relative;
    }
    .wmCell.owned{ box-shadow: inset 0 0 0 2px rgba(0,0,0,.05); }
    .wmCell.mine{ box-shadow: inset 0 0 0 3px rgba(0,0,0,.10); }
    .wmOwnStrip{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 8px;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      opacity: .95;
    }
    .wmLvl{
      position:absolute;
      top:6px; right:6px;
      font-size:10px;
      font-weight:1000;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      color: #1f1f1f;
      filter: saturate(1.05);
    }
    .wmToken{
      transition: transform .18s ease;
    }
    .wmMoveGhost{
      position:absolute;
      left:0; top:0;
      width: 34px; height: 34px;
      display:grid; place-items:center;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.15);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      pointer-events:none;
      z-index: 9;
      transform: translate(-9999px, -9999px);
    }

    .wmCell.start{ background: rgba(255, 242, 201, .75); }
    .wmCell.tax{ background: rgba(255, 220, 220, .75); }
    .wmCell.chance{ background: rgba(220, 245, 255, .75); }
    .wmCell.loan{ background: rgba(229, 255, 235, .75); }
    .wmCell.rest{ background: rgba(235, 235, 255, .75); }
    .wmCellTop{ display:flex; align-items:center; gap:4px; font-weight:950; }
    .wmIc{ font-size:13px; }
    .wmNm{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .wmDesc{ color: var(--muted); font-weight:800; font-size:10px; line-height:1.2; }
    .wmOwner{
      position:absolute; right:6px; bottom:6px;
      padding: 2px 6px;
      border-radius:999px;
      background: rgba(0,0,0,.06);
      font-size:10px;
      font-weight:950;
      max-width: 90%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .wmToken{
      position:relative;
      z-index: 3;
      display:grid;
      place-items:center;
      font-size:16px;
      pointer-events:none;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.18));
    }

    .wmCenter{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 26px rgba(0,0,0,.05);
      position:sticky;
      top: 6px;
    }
    .wmDiceRow{ display:flex; align-items:center; gap:8px; justify-content:center; }
    .wmDice{
      width:56px; height:56px;
      display:grid; place-items:center;
      border-radius:16px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      font-size:32px;
      font-weight:950;
    }
    .wmDice.rolling{
      animation: wmShake .12s infinite;
    }
    .wmDiceSum{ font-weight:950; }
    .wmDiceHint{ text-align:center; font-size:12px; color:var(--muted); font-weight:850; margin-top:-2px; }

    @keyframes wmShake{
      0%{ transform: rotate(-2deg) translateY(0); }
      50%{ transform: rotate(2deg) translateY(-1px); }
      100%{ transform: rotate(-2deg) translateY(0); }
    }

    .wmCenterBox{ border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:10px; background: rgba(255,247,251,.65); }
    .wmCenterTitle{ font-weight:950; margin-bottom:8px; }
    .wmEmpty{ color:var(--muted); font-weight:850; font-size:12px; padding:4px 0; }

    .wmRanks{ display:flex; flex-direction:column; gap:6px; max-height: 220px; overflow:auto; padding-right: 6px; }
    .wmRankRow{ display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:14px; border:1px solid rgba(0,0,0,.07); background: rgba(255,255,255,.85); }
    .wmRankRow.turn{ outline: 2px solid rgba(255, 111, 180, .28); }
    .wmRankRow.dead{ opacity:.55; }
    .wmRankLeft{ display:flex; flex-direction:column; gap:2px; }
    .wmRankNo{ font-weight:950; font-size:12px; color:var(--muted); }
    .wmRankName{ font-weight:950; }
    .wmRankTag{ font-size:11px; color:var(--muted); font-weight:850; }
    .wmRankRight{ text-align:right; display:flex; flex-direction:column; gap:2px; }
    .wmRankMoney{ font-weight:950; }
    .wmRankSub{ font-size:11px; color:var(--muted); font-weight:850; }

    .wmLog{ max-height: 160px; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:4px; }
    .wmLogLine{ font-size:12px; font-weight:850; color:#3a3a3a; }

    .wmFoot{ display:flex; gap:8px; flex-wrap:wrap; }
    .wmRulePill{ padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background: rgba(255,255,255,.8); font-size:12px; font-weight:900; color:#444; }

/* ===== Writer Marble compact UI (v16) ===== */
.wmWrap.wmMini{ gap:10px; }
.wmWrap.wmMini .wmHeader{ text-align:left; }
.wmWrap.wmMini .wmTitle{ letter-spacing:-.2px; }
.wmHud{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; flex-wrap:wrap;
  position: sticky; top: 0;
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 16px;
  padding: 10px 10px;
  z-index: 5;
}
.wmTurnPill{
  display:flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(255, 240, 248, .65);
  font-weight: 950;
}
.wmTurnLabel{ color: var(--muted); font-size: 12px; }
.wmTurnName{ font-size: 13px; }
.wmControls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
.wmStrip{
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.72);
}
.wmStripLeft{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.wmStripRight{ flex:1; text-align:right; font-weight:900; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.wmChip{
  display:inline-flex; align-items:center; gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255, 209, 232, .22);
  font-weight: 950;
  font-size: 12px;
}
.wmChip.muted{ background: rgba(0,0,0,.04); color:#666; }
.wmDicePanel{
  padding: 10px 12px;
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.72);
}
.wmBoardArea{ display:flex; justify-content:center; }
.wmMiniBoard{
  width: 380px;
  max-width: 92vw;
  aspect-ratio: 1/1;
}
@media (max-width: 520px){
  .wmMiniBoard{ width: 330px; }
}
.wmCell{ position: relative; }
.wmCell .wmDesc{ display:none !important; } /* íˆ´íŒìœ¼ë¡œ ëŒ€ì²´ */
.wmCell::after{
  content: attr(data-tip);
  position:absolute;
  left:50%; bottom: 100%;
  transform: translate(-50%, -6px);
  opacity:0;
  pointer-events:none;
  min-width: 140px;
  max-width: 220px;
  white-space: pre-wrap;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.96);
  box-shadow: 0 10px 24px rgba(0,0,0,.10);
  font-size: 12px;
  line-height: 1.35;
  font-weight: 900;
  color:#333;
  z-index: 20;
}
.wmCell:hover::after{ opacity:1; transform: translate(-50%, -10px); }
.wmCell.wmOwned{
  box-shadow: inset 0 6px 0 var(--ownc);
}
.wmCell.wmMine{
  outline: 2px solid rgba(255, 105, 180, .55);
  outline-offset: -2px;
}
.wmLv{
  position:absolute; right:6px; bottom:6px;
  padding: 3px 6px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.85);
  font-size: 11px;
  font-weight: 950;
  color:#444;
}
.wmToken{
  width: 22px; height: 22px;
  border-radius: 999px;
  display:flex; align-items:center; justify-content:center;
  border: 1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.9);
  box-shadow: 0 8px 16px rgba(0,0,0,.08);
}
.wmCenterLogo{
  position:absolute;
  inset: 34% 18%;
  display:flex; align-items:center; justify-content:center;
  text-align:center;
  font-weight: 950;
  letter-spacing: .12em;
  color: rgba(0,0,0,.18);
  border: 1px dashed rgba(0,0,0,.10);
  border-radius: 18px;
  background: rgba(255,255,255,.35);
  pointer-events:none;
}



    /* â˜” Acid Rain (ì‚°ì„±ë¹„) mini game */
    .acidWrap{ display:flex; flex-direction:column; gap:10px; }
    .acidTop{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .acidTop .pill{ background:#fff; border:1px solid rgba(0,0,0,.08); }
    .acidStage{
      position: relative;
      height: 340px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(180,255,210,.22), rgba(255,247,251,.85));
      overflow:hidden;
    }
    .acidWord{
      position:absolute;
      top:-30px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      font-weight: 950;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      user-select:none;
      pointer-events:none;
      white-space:nowrap;
    }
    .acidWord.miss{ opacity:.35; filter: blur(.3px); }

    .acidWord.bonus{
      border-color: rgba(255, 180, 0, .35);
      box-shadow: 0 8px 18px rgba(255,180,0,.12);
    }
        .acidWord.event{
      /* âš ï¸ do NOT animate transform here (JS uses transform for falling) */
      animation: acidGlow_ 1.1s infinite ease-in-out;
      border-color: rgba(255, 215, 0, .55);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,245,210,.92));
    }
    .acidWord.bonus::after{
      content: "+" attr(data-pt);
      margin-left: 6px;
      font-size: 12px;
      font-weight: 1000;
      opacity: .8;
    }
    @keyframes acidGlow_{
      0%{ filter: brightness(1); box-shadow: 0 6px 16px rgba(0,0,0,.06), 0 0 0 rgba(255,215,0,0); }
      50%{ filter: brightness(1.18); box-shadow: 0 10px 24px rgba(0,0,0,.08), 0 0 18px rgba(255,215,0,.32); }
      100%{ filter: brightness(1); box-shadow: 0 6px 16px rgba(0,0,0,.06), 0 0 0 rgba(255,215,0,0); }
    }

.acidHud{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .acidBoard{ min-width: 220px; }
    .acidBoard .line{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.08); }
    .acidBoard .line:last-child{ border-bottom:0; }
    .acidInputRow{ display:flex; gap:8px; align-items:center; }
    .acidInputRow input{
      flex: 1 1 auto;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      font-weight: 900;
    }
    .acidMiniNote{ font-size: 12px; color: var(--muted); font-weight: 800; }

  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="icon">ğŸ’£</div>
      <div class="brandInfo">
        <div class="brandText">
          <div class="titleLine"><span class="roomTitle">Boom!</span><span class="boomDot" aria-hidden="true"></span><span id="boomText" class="boomText">00:00:00 í­íŒŒ</span></div>
          <div class="metaSmall" id="sessLabel">SESSION: -</div>
        </div>
        <button class="pinBtn" id="btnNoticePin" type="button" title="ê³µì§€">ğŸ“Œ</button>
      </div>
    </div>

    <div class="actions">

      <!-- Mini BGM Bar (ìƒë‹¨ì—ì„œ ê°™ì´ ë“£ê¸°) -->
      <div class="miniBgmBar" id="miniBgmBar" aria-label="BGM mini bar">
        <div class="miniBgmBtns">
          <button class="miniIconBtn" id="miniNote" type="button" title="BGM ìƒíƒœ"><span class="noteDance">ğŸµ</span></button>
          <button class="miniIconBtn" id="miniPlay" type="button" title="ì¬ìƒ">â–¶ï¸</button>
          <button class="miniIconBtn" id="miniPause" type="button" title="ì¼ì‹œì •ì§€">â¸ï¸</button>
          <button class="miniIconBtn" id="miniAllow" type="button" title="BGM í—ˆìš©(ê°™ì´ ë“£ê¸°)">ğŸ¶</button>
        </div>
        <div class="miniBgmTitle" id="miniBgmTitle"><span class="marquee" id="miniBgmMarquee">BGM ì¤€ë¹„<span class="sep">â€¢</span>BGM ì¤€ë¹„</span></div>
        <div class="miniBgmBtns">
          <button class="miniIconBtn" id="miniVolBtn" type="button" title="ë³¼ë¥¨">ğŸ”Š</button>
        </div>
      </div>

      <button id="btnTopbarToggle" type="button" title="ìƒë‹¨ë°” ì ‘ê¸°/í¼ì¹˜ê¸° (ì ‘ì†ì ëª…ë‹¨ë„ ê°™ì´ ì ‘í˜)">â¬†ï¸</button>
      <button id="btnMenu" type="button" title="ë©”ë‰´">â˜° ë©”ë‰´</button>
      <button id="btnLeave" type="button" title="ë‚˜ê°€ê¸°">ğŸƒâ€â™‚ï¸ë‚˜ê°€ê¸°</button>

      <div class="menuPanel" id="menuPanel" aria-hidden="true">
        <div class="menuHeader">
          <div class="menuTitle">ë©”ë‰´</div>
          <button class="menuClose" id="btnMenuClose" type="button" title="ë‹«ê¸°">âœ•</button>
        </div>
<div class="block">
          <div class="labelRow">
            <span class="label">ğŸµ BGM (ìœ íŠœë¸Œ)</span>
            <span class="val" id="bgmState">ì¤€ë¹„</span>
          </div>
<div class="labelRow" style="margin-top:8px;">
  <span class="label">ğŸ§ DJ</span>
  <span class="val" id="djStatus">ì—†ìŒ</span>
</div>
<div class="row2" style="margin-top:8px;">
  <button id="btnDjClaim" type="button" title="DJ ë§¡ê¸°">DJ ë§¡ê¸°</button>
  <button id="btnDjTransfer" type="button" title="DJ ì–‘ë„">DJ ì–‘ë„</button>
</div>
<div class="hint" style="margin-top:8px;">
  â€¢ DJë§Œ BGM ì¬ìƒ/ë³€ê²½ ê°€ëŠ¥í•´ìš”. (DJ ë§¡ê¸°=í•„ìš”í•˜ë©´ ê°€ì ¸ì˜¤ê¸° / DJ ì–‘ë„=ì§€ì •í•´ì„œ ë„˜ê¸°ê¸°)
</div>
          <input id="bgmUrl" placeholder="ìœ íŠœë¸Œ ë§í¬ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: https://youtu.be/VIDEOID)" />
          <div class="row2" style="margin-top:8px;">
            <button id="btnBgmPlay" type="button">ì¬ìƒ</button>
            <button id="btnBgmPause" type="button">ì¼ì‹œì •ì§€</button>
          </div>
          <button id="btnQuickPlAdd" type="button" style="margin-top:8px; width:100%;">â• DJ ì¬ìƒëª©ë¡ì— ì¶”ê°€</button>
          <button id="btnBgmAllow" type="button" style="margin-top:8px; width:100%;">ğŸ¶ BGM í—ˆìš©(ê°™ì´ ë“£ê¸°)</button>
          <div id="menuVolBlock" style="margin-top:10px; display:none;">
            <div class="labelRow">
              <span class="label">ë³¼ë¥¨</span>
              <span class="val" id="bgmVolVal">60</span>
            </div>
            <input id="bgmVol" type="range" min="0" max="100" value="60"/>
          </div>

          <div class="hint" style="margin-top:10px;">
            âš ï¸ ë¸Œë¼ìš°ì € ì •ì±… ë•Œë¬¸ì— ìë™ì¬ìƒì€ ë§‰í˜€ì„œ, ê°ì â€œBGM í—ˆìš©â€ì„ í•œ ë²ˆ ëˆŒëŸ¬ì•¼ ê°™ì´ ë“¤ë¦´ ìˆ˜ ìˆì–´ìš”.
          </div>
        </div>


        <div class="block" id="djPlaylistBlock">
          <div class="labelRow">
            <span class="label">ğŸ›ï¸ DJ ì¬ìƒëª©ë¡</span>
            <span class="val" id="plStatus">-</span>
          </div>
          <div class="hint" style="margin-top:8px;">
            â€¢ DJê°€ ë§Œë“  ì¬ìƒëª©ë¡ì´ ìµœìš°ì„ (=DJê°€ ì•„ë‹Œ ì‚¬ëŒì€ ì¬ìƒ/ë³€ê²½ ë¶ˆê°€).<br/>
            â€¢ ìœ íŠœë¸Œ ë§í¬ëŠ” <b>í˜„ì¬ ì…ë ¥ì°½(bgmUrl)</b> ê°’ì„ ê·¸ëŒ€ë¡œ ì¶”ê°€í•´ìš”.
          </div>

          <!-- âœ… í° 'ì „ì²´ ìë™ ì¬ìƒ' ë²„íŠ¼ -->
          <button id="btnPlAutoAll" type="button" class="bigPlayBtn" style="margin-top:10px; width:100%;">â–¶ï¸ ì „ì²´ ìë™ ì¬ìƒ</button>

          <!-- âœ… ì¬ìƒëª©ë¡ì„ ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ë¡œ -->
          <div class="playlistList" id="playlistList" style="margin-top:10px;"></div>

          <!-- âœ… ì´ì „/ë‹¤ìŒì€ ëª©ë¡ ì•„ë˜ì— -->
          <div class="row2" style="margin-top:8px;">
            <button id="btnPlPrev" type="button">â®ï¸ ì´ì „</button>
            <button id="btnPlNext" type="button">â­ï¸ ë‹¤ìŒ</button>
          </div>

          <div class="hint" style="margin-top:8px;">â€¢ ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ë©´ â€œì„ íƒâ€ë©ë‹ˆë‹¤. DJëŠ” ì„ íƒ í•­ëª©ì„ ë°”ë¡œ ì¬ìƒí•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</div>

          <div class="row2" style="margin-top:8px;">
            <button id="btnPlPlayNow" type="button">â–¶ï¸ ì„ íƒ ì¬ìƒ</button>
            <button id="btnPlDeleteSel" type="button">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
          </div>

          <div class="row2" style="margin-top:8px;">
            <button id="btnPlClear" type="button">ğŸ§¹ ëª©ë¡ ë¹„ìš°ê¸°</button>
            <button id="btnPlSyncToInput" type="button">ğŸ“Œ í˜„ì¬ê³¡ â†’ ì…ë ¥ì°½</button>
          </div>
        </div>

<div class="block" id="requestBlock">
          <div class="labelRow">
            <span class="label">ğŸ“ ì‹ ì²­ê³¡</span>
            <span class="val" id="reqStatus">-</span>
          </div>

          <input id="reqUrl" placeholder="ìœ íŠœë¸Œ ë§í¬(ì‹ ì²­ê³¡) ë¶™ì—¬ë„£ê¸°" />
          <input id="reqNote" placeholder="í•œ ì¤„ ë©”ëª¨(ì˜µì…˜)" />

          <div class="row2" style="margin-top:8px;">
            <button id="btnReqSend" type="button" style="grid-column:1/3;">ì‹ ì²­</button>
          </div>
<div class="reqList" id="reqList"></div>

          <div class="hint" style="margin-top:10px;">
            â€¢ ì‹ ì²­ê³¡ì€ â€œëŒ€ê¸°ì—´â€ì— ìŒ“ì´ê³ , DJê°€ ìŠ¹ì¸í•˜ë©´ DJ ì¬ìƒëª©ë¡ì— ë“¤ì–´ê°€ìš”.<br/>
            â€¢ í˜„ì¬ëŠ” <b>ìœ íŠœë¸Œ ë§í¬ë§Œ</b> ì‹ ì²­ ê°€ëŠ¥í•´ìš”.
          </div>
        </div>
</div>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <div class="nameRow">
        <input id="user" placeholder="ë‹‰ë„¤ì„" maxlength="12"/>
        <button id="btnRace" class="miniGameBtn" type="button" title="íƒ€ì´í•‘ ë ˆì´ìŠ¤ ì‹œì‘" onclick="try{openRaceStart_();}catch(e){}">
          <span class="label">âŒ¨ï¸íƒ€ì´í•‘ë ˆì´ìŠ¤</span>
        </button>
        <button id="btnAcid" class="miniGameBtn" type="button" title="ì‚°ì„±ë¹„(ë‹¨ì–´ ë–¨ì–´ì§€ê¸°) ì‹œì‘" onclick="try{openAcidStart_();}catch(e){}">
          <span class="label">â˜”ì‚°ì„±ë¹„</span>
        </button>
        <button id="btnMarble" class="miniGameBtn" type="button" title="ë¶€ë£¨ë§ˆë¸”" onclick="try{openMarble_();}catch(e){}">
          <span class="label">ğŸ²ë¶€ë£¨ë§ˆë¸”</span>
        </button>
        <button id="btnGuide" class="iconBtnSmall" type="button" title="ê°€ì´ë“œ" onclick="try{openGuide_();}catch(e){}">ğŸ§­</button>
        <button id="btnLogPopover" class="iconBtnSmall" type="button" title="ì±„íŒ…ì°½ ë†’ì´ & ê¸€ì”¨ í¬ê¸° ì¡°ì ˆ">â†•ï¸</button>
      </div>
      <div id="ticker" class="ticker" aria-live="polite"></div>
<div id="raceBar" class="raceBar" aria-hidden="true">
  <div class="raceTop">
    <div class="raceTitle">
      <span class="tag" id="raceDiff">ë‚œì´ë„ -</span>
      <span class="txt" id="raceText">íƒ€ì´í•‘ ë ˆì´ìŠ¤ ëŒ€ê¸° ì¤‘â€¦</span>
    </div>
    <div class="raceTools">
      <span class="raceTimer" id="raceTimer">0.0s</span>
      <button id="btnRaceClear" class="raceMiniBtn" type="button" title="ì…ë ¥ ì§€ìš°ê¸°">â¤«</button>
    </div>
  </div>
  <input id="raceInput" placeholder="ì—¬ê¸°ì— ë¬¸êµ¬ë¥¼ ê·¸ëŒ€ë¡œ íƒ€ì´í•‘! (ì´ëª¨ì§€ ìë™ ë¬´ì‹œ / ê¸°í˜¸ëŠ” ê·¸ëŒ€ë¡œ) â€” Enter ì œì¶œ" disabled />
  <div class="raceDiffView" id="raceDiffView"></div>
  <div class="raceHint" id="raceHint"></div>

  <div class="raceBottom">
    <div class="raceProgress"><div id="raceProgBar"></div></div>
    <div class="raceRank" id="raceRank">â€”</div>
  </div>
    <div class="raceMiniTrack" id="raceMiniTrack" aria-label="ê²½ì£¼ íŠ¸ë™"></div>

  <div class="raceSteps" id="raceSteps"></div>
<div class="raceScore" id="raceScore"></div>
</div>


      <div id="log"></div>      <button id="jumpBtn" class="jumpBtn" type="button">â¬‡ ìƒˆ ë©”ì‹œì§€ <span class="cnt" id="jumpCnt">0</span></button>

            <div class="typingWrap" id="typingWrap">
        <button id="btnPicker" class="pickerBtn" type="button" title="ì´ëª¨ì§€/ëª…ë ¹ì–´">ğŸ™‚</button>
        <div id="typingBar" class="typingBar" aria-live="polite"><span id="typingText" class="typingText"></span></div>
      </div>
      <div class="sendRow">
        <textarea id="msg" rows="2" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡ / Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
        <button id="sendBtn" type="button">ì „ì†¡</button>
      </div>

      <div class="hint">
        â€¢ ìì •ì— ë°©ì´ â€œí­íŒŒâ€ë˜ë©´ ìë™ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìƒˆ ë°©ì´ ë©ë‹ˆë‹¤.<br/>
        â€¢ ìš°ë¦¬ì˜ ìˆ˜ë‹¤ëŠ” ì €ì¥ë˜ì§€ ì•Šê³  ìì •ì— ì‚¬ë¼ì§‘ë‹ˆë‹¤ì•„ì•„ì•…!ğŸ”¥ğŸ”¥
      </div>
    </div>

    <div class="card side">
      <h3>ğŸ‘¥ ì ‘ì†ì <span class="muted" id="onlineSub">-</span></h3>
      <div class="onlineList" id="onlineList"></div>
      <div class="hint" style="margin-top:10px;">
      ğŸ§ ê°™ì´ ë“£ê³  ì‹¶ì€ ë…¸ë˜ ì¬ìƒí•˜ë©´ì„œ ì œëŒ€ë¡œ íœ´ì‹ ì¦ê¸°ê¸°â˜•
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" aria-hidden="true">
  <div class="overlayCard" id="overlayCard" role="dialog" aria-modal="true">
    <div class="overlayTop">
      <p class="overlayTitle" id="ovTitle">ì•Œë¦¼</p>
      <div class="overlayTools">
<button id="ovCloseBtn" class="overlayToolBtn" type="button" title="ë‹«ê¸°" onclick="try{event&&event.preventDefault&&event.preventDefault();event&&event.stopPropagation&&event.stopPropagation();}catch(e){};hideOverlay();">âœ•</button>
      </div>
    </div>
    <div class="overlayMsg" id="ovMsg"></div>
    <button id="ovOkBtn" type="button" onclick="try{event&&event.preventDefault&&event.preventDefault();event&&event.stopPropagation&&event.stopPropagation();}catch(e){};hideOverlay();">í™•ì¸</button>
  </div>
</div>

<!-- =========================
     Firebase (Realtime DB)
     ========================= -->

  <!-- Volume Popover (fixed overlay) -->
  <div class="volPopover" id="volPopover" aria-hidden="true">
    <div class="row"><span>ë³¼ë¥¨</span><span id="volVal" style="font-weight:900;">60</span></div>
    <input id="volRange" type="range" min="0" max="100" value="60" />
  </div>

  <!-- Chat height popover -->
  <div class="logPopover" id="logPopover" aria-hidden="true">
    <div class="labelRow">
      <span class="label">ì±„íŒ…ì°½ ë†’ì´</span>
      <span class="val" id="logSizeVal">320px</span>
    </div>
    <input id="logSize" type="range" min="180" max="2400" value="320"/>
    <div class="labelRow" style="margin-top:10px;">
      <span class="label">ì±„íŒ… ê¸€ì”¨ í¬ê¸°</span>
      <span class="val" id="logFontVal">14px</span>
    </div>
    <input id="logFont" type="range" min="12" max="20" value="14"/>
  </div>

  <!-- Picker Popover (emoji/command) -->
  <div class="pickerPopover" id="pickerPopover" aria-hidden="true">
    <div class="pickerHeader">
      <div class="pickerTabs" id="pickerTabs"></div>
      <div class="pickerTools">
        <button id="pickerClose" class="pickerCloseBtn" type="button" title="ë‹«ê¸°">âœ•</button>
      </div>
    </div>
    <div class="pickerBody" id="pickerBody"></div>
  </div>

<script type="module">

// ===== merged module: firebase imports + helpers + app code =====



// ---- script 1 (type="module") ----
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getDatabase, ref, child, push, set, update, remove, get, runTransaction, serverTimestamp,
    query, orderByChild, limitToLast, onChildAdded, onValue, off, onDisconnect, goOnline, goOffline
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  import {
    getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  // âœ… boomboom1009-ae518 (ë„¤ ê°’ìœ¼ë¡œ êµì²´ ì™„ë£Œ)
  const firebaseConfig = {
    apiKey: "AIzaSyAQYp8_sfgHMnH7KsTOdGgpMc1niarZiSs",
    authDomain: "boomboom1009-ae518.firebaseapp.com",
    databaseURL: "https://boomboom1009-ae518-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "boomboom1009-ae518",
    storageBucket: "boomboom1009-ae518.firebasestorage.app",
    messagingSenderId: "954818391824",
    appId: "1:954818391824:web:477eb52436aafdb5d67f95"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Expose helpers for older gate/utility code paths
  window.FB_getDb = () => db;
  window.FB_getAuth = () => auth;
  window.FB_ref = (path) => ref(db, path);
  const storage = getStorage(app);

  async function ensureAnonAuth(){
    // ê¸°ë‹¤ë ¸ë‹¤ê°€(ë³µì› í¬í•¨) ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
    try{
      await setPersistence(auth, browserLocalPersistence);
    }catch(e){
      // persistence ì„¤ì •ì´ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }
    return await new Promise((resolve, reject) => {
      const unsub = onAuthStateChanged(auth, async (user) => {
        try{
          unsub();
          if (user) return resolve(user);
          const cred = await signInAnonymously(auth);
          resolve(cred.user);
        }catch(err){
          reject(err);
        }
      }, reject);
    });
  }

  // module ë°–ì—ì„œ ì“°ê¸° ìœ„í•´ windowë¡œ ë…¸ì¶œ
  window.FB = {
    app, auth, db, storage, ensureAnonAuth,
    getDb: () => db,
    getAuth: () => auth,
    // Realtime Database (v9+ modular)
    ref, child, push, set, update, remove, get, runTransaction, serverTimestamp,
    query, orderByChild, limitToLast,
    onChildAdded, onValue, off, onDisconnect,
    goOnline, goOffline,

    // Storage (MP3 ê³µìœ  ì—…ë¡œë“œìš©)
    sRef, uploadBytesResumable, getDownloadURL, deleteObject
  };


// ---- script 2 (plain) ----
// ìœ íŠœë¸Œ í”Œë ˆì´ì–´ëŠ” iframe_api ë¡œë”© í›„ ìƒì„±
  let ytPlayer = null;
  let ytReady = false;

  function loadYouTubeApiOnce(){
    if (document.getElementById('yt_api')) return;
    const s = document.createElement('script');
    s.id = 'yt_api';
    s.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
  }

  window.onYouTubeIframeAPIReady = function(){
    ytReady = true;
    // ì‹¤ì œ í”Œë ˆì´ì–´ ìƒì„±ì€ "ì¬ìƒ" ëˆ„ë¥¼ ë•Œ ë§Œë“¤ê²Œ(ë¶ˆí•„ìš”í•œ iframe ìµœì†Œí™”)
  };

  function ensureYtPlayer(videoId){
    if (!ytReady) return null;
    if (ytPlayer) return ytPlayer;

    // ìˆ¨ì€ í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ
    let box = document.getElementById('yt_box');
    if (!box){
      box = document.createElement('div');
      box.id = 'yt_box';
      box.style.position = 'fixed';
      box.style.left = '-9999px';
      box.style.top = '0';
      document.body.appendChild(box);
    }

    ytPlayer = new YT.Player('yt_box', {
      height: '0',
      width: '0',
      videoId: videoId || '',
      playerVars: { autoplay: 1, controls: 0, loop: 0 },
      events: {
        onReady: () => {
          setBgmState('ì¬ìƒ ì¤€ë¹„');
          // ready
        },
        onStateChange: (e) => {
          // 0=ended, 1=playing, 2=paused
          if (e.data === 1) setBgmState('ì¬ìƒ ì¤‘');
          if (e.data === 2) setBgmState('ì¼ì‹œì •ì§€');
          if (e.data === 0){
            try{ onYtEnded_(); }catch(err){}
          }
        }
      }
    });
    return ytPlayer;
  }


// ---- script 3 (plain) ----
// =====================
  // State
  // =====================
  let sessionId = null;

// =====================
// External mini-game links (separate web apps)
// - Keep everything in this index intact, but open games in new web apps.
// - Set these 3 URLs after you deploy each game web app.
// =====================
const GAME_URLS_ = {
  race:  'PUT_TYPING_RACE_WEBAPP_URL_HERE',
  marble:'PUT_MARBLE_WEBAPP_URL_HERE',
  rummi: 'PUT_RUMMIKUB_WEBAPP_URL_HERE'
};

function openGameLink_(key){
  try{
    const base = String((GAME_URLS_ && GAME_URLS_[key]) || '').trim();
    if (!base || base.includes('PUT_')){
      try{
        showOverlay('ë¯¸ë‹ˆê²Œì„ URL ì„¤ì • í•„ìš”',
          `ì•„ì§ ${key} ì›¹ì•± ì£¼ì†Œê°€ ë¹„ì–´ìˆì–´ìš”.\n\nì½”ë“œì—ì„œ GAME_URLS_ì— ë°°í¬ URLì„ ë¶™ì—¬ ë„£ì–´ì£¼ì„¸ìš”.`);
      }catch(e){}
      return;
    }
    if (!sessionId){
      try{ showOverlay('ì—°ê²° ì¤‘', 'ì„¸ì…˜ ì—°ê²°ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ì–´ìš”. ì ê¹ ë’¤ì— ë‹¤ì‹œ ëˆŒëŸ¬ ì£¼ì„¸ìš”!'); }catch(e){}
      return;
    }
    const u = (typeof myName === 'function') ? (myName() || '') : '';
    const url = base + (base.includes('?') ? '&' : '?')
      + 'sid=' + encodeURIComponent(sessionId)
      + '&u=' + encodeURIComponent(u);

    window.open(url, '_blank', 'noopener');
  }catch(e){ console.warn(e); }
}

  let createdAt = 0;
  let joinTs_ = 0; // join time cutoff for events (prevent replay)
  let playingFromPlaylist_ = false; // DJë§Œ ì‚¬ìš©: ì¬ìƒëª©ë¡ ìë™ ë„˜ê¹€ìš©
  let isStopped = false;

  // Firebase chat/presence/notice
  let fbStarted = false;
  let presenceStarted = false;
  let presenceTimer = null;
  let presenceUid = null;
  let presenceConnKey = null;

  // live presence cache
  let presenceLiveVal = null;

  // typing
  let typingUnsub_ = null;
  let typingRef_ = null;
  let typingLastSent_ = 0;
  let typingIdleTimer_ = null;

  // log auto-scroll control
  let autoScroll_ = true;
  let unreadCount_ = 0;
  const SCROLL_BOTTOM_THRESHOLD_PX = 90;
  let presenceLiveUnsub = null;

  const CLIENT_ID = getClientId();
  const PRESENCE_STALE_MS = 60 * 1000; // 60ì´ˆ ì´ìƒ ì—…ë°ì´íŠ¸ ì—†ìœ¼ë©´ stale ì²˜ë¦¬

  // Notice
  const NOTICE_PATH_ = (roomId) => `rooms/${String(roomId)}/notice`;
  const NOTICE_LS_KEY_ = 'VENT_NOTICE_LASTSEEN_AT';
  let noticeUnsub_ = null;
  let noticeCache_ = { text:'', updatedAt:0, by:'' };

  // DJ
  let djUnsub_ = null;
  let djState_ = null; // { uid, name, ts }

  // BGM
  const LS_BGM_URL = 'VENT_BGM_URL';
  const LS_BGM_VOL = 'VENT_BGM_VOL';
  const LS_CHAT_FONT = 'VENT_CHAT_FONT_PX';


  // BGM sync (shared listening)
  let bgmUnsub_ = null;
  let bgmRemote_ = null;
  let bgmAllowed_ = false; // user gesture granted?
  let bgmLastAppliedKey_ = ''; // prevent redundant re-apply
  let bgmAnnouncedKey_ = ''; // prevent duplicate song ticker
  let audioPlayer_ = null;

  // DJ Playlist
  let plUnsub_ = null;
  let plRemote_ = null; // { items:[], curIndex:Number }
  let plSelIndex_ = -1;

  // Song Requests
  let reqUnsub_ = null;
  let reqRemote_ = {}; // {key: {..}}
  function $(id){ return document.getElementById(id); }

  function getClientId(){
    let id = sessionStorage.getItem('VENT_TAB_ID_V1');
    if (!id){
      id = 't_' + Math.random().toString(36).slice(2) + '_' + Date.now();
      sessionStorage.setItem('VENT_TAB_ID_V1', id);
    }
    return id;
  }

  function myName(){
    const v = ($('user').value || '').trim();
    return v || 'ìµëª…';
  }

  
  // =====================
  // Nickname confirm/validation
  // =====================
  const LS_LAST_NICK = 'VENT_LAST_NICK_V1';
  let nickConfirmed_ = false;
  let lastConfirmedNick_ = '';

  function sanitizeNick_(raw){
    let s = String(raw || '').replace(/[\r\n]+/g,' ').trim();
    s = s.replace(/\s{2,}/g,' ');
    return s.slice(0,12);
  }

  function validateNick_(nick){
    const s = sanitizeNick_(nick);
    if (!s) return false;
    if (s === 'ìµëª…') return false;
    if (s.length < 2) return false; // âœ… 'ã„¹' ê°™ì€ 1ê¸€ì ë°©ì§€
    return true;
  }

  function serverName_(){
    const v = sanitizeNick_(($('user')?.value || ''));
    return (nickConfirmed_ && validateNick_(v)) ? v : 'ìµëª…';
  }

  function confirmNickname_(reason){
    const userEl = $('user');
    if (!userEl) return false;

    const raw = userEl.value || '';
    const nick = sanitizeNick_(raw);

    if (!nick){
      nickConfirmed_ = false;
      return false;
    }

    if (!validateNick_(nick)){
      nickConfirmed_ = false;
      showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì€ 2ê¸€ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      userEl.focus();
      try{ userEl.select(); }catch(e){}
      return false;
    }

    // ê°™ì€ ë‹‰ë„¤ì„ì´ë©´ ì¬í™•ì¸ ìƒëµ
    if (nickConfirmed_ && nick === lastConfirmedNick_) return true;

    const ok = window.confirm(`ë‹‰ë„¤ì„ì„ "${nick}"(ìœ¼)ë¡œ ì„¤ì •í• ê¹Œìš”?`);
    if (!ok){
      nickConfirmed_ = false;
      userEl.focus();
      try{ userEl.select(); }catch(e){}
      return false;
    }

    userEl.value = nick;
    lastConfirmedNick_ = nick;
    nickConfirmed_ = true;
    try{ localStorage.setItem(LS_LAST_NICK, nick); }catch(e){}

    // í”„ë¡œí•„/í‘œì‹œ ê°±ì‹  + (í•„ìš” ì‹œ) ì…ì¥ ì•Œë¦¼
    try{ myProfile_(); }catch(e){}
    try{ setDjUi_(); }catch(e){}
    try{ maybeAnnounceEnter_(); }catch(e){}

    return true;
  }
function escapeHtml(s){
    return (s ?? '').toString().replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function escapeAttr(s){
    return (s ?? '').toString().replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function showOverlay(title, msg){
    try{ setOverlayResizable_(false); }catch(e){}
    $('ovTitle').textContent = title;
    $('ovMsg').textContent = msg;
    const ov = $('overlay');
    if (ov){
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');
    }
  }

  function hideOverlay(){
    try{ setOverlayResizable_(false); }catch(e){}
    const ov = $('overlay');
    if (ov){
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }
  }


  function bindOverlayUi_(){
    try{
      const ov = $('overlay');
      const card = document.querySelector('.overlayCard');
      if (!ov || ov.__bound) return;
      ov.__bound = true;

      // âœ… ì˜¤ë²„ë ˆì´ í´ë¦­ì´ ë¬¸ì„œë¡œ ì „íŒŒë˜ë©´ ë©”ë‰´ê°€ ë‹«íˆëŠ” ë¬¸ì œê°€ ìƒê¹€ â†’ ì—¬ê¸°ì„œ ì°¨ë‹¨
      ov.addEventListener('click', (e)=>{
        try{
          if (e.target === ov){
            try{
              // resizable(ê²Œì„) ì˜¤ë²„ë ˆì´ëŠ” í¬ê¸° ì¡°ì ˆ ì¤‘ ë°°ê²½ í´ë¦­ì´ ë°œìƒí•  ìˆ˜ ìˆì–´ ë‹«ì§€ ì•ŠìŒ
              if (!(card && card.classList && card.classList.contains('resizable'))){
                hideOverlay();
              }
            }catch(_e){ hideOverlay(); }
          } // ë°°ê²½ í´ë¦­ë§Œ ë‹«ê¸°
        }catch(err){}
        e.stopPropagation();
      }, false);

      if (card){
        card.addEventListener('click', (e)=> e.stopPropagation(), false);
      }


      // âœ… ì˜¤ë²„ë ˆì´ ì•ˆ ë²„íŠ¼ì´ ë¬´ë°˜ì‘ì´ ë˜ëŠ” ë¬¸ì œ ë°©ì§€:
      // - ì˜¤ë²„ë ˆì´ê°€ ë¬¸ì„œ í´ë¦­ìœ¼ë¡œ ì „íŒŒë˜ë©´ ë©”ë‰´ê°€ ë‹«íˆëŠ” ê±¸ ë§‰ë˜,
      // - ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ë§‰ì•„ë²„ë¦¬ë©´ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ì´ ì•„ì˜ˆ targetê¹Œì§€ ëª» ê°€ì„œ "ë²„íŠ¼ ì£½ìŒ"ì´ ë°œìƒí•¨.
      //   (ê·¸ë˜ì„œ ìœ„ì—ì„œ capture=falseë¡œ ë°”ê¾¸ê³ , ì—¬ê¸°ì„œ overlay content ë²„íŠ¼ì„ ìœ„ì„ ì²˜ë¦¬)
      const msgEl = $('ovMsg');
      if (msgEl && !msgEl.__actionBound){
        msgEl.__actionBound = true;
        msgEl.addEventListener('click', (ev)=>{
          try{
            const t = ev.target;
            if (!t) return;
            // íƒ€ì´í•‘ ë ˆì´ìŠ¤ ë‚œì´ë„
            const diffBtn = t.closest?.('.raceDiffCard[data-diff], .raceDiffPill[data-diff]');
            if (diffBtn){
              const diff = diffBtn.getAttribute('data-diff') || 'low';
              try{ localStorage.setItem(RACE_LS_DIFF_, diff); }catch(e){}
              try{ hideOverlay(); }catch(e){}
              try{ startRace_(diff); }catch(e){}
              return;
            }
            // ë£¨ë¯¸íë¸Œ(ë² íƒ€)
            const actBtn = t.closest?.('[data-action]');
            if (!actBtn) return;
            const act = actBtn.getAttribute('data-action') || '';
            if (act === 'raceStrictToggle'){
              const on = setRaceStrict_(!loadRaceStrict_());
              try{ actBtn.classList.toggle('off', !on); }catch(e){}
              try{ actBtn.textContent = on ? 'âœ… ì˜¤íƒ€ 1ë²ˆ=íƒˆë½: ON' : 'â˜‘ï¸ ì˜¤íƒ€ 1ë²ˆ=íƒˆë½: OFF'; }catch(e){}
              return;
            }
            if (act === 'acidStart'){ try{ startAcidRain_(); }catch(e){}; try{ openAcidGame_(); }catch(e){}; return; }
            if (act === 'acidOpen'){ try{ openAcidGame_(); }catch(e){}; return; }
            if (act === 'rkStart'){ rkStartFromUi_(); return; }
            if (act === 'rkDraw'){ rkDraw_(); return; }
            if (act === 'rkNext'){ rkNextTurn_(); return; }
            if (act === 'rkReset'){ rkReset_(); return; }
          }catch(e){}
        }, false);
      }

      const close = (e)=>{
        try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(err){}
        hideOverlay();
      };

      const ok = $('ovOkBtn');
      const x = $('ovCloseBtn');
    }catch(e){}
  }

  function setBgmState(t){
    $('bgmState').textContent = t || 'ì¤€ë¹„';
  }

  
  // =====================
  // Midnight countdown (Asia/Seoul)
  // =====================
  let boomTimer_ = null;
  let midnightReloaded_ = false;

  function seoulNow_(){
    // âœ… íƒ€ì„ì¡´ ê³ ì •: í˜¸ìŠ¤íŠ¸/ì‚¬ìš©ì í™˜ê²½ì´ ë‹¬ë¼ë„ í•œêµ­ ìì • ê¸°ì¤€ìœ¼ë¡œ ì¹´ìš´íŠ¸
    return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
  }

  function formatHms_(ms){
    const t = Math.max(0, Math.floor(ms / 1000));
    const hh = String(Math.floor(t / 3600)).padStart(2,'0');
    const mm = String(Math.floor((t % 3600) / 60)).padStart(2,'0');
    const ss = String(t % 60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  function msToNextMidnightSeoul_(){
    const now = seoulNow_();
    const next = new Date(now);
    next.setHours(24,0,0,0); // next midnight
    return next.getTime() - now.getTime();
  }

  function updateBoomCountdown_(){
    const el = $('boomText');
    if (!el) return;
    const ms = msToNextMidnightSeoul_();
    el.textContent = `${formatHms_(ms)} í­íŒŒ`;

    // ìì • ì „í›„: ì„¸ì…˜ ë¡¤ì˜¤ë²„ê°€ ëŠë¦¬ë©´ í´ë¼ì—ì„œë„ 1íšŒ ë¦¬ë¡œë“œë¡œ ë³´ì¡°
    if (ms <= 1200 && !midnightReloaded_){
      midnightReloaded_ = true;
      setTimeout(()=>{ try{ location.reload(); }catch(e){} }, 1400);
    }
  }

  function startBoomCountdown_(){
    if (boomTimer_) clearInterval(boomTimer_);
    updateBoomCountdown_();
    boomTimer_ = setInterval(updateBoomCountdown_, 1000);
  }
// =====================
  // Menu UI
  // =====================
  function openMenu(){
    $('menuPanel').classList.add('show');
  }
  function closeMenu(){
    $('menuPanel').classList.remove('show');
  }
  function toggleMenu(){
    $('menuPanel').classList.toggle('show');
  }

  // =====================
  // Session join/ping
  // =====================
  let pingTimer = null;

  function schedulePing(ms){
    if (pingTimer) clearTimeout(pingTimer);
    pingTimer = setTimeout(()=> joinOrPing_(), ms);
  }

  // =====================
  // Session join/ping (RTDB-only, Apps Script ì œê±°)
  // - sudaHub/currentSessionV1 ì— ì˜¤ëŠ˜ì˜ ì„¸ì…˜IDë¥¼ ì €ì¥
  // - dayKey(ì„œìš¸) ê¸°ì¤€ìœ¼ë¡œ í•˜ë£¨ 1ì„¸ì…˜
  // =====================
  const SUDA_HUB_PATH_ = () => `sudaHub/currentSessionV1`;
  function dayKeySeoul_(){
    return new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' })
      .format(new Date());
  }
  function makeSessionId_(){
    // ì¶©ëŒ ë‚®ì¶”ê¸°: ë‚ ì§œ + ëœë¤
    const dk = dayKeySeoul_().replace(/-/g,'');
    const rnd = Math.random().toString(16).slice(2,10);
    return `suda_${dk}_${rnd}`;
  }
  async function getOrCreateSession_(){
    await window.FB.ensureAnonAuth();
    const hubRef = window.FB.ref(window.FB.db, SUDA_HUB_PATH_());
    const dk = dayKeySeoul_();
    const res = await window.FB.runTransaction(hubRef, (cur)=>{
      cur = cur || {};
      if (cur.dayKey !== dk || !cur.sessionId){
        cur = { dayKey: dk, sessionId: makeSessionId_(), createdAt: Date.now() };
      }
      // ping stamp
      cur.lastPingAt = Date.now();
      return cur;
    });
    const v = res && res.snapshot ? (res.snapshot.val()||{}) : {};
    return { sessionId: v.sessionId, createdAt: Number(v.createdAt||0), dayKey: v.dayKey||dk };
  }
  async function forceResetSession_(reason){
    await window.FB.ensureAnonAuth();
    const hubRef = window.FB.ref(window.FB.db, SUDA_HUB_PATH_());
    const dk = dayKeySeoul_();
    await window.FB.runTransaction(hubRef, (cur)=>{
      cur = cur || {};
      cur.dayKey = dk;
      cur.sessionId = makeSessionId_();
      cur.createdAt = Date.now();
      cur.resetReason = String(reason||'manual');
      cur.resetAt = Date.now();
      return cur;
    });
  }

  // =====================
  // Gate ticket (ì•½í•œ ë³´ì•ˆ) - ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ìœ¼ë¡œë§Œ ì…ì¥
  // - URL: ?gateRoom=<ì‘ì—…ë°©ë£¸>&ticket=<tid>
  // - rooms/{gateRoom}/access/sudaTickets/{tid} ë¥¼ í™•ì¸
  // =====================
  function __toRoomKey(v){return String(v||'').replace(/[.#$\[\]\/]/g,'_');}
  function getQs_(k){
    try{ return new URL(location.href).searchParams.get(k) || ''; }catch(e){ return ''; }
  }
  const TICKET_PATH_ = (gateRoomId, tid) => `rooms/${__toRoomKey(gateRoomId)}/access/sudaTickets/${String(tid)}`;
  function __normMs(v){
  const n = Number(v||0);
  if(!Number.isFinite(n) || n<=0) return 0;
  // if seconds epoch, convert to ms
  return (n < 2e12) ? Math.floor(n*1000) : Math.floor(n);
}

function verifyGateTicket_(){
  // Single-flight: prevent double runs
  if (window.__sudaGateVerifiedPromise) return window.__sudaGateVerifiedPromise;

  window.__sudaGateVerifiedPromise = (async () => {
    const url = new URL(location.href);
    const rawGate = (url.searchParams.get('gateRoom') || url.searchParams.get('room') || '').trim();
    const tidRaw  = (url.searchParams.get('ticket') || '').trim();

    const gateRoom = String(rawGate || '');
    const ticketId = String(tidRaw || '');

    if(!gateRoom || !ticketId){
      showOverlay('ì ‘ì† ì œí•œ', 'ì‘ì—…ë°© ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ìœ¼ë¡œë§Œ ì…ì¥í•  ìˆ˜ ìˆì–´ìš”.');
      throw new Error('missing gateRoom/ticket');
    }

    const gateKey = __toRoomKey(gateRoom);
    const cleanTid = __toRoomKey(ticketId); // ticket id is generated but sanitize anyway

    await window.FB.ensureAnonAuth();
    const myUid = window.FB.getUid?.() || (window.FB.auth?.currentUser?.uid || "");

    const db = window.FB.getDb();

    // í‹°ì¼“ ê²½ë¡œ í˜¸í™˜: (A) rooms/<gateKey>/access/...  (B) <gateKey>/access/...
    const tryPaths = [
      `rooms/${gateKey}/access/sudaTickets/${cleanTid}`,
      `${gateKey}/access/sudaTickets/${cleanTid}`,
    ];

    let ticketRef = null;
    let snap = null;
    let foundPath = "";
    for (const p of tryPaths){
      const r = window.FB.ref(db, p);
      const s = await window.FB.get(r);
      if (s.exists()){
        ticketRef = r;
        snap = s;
        foundPath = p;
        break;
      }
    }

    if(!snap){ snap = { exists: ()=>false }; }

    if(!snap.exists()){
      showOverlay('ì ‘ì† ì œí•œ', 'ì…ì¥ í‹°ì¼“ì´ ì—†ê±°ë‚˜ ë§Œë£Œë˜ì—ˆì–´ìš”. ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
      throw new Error('invalid/expired ticket (missing)');
    }

    const t = snap.val() || {};
    const now = Date.now();
    const expAtMs = Number(t.expAtMs || 0);
    const usedAtMs = Number(t.usedAtMs || 0);

    // âœ… Session-key ë°©ì‹(ë¸Œë¼ìš°ì € ì €ì¥ì†Œ) ìš°ì„  í™•ì¸
    // - ëŒ€ì‹œë³´ë“œì—ì„œ í‹°ì¼“ ë°œê¸‰ ì‹œ sk(sessionKey)ë¥¼ localStorageì— ì €ì¥í•´ë‘ê³ ,
    //   ìˆ˜ë‹¤ë°©ì—ì„œëŠ” í‹°ì¼“ì˜ skì™€ localStorage skê°€ ì¼ì¹˜í•  ë•Œë§Œ í†µê³¼.
    // - uidëŠ” ë³´ì¡°(ë ˆê±°ì‹œ) ìš©ë„ë¡œë§Œ ì‚¬ìš© (ìµëª… uidê°€ ë°”ë€Œì–´ë„ skê°€ ìœ ì§€ë˜ë©´ OK)
    // gateKey already defined above (normalized)
    const skKey = `sudaSessionKey:${gateKey}`;
    const ticketSk = String(t.sk || "");
    const storedSk = (()=>{ try{ return String(localStorage.getItem(skKey) || ""); }catch(_){ return ""; } })();

    if(ticketSk){
      if(!storedSk || storedSk !== ticketSk){
        showOverlay('ì ‘ì† ì œí•œ', 'ì´ í‹°ì¼“ì€ ë‹¤ë¥¸ ê¸°ê¸°/ì„¸ì…˜ì—ì„œ ë°œê¸‰ëœ í‹°ì¼“ì´ì—ìš”. ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
        throw new Error('ticket sessionKey mismatch');
      }
    }else{
      // âœ… ë ˆê±°ì‹œ í‹°ì¼“ ìë™ ì—…ê·¸ë ˆì´ë“œ: skê°€ ì—†ìœ¼ë©´ "í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ sk"ë¥¼ í‹°ì¼“ì— ì‹¬ì–´ì¤€ë‹¤.
      // - uidëŠ” ë” ì´ìƒ ê°•ì œ ë¹„êµí•˜ì§€ ì•ŠìŒ(ìµëª… uid ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì˜¤íƒ ë°©ì§€)
      let ensuredSk = storedSk;
      if(!ensuredSk){
        ensuredSk = (crypto?.randomUUID?.() || (String(Date.now()) + "-" + Math.random().toString(16).slice(2)));
        try{ localStorage.setItem(skKey, ensuredSk); }catch(_){}
      }
      try{
        // í‹°ì¼“ì— skê°€ ì—†ì„ ë•Œë§Œ ê¸°ë¡(ê²½í•© ì‹œì—ë„ ë¬¸ì œì—†ìŒ)
        await window.FB.update(tRef, { sk: ensuredSk, skSetAtMs: Date.now() });
      }catch(_){
        // ì“°ê¸° ì‹¤íŒ¨í•´ë„(ë£°/ë„¤íŠ¸ì›Œí¬) ì¼ë‹¨ ê³„ì† ì§„í–‰: ì´í›„ usedAtMs ë¡œ ë³´í˜¸ë¨
      }
    }
if(!expAtMs || expAtMs < now){
      showOverlay('ì ‘ì† ì œí•œ', 'ì…ì¥ í‹°ì¼“ì´ ë§Œë£Œë˜ì—ˆì–´ìš”. ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
      throw new Error('ticket expired');
    }

    if(usedAtMs && usedAtMs > 0){
      // If you want multi-use, remove this block
      showOverlay('ì ‘ì† ì œí•œ', 'ì´ë¯¸ ì‚¬ìš©ëœ í‹°ì¼“ì´ì—ìš”. ëŒ€ì‹œë³´ë“œì—ì„œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
      throw new Error('ticket already used');
    }

    // mark used (best-effort)
    try{
      await window.FB.update(ticketRef, { usedAtMs: now, usedBy: (t.usedBy||t.by||""), by: (t.by||""), lastSeenAtMs: now });
    }catch(e){
      console.warn('ticket mark-used failed (continuing):', e);
    }

    // âœ… gate passed
    try{ window.__sudaGatePassed = true; }catch(_){}
    return true;
  })();

  return window.__sudaGateVerifiedPromise;
}



  
  async function joinOrPing_(){
    if (isStopped) return;
    try{
      if (!window.FB) { schedulePing(4000); return; }
      const info = await getOrCreateSession_();
      const newId = info.sessionId;
      if (!sessionId && newId){
        sessionId = newId;
        createdAt = Number(info.createdAt || 0);
        $('sessLabel').textContent = `SESSION: ${sessionId}`;
        await initFirebase_(sessionId);
      } else if (sessionId && newId && newId !== sessionId){
        // âœ… ìì • í­íŒŒ(ì„¸ì…˜ ë³€ê²½) â†’ ìë™ ì¬ì—°ê²°
        stopAll_();
        showOverlay('ğŸ’£ ìì • í­íŒŒ!', 'ì„¸ì…˜ì´ ìƒˆë¡œ ì—´ë ¸ì–´ìš”. ìƒˆë¡œ ê³ ì¹¨ í•œ ë²ˆ!');
        setTimeout(()=>{ location.reload(); }, 1500);
        return;
      }
      schedulePing(6000);
    }catch(e){
      schedulePing(6000);
    }
  }


  function stopAll_(){
    isStopped = true;
    try{ stopTyping_(); }catch(e){}
    try { if (pingTimer) clearTimeout(pingTimer); } catch(e){}
    pingTimer = null;
  }

  // =====================
  // Firebase paths
  // =====================
  function fbMessagesPath_(roomId){ return `rooms/${roomId}/messages`; }
  function fbPresenceConnPath_(roomId){ return `rooms/${roomId}/presenceConn`; }
  function fbBgmPath_(roomId){ return `rooms/${roomId}/bgm`; }
  function fbDjPath_(roomId){ return `rooms/${roomId}/dj`; }
  function fbTypingPath_(roomId){ return `rooms/${roomId}/typing`; }
  function fbPlaylistPath_(roomId){ return `rooms/${roomId}/djPlaylist`; }
  function fbRequestsPath_(roomId){ return `rooms/${roomId}/requests`; }

  // Mini game: Typing Race
  function fbRacePath_(roomId){ return `rooms/${roomId}/games/typingRace`; }
  function fbRaceCurrentPath_(roomId){ return `${fbRacePath_(roomId)}/current`; }
  function fbRacePlayersPath_(roomId){ return `${fbRacePath_(roomId)}/players`; }

  // Mini game: Acid Rain (ì‚°ì„±ë¹„)
  function fbAcidPath_(roomId){ return `rooms/${roomId}/games/acidRain`; }
  function fbAcidCurrentPath_(roomId){ return `${fbAcidPath_(roomId)}/current`; }
  function fbAcidPlayersPath_(roomId){ return `${fbAcidPath_(roomId)}/players`; }


  // =====================
  // Firebase init
  // =====================
  async function initFirebase_(roomId){
    if (!window.FB) throw new Error('Firebase not loaded');
    await window.FB.ensureAnonAuth();

    

    // âœ… ìƒˆë¡œ ì…ì¥í•œ ì‚¬ëŒì—ê²Œ ê³¼ê±° ì´ë²¤íŠ¸(ì´í™íŠ¸/ì™¸ì¹˜ê¸° ë“±)ê°€ í•œêº¼ë²ˆì— ì¬ìƒë˜ëŠ” í˜„ìƒ ë°©ì§€
    joinTs_ = Date.now();
initChat_(roomId);
    await startPresence_(roomId);
    initPresenceLive_(roomId);
    initDj_(roomId);
    initNotice_(roomId);
    initBgmSync_(roomId);
    initPlaylist_(roomId);
    initRequests_(roomId);
    initTyping_(roomId);
    initTypingRace_(roomId);
    initAcidRain_(roomId);

    // ì…ì¥ ì•Œë¦¼ + í•˜íŠ¸ ì´í™íŠ¸(ì„¸ì…˜/íƒ­ë‹¹ 1íšŒ)
    maybeAnnounceEnter_();

    // UI
    setTimeout(()=> refreshPresenceUi_(), 800);
  }

  // =====================
  // Chat
  // =====================
  function initChat_(roomId){
    if (fbStarted) return;
    fbStarted = true;

    const root = window.FB.ref(window.FB.db, fbMessagesPath_(roomId));
    const q = window.FB.query(root, window.FB.limitToLast(200));

    window.FB.onChildAdded(q, (snap)=>{
      if (!snap.exists()) return;
      const m = snap.val() || {};
      appendMessage_(m);
    });
  }

  async function sendChat_(){
    if (isStopped || !sessionId) return;

    const msgEl = $('msg');
    const text = (msgEl.value || '').trim();
    if (!text) return;

    
    // âœ… ìµëª… ìƒíƒœë©´ ë¨¼ì € ë‹‰ë„¤ì„ ì„¤ì •
    if (!isNickConfigured_()){
      showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.');
      try{ $('user')?.focus(); }catch(e){}
      return;
    }
// typing off when sending
    try{ stopTyping_(); }catch(e){}



// ğŸ† Commands (robust parse: trailing spaces OK)
// - ëª…ë ¹ì–´ëŠ” ì±„íŒ…(ìµëª… í¬í•¨)ìœ¼ë¡œ ë‚¨ê¸°ì§€ ì•Šê³ , ì‹œìŠ¤í…œ ë©”ì‹œì§€ + ì´í™íŠ¸ë¡œë§Œ ì²˜ë¦¬
// - ì´í™íŠ¸ëŠ” pushEvent_ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë˜ì–´ ëª¨ë‘ì—ê²Œ ë™ì¼í•˜ê²Œ ë³´ì„
const parts = text.split(/\s+/).filter(Boolean);
const cmd = (parts[0] || '').trim();
const extra = text.slice(cmd.length).trim(); // ì›ë¬¸ì—ì„œ cmd ì œì™¸í•œ ë‚˜ë¨¸ì§€ (ë©”ì‹œì§€ ì˜µì…˜)
const nm = myName().slice(0,12);

function sysLine_(base, extraText){
  return extraText ? `${base} â€” ${extraText}` : base;
}

async function runFx2_(kind, sysMsg){
  msgEl.value = '';
  await pushSystem_(sysMsg);
  await pushEvent_({ type:'event', event:'fx2', kind, by:nm, ts: Date.now() });
  // NOTE: ë¡œì»¬ì—ì„œ ë°”ë¡œ launchí•˜ì§€ ì•ŠìŒ(ì´ë²¤íŠ¸ ìˆ˜ì‹ ìœ¼ë¡œ 1íšŒë§Œ ì‹¤í–‰)
}

// --- force reset (PIN) ---
// âœ… ì±„íŒ…ì— "ë¹„ë°€ë²ˆí˜¸"ê°€ ë…¸ì¶œë˜ì§€ ì•Šê²Œ, Firebaseë¡œëŠ” ë³´ë‚´ì§€ ì•Šê³  ì„œë²„ì—ë§Œ ì „ë‹¬
if (cmd === '/í­íŒŒ' || cmd === '/ì´ˆê¸°í™”' || cmd === '/ë¦¬ì…‹' || cmd === '/reset'){
  msgEl.value = '';
  const pin = String(parts[1] || '').trim();
  if (!pin){
    showOverlay('ğŸ’£ ì„¸ì…˜ ì´ˆê¸°í™”', 'ë¹„ë°€ë²ˆí˜¸(ì•„ë¬´ ê°’) ì…ë ¥ì´ í•„ìš”í•´ìš”. ì˜ˆ) /í­íŒŒ 1234');
    return;
  }

  const ok = window.confirm('ğŸ’£ ì •ë§ë¡œ ì„¸ì…˜ì„ ê°•ì œë¡œ í­íŒŒ(ì´ˆê¸°í™”)í• ê¹Œìš”?\n(ëª¨ë‘ê°€ ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤)');
  if (!ok) return;

  try{
    stopAll_();
    showOverlay('ğŸ’£ ì´ˆê¸°í™” ì¤‘...', 'ìƒˆ ì„¸ì…˜ì„ ì—¬ëŠ” ì¤‘ì´ì—ìš”. ìƒˆë¡œê³ ì¹¨ í•œ ë²ˆ!');
  }catch(e){}

  try{
    await forceResetSession_('chat_command');
  }catch(e){
    alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (e && e.message ? e.message : e));
  }
  try{ location.reload(); }catch(e){}
  return;
}



// --- fireworks ---
if (cmd === '/ì™„ê²°'){
  msgEl.value = '';
  const msg = sysLine_(`ğŸ† ${nm}ë‹˜ì´ ì™„ê²°ì„ ì„ ì–¸í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra);
  await pushSystem_(msg);
  await pushEvent_({ type:'event', event:'fireworks', kind:'complete', by:nm, ts: Date.now() });
  launchFireworks_('complete', nm);
  return;
}
if (cmd === '/ì¶•í•˜'){
  msgEl.value = '';
  const msg = sysLine_(`ğŸ‰ ${nm}ë‹˜, ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!`, extra);
  await pushSystem_(msg);
  await pushEvent_({ type:'event', event:'fireworks', kind:'race', by:nm, ts: Date.now() });
  launchFireworks_('congrats', nm);
  return;
}

// --- help ---
if (cmd === '/ëª…ë ¹ì–´' || cmd === '/ë„ì›€ë§'){
  msgEl.value = '';
  await pushSystem_(
    `ğŸ§­ ${nm}ë‹˜, ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n` +
    `â€¢ /ì™„ê²° [ë©”ì‹œì§€] : ì™„ê²° í­ì£½\n` +
    `â€¢ /ì¶•í•˜ [ë©”ì‹œì§€] : ì¶•í•˜ í­ì£½\n` +
    `â€¢ /í­íŒŒ [ë¹„ë°€ë²ˆí˜¸] : ì„¸ì…˜ ê°•ì œ ì´ˆê¸°í™”(ê´€ë¦¬ì)\n` +
    `â€¢ /ì´ˆê¸°í™” [ë¹„ë°€ë²ˆí˜¸] : (/í­íŒŒì™€ ë™ì¼)\n` +
    `â€¢ /í•˜íŠ¸ : í•˜íŠ¸ ë¿Œë¦¬ê¸°\n` +
    `â€¢ /ë°˜ì§ : ë°˜ì§ë°˜ì§ ì´í™íŠ¸\n` +
    `â€¢ /ëˆˆê½ƒ : ëˆˆê½ƒ ë‚´ë¦¬ê¸°\n` +
    `â€¢ /ë°•ìˆ˜ : ë°•ìˆ˜ ì´í™íŠ¸\n` +
    `â€¢ /í™˜ì˜ [ë©”ì‹œì§€] : í™˜ì˜ ë°˜ì§\n` +
    `â€¢ /ê³ ì¶” [ë©”ì‹œì§€] : ê³ ì¶”ë ¥ í­ë°œ\n` +
    `â€¢ /ë½€ë½€ [ë©”ì‹œì§€] : ë½€ë½€\n` +
    `â€¢ /ë¶ì—… [ë©”ì‹œì§€] : ë¶„ìœ„ê¸° ë¶ì—…\n` +
    `â€¢ /ê²½ê³  [ë©”ì‹œì§€] : ê²½ê³ (í™”ë©´ í”ë“¤ë¦¼)\n` +
    `â€¢ /ëŒ„ìŠ¤ [ë©”ì‹œì§€] : ëŒ„ìŠ¤íƒ€ì„\n` +
    `â€¢ /ë§ˆê° [ë©”ì‹œì§€] : ì›ê³ ê±°ì§€(ì„œë¥˜ë¹„)\n` +
    `â€¢ /ì•ˆë…• [ë©”ì‹œì§€] : ì¸ì‚¬\n` +
    `â€¢ /êµ¿ë°”ì´ [ë©”ì‹œì§€] : êµ¿ë°”ì´\n` +
    `â€¢ /ë„ë• [ë©”ì‹œì§€] : ë„ë•\n` +
    `â€¢ /ì œë°œ [ë©”ì‹œì§€] : ì œë°œ\n` +
    `â€¢ /ìˆ˜ì¤ : ìˆ˜ì¤ ì´í™íŠ¸\n` +
    `â€¢ /í˜„íƒ€ : í˜„íƒ€ ì´í™íŠ¸\n` +
    `â€¢ /ê°ì„± : ê°ì„± ì´í™íŠ¸\n` +
    `â€¢ /ì˜ê° [ë©”ì‹œì§€] : ì˜ê° ë²ˆì©\n` +
    `â€¢ /í‡´ê³  [ë©”ì‹œì§€] : í‡´ê³  ì—°í•„ë¹„\n` +
    `â€¢ /ë–¡ë°¥ [ë©”ì‹œì§€] : ë–¡ë°¥ íˆ¬ì²™\n` +
    `â€¢ /ì •ì£¼í–‰ [ë©”ì‹œì§€] : ì •ì£¼í–‰ ê°€ì†\n` +
    `â€¢ /ì—°ì¬ [ë©”ì‹œì§€] : ì—°ì¬ ì¶œë°œ!`
  );
  return;
}

// --- base fx (already supported by appendMessage_) ---
if (cmd === '/í•˜íŠ¸'){
  msgEl.value = '';
  await pushSystem_(`ğŸ’— ${nm}ë‹˜ì´ í•˜íŠ¸ë¥¼ ë¿Œë¦¬ì…¨ìŠµë‹ˆë‹¤!`);
  await pushEvent_({ type:'event', event:'fx', kind:'hearts', by:nm, ts: Date.now() });
  launchFx_('hearts', nm);
  return;
}
if (cmd === '/ë°˜ì§'){
  msgEl.value = '';
  await pushSystem_(`âœ¨ ${nm}ë‹˜ì´ ë°˜ì§ ì´í™íŠ¸ë¥¼ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤!`);
  await pushEvent_({ type:'event', event:'fx', kind:'sparkles', by:nm, ts: Date.now() });
  launchFx_('sparkles', nm);
  return;
}
if (cmd === '/ëˆˆê½ƒ'){
  msgEl.value = '';
  await pushSystem_(`â„ï¸ ${nm}ë‹˜ì´ ëˆˆê½ƒì„ ë¿Œë¦¬ì…¨ìŠµë‹ˆë‹¤!`);
  await pushEvent_({ type:'event', event:'fx', kind:'snow', by:nm, ts: Date.now() });
  launchFx_('snow', nm);
  return;
}
if (cmd === '/ë°•ìˆ˜'){
  msgEl.value = '';
  await pushSystem_(`ğŸ‘ ${nm}ë‹˜ì´ ë°•ìˆ˜ë¥¼ ë³´ë‚´ì…¨ìŠµë‹ˆë‹¤!`);
  await pushEvent_({ type:'event', event:'fx', kind:'clap', by:nm, ts: Date.now() });
  launchFx_('clap', nm);
  return;
}

// --- writer room fx2 presets ---
if (cmd === '/í™˜ì˜'){
  await runFx2_('welcome', sysLine_(`ğŸ€ ${nm}ë‹˜ì´ í™˜ì˜ ì¸ì‚¬ë¥¼ ì „í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ê³ ì¶”'){
  await runFx2_('pepper', sysLine_(`ğŸŒ¶ï¸ ${nm}ë‹˜ì´ ê³ ì¶”ë ¥ì„ ëŒì–´ì˜¬ë¦¬ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ë½€ë½€'){
  await runFx2_('kiss', sysLine_(`ğŸ’‹ ${nm}ë‹˜ì´ ë½€ë½€ë¥¼ ë‚ ë¦¬ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ë¶ì—…'){
  await runFx2_('boomup', sysLine_(`ğŸ“£ ${nm}ë‹˜ì´ ë¶„ìœ„ê¸°ë¥¼ ë¶ì—…í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ê²½ê³ '){
  await runFx2_('warning', sysLine_(`âš ï¸ ${nm}ë‹˜ì´ ê²½ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.`, extra));
  return;
}
if (cmd === '/ëŒ„ìŠ¤'){
  await runFx2_('dance', sysLine_(`ğŸ•º ${nm}ë‹˜ì´ ëŒ„ìŠ¤íƒ€ì„ì„ ì—¬ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ë§ˆê°' || cmd === '/ì›ê³ ê±°ì§€'){
  const base = `ğŸ§¾ ${nm}ë‹˜ì´ ë§ˆê°ì„ ì™¸ì¹˜ì…¨ìŠµë‹ˆë‹¤â€¦ (ì›ê³ ê±°ì§€ ëª¨ë“œ)`;
  await runFx2_('deadline', sysLine_(base, extra));
  return;
}
if (cmd === '/ì•ˆë…•'){
  await runFx2_('hello', sysLine_(`ğŸ‘‹ ${nm}ë‹˜ì´ ì¸ì‚¬í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/êµ¿ë°”ì´'){
  await runFx2_('bye', sysLine_(`ğŸŒ™ ${nm}ë‹˜ì´ êµ¿ë°”ì´ ì¸ì‚¬ë¥¼ ë‚¨ê¸°ì…¨ìŠµë‹ˆë‹¤.`, extra));
  return;
}
if (cmd === '/ë„ë•'){
  await runFx2_('nod', sysLine_(`ğŸ‘ ${nm}ë‹˜ì´ ë„ë•ì´ì…¨ìŠµë‹ˆë‹¤.`, extra));
  return;
}
if (cmd === '/ì œë°œ'){
  await runFx2_('please', sysLine_(`ğŸ™ ${nm}ë‹˜ì´ ê°„ì ˆí•˜ê²Œ ë¶€íƒí•˜ì…¨ìŠµë‹ˆë‹¤â€¦`, extra));
  return;
}

// --- extra trio ---
if (cmd === '/ìˆ˜ì¤'){
  msgEl.value = '';
  await pushSystem_(`ğŸ™ˆ ${nm}ë‹˜ì´ ìˆ˜ì¤ì–´í•˜ì‹­ë‹ˆë‹¤â€¦`);
  await pushEvent_({ type:'event', event:'fx2', kind:'shy', by:nm, ts: Date.now() });
  return;
}
if (cmd === '/í˜„íƒ€'){
  msgEl.value = '';
  await pushSystem_(`ğŸ«¥ ${nm}ë‹˜ì´ í˜„íƒ€ë¥¼ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤â€¦`);
  await pushEvent_({ type:'event', event:'fx2', kind:'reality', by:nm, ts: Date.now() });
  return;
}
if (cmd === '/ê°ì„±'){
  msgEl.value = '';
  await pushSystem_(`âš¡ ${nm}ë‹˜ì´ ê°ì„±í•˜ì…¨ìŠµë‹ˆë‹¤!`);
  await pushEvent_({ type:'event', event:'fx2', kind:'awaken', by:nm, ts: Date.now() });
  return;
}



// --- new writer-fun presets (shared) ---
if (cmd === '/ì˜ê°'){
  await runFx2_('inspire', sysLine_(`ğŸ’¡ ${nm}ë‹˜ì´ ì˜ê°ì„ ë²ˆì©! í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/í‡´ê³ '){
  await runFx2_('revise', sysLine_(`âœï¸ ${nm}ë‹˜ì´ í‡´ê³ ì— ë“¤ì–´ê°€ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ë–¡ë°¥'){
  await runFx2_('bait', sysLine_(`ğŸ§© ${nm}ë‹˜ì´ ë–¡ë°¥ì„ íˆ¬ì²™í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ì •ì£¼í–‰'){
  await runFx2_('binge', sysLine_(`ğŸš€ ${nm}ë‹˜ì´ ì •ì£¼í–‰ ì—”ì§„ì„ ì¼œì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}
if (cmd === '/ì—°ì¬'){
  await runFx2_('serialize', sysLine_(`ğŸ–‹ï¸ ${nm}ë‹˜ì´ ì—°ì¬ë¥¼ ì‹œì‘í•˜ì…¨ìŠµë‹ˆë‹¤!`, extra));
  return;
}

// --- shout ticker ---
if (cmd === '/ì™¸ì¹˜ê¸°'){
  msgEl.value = '';
  const msg = (extra || '').trim();
  if (!msg){
    await pushSystem_(`ğŸ“£ ${nm}ë‹˜, /ì™¸ì¹˜ê¸° ë’¤ì— ë¬¸ì¥ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.`);
    return;
  }
  await pushSystem_(sysLine_(`ğŸ“£ ${nm}ë‹˜ì´ ì™¸ì¹˜ì…¨ìŠµë‹ˆë‹¤!`, msg));
  await pushEvent_({ type:'event', event:'shout', by:nm, text: msg, ts: Date.now() });
  return;
}

// --- naked shower (cute) ---
if (cmd === '/ë‚˜ì²´ìƒ¤ì›Œ'){
  msgEl.value = '';
  const msg = (extra || '').trim() || 'ë‚˜ì²´ìƒ¤ì›Œí•˜ê³  ì˜µë‹ˆë‹¤!';
  await pushSystem_(sysLine_(`ğŸš¿ ${nm}ë‹˜ì´ ë‚˜ì²´ìƒ¤ì›Œí•˜ëŸ¬ ê°€ì‹­ë‹ˆë‹¤!`, msg));
  // ticker + bubbly fx
  await pushEvent_({ type:'event', event:'shout', by:nm, text: msg, ts: Date.now() });
  await pushEvent_({ type:'event', event:'fx2', kind:'naked', by:nm, ts: Date.now() });
  return;
}

    const name = myName();
    msgEl.value = '';

    try{
      await window.FB.ensureAnonAuth();
      const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
      const msgRef = window.FB.push(root);

      await window.FB.set(msgRef, {
        uid: myUid_() || '',
        name: name.slice(0,12),
        emoji: (myProfile_().emoji || ''),
        color: (myProfile_().color || ''),
        text: text.slice(0, 2000),
        ts: Date.now(),
        type: 'chat'
      });
    }catch(e){
      alert('ì „ì†¡ ì‹¤íŒ¨! ë„¤íŠ¸ì›Œí¬/ê¶Œí•œì„ í™•ì¸í•´ì¤˜.');
    }
  }

  function appendMessage_(m){
    const log = $('log');

    const name = String(m.name || 'ìµëª…');
    const text = String(m.text || '');
    const ts = Number(m.ts || 0);
    const type = String(m.type || 'chat');


    // âœ… ê³¼ê±° ì´ë²¤íŠ¸ ì¬ìƒ ë°©ì§€(ì¬ì…ì¥ ì‹œ í­ì£¼ ë°©ì§€)
    if (type === 'event' && joinTs_ && ts && (ts < joinTs_ - 500)) return;


    // event: fireworks
    if (type === 'event' && String(m.event||'') === 'fireworks'){
      const kind = String(m.kind || 'congrats');
      const by = String(m.by || m.name || '');
      launchFireworks_(kind, by);
      return;
    }

    // event: fx (hearts/sparkles/snow/clap)
    if (type === 'event' && String(m.event||'') === 'fx'){
      const kind = String(m.kind || '');
      const by = String(m.by || m.name || '');
      launchFx_(kind, by);
      return;
    }
    

// event: fx2 (emoji burst preset)
if (type === 'event' && String(m.event||'') === 'fx2'){
  const kind = String(m.kind || '');
  const by = String(m.by || m.name || '');
  launchFx2_(kind, by);
  return;
}



// event: shout (ticker)
if (type === 'event' && String(m.event||'') === 'shout'){
  const by = String(m.by || m.name || '');
  const msg = String(m.text || '');
  showTicker_(by, msg);
  return;
}

    const row = document.createElement('div');
    row.className = 'row ' + (type === 'system' ? 'system' : ((String(m.uid||'') && String(m.uid||'') === String(myUid_()||'')) || (name === myName()) ? 'mine' : 'theirs'));

    const meta = document.createElement('div');
    meta.className = 'metaLine';
    meta.textContent = type === 'system'
      ? 'SYSTEM'
      : `${name}`;

    
const bubble = document.createElement('div');
bubble.className = 'bubble';

if (type === 'system'){
  bubble.textContent = text;
}else{
  const prof = {
    emoji: String(m.emoji || ''),
    color: String(m.color || '')
  };
  const fallback = getNickProfile_(name, false);
  const emoji = prof.emoji || fallback.emoji;
  const color = prof.color || fallback.color;

  const badge = document.createElement('span');
  badge.className = 'nickBadge';
  badge.style.borderColor = color;
  badge.style.background = hexToRgba_(color, 0.14);

  const eSpan = document.createElement('span');
  eSpan.className = 'nickEmoji';
  eSpan.textContent = emoji;

  const nSpan = document.createElement('span');
  nSpan.className = 'nickName';
  nSpan.textContent = name;

  badge.appendChild(eSpan);
  badge.appendChild(nSpan);

  const tSpan = document.createElement('span');
  tSpan.className = 'msgText';
  tSpan.textContent = text;

  bubble.appendChild(badge);
  bubble.appendChild(tSpan);
}
const bubbleRow = document.createElement('div');
bubbleRow.className = 'bubbleRow';

if (type === 'system'){
  bubbleRow.appendChild(bubble);
}else{
  const time = document.createElement('span');
  time.className = 'msgTime';
  time.textContent = fmtTime_(ts);

  // ë‚´ ë©”ì‹œì§€: ì‹œê°„-ë§í’ì„  / ìƒëŒ€: ë§í’ì„ -ì‹œê°„
  if (row.classList.contains('mine')){
    bubbleRow.appendChild(time);
    bubbleRow.appendChild(bubble);
  }else{
    bubbleRow.appendChild(bubble);
    bubbleRow.appendChild(time);
  }
}

row.appendChild(meta);
row.appendChild(bubbleRow);
log.appendChild(row);

// ENTRY_HEARTS_V1: ì…ì¥ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì£¼ë³€ í•˜íŠ¸
try{
  
  // ê³¼ê±° ë¡œê·¸ ì¬ìƒìœ¼ë¡œ ì¸í•œ í•˜íŠ¸ í­ì£¼ ë°©ì§€
  if (joinTs_ && ts && (Number(ts) < joinTs_ - 500)) { /* skip */ }
  else if (type === 'system'){
    const t = String(text||'');
    if (t.startsWith('ğŸ’— ') && (t.includes('ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤') || t.includes('ë‹˜ì´ ì…ì¥í•˜ì…¨ì–´ìš”'))){
      launchHeartsNearEl_(bubble);
    }
  }
}catch(e){}

// ìŠ¤í¬ë¡¤ ì •ì±…:
// - ì‚¬ìš©ìê°€ ë°”ë‹¥ ê·¼ì²˜ë¥¼ ë³´ê³  ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤
// - ìœ„ë¡œ ì˜¬ë ¤ì„œ ì½ëŠ” ì¤‘ì´ë©´ ê³ ì • + "ìƒˆ ë©”ì‹œì§€" ë²„íŠ¼ í‘œì‹œ
if (autoScroll_){
  log.scrollTop = log.scrollHeight;
}else{
  unreadCount_ = Math.min(999, unreadCount_ + 1);
  showJumpBtn_(true);
}}


function showJumpBtn_(show){
  const btn = $('jumpBtn');
  const cnt = $('jumpCnt');
  if (!btn || !cnt) return;
  cnt.textContent = String(unreadCount_);
  if (show && unreadCount_ > 0){
    btn.classList.add('show');
  }else{
    btn.classList.remove('show');
  }
}

function updateAutoScrollState_(){
  const log = $('log');
  if (!log) return;
  const dist = (log.scrollHeight - log.scrollTop - log.clientHeight);
  const nearBottom = dist < SCROLL_BOTTOM_THRESHOLD_PX;
  autoScroll_ = nearBottom;
  if (nearBottom){
    unreadCount_ = 0;
    showJumpBtn_(false);
  }
}

  function fmtTime_(ms){
    if (!ms) return '';
    const d = new Date(ms);
    const h = d.getHours();
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ampm = h >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
    const hh = (h % 12) || 12;
    return `${ampm} ${hh}:${mm}`;
  }

  // =====================
  // Presence (Realtime)
  // =====================
  async function startPresence_(roomId){
    if (presenceStarted) return;

    await window.FB.ensureAnonAuth();
    const user = window.FB.auth.currentUser;
    if (!user) return;

    presenceUid = user.uid;
    const nm = myName().slice(0,12) || 'ìµëª…';

    const connRoot = window.FB.ref(window.FB.db, `${fbPresenceConnPath_(roomId)}/${presenceUid}`);
    const connRef = window.FB.push(connRoot);
    presenceConnKey = connRef.key;

    try { window.FB.onDisconnect(connRef).remove(); } catch(e){}

    await window.FB.set(connRef, { name: nm, ts: Date.now(), cid: CLIENT_ID });

    // heartbeat: 15ì´ˆë§ˆë‹¤ ê°±ì‹ 
    presenceTimer = setInterval(async ()=>{
      try{
        const nm2 = myName().slice(0,12) || 'ìµëª…';
        await window.FB.update(connRef, { name: nm2, ts: Date.now() });
      }catch(e){}
    }, 15000);

    presenceStarted = true;
  }

  function stopPresence_(){
    try { if (presenceTimer) clearInterval(presenceTimer); } catch(e){}
    presenceTimer = null;
    presenceStarted = false;

    try{
      if (presenceLiveUnsub) presenceLiveUnsub();
    }catch(e){}
    presenceLiveUnsub = null;
    presenceLiveVal = null;
  }

  function initPresenceLive_(roomId){
    // rooms/<roomId>/presenceConn ì „ì²´ë¥¼ êµ¬ë…í•´ì„œ ì‹¤ì‹œê°„ ëª©ë¡ êµ¬ì„±
    try{
      const root = window.FB.ref(window.FB.db, fbPresenceConnPath_(roomId));
      presenceLiveUnsub = window.FB.onValue(root, (snap)=>{
        presenceLiveVal = snap.exists() ? (snap.val() || {}) : {};
        refreshPresenceUi_();
      });
    }catch(e){
      console.warn('presence live subscribe failed', e);
    }
  }

  function refreshPresenceUi_(){
    const r = computePresenceFromConn_(presenceLiveVal);
    $('onlineSub').textContent = `${r.count}ëª…`;

    const box = $('onlineList');
    box.innerHTML = '';
    r.names.forEach(n=>{
      const div = document.createElement('div');
      div.className = 'nameChip';
      div.innerHTML = `<span class="nm">${escapeHtml(n)}</span><span class="muted">â—</span>`;
      box.appendChild(div);
    });

    // DJ UI may depend on online list
    try{ setDjUi_(); }catch(e){}
  }


// =====================
// Typing indicator (shared)
// =====================
function initTyping_(roomId){
  try{
    const root = window.FB.ref(window.FB.db, fbTypingPath_(roomId));
    typingUnsub_ = window.FB.onValue(root, (snap)=>{
      const val = snap.exists() ? (snap.val() || {}) : {};
      renderTyping_(val);
    });

    const uid = myUid_();
    if (uid){
      typingRef_ = window.FB.ref(window.FB.db, `${fbTypingPath_(roomId)}/${uid}`);
      try{ window.FB.onDisconnect(typingRef_).remove(); }catch(e){}
    }
    bindTypingInput_();
  }catch(e){
    console.warn('initTyping failed', e);
  }
}

function bindTypingInput_(){
  const el = $('msg');
  if (!el || el.__typingBound) return;
  el.__typingBound = true;

  const onAct = ()=>{
    const v = (el.value || '');
    if (!v.trim()){
      stopTyping_();
      return;
    }
    startTyping_();
    clearTimeout(typingIdleTimer_);
    typingIdleTimer_ = setTimeout(()=> stopTyping_(), 1600);
  };

  el.addEventListener('input', onAct);
  el.addEventListener('focus', onAct);
  el.addEventListener('blur', ()=> stopTyping_());
}

async function startTyping_(){
  if (!sessionId || !typingRef_) return;
  const now = Date.now();
  if (now - typingLastSent_ < 800) return; // throttle
  typingLastSent_ = now;

  try{
    await window.FB.ensureAnonAuth();
    await window.FB.set(typingRef_, { name: myName().slice(0,12), ts: now });
  }catch(e){}
}

async function stopTyping_(){
  try{
    clearTimeout(typingIdleTimer_);
    typingIdleTimer_ = null;
    if (typingRef_) await window.FB.remove(typingRef_);
  }catch(e){}
}

function renderTyping_(val){
  const bar = $('typingBar');
  if (!bar) return;
  const txt = $('typingText');
  const target = txt || bar;

  const now = Date.now();
  const my = myName().slice(0,12);
  const names = [];
  const obj = val || {};
  for (const uid of Object.keys(obj)){
    const v = obj[uid];
    if (!v || !v.ts) continue;
    if ((now - Number(v.ts)) > 2500) continue;
    const nm = String(v.name || 'ìµëª…').trim().slice(0,12);
    if (!nm || nm === my) continue;
    names.push(nm);
  }

  if (!names.length){
    bar.classList.remove('show');
    if (target) target.innerHTML = '';
    return;
  }

  const uniq = Array.from(new Set(names)).slice(0,3);
  const more = names.length - uniq.length;
  const who = (uniq.length === 1) ? `${uniq[0]}ë‹˜` : `${uniq.join('ë‹˜, ')}ë‹˜`;
  const tail = more > 0 ? ` ì™¸ ${more}ëª…` : '';
  bar.classList.add('show');
  if (target){
    target.innerHTML = `<span class="typingDot"></span>${escapeHtml(who)}ê»˜ì„œ íƒ€ì´í•‘ ì¤‘ì…ë‹ˆë‹¤${tail}â€¦`;
  }
}


// =====================
// Mini Game: Typing Race
// =====================
let raceCur_ = null;
let racePlayers_ = {};
let raceCurUnsub_ = null;
let racePlayersUnsub_ = null;
let raceTick_ = null;
let raceLastSentAt_ = 0;
let raceLastProg_ = -1;
let raceCelebratedId_ = '';
let racePrevStatus_ = '';
let racePrevId_ = '';
let raceMeElim_ = false;
let raceLocalEnabled_ = false;

const RACE_LS_DIFF_ = 'VENT_RACE_DIFF_V1';

const RACE_LS_STRICT_ = 'VENT_RACE_STRICT_V1'; // ì˜¤íƒ€ ì¦‰ì‹œ íƒˆë½ ëª¨ë“œ
let raceStrict_ = true;
let raceElimAnnouncedFor_ = ''; // raceIdë³„ 1íšŒë§Œ ì•ˆë‚´

function loadRaceStrict_(){
  try{
    const v = localStorage.getItem(RACE_LS_STRICT_);
    // default: ON
    raceStrict_ = (v === null) ? true : (v !== '0');
  }catch(e){
    raceStrict_ = true;
  }
  return raceStrict_;
}
function setRaceStrict_(on){
  raceStrict_ = !!on;
  try{ localStorage.setItem(RACE_LS_STRICT_, raceStrict_ ? '1' : '0'); }catch(e){}
  return raceStrict_;
}

const RACE_LIMIT_MS_ = 120000; // 120ì´ˆ ì œí•œ
const RACE_ALLOWED_RE_ = /[0-9A-Za-zê°€-í£ã„±-ã…ã…-ã…£ !@#$%^&*(),./?]/g; // ì´ëª¨ì§€ ì œì™¸(í—ˆìš©: !@#$%^&*(),./?)

// --- Sentence pool builder (â‰¥200 per difficulty) ---
let _racePoolCache_ = { low:null, mid:null, high:null };

function hash32_(s){
  s = String(s||'');
  let h = 2166136261 >>> 0;
  for (let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32_(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function shuffleWithRng_(arr, rng){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(rng() * (i + 1));
    const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
  }
  return arr;
}


// âœ… ê³µìœ  ë¬¸ì¥ í’€(ë’¹êµ´ì‹  1000ê°œì˜ ë¬¸ì¥) ê¸°ë°˜
const SHARED_SENTENCES_ = [
  "ì£½ëŠ” ë‚ ê¹Œì§€ í•˜ëŠ˜ì„ ìš°ëŸ¬ëŸ¬ í•œ ì  ë¶€ë„ëŸ¼ì´ ì—†ê¸°ë¥¼, ììƒˆì— ì´ëŠ” ë°”ëŒì—ë„ ë‚˜ëŠ” ê´´ë¡œì›Œí–ˆë‹¤.",
  "ë³„ì„ ë…¸ë˜í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ëª¨ë“  ì£½ì–´ê°€ëŠ” ê²ƒì„ ì‚¬ë‘í•´ì•¼ì§€ ê·¸ë¦¬ê³  ë‚˜í•œí…Œ ì£¼ì–´ì§„ ê¸¸ì„ ê±¸ì–´ê°€ì•¼ê² ë‹¤.",
  "ì˜¤ëŠ˜ ë°¤ì—ë„ ë³„ì´ ë°”ëŒì— ìŠ¤ì¹˜ìš´ë‹¤.",
  "ë‚˜ ë³´ê¸°ê°€ ì—­ê²¨ì›Œ ê°€ì‹¤ ë•Œì—ëŠ” ë§ì—†ì´ ê³ ì´ ë³´ë‚´ ë“œë¦¬ì˜¤ë¦¬ë‹¤.",
  "ì˜ë³€ì— ì•½ì‚° ì§„ë‹¬ë˜ê½ƒ ì•„ë¦„ ë”°ë‹¤ ê°€ì‹¤ ê¸¸ì— ë¿Œë¦¬ì˜¤ë¦¬ë‹¤.",
  "ê°€ì‹œëŠ” ê±¸ìŒ ê±¸ìŒ ë†“ì¸ ê·¸ ê½ƒì„ ì‚¬ë¿íˆ ì¦ˆë ¤ë°Ÿê³  ê°€ì‹œì˜µì†Œì„œ.",
  "ë‚˜ ë³´ê¸°ê°€ ì—­ê²¨ì›Œ ê°€ì‹¤ ë•Œì—ëŠ” ì£½ì–´ë„ ì•„ë‹ˆ ëˆˆë¬¼ í˜ë¦¬ì˜¤ë¦¬ë‹¤.",
  "ìì„¸íˆ ë³´ì•„ì•¼ ì˜ˆì˜ë‹¤.",
  "ì˜¤ë˜ ë³´ì•„ì•¼ ì‚¬ë‘ìŠ¤ëŸ½ë‹¤.",
  "ë„ˆë„ ê·¸ë ‡ë‹¤.",
  "ë‚´ê°€ ê·¸ì˜ ì´ë¦„ì„ ë¶ˆëŸ¬ ì£¼ê¸° ì „ì—ëŠ” ê·¸ëŠ” ë‹¤ë§Œ í•˜ë‚˜ì˜ ëª¸ì§“ì— ì§€ë‚˜ì§€ ì•Šì•˜ë‹¤.",
  "ë‚´ê°€ ê·¸ì˜ ì´ë¦„ì„ ë¶ˆëŸ¬ ì£¼ì—ˆì„ ë•Œ ê·¸ëŠ” ë‚˜ì—ê²Œë¡œ ì™€ì„œ ê½ƒì´ ë˜ì—ˆë‹¤.",
  "ë‚´ê°€ ê·¸ì˜ ì´ë¦„ì„ ë¶ˆëŸ¬ ì¤€ ê²ƒì²˜ëŸ¼ ë‚˜ì˜ ì´ ë¹›ê¹”ê³¼ í–¥ê¸°ì— ì•Œë§ì€ ëˆ„ê°€ ë‚˜ì˜ ì´ë¦„ì„ ë¶ˆëŸ¬ ë‹¤ì˜¤.",
  "ê·¸ì—ê²Œë¡œ ê°€ì„œ ë‚˜ë„ ê·¸ì˜ ê½ƒì´ ë˜ê³  ì‹¶ë‹¤.",
  "ìš°ë¦¬ë“¤ì€ ëª¨ë‘ ë¬´ì—‡ì´ ë˜ê³  ì‹¶ë‹¤.",
  "ë„ˆëŠ” ë‚˜ì—ê²Œ ë‚˜ëŠ” ë„ˆì—ê²Œ ìŠí˜€ì§€ì§€ ì•ŠëŠ” í•˜ë‚˜ì˜ ëˆˆì§“ì´ ë˜ê³  ì‹¶ë‹¤.",
  "ë‚˜ í•˜ëŠ˜ë¡œ ëŒì•„ê°€ë¦¬ë¼.",
  "ìƒˆë²½ë¹› ì™€ ë‹¿ìœ¼ë©´ ìŠ¤ëŸ¬ì§€ëŠ” ì´ìŠ¬ ë”ë¶ˆì–´ ì†ì— ì¡ê³ , ë‚˜ í•˜ëŠ˜ë¡œ ëŒì•„ê°€ë¦¬ë¼.",
  "ë…¸ì„ë¹› í•¨ê»˜ ë‹¨ë‘˜ì´ì„œ ê¸°ìŠ­ì—ì„œ ë†€ë‹¤ê°€ êµ¬ë¦„ ì†ì§“í•˜ë©´ì€, ë‚˜ í•˜ëŠ˜ë¡œ ëŒì•„ê°€ë¦¬ë¼.",
  "ì•„ë¦„ë‹¤ìš´ ì´ ì„¸ìƒ ì†Œí’ ëë‚´ëŠ” ë‚ , ê°€ì„œ, ì•„ë¦„ë‹¤ì› ë”ë¼ê³  ë§í•˜ë¦¬ë¼.",
  "ë‚´ ê·¸ëŒ€ë¥¼ ìƒê°í•¨ì€ í•­ìƒ ê·¸ëŒ€ê°€ ì•‰ì•„ ìˆëŠ” ë°°ê²½ì—ì„œ í•´ê°€ ì§€ê³  ë°”ëŒì´ ë¶€ëŠ” ì¼ì²˜ëŸ¼ ì‚¬ì†Œí•œ ì¼ì¼ ê²ƒì´ë‚˜ ì–¸ì  ê°€ ê·¸ëŒ€ê°€ í•œì—†ì´ ê´´ë¡œì›€ ì†ì„ í—¤ë§¤ì¼ ë•Œì— ì˜¤ë«ë™ì•ˆ ì „í•´ ì˜¤ë˜ ê·¸ ì‚¬ì†Œí•¨ìœ¼ë¡œ ê·¸ëŒ€ë¥¼ ë¶ˆëŸ¬ë³´ë¦¬ë¼.",
  "ì§„ì‹¤ë¡œ ì§„ì‹¤ë¡œ ë‚´ê°€ ê·¸ëŒ€ë¥¼ ì‚¬ë‘í•˜ëŠ” ê¹Œë‹­ì€ ë‚´ ë‚˜ì˜ ì‚¬ë‘ì„ í•œë‚± ê´´ë¡œì›€ìœ¼ë¡œ ë°”ê¾¸ì–´ ë²„ë¦° ë° ìˆì§€ ì•Šê³  ë°¤ì´ ë‚®ìœ¼ë¡œ ë³€í•˜ê³  ë‚®ì´ ë°¤ìœ¼ë¡œ ë³€í•˜ëŠ” ì—´ë ¤ ìˆëŠ” ì‹œê°„ ë•Œë¬¸ì¼ ê²ƒì´ë¼.",
  "ê·¸ëŒ€ê°€ í•œì—†ì´ ì–´ë‘  ì†ì„ í—¤ë§¤ì¼ ë•Œì— ë‚´ê°€ ê°€ì¡Œë˜ ë§Œë‚¨ì˜ ì‹œê°„ìœ¼ë¡œ ê·¸ëŒ€ë¥¼ ë¶ˆëŸ¬ë³´ë¦¬ë¼.",
  "ê³„ì ˆì´ ì§€ë‚˜ê°€ëŠ” í•˜ëŠ˜ì—ëŠ” ê°€ì„ë¡œ ê°€ë“ ì°¨ ìˆìŠµë‹ˆë‹¤.",
  "ë‚˜ëŠ” ì•„ë¬´ ê±±ì •ë„ ì—†ì´ ê°€ì„ ì†ì˜ ë³„ë“¤ì„ ë‹¤ í—¤ì¼ ë“¯í•©ë‹ˆë‹¤.",
  "ê°€ìŠ´ì†ì— í•˜ë‚˜ ë‘˜ ìƒˆê²¨ì§€ëŠ” ë³„ì„ ì´ì œ ë‹¤ ëª» í—¤ëŠ” ê²ƒì€ ì‰¬ì´ ì•„ì¹¨ì´ ì˜¤ëŠ” ê¹Œë‹­ì´ìš”, ë‚´ì¼ ë°¤ì´ ë‚¨ì€ ê¹Œë‹­ì´ìš”, ì•„ì§ ë‚˜ì˜ ì²­ì¶˜ì´ ë‹¤í•˜ì§€ ì•Šì€ ê¹Œë‹­ì…ë‹ˆë‹¤.",
  "ë³„ í•˜ë‚˜ì— ì¶”ì–µê³¼ ë³„ í•˜ë‚˜ì— ì‚¬ë‘ê³¼ ë³„ í•˜ë‚˜ì— ì“¸ì“¸í•¨ê³¼ ë³„ í•˜ë‚˜ì— ë™ê²½ê³¼ ë³„ í•˜ë‚˜ì— ì‹œì™€ ë³„ í•˜ë‚˜ì— ì–´ë¨¸ë‹ˆ, ì–´ë¨¸ë‹ˆ.",
  "ë‹˜ì€ ê°”ìŠµë‹ˆë‹¤.",
  "ì•„ì•„ ì‚¬ë‘í•˜ëŠ” ë‚˜ì˜ ë‹˜ì€ ê°”ìŠµë‹ˆë‹¤.",
  "í‘¸ë¥¸ ì‚°ë¹›ì„ ê¹¨ì¹˜ê³  ë‹¨í’ë‚˜ë¬´ ìˆ²ì„ í–¥í•˜ì—¬ ë‚œ ì‘ì€ ê¸¸ì„ ê±¸ì–´ì„œ ì°¨ë§ˆ ë–¨ì¹˜ê³  ê°”ìŠµë‹ˆë‹¤.",
  "í™©ê¸ˆì˜ ê½ƒê°™ì´ êµ³ê³  ë¹›ë‚˜ë˜ ì˜› ë§¹ì„¸ëŠ” ì°¨ë””ì°¬ í‹°ëŒì´ ë˜ì–´ì„œ í•œìˆ¨ì˜ ë¯¸í’ì— ë‚ ì•„ê°”ìŠµë‹ˆë‹¤.",
  "ë‚ ì¹´ë¡œìš´ ì²« í‚¤ìŠ¤ì˜ ì¶”ì–µì€ ë‚˜ì˜ ìš´ëª…ì˜ ì§€ì¹¨ì„ ëŒë ¤ë†“ê³  ë’·ê±¸ìŒì³ì„œ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.",
  "ë„“ì€ ë²Œ ë™ìª½ ëìœ¼ë¡œ ì˜›ì´ì•¼ê¸° ì§€ì¤„ëŒ€ëŠ” ì‹¤ê°œì²œì´ íœ˜ëŒì•„ ë‚˜ê°€ê³ , ì–¼ë£©ë°±ì´ í™©ì†Œê°€ í•´ì„¤í”¼ ê¸ˆë¹› ê²Œìœ¼ë¥¸ ìš¸ìŒì„ ìš°ëŠ” ê³³, ê·¸ê³³ì´ ì°¨ë§ˆ ê¿ˆì—”ë“¤ ìŠí ë¦¬ì•¼.",
  "ì§ˆí™”ë¡œì— ì¬ê°€ ì‹ì–´ì§€ë©´ ë¹„ì¸ ë°­ì— ë°¤ë°”ëŒ ì†Œë¦¬ ë§ì„ ë‹¬ë¦¬ê³ , ì—·ì€ ì¡¸ìŒì— ê²¨ìš´ ëŠ™ìœ¼ì‹  ì•„ë²„ì§€ê°€ ì§šë² ê°œë¥¼ ë‹ì•„ ê³ ì´ì‹œëŠ” ê³³, ê·¸ê³³ì´ ì°¨ë§ˆ ê¿ˆì—”ë“¤ ìŠí ë¦¬ì•¼.",
  "í•œ ì†¡ì´ì˜ êµ­í™”ê½ƒì„ í”¼ìš°ê¸° ìœ„í•´ ë´„ë¶€í„° ì†Œì©ìƒˆëŠ” ê·¸ë ‡ê²Œ ìš¸ì—ˆë‚˜ ë³´ë‹¤.",
  "í•œ ì†¡ì´ì˜ êµ­í™”ê½ƒì„ í”¼ìš°ê¸° ìœ„í•´ ì²œë‘¥ì€ ë¨¹êµ¬ë¦„ ì†ì—ì„œ ë˜ ê·¸ë ‡ê²Œ ìš¸ì—ˆë‚˜ ë³´ë‹¤.",
  "ê·¸ë¦¬ì›€ì— ì§€ì³ ë¨¼ ë¨¼ ì ŠìŒì˜ ë’¤ì•ˆê¸¸ì—ì„œ ì´ì œëŠ” ëŒì•„ì™€ ê±°ìš¸ ì•ì— ì„  ë‚´ ëˆ„ë‹˜ê°™ì´ ìƒê¸´ ê½ƒì´ì—¬.",
  "ë…¸ë€ ë„¤ ê½ƒìì´ í”¼ë ¤ê³  ê°„ë°¤ì—” ë¬´ì„œë¦¬ê°€ ì €ë¦¬ ë‚´ë¦¬ê³  ë‚´ê²ŒëŠ” ì ë„ ì˜¤ì§€ ì•Šì•˜ë‚˜ ë³´ë‹¤.",
  "í”ë“¤ë¦¬ì§€ ì•Šê³  í”¼ëŠ” ê½ƒì´ ì–´ë”” ìˆìœ¼ë´.",
  "ì´ ì„¸ìƒ ê·¸ ì–´ë–¤ ì•„ë¦„ë‹¤ìš´ ê½ƒë“¤ë„ ë‹¤ í”ë“¤ë¦¬ë©´ì„œ í”¼ì—ˆë‚˜ë‹ˆ í”ë“¤ë¦¬ë©´ì„œ ì¤„ê¸°ë¥¼ ê³§ê²Œ ì„¸ì› ë‚˜ë‹ˆ í”ë“¤ë¦¬ì§€ ì•Šê³  ê°€ëŠ” ì‚¬ë‘ì´ ì–´ë”” ìˆìœ¼ë´.",
  "ì –ì§€ ì•Šê³  í”¼ëŠ” ê½ƒì´ ì–´ë”” ìˆìœ¼ë´.",
  "ì´ ì„¸ìƒ ê·¸ ì–´ë–¤ ë¹›ë‚˜ëŠ” ê½ƒë“¤ë„ ë‹¤ ì –ìœ¼ë©° ì –ìœ¼ë©° í”¼ì—ˆë‚˜ë‹ˆ ë°”ëŒê³¼ ë¹„ì— ì –ìœ¼ë©° ê½ƒì ë”°ëœ»í•˜ê²Œ í”¼ì› ë‚˜ë‹ˆ ì –ì§€ ì•Šê³  ê°€ëŠ” ì‚¶ì´ ì–´ë”” ìˆìœ¼ë´.",
  "ì—°íƒ„ì¬ í•¨ë¶€ë¡œ ë°œë¡œ ì°¨ì§€ ë§ˆë¼.",
  "ë„ˆëŠ” ëˆ„êµ¬ì—ê²Œ í•œ ë²ˆì´ë¼ë„ ëœ¨ê±°ìš´ ì‚¬ëŒì´ì—ˆëŠëƒ.",
  "ì‚¬ëŒì´ ì˜¨ë‹¤ëŠ” ê±´ ì‹¤ì€ ì–´ë§ˆì–´ë§ˆí•œ ì¼ì´ë‹¤.",
  "ê·¸ëŠ” ê·¸ì˜ ê³¼ê±°ì™€ í˜„ì¬ì™€ ê·¸ë¦¬ê³  ê·¸ì˜ ë¯¸ë˜ì™€ í•¨ê»˜ ì˜¤ê¸° ë•Œë¬¸ì´ë‹¤.",
  "í•œ ì‚¬ëŒì˜ ì¼ìƒì´ ì˜¤ê¸° ë•Œë¬¸ì´ë‹¤.",
  "ë¶€ì„œì§€ê¸° ì‰¬ìš´ ê·¸ë˜ì„œ ë¶€ì„œì§€ê¸°ë„ í–ˆì„ ë§ˆìŒì´ ì˜¤ëŠ” ê²ƒì´ë‹¤.",
  "ê·¸ ê°ˆí”¼ë¥¼ ì•„ë§ˆ ë°”ëŒì€ ë”ë“¬ì–´ë³¼ ìˆ˜ ìˆì„ ë§ˆìŒ, ë‚´ ë§ˆìŒì´ ê·¸ëŸ° ë°”ëŒì„ í‰ë‚´ ë‚¸ë‹¤ë©´ í•„ê²½ í™˜ëŒ€ê°€ ë  ê²ƒì´ë‹¤.",
  "ê°€ë‚œí•˜ë‹¤ê³  í•´ì„œ ì™¸ë¡œì›€ì„ ëª¨ë¥´ê² ëŠ”ê°€.",
  "ë„ˆì™€ í—¤ì–´ì ¸ ëŒì•„ì˜¤ëŠ” ëˆˆ ìŒ“ì¸ ê³¨ëª©ê¸¸ì— ìƒˆí•˜ì–—ê²Œ ë‹¬ì´ ëœ¨ëŠ”ë°.",
  "ê°€ë‚œí•˜ë‹¤ê³  í•´ì„œ ë‘ë ¤ì›€ì´ ì—†ê² ëŠ”ê°€.",
  "ë‘ ì ì„ ì¹˜ëŠ” ì†Œë¦¬ ë°©ë²”ëŒ€ì›ì˜ í˜¸ê°ì†Œë¦¬ ë©”ë°€ë¬µ ì‚¬ë ¤ ì†Œë¦¬ì— ëˆˆì„ ëœ¨ë©´ ë©€ë¦¬ ìœ¡ì¤‘í•œ ê¸°ê³„ êµ´ëŸ¬ê°€ëŠ” ì†Œë¦¬.",
  "ê°€ë‚œí•˜ë‹¤ê³  í•´ì„œ ì‚¬ë‘ì„ ëª¨ë¥´ê² ëŠ”ê°€.",
  "ë‚´ ë³¼ì— ì™€ ë‹¿ë˜ ë„¤ ì…ìˆ ì˜ ëœ¨ê±°ì›€, ì‚¬ë‘í•œë‹¤ê³  ì‚¬ë‘í•œë‹¤ê³  ì†ì‚­ì´ë˜ ë„¤ ìˆ¨ê²°, ëŒì•„ì„œëŠ” ë‚´ ë“± ë’¤ì— í„°ì§€ë˜ ë„¤ ìš¸ìŒ.",
  "ê°€ì•¼ í•  ë•Œê°€ ì–¸ì œì¸ê°€ë¥¼ ë¶„ëª…íˆ ì•Œê³  ê°€ëŠ” ì´ì˜ ë’·ëª¨ìŠµì€ ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ìš´ê°€.",
  "ë´„ í•œ ì²  ê²©ì •ì„ ì¸ë‚´í•œ ë‚˜ì˜ ì‚¬ë‘ì€ ì§€ê³  ìˆë‹¤.",
  "ë¶„ë¶„í•œ ë‚™í™”, ê²°ë³„ì´ ì´ë£©í•˜ëŠ” ì¶•ë³µì— ì‹¸ì—¬ ì§€ê¸ˆì€ ê°€ì•¼ í•  ë•Œ.",
  "ë¬´ì„±í•œ ë…¹ìŒê³¼ ê·¸ë¦¬ê³  ë¨¸ì§€ì•Šì•„ ì—´ë§¤ ë§ºëŠ” ê°€ì„ì„ í–¥í•˜ì—¬ ë‚˜ì˜ ì²­ì¶˜ì€ ê½ƒë‹µê²Œ ì£½ëŠ”ë‹¤.",
  "ë¨¼ í›„ì¼ ë‹¹ì‹ ì´ ì°¾ìœ¼ì‹œë©´ ê·¸ë•Œì— ë‚´ ë§ì´ \"ìŠì—ˆë…¸ë¼\".",
  "ë‹¹ì‹ ì´ ì†ìœ¼ë¡œ ë‚˜ë¬´ë¼ë©´ \"ë¬´ì²™ ê·¸ë¦¬ë‹¤ê°€ ìŠì—ˆë…¸ë¼\".",
  "ê·¸ë˜ë„ ë‹¹ì‹ ì´ ë‚˜ë¬´ë¼ë©´ \"ë¯¿ê¸°ì§€ ì•Šì•„ì„œ ìŠì—ˆë…¸ë¼\".",
  "ì˜¤ëŠ˜ë„ ì–´ì œë„ ì•„ë‹ˆ ìŠê³  ë¨¼ í›„ì¼ ê·¸ë•Œì— \"ìŠì—ˆë…¸ë¼\".",
  "ì‚¬ë‘í•˜ëŠ” ê²ƒì€ ì‚¬ë‘ì„ ë°›ëŠë‹ˆë³´ë‹¤ í–‰ë³µí•˜ë‚˜ë‹ˆë¼.",
  "ì˜¤ëŠ˜ë„ ë‚˜ëŠ” ì—ë©”ë„ë“œë¹› í•˜ëŠ˜ì´ í™˜íˆ ë‚´ë‹¤ëµˆëŠ” ìš°ì²´êµ­ ì°½ë¬¸ ì•ì— ì™€ì„œ ë„ˆì—ê²Œ í¸ì§€ë¥¼ ì“´ë‹¤.",
  "í–‰ê¸¸ì„ í–¥í•´ ë‚œ ë¬¸ìœ¼ë¡œ ìˆ˜ì—†ì´ ë§ì€ ì‚¬ëŒë“¤ì´ ì œê°ê¸° í•œ ê°€ì§€ì”© ìƒê°ì— ì –ì–´ ì˜¤ê³  ê°€ê³ , ë‚´ê°€ ì €ë“¤ì„ ë¶€ë¥¼ ê¸°ì•½ ì—†ëŠ” ì¸ì—°ì´ë¼ê³  ìƒê°í•  ë•Œ, ë„ˆì—ê²Œ ë³´ë‚´ëŠ” ë‚˜ì˜ í¸ì§€ëŠ” ë”ìš± ëœ¨ê±°ìš´ ì‚¬ë‘ì˜ ê³ ë°±ì´ ë ì§€ë„ ëª¨ë¥¸ë‹¤.",
  "ë‚˜ë‘ì•¼ ê°„ë‹¤.",
  "ë‚˜ì˜ ì´ ì Šì€ ë‚˜ì´ë¥¼ ëˆˆë¬¼ë¡œì•¼ ë³´ë‚¼ ê±°ëƒ.",
  "ë‚˜ë‘ì•¼ ê°€ë ¨ë‹¤.",
  "ì•„ëŠ‘í•œ ì´ í•­êµ¬ì¸ë“¤ ì†ì‰½ê²Œì•¼ ë²„ë¦´ ê±°ëƒ.",
  "ì•ˆê°œê°™ì´ ììš±í•œ ë¶„ë…¸ê°€ ê°€ë¡œë§‰ì•„ë„ ë‚˜ë‘ì•¼ ê°€ë ¨ë‹¤.",
  "ëª¨ê°€ì§€ê°€ ê¸¸ì–´ì„œ ìŠ¬í”ˆ ì§ìŠ¹ì´ì—¬, ì–¸ì œë‚˜ ì ì–ì€ í¸ ë§ì´ ì—†êµ¬ë‚˜.",
  "ê´€(å† )ì´ í–¥ê¸°ë¡œìš´ ë„ˆëŠ” ë¬´ì²™ ë†’ì€ ì¡±ì†ì´ì—ˆë‚˜ ë³´ë‹¤.",
  "ë¬¼ì†ì˜ ì œ ê·¸ë¦¼ìë¥¼ ë“¤ì—¬ë‹¤ë³´ê³  ìƒì—ˆë˜ ì „ì„¤ì„ ìƒê°í•´ ë‚´ê³ ëŠ” ì–´ì°Œí•  ìˆ˜ ì—†ëŠ” í–¥ìˆ˜ì— ìŠ¬í”ˆ ëª¨ê°€ì§€ë¥¼ í•˜ê³  ë¨¼ ë° í•˜ëŠ˜ì„ ë°”ë¼ë³¸ë‹¤.",
  "íŒŒë„ì•¼ ì–´ì©Œë€ ë§ì´ëƒ, íŒŒë„ì•¼ ì–´ì©Œë€ ë§ì´ëƒ.",
  "ì„ì€ ë­ê°™ì´ ê¹Œë”± ì•ŠëŠ”ë°, íŒŒë„ì•¼ ì–´ì©Œë€ ë§ì´ëƒ.",
  "ë‚  ì–´ì©Œë€ ë§ì´ëƒ.",
  "í•´ì•¼ ì†Ÿì•„ë¼, í•´ì•¼ ì†Ÿì•„ë¼.",
  "ë§ê°›ê²Œ ì”»ì€ ì–¼êµ´ ê³ ìš´ í•´ì•¼ ì†Ÿì•„ë¼.",
  "ì‚° ë„˜ì–´ ì‚° ë„˜ì–´ì„œ ì–´ë‘ ì„ ì‚´ë¼ ë¨¹ê³ , ì‚° ë„˜ì–´ ë°¤ìƒˆë„ë¡ ì–´ë‘ ì„ ì‚´ë¼ ë¨¹ê³ , ì´ê¸€ì´ê¸€ ì• ë³ ì–¼êµ´ ê³ ìš´ í•´ì•¼ ì†Ÿì•„ë¼.",
  "ë‹¬ë°¤ì´ ì‹«ì–´, ë‹¬ë°¤ì´ ì‹«ì–´, ëˆˆë¬¼ ê°™ì€ ê³¨ì§œê¸°ì— ë‹¬ë°¤ì´ ì‹«ì–´, ì•„ë¬´ë„ ì—†ëŠ” ëœ°ì— ë‹¬ë°¤ì´ ë‚˜ëŠ” ì‹«ì–´.",
  "ì €ê²ƒì€ ë²½ ì–´ì©” ìˆ˜ ì—†ëŠ” ë²½ì´ë¼ê³  ìš°ë¦¬ê°€ ëŠë‚„ ë•Œ, ê·¸ë•Œ ë‹´ìŸì´ëŠ” ë§ì—†ì´ ê·¸ ë²½ì„ ì˜¤ë¥¸ë‹¤.",
  "ë¬¼ í•œ ë°©ìš¸ ì—†ê³  ì”¨ì•— í•œ í†¨ ì‚´ì•„ë‚¨ì„ ìˆ˜ ì—†ëŠ” ì €ê²ƒì€ ì ˆë§ì˜ ë²½ì´ë¼ê³  ë§í•  ë•Œ ë‹´ìŸì´ëŠ” ì„œë‘ë¥´ì§€ ì•Šê³  ì•ìœ¼ë¡œ ë‚˜ì•„ê°„ë‹¤.",
  "í•œ ë¼˜ì´ë¼ë„ ê¼­ ì—¬ëŸ¿ì´ í•¨ê»˜ ì†ì„ ì¡ê³  ì˜¬ë¼ê°„ë‹¤.",
  "í‘¸ë¥´ê²Œ ì ˆë§ì„ ë‹¤ ë®ì„ ë•Œê¹Œì§€ ë°”ë¡œ ê·¸ ì ˆë§ì„ ì¡ê³  ë†“ì§€ ì•ŠëŠ”ë‹¤.",
  "ê°€ë¬¸ ì„¬ì§„ê°• ì•„ì´ë“¤ì•„, ë„ˆí¬ë“¤ì€ ì•„ëŠëƒ.",
  "êµ½ì´êµ½ì´ íë¥´ëŠ” ì € ë¬¼ê¸¸ì´ ì–´ë””ë¡œ ê°€ëŠ”ì§€.",
  "íë¥´ë‹¤ íë¥´ë‹¤ ì§€ì³ì„œ ë©ˆì¶”ëŠ” ê³³ì´ ì–´ë””ì¸ì§€ ë„ˆí¬ë“¤ì€ ì•„ëŠëƒ.",
  "ê°€ë„ ê°€ë„ ëì—†ëŠ” ì € ì‚° ìë½ë“¤ì´ ì™œ ì €ë ‡ê²Œ í‘¸ë¥¸ì§€ ë„ˆí¬ë“¤ì€ ì•„ëŠëƒ.",
  "ê·¸ëŒ€ ì˜¤ì‹œëŠ” ê¸¸ì— ê½ƒ í•œ ì†¡ì´ í”¼ìš°ê³  ì‹¶ì–´, ë°œìêµ­ ì†Œë¦¬ ë“¤ë¦¬ëŠ” ê³³ë§ˆë‹¤ ê½ƒë“¤ì´ ë¨¼ì € ë§ˆì¤‘ ë‚˜ê°€ëŠ” ê·¸ëŸ° ë´„ë‚ ì´ê³  ì‹¶ìŠµë‹ˆë‹¤.",
  "ë‚´ ë§ˆìŒì†ì— ë‹¹ì‹ ì´ë¼ëŠ” ì´ë¦„ì´ ê½ƒì²˜ëŸ¼ í”¼ì–´ë‚  ë•Œ, ì„¸ìƒì€ ì˜¨í†µ ë‹¹ì‹ ì˜ í–¥ê¸°ë¡œ ê°€ë“í•©ë‹ˆë‹¤.",
  "í‘¸ë¥¸ í•˜ëŠ˜ì„ ì œì••í•˜ëŠ” ë…¸ê³ ì§€ë¦¬ê°€ ììœ ë¡œì™”ë‹¤ê³  ë¶€ëŸ¬ì›Œí•˜ë˜ ì–´ëŠ ì‹œì¸ì˜ ë§ì€ ìˆ˜ì •ë˜ì–´ì•¼ í•œë‹¤.",
  "ììœ ë¥¼ ìœ„í•´ì„œ ë¹„ìƒí•˜ì—¬ ë³¸ ì¼ì´ ìˆëŠ” ì‚¬ëŒì´ë©´ ì•Œì§€.",
  "ë…¸ê³ ì§€ë¦¬ê°€ ë¬´ì—‡ì„ ë³´ê³  ë…¸ë˜í•˜ëŠ”ê°€ë¥¼.",
  "ì–´ì§¸ì„œ ììœ ì—ëŠ” í”¼ì˜ ëƒ„ìƒˆê°€ ì„ì—¬ ìˆëŠ”ê°€ë¥¼.",
  "í˜ëª…ì€ ì™œ ê³ ë…í•´ì•¼ í•˜ëŠ”ê°€ë¥¼.",
  "í–¥ë‹¨ì•„ ê·¸ë„¤ì¤„ì„ ë°€ì–´ë¼.",
  "ë¨¸ì–¸ ë°”ë‹¤ë¡œ ë°°ë¥¼ ë‚´ì–´ ë°€ ë“¯ì´, í–¥ë‹¨ì•„.",
  "ì´ ë‹¤ì†Œê³³ì´ í”ë“¤ë¦¬ëŠ” ìˆ˜ì–‘ë²„ë“¤ ë‚˜ë¬´ì™€ ë² ê°¯ëª¨ì— ë†“ì¸ ê¸ˆì‹¤ ì›ì•™ìƒˆë¥¼ ê±´ë„ˆì„œ, í–¥ë‹¨ì•„.",
  "ì‚°í˜¸ë„ ì„¬ë„ ì—†ëŠ” ì € í•˜ëŠ˜ë¡œ ë‚˜ë¥¼ ë°€ì–´ ì˜¬ë ¤ë‹¤ì˜¤.",
  "ì±„ìƒ‰í•œ êµ¬ë¦„ê°™ì´ ë‚˜ë¥¼ ë°€ì–´ ì˜¬ë ¤ë‹¤ì˜¤.",
  "ì´ ìš¸ë ì´ëŠ” ê°€ìŠ´ì„ ë°€ì–´ ì˜¬ë ¤ë‹¤ì˜¤!",
  "ì‚°ì—ëŠ” ê½ƒ í”¼ë„¤, ê½ƒì´ í”¼ë„¤.",
  "ê°ˆ ë´„ ì—¬ë¦„ ì—†ì´ ê½ƒì´ í”¼ë„¤.",
  "ì‚°ì— ì‚°ì— í”¼ëŠ” ê½ƒì€ ì €ë§Œì¹˜ í˜¼ìì„œ í”¼ì–´ ìˆë„¤.",
  "ì‚°ì—ì„œ ìš°ëŠ” ì‘ì€ ìƒˆì—¬, ê½ƒì´ ì¢‹ì•„ ì‚°ì—ì„œ ì‚¬ë…¸ë¼ë„¤.",
  "ì‚°ì—ëŠ” ê½ƒ ì§€ë„¤, ê½ƒì´ ì§€ë„¤.",
  "ê°ˆ ë´„ ì—¬ë¦„ ì—†ì´ ê½ƒì´ ì§€ë„¤.",
  "ì„±ë¶ë™ ì‚°ì— ë²ˆì§€ê°€ ìƒˆë¡œ ìƒê¸°ë©´ì„œ ë³¸ë˜ ì‚´ë˜ ì„±ë¶ë™ ë¹„ë‘˜ê¸°ë§Œì´ ë²ˆì§€ê°€ ì—†ì–´ì¡Œë‹¤.",
  "ìƒˆë²½ë¶€í„° ëŒ ê¹¨ëŠ” ì‚°ìš¸ë¦¼ì— ë–¨ë‹¤ê°€ ê°€ìŠ´ì— ê¸ˆì´ ê°”ë‹¤.",
  "ê·¸ë˜ë„ ì„±ë¶ë™ ë¹„ë‘˜ê¸°ëŠ” í•˜ëŠë‹˜ì˜ ê´‘ì¥ ê°™ì€ ìƒˆíŒŒë€ ì•„ì¹¨ í•˜ëŠ˜ì— ì„±ë¶ë™ ì£¼ë¯¼ì—ê²Œ ì¶•ë³µì˜ ë©”ì‹œì§€ë‚˜ ì „í•˜ë“¯ ì„±ë¶ë™ í•˜ëŠ˜ì„ í•œ ë°”í€´ íœ˜ëˆë‹¤.",
  "ì´ì œ ì‚°ë„ ìƒê³  ì‚¬ëŒë„ ìƒê³  ì‚¬ë‘ê³¼ í‰í™”ì˜ ì‚¬ìƒê¹Œì§€ ë‚³ì§€ ëª»í•˜ëŠ” ì«“ê¸°ëŠ” ìƒˆê°€ ë˜ì—ˆë‹¤.",
  "ê°€ì„ì—ëŠ” ê¸°ë„í•˜ê²Œ í•˜ì†Œì„œ.",
  "ë‚™ì—½ë“¤ì´ ì§€ëŠ” ë•Œë¥¼ ê¸°ë‹¤ë ¤ ë‚´ê²Œ ì£¼ì‹  ê²¸í—ˆí•œ ëª¨êµ­ì–´ë¡œ ë‚˜ë¥¼ ì±„ìš°ê²Œ í•˜ì†Œì„œ.",
  "ê°€ì„ì—ëŠ” ì‚¬ë‘í•˜ê²Œ í•˜ì†Œì„œ.",
  "ì˜¤ì§ í•œ ì‚¬ëŒì„ íƒí•˜ê²Œ í•˜ì†Œì„œ.",
  "ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ì—´ë§¤ë¥¼ ìœ„í•˜ì—¬ ì´ ë¹„ì˜¥í•œ ì‹œê°„ì„ ê°€ê¾¸ê²Œ í•˜ì†Œì„œ.",
  "ê°€ì„ì—ëŠ” í˜¸ì˜¬ë¡œ ìˆê²Œ í•˜ì†Œì„œ.",
  "ë‚˜ì˜ ì˜í˜¼, êµ½ì´ì¹˜ëŠ” ë°”ë‹¤ì™€ ì—¬ì¸ ê³¨ì§œê¸°ë¥¼ ì§€ë‚˜ ë§ˆë¥¸ ë‚˜ë­‡ê°€ì§€ ìœ„ì— ë‹¤ë‹¤ë¥¸ ê¹Œë§ˆê·€ê°™ì´.",
  "ê»ë°ê¸°ëŠ” ê°€ë¼.",
  "ì‚¬ì›”ë„ ì•Œë§¹ì´ë§Œ ë‚¨ê³  ê»ë°ê¸°ëŠ” ê°€ë¼.",
  "ë™í•™ë…„ ê³°ë‚˜ë£¨ì˜, ê·¸ ì•„ìš°ì„±ë§Œ ì‚´ê³  ê»ë°ê¸°ëŠ” ê°€ë¼.",
  "ê·¸ë¦¬í•˜ì—¬, ë‹¤ì‹œ ê»ë°ê¸°ëŠ” ê°€ë¼.",
  "ì´ê³³ì—ì„ , ë‘ ê°€ìŠ´ê³¼ ê·¸ê³³ê¹Œì§€ ë‚´ë…¼ ì•„ì‚¬ë‹¬ ì•„ì‚¬ë…€ê°€ ì¤‘ë¦½ì˜ ì´ˆë¡€ì²­ ì•ì— ì„œì„œ ë¶€ë„ëŸ¼ ë¹›ë‚´ë©° ë§ì ˆí• ì§€ë‹ˆ.",
  "ì• ë¹„ëŠ” ì¢…ì´ì—ˆë‹¤.",
  "ë°¤ì´ ê¹Šì–´ë„ ì˜¤ì§€ ì•Šì•˜ë‹¤.",
  "íŒŒë¿Œë¦¬ê°™ì´ ëŠ™ì€ í• ë¨¸ë‹ˆì™€ ëŒ€ì¶”ë‚˜ë¬´ ê½ƒì´ ìŒ“ì´ëŠ” ë§ˆë‹¹ ì•„ë˜ì„œ ë‚´ ì–´ë¨¸ë‹ˆëŠ” ë‹¬ì„ ë‘ê³  ë‚˜ë¥¼ ë‚³ì•˜ë‹¤.",
  "ìŠ¤ë¬¼ì„¸ í•´ ë™ì•ˆ ë‚˜ë¥¼ í‚¤ìš´ ê±´ íŒ”í• ì´ ë°”ëŒì´ë‹¤.",
  "ì„¸ìƒì€ ë‚˜ë¥¼ ê°€ë¥´ì³ë„ ëŠ˜ ë¶€ë„ëŸ¬ì› ë‹¤.",
  "ì–´ë–¤ ì´ëŠ” ë‚´ ëˆˆì—ì„œ ì£„ì¸ì„ ì½ê³  ê°€ê³  ì–´ë–¤ ì´ëŠ” ë‚´ ì…ì—ì„œ ì²œì¹˜ë¥¼ ì½ê³  ê°€ë‚˜ ë‚˜ëŠ” ì•„ë¬´ê²ƒë„ ë‰˜ìš°ì¹˜ì§„ ì•Šì„ë ¨ë‹¤.",
  "ê¹Œë§ˆë“í•œ ë‚ ì— í•˜ëŠ˜ì´ ì²˜ìŒ ì—´ë¦¬ê³  ì–´ë”” ë‹­ ìš°ëŠ” ì†Œë¦¬ ë“¤ë ¸ìœ¼ë´.",
  "ëª¨ë“  ì‚°ë§¥ë“¤ì´ ë°”ë‹¤ë¥¼ ì—°ëª¨í•´ íœ˜ë‹¬ë¦´ ë•Œë„ ì°¨ë§ˆ ì´ê³³ì„ ë²”í•˜ë˜ ëª»í•˜ì˜€ìœ¼ë¦¬ë¼.",
  "ëŠì„ì—†ëŠ” ê´‘ìŒì„ ë¶€ì§€ëŸ°í•œ ê³„ì ˆì´ í”¼ì–´ì„  ì§€ê³  í° ê°•ë¬¼ì´ ë¹„ë¡œì†Œ ê¸¸ì„ ì—´ì—ˆë‹¤.",
  "ì§€ê¸ˆ ëˆˆ ë‚´ë¦¬ê³  ë§¤í™” í–¥ê¸° í™€ë¡œ ì•„ë“í•˜ë‹ˆ ë‚´ ì—¬ê¸° ê°€ë‚œí•œ ë…¸ë˜ì˜ ì”¨ë¥¼ ë¿Œë ¤ë¼.",
  "ë‹¤ì‹œ ì²œê³ ì˜ ë’¤ì— ë°±ë§ˆ íƒ€ê³  ì˜¤ëŠ” ì´ˆì¸ì´ ìˆì–´ ì´ ê´‘ì•¼ì—ì„œ ëª©ë†“ì•„ ë¶€ë¥´ê²Œ í•˜ë¦¬ë¼.",
  "ë‚´ ê³ ì¥ ì¹ ì›”ì€ ì²­í¬ë„ê°€ ìµì–´ ê°€ëŠ” ì‹œì ˆ.",
  "ì´ ë§ˆì„ ì „ì„¤ì´ ì£¼ì €ë¦¬ì£¼ì €ë¦¬ ì—´ë¦¬ê³  ë¨¼ ë° í•˜ëŠ˜ì´ ê¿ˆê¾¸ë©° ì•Œì•Œì´ ë“¤ì–´ì™€ ë°•í˜€ í•˜ëŠ˜ ë°‘ í‘¸ë¥¸ ë°”ë‹¤ê°€ ê°€ìŠ´ì„ ì—´ê³  í° ë› ë‹¨ ë°°ê°€ ê³±ê²Œ ë°€ë ¤ì„œ ì˜¤ë©´ ë‚´ê°€ ë°”ë¼ëŠ” ì†ë‹˜ì€ ê³ ë‹¬í”ˆ ëª¸ìœ¼ë¡œ ì²­í¬ë¥¼ ì…ê³  ì°¾ì•„ì˜¨ë‹¤ê³  í–ˆìœ¼ë‹ˆ ë‚´ ê·¸ë¥¼ ë§ì•„ ì´ í¬ë„ë¥¼ ë”° ë¨¹ìœ¼ë©´ ë‘ ì†ì€ í•¨ë¿ ì ì…”ë„ ì¢‹ìœ¼ë ¨.",
  "ì•„ì´ì•¼ ìš°ë¦¬ ì‹íƒì—” ì€ìŸë°˜ì— í•˜ì´ì–€ ëª¨ì‹œ ìˆ˜ê±´ì„ ë§ˆë ¨í•´ ë‘ë ´.",
  "ì‚°ì‚°ì´ ë¶€ì„œì§„ ì´ë¦„ì´ì—¬!",
  "í—ˆê³µ ì¤‘ì— í—¤ì–´ì§„ ì´ë¦„ì´ì—¬!",
  "ë¶ˆëŸ¬ë„ ì£¼ì¸ ì—†ëŠ” ì´ë¦„ì´ì—¬!",
  "ë¶€ë¥´ë‹¤ê°€ ë‚´ê°€ ì£½ì„ ì´ë¦„ì´ì—¬!",
  "ì‹¬ì¤‘ì— ë‚¨ì•„ ìˆëŠ” ë§ í•œë§ˆë””ëŠ” ëëë‚´ ë§ˆì € í•˜ì§€ ëª»í•˜ì˜€êµ¬ë‚˜.",
  "ì‚¬ë‘í•˜ë˜ ê·¸ ì‚¬ëŒì´ì—¬!",
  "ë¶‰ì€ í•´ëŠ” ì„œì‚°ë§ˆë£¨ì— ê±¸ë ¸ë‹¤.",
  "ì‚¬ìŠ´ì˜ ë¬´ë¦¬ë„ ìŠ¬í”¼ ìš´ë‹¤.",
  "ë–¨ì–´ì ¸ ë‚˜ê°€ ì•‰ì€ ì‚° ìœ„ì—ì„œ ë‚˜ëŠ” ê·¸ëŒ€ì˜ ì´ë¦„ì„ ë¶€ë¥´ë…¸ë¼.",
  "ë§¤ìš´ ê³„ì ˆì˜ ì±„ì°ì— ê°ˆê²¨ ë§ˆì¹¨ë‚´ ë¶ë°©ìœ¼ë¡œ íœ©ì“¸ë ¤ ì˜¤ë‹¤.",
  "í•˜ëŠ˜ë„ ê·¸ë§Œ ì§€ì³ ëë‚œ ê³ ì› ì„œë¦¿ë°œ ì¹¼ë‚ ì§„ ê·¸ ìœ„ì— ì„œë‹¤.",
  "ì–´ë””ë‹¤ ë¬´ë¦ì„ ê¿‡ì–´ì•¼ í•˜ë‚˜ í•œ ë°œ ì¬ê²¨ ë””ë”œ ê³³ì¡°ì°¨ ì—†ë‹¤.",
  "ì´ëŸ¬ë§¤ ëˆˆ ê°ì•„ ìƒê°í•´ ë³¼ë°–ì— ê²¨ìš¸ì€ ê°•ì² ë¡œ ëœ ë¬´ì§€ê°œì¸ê°€ ë³´ë‹¤.",
  "ì•„ë¬´ë„ ê·¸ì—ê²Œ ìˆ˜ì‹¬ì„ ì¼ëŸ¬ ì¤€ ì¼ì´ ì—†ê¸°ì— í° ë‚˜ë¹„ëŠ” ë„ë¬´ì§€ ë°”ë‹¤ê°€ ë¬´ì„­ì§€ ì•Šë‹¤.",
  "ì²­ë¬´ìš°ë°­ì¸ê°€ í•´ì„œ ë‚´ë ¤ê°”ë‹¤ê°€ëŠ” ì–´ë¦° ë‚ ê°œê°€ ë¬¼ê²°ì— ì ˆì–´ì„œ ê³µì£¼ì²˜ëŸ¼ ì§€ì³ì„œ ëŒì•„ì˜¨ë‹¤.",
  "ì‚¼ì›”ë‹¬ ë°”ë‹¤ê°€ ê½ƒì´ í”¼ì§€ ì•Šì•„ì„œ ì„œê¸€í”ˆ ë‚˜ë¹„ í—ˆë¦¬ì— ìƒˆíŒŒë€ ì´ˆìƒë‹¬ì´ ì‹œë¦¬ë‹¤.",
  "ìœ ë¦¬ì— ì°¨ê³  ìŠ¬í”ˆ ê²ƒì´ ì–´ë¥¸ê±°ë¦°ë‹¤.",
  "ì—´ì—†ì´ ë¶™ì–´ ì„œì„œ ì…ê¹€ì„ íë¦¬ìš°ë‹ˆ ê¸¸ë“¤ì€ ì–‘ ì–¸ ë‚ ê°œë¥¼ íŒŒë‹¥ê±°ë¦°ë‹¤.",
  "ì§€ìš°ê³  ë³´ê³  ì§€ìš°ê³  ë³´ì•„ë„ ìƒˆì¹´ë§Œ ë°¤ì€ ë°€ë ¤ ë‚˜ê°€ê³  ë°€ë ¤ì™€ ë¶€ë”ªì¹˜ê³ , ë¬¼ë¨¹ì€ ë³„ì´ ë°˜ì§ ë³´ì„ì²˜ëŸ¼ ë°•íŒë‹¤.",
  "ë°¤ì— í™€ë¡œ ìœ ë¦¬ë¥¼ ë‹¦ëŠ” ê²ƒì€ ì™¸ë¡œìš´ í™©í™€í•œ ì‹¬ì‚¬ì´ì–´ë‹ˆ, ê³ ìš´ íí˜ˆê´€ì´ í„°ì§„ ì±„ë¡œ ì•„ì•„ ë„ˆëŠ” ì‚°ìƒˆì²˜ëŸ¼ ë‚ ì•„ê°”êµ¬ë‚˜!",
  "í•˜ì´ì–€ ëª¨ìƒ‰ ì†ì— í”¼ì–´ ìˆëŠ” ì‚°í˜‘ì´Œì˜ ê³ ë…í•œ ê·¸ë¦¼ë™ë„¤.",
  "ì–´ëŠë§ ì°¨ê°€ìš´ ë“±ë¶ˆì„ ì¼œê³  ë¹„ì¸ ë¬˜ì§€ ëì— ì„œ ìˆëŠ” ë¯¸í’ ì†ì— ì¢…ì†Œë¦¬ì¡°ì°¨ ë“¤ë¦¬ì§€ ì•ŠëŠ” ì €ë…ë•Œê°€ ì™”ë‹¤.",
  "ê³ ì¸µ ë¹Œë”© ìœ ë¦¬ì°½ì— ì´ìŠ¬ì´ ë§ºíˆê³  ì–´ë””ì„ ê°€ í™€ë¡œ ì„œ ìˆëŠ” ì „ì‹ ì£¼ê°€ ë°¤ì˜ í•œë³µíŒìœ¼ë¡œ ê±¸ì–´ê°„ë‹¤.",
  "ëˆˆì€ ì‚´ì•„ ìˆë‹¤.",
  "ë–¨ì–´ì§„ ëˆˆì€ ì‚´ì•„ ìˆë‹¤.",
  "ë§ˆë‹¹ ìœ„ì— ë–¨ì–´ì§„ ëˆˆì€ ì‚´ì•„ ìˆë‹¤.",
  "ê¸°ì¹¨ì„ í•˜ì.",
  "ì Šì€ ì‹œì¸ì´ì—¬ ê¸°ì¹¨ì„ í•˜ì.",
  "ëˆˆ ìœ„ì— ëŒ€ê³  ê¸°ì¹¨ì„ í•˜ì.",
  "ëˆˆë”ëŸ¬ ë³´ë¼ê³  ë§ˆìŒë†“ê³  ë§ˆìŒë†“ê³  ê¸°ì¹¨ì„ í•˜ì.",
  "ì£½ìŒì„ ìŠì–´ë²„ë¦° ì˜í˜¼ê³¼ ìœ¡ì²´ë¥¼ ìœ„í•˜ì—¬ ëˆˆì€ ìƒˆë²½ì´ ì§€ë‚˜ë„ë¡ ì‚´ì•„ ìˆë‹¤.",
  "í­í¬ëŠ” ê³§ì€ ì ˆë²½ì„ ë¬´ì„œìš´ ê¸°ìƒ‰ë„ ì—†ì´ ë–¨ì–´ì§„ë‹¤.",
  "ê·œì •í•  ìˆ˜ ì—†ëŠ” ë¬¼ê²°ì´ ë¬´ì—‡ì„ í–¥í•˜ì—¬ ë–¨ì–´ì§„ë‹¤ëŠ” ì˜ë¯¸ë„ ì—†ì´ ê³„ì ˆê³¼ ì£¼ì•¼ë¥¼ ê°€ë¦¬ì§€ ì•Šê³  ê³ ë§¤í•œ ì •ì‹ ì²˜ëŸ¼ ì‰´ ì‚¬ì´ ì—†ì´ ë–¨ì–´ì§„ë‹¤.",
  "ê¸ˆì”í™”ë„ ì¸ê°€ë„ ë³´ì´ì§€ ì•ŠëŠ” ë°¤ì´ ë˜ë©´ í­í¬ëŠ” ê³§ì€ ì†Œë¦¬ë¥¼ ë‚´ë©° ë–¨ì–´ì§„ë‹¤.",
  "ê³ ë¦½ì„ ë‘ë ¤ì›Œí•˜ì§€ ì•Šê³  ë–¨ì–´ì§„ë‹¤.",
  "ë¨¸ë¦¿ê³ ê°œ ë„ˆë¨¸ ë™í™” ì† ê°™ì€ ì´ˆê°€ì§‘ í•œ ì±„.",
  "ìš¸íƒ€ë¦¬ ë°–ì—ëŠ” ì±„ì†¡í™”ê°€ í”¼ê³  ì•„ê¸° ì±„ì†¡í™”ê°€ í•€ë‹¤.",
  "ë¨¸ë¦¬ì— ìˆ˜ê±´ì„ ì“´ ì•„ì£¼ë¨¸ë‹ˆê°€ ì±„ì†Œë°­ì„ ë§¤ê³  ë¨¼ ë°ì„œ ë»ê¾¸ê¸° ì†Œë¦¬ê°€ ë“¤ë ¤ì˜¨ë‹¤.",
  "ë§ˆì„ì€ ê·¸ë ‡ê²Œ í‰í™”ë¡­ê³  ë‚˜ë¥¸í•œ ì˜¤í›„ë¥¼ ì§€ë‚˜ê°„ë‹¤.",
  "ë‚˜ëŠ” ë‚˜ë£»ë°° ë‹¹ì‹ ì€ í–‰ì¸.",
  "ë‹¹ì‹ ì€ í™ë°œë¡œ ë‚˜ë¥¼ ì§“ë°ŸìŠµë‹ˆë‹¤.",
  "ë‚˜ëŠ” ë‹¹ì‹ ì„ ì•ˆê³  ë¬¼ì„ ê±´ë„ˆê°‘ë‹ˆë‹¤.",
  "ë‚˜ëŠ” ë‹¹ì‹ ì„ ì•ˆìœ¼ë©´ ê¹Šìœ¼ë‚˜ ì–•ìœ¼ë‚˜ ê¸‰í•œ ì—¬ìš¸ì´ë‚˜ ê±´ë„ˆê°‘ë‹ˆë‹¤.",
  "ë§Œì¼ ë‹¹ì‹ ì´ ì•„ë‹ˆ ì˜¤ì‹œë©´ ë‚˜ëŠ” ë°”ëŒì„ ì¬ê³  ëˆˆë¹„ë¥¼ ë§ìœ¼ë©° ë°¤ì—ì„œ ë‚®ê¹Œì§€ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.",
  "ë‹¹ì‹ ì€ í–‰ì¸ì´ë¼ì„œ ê±´ë„ˆê°€ì‹œë©´ ë’¤ë„ ëŒì•„ë³´ì§€ ì•Šê³  ê°€ì‹­ë‹ˆë‹¤ê·¸ë ¤.",
  "ê·¸ëŸ¬ë‚˜ ë‹¹ì‹ ì´ ì–¸ì œë“ ì§€ ì˜¤ì‹¤ ì¤„ë§Œì€ ì•Œì•„ìš”.",
  "ë‚˜ëŠ” ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ë©´ì„œ ë‚ ë§ˆë‹¤ ë‚ ë§ˆë‹¤ ë‚¡ì•„ ê°‘ë‹ˆë‹¤.",
  "ì˜¥ìˆ˜ìˆ˜ ìì— ë¹—ë°©ìš¸ì´ ë‚´ë¦½ë‹ˆë‹¤.",
  "ì˜¤ëŠ˜ë„ ë˜ í•˜ë£¨ë¥¼ ì‚´ì•˜ìŠµë‹ˆë‹¤.",
  "ë‚™ì—½ì´ ì§€ê³  ì°¬ë°”ëŒì´ ë¶€ëŠ” ë•Œê¹Œì§€ ìš°ë¦¬ì—ê²Œ ë‚¨ì•„ ìˆëŠ” ë‚ ë“¤ì€ ì–¼ë§ˆë‚˜ ë ê¹Œìš”.",
  "ë‹¹ì‹ ì„ ì‚¬ë‘í•©ë‹ˆë‹¤.",
  "ë‚´ ëª¸ ì „ì²´ê°€ ë‹¹ì‹ ì˜ ì‚¬ë‘ìœ¼ë¡œ ê°€ë“ ì°¨ ì˜¤ë¥¼ ë•Œê¹Œì§€ ë‚˜ëŠ” ë‹¹ì‹ ì˜ ê³ì„ ë– ë‚˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.",
  "ìš°ë¦¬ê°€ í•¨ê»˜í–ˆë˜ ì‹œê°„ë“¤ì´ ì €ë¬´ëŠ” ë…¸ì„ì²˜ëŸ¼ ì•„ë¦„ë‹µê²Œ ê¸°ì–µë˜ê¸¸ ë°”ëë‹ˆë‹¤.",
  "ë‚˜ëŠ” ê·¸ëŠ˜ì´ ì—†ëŠ” ì‚¬ëŒì„ ì‚¬ë‘í•˜ì§€ ì•ŠëŠ”ë‹¤.",
  "ë‚˜ëŠ” ëˆˆë¬¼ì´ ì—†ëŠ” ì‚¬ëŒì„ ì‚¬ë‘í•˜ì§€ ì•ŠëŠ”ë‹¤.",
  "ë‚˜ëŠ” ëˆˆë¬¼ì„ í˜ë¦¬ë©° ê±¸ì–´ê°€ëŠ” ì‚¬ëŒì˜ ë’·ëª¨ìŠµì„ ì‚¬ë‘í•œë‹¤.",
  "ë‚˜ë¬´ì— ê·¸ëŠ˜ì´ ìˆì–´ ë‚˜ë¬´ê°€ ë˜ë“¯ ëˆˆë¬¼ì´ ìˆì–´ ì‚¬ëŒì´ ë˜ëŠ” ê²ƒì´ë‹¤.",
  "ì •ì‘ ìŠ¬í”ˆ ê²ƒì€ ëˆˆë¬¼ì´ ì—†ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ëˆˆë¬¼ì„ í˜ë¦´ ì¤„ ëª¨ë¥´ëŠ” ê²ƒì´ë‹¤.",
  "ë‚˜ë¬´ë„ ìƒì²˜ë¥¼ ì…ìœ¼ë©´ ë‹¨ë‹¨í•´ì§„ë‹¤.",
  "ê·¸ ìƒì²˜ ìêµ­ì´ ì˜¹ì´ê°€ ë˜ì–´ ë‹¨ë‹¨í•œ ë‚˜ë¬´ë¥¼ ë§Œë“ ë‹¤.",
  "ì‚¬ëŒë„ ìƒì²˜ë¥¼ ì…ì–´ì•¼ ë¹„ë¡œì†Œ ì‚¬ëŒì´ ëœë‹¤.",
  "ìƒì²˜ ì—†ëŠ” ì‚¬ë‘ì´ ì–´ë”” ìˆìœ¼ë´.",
  "ë°”ëŒì— í”ë“¤ë¦¬ê³  ë¹„ì— ì –ìœ¼ë©° ìš°ë¦¬ëŠ” ê·¸ë ‡ê²Œ ì¡°ê¸ˆì”© ê¹Šì–´ì§€ëŠ” ê²ƒì´ë‹¤.",
  "ì§•ì´ ìš¸ë¦°ë‹¤ ë§‰ì´ ë‚´ë ¸ë‹¤.",
  "ì˜¤ë™ë‚˜ë¬´ì— ì „ë“±ì´ ë§¤ì–´ë‹¬ë¦° ê°€ì„¤ë¬´ëŒ€, êµ¬ê²½ê¾¼ì´ ë°”ì§„ ìš´ë™ì¥ ì£¼ìœ„ì—” ì£¼ì €ì•‰ì•„ ë²½ì— ê¸°ëŒ€ì–´ ì†Œì£¼ë¥¼ ë§ˆì‹ ë‹¤.",
  "ë‹µë‹µí•˜ê³  ê³ ë‹¬í”„ê²Œ ì‚¬ëŠ” ê²ƒì´ ì›í†µí•˜ë‹¤.",
  "ê½¹ê³¼ë¦¬ë¥¼ ì•ì¥ì„¸ì›Œ ì¥ê±°ë¦¬ë¡œ ë‚˜ì„œë©´ ë”°ë¼ë¶™ì–´ ì•…ì„ ì“°ëŠ” ê±´ ì¡°ë¬´ë˜ê¸°ë“¤ë¿ ì²˜ë…€ì• ë“¤ì€ ë‹´ë²½ì— ë¶™ì–´ ì„œì„œ ì² ì—†ì´ ë‚„ë‚„ê±°ë¦¬ëŠ”êµ¬ë‚˜.",
  "ë³´ë¦„ë‹¬ì€ ë°ì•„ ì–´ë–¤ ë…€ì„ì€ êº½ì •ì´ì²˜ëŸ¼ ìš¸ë¶€ì§–ê³  ë˜ ì–´ë–¤ ë…€ì„ì€ ì„œë¦¼ì´ì²˜ëŸ¼ í•´í•´ëŒ€ì§€ë§Œ ì´ê¹Œì§“ ì‚° êµ¬ì„ì— ì²˜ë°•í˜€ ë°œë²„ë‘¥ì¹œë“¤ ë¬´ì—‡í•˜ë´.",
  "í’€ì´ ëˆ•ëŠ”ë‹¤.",
  "ë¹„ë¥¼ ëª°ì•„ì˜¤ëŠ” ë°”ëŒì— ë‚˜ë¶€ê»´ í’€ì€ ëˆ•ê³  ë“œë””ì–´ ìš¸ì—ˆë‹¤.",
  "ë‚ ì´ íë ¤ì„œ ë” ìš¸ë‹¤ê°€ ë‹¤ì‹œ ëˆ„ì› ë‹¤.",
  "ë°”ëŒë³´ë‹¤ë„ ë” ë¹¨ë¦¬ ëˆ•ëŠ”ë‹¤.",
  "ë°”ëŒë³´ë‹¤ë„ ë” ë¹¨ë¦¬ ìš¸ê³  ë°”ëŒë³´ë‹¤ ë¨¼ì € ì¼ì–´ë‚œë‹¤.",
  "ë‚ ì´ íë¦¬ê³  í’€ë¿Œë¦¬ê°€ ëˆ•ëŠ”ë‹¤.",
  "ë§‰ì°¨ëŠ” ì¢€ì²˜ëŸ¼ ì˜¤ì§€ ì•Šì•˜ë‹¤.",
  "ëŒ€í•©ì‹¤ ë°–ì—ëŠ” ë°¤ìƒˆ ì†¡ì´ëˆˆì´ ìŒ“ì´ê³  í° ë³´ë¼ ìˆ˜ì„ í™” ë‹®ì€ ì°¨ê°€ìš´ ìœ ë¦¬ì°½ë§ˆë‹¤ í†±ë°¥ ë‚œë¡œê°€ ì§€í´ì§€ê³  ìˆì—ˆë‹¤.",
  "ê·¸ë¯íŒ” ì•„ë¦° ì™¸ë¡œì›€ë“¤ì´ ìœ ë ¹ì²˜ëŸ¼ ì •ê±°ì¥ì— ëª°ë ¤ì™€ ì•‰ì•„ë„, ëˆ„êµ¬ í•˜ë‚˜ ì„£ë¶ˆë¦¬ ë§ì„ ê±´ë„¤ì§€ ëª»í–ˆë‹¤.",
  "ìš°ë¦¬ëŠ” ì €ë§ˆë‹¤ì˜ ì†ë°”ë‹¥ì— ë¬»ì€ ì‚¶ì˜ ë•Œë¥¼ ë¶ˆë¹›ì— ë§ë¦¬ë©°, ê·¸ë¦¬ìš´ ì´ë“¤ì˜ ì´ë¦„ì„ ê°€ìŠ´ ê¹Šì´ ìƒˆê²¼ë‹¤.",
  "ìš¸ì§€ ë§ˆë¼.",
  "ì™¸ë¡œìš°ë‹ˆê¹Œ ì‚¬ëŒì´ë‹¤.",
  "ì‚´ì•„ê°„ë‹¤ëŠ” ê²ƒì€ ì™¸ë¡œì›€ì„ ê²¬ë””ëŠ” ì¼ì´ë‹¤.",
  "ê³µì—°íˆ ì˜¤ì§€ ì•ŠëŠ” ì „í™”ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ë§ˆë¼.",
  "ëˆˆì´ ì˜¤ë©´ ëˆˆê¸¸ì„ ê±¸ì–´ê°€ê³  ë¹„ê°€ ì˜¤ë©´ ë¹—ê¸¸ì„ ê±¸ì–´ê°€ë¼.",
  "ê°ˆëŒ€ìˆ²ì—ì„œ ê°€ìŠ´ ê²€ì€ ë„ìš”ìƒˆë„ ë„ˆë¥¼ ë³´ê³  ìˆë‹¤.",
  "ê°€ë”ì€ í•˜ëŠë‹˜ë„ ì™¸ë¡œì›Œì„œ ëˆˆë¬¼ì„ í˜ë¦¬ì‹ ë‹¤.",
  "ì‚°ê·¸ë¦¼ìë„ ì™¸ë¡œì›Œì„œ í•˜ë£¨ì— í•œ ë²ˆì”© ë§ˆì„ë¡œ ë‚´ë ¤ì˜¨ë‹¤.",
  "ì¢…ì†Œë¦¬ë„ ì™¸ë¡œì›Œì„œ ìš¸ë ¤ í¼ì§„ë‹¤.",
  "ê¹Œë‹­ ì—†ì´ ë§ˆìŒ ì™¸ë¡œì›Œì§€ëŠ” ë‚ ì€ ë…¸ë€ ë¯¼ë“¤ë ˆ ê½ƒ í•œ ì†¡ì´ í”¼ì–´ ìˆëŠ” ê¸¸ì„ ê±·ê³  ì‹¶ë‹¤.",
  "í•˜ëŠ˜ì€ ì €ë ‡ê²Œ í‘¸ë¥´ê³  êµ¬ë¦„ì€ ì €ë ‡ê²Œ í•˜ì–€ë°, ë‚˜ëŠ” ì™œ ì´ë¦¬ í˜¼ìì¼ê¹Œ ìƒê°í•˜ë©° ê±·ë‹¤ ë³´ë©´ ë°œëì— ë‹¿ëŠ” ì‘ì€ ê½ƒë§ìš¸ì´ ë§ì„ ê±´ë„¨ë‹¤.",
  "ë„ˆë„ í˜¼ìêµ¬ë‚˜, ë‚˜ë„ í˜¼ìë€ë‹¤.",
  "ìš°ë¦¬ëŠ” ê·¸ë ‡ê²Œ ì„œë¡œì˜ ì™¸ë¡œì›€ì„ ë„ë‹¥ì´ë©° í•´ ì €ë¬´ëŠ” ë“¤íŒì„ í•¨ê»˜ ì§€í‚¨ë‹¤.",
  "ì €ê²Œ ì €ì ˆë¡œ ë¶‰ì–´ì§ˆ ë¦¬ëŠ” ì—†ë‹¤.",
  "ì € ì•ˆì— íƒœí’ ëª‡ ê°œ, ì € ì•ˆì— ì²œë‘¥ ëª‡ ê°œ, ì € ì•ˆì— ë²¼ë½ ëª‡ ê°œê°€ ë“¤ì–´ ìˆì–´ì„œ ë¶‰ê²Œ ìµíˆëŠ” ê²ƒì¼ ê²Œë‹¤.",
  "ì €ê²Œ ì € í˜¼ì ë‘¥ê¸€ì–´ì§ˆ ë¦¬ëŠ” ì—†ë‹¤.",
  "ì € ì•ˆì— ë¬´ì„œë¦¬ ë‚´ë¦¬ëŠ” ëª‡ ë°¤, ì € ì•ˆì— ë•¡ë³• ë‘ì–´ ë‹¬, ì € ì•ˆì— ì´ˆìŠ¹ë‹¬ ëª‡ ë‚ ì´ ë“¤ì–´ì„œì„œ ë‘¥ê¸€ê²Œ ë§Œë“œëŠ” ê²ƒì¼ ê²Œë‹¤.",
  "ëŒ€ì¶”ì•¼, ë„ˆëŠ” ì„¸ìƒê³¼ ì‹¸ì›Œ ì´ê²¼êµ¬ë‚˜.",
  "ë†’ì€ ê°€ì§€ë¥¼ í”ë“œëŠ” ë§¤ë¯¸ ì†Œë¦¬ì— ë¬»í˜€ ë‚´ ìš¸ìŒì†Œë¦¬ëŠ” ì•„ì§ ë…¸ë˜ê°€ ì•„ë‹ˆë‹¤.",
  "ì°¨ê°€ìš´ ë°”ë‹¥ ìœ„ì— í† í•˜ëŠ” ìš¸ìŒ, í’€ì ì—†ê³  ì´ìŠ¬ í•œ ë°©ìš¸ ë‚´ë¦¬ì§€ ì•ŠëŠ” ì§€í•˜ë„ ì½˜í¬ë¦¬íŠ¸ë²½ ì¢ì€ í‹ˆì—ì„œ ìˆ¨ë§‰í ë“¯ ë‚´ì‰¬ëŠ” ê¸°ì¹¨ ì†Œë¦¬ë‹¤.",
  "ê·¸ëŸ¬ë‚˜ ëˆ„êµ°ê°€ì—ê²Œ ë‚´ ìš¸ìŒì€ ê°€ì„ì„ ë¶€ë¥´ëŠ” ì‹ í˜¸ê°€ ë˜ë¦¬ë¼.",
  "ì§€ê¸ˆì€ ë¹„ë¡ ë§¤ë¯¸ ì†Œë¦¬ì— ê°€ë ¤ ë“¤ë¦¬ì§€ ì•Šì§€ë§Œ, ë¨¸ì§€ì•Šì•„ ëŒ€ì§€ëŠ” ë‚´ ë…¸ë˜ë¡œ ê¹Šì–´ê°ˆ ê²ƒì´ë‹¤.",
  "ë‚´ë ¤ê°ˆ ë•Œ ë³´ì•˜ë„¤.",
  "ì˜¬ë¼ê°ˆ ë•Œ ëª» ë³¸ ê·¸ ê½ƒ.",
  "ì–´ë”˜ê°€ ë‚´ê°€ ëª¨ë¥´ëŠ” ê³³ì— ë³´ì´ì§€ ì•ŠëŠ” ê½ƒì²˜ëŸ¼ ì›ƒê³  ìˆëŠ”, ë„ˆ í•œ ì‚¬ëŒìœ¼ë¡œ í•˜ì—¬ ì„¸ìƒì€ ë‹¤ì‹œ í•œ ë²ˆ ëˆˆë¶€ì‹  ì•„ì¹¨ì´ ë˜ê³ , ì–´ë”˜ê°€ ë„¤ê°€ ëª¨ë¥´ëŠ” ê³³ì— ë³´ì´ì§€ ì•ŠëŠ” í’€ìì²˜ëŸ¼ ì„œ ìˆëŠ”, ë‚˜ í•œ ì‚¬ëŒìœ¼ë¡œ í•˜ì—¬ ì„¸ìƒì€ ë‹¤ì‹œ í•œ ë²ˆ ê³ ìš”í•œ ì €ë…ì´ ëœë‹¤.",
  "ê°€ì„ì´ë‹¤, ë¶€ë”” ì•„í”„ì§€ ë§ˆë¼.",
  "ê¸¸ì´ ëë‚˜ëŠ” ê³³ì—ì„œë„ ê¸¸ì´ ìˆë‹¤.",
  "ê¸¸ì´ ëë‚˜ëŠ” ê³³ì—ì„œë„ ê¸¸ì´ ë˜ëŠ” ì‚¬ëŒì´ ìˆë‹¤.",
  "ìŠ¤ìŠ¤ë¡œ ì‚¬ë‘ì´ ë˜ì–´ í•œì—†ì´ ë´„ê¸¸ì„ ê±¸ì–´ê°€ëŠ” ì‚¬ëŒì´ ìˆë‹¤.",
  "ê°•ë¬¼ì€ íë¥´ë‹¤ê°€ ë©ˆì¶”ê³  ìƒˆë“¤ì€ ë‚ ì•„ê°€ ëŒì•„ì˜¤ì§€ ì•Šê³  í•˜ëŠ˜ê³¼ ë•… ì‚¬ì´ì˜ ëª¨ë“  ê½ƒìì€ í©ì–´ì ¸ë„, ë³´ë¼ ì‚¬ë‘ì„ ëë‚¸ ì‚¬ëŒë³´ë‹¤ ì‚¬ë‘ì„ ì‹œì‘í•˜ëŠ” ì‚¬ëŒì˜ ë’·ëª¨ìŠµì€ ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ìš´ê°€.",
  "ë„¤ê°€ ì˜¤ê¸°ë¡œ í•œ ê·¸ ìë¦¬ì—, ë‚´ê°€ ë¯¸ë¦¬ ê°€ì„œ ë„ˆë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë‹¤ê°€ì˜¤ëŠ” ëª¨ë“  ë°œìêµ­ì€ ë‚´ ê°€ìŠ´ì— ì¿µì¿µê±°ë¦°ë‹¤.",
  "ë°”ìŠ¤ë½ê±°ë¦¬ëŠ” ë‚˜ë­‡ì í•˜ë‚˜ë„ ë‹¤ ë‚´ê²Œë¡œ ì˜¤ëŠ” ë„ˆì˜ ë°œì†Œë¦¬ ê°™ë‹¤.",
  "ê¸°ë‹¤ë ¤ ë³¸ ì ì´ ìˆëŠ” ì‚¬ëŒì€ ì•ˆë‹¤.",
  "ì„¸ìƒì—ì„œ ê¸°ë‹¤ë¦¬ëŠ” ì¼ì²˜ëŸ¼ ê°€ìŠ´ ì•„í”ˆ ì¼ì€ ì—†ë‹¤ëŠ” ê²ƒì„.",
  "ë„¤ê°€ ì˜¤ì§€ ì•ŠëŠ” ê·¸ ì‹œê°„ê¹Œì§€ë„ ë‚˜ëŠ” ë„ˆë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.",
  "ì‚¬ë‘ì„ ìƒê³  ë‚˜ëŠ” ì“°ë„¤.",
  "ì˜ ìˆê±°ë¼, ì§§ì•˜ë˜ ë°¤ë“¤ì•„.",
  "ì°½ë°–ì„ ë– ëŒë˜ ê²¨ìš¸ ì•ˆê°œë“¤ì•„.",
  "ì•„ë¬´ê²ƒë„ ëª¨ë¥´ë˜ ì´›ë¶ˆë“¤ì•„, ì˜ ìˆê±°ë¼.",
  "ê³µí¬ë¥¼ ê¸°ë‹¤ë¦¬ë˜ í° ì¢…ì´ë“¤ì•„.",
  "ë§ì„¤ì„ì„ ëŒ€ì‹ í•˜ë˜ ëˆˆë¬¼ë“¤ì•„.",
  "ì˜ ìˆê±°ë¼, ë” ì´ìƒ ë‚´ ê²ƒì´ ì•„ë‹Œ ì—´ë§ë“¤ì•„.",
  "ì¥ë‹˜ì²˜ëŸ¼ ë‚˜ ì´ì œ ë”ë“¬ê±°ë¦¬ë©° ë¬¸ì„ ì ê·¸ë„¤.",
  "ê°€ì—¾ì€ ë‚´ ì‚¬ë‘ ë¹ˆì§‘ì— ê°‡í˜”ë„¤.",
  "ì—´ë¬´ ì‚¼ì‹­ ë‹¨ì„ ì´ê³  ì‹œì¥ì— ê°„ ìš°ë¦¬ ì—„ë§ˆ ì•ˆ ì˜¤ì‹œë„¤.",
  "í•´ëŠ” ì‹œë“  ì§€ ì˜¤ë˜, ë‚˜ëŠ” ì°¬ë°¥ì²˜ëŸ¼ ë°©ì— ë‹´ê²¨ ì•„ë¬´ë¦¬ ì²œì²œíˆ ìˆ™ì œë¥¼ í•´ë„ ì—„ë§ˆ ì•ˆ ì˜¤ì‹œë„¤.",
  "ë°°ì¶”ì ê°™ì€ ë°œì†Œë¦¬ íƒ€ë°•íƒ€ë°• ì•ˆ ë“¤ë¦¬ë„¤.",
  "ì–´ë‘¡ê³  ë¬´ì„œì›Œ ê¸ˆê°„ ì°½ í‹ˆìœ¼ë¡œ ê³ ìš”íˆ ë¹—ì†Œë¦¬ ë¹ˆë°©ì— í˜¼ì ì—ë“œë ¤ í›Œì©ê±°ë¦¬ë˜ ì•„ì£¼ ë¨¼ ì˜›ë‚ .",
  "ì§€ê¸ˆë„ ë‚´ ëˆˆì‹œìš¸ì„ ëœ¨ê²ê²Œ í•˜ëŠ” ê·¸ ì‹œì ˆ, ë‚´ ìœ ë…„ì˜ ìœ—ëª©.",
  "í”ë“¤ë¦¬ëŠ” ë‚˜ë­‡ê°€ì§€ì— ê½ƒ í•œë²ˆ í”¼ìš°ë ¤ê³  ëˆˆì€ ì–¼ë§ˆë‚˜ ë§ì€ ë„ì „ì„ ë©ˆì¶”ì§€ ì•Šì•˜ìœ¼ë´.",
  "ì‹¸ê·¸ë½ ì‹¸ê·¸ë½ ë‚¨ë°”ëŒ ì•ì„¸ìš°ê³  ì™”ë‹¤ê°€ í™°í™° ë’¤ì²™ì´ë©° ë°€ë ¤ê°€ëŠ” ëˆˆë³´ë¼.",
  "ê·¸ ë³´ë“œë¼ìš´ ë§ˆìŒì„ ë‹¤í•´ ë§ˆì¹¨ë‚´ í”¼ì›Œ ë‚¸ ì € í™©í™€í•œ ê½ƒ í•œ ì†¡ì´ ë³´ì•„ë¼.",
  "ë´„ì´ë©´ ê°€ì§€ëŠ” ê·¸ í•œ ë²ˆ ë´ ìë¦¬ì— ì„¸ìƒì—ì„œ ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ìƒì²˜ë¥¼ í„°ëœ¨ë¦°ë‹¤.",
  "ì € ì§€ë¶• ì•„ë˜ ì € ë°°ê³ í”ˆ ì–´ë¨¸ë‹ˆëŠ” ì–´ë–»ê²Œ ì ì„ ìëŠ”ê°€.",
  "ëª» í•˜ë‚˜ì— ì˜ì§€í•´ ì ì„ ì²­í•˜ëŠ” ì € ê°€ë…€ë¦° ìƒì• ë¥¼ ë³´ì•„ë¼.",
  "ë°”ëŒì´ ë¶ˆë©´ í”ë“¤ë¦¬ê³  ë¹„ê°€ ì˜¤ë©´ ì –ìœ¼ë©´ì„œë„ ê²°ì½” ë†“ì§€ ì•ŠëŠ” ê·¸ ëª» í•˜ë‚˜.",
  "ìš°ë¦¬ë¥¼ í‚¤ìš´ ê²ƒì€ ì–´ë¨¸ë‹ˆì˜ ë‹¨ì ì´ ì•„ë‹ˆë¼ ê·¸ ìœ„íƒœë¡œìš´ ì ì˜ í•œ ìë½ì´ì—ˆìŒì„, ì´ì œì•¼ ë‚¡ì€ ëª» ìêµ­ì„ ë³´ë©° ê¹¨ë‹«ëŠ”ë‹¤.",
  "ì‚°ëª¨í‰ì´ë¥¼ ëŒì•„ ë…¼ê°€ ì™¸ë”´ ìš°ë¬¼ì„ í™€ë¡œ ì°¾ì•„ê°€ì„  ê°€ë§Œíˆ ë“¤ì—¬ë‹¤ë´…ë‹ˆë‹¤.",
  "ìš°ë¬¼ ì†ì—ëŠ” ë‹¬ì´ ë°ê³  êµ¬ë¦„ì´ íë¥´ê³  í•˜ëŠ˜ì´ í¼ì¹˜ê³  íŒŒë€ ë°”ëŒì´ ë¶ˆê³  ê°€ì„ì´ ìˆìŠµë‹ˆë‹¤.",
  "ê·¸ë¦¬ê³  í•œ ì‚¬ë‚˜ì´ê°€ ìˆìŠµë‹ˆë‹¤.",
  "ì–´ì©ì§€ ê·¸ ì‚¬ë‚˜ì´ê°€ ë¯¸ì›Œì ¸ ëŒì•„ê°‘ë‹ˆë‹¤.",
  "ëŒì•„ê°€ë‹¤ ìƒê°í•˜ë‹ˆ ê·¸ ì‚¬ë‚˜ì´ê°€ ê°€ì—¾ì–´ì§‘ë‹ˆë‹¤.",
  "ë„ë¡œ ê°€ ë“¤ì—¬ë‹¤ë³´ë‹ˆ ì‚¬ë‚˜ì´ëŠ” ê·¸ëŒ€ë¡œ ìˆìŠµë‹ˆë‹¤.",
  "ë‹¤ì‹œ ê·¸ ì‚¬ë‚˜ì´ê°€ ë¯¸ì›Œì ¸ ëŒì•„ê°‘ë‹ˆë‹¤.",
  "ëŒì•„ê°€ë‹¤ ìƒê°í•˜ë‹ˆ ê·¸ ì‚¬ë‚˜ì´ê°€ ê·¸ë¦¬ì›Œì§‘ë‹ˆë‹¤.",
  "ìš°ë¬¼ ì†ì—ëŠ” ë‹¬ì´ ë°ê³  êµ¬ë¦„ì´ íë¥´ê³  í•˜ëŠ˜ì´ í¼ì¹˜ê³  íŒŒë€ ë°”ëŒì´ ë¶ˆê³  ê°€ì„ì´ ìˆê³  ì¶”ì–µì²˜ëŸ¼ ì‚¬ë‚˜ì´ê°€ ìˆìŠµë‹ˆë‹¤.",
  "ì €ë ‡ê²Œ ë§ì€ ì¤‘ì—ì„œ ë³„ í•˜ë‚˜ê°€ ë‚˜ë¥¼ ë‚´ë ¤ë‹¤ë³¸ë‹¤.",
  "ì´ë ‡ê²Œ ë§ì€ ì‚¬ëŒ ì¤‘ì—ì„œ ê·¸ ë³„ í•˜ë‚˜ë¥¼ ì³ë‹¤ë³¸ë‹¤.",
  "ë°¤ì´ ê¹Šì„ìˆ˜ë¡ ë³„ì€ ë°ìŒ ì†ì— ì‚¬ë¼ì§€ê³  ë‚˜ëŠ” ì–´ë‘  ì†ìœ¼ë¡œ ì‚¬ë¼ì§„ë‹¤.",
  "ì´ë ‡ê²Œ ì •ë‹¤ìš´ ë„ˆ í•˜ë‚˜ ë‚˜ í•˜ë‚˜ëŠ” ì–´ë””ì„œ ë¬´ì—‡ì´ ë˜ì–´ ë‹¤ì‹œ ë§Œë‚˜ë´.",
  "ê°•ë‚˜ë£¨ ê±´ë„ˆì„œ ë°€ë°­ ê¸¸ì„ êµ¬ë¦„ì— ë‹¬ ê°€ë“¯ì´ ê°€ëŠ” ë‚˜ê·¸ë„¤.",
  "ê¸¸ì€ ì™¸ì¤„ê¸° ë‚¨ë„ ì‚¼ë°± ë¦¬, ìˆ  ìµëŠ” ë§ˆì„ë§ˆë‹¤ íƒ€ëŠ” ì €ë… ë†€.",
  "êµ¬ë¦„ì— ë‹¬ ê°€ë“¯ì´ ê°€ëŠ” ë‚˜ê·¸ë„¤.",
  "ì–‡ì€ ì‚¬ í•˜ì´ì–€ ê³ ê¹”ì€ ê³ ì´ ì ‘ì–´ì„œ ë‚˜ë¹„ ì ìë¦¬.",
  "íŒŒë¥´ë¼ë‹ˆ ê¹ì€ ë¨¸ë¦¬ ë°•ì‚¬ê³ ê¹”ì— ê°€ë ¤ì§€ìš°ê³ , ë‘ ë³¼ì— íë¥´ëŠ” ë¹›ì´ ì •ì‘ìœ¼ë¡œ ê³ ì™€ì„œ ì„œëŸ¬ì›Œë¼.",
  "ë¹ˆ ëŒ€ì— í™©ì´‰ ë¶ˆì´ ë§ì—†ì´ ë…¹ëŠ” ë°¤ì— ì˜¤ë™ì ììƒˆë§ˆë‹¤ ë‹¬ì´ ì§€ëŠ”ë°, ì†Œë§¤ëŠ” ê¸¸ì–´ì„œ í•˜ëŠ˜ì€ ë„“ê³ , ê¹Œì¹˜ë°œ ë‹ìš°ê³ ì„œ ê°€ë³ê²Œ ì—ì›Œì„œë¼.",
  "íœ˜ì–´ì ¸ ê°ê¸°ìš°ê³  ë‹¤ì‹œ ì ‘ì–´ ë»—ëŠ” ì†ì´ ê¹Šì€ ë§ˆìŒ ì† ê±°ë£©í•œ í•©ì¥ì¸ ì–‘í•˜ê³ , ì´ ë°¤ì‚¬ ê·€ë˜ë¦¬ë„ ì§€ìƒˆìš°ëŠ” ì‚¼ê²½ì¸ë°, ì–‡ì€ ì‚¬ í•˜ì´ì–€ ê³ ê¹”ì€ ê³ ì´ ì ‘ì–´ì„œ ë‚˜ë¹„ ì ìë¦¬.",
  "ë”ëŸ¬ëŠ” ì˜¥í† ì— ë–¨ì–´ì§€ëŠ” ì‘ì€ ìƒëª…ì´ê³ ì €.",
  "í ë„ í‹°ë„ ì—†ëŠ” ë‚˜ì˜ ì „ì²´ëŠ” ì˜¤ì§ ì´ë¿.",
  "ë”ìš± ê°’ì§„ ê²ƒìœ¼ë¡œ ë“œë¦¬ë¼ í•˜ì˜¬ ì œ, ë‚˜ì˜ ê°€ì¥ ë‚˜ì•„ì¢… ì§€ë‹ˆì¸ ê²ƒë„ ì˜¤ì§ ì´ë¿.",
  "ì•„ë¦„ë‹¤ìš´ ë‚˜ë¬´ì˜ ê½ƒì´ ì‹œë“¦ì„ ë³´ì‹œê³  ì—´ë§¤ë¥¼ ë§ºê²Œ í•˜ì‹  ë‹¹ì‹ ì€, ë‚˜ì˜ ì›ƒìŒì„ ë§Œë“œì‹  í›„ì— ìƒˆë¡œì´ ë‚˜ì˜ ëˆˆë¬¼ì„ ì§€ì–´ ì£¼ì‹œë‹¤.",
  "ì‚°ì€ êµ¬ê°•ì‚° ë³´ëë¹› ì„ì‚°.",
  "ì‚°ë„í™” ë‘ì–´ ì†¡ì´ ì†¡ì´ì†¡ì´ í”¼ì—ˆëŠ”ë°, ë´„ëˆˆ ë…¹ì•„ íë¥´ëŠ” ì˜¥ ê°™ì€ ë¬¼ì— ì‚¬ìŠ´ì€ ì•”ì‚¬ìŠ´ ë°œì„ ì”»ëŠ”ë‹¤.",
  "ë‚™ì—½ì€ í´ë€ë“œ ë§ëª… ì •ë¶€ì˜ ì§€í, í¬í™”ì— ì´ì§€ëŸ¬ì§„ ë„ë£¬ ì‹œì˜ ê°€ì„ í•˜ëŠ˜ì„ ìƒê°ì¼€ í•œë‹¤.",
  "ê¸¸ì€ í•œ ì¤„ê¸° êµ¬ê²¨ì§„ ë„¥íƒ€ì´ì²˜ëŸ¼ í’€ì–´ì ¸ ì¼ê´‘ì˜ í­í¬ ì†ìœ¼ë¡œ ì‚¬ë¼ì§€ê³ , ì¡°ê·¸ë§Œ ë‹´ë°° ì—°ê¸°ë¥¼ ë‚´ë¿œìœ¼ë©° ìƒˆë¡œ ë‘ ì‹œì˜ ê¸‰í–‰ì—´ì°¨ê°€ ì§€ì—´ì„ ì°¨ê³  ê°„ë‹¤.",
  "í¬í”ŒëŸ¬ ë‚˜ë¬´ì˜ ê·¼ê³¨ ì‚¬ì´ë¡œ ê³µì¥ì˜ ì§€ë¶•ì€ í° ì´ë¹¨ì„ ë“œëŸ¬ë‚¸ ì±„ í•œ ê°€ë‹¥ êµ¬ë¶€ëŸ¬ì§„ ì² ì±…ì´ ë°”ëŒì— ì¼ë ì´ê³ , ê·¸ ìœ„ì— ì…€ë¡œíŒì§€ë¡œ ë§Œë“  êµ¬ë¦„ì´ í•œ ì¥ ë¶™ì–´ ìˆë‹¤.",
  "ì‚¬ëŒë“¤ ì‚¬ì´ì— ì„¬ì´ ìˆë‹¤.",
  "ê·¸ ì„¬ì— ê°€ê³  ì‹¶ë‹¤.",
  "ë²¼ëŠ” ì„œë¡œ ì–´ìš°ëŸ¬ì ¸ ê¸°ëŒ€ê³  ì‚°ë‹¤.",
  "í–‡ì‚´ ë”°ê°€ì›Œì§ˆìˆ˜ë¡ ê¹Šì´ ìµì–´ ìŠ¤ìŠ¤ë¡œë¥¼ ì•„ë¼ê³  ì´ì›ƒë“¤ì—ê²Œ ì €ë¥¼ ë§¡ê¸´ë‹¤.",
  "ì„œë¡œê°€ ì„œë¡œì˜ ëª¸ì„ ë¬¶ì–´ ë” íŠ¼íŠ¼í•´ì§„ ë°±ì„±ë“¤ì„ ë³´ì•„ë¼.",
  "ì£„ ì—†ëŠ” ì €í•­ì˜ ì¶¤ì„ ë³´ì•„ë¼.",
  "ë²¼ê°€ ë– ë‚˜ê°€ë©° ë°”ì¹˜ëŠ” ì´ ë„“ë””ë„“ì€ ì‚¬ë‘ì„ ë³´ì•„ë¼.",
  "ì´ ì„¸ìƒ ì‚¬ëŒë“¤ ëª¨ë‘ ì ë“¤ê³  ì–´ë‘  ì†ì— ê°‡í˜€ì„œ ê¿ˆê¿€ ë•Œ í™€ë¡œ ì¼ì–´ë‚œ ìƒˆë²½ì„ ë‘ë ¤ì›Œ ë§ê³  ë³„ì„ ë³´ê³  ê±¸ì–´ê°€ëŠ” ì‚¬ëŒì´ ë˜ë¼.",
  "í¬ë§ì„ ë§Œë“œëŠ” ì‚¬ëŒì´ ë˜ë¼.",
  "ê²¨ìš¸ë°¤ì€ ê¹Šì–´ì„œ ëˆˆë§Œ ë‚´ë¦¬ì–´ ìš°ë¦¬ë“¤ ì‚¬ë‘í•˜ëŠ” ìê·¸ë§Œ ì§‘ì°½ê°€ë§ˆë‹¤ ëˆˆì´ ìŒ“ì—¬ë„ ë¶‰ì€ ë§ˆìŒ í•˜ë‚˜ë¡œ ì ë“¤ì§€ ë§ê³  ë³„ì„ ë³´ê³  ê±¸ì–´ê°€ëŠ” ì‚¬ëŒì´ ë˜ë¼.",
  "ê°€ë³´ì§€ ëª»í•œ ê³³ì„ ê·¸ë¦¬ì›Œí•˜ëŠ” ë§ˆìŒì´ ì‚¬ë‘ì´ ì•„ë‹ˆë©´ ë¬´ì—‡ì¸ê°€.",
  "ê°€ë³´ì§€ ëª»í•œ ê³³ì„ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì´ ê·¸ë¦¬ì›€ì´ ì•„ë‹ˆë©´ ë¬´ì—‡ì¸ê°€.",
  "ì„œí•´, ë‹¹ì‹ ì˜ ëˆˆë™ì ì†ì— ì ê¸°ëŠ” ë…¸ì„ì„ ë³´ë©° ë‚˜ëŠ” í•œ ë²ˆë„ ê°€ë³´ì§€ ëª»í•œ ë‹¹ì‹ ì˜ ë§ˆìŒì†ì„ ê±·ëŠ”ë‹¤.",
  "ê²¨ìš¸ ë°”ë‹¤ì— ê°€ ë³´ì•˜ì§€.",
  "ë¯¸ì§€ì˜ ìƒˆ, ë³´ê³  ì‹¶ë˜ ìƒˆë“¤ì€ ì£½ê³  ì—†ì—ˆë„¤.",
  "ê·¸ëŒ€ ìƒê°ì„ íƒí–ˆë”ë‹ˆ ë§¤ìš´ í•´í’ì— ê·¸ë§ˆì € ê°€ë²„ë¦¬ê³ , í—ˆë¬´ì˜ ë¶ˆì„ í”¼ì›Œ ì°¨ê°€ìš´ ìˆ˜ì‹¬ìœ„ì— ë˜ì ¸ ì£¼ì—ˆë„¤.",
  "ë‚˜ë¥¼ ê°€ë¥´ì¹˜ëŠ” ê±´ ì–¸ì œë‚˜ ì‹œê°„, ë„ë•ì´ë©° ë„ë•ì´ë©° ê²¨ìš¸ ë°”ë‹¤ì— ì„°ì—ˆë„¤.",
  "ë‚¨ì€ ë‚ ì€ ì ì§€ë§Œ ê¸°ë„ëŠ” ëë‚œ ë‹¤ìŒë³´ë‹¤ ëœ¨ê±°ìš´ ê¸°ë„ì˜ ì‹œì‘ì„ì„ ë¯¿ë…¸ë¼.",
  "ë°”ëŒì´ ì„œëŠ˜ë„ í•˜ì—¬ ëœ° ì•ì— ë‚˜ì„°ë”ë‹ˆ, ì„œì‚° ë¨¸ë¦¬ì— í•˜ëŠ˜ì€ êµ¬ë¦„ì„ ë²—ì–´ë‚˜ê³ , ì‚°ëœ»í•œ ì´ˆìŠ¹ë‹¬ì´ ë³„ë¹›ì„ ë°ë¦¬ê³  ì˜µë‹ˆë‹¤.",
  "ë³„ì•„, ì € ë³„ì•„, ë„ˆëŠ” ì–´ì´ ê·¸ë¦¬ë„ ë°ìœ¼ëƒ.",
  "ë‚´ ë§ˆìŒì†ì— ê°€ë“í•œ ì–´ë‘ ì„ ë„¤ê°€ ë‹¤ ê°€ì ¸ê°”ëŠëƒ.",
  "ëª©ë ¨ê½ƒ ì§€ëŠ” ëª¨ìŠµ ì§€ì €ë¶„í•˜ë‹¤ê³  ë§í•˜ì§€ ë§ë¼.",
  "ê³ì— ìˆì„ ë•Œ í™˜í•˜ë˜ ëª¨ìŠµë§Œí¼ì´ë‚˜ ë– ë‚  ë•Œì˜ ëª¨ìŠµë„ ë¬µì§í•œ ë²•ì´ë‹¤.",
  "í° ë¹›ì„ ë‹¤ ë‚´ì–´ì£¼ê³  ìŠ¤ìŠ¤ë¡œ ëˆ„ëŸ° í™ë¹›ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ì € ë‹¨í˜¸í•¨ì„ ë³´ë¼.",
  "ì‚¬ë‘ë„ ê·¸ì™€ ê°™ì•„ì„œ ëœ¨ê±°ì› ë˜ ë§Œí¼ ì‹ì–´ê°€ëŠ” ì‹œê°„ë„ ì•„ë¦„ë‹¤ì›Œì•¼ í•˜ë¦¬ë‹ˆ.",
  "ë³‘ì›ì— ê°ˆ ì±„ë¹„ë¥¼ í•˜ë©° ì–´ë¨¸ë‹ˆê»˜ì„œ í•œ ë§ì”€ í•˜ì‹ ë‹¤.",
  "í—ˆë¦¬ê°€ ì•„í”„ë‹ˆê¹Œ ì„¸ìƒì´ ë‹¤ ì˜ìë¡œ ë³´ì—¬ì•¼.",
  "ê½ƒë„ ì—´ë§¤ë„ ê·¸ê²Œ ë‹¤ ì˜ìì— ì•‰ì•„ ì‰¬ëŠ” ê²ƒì´ì—¬.",
  "ì‹¸ìš°ì§€ ë§ˆë¼, ë‹¤ë“¤ ì•‰ì„ ìë¦¬ê°€ í•˜ë‚˜ì”©ì€ ìˆëŠ” ë²•ì´ì—¬.",
  "ë‹¤ë¦¬ê°€ ì•„í”„ë©´ ì ì‹œ ì•‰ì•„ ì‰¬ì–´ ê°€ë¼ê³  ì„¸ìƒì´ ë„“ì€ ê²ƒì´ì—¬.",
  "ëª¨ë€ì´ í”¼ê¸°ê¹Œì§€ëŠ” ë‚˜ëŠ” ì•„ì§ ë‚˜ì˜ ë´„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì„ í…Œìš”.",
  "ëª¨ë€ì´ ëšëš ë–¨ì–´ì ¸ ë²„ë¦° ë‚ , ë‚˜ëŠ” ë¹„ë¡œì†Œ ë´„ì„ ì—¬ìœ ì„¤ì›€ì— ì ê¸¸ í…Œìš”.",
  "ì˜¤ì›” ì–´ëŠ ë‚  ê·¸ í•˜ë£¨ ë¬´ë¥ë˜ ë‚ , ë–¨ì–´ì ¸ ëˆ„ìš´ ê½ƒìë§ˆì € ì‹œë“¤ì–´ ë²„ë¦¬ê³ ëŠ” ì²œì§€ì— ëª¨ë€ì€ ìì·¨ë„ ì—†ì–´ì§€ê³ , ë»—ì³ ì˜¤ë¥´ë˜ ë‚´ ë³´ëŒ ì„œìš´ì¼€ ë¬´ë„ˆì¡ŒëŠë‹ˆ, ëª¨ë€ì´ ì§€ê³  ë§ˆë©´ ê·¸ë¿ ë‚´ í•œ í•´ëŠ” ë‹¤ ê°€ê³  ë§ì•„ ì‚¼ë°± ì˜ˆìˆœ ë‚  í•œê²°ê°™ì´ ì„­ì„­í•´ ìš°ì˜µë‚´ë‹¤.",
  "ëª¨ë€ì´ í”¼ê¸°ê¹Œì§€ëŠ” ë‚˜ëŠ” ì•„ì§ ê¸°ë‹¤ë¦¬ê³  ìˆì„ í…Œìš”, ì°¬ë€í•œ ìŠ¬í””ì˜ ë´„ì„.",
  "ì§€ê¸ˆì€ ë‚¨ì˜ ë•…, ë¹¼ì•—ê¸´ ë“¤ì—ë„ ë´„ì€ ì˜¤ëŠ”ê°€?",
  "ë‚˜ëŠ” ì˜¨ëª¸ì— í–‡ì‚´ì„ ë°›ê³  í‘¸ë¥¸ í•˜ëŠ˜ í‘¸ë¥¸ ë“¤ì´ ë§ë¶™ì€ ê³³ìœ¼ë¡œ ê°€ë¥´ë§ˆ ê°™ì€ ë…¼ê¸¸ì„ ë”°ë¼ ê¿ˆì†ì„ ê°€ë“¯ ê±¸ì–´ë§Œ ê°„ë‹¤.",
  "ì…ìˆ ì„ ë‹¤ë¬¸ í•˜ëŠ˜ì•„ ë“¤ì•„, ë‚´ ë§˜ì—ëŠ” ë‚˜ í˜¼ì ì˜¨ ê²ƒ ê°™ì§€ëŠ” ì•Šêµ¬ë‚˜.",
  "ë„¤ê°€ ëŒì—ˆëŠëƒ ëˆ„ê°€ ë¶€ë¥´ë”ëƒ, ë‹µë‹µí•´ë¼ ë§ì„ í•´ ë‹¤ì˜¤.",
  "ë°”ëŒì€ ë‚´ ê·€ì— ì†ì‚­ì´ë©° í•œ ììš±ë„ ì„œì§€ ë§ˆë¼ ì˜·ìë½ì„ í”ë“¤ê³ , ì¢…ë‹¤ë¦¬ëŠ” ìš¸íƒ€ë¦¬ ë„ˆë¨¸ ì•„ì”¨ê°™ì´ êµ¬ë¦„ ë’¤ì—ì„œ ë°˜ê°‘ê²Œ ì›ƒë„¤.",
  "ê³ ë§™ê²Œ ì˜ ìë€ ë³´ë¦¬ë°­ì•„, ê°„ë°¤ ìì • ë„˜ê²¨ ë‚´ë¦¬ë˜ ê³ ìš´ ë¹„ë¡œ ë„ˆëŠ” ì‚¼ë‹¨ ê°™ì€ ë¨¸ë¦¬ë¥¼ ê°ì•˜êµ¬ë‚˜.",
  "ë‚´ ë¨¸ë¦¬ì¡°ì°¨ ê°€ë¿í•˜ë‹¤.",
  "ì§€ê¸ˆ ê·¸ ì‚¬ëŒì˜ ì´ë¦„ì€ ìŠì—ˆì§€ë§Œ ê·¸ì˜ ëˆˆë™ì ì…ìˆ ì€ ë‚´ ê°€ìŠ´ì— ìˆì–´.",
  "ë°”ëŒì´ ë¶ˆê³  ë¹„ê°€ ì˜¬ ë•Œë„ ë‚˜ëŠ” ì € ìœ ë¦¬ì°½ ë°– ê°€ë¡œë“± ê·¸ëŠ˜ì˜ ë°¤ì„ ìŠì§€ ëª»í•˜ì§€.",
  "ì‚¬ë‘ì€ ê°€ê³  ê³¼ê±°ëŠ” ë‚¨ëŠ” ê²ƒ, ì—¬ë¦„ë‚ ì˜ í˜¸ìˆ«ê°€ ê°€ì„ì˜ ê³µì›, ê·¸ ë²¤ì¹˜ ìœ„ì— ë‚˜ë­‡ìì€ ë–¨ì–´ì§€ê³  ë‚˜ë­‡ìì€ í™ì´ ë˜ê³  ë‚˜ë­‡ìì— ë®ì—¬ì„œ ìš°ë¦¬ë“¤ì˜ ì‚¬ë‘ì´ ì‚¬ë¼ì§„ë‹¤ í•´ë„.",
  "ì§€ê¸ˆ ê·¸ ì‚¬ëŒ ì´ë¦„ì€ ìŠì—ˆì§€ë§Œ ê·¸ì˜ ëˆˆë™ì ì…ìˆ ì€ ë‚´ ê°€ìŠ´ì— ìˆì–´ ë‚´ ì„œëŠ˜í•œ ê°€ìŠ´ì— ìˆë„¤.",
  "ê²¨ìš¸ ë‚˜ë¬´ì™€ ë°”ëŒ, ë¨¸ë¦¬í•€ ê½‚ì€ ì˜ˆìœ ì ë“¤ì´ ë¹„ë‘˜ê¸°ì²˜ëŸ¼ ì‚°ì„ ë‚´ë ¤ê°€ë„¤.",
  "ì˜¨ ì„¸ìƒì´ ëˆˆì˜ ì˜·ì„ ì…ì—ˆìœ¼ë‹ˆ, ìš°ë¦¬ë“¤ ì‚¬ë‘í•˜ì§€ ì•Šì„ ìˆ˜ ì—†ë„¤.",
  "ëˆ„êµ¬ì¼ê¹Œ, ì´í† ë¡ ëˆˆë¶€ì‹  ì¹¨ë¬µì„ ë³´ë‚´ëŠ” ì´ëŠ”.",
  "ë§ˆìŒì†ì— ê°€ë“íˆ ì°¬ ê¸°ë„ë¥¼ ì˜¬ë¦¬ê³ , ëˆˆì´ ë…¹ê¸° ì „ì— ë‚´ ì‚¬ë‘ì€ ê·¸ëŒ€ì—ê²Œ ë‹¿ê¸°ë¥¼.",
  "ì•„ì£¼ ì˜¤ëœ ì„¸ì›”ì´ íë¥¸ ë’¤ì— í˜ì—†ëŠ” ì±…ê°ˆí”¼ì™€ ì´ ì¢…ì´ê°€ ë‚˜ë¥¼ ì°¾ì•„ì˜¬ ì¤„ ì•Œì•˜ì§€.",
  "ê·¸ë•Œ ë‚´ ë§ˆìŒì€ ë„ˆë¬´ë‚˜ ë§ì€ ê³µì¥ì„ ì„¸ì› ìœ¼ë‹ˆ, ì–´ë¦¬ì„ê²Œë„ ê·¸í† ë¡ ê¸°ë¡í•  ê²ƒì´ ë§ì•˜êµ¬ë‚˜.",
  "êµ¬ë¦„ ë°‘ì„ ì²œì²œíˆ ê°€ëŠ” ê°œì²˜ëŸ¼ ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ë‚˜ì˜ ì—´ë§ì€, ë‹¨ í•œ ë²ˆë„ ë‚˜ë¥¼ ì‚¬ë‘í•˜ì§€ ì•Šì•˜ë˜ ë‚˜ë¥¼ ì°¾ì•„ ëŒì•„ì˜¨ë‹¤.",
  "ë‚˜ì˜ ìƒì€ ë¯¸ì¹œ ë“¯ì´ ì‚¬ë‘ì„ ì°¾ì•„ í—¤ë§¤ì—ˆìœ¼ë‚˜ ë‹¨ í•œ ë²ˆë„ ìŠ¤ìŠ¤ë¡œë¥¼ ì‚¬ë‘í•˜ì§€ ì•Šì•˜ë…¸ë¼.",
  "ê½ƒê²Œê°€ ê°„ì¥ ì†ì— ë°˜ì¯¤ ëª¸ì„ ë‹´ê·¸ê³  ì—ë“œë ¤ ìˆë‹¤.",
  "ë“±íŒì— ê°„ì¥ì´ ìš¸ì»¥ìš¸ì»¥ ìŸì•„ì§ˆ ë•Œ ê½ƒê²ŒëŠ” ë±ƒì†ì˜ ì•Œì„ ê»´ì•ˆìœ¼ë ¤ê³  ê¿ˆí‹€ê±°ë¦¬ë‹¤ê°€ ë” ë‚®ê²Œ ë” ë°”ë‹¥ ìª½ìœ¼ë¡œ ì›…í¬ë ¸ìœ¼ë¦¬ë¼.",
  "ë²„ë‘¥ê±°ë¦¼ì„ ë©ˆì¶”ê³  ì œ ëª¸ì†ì— ì•Œì„ ë‹¤ì¹˜ì§€ ì•Šê²Œ í•˜ë ¤ê³  ì–´ë‘ ì„ ë°›ì•„ë“¤ì˜€ìœ¼ë¦¬ë¼.",
  "ì•Œë“¤ì•„ ê±±ì • ë§ˆë¼, ì´ì œ ê³§ ê°„ì¥ì´ ë“¤ì–´ì˜¨ë‹¤.",
  "ë¶ˆì„ ë„ê³  ì–´ë‘  ì†ì—ì„œ ì¡°ìš©íˆ ìˆ¨ì„ ì£½ì˜€ìœ¼ë¦¬ë¼.",
  "ëŒë‹´ì— ì†ì‚­ì´ëŠ” í–‡ë°œê°™ì´, í’€ ì•„ë˜ ì›ƒìŒ ì§“ëŠ” ìƒ˜ë¬¼ê°™ì´, ë‚´ ë§ˆìŒ ê³ ìš”íˆ ê³ ìš´ ë´„ ê¸¸ ìœ„ì— ì˜¤ëŠ˜ í•˜ë£¨ í•˜ëŠ˜ì„ ìš°ëŸ¬ë¥´ê³  ì‹¶ë‹¤.",
  "ìƒˆì•…ì‹œ ë³¼ì— ë¶‰ì€ ë¶€ë„ëŸ¼ê°™ì´, ì‹œì˜ ê°€ìŠ´ì— ì‚´í¬ì‹œ ì –ëŠ” ë¬¼ê²°ê°™ì´, ë³´ë“œë ˆí•œ ì—ë¨¸ë„ë“œ ì–‡ê²Œ íë¥´ëŠ” ì‹¤ë¹„ë‹¨ í•˜ëŠ˜ì„ ë°”ë¼ë³´ê³  ì‹¶ë‹¤.",
  "ì‚°ì•„ ì‚°ì•„ í‘¸ë¥¸ ì‚°ì•„, ë„¤ ê°€ìŠ´ì— ë‚˜ë¥¼ ë¬»ì–´ ë‹¤ì˜¤.",
  "ë»ê¾¸ê¸° ë…¸ë˜í•˜ëŠ” êµ¬ë¦„ ì•„ë˜, ê½ƒë“¤ì´ ì›ƒê³  ìƒˆë“¤ì´ ë…¸ë˜í•˜ëŠ” ë„¤ í’ˆì†ìœ¼ë¡œ ë‚˜ë¥¼ ë°›ì•„ ë‹¤ì˜¤.",
  "ë‚´ê°€ ì£½ì–´ í™ì´ ë˜ê³  í’€ì´ ë˜ì–´ë„, ë„ˆì˜ í‘¸ë¥¸ ê·¸ëŠ˜ ì•„ë˜ì„œ ì˜ì›íˆ ì ë“¤ê³  ì‹¶ë‹¤.",
  "íë¥´ëŠ” ê²ƒì´ ë¬¼ë¿ì´ë´.",
  "ìš°ë¦¬ê°€ ì €ë¬¸ ê°•ì°½ì— ì‚½ì„ ì”»ìœ¼ë©° ê±°ê¸° ìŠ¬í””ë„ í¼ë‹¤ ë²„ë¦°ë‹¤.",
  "ì¼ì´ ëë‚˜ ì €ë¬¼ì–´, ìŠ¤ìŠ¤ë¡œ ê¹Šì–´ ê°€ëŠ” ê°•ì„ ë³´ë©° ì­ˆê·¸ë ¤ ì•‰ì•„ ë‹´ë°°ë‚˜ í”¼ìš°ê³  ë‚˜ëŠ” ëŒì•„ê°ˆ ë¿ì´ë‹¤.",
  "ì‚½ìë£¨ì— ë§¡ê¸´ í•œ ìƒì• ê°€ ì´ë ‡ê²Œ ì €ë¬¼ê³  ì €ë¬¼ì–´ì„œ, ìƒ‰ê°• ë°”ë‹¥ ì©ì€ ë¬¼ì— ë‹¬ì´ ëœ¨ëŠ”êµ¬ë‚˜.",
  "ìš°ë¦¬ê°€ ì €ë¬¸ ê°•ì°½ì— ì‚½ì„ ì”»ìœ¼ë©° ë¨¹ì„ ê²ƒ ì—†ëŠ” ì‚¬ëŒë“¤ì˜ ë§ˆì„ë¡œ ë‹¤ì‹œ ì–´ë‘ì›Œ ëŒì•„ê°€ì•¼ í•œë‹¤.",
  "ì™¸ë¡­ê²Œ ì‚´ë‹¤ ì™¸ë¡­ê²Œ ì£½ì„ ë‚´ ì˜í˜¼ì˜ ë¹ˆí„°ì— ìƒˆê°€ í•œ ë§ˆë¦¬ ë‚ ì•„ì™€ ì•‰ëŠ”ë‹¤.",
  "ì´ë¦„ë„ ëª¨ë¥´ëŠ” ì‘ì€ ìƒˆ, ê·¸ ì‘ì€ ë¶€ë¦¬ë¡œ ë‚´ ë§ˆìŒì˜ ìƒì²˜ë¥¼ ìª¼ì•„ ë¨¹ëŠ”ë‹¤.",
  "ì•„í””ë„ ìŠ¬í””ë„ ë‹¤ ê°€ì ¸ê°€ë‹¤ì˜¤.",
  "ê·¸ë¦¬ê³  í•˜ëŠ˜ ë†’ì´ ë‚ ì•„ê°€ ì•„ë¦„ë‹¤ìš´ ë…¸ë˜ë¡œ ì„¸ìƒì„ ì±„ì›Œ ë‹¤ì˜¤.",
  "ë¹„ê°€ ì˜¤ë©´ ë¹„ë¥¼ ë§ê³  ë°”ëŒì´ ë¶ˆë©´ ë°”ëŒì„ ë§ìœ¼ë©°, ìš°ë¦¬ëŠ” ê·¸ë ‡ê²Œ ì„œë¡œì˜ ê³ì„ ì§€í‚¤ëŠ” ë‚˜ë¬´ê°€ ë˜ì.",
  "ì–´ëŠ ë‚  ë¬¸ë“ ë„¤ê°€ ê·¸ë¦¬ì›Œì§€ë©´, ë‚˜ëŠ” ê°€ë§Œíˆ ëˆˆì„ ê°ê³  ë„¤ ì´ë¦„ì„ ë¶ˆëŸ¬ ë³´ë¦¬ë¼.",
  "ì € ë©€ë¦¬ì„œ ë“¤ë ¤ì˜¤ëŠ” ë‚˜ë­‡ì ì†Œë¦¬ê°€ ë„¤ ëŒ€ë‹µì¸ ì–‘ ìƒê°í•˜ë©°, ë‚˜ëŠ” ë‹¤ì‹œ ê¸¸ì„ ë– ë‚˜ë¦¬ë¼.",
  "ì €ë…ì„ ë¨¹ê³  ë‚˜ë©´ í—ˆë¬¼ì—†ì´ ì°¾ì•„ê°€ ì°¨ í•œ ì”ì„ ë§ˆì‹œê³  ì‹¶ë‹¤ê³  ë§í•  ìˆ˜ ìˆëŠ” ì¹œêµ¬ê°€ ìˆì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤.",
  "ì…ì€ ì˜·ì„ ê°ˆì•„ì…ì§€ ì•Šê³  ê¹€ì¹˜ ëƒ„ìƒˆê°€ ë‚˜ë„ í‰ë³´ì§€ ì•Šì„ ê·¸ëŸ° ì¹œêµ¬, ë°¤ëŠ¦ë„ë¡ ì´ì•¼ê¸°ê°€ ëŠì´ì§€ ì•Šì•„ë„ ì§€ë£¨í•˜ì§€ ì•Šì€ ì¹œêµ¬.",
  "ê·¸ëŸ° ì¹œêµ¬ì™€ í•¨ê»˜ë¼ë©´ ì¸ìƒì˜ í—˜í•œ ê¸¸ë„ ë‘ë µì§€ ì•Šìœ¼ë¦¬ë¼.",
  "ë‚˜ëŠ” í•œ ìì˜ ì—¬ìì™€ ì‚´ê³  ì‹¶ë‹¤.",
  "ê°€ì„ì´ë©´ ë‚™ì—½ì´ ë˜ì–´ ë‚´ ê°€ìŠ´ì— ìŒ“ì´ê³ , ë´„ì´ë©´ ìƒˆìˆœì´ ë˜ì–´ ë‚´ í’ˆì—ì„œ ë‹ì•„ë‚˜ëŠ” ê·¸ëŸ° ì—¬ìì™€.",
  "ë°”ëŒì´ ë¶ˆë©´ í”ë“¤ë¦¬ëŠ” ë‚˜ë­‡ìì²˜ëŸ¼ ë‚´ ë§ˆìŒë„ í•¨ê»˜ í”ë“¤ë¦´ ìˆ˜ ìˆëŠ”, íˆ¬ëª…í•˜ê³  ê³ ìš”í•œ ì˜í˜¼ì„ ê°€ì§„ ì—¬ìì™€ ì‚´ê³  ì‹¶ë‹¤.",
  "ë‚´ ê³ í†µì€ ì‘ì•˜ë‹¤.",
  "ê·¸ëŸ¬ë‚˜ ê·¸ ê³ í†µì˜ ëì—ì„œ ë‚˜ëŠ” ë¹„ë¡œì†Œ ì„¸ìƒì„ ë³´ì•˜ë‹¤.",
  "í­í’ìš°ê°€ ì§€ë‚˜ê°„ ë’¤ì˜ í•˜ëŠ˜ì²˜ëŸ¼, ëœ¨ê±°ì› ë˜ ì—¬ë¦„ì´ ê°€ê³  ë‚œ ë’¤ì˜ ë“¤íŒì²˜ëŸ¼, ë‚´ ë§ˆìŒë„ ì´ì œëŠ” í‰ì˜¨ì„ ì°¾ì•˜ë‹¤.",
  "ì“°ëŸ¬ì§„ ë°°ë¡±ë‚˜ë¬´ ê½ƒë“¤ì´ ë‹¤ì‹œ í”¼ì–´ë‚˜ëŠ” ê²ƒì„ ë³´ë©°, ë‚˜ëŠ” ì‚¶ì˜ ëˆì§ˆê¸´ ì•„ë¦„ë‹¤ì›€ì„ ë°°ìš´ë‹¤.",
  "ë‹¹ì‹ ì„ ë³´ë‚´ê³  ëŒì•„ì˜¤ëŠ” ê¸¸ì— ë‚˜ëŠ” ë³´ì•˜ë„¤.",
  "ê¸¸ê°€ì— í•€ ì´ë¦„ ì—†ëŠ” ê½ƒ í•œ ì†¡ì´ê°€ ì–¼ë§ˆë‚˜ ìœ„íƒœë¡­ê²Œ í”ë“¤ë¦¬ê³  ìˆëŠ”ì§€ë¥¼.",
  "ì‚¬ë‘í•œë‹¤ëŠ” ê²ƒì€ ê²°êµ­ ì´ë³„ì„ ì¤€ë¹„í•˜ëŠ” ê³¼ì •ì´ì—ˆìŒì„, ë– ë‚˜ê°€ëŠ” ë‹¹ì‹ ì˜ ë’·ëª¨ìŠµì„ ë³´ë©° ì´ì œì•¼ ê¹¨ë‹«ë„¤.",
  "ìš°ë¦¬ê°€ ëˆˆë°œì´ë¼ë©´ í—ˆê³µì—ì„œ ì­ˆë¹—ì­ˆë¹— í•¨ë°•ëˆˆì´ ë˜ì.",
  "ìš°ë¦¬ê°€ ëˆˆë°œì´ë¼ë©´ ì  ëª» ë“  ì´ì˜ ì°½ê°€ì—ì„œ í¸ì§€ê°€ ë˜ê³  ê·¸ì´ì˜ ê¹Šê³  ë¶‰ì€ ìƒì²˜ ìœ„ì— ë‹ëŠ” ìƒˆì‚´ì´ ë˜ì.",
  "ìš°ë¦¬ê°€ ëˆˆë°œì´ë¼ë©´ ì§„ëˆˆê¹¨ë¹„ëŠ” ë˜ì§€ ë§ì.",
  "ì„¸ìƒì´ ì–´ì§€ëŸ¬ìš¸ìˆ˜ë¡ ìš°ë¦¬ëŠ” ì„œë¡œì˜ ì‹œë¦° ì†ì„ ì¡ì•„ì£¼ëŠ” ë”°ëœ»í•œ í•¨ë°•ëˆˆì´ ë˜ì–´ ë‚´ë¦¬ì.",
  "ë‹¬ì´ ë–´ë‹¤ê³  ì „í™”ë¥¼ ì£¼ì‹œë‹¤ë‹ˆìš” ì´ ë°¤ ë„ˆë¬´ ì‹ ë‚˜ê³  ì•„ë¦„ë‹µìŠµë‹ˆë‹¤.",
  "ë‚´ ë§ˆìŒì—ë„ ìƒì „ ë³´ì§€ ëª»í•œ í™˜í•œ ë‹¬ì´ ë– ì˜¤ë¥´ê³  ë‹¬ë¹›ì´ ì „í™”ë¥¼ íƒ€ê³  í˜ëŸ¬ì™€ ì˜¨ ë°©ì•ˆì„ ê°€ë“ ì±„ì›ë‹ˆë‹¤.",
  "ì„¸ìƒì—, ë‹¹ì‹ ì´ë¼ëŠ” ì‚¬ëŒì´ ìˆë‹¤ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë‚˜ëŠ” ì´ë ‡ê²Œ ë‹¤ì‹œ íƒœì–´ë‚œ ë“¯ í–‰ë³µí•´ì§‘ë‹ˆë‹¤.",
  "ìš´ì£¼ì‚¬ ì™€ë¶ˆë‹˜ì„ ëµ™ê³  ëŒì•„ì˜¤ëŠ” ê¸¸ì— ê·¸ëŒ€ ê°€ìŠ´ì˜ ì²˜ë§ˆ ëì— í’ê²½ì„ ë‹¬ê³  ëŒì•„ì™”ë‹¤.",
  "ë¨¼ ë°ì„œ ë°”ëŒì´ ë¶ˆì–´ì™€ í’ê²½ ì†Œë¦¬ê°€ ë“¤ë¦¬ë©´ ë‚˜ë¥¼ ìƒê°í•´ì£¼ê¸°ë¥¼ ë°”ë¼ëŠ” ë§ˆìŒìœ¼ë¡œ.",
  "ë¹„ë°”ëŒì´ ì¹˜ê³  ëˆˆë³´ë¼ê°€ ì³ë„ ê·¸ëŒ€ ê°€ìŠ´ì†ì— ë§¤ë‹¬ë¦° ë‚´ ë§ˆìŒì€ ë§‘ì€ ì†Œë¦¬ë¥¼ ë‚´ë©° í”ë“¤ë¦¬ê³  ìˆì„ ê²ƒì´ë‹¤.",
  "ê²¬ìš°ì§ë…€ë„ ì´ ë‚ ë§Œì€ ë§Œë‚˜ê²Œ í•˜ëŠ” ì¹ ì„ë‚ , ë‚˜ëŠ” ë‹¹ì‹ ì„ ë•…ì— ë¬»ê³  ëŒì•„ì™”ìŠµë‹ˆë‹¤.",
  "ì‚°ë¨¸ë¦¬ì— ëœ¬ ë³„ì„ ë³´ë©° ë‹¹ì‹ ì´ ìˆëŠ” ê³³ê¹Œì§€ ë‚´ ë§ˆìŒì´ ë‹¿ì„ ìˆ˜ ìˆì„ì§€ ë¬»ê³  ë˜ ë¬¼ì—ˆìŠµë‹ˆë‹¤.",
  "ë‹¹ì‹ ì„ ë³´ë‚´ê³  ëŒì•„ì˜¤ëŠ” ê¸¸ì— ë‚´ ë°œê¸¸ì— ì±„ì´ëŠ” í™ í•œ ì¤Œì¡°ì°¨ ë‹¹ì‹ ì˜ ì‚´ê²°ì¸ ì–‘ ì†Œì¤‘í•˜ì—¬ ì°¨ë§ˆ ë°Ÿì§€ ëª»í–ˆìŠµë‹ˆë‹¤.",
  "ê·¸ë¦¬ìš´ ê·¸ì˜ ì–¼êµ´ ë‹¤ì‹œ ì°¾ì„ ê¸¸ ì—†ì–´ë„ í™”ì‚¬í•œ ê·¸ì˜ ê½ƒ ì‚°ì— ì–¸ë•ì— í”¼ì–´ë‚ ì§€ì–´ì´.",
  "ë´„ì´ ì˜¤ë©´ ë“¤íŒ ê°€ë“ í‘¸ë¥¸ ìˆ¨ê²°ë¡œ ë˜ì‚´ì•„ë‚˜ëŠ” ê·¸ëŒ€ ì´ë¦„ì„ ë‚˜ëŠ” ë‚˜ì§€ë§‰ì´ ë¶ˆëŸ¬ë´…ë‹ˆë‹¤.",
  "ê°€ë²„ë¦° ê²ƒë“¤ì€ ë‹¤ì‹œ ì˜¤ì§€ ì•Šìœ¼ë‚˜ ìš°ë¦¬ë“¤ ê°€ìŠ´ì†ì— í”¼ì–´ë‚œ ê½ƒììœ¼ë¡œ ì˜ì›íˆ ì‹œë“¤ì§€ ì•ŠëŠ” ê·¸ë¦¬ì›€ì´ ë˜ë¦¬ë¼.",
  "ìƒì–´ë²„ë ¸ìŠµë‹ˆë‹¤.",
  "ë¬´ì–¼ ì–´ë””ë‹¤ ìƒì—ˆëŠ”ì§€ ëª°ë¼ ë‘ ì†ì´ ì£¼ë¨¸ë‹ˆë¥¼ ë”ë“¬ì–´ ê¸¸ë¡œ ë‚˜ê°‘ë‹ˆë‹¤.",
  "ëŒê³¼ ëŒ ì‚¬ì´ë¥¼ íë¥´ëŠ” ë¬¼ì†Œë¦¬ì— ê·€ ê¸°ìš¸ì´ë©° ë‚´ ìƒì–´ë²„ë¦° ìì•„ë¥¼ ì°¾ì•„ ëì—†ì´ ê±·ìŠµë‹ˆë‹¤.",
  "ë‚´ê°€ ê±·ëŠ” ì´ ê¸¸ì´ ì•„ì¹¨ì—ì„œ ì €ë…ìœ¼ë¡œ ì €ë…ì—ì„œ ì•„ì¹¨ìœ¼ë¡œ í†µí–ˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.",
  "ë³´ë„ë¸”ë¡ í‹ˆì— ë¿Œë¦¬ ë‚´ë¦° ë¯¼ë“¤ë ˆê°€ ê½ƒì„ í”¼ìš¸ ë•Œ ë‚˜ë¥¼ ë©ˆì¶”ê²Œ í•œë‹¤.",
  "êµ‰ìŒì„ ë‚´ë©° ì§ˆì£¼í•˜ëŠ” ìë™ì°¨ ì‚¬ì´ë¡œ ì—°ì•½í•œ ì´ˆë¡ì´ ê³ ê°œë¥¼ ë“¤ ë•Œ ì„¸ìƒì€ ì ì‹œ ìˆ¨ì„ ì£½ì´ê³  ë‚˜ë¥¼ ëŒì•„ë³´ê²Œ í•œë‹¤.",
  "ë°”ì˜ê²Œ ëŒì•„ê°€ëŠ” ì‹œê³„ ë°”ëŠ˜ì„ ì ì‹œ ë©ˆì¶”ê³  ë‚´ ë°œë°‘ì— ì‚´ì•„ìˆëŠ” ì‘ì€ ìƒëª…ë“¤ì˜ ì†ì‚­ì„ì— ê·€ë¥¼ ê¸°ìš¸ì¸ë‹¤.",
  "ê·€ëšœë¼ë¯¸ì™€ ë‚˜ì™€ ì”ë””ë°­ì—ì„œ ì´ì•¼ê¸°í–ˆë‹¤.",
  "ê·€ëš¤ê·€ëš¤ ê·€ëš¤ê·€ëš¤ ì•„ë¬´ì—ê²Œë„ ì•ˆ ë“¤í‚¤ê²Œ ì´ì•¼ê¸°í–ˆë‹¤.",
  "ë‹¬ë¹›ì´ ì†Œë¦¬ ì—†ì´ ë‚´ë ¤ì•‰ëŠ” ë°¤, ìš°ë¦¬ëŠ” ì‘ì€ ì¡´ì¬ë“¤ì˜ ìŠ¬í””ì— ëŒ€í•´ ì†ì‚­ì˜€ë‹¤.",
  "ë†’ì€ í•˜ëŠ˜ì— ë–  ìˆëŠ” ë³„ë“¤ë„ ìš°ë¦¬ì˜ ë‚®ì€ ëª©ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë ¤ëŠ”ì§€ ë°˜ì§ì´ë©° ìˆ¨ì„ ì£½ì˜€ë‹¤.",
  "ìš°ë¦¬ë“¤ì˜ ì‚¬ë‘ë„ ì´ë ‡ê²Œ ê¹Šì–´ ê°€ë©´ ì¢‹ê² ë„¤.",
  "ì–¼ìŒì¥ ë°‘ìœ¼ë¡œ ì†Œë¦¬ ì£½ì—¬ íë¥´ëŠ” ë¬¼ì†Œë¦¬ì²˜ëŸ¼, ê²‰ìœ¼ë¡œëŠ” ì°¨ê°€ì›Œ ë³´ì—¬ë„ ì†ìœ¼ë¡œëŠ” ë”°ëœ»í•œ ì˜¨ê¸°ë¥¼ í’ˆê³  íë¥´ëŠ” ì € ê²¨ìš¸ ê°•ë¬¼ì²˜ëŸ¼.",
  "ëˆˆ ë‚´ë¦¬ëŠ” ë°¤, ê°•ê°€ì— ì„œì„œ ìš°ë¦¬ê°€ í•¨ê»˜ ê°ˆ ê¹Šê³  í‘¸ë¥¸ ë‚´ì¼ì„ ê¿ˆê¾¸ì–´ ë³¸ë‹¤.",
  "ì˜¤ëŠ˜ ì €ë… ì´ ì¢ë‹¤ë€ ë°©ì˜ í° ë°”ëŒë²½ì— ì–´ì©ì§€ ì“¸ì“¸í•œ ê²ƒë“¤ì´ ì˜¤ê³  ê°„ë‹¤.",
  "ì´ í° ë°”ëŒë²½ì— í¬ë¯¸í•œ ì‹­ì˜¤ì´‰ ì „ë“±ì´ ì§€ì¹œ ì–¼êµ´ì„ ë¹„ì¶”ê³ , ë‚˜ëŠ” ë‚´ ê°€ë‚œí•œ ì‚¬ë‘ê³¼ ê³ ë…ì„ ì½ëŠ”ë‹¤.",
  "í•˜ëŠ˜ì´ ì´ ì„¸ìƒì„ ë‚´ì¼ ì ì— ê·¸ê°€ ê°€ì¥ ê·€í•´í•˜ê³  ì‚¬ë‘í•˜ëŠ” ê²ƒë“¤ì€ ëª¨ë‘ ê°€ë‚œí•˜ê³  ì™¸ë¡­ê³  ë†’ê³  ì“¸ì“¸í•˜ë‹ˆ ì‚´ì•„ê°€ë„ë¡ ë§Œë“¤ì—ˆë‹¤ëŠ” ê²ƒì„ ìƒê°í•œë‹¤.",
  "ëˆˆì´ ë§ì´ ì™€ì„œ ì‚°ê³ ë‘ ì™¸ë”´ì§‘ì— ëˆˆì´ ìŒ“ì´ëŠ” ë°¤, í‰ì•ˆë„ ì–´ëŠ ë§ˆì„ì—ëŠ” êµ­ìˆ˜ë¥¼ ëˆ„ë¥´ëŠ” ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤.",
  "íˆ¬ë°•í•˜ê³  ì •ê²¨ìš´ ìš°ë¦¬ë„¤ ì‚¶ì˜ ëƒ„ìƒˆê°€ ë¬¼ì”¬ í’ê¸°ëŠ” ê·¸ ë”°ëœ»í•œ í•œ ê·¸ë¦‡ì˜ ìœ„ë¡œë¥¼ ìƒê°í•œë‹¤.",
  "ë§ˆì„ ì‚¬ëŒë“¤ì´ ì˜¹ê¸°ì¢…ê¸° ëª¨ì—¬ ì•‰ì•„ ì‹œì‹œì½œì½œí•œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©° ë‚˜ëˆ  ë¨¹ë˜ ê·¸ êµ¬ìˆ˜í•œ êµ­ìˆ˜ í•œ ì‚¬ë°œì´ ê·¸ë¦½ë‹¤.",
  "ë‚˜ëŠ” ì´ì œ ë„ˆì—ê²Œë„ ìŠ¬í””ì„ ì£¼ê² ë‹¤.",
  "ì‚¬ë‘ë³´ë‹¤ ì†Œì¤‘í•œ ìŠ¬í””ì„ ì£¼ê² ë‹¤.",
  "ì¶”ìœ„ì— ë–¨ê³  ìˆëŠ” ì‚¬ëŒë“¤ì—ê²Œ ëˆˆ ëŒ€ì‹  ë³´ë¦¬ì°¨ í•œ ì”ì˜ ì˜¨ê¸°ë¥¼ ê±´ë„¬ ìˆ˜ ìˆëŠ” ê·¸ëŸ° ë§ˆìŒì˜ ê¹Šì´ë¥¼ ì£¼ê³  ì‹¶ë‹¤.",
  "ë‚¨ì˜ ëˆˆë¬¼ì„ ë‹¦ì•„ì£¼ê¸° ì „ì— ë‚´ ëˆˆë¬¼ì˜ ì˜ë¯¸ë¥¼ ë¨¼ì € ì•„ëŠ” ì‚¬ëŒì´ ë˜ê¸°ë¥¼ ë°”ë€ë‹¤.",
  "ì‚°ê·¸ëŠ˜ ë‚´ë¦° ë°­ê°€ì— ì•‰ì•„ ì°¸ê¹¨ë¥¼ í„¸ëŠ”ë‹¤.",
  "ë³´ë“œë¼ìš´ ì†ê¸¸ë¡œ í†¡í†¡ ê±´ë“œë ¤ë„ ì°¸ê¹¨ëŠ” ìŸì•„ì§€ëŠ”ë°, ì„¸ìƒì„ ë„ˆë¬´ ì„œë‘ë¥´ë©° ì‚´ì•„ì˜¨ ê²ƒì€ ì•„ë‹Œì§€ ë¬¸ë“ ë’¤ë¥¼ ëŒì•„ë³´ê²Œ ëœë‹¤.",
  "í•œ ë²ˆì˜ íœ˜ë‘ë¦„ìœ¼ë¡œ ëª¨ë“  ê²ƒì„ ì–»ìœ¼ë ¤ í–ˆë˜ ë‚´ ìš•ì‹¬ì´ ë¶€ë„ëŸ¬ì›Œ ì°¸ê¹¨ ì†¡ì´ ì•ì—ì„œ ê³ ê°œë¥¼ ìˆ™ì¸ë‹¤.",
  "ìš°ë¦¬ ì§‘ ë¨¸ìŠ´ ëŒ€ê¸¸ì´ëŠ” ë‚˜ë¥¼ ì—…ê³  í•™êµì— ë°ë ¤ë‹¤ì£¼ê³¤ í–ˆë‹¤.",
  "ì„¸ìƒì—ì„œ ê°€ì¥ ë‚®ì€ ê³³ì— ì‚´ë©´ì„œë„ ì„¸ìƒì—ì„œ ê°€ì¥ í™˜í•œ ì›ƒìŒì„ ì§€ì—ˆë˜ ê·¸ ì‚¬ëŒì˜ ë§ˆìŒì´ ë‚´ ìœ ë…„ì˜ ë¹›ì´ì—ˆë‹¤.",
  "ì´ì œëŠ” ì „ì„¤ì´ ë˜ì–´ë²„ë¦° ê·¸ì˜ ë’·ëª¨ìŠµì„ ìƒê°í•˜ë©° ë‚˜ëŠ” ì‚¬ëŒì„ ì‚¬ë‘í•˜ëŠ” ë²•ì„ ë‹¤ì‹œ ë°°ìš´ë‹¤.",
  "ê°€ì„ ë°”ë‹¤ëŠ” ë‚´ê²Œ ì™€ì„œ ìŠí˜€ì§„ ì•½ì†ì„ ë¬»ëŠ”ë‹¤.",
  "í•˜ì–—ê²Œ ë¶€ì„œì§€ëŠ” íŒŒë„ ì†ì— ë‚´ê°€ ë‘ê³  ì˜¨ ê¿ˆë“¤ì´ ìˆì—ˆëŠëƒê³ , ì´ì œëŠ” ëŒì•„ê°€ì•¼ í•  ì‹œê°„ì´ ì•„ë‹ˆëƒê³  í‘¸ë¥¸ ëª©ì†Œë¦¬ë¡œ ì†ì‚­ì¸ë‹¤.",
  "ìˆ˜í‰ì„  ë„ˆë¨¸ë¡œ ì €ë¬¼ì–´ê°€ëŠ” ë…¸ì„ì„ ë³´ë©° ë‚˜ëŠ” ëŒ€ë‹µ ëŒ€ì‹  ê¹Šì€ ì¹¨ë¬µ í•˜ë‚˜ë¥¼ ë°”ë‹¤ì— ë˜ì§„ë‹¤."
];


function injectRaceSymbols_(s, diff, seedKey){
  // âœ… PATCH(v14): 'ê¹¨ì§„ ê¸°í˜¸' ì£¼ì… ì œê±°. ë‚œì´ë„ëŠ” ì†ë„/ì œí•œì‹œê°„/ì—„ê²©ëª¨ë“œë¡œë§Œ ì¡°ì ˆ.
  return String(s||'').replace(/\s{2,}/g,' ').trim();
}

function buildRacePool_(diff){
  // diff: low/mid/high
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';

  const base = Array.isArray(SHARED_SENTENCES_) ? SHARED_SENTENCES_ : [];
  const low = [], mid = [], high = [];

  for (let i=0;i<base.length;i++){
    const raw = String(base[i]||'').trim();
    const n = raceNormalize_(raw);
    if (!n) continue;
    const L = n.length;

    if (L <= 18) low.push(n);
    else if (L <= 38) mid.push(n);
    else high.push(n);
  }

  // ë²„í‚·ì´ ëª¨ìë¼ë©´ ìœ ì—°í•˜ê²Œ ë³´ê°•
  const sortByLen = (a,b)=> a.length - b.length;
  low.sort(sortByLen);
  mid.sort(sortByLen);
  high.sort(sortByLen);

  const needMin = 240; // ë‚´ë¶€ì—ì„œ 240ê°œ ìºì‹œ
  const fillFrom = (dst, src, maxLen)=>{
    for (let i=0;i<src.length && dst.length < maxLen;i++) dst.push(src[i]);
  };

  if (low.length < 220) fillFrom(low, mid, 260);
  if (mid.length < 220) {
    // ì¤‘ ë‚œì´ë„ëŠ” ë„ˆë¬´ ì§§ì€ ë¬¸ì¥ë§Œ ëª°ë¦¬ì§€ ì•Šê²Œ, low+high ì„ì–´ì„œ ë³´ê°•
    fillFrom(mid, low.slice().reverse(), 260);
    fillFrom(mid, high, 260);
  }
  if (high.length < 220) {
    // ìƒ ë‚œì´ë„ëŠ” ê¸´ ë¬¸ì¥ ìš°ì„ , ë¶€ì¡±í•˜ë©´ midì˜ ê¸´ ê²ƒë“¤ë¡œ ë³´ê°•
    fillFrom(high, mid.slice().reverse(), 280);
  }

  let bucket = (d === 'high') ? high : (d === 'mid') ? mid : low;

  // ë‚œì´ë„ë³„ ê¸°í˜¸ ì„ê¸°
  const out = [];
  for (let i=0;i<bucket.length;i++){
    const s = bucket[i];
    const key = `${sessionId||'noSession'}|${d}|SYM|${i}|${s}`;
    const mixed = injectRaceSymbols_(s, d, key);
    const norm = raceNormalize_(mixed);
    if (!norm) continue;
    out.push(norm);
  }

  // ì…”í”Œ(ì„¸ì…˜+ë‚œì´ë„ ê³ ì • ì‹œë“œ)
  const seed = hash32_(`${sessionId||'noSession'}|${d}|POOL_SHARED`);
  const rng = mulberry32_(seed);
  shuffleWithRng_(out, rng);

  // ì ë‹¹íˆ ìƒí•œ
  return out.slice(0, needMin);
}


function getRacePool_(diff){
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  if (_racePoolCache_[d] && Array.isArray(_racePoolCache_[d]) && _racePoolCache_[d].length >= 200){
    return _racePoolCache_[d];
  }
  _racePoolCache_[d] = buildRacePool_(d);
  return _racePoolCache_[d];
}

function buildRaceSet_(diff, count, salt){
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  const pool = (getRacePool_(d) || []).slice();
  const seed = hash32_(`${sessionId||'noSession'}|${d}|${salt||Date.now()}`);
  const rng = mulberry32_(seed);
  shuffleWithRng_(pool, rng);
  const out = [];
  const used = new Set();
  for (let i=0; i<pool.length && out.length < count; i++){
    const s = raceNormalize_(String(pool[i]||'')).trim();
    if (!s || used.has(s)) continue;
    used.add(s);
    out.push(s);
  }
  return out;
}

function raceDiffLabel_(d){
  return (d === 'high') ? 'ìƒ' : (d === 'mid') ? 'ì¤‘' : 'í•˜';
}

function raceNormalize_(s){
  const m = String(s || '').match(RACE_ALLOWED_RE_);
  return m ? m.join('') : '';
}

function racePrefixLen_(target, typed){
  const a = String(target || '');
  const b = String(typed || '');
  const n = Math.min(a.length, b.length);
  let i = 0;
  for (; i < n; i++){
    if (a[i] !== b[i]) break;
  }
  return i;
}


function raceEscape_(s){
  return escapeHtml(String(s||''))
    .replace(/\n/g,'<br/>');
}

// âœ… ì…ë ¥/ì •ë‹µ ë¹„êµë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸° (í‹€ë¦° ê³³ ë¹¨ê°›ê²Œ + ìˆ˜ì • íŒíŠ¸)
function updateRaceDiffView_(targetRaw, typedRaw){
  const box = $('raceDiffView');
  const hint = $('raceHint');
  if (!box) return;

  const target = raceNormalize_(targetRaw);
  const typed  = raceNormalize_(typedRaw);

  const first = racePrefixLen_(target, typed);
  const okPrefix = target.slice(0, first);
  const expChar = (first < target.length) ? target[first] : '';
  const gotChar = (first < typed.length) ? typed[first] : '';

  const restTarget = (first < target.length) ? target.slice(first+1) : '';
  const restTyped  = (first < typed.length) ? typed.slice(first+1) : '';

  const tHtml = [
    `<span class="ok">${raceEscape_(okPrefix)}</span>`,
    (expChar ? `<span class="${(first < typed.length && gotChar!==expChar) ? 'bad' : 'miss'}">${raceEscape_(expChar)}</span>` : ''),
    `<span>${raceEscape_(restTarget)}</span>`
  ].join('');

  const uHtml = [
    `<span class="ok">${raceEscape_(typed.slice(0, first))}</span>`,
    (first < typed.length ? `<span class="${(first < target.length && gotChar!==expChar) ? 'bad' : 'bad'}">${raceEscape_(gotChar)}</span>` : ''),
    `<span>${raceEscape_(restTyped)}</span>`
  ].join('');

  box.innerHTML = `
    <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
      <div style="min-width:64px; opacity:.8; font-weight:1000;">ëª©í‘œ</div>
      <div style="flex:1; word-break:break-word;">${tHtml || '<span style="opacity:.6;">(ë¬¸êµ¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘)</span>'}</div>
    </div>
    <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; margin-top:8px;">
      <div style="min-width:64px; opacity:.8; font-weight:1000;">ì…ë ¥</div>
      <div style="flex:1; word-break:break-word;">${uHtml || '<span style="opacity:.6;">(ì…ë ¥ ëŒ€ê¸°)</span>'}</div>
    </div>
  `;

  if (!hint) return;

  // hint
  let msg = '';
  if (!typed){
    msg = '';
  }else if (typed === target){
    msg = '';
  }else if (typed.length > target.length && typed.startsWith(target)){
    const extra = typed.slice(target.length);
    msg = `ì´ˆê³¼ ì…ë ¥! ë’¤ì˜ â€œ${extra}â€ ë¥¼ ì§€ì›Œ ì£¼ì„¸ìš”.`;
  }else if (first < target.length){
    if (first >= typed.length){
      msg = `ëˆ„ë½! ${first+1}ë²ˆì§¸ ê¸€ì â€œ${expChar}â€ ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.`;
    }else{
      msg = `ì˜¤íƒ€! ${first+1}ë²ˆì§¸ ê¸€ì: â€œ${gotChar}â€ â†’ â€œ${expChar}â€ ë¡œ ê³ ì³ ì£¼ì„¸ìš”.`;
    }
  }else{
    msg = `ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ë‚¨ì€ ë¬¸êµ¬ë¥¼ ì´ì–´ì„œ ì…ë ¥í•´ ì£¼ì„¸ìš”.`;
  }

  if (msg){
    hint.textContent = msg;
    hint.classList.add('show');
  }else{
    hint.textContent = '';
    hint.classList.remove('show');
  }
}

function renderRaceBar_(){
  const bar = $('raceBar');
  const input = $('raceInput');
  const txtEl = $('raceText');
  const diffEl = $('raceDiff');
  const rankEl = $('raceRank');
  const scoreEl = $('raceScore');
  const progEl = $('raceProgBar');
  const stepsEl = $('raceSteps');
  const trackEl = $('raceMiniTrack');

  if (!bar || !input || !txtEl || !diffEl || !rankEl || !scoreEl || !progEl) return;

  const cur = raceCur_;
  if (!cur || !cur.id || cur.status !== 'running'){
    bar.classList.remove('show');
    bar.setAttribute('aria-hidden','true');
    input.disabled = true;
    input.value = '';
    try{ $('raceDiffView') && ($('raceDiffView').innerHTML=''); }catch(e){}
    try{ $('raceHint') && ($('raceHint').textContent=''); $('raceHint') && $('raceHint').classList.remove('show'); }catch(e){}
    progEl.style.width = '0%';
    rankEl.textContent = 'â€”';
    scoreEl.innerHTML = '';
    if (stepsEl) stepsEl.innerHTML = '';
    try{ if (trackEl) trackEl.innerHTML = ''; }catch(e){}
    stopRaceTimer_();
    raceLocalEnabled_ = false;
    return;
  }

  bar.classList.add('show');
  bar.setAttribute('aria-hidden','false');

  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];
  const uid = myUid_();
  const me = (uid && racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;
  const myMis = Number(me.mistakes || 0) || 0;
  const myIdx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[myIdx] || texts[0] || '');

  diffEl.textContent = `ğŸ ${Math.min(myDone+1, total)}/${total} Â· ë‚œì´ë„ ${raceDiffLabel_(cur.difficulty)}`;
  txtEl.textContent = target;
  input.disabled = false;

  // reset input when race id changed
  if (input.dataset.raceId !== String(cur.id)){
    input.dataset.raceId = String(cur.id);
    input.value = '';
    progEl.style.width = '0%';
    rankEl.textContent = 'â€”';
    raceLastProg_ = -1;
    try{ input.focus(); }catch(e){}
  }

  // Steps UI (my progress)
  if (stepsEl){
    let h = '<span class="stepFlag">ğŸš©</span>';
    for (let i=0;i<total;i++){
      const cls = (i < myDone) ? 'stepDot done' : (i === myDone ? 'stepDot active' : 'stepDot');
      h += `<span class="${cls}"></span>`;
    }
    h += '<span class="stepFlag">ğŸ</span>';
    stepsEl.innerHTML = h;
  }

  // scoreboard
  const items = [];
  const now = Date.now();
  const players = racePlayers_ || {};
  for (const puid of Object.keys(players)){
    const p = players[puid] || {};
    const nm = String(p.name || 'ìµëª…').trim().slice(0,12);
    const doneCount = Number(p.doneCount || p.idx || 0) || 0;
    const prog = Number(p.p || 0) || 0;
    const done = !!p.done;
    const eliminated = !!p.eliminated;
    const mis = Number(p.mistakes || 0) || 0;
    const timeMs = Number(p.timeMs || 0) || 0;
    const ts = Number(p.ts || 0);
    if (ts && (now - ts) > 180000) continue; // stale 3m
    items.push({ uid: puid, nm, doneCount, prog, done, eliminated, mis, timeMs });
  }

  items.sort((a,b)=>{
    const aPerfect = a.done && a.mis === 0;
    const bPerfect = b.done && b.mis === 0;
    if (aPerfect && bPerfect) return a.timeMs - b.timeMs;
    if (aPerfect) return -1;
    if (bPerfect) return 1;
    if (a.doneCount !== b.doneCount) return b.doneCount - a.doneCount;
    if (a.prog !== b.prog) return b.prog - a.prog;
    if (a.mis !== b.mis) return a.mis - b.mis;
    return a.nm.localeCompare(b.nm);
  });

  // my rank
  if (uid){
    const r = items.findIndex(x=> x.uid === uid);
    rankEl.textContent = (r >= 0) ? `#${r+1}` : 'â€”';
  }else{
    rankEl.textContent = 'â€”';
  }

  // mini track (top 5)
  try{
    if (trackEl){
      const top = items.slice(0,5);
      let h = '';
      for (let i=0;i<top.length;i++){
        const it = top[i];
        const idx = Math.max(0, Math.min(total-1, Number(it.doneCount||0)));
        const t = String(texts[idx] || texts[texts.length-1] || '');
        const L = Math.max(1, t.length);
        const p = Math.max(0, Math.min(L, Number(it.prog||0)));
        let pct = it.done ? 100 : (((idx / total) + ((p / L) / total)) * 100);
        pct = Math.max(0, Math.min(100, pct));
        const icon = it.done ? 'ğŸ' : (it.eliminated ? 'ğŸ’¥' : (i===0 ? 'ğŸï¸' : i===1 ? 'ğŸš—' : i===2 ? 'ğŸš™' : 'ğŸš˜'));
        const medalCls = (i===0?'medal1':i===1?'medal2':i===2?'medal3':'');
        h += `<div class="raceLane"><div class="raceNamePill">${escapeHtml(it.nm)}</div><div class="raceCar ${medalCls}" style="left:${pct.toFixed(1)}%">${icon}</div></div>`;
      }
      trackEl.innerHTML = h;
    }
  }catch(e){}

  // UI
  scoreEl.innerHTML = '';
  const hint = document.createElement('div');
  hint.className = 'raceHintLine';
  const myStateText = raceMeElim_ ? 'ğŸš« íƒˆë½(ì˜¤íƒ€)' : `ë‚´ ì‹¤ìˆ˜: ${myMis}íšŒ`;
  hint.innerHTML = `<span>Enter=ì œì¶œ Â· <b>ë¬´ì‹¤ìˆ˜ 10ë¬¸ì¥</b> ìš°ìŠ¹</span><span class="${(raceMeElim_||myMis>0)?'bad':''}">${myStateText}</span>`;
  scoreEl.appendChild(hint);

  items.slice(0,8).forEach((it)=>{
    const chip = document.createElement('div');
    chip.className = 'raceChip';
    const doneText = it.done ? ` Â· ${(it.timeMs/1000).toFixed(2)}s` : '';
    chip.innerHTML = `
      <div class="top"><span>${escapeHtml(it.nm)}</span><span class="sub">${it.doneCount}/${total}${doneText}</span></div>
      <div class="sub">ì˜¤íƒ€ ${it.mis} Â· ì§„í–‰ ${it.prog}</div>
    `;
    scoreEl.appendChild(chip);
  });

  startRaceTimer_();
  bindRaceInput_();
  raceLocalEnabled_ = true;

  try{
    if (document.activeElement !== input) input.focus();
  }catch(e){}
}


async function celebrateRaceEnd_(){
  try{
    const cur = raceCur_;
    if (!cur || !cur.id) return;
    const rid = String(cur.id);
    if (raceCelebratedId_ === rid) return;
    raceCelebratedId_ = rid;

    const items = [];
    const players = racePlayers_ || {};
    for (const puid of Object.keys(players)){
      const p = players[puid] || {};
      const nm = String(p.name || 'ìµëª…').trim().slice(0,12);
      const done = !!p.done;
      const mis = Number(p.mistakes || 0) || 0;
      const timeMs = Number(p.timeMs || 0) || 0;
      const doneCount = Number(p.doneCount || p.idx || 0) || 0;
      const prog = Number(p.p || 0) || 0;
      items.push({ nm, done, mis, timeMs, doneCount, prog });
    }

    items.sort((a,b)=>{
      const aPerfect = a.done && a.mis === 0;
      const bPerfect = b.done && b.mis === 0;
      if (aPerfect && bPerfect) return a.timeMs - b.timeMs;
      if (aPerfect) return -1;
      if (bPerfect) return 1;
      if (a.doneCount !== b.doneCount) return b.doneCount - a.doneCount;
      if (a.prog !== b.prog) return b.prog - a.prog;
      if (a.mis !== b.mis) return a.mis - b.mis;
      return a.nm.localeCompare(b.nm);
    });

    const podium = items.filter(it=> it.done && it.mis===0).slice(0,3);
    // ğŸ¥ˆğŸ¥‰ì—ê²Œë„ ì‘ì€ ì¶•í•˜(ë°© ì „ì²´ì— 1íšŒë§Œ)
    for (let i=1;i<Math.min(3, podium.length);i++){
      const by = podium[i].nm;
      try{ await pushEvent_({ type:'event', event:'fx2', kind:'confetti', by, ts: Date.now() }); }catch(e){}
    }
  }catch(e){}
}

function initTypingRace_(roomId){
  try{
    // current
    const curRef = window.FB.ref(window.FB.db, fbRaceCurrentPath_(roomId));
    if (raceCurUnsub_) raceCurUnsub_();
    raceCurUnsub_ = window.FB.onValue(curRef, (snap)=>{
      raceCur_ = snap.exists() ? (snap.val() || null) : null;
      const nid = String(raceCur_?.id || '');
      const nst = String(raceCur_?.status || '');
      // status transition: running -> ended
      try{
        if (racePrevId_ && (racePrevId_ === nid) && racePrevStatus_ === 'running' && nst === 'ended'){
          celebrateRaceEnd_();
        }
      }catch(e){}
      racePrevId_ = nid;
      racePrevStatus_ = nst;
      renderRaceBar_();
    });

    // players
    const plRef = window.FB.ref(window.FB.db, fbRacePlayersPath_(roomId));
    if (racePlayersUnsub_) racePlayersUnsub_();
    racePlayersUnsub_ = window.FB.onValue(plRef, (snap)=>{
      racePlayers_ = snap.exists() ? (snap.val() || {}) : {};
      renderRaceBar_();
    });

    bindRaceInput_();
  }catch(e){
    console.warn('initTypingRace failed', e);
  }
}

function startRaceTimer_(){
  if (raceTick_) return;
  let timeoutSent_ = false;

  raceTick_ = setInterval(()=> {
    const t = $('raceTimer');
    const cur = raceCur_;
    if (!t || !cur || cur.status !== 'running' || !cur.startedAt){
      stopRaceTimer_();
      return;
    }

    const endsAt = Number(cur.endsAt || 0) || (Number(cur.startedAt) + RACE_LIMIT_MS_);
    const remainMs = Math.max(0, endsAt - Date.now());
    const remainSec = remainMs / 1000;

    t.textContent = `${remainSec.toFixed(1)}s`;

    // â±ï¸ time over â†’ winner ì—†ìœ¼ë©´ ì¢…ë£Œ ì²˜ë¦¬(í•œ ë²ˆë§Œ)
    if (remainMs <= 0 && !timeoutSent_){
      timeoutSent_ = true;
      (async ()=>{
        try{
          await window.FB.ensureAnonAuth();
          const root = window.FB.ref(window.FB.db, fbRacePath_(sessionId) + '/current');
          await window.FB.runTransaction(root, (cur2)=>{
            if (!cur2) return cur2;
            if (cur2.status !== 'running') return cur2;
            if (cur2.winnerUid) return cur2;
            cur2.status = 'ended';
            cur2.endedReason = 'timeout';
            cur2.endedAt = Date.now();
            return cur2;
          });
          await pushSystem_(`â±ï¸ íƒ€ì´í•‘ ë ˆì´ìŠ¤ ì‹œê°„ ì¢…ë£Œ! (120ì´ˆ) â€” ì´ë²ˆ íŒì€ ìš°ìŠ¹ìê°€ ì—†ì–´ìš”.`);
        }catch(e){}
      })();
    }
  }, 120);
}
function stopRaceTimer_(){
  try{ if (raceTick_) clearInterval(raceTick_); }catch(e){}
  raceTick_ = null;
}

function bindRaceInput_(){
  const el = $('raceInput');
  if (!el || el.__raceBound) return;
  el.__raceBound = true;

  el.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      submitRaceLine_();
    }
  });

  el.addEventListener('input', ()=> onRaceInput_());
}

async function submitRaceLine_(){
  if (!sessionId || !raceCur_ || raceCur_.status !== 'running') return;
  const el = $('raceInput');
  if (!el) return;

  const cur = raceCur_;
  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];

  const uid = myUid_();
  if (!uid) return;

  const me = (racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;
  const myMis = Number(me.mistakes || 0) || 0;

  const idx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[idx] || '');
  const typed = String(el.value || '');

  // âœ… ë¹„êµ ì‹œ ì´ëª¨ì§€(í—ˆìš© ì œì™¸) ìë™ ë¬´ì‹œ
  const targetN = raceNormalize_(target);
  const typedN  = raceNormalize_(typed);

  // Require exact match on submit (normalized)
  if (typedN !== targetN){
    try{
      el.classList.add('shake');
      setTimeout(()=> el.classList.remove('shake'), 320);
    }catch(e){}

    try{
      await window.FB.ensureAnonAuth();
      const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
      const nm = myName().slice(0,12) || 'ìµëª…';
      await window.FB.runTransaction(pRef, (p)=>{
        p = p || {};
        const mis = Number(p.mistakes||0) + 1;
        return Object.assign({}, p, {
          name: nm,
          idx: Number(p.idx||0),
          doneCount: Number(p.doneCount||0),
          p: Number(p.p||0),
          mistakes: mis,
          done: !!p.done,
          ts: Date.now()
        });
      });
    }catch(e){}
    return;
  }

  // Correct: advance sentence
  const nextDone = idx + 1;
  const now = Date.now();
  const doneAll = nextDone >= total;
  const timeMs = Math.max(0, now - Number(cur.startedAt || now));

  try{
    await window.FB.ensureAnonAuth();
    const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
    const nm = myName().slice(0,12) || 'ìµëª…';

    await window.FB.runTransaction(pRef, (p)=>{
      p = p || {};
      const mis = Number(p.mistakes||0);
      return Object.assign({}, p, {
        name: nm,
        idx: nextDone,
        doneCount: nextDone,
        p: 0,
        mistakes: mis,
        done: doneAll,
        finishedAt: doneAll ? now : (p.finishedAt||0),
        timeMs: doneAll ? timeMs : (p.timeMs||0),
        ts: now
      });
    });

    el.value = '';
    raceLastProg_ = -1;
    const progEl = $('raceProgBar');
    if (progEl) progEl.style.width = '0%';

    if (doneAll){
      if (myMis === 0){
        await trySetWinner_(uid, nm, timeMs);
      }else{
        await pushSystem_(`ğŸ ${nm}ë‹˜ ì™„ì£¼! (10ë¬¸ì¥, ì‹¤ìˆ˜ ${myMis}íšŒ, ${(timeMs/1000).toFixed(2)}s)`);
      }
    }
  }catch(e){}
}


async function raceEliminate_(reason){
  try{
    if (!raceCur_ || !raceCur_.id) return;
    raceMeElim_ = true;

    const inp = $('raceInput');
    if (inp){
      inp.disabled = true;
      inp.classList.add('eliminated');
    }
    const bar = $('raceBar');
    if (bar){
      bar.classList.add('eliminated');
      setTimeout(()=>{ try{ bar.classList.remove('eliminated'); }catch(e){} }, 360);
    }

    // ë‚´ ìƒíƒœ ê³µìœ (ë‹¤ë¥¸ ì‚¬ëŒ íŠ¸ë™/ìˆœìœ„ í‘œì‹œìš©)
    try{
      const uid = myUid_();
      if (uid){
        const pRef = window.FB.ref(window.FB.db, fbRacePlayerPath_(sessionId, raceCur_.id, uid));
        await window.FB.update(pRef, { eliminated:true, elimReason:String(reason||'typo'), elimAt: Date.now() });
      }
    }catch(e){}

    // ë¡œì»¬ ì•ˆë‚´(ë°© ì „ì²´ ìŠ¤íŒ¸ ë°©ì§€)
    try{
      const box = $('raceScore');
      if (box) box.textContent = 'ğŸš« ì˜¤íƒ€! íƒˆë½(ì…ë ¥ ì ê¸ˆ)';
    }catch(e){}
  }catch(e){}
}

async function onRaceInput_(){
  if (!sessionId || !raceCur_ || raceCur_.status !== 'running') return;
  const el = $('raceInput');
  if (!el) return;

  const cur = raceCur_;
  const total = Number(cur.total || 10) || 10;
  const texts = Array.isArray(cur.texts) ? cur.texts : [];

  const uid = myUid_();
  const me = (uid && racePlayers_ && racePlayers_[uid]) ? (racePlayers_[uid] || {}) : {};
  const myDone = Number(me.doneCount || me.idx || 0) || 0;

  const idx = Math.max(0, Math.min(myDone, total-1));
  const target = String(texts[idx] || '');
  const typed = String(el.value || '');

  const prog = racePrefixLen_(raceNormalize_(target), raceNormalize_(typed));
  const pct = target.length ? Math.floor((prog / target.length) * 100) : 0;
  const progEl = $('raceProgBar');
  if (progEl) progEl.style.width = `${Math.max(0, Math.min(100, pct))}%`;

  try{ updateRaceDiffView_(target, typed); }catch(e){}

  // throttle + only when changed
  const now = Date.now();
  if (prog === raceLastProg_ && (now - raceLastSentAt_) < 900) return;
  if ((now - raceLastSentAt_) < 220) return;

  raceLastSentAt_ = now;
  raceLastProg_ = prog;

  if (!uid) return;
  try{
    await window.FB.ensureAnonAuth();
    const pRef = window.FB.ref(window.FB.db, `${fbRacePlayersPath_(sessionId)}/${uid}`);
    const nm = myName().slice(0,12) || 'ìµëª…';
    await window.FB.update(pRef, { name: nm, idx: idx, doneCount: myDone, p: prog, done: false, ts: now });
  }catch(e){}
}

async function trySetWinner_(uid, name, timeMs){
  try{
    const curRef = window.FB.ref(window.FB.db, fbRaceCurrentPath_(sessionId));
    const res = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur || cur.status !== 'running') return cur;
      if (cur.winnerUid) return cur;
      return Object.assign({}, cur, {
        status: 'ended',
        endedAt: Date.now(),
        winnerUid: uid,
        winnerName: String(name || '').slice(0,12),
        winnerTimeMs: Number(timeMs || 0)
      });
    });

    if (res && res.committed){
      const sec = (Number(timeMs||0)/1000).toFixed(2);
      await pushSystem_(`ğŸ† ${String(name||'').slice(0,12)}ë‹˜ì´ âŒ¨ï¸ íƒ€ì´í•‘ ë ˆì´ìŠ¤ ìš°ìŠ¹! (ë¬´ì‹¤ìˆ˜ 10ë¬¸ì¥, ${sec}s)`);
      // "ì—„ì²­ í™”ë ¤í•˜ê²Œ" = fireworks + sparkles + boomup
      await pushEvent_({ type:'event', event:'fireworks', kind:'race', by:String(name||'').slice(0,12), ts: Date.now() });
      await pushEvent_({ type:'event', event:'fx', name:'sparkle', by:String(name||'').slice(0,12), ts: Date.now() });
      await pushEvent_({ type:'event', event:'fx', name:'boomup', by:String(name||'').slice(0,12), ts: Date.now() });
    }
  }catch(e){}
}

async function startRace_(diff){
  if (!sessionId) return;
  const d = (diff === 'high' || diff === 'mid' || diff === 'low') ? diff : 'low';
  try{ localStorage.setItem(RACE_LS_DIFF_, d); }catch(e){}
  try{ raceMeElim_ = false; }catch(e){}
  try{ const inp=$('raceInput'); if(inp){ inp.disabled=false; inp.classList.remove('eliminated'); } }catch(e){}

  const texts = buildRaceSet_(d, 10, `SET:${Date.now()}`);
  if (!texts || !texts.length) return;

  const cur = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
    status: 'running',
    difficulty: d,
    texts: texts,
    idx: 0,
    total: 10,
    startedAt: Date.now(),
    endsAt: Date.now() + RACE_LIMIT_MS_,
    limitMs: RACE_LIMIT_MS_,
    startedBy: myName().slice(0,12),
    winnerUid: '',
    winnerName: '',
    winnerTimeMs: 0
  };

  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbRacePath_(sessionId));
    await window.FB.set(root, { current: cur, players: {} });

    

    // âœ… PATCH: immediately reflect running state locally so input enables right away
    acidCur_ = cur;
    acidPlayers_ = acidPlayers_ || {};
    try{
      const uid = myUid_();
      if (uid){
        acidPlayers_[uid] = acidPlayers_[uid] || { name: myName().slice(0,12) || 'ìµëª…', score: 0, ts: Date.now() };
      }
    }catch(e){}
await pushSystem_(`ğŸ âŒ¨ï¸ íƒ€ì´í•‘ ë ˆì´ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! (ë‚œì´ë„: ${raceDiffLabel_(d)}) â€” <ë¬´ì‹¤ìˆ˜ 10ë¬¸ì¥> ìš°ìŠ¹! â±ï¸ 120ì´ˆ ì œí•œ (ì´ëª¨ì§€ ìë™ ë¬´ì‹œ / ê¸°í˜¸ëŠ” ê·¸ëŒ€ë¡œ)`);
  }catch(e){
    showOverlay('ì˜¤ë¥˜', 'ë ˆì´ìŠ¤ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }
}

function openRaceStart_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const last = (localStorage.getItem(RACE_LS_DIFF_) || 'low');
  const strictOn = loadRaceStrict_();

  // âœ… compact UI (no inner scroll) â€” difficulty buttons on top
  const html = `
    <div class="raceStartWrap compact">
      <div class="raceStartTopRow" style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:8px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button class="raceDiffPill" type="button" data-diff="low"  aria-label="ë‚œì´ë„ í•˜">í•˜</button>
          <button class="raceDiffPill" type="button" data-diff="mid"  aria-label="ë‚œì´ë„ ì¤‘">ì¤‘</button>
          <button class="raceDiffPill" type="button" data-diff="high" aria-label="ë‚œì´ë„ ìƒ">ìƒ</button>
          <span class="metaPill" style="padding:6px 10px;">ìµœê·¼: ${raceDiffLabel_(last)}</span>
        </div>
        <button class="raceStrictBtn ${strictOn ? '' : 'off'}" type="button" data-action="raceStrictToggle">
          ${strictOn ? 'âœ… ì˜¤íƒ€ 1ë²ˆ=íƒˆë½: ON' : 'â˜‘ï¸ ì˜¤íƒ€ 1ë²ˆ=íƒˆë½: OFF'}
        </button>
      </div>

      <div class="raceStartHero" style="margin-bottom:0;">
        <div class="raceStartHeroInner">
          <div class="raceHeroBadge">ğŸ 10ë¬¸ì¥ ìŠ¤í”„ë¦°íŠ¸</div>
          <div class="raceHeroTrack">
            <div class="trackLane">
              <div class="trackCars">ğŸï¸ğŸ’¨ ğŸš—ğŸ’¨ ğŸš™ğŸ’¨ ğŸ›µğŸ’¨</div>
              <div style="margin-left:auto; font-weight:950;">FINISH ğŸ</div>
            </div>
            <div class="trackMeta">
              <span class="metaPill">Enter=ì œì¶œ</span>
              <span class="metaPill">ì˜¤íƒ€=ì¦‰ì‹œ ì‹¤íŒ¨</span>
              <span class="metaPill">120ì´ˆ ì œí•œ</span>
              <span class="metaPill">1ë“±: í­ì£½+ë°˜ì§âœ¨</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  showOverlayHtml('âŒ¨ï¸ íƒ€ì´í•‘ ë ˆì´ìŠ¤ ğŸ', html, false);
}

window.openRaceStart_ = openRaceStart_;
window.raceStartWith_ = function(diff){
  try{ hideOverlay(); }catch(e){}
  startRace_(diff);
};



// =====================
// â˜” Mini game: Acid Rain (ì‚°ì„±ë¹„) â€” 120ì´ˆ
// - ëˆ„ê°€ ì‹œì‘í•˜ë©´, ê°™ì€ ì„¸ì…˜(room)ì—ì„œ "seed/startedAt"ì„ ê³µìœ í•©ë‹ˆë‹¤.
// - ë‹¨ì–´ ë‚™í•˜ëŠ” ê° í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì¼í•œ seedë¡œ 'ê²°ì •ë¡ ì 'ìœ¼ë¡œ ìƒì„±(ë™ê¸°í™” ì‰¬ì›€).
// - ì ìˆ˜ëŠ” ê°ì players/{uid}.score ë¡œë§Œ ì˜¬ë¦½ë‹ˆë‹¤(ë‹¨ì–´ëŠ” ê³µìš© ì œê±° X).
// =====================
let acidCur_ = null;
let acidPlayers_ = {};
let acidCurUnsub_ = null;
let acidPlayersUnsub_ = null;

let acidUi_ = { open:false, raf: null, lastNow:0, schedule: [], active: new Map(), misses:0, hits:0 };
const ACID_LIMIT_MS_ = 120000;
const ACID_SPAWN_MS_ = 900;
const ACID_FALL_MS_  = 13000;
const ACID_MAX_ACTIVE_ = 15;
const ACID_FALL_MIN_MS_ = 5200;
const ACID_FALL_MAX_MS_ = 9000;
const ACID_EVENT_PROB_ = 0.12; // í™•ë¥ 
const ACID_EVENT_POINTS_ = 3;
const ACID_EVENT_FALL_MIN_MS_ = 2600;
const ACID_EVENT_FALL_MAX_MS_ = 4200;
const ACID_POOL_ = [
  'ì‚¬ë‘','ê³ ë°±','í›„íšŒ','êµ¬ì›','ì¹¨ë¬µ','ë¶ˆê½ƒ','ê·¸ë¦¼ì','ë¹›','ë‹¬','ë¹„','ìƒˆë²½','ê³ ìš”',
  'íƒ‘','ë¬¸','ì—´ì‡ ','ë¹„ë°€','ê³„ì•½','ê°ì¸','ë§ê°','í™˜ìƒ','ì§„ì‹¤','ìš´ëª…','ì‹¬ì¥','ìˆ¨',
  'íŒŒë„','ìˆ²','ë°¤','ê¿ˆ','ìƒì²˜','ì†ë','ì˜¨ê¸°','ì ˆë§','í¬ë§','ì˜¤í•´','ì•½ì†','ê±°ë¦¬',
  'ê°€ë©´','ì´ˆëŒ€','ë„ë§','ì¶”ê²©','ë¯¸ì†Œ','ëˆˆë¬¼','í­í’','ê²€','ë§ˆë²•','ì €ì£¼','ê¸°ë„','ì„±ì¢Œ',
  'ì•„ì´ëŒ','ë¬´ëŒ€','ì—°ìŠµ','ë°ë·”','ì¹´ë©”ë¼','ì»·','ì”¬','í¸ì§‘','ì„œì‚¬','í´ë¦¬ì…°','ë°˜ì „'
];
const ACID_BONUS_POOL_ = [
  'âœ¨ë³´ë„ˆìŠ¤','âš¡ìŠ¤í”¼ë“œ','ğŸ’ì­íŒŸ','ğŸ”¥ì½¤ë³´','ğŸŒŸì´ë²¤íŠ¸','ğŸ¯ì •ë‹µ','ğŸ§ªì‚°ì„±','â˜”í­ìš°'
];


function fbAcidPlayerPath_(roomId, uid){ return `${fbAcidPlayersPath_(roomId)}/${uid}`; }

const mulberry32_acid_ = (a)=>{
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
};

function buildAcidSchedule_(cur){
  try{
    const startedAt = Number(cur.startedAt||0) || Date.now();
    const seed = Number(cur.seed||0) || (startedAt % 2147483647);
    const rng = mulberry32_acid_(seed >>> 0);

    const duration = Number(cur.limitMs||0) || ACID_LIMIT_MS_;
    const spawnMs = Number(cur.spawnMs||0) || ACID_SPAWN_MS_;

    const total = Math.ceil(duration / spawnMs) + 6;
    const arr = [];
    for (let i=0;i<total;i++){
      const w = ACID_POOL_[Math.floor(rng()*ACID_POOL_.length)] || 'ë‹¨ì–´';
      const x = 6 + Math.floor(rng()*84); // 6~90%
      const spawnAt = startedAt + i*spawnMs;
      arr.push({ id: i, w, xPct: x, spawnAt });
    }
    return arr;
  }catch(e){
    return [];
  }
}

function initAcidRain_(roomId){
  try{
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(roomId));
    if (acidCurUnsub_) acidCurUnsub_();
    acidCurUnsub_ = window.FB.onValue(curRef, (snap)=>{
      acidCur_ = snap.exists() ? (snap.val() || null) : null;

      // ê²Œì„ì´ ì‹œì‘ë˜ë©´ ìŠ¤ì¼€ì¤„ ì¬êµ¬ì¶•
      try{
        if (acidCur_ && acidCur_.status === 'running'){
          // (wave-based) no fixed schedule needed
          acidUi_.schedule = null;
          }
      }catch(e){}

      // ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆìœ¼ë©´ UI ê°±ì‹ 
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('ì‚°ì„±ë¹„')) acidRender_();
      }catch(e){}
    });

    const plRef = window.FB.ref(window.FB.db, fbAcidPlayersPath_(roomId));
    if (acidPlayersUnsub_) acidPlayersUnsub_();
    acidPlayersUnsub_ = window.FB.onValue(plRef, (snap)=>{
      acidPlayers_ = snap.exists() ? (snap.val() || {}) : {};
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('ì‚°ì„±ë¹„')) acidRender_();
      }catch(e){}
    });
  }catch(e){
    console.warn('initAcidRain failed', e);
  }
}

function openAcidStart_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const running = !!(acidCur_ && acidCur_.status === 'running');
  const btn = running
    ? `<button class="bigPlayBtn" type="button" data-action="acidOpen">â˜” ì‚°ì„±ë¹„ ì—´ê¸°</button>`
    : `<button class="bigPlayBtn" type="button" data-action="acidStart">â˜” ì‚°ì„±ë¹„ ì‹œì‘ (120ì´ˆ)</button>`;

  // âœ… compact UI (no inner scroll) â€” start button on top, keep only the background hero layer
  const html = `
    <div class="acidWrap compact">
      <div style="display:flex; justify-content:flex-start; margin-bottom:8px;">
        ${btn}
      </div>

      <div class="raceStartHero" style="margin-bottom:0;">
        <div class="raceStartHeroInner">
          <div class="raceHeroBadge">â˜” ë‹¨ì–´ê°€ ë¹„ì²˜ëŸ¼ ë–¨ì–´ì§„ë‹¤</div>
          <div class="raceHeroTrack">
            <div class="trackLane">
              <div class="trackCars">â˜”â˜”â˜”  âŒ¨ï¸  â˜”â˜”â˜”</div>
              <div style="margin-left:auto; font-weight:950;">SCORE ğŸ¯</div>
            </div>
            <div class="trackMeta">
              <span class="metaPill">Enter/Space=ì œì¶œ</span>
              <span class="metaPill">120ì´ˆ ì œí•œ</span>
              <span class="metaPill">ì™„ë²½ ì…ë ¥=+1</span>
              <span class="metaPill">ì‹¤ì‹œê°„ ìˆœìœ„</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  showOverlayHtml('â˜” ì‚°ì„±ë¹„', html, false);
}

function openAcidGame_(){
  acidRender_();
  // âœ… PATCH: focus input so typing works immediately
  try{ setTimeout(()=>{ document.getElementById('acidInput')?.focus(); }, 60); }catch(e){}
}

function acidRender_(){
  const cur = acidCur_;
  const meUid = myUid_();
  const me = (meUid && acidPlayers_ && acidPlayers_[meUid]) ? (acidPlayers_[meUid]||{}) : {};
  const myScore = Number(me.score||0) || 0;

  const now = Date.now();
  const running = !!(cur && cur.status === 'running');
  const startedAt = Number(cur?.startedAt||0) || now;
  const endsAt = Number(cur?.endsAt||0) || (startedAt + ACID_LIMIT_MS_);
  const remainMs = Math.max(0, endsAt - now);

  // âœ… When the game is running and overlay is already open,
  // update only small UI parts (do NOT rebuild overlay â†’ prevents words from disappearing)
  try{
    const title = String($('ovTitle')?.textContent || '');
    const stage = document.getElementById('acidStage');
    if (running && stage && title.includes('ì‚°ì„±ë¹„')){
      const remainEl = document.getElementById('acidRemain');
      const myEl = document.getElementById('acidMyScore');
      const hmEl = document.getElementById('acidHM');
      const board = document.getElementById('acidBoard');
      const inp = document.getElementById('acidInput');

      if (remainEl) remainEl.textContent = `${(remainMs/1000).toFixed(1)}s`;
      if (myEl) myEl.textContent = String(myScore);
      if (hmEl) hmEl.textContent = `${acidUi_.hits}/${acidUi_.misses}`;
      if (board) board.innerHTML = acidRankHtml_();
      if (inp) inp.disabled = false;

      // keep loop alive
      acidStartLoop_();
      return;
    }
  }catch(e){}

  const rankHtml = acidRankHtml_();

  const html = `
    <div class="acidWrap">
      <div class="acidTop">
        <span class="pill">ìƒíƒœ: <b>${running ? 'ì§„í–‰ ì¤‘' : (cur ? 'ì¢…ë£Œ' : 'ëŒ€ê¸°')}</b></span>
        <span class="pill">ë‚¨ì€ ì‹œê°„: <b id="acidRemain">${(remainMs/1000).toFixed(1)}s</b></span>
        <span class="pill">ë‚´ ì ìˆ˜: <b id="acidMyScore">${myScore}</b></span>
        <span class="pill">ë‚´ íˆíŠ¸/ë¯¸ìŠ¤: <b id="acidHM">${acidUi_.hits}/${acidUi_.misses}</b></span>
        ${running ? '' : `<button class="bigPlayBtn" type="button" data-action="acidStart">â˜” ìƒˆ ê²Œì„ ì‹œì‘</button>`}
      </div>

      <div class="acidStage" id="acidStage" aria-label="ì‚°ì„±ë¹„ ìŠ¤í…Œì´ì§€"></div>

      <div class="acidHud">
        <div class="acidInputRow" style="flex: 1 1 340px;">
          <input id="acidInput" placeholder="ë‹¨ì–´ ì…ë ¥ í›„ Enter/Space" ${running ? '' : 'disabled'} />
          <button id="acidClear" type="button">ì§€ìš°ê¸°</button>
        </div>
        <div class="acidBoard">
          <div style="font-weight: 1000; margin-bottom:6px;">ğŸ† ìˆœìœ„</div>
          <div id="acidBoard">${rankHtml}</div>
        </div>
      </div>

      <div class="acidMiniNote">íŒ: ì˜¤ë²„ë ˆì´ í¬ê¸°ë¥¼ í‚¤ìš°ë©´ ë‹¨ì–´ê°€ ë” ì˜ ë³´ì—¬ìš” ğŸ‘€</div>
    </div>
  `;
  showOverlayHtml('â˜” ì‚°ì„±ë¹„', html, false);

  // bind UI
  try{ acidBindUi_(); }catch(e){}
  // start loop if running
  if (running) acidStartLoop_(); else acidStopLoop_();
}

function acidRankHtml_(){
  try{
    const items = [];
    for (const uid of Object.keys(acidPlayers_||{})){
      const p = acidPlayers_[uid] || {};
      items.push({
        nm: String(p.name||'ìµëª…').slice(0,12),
        score: Number(p.score||0) || 0,
        ts: Number(p.ts||0) || 0
      });
    }
    items.sort((a,b)=> (b.score - a.score) || (b.ts - a.ts) || a.nm.localeCompare(b.nm));
    const top = items.slice(0, 12);
    if (!top.length) return `<div class="line"><span>â€”</span><span>0</span></div>`;
    return top.map((it, i)=> `<div class="line"><span>${i+1}. ${escapeHtml(it.nm)}</span><span>${it.score}</span></div>`).join('');
  }catch(e){
    return `<div class="line"><span>â€”</span><span>0</span></div>`;
  }
}

function acidBindUi_(){
  const inp = document.getElementById('acidInput');
  const clear = document.getElementById('acidClear');
  const stage = document.getElementById('acidStage');
  if (!stage) return;

  // idempotent bind
  if (stage.__acidBound) return;
  stage.__acidBound = true;

  if (clear){
    clear.addEventListener('click', (e)=>{
      try{ e.preventDefault(); }catch(err){}
      if (inp) inp.value = '';
      try{ inp?.focus(); }catch(err){}
    }, false);
  }

  if (inp){
    // IME composition guard (Korean typing etc.)
    inp.__acidComposing = false;
    inp.addEventListener('compositionstart', ()=>{ inp.__acidComposing = true; }, false);
    inp.addEventListener('compositionend', ()=>{ inp.__acidComposing = false; }, false);

    inp.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        acidSubmit_();
      }
    }, false);

    // âœ… Auto-clear on typo: if current input is not a prefix of any live word, wipe it + apply penalty
    inp.addEventListener('input', (e)=>{
      try{
        if (inp.__acidComposing) return;
        const cur = acidCur_;
        if (!cur || cur.status !== 'running') return;
        const vRaw = String(inp.value||'').trim();
        if (!vRaw) return;

        const v = acidNormAcid_(vRaw);
        if (!v) return;

        let okPrefix = false;
        acidUi_.active.forEach((it, id)=>{
          if (okPrefix) return;
          if (!it || it.state !== 'live') return;
          const tw = acidNormAcid_(String(it.w||''));
          if (!tw) return;
          if (tw.startsWith(v)) okPrefix = true;
        });

        if (!okPrefix){
          // typo -> clear and penalty
          inp.value = '';
          acidUi_.misses++;
          try{ inp.classList.add('shake'); setTimeout(()=> inp.classList.remove('shake'), 260); }catch(err){}
          // score penalty (clamped at >=0)
          acidIncScore_(-1);
        }
      }catch(err){}
    }, false);
  }

  // focus
  try{ setTimeout(()=>{ try{ inp?.focus(); }catch(e){} }, 0); }catch(e){}
}


function acidStartLoop_(){
  if (acidUi_.raf) return;
  acidUi_.open = true;
  acidUi_.active = new Map();
  acidUi_.lastNow = 0;
  acidUi_.waveId = 0;
  acidUi_.schedKey = '';
  acidUi_.nextEventAt = 0;

  const spawnWave_ = (stage, cur, now)=>{
    const baseFall = (Number(cur.fallMs||0) || ACID_FALL_MS_) * 2;
    const maxN = ACID_MAX_ACTIVE_;
    const n = Math.max(6, Math.min(maxN, 10 + Math.floor(Math.random()*6))); // 10~15 (min 6)
    // x positions with overlap avoidance
    const xs = [];
    const minGap = 6; // percent
    for (let i=0;i<n;i++){
      let tries = 0;
      while (tries++ < 60){
        const x = 6 + Math.floor(Math.random()*84); // 6~90
        if (xs.every(v=> Math.abs(v-x) >= minGap)){ xs.push(x); break; }
      }
      if (xs.length < i+1) xs.push(6 + Math.floor(Math.random()*84));
    }
    xs.sort((a,b)=>a-b);

    acidUi_.waveId = (acidUi_.waveId||0) + 1;
    for (let i=0;i<n;i++){
      if (acidUi_.active.size >= maxN) break;
      const w = ACID_POOL_[Math.floor(Math.random()*ACID_POOL_.length)] || 'ë‹¨ì–´';
      const fallMs = Math.max(2600, Math.round(baseFall * (0.75 + Math.random()*0.95))); // ëŠë¦¼~ë¹ ë¦„
      const id = `w${acidUi_.waveId}_${i}_${now}`;
      const it = { id, w, xPct: xs[i], spawnAt: now, fallMs, points: 1, isEvent:false, state:'live' };
      acidUi_.active.set(id, it);
      acidAddWordEl_(stage, id, it.w, it.xPct, it.points, it.isEvent);
    }
  };

  const spawnEvent_ = (stage, cur, now)=>{
    if (acidUi_.active.size >= ACID_MAX_ACTIVE_) return;
    // ì´ë²¤íŠ¸ ë‹¨ì–´ëŠ” ì „ì²´ ì†ë„(2ë°° ëŠë¦¼) ì˜í–¥ì„ ë°›ì§€ ì•Šê²Œ ì›ë˜ ì²´ê° ì†ë„ë¡œ
    const baseFall = (Number(cur.fallMs||0) || ACID_FALL_MS_);
    const w = ACID_BONUS_POOL_[Math.floor(Math.random()*ACID_BONUS_POOL_.length)] || 'BONUS';
    const x = 8 + Math.floor(Math.random()*80);
    const fallMs = Math.max(1600, Math.round(baseFall * (0.40 + Math.random()*0.20))); // ë¹ ë¥´ê²Œ
    const points = 3;
    const id = `e_${now}_${Math.floor(Math.random()*9999)}`;
    const it = { id, w, xPct:x, spawnAt: now, fallMs, points, isEvent:true, state:'live' };
    acidUi_.active.set(id, it);
    acidAddWordEl_(stage, id, it.w, it.xPct, it.points, it.isEvent);
  };

  const scheduleNextEvent_ = (now)=>{
    // 6~12ì´ˆ ê°„ê²©ìœ¼ë¡œ ì´ë²¤íŠ¸ ë‹¨ì–´ ë“±ì¥
    const gap = 6000 + Math.floor(Math.random()*6000);
    acidUi_.nextEventAt = now + gap;
  };

  const tick = ()=>{
    if (!acidUi_.open) { acidStopLoop_(); return; }
    const cur = acidCur_;
    const stage = document.getElementById('acidStage');
    const remainEl = document.getElementById('acidRemain');
    const hmEl = document.getElementById('acidHM');
    if (!cur || cur.status !== 'running' || !stage){
      acidStopLoop_();
      return;
    }

    const now = Date.now();
    const startedAt = Number(cur.startedAt||0) || now;
    const endsAt = Number(cur.endsAt||0) || (startedAt + ACID_LIMIT_MS_);
    const remainMs = Math.max(0, endsAt - now);

    // new game session -> reset local stage and spawn immediately
    const curKey = String(cur.id||'');
    if (acidUi_.schedKey !== curKey){
      acidUi_.schedKey = curKey;
      acidUi_.active = new Map();
      try{ stage.innerHTML = ''; }catch(e){}
      acidUi_.hits = 0; acidUi_.misses = 0;
      acidUi_.waveId = 0;
      acidUi_.nextEventAt = 0;
      // ì¦‰ì‹œ ì²« ì›¨ì´ë¸Œ ìƒì„±(ê²Œì„ ì‹œì‘í•˜ìë§ˆì ë‹¨ì–´ ë‚´ë ¤ì˜¤ê¸°)
      spawnWave_(stage, cur, now);
      // ì´ë²¤íŠ¸ ë‹¨ì–´ëŠ” 4~8ì´ˆ í›„ ì²« ë“±ì¥
      acidUi_.nextEventAt = now + (4000 + Math.floor(Math.random()*4000));
    }

    if (remainEl) remainEl.textContent = `${(remainMs/1000).toFixed(1)}s`;
    if (hmEl) hmEl.textContent = `${acidUi_.hits}/${acidUi_.misses}`;

    // ì´ë²¤íŠ¸ ë‹¨ì–´: ì§„í–‰ ì¤‘ ì¤‘ê°„ì¤‘ê°„ ë¹ ë¥´ê²Œ ë“±ì¥
    if (acidUi_.nextEventAt && now >= acidUi_.nextEventAt){
      spawnEvent_(stage, cur, now);
      scheduleNextEvent_(now);
    }

    // í¬ì§€ì…˜ ì—…ë°ì´íŠ¸ + ë¯¸ìŠ¤ ì²˜ë¦¬ (px ê¸°ë°˜)
    const stageH = Math.max(1, stage.clientHeight || 340);
    acidUi_.active.forEach((it, id)=>{
      const el = stage.querySelector?.(`.acidWord[data-id="${id}"]`);
      if (!el) return;
      const age = now - it.spawnAt;
      const fallMsIt = Number(it.fallMs||0) || Number(cur.fallMs||0) || ACID_FALL_MS_;
      const travel = stageH + 80; // top(-30)~bottom(+50)
      const yPx = (age / fallMsIt) * travel;
      el.style.transform = `translate(-50%, ${yPx}px)`;
      if (yPx >= (stageH + 50) && it.state === 'live'){
        it.state = 'miss';
        acidUi_.misses++;
        try{ el.classList.add('miss'); }catch(e){}
        setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 350);
        acidUi_.active.delete(id);
      }
    });

    // ì›¨ì´ë¸Œ ê·œì¹™: í™”ë©´(ìŠ¤í…Œì´ì§€)ì— ë³´ì´ëŠ” ë‹¨ì–´ê°€ ì „ë¶€ ì‚¬ë¼ì§€ë©´(=ì „ë¶€ í´ë¦¬ì–´/ë¯¸ìŠ¤) ë‹¤ìŒ ì›¨ì´ë¸Œ
    if (acidUi_.active.size === 0 && remainMs > 0){
      spawnWave_(stage, cur, now);
    }

    // time over â†’ end
    if (remainMs <= 0){
      acidTryEnd_();
    }

    acidUi_.raf = requestAnimationFrame(tick);
  };

  acidUi_.raf = requestAnimationFrame(tick);
}


function acidStopLoop_(){
  acidUi_.open = false;
  try{ if (acidUi_.raf) cancelAnimationFrame(acidUi_.raf); }catch(e){}
  acidUi_.raf = null;
  // do not wipe scores; only stage nodes cleanup
  try{
    const stage = document.getElementById('acidStage');
    if (stage) stage.innerHTML = '';
  }catch(e){}
  try{ acidUi_.active = new Map(); }catch(e){}
}

function acidAddWordEl_(stage, id, word, xPct, points, isEvent){
  try{
    const el = document.createElement('div');
    const pt = Number(points||1)||1;
    const ev = !!isEvent;
    el.className = 'acidWord' + ((pt>1) ? ' bonus' : '') + (ev ? ' event' : '');
    el.setAttribute('data-pt', String(Number(points||1)||1));
    el.setAttribute('data-id', String(id));
    el.setAttribute('data-word', String(word));
    el.textContent = word;
    el.style.left = `${xPct}%`;
    el.style.transform = 'translate(-50%, 0%)';
    stage.appendChild(el);
  }catch(e){}
}

function acidNormAcid_(s){
  // Normalize for matching: allow users to type without leading emoji/symbols
  const str = String(s||'').trim();
  // remove leading non word (keep Hangul/Latin/number)
  const cleaned = str.replace(/^[^0-9A-Za-zê°€-í£]+/g,'').trim();
  return cleaned;
}

function acidSubmit_(){
  try{
    const cur = acidCur_;
    if (!cur || cur.status !== 'running') return;
    const inp = document.getElementById('acidInput');
    const stage = document.getElementById('acidStage');
    if (!inp || !stage) return;

    const raw = String(inp.value || '').trim();
    if (!raw) return;

    // find matching live word (closest to bottom for fairness)
    let matchId = null;
    let bestY = -1;
    acidUi_.active.forEach((it, id)=>{
      if (!it || it.state !== 'live') return;
      const w0 = String(it.w||'');
      if (w0 !== raw && acidNormAcid_(w0) !== acidNormAcid_(raw)) return;
      const now = Date.now();
      const fallMsIt = Number(it.fallMs||0) || Number(cur.fallMs||0) || ACID_FALL_MS_;
      const age = now - it.spawnAt;
      const y = (age / fallMsIt) * 100;
      if (y > bestY){
        bestY = y;
        matchId = id;
      }
    });

    if (matchId == null){
      // miss input feedback + auto-clear + penalty
      try{ inp.classList.add('shake'); setTimeout(()=> inp.classList.remove('shake'), 260); }catch(e){}
      try{ inp.value = ''; }catch(e){}
      acidUi_.misses++;
      // score penalty (clamped >=0)
      acidIncScore_(-1);
      return;
    }

    // remove local word + score++
    const it = acidUi_.active.get(matchId);
    const pts = Number(it?.points||1) || 1;

    if (it) it.state = 'hit';
    acidUi_.hits++;
    try{
      const el = stage.querySelector?.(`.acidWord[data-id="${matchId}"]`);
      if (el) el.remove();
    }catch(e){}
    acidUi_.active.delete(matchId);

    inp.value = '';

    // update my score in firebase
    acidIncScore_(pts);
  }catch(e){}
}

async function acidIncScore_(delta){
  try{
    await window.FB.ensureAnonAuth();
    const uid = myUid_();
    if (!uid) return;

    const nm = myName().slice(0,12) || 'ìµëª…';
    const pRef = window.FB.ref(window.FB.db, fbAcidPlayerPath_(sessionId, uid));

    const dd = Math.round(Number(delta||0) || 0);
    if (!dd) return;

    await window.FB.runTransaction(pRef, (p)=>{
      p = p || {};
      const score0 = Number(p.score||0) || 0;
      const score = Math.max(0, score0 + dd);
      return Object.assign({}, p, { name: nm, score, ts: Date.now() });
    });

    // reflect quickly in UI (optimistic)
    try{
      const el = document.getElementById('acidMyScore');
      if (el){
        const me = acidPlayers_ && acidPlayers_[uid] ? (acidPlayers_[uid]||{}) : {};
        const score0 = Number(me.score||0) || 0;
        const sc = Math.max(0, score0 + dd);
        el.textContent = String(sc);
      }
    }catch(e){}
  }catch(e){}
}

async function acidTryEnd_(){
  try{
    await window.FB.ensureAnonAuth();
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(sessionId));
    const res = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur) return cur;
      if (cur.status !== 'running') return cur;
      // ensure time really over
      const endsAt = Number(cur.endsAt||0) || 0;
      if (endsAt && Date.now() < endsAt) return cur;
      cur.status = 'ended';
      cur.endedAt = Date.now();
      return cur;
    });

    if (res && res.committed){
      try{ await pushSystem_(`â˜” ì‚°ì„±ë¹„ ì¢…ë£Œ! (120ì´ˆ) â€” ì ìˆ˜íŒì„ í™•ì¸í•´ ë³´ì„¸ìš” ğŸ¯`); }catch(e){}
      try{ await acidPublishPodium_(); }catch(e){}
    }
  }catch(e){}
}

async function acidPublishPodium_(){
  try{
    if (!sessionId) return;
    await window.FB.ensureAnonAuth();

    // 1) read players once
    const plRef = window.FB.ref(window.FB.db, fbAcidPlayersPath_(sessionId));
    const snap = await window.FB.get(plRef);
    const players = (snap && snap.exists()) ? (snap.val() || {}) : {};

    const items = [];
    for (const puid of Object.keys(players||{})){
      const p = players[puid] || {};
      const nm = String(p.name || 'ìµëª…').trim().slice(0,12);
      const score = Number(p.score || 0) || 0;
      const ts = Number(p.ts || 0) || 0;
      items.push({ uid:puid, nm, score, ts });
    }

    // sort: score desc, ts asc(earlier first), name
    items.sort((a,b)=>{
      if (a.score !== b.score) return b.score - a.score;
      if (a.ts !== b.ts) return a.ts - b.ts;
      return a.nm.localeCompare(b.nm);
    });

    const top = items.slice(0,3);

    // 2) claim "podium posted" atomically so it's broadcast once
    const curRef = window.FB.ref(window.FB.db, fbAcidCurrentPath_(sessionId));
    const claim = await window.FB.runTransaction(curRef, (cur)=>{
      if (!cur) return cur;
      if (cur.podiumPostedAt) return cur; // already posted
      cur.podiumPostedAt = Date.now();
      cur.podium = top.map((t, i)=>({ rank:i+1, name:t.nm, score:t.score }));
      return cur;
    });

    if (!claim || !claim.committed) return;

    // 3) system message + fanfare
    const line = top.map((t,i)=> `${i+1}ë“± ${t.nm}(${t.score})`).join(' Â· ');
    const msg = top.length ? `ğŸ† ì‚°ì„±ë¹„ ê²°ê³¼ TOP${top.length}: ${line} ğŸºğŸ‰` : `ğŸ† ì‚°ì„±ë¹„ ê²°ê³¼: ì°¸ê°€ìê°€ ì—†ì—ˆì–´ìš” ğŸ˜¿`;
    try{ await pushSystem_(msg); }catch(e){}

    // fireworks for #1 (or generic)
    const winner = top[0]?.nm || '';
    try{ await pushEvent_({ type:'event', event:'fireworks', kind:'acid', by:winner || (myName().slice(0,12)||'SYSTEM'), ts: Date.now() }); }catch(e){}

    // small confetti for #2/#3
    for (let i=1;i<Math.min(3, top.length);i++){
      try{ await pushEvent_({ type:'event', event:'fx2', kind:'confetti', by: top[i].nm, ts: Date.now() }); }catch(e){}
    }
  }catch(e){}
}


async function startAcidRain_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }

  const cur = {
    id: (Date.now().toString(36) + Math.random().toString(36).slice(2,6)),
    status: 'running',
    startedAt: Date.now(),
    endsAt: Date.now() + ACID_LIMIT_MS_,
    limitMs: ACID_LIMIT_MS_,
    spawnMs: ACID_SPAWN_MS_,
    fallMs: ACID_FALL_MS_,
    seed: Math.floor(Math.random()*2147483647),
    startedBy: myName().slice(0,12) || 'ìµëª…'
  };

  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbAcidPath_(sessionId));
    await window.FB.set(root, { current: cur, players: {} });

    // local prep
    acidUi_.hits = 0;
    acidUi_.misses = 0;
    acidUi_.schedule = buildAcidSchedule_(cur);

    await pushSystem_(`â˜” ${cur.startedBy}ë‹˜ì´ ì‚°ì„±ë¹„ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤! â±ï¸ 120ì´ˆ â€” ë‹¨ì–´ë¥¼ ì™„ë²½í•˜ê²Œ ì¹˜ê³  Enter/Space!`);
    openAcidGame_();
  }catch(e){
    showOverlay('ì˜¤ë¥˜', 'ì‚°ì„±ë¹„ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }
}

window.openAcidStart_ = openAcidStart_;
window.openAcidGame_ = openAcidGame_;
window.startAcidRain_ = startAcidRain_;

// =====================

// =====================
// =====================
// ğŸ§© Mini game: Rummikub (ë² íƒ€ / ì‹¤ì‹œê°„ ê³µìœ )
// - ê°™ì€ ì„¸ì…˜(room) ì•ˆì—ì„œ ìƒíƒœë¥¼ Firebaseë¡œ ê³µìœ í•©ë‹ˆë‹¤.
// - ë“œë¡œìš°/í„´ ë„˜ê¸°ê¸° ë“±ì€ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê°±ì‹ (ì¶©ëŒ ìµœì†Œí™”)
// =====================
let rkState_ = null;
let rkUnsub_ = null;

function fbRKPath_(roomId){ return `rooms/${roomId}/games/rummikub`; }
function fbRKStatePath_(roomId){ return `${fbRKPath_(roomId)}/state`; }

function rkEnsureSub_(){
  try{
    if (rkUnsub_) return;
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    rkUnsub_ = window.FB.onValue(sRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      rkState_ = v;
      // ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆìœ¼ë©´ UI ê°±ì‹ 
      try{
        const title = String($('ovTitle')?.textContent || '');
        if (title.includes('ë£¨ë¯¸íë¸Œ')) rkRender_();
      }catch(e){}
    });
  }catch(e){}
}

function openRummi_(){
  try{ rkEnsureSub_(); }catch(e){}
  try{ rkRender_(); }catch(e){}
}

async function rkReset_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.remove(sRef);
  }catch(e){}
  try{ rkState_ = null; }catch(e){}
  try{ hideOverlay(); }catch(e){}
}

async function rkStartFromUi_(){
  try{ rkEnsureSub_(); }catch(e){}
  try{
    const n = Math.max(2, Math.min(5, parseInt(document.getElementById('rkPlayers')?.value || '2',10) || 2));
    const st = rkNewGame_(n);
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.set(sRef, st);
  }catch(e){}
}

function rkNewGame_(nPlayers){
  const colors = ['R','B','G','K'];
  const tiles = [];
  let id = 0;
  // 1~13, 4ìƒ‰, 2ì„¸íŠ¸
  for (let set=0; set<2; set++){
    for (const c of colors){
      for (let num=1; num<=13; num++){
        tiles.push({ id: (++id), c, num, j:false });
      }
    }
  }
  // jokers x2
  tiles.push({ id: (++id), c:'J', num:0, j:true });
  tiles.push({ id: (++id), c:'J', num:0, j:true });

  // shuffle
  for (let i=tiles.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    const tmp = tiles[i]; tiles[i]=tiles[j]; tiles[j]=tmp;
  }

  const players = [];
  for (let p=0;p<nPlayers;p++){
    players.push({ name:`P${p+1}`, rack:[] });
  }
  // deal 14 each
  for (let k=0;k<14;k++){
    for (let p=0;p<nPlayers;p++){
      const t = tiles.pop();
      if (t) players[p].rack.push(t);
    }
  }

  return {
    nPlayers,
    players,
    pool: tiles,
    table: [],
    turn: 0,
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
}

function rkTileHtml_(t){
  if (!t) return '';
  const cls = t.j ? 'rkTile joker' : ('rkTile c'+t.c);
  const label = t.j ? 'ğŸƒ' : String(t.num);
  const sub = t.j ? 'J' : t.c;
  return `<span class="${cls}" title="${sub}">${label}</span>`;
}

function rkSetupHtml_(){
  return `
    <div class="rkWrap">
      <div class="rkHead">
        <div class="rkTitle">ğŸ§© ë£¨ë¯¸íë¸Œ (ë² íƒ€)</div>
        <div class="rkSub">2~5ëª… Â· <b>ì‹¤ì‹œê°„ ê³µìœ </b></div>
      </div>

      <div class="rkSetup">
        <label class="rkLbl">í”Œë ˆì´ì–´ ìˆ˜</label>
        <select id="rkPlayers">
          <option value="2">2ëª…</option>
          <option value="3">3ëª…</option>
          <option value="4">4ëª…</option>
          <option value="5">5ëª…</option>
        </select>
        <button class="btn" type="button" data-action="rkStart">ìƒˆ ê²Œì„ ì‹œì‘</button>
        <button class="btn ghost" type="button" data-action="rkReset">ë‹«ê¸°</button>
      </div>

      <div class="rkHint">
        â€¢ í˜„ì¬ëŠ” <b>ê¸°ë³¸ êµ¬ì¡°</b>(ì…”í”Œ/ë”œ/ë“œë¡œìš°/í„´)ë§Œ êµ¬í˜„ë˜ì–´ ìˆì–´ìš”.<br/>
        â€¢ ê°™ì€ ì„¸ì…˜ì— ë“¤ì–´ì˜¨ ì‚¬ëŒë“¤ì´ <b>ê°™ì€ ìƒíƒœë¥¼ ê³µìœ </b>í•´ì„œ ê°™ì´ í”Œë ˆì´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  `;
}

function rkRender_(){
  try{
    if (!rkState_){
      showOverlayHtml('ğŸ§© ë£¨ë¯¸íë¸Œ(ë² íƒ€)', rkSetupHtml_(), true);
      return;
    }
    const st = rkState_;
    const me = (st.players||[])[st.turn] || (st.players||[])[0] || {name:'P1', rack:[]};
    const poolN = (st.pool||[]).length;

    const rack = (me.rack||[]).slice().sort((a,b)=>{
      const ca = (a.c||'').charCodeAt(0), cb = (b.c||'').charCodeAt(0);
      if (ca!==cb) return ca-cb;
      return (a.num||0)-(b.num||0);
    });

    const rackHtml = rack.map(rkTileHtml_).join('');

    const html = `
      <div class="rkWrap">
        <div class="rkHead">
          <div class="rkTitle">ğŸ§© ë£¨ë¯¸íë¸Œ (ë² íƒ€)</div>
          <div class="rkSub">í˜„ì¬ í„´: <b>${escapeHtml(me.name||'P')}</b> Â· ë‚¨ì€ íƒ€ì¼: <b>${poolN}</b></div>
        </div>

        <div class="rkCtrl">
          <button class="btn" type="button" data-action="rkDraw">ë“œë¡œìš°(1ì¥)</button>
          <button class="btn ghost" type="button" data-action="rkNext">í„´ ë„˜ê¸°ê¸°</button>
          <button class="btn ghost" type="button" data-action="rkReset">ì¢…ë£Œ</button>
        </div>

        <div class="rkRack">
          <div class="rkLbl">í˜„ì¬ í„´ì˜ íŒ¨(ì •ë ¬)</div>
          <div class="rkRackTiles">${rackHtml || '<span class="muted">íŒ¨ê°€ ë¹„ì—ˆì–´ìš”</span>'}</div>
        </div>

        <div class="rkHint">
          â€¢ ë‹¤ìŒ í™•ì¥: íƒ€ì¼ ë“œë˜ê·¸/ì„ íƒ â†’ í…Œì´ë¸”ì— ëŸ°/ê·¸ë£¹ìœ¼ë¡œ ë‚´ë ¤ë†“ê¸°, ê·œì¹™ ê²€ì¦, ìŠ¹ë¦¬ íŒì •, í”Œë ˆì´ì–´ ì´ë¦„/ìë¦¬ ì—°ê²°
        </div>
      </div>
    `;
    showOverlayHtml('ğŸ§© ë£¨ë¯¸íë¸Œ(ë² íƒ€)', html, true);
  }catch(e){}
}

async function rkDraw_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.runTransaction(sRef, (cur)=>{
      if (!cur || !cur.players || !cur.pool) return cur;
      const t = (cur.pool||[]).pop();
      const idx = Number(cur.turn||0) || 0;
      cur.players[idx] = cur.players[idx] || {name:`P${idx+1}`, rack:[]};
      cur.players[idx].rack = cur.players[idx].rack || [];
      if (t) cur.players[idx].rack.push(t);
      cur.updatedAt = Date.now();
      return cur;
    });
  }catch(e){}
}

async function rkNextTurn_(){
  try{
    const sRef = window.FB.ref(window.FB.db, fbRKStatePath_(sessionId));
    await window.FB.runTransaction(sRef, (cur)=>{
      if (!cur || !cur.players) return cur;
      const n = (cur.players||[]).length || 1;
      cur.turn = ((Number(cur.turn||0)||0) + 1) % n;
      cur.updatedAt = Date.now();
      return cur;
    });
  }catch(e){}
}

// =====================
// =====================

// âœ… WriterMarble: fit board to overlay width (no weird font jumping)
function wmFitBoard_(){
  try{
    const wrap = document.querySelector('.wmBoardWrap');
    const board = document.querySelector('.wmBoard.wmBoardScaled');
    if (!wrap || !board) return;

    // reset (measure at 1x)
    board.style.transform = 'scale(1)';
    board.style.transformOrigin = '50% 50%';

    // natural size
    const naturalW = board.scrollWidth || board.getBoundingClientRect().width || 1;
    const availW = wrap.clientWidth || 1;

    // leave some padding
    const pad = 8;
    const base = Math.max(0.5, Math.min(1, (availW - pad) / naturalW));
    board.dataset.baseScale = String(base);

    const zoom = (typeof wmWheelScale_ === 'number' && isFinite(wmWheelScale_)) ? wmWheelScale_ : 1;
    const finalScale = Math.max(0.35, Math.min(2.8, base * zoom));

    board.style.transform = `scale(${finalScale})`;

    // keep wrap tall enough so center area doesn't overlap
    const naturalH = board.scrollHeight || board.getBoundingClientRect().height || 1;
    wrap.style.minHeight = Math.ceil(naturalH * finalScale) + 'px';
  }catch(e){}
}

// âœ… ë¶€ë£¨ë§ˆë¸” ë³´ë“œ: ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ê³  ìŠ¤í¬ë¡¤ë¡œ í™•ëŒ€/ì¶•ì†Œ (íœ  ì¤Œ)
let wmWheelScale_ = (()=>{
  try{
    const v = parseFloat(localStorage.getItem('WM_WHEEL_ZOOM_V1')||'1');
    return (isFinite(v) && v>0) ? v : 1;
  }catch(e){ return 1; }
})();

function wmBindWheelZoom_(){
  try{
    const wrap = document.querySelector('.wmBoardWrap');
    const board = document.querySelector('.wmBoard.wmBoardScaled');
    if (!wrap || !board) return;
    if (wrap.__wheelZoomBound) return;
    wrap.__wheelZoomBound = true;

    // initial apply (fit + saved zoom)
    try{ wmFitBoard_(); }catch(e){}

    wrap.addEventListener('wheel', (e)=>{
      try{
        if (!board) return;
        // prevent page scroll while zooming the board
        e.preventDefault();

        const rect = wrap.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / Math.max(1, rect.width)) * 100;
        const y = ((e.clientY - rect.top) / Math.max(1, rect.height)) * 100;
        board.style.transformOrigin = `${Math.max(0,Math.min(100,x))}% ${Math.max(0,Math.min(100,y))}%`;

        const step = 1.07;
        if (e.deltaY < 0) wmWheelScale_ *= step;      // wheel up â†’ zoom in
        else wmWheelScale_ /= step;                   // wheel down â†’ zoom out

        wmWheelScale_ = Math.max(0.6, Math.min(2.2, wmWheelScale_));
        try{ localStorage.setItem('WM_WHEEL_ZOOM_V1', String(wmWheelScale_)); }catch(err){}
        try{ wmFitBoard_(); }catch(err){}
      }catch(err){}
    }, { passive:false });

    // resize safe
    window.addEventListener('resize', ()=>{ try{ wmFitBoard_(); }catch(e){} }, { passive:true });
  }catch(e){}
}



// Mini Game: Writer Marble (ë¶€ë£¨ë§ˆë¸”: ê¸€ììˆ˜ ë²„ì „)
// âœ… ëª©í‘œ: 10ë°”í€´ ì„ ì°© ë˜ëŠ” ë§ˆì§€ë§‰ ìƒì¡´
// âœ… í†µí™”: ê¸€ììˆ˜(ê¸°ë³¸ 15,000ì)
// âœ… ëŒ€ì¶œ: 2íšŒê¹Œì§€(í•œ ë²ˆ 5,000ì, ìƒí™˜ 5,500ì)
// âœ… ì£¼ì‚¬ìœ„ ì—°ì¶œ: 2ì´ˆ êµ´ë¦¼(ìƒíƒœ ê³µìœ )
// =====================
const WM_START_MONEY_ = 15000;
const WM_PASS_START_BONUS_ = 1200;
const WM_LOAN_AMOUNT_ = 5000;
const WM_LOAN_REPAY_ = 5500;
const WM_MAX_LOANS_ = 2;
const WM_DICE_ANIM_MS_ = 2000;

let wmPlayers_ = {};
let wmPlayersUnsub_ = null;
let wmState_ = null;
let wmStateUnsub_ = null;

function fbWMPath_(roomId){ return `rooms/${roomId}/games/writerMarble`; }
function fbWMPlayersPath_(roomId){ return `${fbWMPath_(roomId)}/players`; }
function fbWMStatePath_(roomId){ return `${fbWMPath_(roomId)}/state`; }

function wmDefaultState_(){
  return {
    started:false,
    ended:false,
    winner:null,
    createdAt: Date.now(),
    turnOrder:[],
    turnIdx:0,
    pending:null, // {by, d1, d2, total, startedAt, resolveAt, fromPos}
    lastMove:null, // {uid, from, to, steps, at, token}
    lastLog:[],
    tiles:{} // pos -> {ownerId, ownerName, price, rent}
  };
}

function wmDiceChar_(n){
  const map = {1:'âš€',2:'âš',3:'âš‚',4:'âšƒ',5:'âš„',6:'âš…'};
  return map[n] || 'ğŸ²';
}

function wmBoard_(){
  // 40ì¹¸(11x11 ì™¸ê³½) â€” â€œëª¨ë‘ì˜ë§ˆë¸” ëŠë‚Œâ€ë§Œ ì‚´ë¦° ë¼ì´íŠ¸ ë²„ì „
  // pos: 0(START) â†’ ì‹œê³„ë°©í–¥
  // type: start, land, chance, tax, loan, rest
  const lands = [
    ['ë‹¬ë¹›ì„œì ','ğŸ“š'],['í¸ì§‘ì‹¤','ğŸ“'],['í”¼ë“œë°±ë°©','ğŸ’¬'],['ë§ˆê°ì¹´í˜','â˜•'],
    ['ì‘ì—…ì‹¤A','ğŸ–¥ï¸'],['ì‘ì—…ì‹¤B','âŒ¨ï¸'],['ì§‘í•„ë™êµ´','ğŸ•³ï¸'],['ì˜ê°ì‹œì¥','ğŸ›’'],
    ['í‡´ê³ ì˜ìˆ²','ğŸŒ²'],['ê³ ì¦ë„ì„œê´€','ğŸ›ï¸'],['ì—°ì¬ê´‘ì¥','ğŸŸï¸'],['í‘œì§€ìŠ¤íŠœë””ì˜¤','ğŸ¨'],
    ['í¬ìŠ¤í„°ê±°ë¦¬','ğŸª§'],['ë…ìë§ˆì„','ğŸ˜ï¸'],['ë¦¬ë””ì—­','ğŸš‰'],['í”Œë«í¼íƒ€ì›Œ','ğŸ—¼'],
    ['ê¸°íšíšŒì˜ì‹¤','ğŸ“‹'],['ì‹œë†‰ê³µë°©','ğŸ§©'],['ì„¸ê³„ê´€í•­êµ¬','âš“'],['ìºë¦­í„°ê³µì›','ğŸ¡'],
    ['ê°ì •ì„ ê°€','ğŸ­'],['ì „ê°œë„ë¡œ','ğŸ›£ï¸'],['ë–¡ë°¥ì°½ê³ ','ğŸ“¦'],['ë°˜ì „í„°ë„','ğŸŒ€'],
    ['í›„ê¸°ê´‘ì¥','ğŸ—£ï¸'],['êµ¿ì¦ˆìƒì ','ğŸ§¸'],['ì‹ ì‘ê±°ë¦¬','ğŸ†•'],['ë² ìŠ¤íŠ¸ì¡´','ğŸ†'],
  ];
  // ê°€ê²©/ë ŒíŠ¸ëŠ” â€œëª‡ë°±ìâ€ ë‹¨ìœ„ë¡œ
  const priceBase = [450,520,600,680,760,840,920,1000];
  const rentBase  = [220,260,300,340,380,420,460,520];

  // ê³ ì • ì´ë²¤íŠ¸ ì¹¸ ë°°ì¹˜(ëŠë‚Œìš©)
  const special = {
    0:{type:'start', name:'START', icon:'ğŸ', desc:`+${WM_PASS_START_BONUS_} (í†µê³¼)`},
    5:{type:'chance', name:'í¬ì¶˜', icon:'ğŸ', desc:'ëœë¤'},
    10:{type:'tax', name:'ì„¸ê¸ˆ', icon:'ğŸ§¾', desc:'-900'},
    15:{type:'loan', name:'ì€í–‰', icon:'ğŸ¦', desc:`ëŒ€ì¶œ(${WM_LOAN_AMOUNT_})/ìƒí™˜(${WM_LOAN_REPAY_})`},
    20:{type:'rest', name:'íœ´ì‹', icon:'ğŸ›‹ï¸', desc:'í•œìˆ¨ ëŒë¦¬ê¸°'},
    25:{type:'chance', name:'í¬ì¶˜', icon:'ğŸ', desc:'ëœë¤'},
    30:{type:'tax', name:'ì„¸ê¸ˆ', icon:'ğŸ§¾', desc:'-1200'},
    35:{type:'loan', name:'ì€í–‰', icon:'ğŸ¦', desc:`ëŒ€ì¶œ(${WM_LOAN_AMOUNT_})/ìƒí™˜(${WM_LOAN_REPAY_})`},
  };

  const out = [];
  let landIdx=0;
  for (let pos=0; pos<40; pos++){
    if (special[pos]){
      out.push({pos, ...special[pos]});
    }else{
      const [nm, ic] = lands[landIdx % lands.length];
      const tier = landIdx % priceBase.length;
      const price = priceBase[tier];
      const rent = rentBase[tier];
      out.push({pos, type:'land', name:nm, icon:ic, price, rent, desc:`${price}ì / í†µí–‰ë£Œ ${rent}ì`});
      landIdx++;
    }
  }
  return out;
}

const WM_BOARD_ = wmBoard_();

// grid position mapping for 11x11 perimeter (pos 0..39)
function wmPosToGrid_(pos){
  const n = 11;
  const max = n-1; // 10
  // corners: 0=top-left, 10=top-right, 20=bottom-right, 30=bottom-left
  if (pos<=10){
    return {r:1, c:1+pos}; // top row left->right
  }else if (pos<=19){
    return {r:1+(pos-10), c:11}; // right col top->bottom (rows 2..10)
  }else if (pos<=30){
    // bottom row right->left
    return {r:11, c:11-(pos-20)}; // pos20..30 => c 11..1
  }else{
    // left col bottom->top
    return {r:11-(pos-30), c:1}; // pos31..39 => r 10..2
  }
}


function wmMeId_(){
  try{
    return ((window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || '').trim();
  }catch(e){ return wmMeId_(); }
}
function wmColorFor_(id){
  const hues = [330,320,305,285,265,245,220,200,180,160,140,120];
  const h = hues[Math.abs(hash32_(String(id||''))) % hues.length];
  return `hsl(${h} 85% 78%)`;
}
function wmMyPlayer_(){
  const me = wmMeId_();
  if (!me) return null;
  return { id: me, ...(wmPlayers_[me]||{}) };
}

function wmAddLog_(msg){
  try{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      const arr = Array.isArray(cur.lastLog) ? cur.lastLog.slice(-10) : [];
      arr.push({ts:Date.now(), msg:String(msg||'')});
      cur.lastLog = arr.slice(-12);
      return cur;
    });
  }catch(e){}
}

function wmEnsureInit_(roomId){
  return (async ()=>{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(roomId));
    const snap = await window.FB.get(sRef);
    if (!snap.exists()){
      await window.FB.set(sRef, wmDefaultState_());
    }
  })();
}

function initWriterMarble_(roomId){
  try{ if (wmPlayersUnsub_) wmPlayersUnsub_(); }catch(e){}
  try{ if (wmStateUnsub_) wmStateUnsub_(); }catch(e){}
  wmPlayersUnsub_ = null;
  wmStateUnsub_ = null;

  const pRef = window.FB.ref(window.FB.db, fbWMPlayersPath_(roomId));
  wmPlayersUnsub_ = window.FB.onValue(pRef, (snap)=>{
    wmPlayers_ = snap.val() || {};
    renderWriterMarbleOverlay_();
  });

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(roomId));
  wmStateUnsub_ = window.FB.onValue(sRef, (snap)=>{
    wmState_ = snap.val() || wmDefaultState_();
    // pending resolve attempt
    try{ wmResolvePending_(); }catch(e){}
    renderWriterMarbleOverlay_();
  });
}

async function wmJoin_(){
  if (!sessionId) return;
  if (!isNickConfigured_()){
    showOverlay('ë‹‰ë„¤ì„', 'ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.');
    try{ $('user')?.focus(); }catch(e){}
    return;
  }
  try{ await window.FB.ensureAnonAuth(); window.__presenceId = (window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || ''; }catch(e){}
  const meId = wmMeId_();
  if (!meId) return;

  const nick = (getNick_() || 'ìµëª…').trim();
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${meId}`);
  const payload = {
    id: meId,
    name: nick,
    joinedAt: Date.now(),
    money: WM_START_MONEY_,
    pos: 0,
    lap: 0,
    loans: 0,
    debt: 0,
    bankrupt: false,
    token: wmPickToken_(meId),
  };
  try{
    await window.FB.set(pRef, payload);
    wmAddLog_(`ğŸ ${nick} ì°¸ê°€! (ì‹œì‘ ${WM_START_MONEY_}ì)`);
  }catch(e){}
}

function wmPickToken_(seed){
  const tokens = ['ğŸ¦Š','ğŸ¼','ğŸ¯','ğŸ°','ğŸ¸','ğŸµ','ğŸ§','ğŸ£','ğŸ™','ğŸ¦„','ğŸ±','ğŸ¶','ğŸ¹','ğŸ¦–','ğŸ¦•','ğŸ²'];
  const idx = Math.abs(hash32_(String(seed||''))) % tokens.length;
  return tokens[idx];
}

async function wmLeaveMe_(){
  try{
    const meId = wmMeId_();
    if (!meId) return;
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${meId}`);
    await window.FB.remove(pRef);
    wmAddLog_(`ğŸ‘‹ ${(getNick_()||'ëˆ„êµ°ê°€')} í‡´ì¥`);
  }catch(e){}
}

function wmAliveIds_(){
  const ids = Object.keys(wmPlayers_||{});
  return ids.filter(id=> !(wmPlayers_[id]||{}).bankrupt);
}

async function wmStartGame_(){
  if (!sessionId) return;
  const ids = Object.keys(wmPlayers_||{});
  if (ids.length < 2){
    showOverlay('ë¶€ë£¨ë§ˆë¸”', '2ëª… ì´ìƒ ì°¸ê°€í•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”!');
    return;
  }
  const order = ids
    .map(id=>({id, t:(wmPlayers_[id]||{}).joinedAt || 0}))
    .sort((a,b)=>a.t-b.t)
    .map(x=>x.id);

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    cur.started = true;
    cur.ended = false;
    cur.winner = null;
    cur.turnOrder = order;
    cur.turnIdx = 0;
    cur.pending = null;
    cur.tiles = {}; // reset ownership
    cur.lastLog = [{ts:Date.now(), msg:'ğŸ ê²Œì„ ì‹œì‘! (10ë°”í€´ ì„ ì°© / ë§ˆì§€ë§‰ ìƒì¡´)'}];
    return cur;
  });

  // reset players stats
  for (const id of ids){
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${id}`);
    await window.FB.update(pRef, { money: WM_START_MONEY_, pos:0, lap:0, loans:0, debt:0, bankrupt:false });
  }
}

async function wmEndGame_(){
  if (!sessionId) return;
  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    cur.started = false;
    cur.ended = true;
    cur.winner = null;
    cur.pending = null;
    cur.turnOrder = [];
    cur.turnIdx = 0;
    cur.tiles = {};
    cur.lastLog = [{ts:Date.now(), msg:'ğŸ§¹ ê²Œì„ ì¢…ë£Œ/ë¦¬ì…‹'}];
    return cur;
  });
}

function wmIsMyTurn_(){
  const me = wmMyPlayer_();
  if (!me || !wmState_ || !wmState_.started || wmState_.ended) return false;
  const curId = (wmState_.turnOrder||[])[wmState_.turnIdx||0];
  return curId && curId === me.id;
}

function wmCurrentTurnId_(){
  if (!wmState_ || !wmState_.started) return null;
  const curId = (wmState_.turnOrder||[])[wmState_.turnIdx||0];
  return curId || null;
}

async function wmRoll_(){
  if (!sessionId) return;
  if (!wmState_ || !wmState_.started || wmState_.ended) return;

  const me = wmMyPlayer_();
  if (!me) return;
  if (!wmIsMyTurn_()){
    showOverlay('ë¶€ë£¨ë§ˆë¸”', 'ì§€ê¸ˆì€ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆì—ìš”!');
    return;
  }
  // pending exists
  if (wmState_.pending){
    showOverlay('ë¶€ë£¨ë§ˆë¸”', 'ì£¼ì‚¬ìœ„ê°€ êµ´ëŸ¬ê°€ëŠ” ì¤‘ì´ì—ìš”!');
    return;
  }
  const d1 = 1 + Math.floor(Math.random()*6);
  const d2 = 1 + Math.floor(Math.random()*6);
  const total = d1 + d2;
  const now = Date.now();

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  await window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    if (!cur.started || cur.ended) return cur;
    if (cur.pending) return cur;
    const curId = (cur.turnOrder||[])[cur.turnIdx||0];
    if (curId !== me.id) return cur;
    cur.pending = { by: me.id, d1, d2, total, startedAt: now, resolveAt: now + WM_DICE_ANIM_MS_, fromPos: (me.pos||0) };
    return cur;
  });
}

function wmResolvePending_(){
  if (!sessionId) return;
  if (!wmState_ || !wmState_.pending || !wmState_.started || wmState_.ended) return;
  const p = wmState_.pending;
  const now = Date.now();
  if (now < (p.resolveAt||0)) return;

  const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
  window.FB.runTransaction(sRef, (cur)=>{
    cur = cur || wmDefaultState_();
    if (!cur.started || cur.ended) return cur;
    if (!cur.pending) return cur;
    const pend = cur.pending;
    if (Date.now() < (pend.resolveAt||0)) return cur;

    const pid = pend.by;
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt){
      cur.pending = null;
      return cur;
    }

    const steps = pend.total || 0;
    const from = pl.pos || 0;
    let to = (from + steps) % 40;
    let lapAdd = 0;
    if (from + steps >= 40) lapAdd = Math.floor((from + steps)/40);
    const newLap = (pl.lap||0) + lapAdd;

    // movement broadcast (for animation)
    cur.lastMove = { uid: pid, from, to, steps, at: Date.now(), token: (pl.token||'ğŸ™‚') };

    // apply move (write player update outside transaction via queued update)
    setTimeout(()=>{ try{
      const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
      window.FB.update(pRef, { pos: to, lap: newLap });
      if (lapAdd>0){
        window.FB.update(pRef, { money: (pl.money||0) + (WM_PASS_START_BONUS_ * lapAdd) });
      }
    }catch(e){} }, 0);

    // log dice
    const nm = pl.name || 'ëˆ„êµ°ê°€';
    const arr = Array.isArray(cur.lastLog) ? cur.lastLog.slice(-10) : [];
    arr.push({ts:Date.now(), msg:`ğŸ² ${nm}: ${pend.d1}+${pend.d2} = ${steps}`});
    cur.lastLog = arr.slice(-12);

    // land effect: compute using snapshot-ish (best effort)
    const tile = WM_BOARD_[to] || null;
    if (tile){
      // resolve effects in microtask
      setTimeout(()=>{ try{ wmApplyTileEffect_(pid, tile, cur.tiles||{}); }catch(e){} }, 0);
    }

    // win check (10 laps)
    if (newLap >= 10){
      cur.ended = true;
      cur.winner = pid;
      cur.lastLog = (cur.lastLog||[]).concat([{ts:Date.now(), msg:`ğŸ† ${nm} 10ë°”í€´ ì™„ì£¼! ìš°ìŠ¹!`}]).slice(-12);
    }

    // advance turn (unless game ended)
    if (!cur.ended){
      const alive = (cur.turnOrder||[]).filter(id=>{
        const pl2 = (wmPlayers_||{})[id];
        return pl2 && !pl2.bankrupt;
      });
      if (alive.length <= 1){
        cur.ended = true;
        cur.winner = alive[0] || pid;
      }else{
        // rotate to next alive
        const curId = (cur.turnOrder||[])[cur.turnIdx||0];
        let idx = cur.turnIdx||0;
        for (let k=0;k<alive.length+2;k++){
          idx = (idx+1) % (cur.turnOrder||[]).length;
          const nid = (cur.turnOrder||[])[idx];
          const pl3 = (wmPlayers_||{})[nid];
          if (pl3 && !pl3.bankrupt){
            cur.turnIdx = idx;
            break;
          }
        }
      }
    }

    cur.pending = null;
    return cur;
  });
}

function wmTileKey_(pos){ return String(pos); }

function wmRentFor_(tile, owned){
  const base = Number((owned && owned.baseRent) || (owned && owned.rent) || tile.rent || 300);
  const lvl = Number((owned && owned.level) || 0);
  return Math.max(50, Math.floor(base * (1 + lvl * 0.75)));
}
function wmUpgradeCost_(tile, nextLvl){
  const p = Number(tile.price || 0);
  // nextLvl: 1..3
  const mul = [0, 0.45, 0.55, 0.70][nextLvl] || 0.6;
  return Math.max(200, Math.floor(p * mul));
}
function wmSellValue_(tile, owned){
  const p = Number(tile.price || (owned && owned.price) || 0);
  const lvl = Number((owned && owned.level) || 0);
  return Math.max(100, Math.floor(p * (0.7 + lvl*0.12)));
}

function wmReleaseAllProps_(pid){
  try{
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      cur.tiles = cur.tiles || {};
      for (const k of Object.keys(cur.tiles)){
        const o = cur.tiles[k];
        if (o && o.ownerId === pid) cur.tiles[k] = { ...o, ownerId:null, ownerName:null, level:0, visits:null };
      }
      return cur;
    });
  }catch(e){}
}

function wmTryCoverDeficit_(pid, tilesState, reason){
  try{
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt) return;
    let money = Number(pl.money||0);
    if (money >= 0) return;

    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
    const nm = pl.name || 'ëˆ„êµ°ê°€';

    // 1) auto-loan up to limit
    if ((pl.loans||0) < WM_MAX_LOANS_){
      const loanAmt = WM_LOAN_AMOUNT_;
      window.FB.update(pRef, { money: money + loanAmt, loans: (pl.loans||0)+1, debt: (pl.debt||0)+loanAmt });
      money += loanAmt;
      wmAddLog_(`ğŸ†˜ ${nm} íŒŒì‚° ì§ì „! ìë™ ëŒ€ì¶œ +${loanAmt}ì (ëŒ€ì¶œ ${((pl.loans||0)+1)}/${WM_MAX_LOANS_})`);
    }

    // 2) forced sales if still negative
    if (money < 0){
      const props = [];
      for (const t of WM_BOARD_){
        if (t.type !== 'land') continue;
        const key = wmTileKey_(t.pos);
        const o = (tilesState||{})[key];
        if (o && o.ownerId === pid){
          props.push({pos:t.pos, tile:t, owned:o, val: wmSellValue_(t,o)});
        }
      }
      props.sort((a,b)=>b.val-a.val);
      for (const pr of props){
        if (money >= 0) break;
        const gain = pr.val;
        money += gain;
        // release tile ownership
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const k = wmTileKey_(pr.pos);
          const curO = cur.tiles[k];
          if (curO && curO.ownerId === pid){
            cur.tiles[k] = { ...curO, ownerId:null, ownerName:null, level:0, visits:null };
          }
          return cur;
        });
        window.FB.update(pRef, { money });
        wmAddLog_(`ğŸ’¥ ${nm} ê°•ì œ ë§¤ê°! <${pr.tile.icon}${pr.tile.name}> +${gain}ì`);
      }
    }

    // 3) still negative => bankrupt
    if (money < 0){
      window.FB.update(pRef, { bankrupt:true, money:0 });
      wmReleaseAllProps_(pid);
      wmAddLog_(`ğŸ’€ ${nm} ${reason || 'íŒŒì‚°'}â€¦ (ë³´ìœ  ë•… ëª¨ë‘ ì••ë¥˜)`);
    }
  }catch(e){}
}

function wmApplyTileEffect_(pid, tile, tilesState){
  const pl = (wmPlayers_||{})[pid];
  if (!pl || pl.bankrupt) return;

  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
  const nm = pl.name || 'ëˆ„êµ°ê°€';
  const money = Number(pl.money||0);

  if (tile.type === 'tax'){
    const delta = (tile.pos===30) ? -1200 : -900;
    const nmoney = money + delta;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`ğŸ§¾ ${nm} ì„¸ê¸ˆ ${-delta}ì`);
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'ì„¸ê¸ˆìœ¼ë¡œ íŒŒì‚°');
    return;
  }
  if (tile.type === 'chance'){
    const rng = Math.abs(hash32_(`${Date.now()}|${pid}|${tile.pos}`)) % 6;
    const events = [
      {d:+900, t:'âœ¨ ì˜ê° í­ë°œ! +900ì'},
      {d:+1200,t:'ğŸ”¥ ì§‘ì¤‘ëª¨ë“œ ì„±ê³µ! +1200ì'},
      {d:-700, t:'ğŸ¥± ì¡¸ìŒ ê³µê²©â€¦ -700ì'},
      {d:-900, t:'ğŸ“µ ë©˜íƒˆ ì™€ì¥â€¦ -900ì'},
      {d:+600, t:'â˜• ì¹´í˜ì¸ ì£¼ì…! +600ì'},
      {d:-600, t:'ğŸ§¼ ìƒí™œë ¥ ì†Œëª¨ -600ì'},
    ];
    const ev = events[rng];
    const nmoney = money + ev.d;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`ğŸ ${nm} ${ev.t}`);
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'í¬ì¶˜ìœ¼ë¡œ íŒŒì‚°');
    return;
  }
  if (tile.type === 'loan'){
    wmAddLog_(`ğŸ¦ ${nm} ì€í–‰ ì¹¸`);
    return;
  }
  if (tile.type === 'rest'){
    wmAddLog_(`ğŸ›‹ï¸ ${nm} íœ´ì‹! (ì•„ë¬´ ì¼ë„ ì—†ìŒ)`);
    return;
  }

  if (tile.type === 'land'){
    const key = wmTileKey_(tile.pos);
    const owned = (tilesState||{})[key] || null;

    if (!owned || !owned.ownerId){
      if (money >= tile.price){
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const nowOwned = cur.tiles[key];
          if (nowOwned && nowOwned.ownerId) return cur;
          cur.tiles[key] = { ownerId: pid, ownerName: nm, price: tile.price, baseRent: tile.rent, level: 0, visits: { [pid]: 1 } };
          return cur;
        });
        window.FB.update(pRef, { money: money - tile.price });
        wmAddLog_(`ğŸ—ï¸ ${nm} <${tile.icon}${tile.name}> êµ¬ë§¤! (-${tile.price}ì)`);
      }else{
        wmAddLog_(`ğŸ˜µ ${nm} <${tile.icon}${tile.name}> ì‚´ ëˆì´ ë¶€ì¡±â€¦`);
      }
      return;
    }

    if (owned.ownerId === pid){
      // visit + possible auto-upgrade (2~4ë²ˆì§¸ ë°©ë¬¸)
      const prevV = (owned.visits && owned.visits[pid]) ? Number(owned.visits[pid]) : 0;
      const v = prevV + 1;
      const lvl = Number(owned.level||0);
      const wantUp = (v>=2 && lvl<1) || (v>=3 && lvl<2) || (v>=4 && lvl<3);
      if (wantUp){
        const nextLvl = Math.min(3, lvl+1);
        const cost = wmUpgradeCost_(tile, nextLvl);
        if (money >= cost){
          const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
          window.FB.runTransaction(sRef, (cur)=>{
            cur = cur || wmDefaultState_();
            cur.tiles = cur.tiles || {};
            const curO = cur.tiles[key];
            if (curO && curO.ownerId === pid){
              const vv = (curO.visits||{});
              vv[pid] = (vv[pid]||0) + 1;
              cur.tiles[key] = { ...curO, level: Math.min(3, Number(curO.level||0)+1), visits: vv };
            }
            return cur;
          });
          window.FB.update(pRef, { money: money - cost });
          wmAddLog_(`ğŸ™ï¸ ${nm} <${tile.icon}${tile.name}> ëœë“œë§ˆí¬ ì—…! Lv.${nextLvl} (-${cost}ì)`);
        }else{
          // still record visit
          const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
          window.FB.runTransaction(sRef, (cur)=>{
            cur = cur || wmDefaultState_();
            cur.tiles = cur.tiles || {};
            const curO = cur.tiles[key];
            if (curO && curO.ownerId === pid){
              const vv = (curO.visits||{});
              vv[pid] = (vv[pid]||0) + 1;
              cur.tiles[key] = { ...curO, visits: vv };
            }
            return cur;
          });
          wmAddLog_(`ğŸ  ${nm} ë‚´ ë•… <${tile.icon}${tile.name}> (ì—…ê·¸ë ˆì´ë“œ ìê¸ˆ ë¶€ì¡±)`);
        }
      }else{
        const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
        window.FB.runTransaction(sRef, (cur)=>{
          cur = cur || wmDefaultState_();
          cur.tiles = cur.tiles || {};
          const curO = cur.tiles[key];
          if (curO && curO.ownerId === pid){
            const vv = (curO.visits||{});
            vv[pid] = (vv[pid]||0) + 1;
            cur.tiles[key] = { ...curO, visits: vv };
          }
          return cur;
        });
        wmAddLog_(`ğŸ  ${nm} ë‚´ ë•… <${tile.icon}${tile.name}>`);
      }
      return;
    }

    // pay rent
    const rent = wmRentFor_(tile, owned);
    const nmoney = money - rent;
    window.FB.update(pRef, { money: nmoney });
    wmAddLog_(`ğŸ’¸ ${nm} í†µí–‰ë£Œ ${rent}ì ì§€ë¶ˆ â†’ ${owned.ownerName||'ìƒëŒ€'}ì—ê²Œ`);

    // give owner
    if (owned.ownerId){
      const oRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${owned.ownerId}`);
      const o = (wmPlayers_||{})[owned.ownerId];
      if (o && !o.bankrupt){
        window.FB.update(oRef, { money: Number(o.money||0) + rent });
      }
    }
    if (nmoney < 0) wmTryCoverDeficit_(pid, tilesState, 'í†µí–‰ë£Œë¡œ íŒŒì‚°');
    return;
  }
}

function wmBankrupt_(pid, reason){
  try{
    const pl = (wmPlayers_||{})[pid];
    if (!pl || pl.bankrupt) return;
    const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${pid}`);
    window.FB.update(pRef, { bankrupt:true, money:0 });
    wmAddLog_(`ğŸ’¥ ${pl.name||'ëˆ„êµ°ê°€'} íŒŒì‚°! (${reason||'íŒŒì‚°'})`);
    // release owned tiles
    const sRef = window.FB.ref(window.FB.db, fbWMStatePath_(sessionId));
    window.FB.runTransaction(sRef, (cur)=>{
      cur = cur || wmDefaultState_();
      cur.tiles = cur.tiles || {};
      for (const k of Object.keys(cur.tiles)){
        if (cur.tiles[k] && cur.tiles[k].ownerId === pid){
          cur.tiles[k] = null;
        }
      }
      // winner check
      const alive = (cur.turnOrder||[]).filter(id=>{
        const p2 = (wmPlayers_||{})[id];
        return p2 && !p2.bankrupt && id !== pid;
      });
      if (cur.started && !cur.ended && alive.length === 1){
        cur.ended = true;
        cur.winner = alive[0];
        cur.lastLog = (cur.lastLog||[]).concat([{ts:Date.now(), msg:`ğŸ† ${ (wmPlayers_||{})[alive[0]]?.name || 'ëˆ„êµ°ê°€'} ë§ˆì§€ë§‰ ìƒì¡´! ìš°ìŠ¹!` }]).slice(-12);
      }
      return cur;
    });
  }catch(e){}
}

async function wmLoan_(){
  if (!wmIsMyTurn_()) return showOverlay('ë¶€ë£¨ë§ˆë¸”','ë‚´ ì°¨ë¡€ì—ì„œë§Œ ëŒ€ì¶œí•  ìˆ˜ ìˆì–´ìš”!');
  const me = wmMyPlayer_(); if (!me) return;
  if ((me.loans||0) >= WM_MAX_LOANS_) return showOverlay('ë¶€ë£¨ë§ˆë¸”', `ëŒ€ì¶œì€ ìµœëŒ€ ${WM_MAX_LOANS_}íšŒê¹Œì§€!`);
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${me.id}`);
  await window.FB.update(pRef, {
    loans: (me.loans||0) + 1,
    debt: (me.debt||0) + WM_LOAN_REPAY_,
    money: (me.money||0) + WM_LOAN_AMOUNT_
  });
  wmAddLog_(`ğŸ¦ ${(me.name||'ë‚˜')} ëŒ€ì¶œ +${WM_LOAN_AMOUNT_}ì (ìƒí™˜ ${WM_LOAN_REPAY_}ì)`);
}

async function wmRepay_(){
  if (!wmIsMyTurn_()) return showOverlay('ë¶€ë£¨ë§ˆë¸”','ë‚´ ì°¨ë¡€ì—ì„œë§Œ ìƒí™˜í•  ìˆ˜ ìˆì–´ìš”!');
  const me = wmMyPlayer_(); if (!me) return;
  if ((me.debt||0) <= 0) return showOverlay('ë¶€ë£¨ë§ˆë¸”','ìƒí™˜í•  ëŒ€ì¶œì´ ì—†ì–´ìš”!');
  if ((me.money||0) < (me.debt||0)) return showOverlay('ë¶€ë£¨ë§ˆë¸”','ìƒí™˜í•  ëˆ(ê¸€ììˆ˜)ì´ ë¶€ì¡±í•´ìš”!');
  const pRef = window.FB.ref(window.FB.db, `${fbWMPlayersPath_(sessionId)}/${me.id}`);
  await window.FB.update(pRef, { money: (me.money||0) - (me.debt||0), debt: 0 });
  wmAddLog_(`âœ… ${(me.name||'ë‚˜')} ëŒ€ì¶œ ìƒí™˜ ì™„ë£Œ!`);
}

function wmFmt_(n){
  const v = Math.round(Number(n||0));
  return v.toLocaleString('ko-KR');
}


let wmDiceAnimTimer_ = null;
let wmDiceAnimKey_ = null;

function wmKickDiceAnim_(){
  try{
    const st = wmState_;
    if (!st || !st.pending){
      if (wmDiceAnimTimer_) clearInterval(wmDiceAnimTimer_);
      wmDiceAnimTimer_ = null;
      wmDiceAnimKey_ = null;
      return;
    }
    const p = st.pending;
    const key = `${p.by||''}|${p.startedAt||0}`;
    if (wmDiceAnimKey_ === key) return;
    wmDiceAnimKey_ = key;

    if (wmDiceAnimTimer_) clearInterval(wmDiceAnimTimer_);
    const endAt = p.resolveAt || (Date.now() + WM_DICE_ANIM_MS_);
    wmDiceAnimTimer_ = setInterval(()=>{
      try{
        const a = document.getElementById('wmDiceA');
        const b = document.getElementById('wmDiceB');
        if (!a || !b) return;
        const r1 = 1 + Math.floor(Math.random()*6);
        const r2 = 1 + Math.floor(Math.random()*6);
        a.textContent = wmDiceChar_(r1);
        b.textContent = wmDiceChar_(r2);
        if (Date.now() >= endAt){
          a.textContent = wmDiceChar_(p.d1||1);
          b.textContent = wmDiceChar_(p.d2||1);
          clearInterval(wmDiceAnimTimer_);
          wmDiceAnimTimer_ = null;
        }
      }catch(e){}
    }, 90);
  }catch(e){}
}

let wmLastMoveSeenKey_ = null;
function wmAnimateLastMove_(){
  try{
    const st = wmState_ || {};
    const mv = st.lastMove;
    if (!mv || !mv.uid) return;
    const key = `${mv.uid}|${mv.at||0}|${mv.from}|${mv.to}`;
    if (wmLastMoveSeenKey_ === key) return;
    wmLastMoveSeenKey_ = key;

    const board = document.querySelector('#wmBoard');
    if (!board) return;

    // create / reuse ghost
    let ghost = board.querySelector('.wmMoveGhost');
    if (!ghost){
      ghost = document.createElement('div');
      ghost.className = 'wmMoveGhost';
      ghost.textContent = mv.token || 'ğŸ™‚';
      board.appendChild(ghost);
    }else{
      ghost.textContent = mv.token || 'ğŸ™‚';
    }

    const steps = Math.max(0, Math.min(20, Number(mv.steps||0)));
    const path = [];
    for (let i=0;i<=steps;i++){
      path.push((Number(mv.from||0) + i) % 40);
    }
    const rectB = board.getBoundingClientRect();
    const toXY = (pos)=>{
      const cell = board.querySelector(`.wmCell[data-pos="${pos}"]`);
      if (!cell) return {x:-9999,y:-9999};
      const r = cell.getBoundingClientRect();
      return { x: (r.left - rectB.left) + r.width/2, y: (r.top - rectB.top) + r.height/2 };
    };

    let i = 0;
    const hop = ()=>{
      const p = path[i];
      const xy = toXY(p);
      ghost.style.transform = `translate(${xy.x-17}px, ${xy.y-17}px)`;
      i++;
      if (i <= steps){
        setTimeout(hop, 120);
      }else{
        // fade out quickly
        setTimeout(()=>{ try{ ghost.style.transform = 'translate(-9999px,-9999px)'; }catch(e){} }, 240);
      }
    };
    hop();
  }catch(e){}
}

function renderWriterMarbleOverlay_(){
  const me = wmMyPlayer_();
  const st = wmState_ || wmDefaultState_();

  const players = Object.keys(wmPlayers_||{}).map(id=>wmPlayers_[id]).filter(Boolean);
  players.sort((a,b)=> (b.money||0) - (a.money||0));

  const turnId = wmCurrentTurnId_();
  const turnPl = turnId ? (wmPlayers_||{})[turnId] : null;
  const pending = st.pending;

  const myTurn = wmIsMyTurn_();
  const meId = wmMeId_();

  // --- helpers
  const tollFor = (pos, owned, tile)=>{
    try{
      if (!tile) tile = (WM_BOARD_||[]).find(x=>x.pos===pos);
      if (!tile) return 0;
      let base = Number(tile.rent || 0);
      const lv = Number((owned && owned.level) || 0);
      // 0:ê¸°ë³¸, 1:ëœë“œë§ˆí¬1, 2:ëœë“œë§ˆí¬2, 3:ëœë“œë§ˆí¬3 (ì ì  ë¹¡ì„¸ê²Œ)
      const mult = [1, 1.6, 2.3, 3.2][Math.max(0, Math.min(3, lv))];
      return Math.round(base * mult);
    }catch(e){ return 0; }
  };

  const tipFor = (tile, owned)=>{
    if (!tile) return '';
    const lines = [];
    lines.push(`${tile.icon||''} ${tile.name||''}`.trim());
    if (tile.type==='land'){
      const lv = Number((owned && owned.level) || 0);
      const price = Number(tile.price||0);
      const toll = tollFor(tile.pos, owned, tile);
      lines.push(`êµ¬ë§¤: ${wmFmt_(price)}ì`);
      lines.push(`í†µí–‰ë£Œ: ${wmFmt_(toll)}ì (Lv.${lv})`);
      if (owned && owned.ownerName) lines.push(`ì†Œìœ ì£¼: ${owned.ownerName}`);
    }else{
      if (tile.desc) lines.push(tile.desc);
    }
    return lines.join('\n');
  };

  // --- build board cells
  let cellsHtml = '';
  for (const t of WM_BOARD_){
    const g = wmPosToGrid_(t.pos);
    const owned = (st.tiles||{})[String(t.pos)];
    const isOwned = owned && owned.ownerId;
    const isMine = isOwned && meId && (String(owned.ownerId)===String(meId));
    const ownColor = isOwned ? wmColorFor_(owned.ownerId) : 'transparent';
    const lv = Number((owned && owned.level) || 0);
    const badge = (t.type==='land' && isOwned) ? `<div class="wmLv">Lv.${lv}</div>` : '';
    cellsHtml += `
      <div class="wmCell ${t.type} ${isOwned?'wmOwned':''} ${isMine?'wmMine':''}" 
           style="grid-row:${g.r}; grid-column:${g.c}; --ownc:${ownColor};"
           data-pos="${t.pos}" data-tip="${escapeAttr(tipFor(t, owned))}">
        <div class="wmCellTop">
          <span class="wmIc">${t.icon||''}</span>
          <span class="wmNm">${escapeHtml(t.name||'')}</span>
        </div>
        ${badge}
      </div>
    `;
  }

  // tokens
  const tokenHtml = players.filter(p=>!p.bankrupt).map(p=>{
    const g = wmPosToGrid_(p.pos||0);
    const c = wmColorFor_(p.id);
    return `<div class="wmToken" style="grid-row:${g.r}; grid-column:${g.c}; --tokc:${c}" title="${escapeAttr(p.name||'')}">${p.token||'ğŸ™‚'}</div>`;
  }).join('');

  // dice ui
  const diceUI = pending ? `
    <div class="wmDiceRow">
      <div class="wmDice rolling">${wmDiceChar_(pending.d1)}</div>
      <div class="wmDice rolling">${wmDiceChar_(pending.d2)}</div>
      <div class="wmDiceSum">= ${pending.total}</div>
    </div>
    <div class="wmDiceHint">ì£¼ì‚¬ìœ„ êµ´ë¦¬ëŠ” ì¤‘â€¦ (2ì´ˆ)</div>
  ` : `
    <div class="wmDiceRow">
      <div class="wmDice">${wmDiceChar_(1)}</div>
      <div class="wmDice">${wmDiceChar_(6)}</div>
      <div class="wmDiceSum">ğŸ²</div>
    </div>
    <div class="wmDiceHint">${myTurn ? 'ë‚´ ì°¨ë¡€! êµ´ë¦¬ê¸° GO' : 'ëŒ€ê¸° ì¤‘â€¦'}</div>
  `;

  // controls (safe wrappers: auth+init)
  const startBtn = (!st.started || st.ended) ? `<button class="btn wmBtn" onclick="marbleStartSafe_()">ê²Œì„ ì‹œì‘</button>` : '';
  const endBtn   = (st.started && !st.ended) ? `<button class="btn wmBtn ghost" onclick="marbleEndSafe_()">ë¦¬ì…‹</button>` : '';
  const joinBtn  = (!me) ? `<button class="btn wmBtn" onclick="marbleJoinSafe_()">ì°¸ì—¬í•˜ê¸°</button>` : `<button class="btn wmBtn ghost" onclick="marbleLeaveSafe_()">ë‚˜ê°€ê¸°</button>`;
  const rollBtn  = (st.started && !st.ended) ? `<button class="btn wmBtn ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="marbleRollSafe_()">ğŸ² êµ´ë¦¬ê¸°</button>` : '';
  const loanBtns = (st.started && !st.ended) ? `
      <button class="btn wmBtn ghost ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="wmLoanSafe_()">ğŸ¦ ëŒ€ì¶œ</button>
      <button class="btn wmBtn ghost ${myTurn?'':'disabled'}" ${myTurn?'':'disabled'} onclick="wmRepaySafe_()">âœ… ìƒí™˜</button>
  ` : '';

  // strip: top3 + last log
  const top3 = players.slice(0,3).map((p,i)=>`<span class="wmChip">${i+1}ìœ„ ${p.token||'ğŸ™‚'} ${escapeHtml(p.name||'')}</span>`).join('');
  const lastLog = (st.lastLog||[]).slice(-1)[0]?.msg || '';
  const strip = `
    <div class="wmStrip">
      <div class="wmStripLeft">${top3 || '<span class="wmChip muted">ì°¸ê°€ìê°€ ì—†ì–´ìš”</span>'}</div>
      <div class="wmStripRight">${lastLog ? ('ğŸ—’ï¸ '+escapeHtml(lastLog)) : '<span class="muted">ë¡œê·¸ê°€ ì•„ì§ ì—†ì–´ìš”</span>'}</div>
    </div>
  `;

  const winBanner = st.ended && st.winner ? (()=>{ 
    const w = (wmPlayers_||{})[st.winner];
    const wn = w ? (w.name||'ìš°ìŠ¹ì') : 'ìš°ìŠ¹ì';
    return `<div class="wmWin">ğŸ† ${escapeHtml(wn)} ìš°ìŠ¹!</div>`;
  })() : '';

  const html = `
    <div class="wmWrap wmMini">
      <div class="wmHeader">
        <div class="wmTitle">ğŸ² ë¶€ë£¨ë§ˆë¸”(ê¸€ììˆ˜) ğŸ</div>
        <div class="wmSub">10ë°”í€´ ì„ ì°© ë˜ëŠ” ë§ˆì§€ë§‰ ìƒì¡´! Â· ì‹œì‘ ${wmFmt_(WM_START_MONEY_)}ì</div>
      </div>

      ${winBanner}

      <div class="wmHud">
        <div class="wmTurnPill">
          <span class="wmTurnLabel">í˜„ì¬ í„´</span>
          <span class="wmTurnName">${turnPl ? `${escapeHtml(turnPl.name||'')} ${turnPl.token||''}` : 'ëŒ€ê¸°'}</span>
        </div>
        <div class="wmControls">
          ${joinBtn}
          ${startBtn}
          ${rollBtn}
          ${loanBtns}
          ${endBtn}
        </div>
      </div>

      ${strip}

      <div class="wmDicePanel">${diceUI}</div>

      <div class="wmBoardArea">
        <div class="wmBoard wmBoardScaled wmMiniBoard">
          ${cellsHtml}
          ${tokenHtml}
          <div class="wmCenterLogo">BOOM MARBLE</div>
        </div>
      </div>

      <div class="wmFoot">
        <div class="wmRulePill">ğŸ“Œ ë‚´ ì°¨ë¡€ì—ë§Œ êµ´ë¦¬ê¸°</div>
        <div class="wmRulePill">ğŸ START í†µê³¼ +${wmFmt_(WM_PASS_START_BONUS_)}ì</div>
        <div class="wmRulePill">ğŸ¦ ëŒ€ì¶œ ${WM_MAX_LOANS_}íšŒ</div>
        <div class="wmRulePill">ğŸ—ï¸ ê°™ì€ ë•… 2~3ë²ˆ ë°Ÿìœ¼ë©´ ëœë“œë§ˆí¬ ì—…!</div>
      </div>
    </div>
  `;

  showOverlayHtml('ğŸ² ë¶€ë£¨ë§ˆë¸”(ê¸€ììˆ˜) ğŸ', html, true);
  try{ wmBindWheelZoom_(); }catch(e){}
  try{ wmFitBoard_(); }catch(e){}
  try{ wmKickDiceAnim_(); }catch(e){}
}

function openMarble_(){
  if(!sessionId) return;

  // âœ… ê°™ì€ ìˆ˜ë‹¤ë°©(sessionId)ì—ì„œ ëª¨ë‘ í•œ ë°©ìœ¼ë¡œ ì…ì¥ (ìƒˆì°½/ìƒˆíƒ­)
  // âœ… GitHub Pages(ì •ì  í˜¸ìŠ¤íŒ…)ë¡œ ì—´ì–´ì„œ GAS/Drive ê¶Œí•œ ë¬¸ì œë¥¼ ì œê±°
  const MARBLE_URL_ = 'https://magammm1009.github.io/mmaabbbb1009/'; // ëì— / ìœ ì§€ ê¶Œì¥
  const sid = String(sessionId || '').trim();
  const gs  = 'G' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).slice(2,8).toUpperCase();

  // í•­ìƒ ìƒˆ íŒ: sid/room + gs(ê²Œì„ì„¸ì…˜) í¬í•¨
  const src = `${MARBLE_URL_}?sid=${encodeURIComponent(sid)}&room=${encodeURIComponent(sid)}&gs=${encodeURIComponent(gs)}`;

  // ğŸ”” ì‹œì‘ ì‹œìŠ¤í…œ ë©”ì‹œì§€(ë²„íŠ¼ í´ë¦­ ìˆœê°„)
  try{ pushSystem_(`ğŸ² ë¶€ë£¨ë§ˆë¸”ì´ ì‹œì‘ëì–´ìš”! (ë°©: ${sid})`); }catch(e){}

  // íŒì—… ì°¨ë‹¨ ëŒ€ë¹„: ìƒˆì°½ì´ ë§‰íˆë©´ ëª¨ë‹¬ë¡œ ë§í¬ ì•ˆë‚´
  const w = window.open(src, '_blank', 'noopener,noreferrer');
  if(!w){
    showOverlayHtml('ğŸ² ë¶€ë£¨ë§ˆë¸”', `
      <div class="hint" style="margin:8px 0 10px;">
        ë¸Œë¼ìš°ì €ì—ì„œ ìƒˆì°½ì´ ì°¨ë‹¨ë˜ì–´ ë§í¬ë¡œ ì•ˆë‚´í• ê²Œìš”. (íŒì—… í—ˆìš©í•˜ë©´ ìë™ìœ¼ë¡œ ìƒˆì°½ì´ ì—´ë ¤ìš”!)
      </div>
      <a href="${src}" target="_blank" rel="noopener noreferrer"
         class="btn" style="display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px dashed var(--line);border-radius:999px;background:var(--chip);text-decoration:none;">
        ğŸ² ë¶€ë£¨ë§ˆë¸” ìƒˆì°½ ì—´ê¸°
      </a>
    `, true);
  }
}


// =====================
// Writer Marble: window â†” window bridge (postMessage)
// - ê²Œì„ì°½(index.html)ì—ì„œ GAME_OVERë¥¼ ë³´ë‚´ë©´, ìˆ˜ë‹¤ë°©ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ê¸°ë¡
// =====================
(function installMarbleBridge_(){
  if (window.__marbleBridgeInstalled) return;
  window.__marbleBridgeInstalled = true;

  window.addEventListener('message', (ev)=>{
    try{
      const d = ev && ev.data;
      if (!d || d.source !== 'WRITER_MARBLE') return;

      if (d.type === 'GAME_OVER'){
        const winner = (d.winnerName || d.winnerId || 'ì•Œ ìˆ˜ ì—†ìŒ');
        const emoji  = (d.winnerEmoji || 'ğŸ†');
        const reason = (d.reason || 'ê²Œì„ ì¢…ë£Œ');
        try{ pushSystem_(`${emoji} ë¶€ë£¨ë§ˆë¸” ì¢…ë£Œ! ìŠ¹ì: ${winner} (${reason})`); }catch(e){}
      }
    }catch(e){}
  });
})();




// --- Safe wrappers: auth + init ë³´ì¥
async function marbleEnsure_(){
  if (!sessionId) throw new Error('no session');
  await window.FB.ensureAnonAuth();
  try{ window.__presenceId = (window.FB && window.FB.auth && window.FB.auth.currentUser && window.FB.auth.currentUser.uid) || window.__presenceId || ''; }catch(e){}
  if (!wmPlayersUnsub_ || !wmStateUnsub_) initWriterMarble_(sessionId);
  await wmEnsureInit_(sessionId);
}

async function marbleJoinSafe_(){ try{ await marbleEnsure_(); await wmJoin_(); renderWriterMarbleOverlay_(); }catch(e){} }
async function marbleLeaveSafe_(){ try{ await marbleEnsure_(); await wmLeaveMe_(); renderWriterMarbleOverlay_(); }catch(e){} }
async function marbleRollSafe_(){ try{ await marbleEnsure_(); await wmRoll_(); }catch(e){} }
async function marbleStartSafe_(){ try{ await marbleEnsure_(); await wmStartGame_(); }catch(e){} }
async function marbleEndSafe_(){ try{ await marbleEnsure_(); await wmEndGame_(); }catch(e){} }
async function wmLoanSafe_(){ try{ await marbleEnsure_(); await wmLoan_(); }catch(e){} }
async function wmRepaySafe_(){ try{ await marbleEnsure_(); await wmRepay_(); }catch(e){} }

window.openMarble_ = openMarble_;
window.marbleJoinSafe_ = marbleJoinSafe_;
window.marbleLeaveSafe_ = marbleLeaveSafe_;
window.marbleRollSafe_ = marbleRollSafe_;
window.marbleStartSafe_ = marbleStartSafe_;
window.marbleEndSafe_ = marbleEndSafe_;
window.wmLoanSafe_ = wmLoanSafe_;
window.wmRepaySafe_ = wmRepaySafe_;


const GUIDE_TEXT_ = `ğŸ’£ìì •ì— í­íŒŒë˜ëŠ” ìˆ˜ë‹¤ë°©ì…ë‹ˆë‹¤ğŸ’£

24ì‹œê°„ì˜ ëŒ€í™” ê¸°ë¡ë§Œ ìœ ì§€ë˜ë‹¤ê°€ ë¦¬ì…‹ë˜ëŠ” ë°©ì´ì—ìš”

ğŸ“Œê³µì§€ ì˜†ì— ìŸˆê·¼ ë²„íŠ¼ë“¤ì„ ëˆ„ë¥´ë©´ ê°€ì´ë“œ í™•ì¸ ê°€ëŠ¥í•˜ê³ ,
ì±—ì°½ ê¸¸ì´ì™€ ê¸€ì”¨ ì¡°ì ˆë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

!â˜°ë©”ë‰´ ë²„íŠ¼ì„ ëˆ„ë¥´ì‹œë©´ìˆ˜ë‹¤ë°©ì— ê³„ì‹  ì‘ê°€ë‹˜ë“¤ê³¼ 
ğŸµBGMì„ ê°™ì´ ë“¤ì„ ìˆ˜ ìˆì–´ìš”!
ğŸ§ DJëŠ” ëˆ„êµ¬ë‚˜ ê°€ë„!
ëŒ€ì‹  BGM ê°™ì´ ë“£ê¸°ë¥¼ í—ˆìš©í•´ì•¼ ë…¸ë˜ê°€ ë“¤ë¦½ë‹ˆë‹¤ ><

ğŸ“Œì‘ì—…í•˜ì‹œë‹¤ê°€ ì‰¬ê³  ì‹¶ê±°ë‚˜, 
ğŸ“Œì—¬ìœ ê°€ ìˆì–´ì„œ ì‘ê°€ë‹˜ë“¤ì´ë‘ ì†Œí†µí•˜ê³  ì‹¶ê±°ë‚˜,
ğŸ“Œê°€ë³ê²Œ ì•„ì ì €ë©”ì¶” ê°™ì€ ê²Œ ë°›ê³  ì‹¶ì„ ë•Œë‚˜!
ğŸ“Œê½‰ ë§‰í˜€ì„œ ìˆ˜ë‹¤ë¥¼ ì¢€ ë–¨ê³  ì‹¶ì„ë•Œ ë“±ë“±ë“±ë“± 
ğŸ“Œììœ ë¡­ê²Œ ëª¨ì—¬ì„œ ìˆ˜ë‹¤ë¥¼ ë– ì‹œë©´ ë©ë‹ˆë‹¤.

ğŸš«ì•ˆ ë˜ëŠ” ê²ƒğŸš«
ğŸ“Œëš±ì­í•œ ë¶ˆí–‰ë°°í‹€
ğŸ“Œì•ˆë¬¼ì•ˆê¶ TMI
ğŸ“Œê³¼ë„í•œ ì‹ ìƒìºë¬»ê¸°
ğŸ“Œë¶ˆëª…í™•í•œ ì¹´ë”ë¼ í†µì‹  ì „íŒŒ

ğŸŒ¸ê·¸ ì™¸ì—ëŠ” ììœ ë¡­ê²Œ ì†Œí†µí•˜ì‹œë©´ ë©ë‹ˆë‹¤ğŸŒ¸
ğŸ“ŒPC/ëª¨ë°”ì¼ ìƒê´€ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥
ğŸ“Œë¶ˆí¸í•œ ì ì´ ìˆê±°ë‚˜ ê¸°ëŠ¥ì„ ìƒˆë¡œ ë„£ê³  ì‹¶ì€ ê²Œ ìˆë‹¤ë©´
ğŸ“Œêµ¬í˜„ ê°€ëŠ¥í•œ ì„ ì—ì„œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•˜ë‹ˆ
ğŸ“Œë°”ë¡œ ë§ì”€í•´ ì£¼ì‹œê¸°~

ğŸŒ¸í¸í•˜ê²Œ ê° í†¡ ì£¼ì‹­ì…”!ğŸŒ¸


ğŸ’¡ ì‚¬ìš©ë²• ë¹ ë¥¸ ê°€ì´ë“œ

 1) ì±„íŒ…
â€¢ Enter = ì „ì†¡ / Shift+Enter = ì¤„ë°”ê¿ˆ
â€¢ ë‹‰ë„¤ì„ ë¨¼ì € ì„¤ì •!
      
2) ëª…ë ¹ì–´
â€¢ /ëª…ë ¹ì–´ ë˜ëŠ” /ë„ì›€ë§ : ì „ì²´ ëª©ë¡
 â€¢ /ì™„ê²°, /ì¶•í•˜, /í•˜íŠ¸, /ë°˜ì§, /ëˆˆê½ƒ, /ë°•ìˆ˜ â€¦ (ì´í™íŠ¸!)
      
3) íƒ€ì´í•‘ ë ˆì´ìŠ¤

â€¢ ìƒë‹¨ì˜ âŒ¨ï¸ ë ˆì´ìŠ¤ ë²„íŠ¼ â†’ ë‚œì´ë„ ì„ íƒ â†’ ì‹œì‘!
â€¢ ë¬¸êµ¬ê°€ ëœ¨ë©´, ì•„ë˜ ë ˆì´ìŠ¤ ì…ë ¥ì¹¸ì— ê·¸ëŒ€ë¡œ íƒ€ì´í•‘í•˜ì„¸ìš”.
â€¢ 1ë“±ì—ê²ŒëŠ” í­ì£½ + ë°˜ì§ + ë¶ì—…ì´ í„°ì§‘ë‹ˆë‹¤âœ¨

ğŸ“Œì´ ë°©ì€ ìì • í­íŒŒ ì‹œ ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ë°”ë€Œê³ , ëŒ€í™”ëŠ” ì €ì¥ë˜ì§€ ì•Šì•„ìš”.`;

function showGuide_(){
  const html = `
    <div class="guideWrap">
      <div class="guideHead">
        <div class="guideBadge">ğŸ§­ GUIDE</div>
        <div class="guideTitle">ìˆ˜ë‹¤ë°© ê°€ì´ë“œ</div>
      </div>
      <pre class="guidePre">${escapeHtml(GUIDE_TEXT_)}</pre>
    </div>
  `;
  showOverlayHtml('ğŸ§­ ê°€ì´ë“œ', html, true);
}
function computePresenceFromConn_(val){
    const now = Date.now();
    const items = [];
    const obj = val || {};
    for (const uid of Object.keys(obj)){
      const conns = obj[uid] || {};
      let best = null;
      for (const cid of Object.keys(conns)){
        const v = conns[cid];
        if (!v || !v.ts) continue;
        const ts = Number(v.ts);
        if (!Number.isFinite(ts)) continue;
        if ((now - ts) > PRESENCE_STALE_MS) continue;
        if (!best || ts > best.ts){
          best = { uid, name: String(v.name || 'ìµëª…').trim().slice(0,12), ts };
        }
      }
      if (best) items.push(best);
    }
    // ì¤‘ë³µ ë‹‰ë„¤ì„ disambiguate
    const counts = {};
    items.forEach(it => counts[it.name] = (counts[it.name]||0) + 1);
    const names = items.map(it => (counts[it.name] > 1) ? `${it.name}Â·${String(it.uid).slice(-4)}` : it.name);
    return { count: names.length, names };
  }

  // =====================
  // Notice (Firebase)
  // =====================
  function initNotice_(roomId){
    // rooms/<roomId>/notice = { text, updatedAt, by }
    try{
      if (noticeUnsub_) noticeUnsub_();
    }catch(e){}
    noticeUnsub_ = null;

    const p = NOTICE_PATH_(roomId);
    const noticeRef = window.FB.ref(window.FB.db, p);

    noticeUnsub_ = window.FB.onValue(noticeRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || {}) : {};
      noticeCache_ = {
        text: String(v.text || ''),
        updatedAt: Number(v.updatedAt || 0),
        by: String(v.by || '')
      };
      updateNoticePreview_();
      maybePopupNotice_();
    });
  }

  function firstLine_(t){
    const s = String(t || '').replace(/\r/g,'').trim();
    if (!s) return '';
    return s.split('\n')[0].trim();
  }

  function updateNoticePreview_(){
    const t = (noticeCache_.text || '').trim();
    const pv = $('noticePreview');
    if (pv) pv.textContent = t ? firstLine_(t) : 'ê³µì§€ ì—†ìŒ';
    const ts = $('noticeTs');
    if (ts) ts.textContent = fmtNoticeTs_(noticeCache_.updatedAt);
  }

  function maybePopupNotice_(){
    const t = (noticeCache_.text || '').trim();
    if (!t){
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      return;
    }

    const lastSeen = Number(localStorage.getItem(NOTICE_LS_KEY_) || 0);
    const updatedAt = Number(noticeCache_.updatedAt || 0);

    // âœ… ìƒˆ ê³µì§€: ìë™ íŒì—… ëŒ€ì‹  "í•€ ë‹¬ë‘ë‹¬ë‘"
    if (updatedAt && updatedAt > lastSeen){
      try{ $('btnNoticePin')?.classList.add('pinNew'); }catch(e){}
    }else{
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
    }
  }

  
  // =====================
  // Notice (Firebase) + Admin-only edit
  // =====================
  // âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(í•´ì‹œ) ì„¤ì •:
  // 1) ì•„ë˜ NOTICE_ADMIN_PW_SHA256_ ì— SHA-256 í•´ì‹œ(ì†Œë¬¸ì 64ìë¦¬)ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”.
  // 2) í•´ì‹œëŠ” ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ:  await sha256Hex_('ì›í•˜ëŠ”ë¹„ë²ˆ')  ë¡œ ì‰½ê²Œ ì–»ì„ ìˆ˜ ìˆì–´ìš”.
  const NOTICE_ADMIN_PW_SHA256_ = '5d6d5393f040bd92c36b7a791f80b1c8827125715a392c57725f74df89458df7'; // <- ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°
  const NOTICE_ADMIN_SS_KEY_ = 'VENT_NOTICE_ADMIN_OK_V1';

  async function sha256Hex_(str){
    const enc = new TextEncoder().encode(String(str ?? ''));
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,'0')).join('');
  }
  // âœ… ì½˜ì†”/ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ì—ì„œ ì“°ë„ë¡ ì „ì—­ ë…¸ì¶œ
  window.sha256Hex_ = sha256Hex_;
  window.makeNoticeHash = async function(pw){
    const h = await sha256Hex_(pw);
    console.log(h);
    return h;
  };


  function isNoticeAdmin_(){
    try{ return localStorage.getItem(NOTICE_ADMIN_SS_KEY_) === '1'; }catch(e){ return false; }
  }

  async function noticeEnsureAdmin_(){
    if (isNoticeAdmin_()) return true;

    // í•´ì‹œê°€ ë¹„ì–´ ìˆìœ¼ë©´(ì„¤ì • ì „), í¸ì§‘ì„ ë§‰ìŠµë‹ˆë‹¤.
    if (!NOTICE_ADMIN_PW_SHA256_){
      alert('âš ï¸ ê³µì§€ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(í•´ì‹œ)ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì½”ë“œì˜ NOTICE_ADMIN_PW_SHA256_ ê°’ì„ ë¨¼ì € ì±„ì›Œ ì£¼ì„¸ìš”.');
      return false;
    }

    const pw = prompt('ğŸ”’ ê³µì§€ ì‘ì„±ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if (pw == null) return false;

    try{
      const h = await sha256Hex_(pw);
      if (h === NOTICE_ADMIN_PW_SHA256_){
        try{ localStorage.setItem(NOTICE_ADMIN_SS_KEY_, '1'); }catch(e){}
        alert('âœ… ê´€ë¦¬ì ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        return true;
      }
    }catch(e){}

    alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return false;
  }

  function fmtNoticeTs_(ms){
    const n = Number(ms || 0);
    if (!n) return 'â€”';
    try{
      const d = new Date(n);
      // í•œêµ­ì‹ ë³´ê¸° ì¢‹ê²Œ
      return d.toLocaleString('ko-KR', { hour12:false });
    }catch(e){
      return String(n);
    }
  }

  function noticeViewHtml_(){
    const t = (noticeCache_.text || '').trim();
    const meta = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${fmtNoticeTs_(noticeCache_.updatedAt)} Â· ì‘ì„±ì: ${escapeHtml((noticeCache_.by || '')) || 'â€”'}`;
    const body = escapeHtml(t || 'ê³µì§€ ì—†ìŒ');
    const adminHint = isNoticeAdmin_()
      ? `<button class="miniBtn" type="button" onclick="window.noticeStartEdit_()">âœï¸ ê³µì§€ ìˆ˜ì •</button>`
      : `<button class="miniBtn" type="button" onclick="window.noticeStartEdit_()">ğŸ”’ ê´€ë¦¬ì ê³µì§€ ì‘ì„±</button>`;

    return `
      <div class="noticeBox">
        <div class="noticeMeta">${meta}</div>
        <div class="noticeText">${body}</div>
        <div class="noticeActions">
          ${adminHint}
        </div>
      </div>
    `;
  }

  function noticeEditHtml_(initial){
    const safe = escapeHtml(String(initial ?? ''));
    return `
      <div class="noticeBox">
        <div class="noticeMeta">ê´€ë¦¬ì ëª¨ë“œ Â· ê³µì§€ë¥¼ ì‘ì„±/ìˆ˜ì •í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <textarea id="noticeEditArea" class="noticeEditArea" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.\n(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)">${safe}</textarea>
        <div class="noticeActions">
          <button class="miniBtn" type="button" onclick="window.noticeSave_()">ğŸ’¾ ì €ì¥</button>
          <button class="miniBtn" type="button" onclick="window.noticeCancelEdit_()">ì·¨ì†Œ</button>
        </div>
        <div class="noticeHelp">â€» ì €ì¥í•˜ë©´ ëª¨ë“  ì ‘ì†ìì—ê²Œ â€˜ìƒˆ ê³µì§€â€™ë¡œ í‘œì‹œë˜ê³ , ë‹¤ìŒì— ë“¤ì–´ì˜¨ ë¶„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
    `;
  }

  async function noticeStartEdit_(){
    const ok = await noticeEnsureAdmin_();
    if (!ok) return;
    showOverlayHtml('ğŸ“Œ ê³µì§€ (ê´€ë¦¬ì)', noticeEditHtml_((noticeCache_.text || '').trim()));
  }

  async function noticeSave_(){
    const ta = document.getElementById('noticeEditArea');
    if (!ta) return;
    const textVal = String(ta.value || '').replace(/\r/g,'').trim();
    try{
      if (!sessionId) return;
      await window.FB.ensureAnonAuth();
      const ref_ = window.FB.ref(window.FB.db, NOTICE_PATH_(sessionId));
      const payload = { text: textVal, updatedAt: Date.now(), by: serverName_().slice(0,12) };
      await window.FB.set(ref_, payload);
      // ì €ì¥ ì„±ê³µ -> ë³´ê¸°ë¡œ
      showOverlayHtml('ğŸ“Œ ê³µì§€', noticeViewHtml_());
    }catch(e){
      console.warn('noticeSave failed', e);
      alert('ê³µì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬/ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
    }
  }

  function noticeCancelEdit_(){
    showOverlayHtml('ğŸ“Œ ê³µì§€', noticeViewHtml_());
  }

  // ì „ì—­ ë°”ì¸ë”©(ì˜¤ë²„ë ˆì´ì˜ inline onclickì—ì„œ ì‚¬ìš©)
  window.noticeStartEdit_ = noticeStartEdit_;
  window.noticeSave_ = noticeSave_;
  window.noticeCancelEdit_ = noticeCancelEdit_;

  function showNoticeManual_(){
    openNotice_();
  }

  function openNotice_(){
    const t = (noticeCache_.text || '').trim();
    const updatedAt = Number(noticeCache_.updatedAt || 0);
    if (!t){
      showOverlay('ğŸ“Œ', 'ë“±ë¡ëœ ê³µì§€ê°€ ì—†ì–´ìš”.');
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      return;
    }

    // ì—´ ë•ŒëŠ” ìë™ "ì½ìŒ" ì²˜ë¦¬ X â†’ ë‹«ì„ ë•Œ ì²˜ë¦¬
    showOverlayHtml('ğŸ“Œ', noticeViewHtml_());

    // ë‹«ëŠ” ìˆœê°„ ì½ìŒ ì²˜ë¦¬ + í•€ í”ë“¤ë¦¼ ì¢…ë£Œ
    const oldHide = window.hideOverlay;
    window.hideOverlay = function(){
      try{
        if (updatedAt) localStorage.setItem(NOTICE_LS_KEY_, String(updatedAt));
      }catch(e){}
      try{ $('btnNoticePin')?.classList.remove('pinNew'); }catch(e){}
      window.hideOverlay = oldHide;
      oldHide();
    };
  }
// =====================
// Identity (nickname -> emoji/color)
// =====================
const LS_PROFILE_PREFIX = 'VENT_NICK_PROFILE_V1:';
const NICK_EMOJIS = ['ğŸ£','ğŸ°','ğŸ±','ğŸ¶','ğŸ¦Š','ğŸ¼','ğŸ¯','ğŸ¸','ğŸµ','ğŸ»','ğŸ¹','ğŸ¦','ğŸ¦„','ğŸ™','ğŸ¦‹','ğŸ§¸','ğŸ€','ğŸŒ™','â­','ğŸ”¥','ğŸ’«','ğŸ€','ğŸ“','ğŸ‘','ğŸ‹','ğŸ‡','ğŸ‰','ğŸ¥','ğŸ™','ğŸœ','â˜•','ğŸ§','ğŸ®','ğŸ“š','âœï¸','ğŸ¬'];
const NICK_COLORS = ['#ff4d6d','#ff7a00','#ffb703','#38b000','#00b4d8','#1d4ed8','#6d28d9','#b5179e','#ef476f','#06d6a0','#118ab2','#ffd166'];

function hashStr_(s){
  const str = String(s || '');
  let h = 2166136261;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
  }
  return h >>> 0;
}

function randPick_(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getNickProfile_(name, createIfMissing){
  const nm = String(name || '').trim().slice(0,12) || 'ìµëª…';
  const key = LS_PROFILE_PREFIX + nm;
  try{
    const raw = localStorage.getItem(key);
    if (raw){
      const obj = JSON.parse(raw);
      if (obj && obj.emoji && obj.color) return obj;
    }
  }catch(e){}

  // fallback deterministic (if not creating)
  if (!createIfMissing){
    const h = hashStr_(nm);
    return { emoji: NICK_EMOJIS[h % NICK_EMOJIS.length], color: NICK_COLORS[h % NICK_COLORS.length] };
  }

  const prof = { emoji: randPick_(NICK_EMOJIS), color: randPick_(NICK_COLORS) };
  try{ localStorage.setItem(key, JSON.stringify(prof)); }catch(e){}
  return prof;
}

function myUid_(){ return window.FB?.auth?.currentUser?.uid || null; }
function myProfile_(){ return getNickProfile_(myName(), true); }

function hexToRgba_(hex, a){
  const h = String(hex || '').replace('#','').trim();
  if (h.length !== 6) return `rgba(0,0,0,${a})`;
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

// =====================
// System message helper
// =====================

async function pushEvent_(payload){
  if (!sessionId) return;
  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
    const msgRef = window.FB.push(root);
    const p = payload || {};
    p.ts = p.ts || Date.now();
    if (!p.type) p.type = 'event';
    await window.FB.set(msgRef, p);
  }catch(e){
    console.warn('pushEvent failed', e);
  }
}

function launchFireworks_(kind, byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const title = document.createElement('div');
  title.className = 'fxTitle';
  const who = byName ? ` Â· ${byName}` : '';
  title.textContent = (kind === 'complete') ? `ğŸ† ì™„ê²°!${who}` : (kind === 'race') ? `âŒ¨ï¸ íƒ€ì´í•‘ ë ˆì´ìŠ¤ ğŸ${who}` : (kind === 'acid') ? `â˜” ì‚°ì„±ë¹„ TOP3!${who}` : `ğŸ‰ ì¶•í•˜!${who}`;
  document.body.appendChild(title);

  const W = window.innerWidth;
  const H = window.innerHeight;

  function rand(min, max){ return min + Math.random() * (max - min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const colors = ['#ff4d6d','#ff7a00','#ffb703','#38b000','#00b4d8','#1d4ed8','#6d28d9','#b5179e','#06d6a0','#ffd166'];

  const bursts = 6;
  const sparksPer = 26;

  for (let b=0;b<bursts;b++){
    const cx = rand(W*0.18, W*0.82);
    const cy = rand(H*0.20, H*0.55);

    for (let i=0;i<sparksPer;i++){
      const sp = document.createElement('div');
      sp.className = 'spark';
      sp.style.left = cx + 'px';
      sp.style.top = cy + 'px';
      sp.style.background = pick(colors);

      const ang = rand(0, Math.PI*2);
      const dist = rand(80, 240);
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist;

      sp.style.setProperty('--dx', `${dx}px`);
      sp.style.setProperty('--dy', `${dy}px`);

      sp.style.animationDelay = `${rand(0, 220)}ms`;
      sp.style.animationDuration = `${rand(900, 1400)}ms`;

      layer.appendChild(sp);
    }
  }

  setTimeout(()=>{
    try{ layer.remove(); }catch(e){}
    try{ title.remove(); }catch(e){}
  }, 1700);
}


function launchHearts_(byName){
  const layer = document.createElement('div');
  layer.className = 'heartLayer';
  document.body.appendChild(layer);

  // small title pill (reuse fxTitle styling if exists)
  const title = document.createElement('div');
  title.className = 'fxTitle';
  const who = byName ? ` Â· ${byName}` : '';
  title.textContent = `ğŸ’— ì…ì¥!${who}`;
  document.body.appendChild(title);

  const W = window.innerWidth;
  const H = window.innerHeight;

  function rand(min, max){ return min + Math.random() * (max - min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const hearts = ['ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’'];
  const bursts = 28;

  for (let i=0;i<bursts;i++){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = pick(hearts);

    const cx = W * 0.5 + rand(-W*0.18, W*0.18);
    const cy = H * 0.78 + rand(-40, 40);
    h.style.left = cx + 'px';
    h.style.top  = cy + 'px';

    const ang = rand(-Math.PI*0.85, -Math.PI*0.15); // upward-ish
    const dist = rand(120, 320);
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    const rot = rand(-18, 18);

    h.style.setProperty('--dx', `${dx}px`);
    h.style.setProperty('--dy', `${dy}px`);
    h.style.setProperty('--rot', `${rot}deg`);
    h.style.animationDelay = `${rand(0, 220)}ms`;
    h.style.animationDuration = `${rand(1100, 1600)}ms`;
    h.style.fontSize = `${rand(16, 26)}px`;

    layer.appendChild(h);
  }

  setTimeout(()=>{
    try{ layer.remove(); }catch(e){}
    try{ title.remove(); }catch(e){}
  }, 1700);
}



function launchHeartsNearEl_(el){
  try{
    if (!el) return;
    const rect = el.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + Math.min(rect.height, 64) / 2;

    const layer = document.createElement('div');
    layer.className = 'heartLayer';
    document.body.appendChild(layer);

    function rand(min, max){ return min + Math.random() * (max - min); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    const hearts = ['ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’','â¤ï¸'];
    const bursts = 18;

    for (let i=0;i<bursts;i++){
      const h = document.createElement('div');
      h.className = 'heart';
      h.textContent = pick(hearts);

      h.style.left = (cx + rand(-28, 28)) + 'px';
      h.style.top  = (cy + rand(-10, 10)) + 'px';

      const ang = rand(-Math.PI*0.95, -Math.PI*0.10);
      const dist = rand(60, 160);
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist;
      const rot = rand(-22, 22);

      h.style.setProperty('--dx', `${dx}px`);
      h.style.setProperty('--dy', `${dy}px`);
      h.style.setProperty('--rot', `${rot}deg`);
      h.style.animationDelay = `${rand(0, 140)}ms`;
      h.style.animationDuration = `${rand(900, 1200)}ms`;
      h.style.fontSize = `${rand(14, 24)}px`;

      layer.appendChild(h);
    }

    setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1400);
  }catch(e){
    console.warn('launchHeartsNearEl failed', e);
  }
}





// =====================
// FX2 preset mapping (shared for everyone)
// =====================
function launchFx2_(kind, byName){
  const k = String(kind || '').trim();

  const presets = {
    // new + existing
    welcome:  { emojis:['ğŸ€','âœ¨','ğŸ’—','ğŸŒ™','â­'], mode:'twinkle', title:'ğŸ€ í™˜ì˜' },
    pepper:   { emojis:['ğŸŒ¶ï¸','ğŸ”¥','ğŸ’¥','âœ¨'], mode:'pop',     title:'ğŸŒ¶ï¸ ê³ ì¶”ë ¥' },
    kiss:     { emojis:['ğŸ’‹','ğŸ’—','ğŸ’˜','ğŸ’•','ğŸ˜˜'], mode:'pop', title:'ğŸ’‹ ë½€ë½€' },
    boomup:   { emojis:['ğŸ“£','ğŸ”¥','ğŸ’¥','âœ¨','ğŸ‰'], mode:'pop', title:'ğŸ“£ ë¶ì—…' },
    confetti: { emojis:['ğŸ‰','ğŸŠ','âœ¨','â­','ğŸ’—'], mode:'pop', title:'ğŸŠ ì¶•í•˜' },
    warning:  { emojis:['âš ï¸','ğŸš¨','ğŸ’¥'], mode:'twinkle',     title:'âš ï¸ ê²½ê³ ', shake:true },
    dance:    { emojis:['ğŸ•º','ğŸ’ƒ','ğŸµ','ğŸ¶','âœ¨'], mode:'pop', title:'ğŸ•º ëŒ„ìŠ¤' },
    deadline: { emojis:['ğŸ“','ğŸ“„','ğŸ§¾','ğŸ’¸','ğŸ˜µâ€ğŸ’«','âŒ›'], mode:'rain', title:'ğŸ§¾ ë§ˆê°' },
    hello:    { emojis:['ğŸ‘‹','âœ¨','ğŸ’—'], mode:'twinkle',      title:'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”' },
    bye:      { emojis:['ğŸŒ™','â­','âœ¨','ğŸ‘‹'], mode:'twinkle',  title:'ğŸŒ™ êµ¿ë°”ì´' },
    nod:      { emojis:['ğŸ‘','ğŸ‘Œ','âœ…','âœ¨'], mode:'pop',      title:'ğŸ‘ ë„ë•' },
    please:   { emojis:['ğŸ™','ğŸ¥º','ğŸ’—','âœ¨'], mode:'twinkle',  title:'ğŸ™ ì œë°œ' },

    // added now
    shy:      { emojis:['ğŸ˜³','ğŸ™ˆ','ğŸ’—','âœ¨','ğŸ«¶'], mode:'twinkle', title:'ğŸ™ˆ ìˆ˜ì¤' },
    reality:  { emojis:['ğŸ˜®â€ğŸ’¨','ğŸ«¥','ğŸŒ«ï¸','ğŸ’­','ğŸ—¿'], mode:'twinkle', title:'ğŸ«¥ í˜„íƒ€' },
    awaken:   { emojis:['âš¡','âœ¨','ğŸ”¥','ğŸ’«','ğŸŒ€'], mode:'pop', title:'âš¡ ê°ì„±' },
    inspire:  { emojis:['ğŸ’¡','âœ¨','ğŸ§ ','ğŸŒŸ','âš¡'], mode:'twinkle', title:'ğŸ’¡ ì˜ê°' },
    revise:   { emojis:['âœï¸','ğŸ“','ğŸ“','ğŸ”','âœ¨'], mode:'rain', title:'âœï¸ í‡´ê³ ' },
    bait:     { emojis:['ğŸ§©','ğŸ«´','ğŸ£','ğŸ‘€','ğŸ’¬'], mode:'pop', title:'ğŸ§© ë–¡ë°¥' },
    binge:    { emojis:['ğŸš€','ğŸ“š','ğŸ’¨','ğŸ”¥','â­'], mode:'twinkle', title:'ğŸš€ ì •ì£¼í–‰' },
    serialize:{ emojis:['ğŸ–‹ï¸','ğŸ“†','âœ¨','ğŸ“Œ','ğŸ’—'], mode:'twinkle', title:'ğŸ–‹ï¸ ì—°ì¬' },
    naked:    { emojis:['ğŸš¿','ğŸ«§','ğŸ’¦','âœ¨','ğŸ™ˆ'], mode:'rain', title:'ğŸš¿ ë‚˜ì²´ìƒ¤ì›Œ' },
  };

  const p = presets[k];
  if (!p){
    // unknown kind -> small sparkle fallback
    launchEmojiBurst_(['âœ¨','ğŸ’«','â­'], 'twinkle', 'âœ¨');
    return;
  }
  if (p.shake) shakeScreen_(700);
  launchEmojiBurst_(p.emojis, p.mode, p.title + (byName ? ` Â· ${byName}` : ''));
}

// =====================
// Emoji Burst FX (for new commands)
// =====================
function launchEmojiBurst_(emojis, mode, titleText){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const list = Array.isArray(emojis) && emojis.length ? emojis : ['âœ¨'];
  const kind = String(mode || 'pop');

  // optional title pill
  let title = null;
  if (titleText){
    title = document.createElement('div');
    title.className = 'fxTitle';
    title.textContent = String(titleText);
    document.body.appendChild(title);
  }

  if (kind === 'rain'){
    const n = 34;
    for (let i=0;i<n;i++){
      const e = document.createElement('div');
      e.className = 'fxEmoji snow';
      e.textContent = pick(list);

      const x = rand(10, W-10);
      e.style.left = x + 'px';
      e.style.top  = rand(-60, -10) + 'px';
      e.style.setProperty('--dx', `${rand(-140,140)}px`);
      e.style.setProperty('--dy', `${H + rand(160, 320)}px`);
      e.style.setProperty('--rot', `${rand(-110,110)}deg`);
      e.style.animationDelay = `${rand(0, 560)}ms`;
      e.style.animationDuration = `${rand(2000, 3000)}ms`;
      e.style.fontSize = `${rand(14, 30)}px`;
      layer.appendChild(e);
    }
    setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 3400);
    return;
  }

  if (kind === 'twinkle'){
    const n = 36;
    for (let i=0;i<n;i++){
      const e = document.createElement('div');
      e.className = 'fxEmoji twinkle';
      e.textContent = pick(list);
      e.style.left = rand(20, W-20) + 'px';
      e.style.top  = rand(H*0.25, H*0.8) + 'px';
      e.style.setProperty('--rot', `${rand(-35,35)}deg`);
      e.style.animationDelay = `${rand(0, 420)}ms`;
      e.style.fontSize = `${rand(16, 32)}px`;
      layer.appendChild(e);
    }
    setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 1800);
    return;
  }

  // default: pop
  const n = 26;
  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji pop';
    e.textContent = pick(list);
    e.style.left = rand(30, W-30) + 'px';
    e.style.top  = rand(H*0.35, H*0.78) + 'px';
    e.style.setProperty('--dx', `${rand(-180,180)}px`);
    e.style.setProperty('--dy', `${rand(-240,-60)}px`);
    e.style.setProperty('--rot', `${rand(-40,40)}deg`);
    e.style.animationDelay = `${rand(0, 260)}ms`;
    e.style.animationDuration = `${rand(900, 1400)}ms`;
    e.style.fontSize = `${rand(18, 36)}px`;
    layer.appendChild(e);
  }
  setTimeout(()=>{ try{ layer.remove(); }catch(e){}; try{ title?.remove(); }catch(e){} }, 1700);
}

// simple screen shake (for warning)
function shakeScreen_(ms){
  const dur = Math.max(300, Math.min(1200, Number(ms||700)));
  document.body.classList.add('shake');
  setTimeout(()=>{ try{ document.body.classList.remove('shake'); }catch(e){} }, dur);
}


// =====================
// Shout ticker (shared)
// =====================// =====================
// Ticker placement (overlay under topbar)
// =====================
function ensureTickerPlaced_(){
  const t = $('ticker');
  if (!t) return;

  // âœ… ì „ê´‘íŒ: í™”ë©´ ì¤‘ì•™ ì˜¤ë²„ë ˆì´ (ë ˆì´ì•„ì›ƒ ì˜í–¥ 0, ë²„íŠ¼/ì…ë ¥ ì•ˆ ë§‰ìŒ)
  t.style.position = 'fixed';
  t.style.left = '50%';
  t.style.top = '50%';
  t.style.transform = 'translate(-50%, -50%)';
  t.style.width = 'auto';
  t.style.maxWidth = 'calc(100vw - 18px)';
  t.style.pointerEvents = 'none';
}


window.addEventListener('resize', ()=>{ try{ ensureTickerPlaced_(); }catch(e){} }, { passive:true });


function showTicker_(byName, text){
  ensureTickerPlaced_();

  const box = $('ticker');
  if (!box) return;

  const by = String(byName || '').trim().slice(0,12) || 'ìµëª…';
  const msg = String(text || '').trim().slice(0, 140);
  if (!msg) return;

  box.classList.add('show');
  box.innerHTML = '';

  const track = document.createElement('div');
  track.className = 'tickerTrack';

  const badge = document.createElement('span');
  badge.className = 'tickerBadge';
  badge.textContent = `ğŸ“£ ${by}ë‹˜`;

  const t = document.createElement('span');
  t.className = 'tickerText';
  t.textContent = msg;

  track.appendChild(badge);
  track.appendChild(t);
  const pill = document.createElement('div');
  pill.className = 'tickerPill';
  pill.appendChild(track);
  box.appendChild(pill);

  const base = 10; // seconds (ì¡°ê¸ˆ ë” ì²œì²œíˆ)
  const extra = Math.min(14, Math.max(0, msg.length / 10));
  const dur = base + extra;
  track.style.animationDuration = `${dur}s`;

  setTimeout(()=>{ 
    try{ box.classList.remove('show'); box.innerHTML=''; }catch(e){}
  }, (dur * 1000) + 250);
}


function showSongTicker_(djName){
  // ì±„íŒ… ìƒë‹¨ ì´í™íŠ¸: "DJê°€ ë…¸ë˜ ì¬ìƒ"ë§Œ í‘œì‹œ(ë§í¬/ì œëª© ë…¸ì¶œ X)
  ensureTickerPlaced_();
  const box = $('ticker');
  if (!box) return;

  const dj = String(djName || '').trim().slice(0,12) || 'DJ';

  box.classList.add('show');
  box.innerHTML = '';

  const track = document.createElement('div');
  track.className = 'tickerTrack';

  const badge = document.createElement('span');
  badge.className = 'tickerBadge songMode';
  badge.textContent = `ğŸ§ DJ ${dj}`;

  const t = document.createElement('span');
  t.className = 'tickerText songMode';
  t.textContent = 'ë…¸ë˜ ì¬ìƒ ì‹œì‘! ğŸ¶';

  track.appendChild(badge);
  track.appendChild(t);

  const pill = document.createElement('div');
  pill.className = 'tickerPill songMode';
  pill.appendChild(track);
  box.appendChild(pill);

  // ì¡°ê¸ˆ ë” ì§§ê³  í™•ì‹¤í•˜ê²Œ
  const dur = 6.5;
  track.style.animationDuration = `${dur}s`;

  setTimeout(()=>{ 
    try{ box.classList.remove('show'); box.innerHTML=''; }catch(e){}
  }, (dur * 1000) + 250);
}

// =====================
// Extra FX commands
// =====================
function launchFx_(kind, byName){
  switch(String(kind||'')){
    case 'hearts': return launchHeartsAll_(byName);
    case 'sparkles': return launchSparkles_(byName);
    case 'snow': return launchSnow_(byName);
    case 'clap': return launchClap_(byName);
    default: return;
  }
}

function launchHeartsAll_(byName){
  const layer = document.createElement('div');
  layer.className = 'heartLayer';
  document.body.appendChild(layer);

  function rand(min,max){ return min + Math.random()*(max-min); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  const hearts = ['ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’','â¤ï¸'];
  const bursts = 42;
  const W = window.innerWidth, H = window.innerHeight;

  for (let i=0;i<bursts;i++){
    const h = document.createElement('div');
    h.className = 'heart';
    h.textContent = pick(hearts);

    const cx = rand(40, W-40);
    const cy = rand(H*0.35, H*0.78);

    h.style.left = cx + 'px';
    h.style.top  = cy + 'px';

    const ang = rand(-Math.PI*1.05, -Math.PI*0.05);
    const dist = rand(80, 220);
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    const rot = rand(-28, 28);

    h.style.setProperty('--dx', `${dx}px`);
    h.style.setProperty('--dy', `${dy}px`);
    h.style.setProperty('--rot', `${rot}deg`);
    h.style.animationDelay = `${rand(0, 220)}ms`;
    h.style.animationDuration = `${rand(950, 1300)}ms`;
    h.style.fontSize = `${rand(16, 28)}px`;

    layer.appendChild(h);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1500);
}

function launchSparkles_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const n = 36;

  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji twinkle';
    e.textContent = 'âœ¨';
    e.style.left = rand(20, W-20) + 'px';
    e.style.top  = rand(H*0.25, H*0.8) + 'px';
    e.style.setProperty('--rot', `${rand(-35,35)}deg`);
    e.style.animationDelay = `${rand(0, 420)}ms`;
    e.style.fontSize = `${rand(16, 30)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1700);
}

function launchSnow_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const flakes = 34;
  const snowChars = ['â„ï¸','â„ï¸','â„ï¸','âœ³ï¸','âœ´ï¸','âœ¨'];

  for (let i=0;i<flakes;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji snow';
    e.textContent = snowChars[Math.floor(Math.random()*snowChars.length)];
    const x = rand(10, W-10);
    e.style.left = x + 'px';
    e.style.top  = rand(-40, -10) + 'px';
    e.style.setProperty('--dx', `${rand(-120,120)}px`);
    e.style.setProperty('--dy', `${H + rand(120, 260)}px`);
    e.style.setProperty('--rot', `${rand(-90,90)}deg`);
    e.style.animationDelay = `${rand(0, 520)}ms`;
    e.style.animationDuration = `${rand(1800, 2600)}ms`;
    e.style.fontSize = `${rand(14, 28)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 3000);
}

function launchClap_(byName){
  const layer = document.createElement('div');
  layer.className = 'fxLayer';
  document.body.appendChild(layer);

  const W = window.innerWidth, H = window.innerHeight;
  function rand(min,max){ return min + Math.random()*(max-min); }
  const n = 22;

  for (let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className = 'fxEmoji pop';
    e.textContent = 'ğŸ‘';
    e.style.left = rand(30, W-30) + 'px';
    e.style.top  = rand(H*0.35, H*0.75) + 'px';
    e.style.setProperty('--dx', `${rand(-160,160)}px`);
    e.style.setProperty('--dy', `${rand(-220,-60)}px`);
    e.style.setProperty('--rot', `${rand(-35,35)}deg`);
    e.style.animationDelay = `${rand(0, 260)}ms`;
    e.style.animationDuration = `${rand(900, 1300)}ms`;
    e.style.fontSize = `${rand(18, 34)}px`;
    layer.appendChild(e);
  }

  setTimeout(()=>{ try{ layer.remove(); }catch(e){} }, 1600);
}


async function pushSystem_(text){
  if (!sessionId) return;
  const t = String(text || '').trim();
  if (!t) return;
  try{
    await window.FB.ensureAnonAuth();
    const root = window.FB.ref(window.FB.db, fbMessagesPath_(sessionId));
    const msgRef = window.FB.push(root);
    await window.FB.set(msgRef, { name:'SYSTEM', text: t.slice(0,2000), ts: Date.now(), type:'system' });
  }catch(e){
    console.warn('pushSystem failed', e);
  }
}


// =====================
// Enter announcement (after nickname is set)
// =====================
let enterAnnounced_ = false;

function isNickConfigured_(){
  const v = ($('user')?.value || '').trim();
  if (!v) return false;
  if (v === 'ìµëª…') return false;
  if (!nickConfirmed_) return false;
  if (!validateNick_(v)) return false;
  return true;
}

function maybeAnnounceEnter_(){
  if (enterAnnounced_) return;
  if (!sessionId) return;
  if (!isNickConfigured_()) return; // ìµëª… ìƒíƒœë©´ ë‹‰ë„¤ì„ ì„¤ì • ì´í›„ì— ì•Œë¦¼
  enterAnnounced_ = true;
  announceEnter_();
}

async function announceEnter_(){
  if (!sessionId) return;

  try{
    await window.FB.ensureAnonAuth();
    const uid = myUid_() || '';
    const nm  = myName().slice(0,12);

    // ì„¸ì…˜/íƒ­ ë‹¨ìœ„ë¡œ 1ë²ˆë§Œ
    const key = `VENT_ENTER_SENT_V1:${sessionId}:${uid || CLIENT_ID}`;
    if (sessionStorage.getItem(key)) return;
    sessionStorage.setItem(key, '1');

    const msg = `ğŸ’— ${nm}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤!`;
    await pushSystem_(msg);
  }catch(e){
    console.warn('announceEnter failed', e);
  }
}


// =====================
// DJ (shared BGM permission)
// =====================
function activePresenceItems_(){
  const now = Date.now();
  const items = [];
  const obj = presenceLiveVal || {};
  for (const uid of Object.keys(obj)){
    const conns = obj[uid] || {};
    let best = null;
    for (const cid of Object.keys(conns)){
      const v = conns[cid];
      if (!v || !v.ts) continue;
      const ts = Number(v.ts);
      if (!Number.isFinite(ts)) continue;
      if ((now - ts) > PRESENCE_STALE_MS) continue;
      if (!best || ts > best.ts){
        best = { uid, name: String(v.name || 'ìµëª…').trim().slice(0,12), ts };
      }
    }
    if (best) items.push(best);
  }
  items.sort((a,b)=> b.ts - a.ts);
  return items;
}

function isUidOnline_(uid){
  if (!uid) return false;
  return activePresenceItems_().some(it => it.uid === uid);
}

function isDj_(){
  const uid = myUid_();
  return !!(uid && djState_ && djState_.uid && djState_.uid === uid);
}

function djTakeoverAllowed_(){
  if (!djState_ || !djState_.uid) return true;
  return !isUidOnline_(djState_.uid);
}

function setDjUi_(){
  const el = $('djStatus');
  if (!el) return;
  if (!djState_ || !djState_.uid){
    el.textContent = 'ì—†ìŒ';
  }else{
    el.textContent = `${djState_.name || 'ìµëª…'}${isUidOnline_(djState_.uid) ? '' : ' (ì˜¤í”„ë¼ì¸)'}`;
  }

  const claimBtn = $('btnDjClaim');
  const transferBtn = $('btnDjTransfer');
  if (claimBtn){
    claimBtn.disabled = false; // ëˆ„êµ¬ë‚˜ "DJ ë§¡ê¸°(ê°€ì ¸ì˜¤ê¸°)" ê°€ëŠ¥
}
  if (transferBtn){
    transferBtn.disabled = !isDj_();
  }
}

function setOverlayResizable_(on){
  try{
    const card = document.querySelector('.overlayCard');
    if (!card) return;
    if (on) card.classList.add('resizable');
    else card.classList.remove('resizable');
  }catch(e){}
}

function showOverlayHtml(title, html, resizable){
  // âœ… game overlays: no inner scroll + hide bottom OK button
  const isGame = /íƒ€ì´í•‘\s*ë ˆì´ìŠ¤|âŒ¨ï¸|ì‚°ì„±ë¹„|â˜”/i.test(String(title||''));
  try{ setOverlayResizable_(!!resizable && !isGame); }catch(e){}
  try{
    const card = $('overlayCard');
    if (card){
      card.classList.remove('wide');
      if (!isGame){
        if (/ë¶€ë£¨ë§ˆë¸”|writer\s*marble|boom\s*marble/i.test(String(title||''))) card.classList.add('wide');
        if (/ë£¨ë¯¸íë¸Œ/i.test(String(title||''))) card.classList.add('wide');
      }
    }
  }catch(e){}
  try{
    const msg = $('ovMsg');
    if (msg){
      msg.classList.toggle('game', !!isGame);
    }
    const ok = $('ovOkBtn');
    if (ok){
      ok.style.display = isGame ? 'none' : '';
    }
  }catch(e){}

  $('ovTitle').textContent = title;
  $('ovMsg').innerHTML = html;
  $('overlay').style.display = 'flex';

  // post-render hooks for games (fit/zoom)
  try{
    setTimeout(()=>{
      try{ if (document.querySelector('.wmBoardWrap')){ wmBindWheelZoom_(); wmFitBoard_(); } }catch(e){}
    }, 0);
  }catch(e){}
}

function initDj_(roomId){
  try{ if (djUnsub_) djUnsub_(); }catch(e){}
  djUnsub_ = null;
  djState_ = null;

  try{
    const djRef = window.FB.ref(window.FB.db, fbDjPath_(roomId));
    djUnsub_ = window.FB.onValue(djRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      if (v && v.uid){
        djState_ = { uid: String(v.uid), name: String(v.name || 'ìµëª…').slice(0,12), ts: Number(v.ts || 0) };
      }else{
        djState_ = null;
      }
      setDjUi_();
    });
  }catch(e){
    console.warn('DJ subscribe failed', e);
  }
}

async function setDj_(uid, name, announceText){
  if (!sessionId) return;
  await window.FB.ensureAnonAuth();
  const djRef = window.FB.ref(window.FB.db, fbDjPath_(sessionId));
  await window.FB.set(djRef, { uid, name, ts: Date.now() });
  if (announceText) await pushSystem_(announceText);
}

async function claimDj_(auto){
  const uid = myUid_();
  if (!uid) return;

  const nm = myName().slice(0,12);

  // DJê°€ ì˜¨ë¼ì¸ìœ¼ë¡œ ì¡´ì¬í•  ë•ŒëŠ” "ê°€ì ¸ì˜¤ê¸°" í™•ì¸ì„ ë°›ëŠ”ë‹¤
  if (djState_ && djState_.uid && isUidOnline_(djState_.uid) && !isDj_()){
    const cur = (djState_?.name || 'ìµëª…');
    showOverlay('DJ ê°€ì ¸ì˜¤ê¸°', `í˜„ì¬ DJ: ${cur}

DJë¥¼ ê°€ì ¸ì˜¤ë©´ í˜„ì¬ DJì˜ ê¶Œí•œì´ ì¦‰ì‹œ ë³¸ì¸ì—ê²Œ ë„˜ì–´ì˜µë‹ˆë‹¤.
ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`);

    // overlayì˜ í™•ì¸ ë²„íŠ¼ì„ "ê°€ì ¸ì˜¤ê¸°"ë¡œ ì„ì‹œ ë³€ê²½
    const ov = $('overlay');
    const btn = ov ? ov.querySelector('button') : null;
    if (btn){
      const oldOnclick = btn.onclick;
      const oldText = btn.textContent;
      btn.textContent = 'ê°€ì ¸ì˜¤ê¸°';
      btn.onclick = async ()=>{
        try{
          await setDj_(uid, nm, `ğŸ§ DJê°€ ${cur} â†’ ${nm}ë‹˜ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (ê°€ì ¸ì˜¤ê¸°)`);
        }finally{
          btn.textContent = oldText || 'í™•ì¸';
          btn.onclick = oldOnclick;
          hideOverlay();
        }
      };
    }
    return;
  }

  // DJê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤í”„ë¼ì¸ì´ë©´ ë°”ë¡œ ë§¡ê¸°
  const msg = auto
    ? `ğŸ§ ${nm}ë‹˜ì´ DJë¥¼ ë§¡ìœ¼ì…¨ìŠµë‹ˆë‹¤. (DJê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤í”„ë¼ì¸ì´ë¼ ìë™ ìŠ¹ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.)`
    : `ğŸ§ ${nm}ë‹˜ì´ DJë¥¼ ë§¡ìœ¼ì…¨ìŠµë‹ˆë‹¤!`;
  await setDj_(uid, nm, msg);
}

async function transferDjPick_(){
  if (!isDj_()){
    showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì–‘ë„í•  ìˆ˜ ìˆì–´. (ë¨¼ì € DJë¥¼ ë§¡ì•„ì¤˜!)');
    return;
  }

  const items = activePresenceItems_().filter(it => it.uid !== myUid_());
  if (!items.length){
    showOverlay('ì–‘ë„ ë¶ˆê°€', 'ì§€ê¸ˆ ì ‘ì†ì ëª©ë¡ì´ ë¹„ì–´ìˆê±°ë‚˜, ì–‘ë„í•  ì‚¬ëŒì´ ì—†ì–´.');
    return;
  }

  const html = items.map(it => {
    const nm = escapeHtml(it.name);
    const uid = escapeHtml(it.uid);
    return `<button style="width:100%; margin:6px 0; padding:10px 12px; border-radius:12px;" onclick="window.__djTo('${uid}')">ğŸ§ ${nm} ì—ê²Œ DJ ì–‘ë„</button>`;
  }).join('');

  window.__djTo = async (uid)=>{
    try{
      const to = items.find(x => x.uid === uid);
      if (!to) return;
      const fromName = myName().slice(0,12);
      await setDj_(uid, to.name, `ğŸ§ DJê°€ ${fromName} â†’ ${to.name} ë¡œ ë³€ê²½ëì–´!`);
      hideOverlay();
    }catch(e){
      console.warn(e);
    }
  };

  showOverlayHtml('DJ ì–‘ë„', html + '<div class="hint" style="margin-top:8px;">â€¢ ëª©ë¡ì€ í˜„ì¬ ì ‘ì†ì ê¸°ì¤€ì´ì•¼.</div>');
}

// =====================
// BGM Sync (Firebase)
// =====================
function initBgmSync_(roomId){
  try{ if (bgmUnsub_) bgmUnsub_(); }catch(e){}
  bgmUnsub_ = null;
  bgmRemote_ = null;
  bgmLastAppliedKey_ = '';

  try{
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(roomId));
    bgmUnsub_ = window.FB.onValue(bgmRef, (snap)=>{
      const v = snap.exists() ? (snap.val() || null) : null;
      bgmRemote_ = v;

      // âœ… ë…¸ë˜ ì¬ìƒ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ëŒ€ì‹ : ì±„íŒ… ìƒë‹¨ ì´í™íŠ¸(ì‹ ê·œ ì¬ìƒë§Œ)
      try{
        if (v && String(v.kind||'yt') !== 'file' && String(v.state||'') === 'playing'){
          const at = Number(v.startedAt || 0);
          const key = `${String(v.videoId||v.url||'')}-${at}-${String(v.by||'')}`;
          if (at && at >= joinTs_ && key !== bgmAnnouncedKey_){
            bgmAnnouncedKey_ = key;
            showSongTicker_(v.by || 'DJ');
          }
        }
      }catch(e){}

      if (!v){
        setBgmState('ì¤€ë¹„');
        return;
      }

      // UI reflect
      if (v.url && !$('bgmUrl').value) $('bgmUrl').value = v.url;

      // if not allowed yet, show pending
      if (!bgmAllowed_){
        const who = v.by ? ` Â· ${v.by}` : '';
        setBgmState('ëŒ€ê¸°ì¤‘(í—ˆìš© í•„ìš”)' + who);
        return;
      }

      applyRemoteBgm_(v, false);
    });
  }catch(e){
    console.warn('bgm sync subscribe failed', e);
  }
}

function remoteKey_(v){
  const kind = String(v?.kind || 'yt');

  // âœ… ì¬ìƒëª©ë¡ì—ì„œ ì˜¨ ì¬ìƒì¸ì§€(ìë™ ë„˜ê¹€)
  playingFromPlaylist_ = !!v?.fromPlaylist;
  const vid = String(v?.videoId || '');
  const fileUrl = String(v?.fileUrl || v?.url || '');
  const at = Number(v?.startedAt || 0);
  const st = String(v?.state || '');
  const pp = (v && typeof v.pausedPos === 'number') ? String(v.pausedPos) : '';
  return `${kind}|${vid}|${fileUrl}|${at}|${st}|${pp}`;
}

function ensureAudioPlayer_(){
  if (audioPlayer_) return audioPlayer_;
  const a = $('audioPlayer') || document.createElement('audio');
  if (!a.id) a.id = 'audioPlayer';
  a.preload = 'auto';
  a.crossOrigin = 'anonymous';
  a.style.display = 'none';
  if (!a.parentNode) document.body.appendChild(a);

  a.addEventListener('loadedmetadata', ()=>{
    try{
      const pend = a.__pendingSeek;
      if (typeof pend === 'number' && isFinite(pend) && pend >= 0){
        const dur = isFinite(a.duration) ? a.duration : 0;
        const to = dur > 0 ? Math.min(dur - 0.25, Math.max(0, pend)) : Math.max(0, pend);
        try{ a.currentTime = to; }catch(e){}
      }
    }catch(e){}
    a.__pendingSeek = null;
  });

  audioPlayer_ = a;
  return a;
}

function stopAudio_(){
  try{
    const a = ensureAudioPlayer_();
    a.pause();
    // do not clear src: allow quick resume
  }catch(e){}
}

function stopYouTube_(){
  try{ if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo(); }catch(e){}
}

function applyRemoteBgm_(v, force){
  const kind = String(v?.kind || 'yt');

  const k = remoteKey_(v);
  if (!force && k === bgmLastAppliedKey_) return;
  bgmLastAppliedKey_ = k;

  const state = String(v?.state || 'playing');
  const who = v?.by ? ` Â· ${v.by}` : '';

  // if not allowed yet, we still reflect title/status but don't autoplay
  if (!bgmAllowed_){
    setBgmState('ëŒ€ê¸°ì¤‘(í—ˆìš© í•„ìš”)' + who);
    try{
      if (kind === 'file'){
        setMiniTitle_(v.title || v.fileName || 'MP3');
      }
    }catch(e){}
    return;
  }

  if (kind === 'file'){
    // MP3 ê³µìœ  ê¸°ëŠ¥ ì‚­ì œë¨ (ìœ íŠœë¸Œë§Œ ì§€ì›)
    try{ stopYouTube_(); }catch(e){}
    try{ stopAudio_(); }catch(e){}
    setBgmState('MP3 ë¯¸ì§€ì›' + who);
    try{ setMiniTitle_(v.title || v.fileName || 'MP3'); }catch(e){}
    return;
  }

  // default: YouTube
  stopAudio_();

  const vid = String(v.videoId || '');
  if (!vid) return;

  loadYouTubeApiOnce();

  const p = ensureYtPlayer(vid);
  if (!p){
    setBgmState('ìœ íŠœë¸Œ ë¡œë”© ì¤‘...');
    setTimeout(()=> applyRemoteBgm_(v, true), 600);
    return;
  }

  // Keep volume as local preference
  const vol = Number($('bgmVol').value || 60);
  try{ p.setVolume(vol); }catch(e){}

  try{
    // load
    p.loadVideoById(vid);

    // seek
    let target = null;
    if (state === 'paused' && typeof v.pausedPos === 'number'){
      target = Math.max(0, Number(v.pausedPos || 0));
    }else{
      const startedAt = Number(v.startedAt || 0);
      if (startedAt){
        target = Math.max(0, (Date.now() - startedAt) / 1000);
      }
    }
    if (typeof target === 'number' && isFinite(target)){
      p.seekTo(target, true);
    }

    if (state === 'paused'){
      p.pauseVideo();
      setBgmState('ì¼ì‹œì •ì§€' + who);
    }else{
      p.playVideo();
      setBgmState('ê°™ì´ ë“£ëŠ” ì¤‘' + who);
    }
  }catch(e){
    setBgmState('ì¬ìƒ ì‹¤íŒ¨');
  }
}

// =====================
  // BGM (YouTube)
  // =====================
  function parseYouTubeId(url){
    const s = String(url || '').trim();
    if (!s) return '';
    // youtu.be/VIDEOID
    let m = s.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    // v=VIDEOID
    m = s.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    // shorts/VIDEOID
    m = s.match(/shorts\/([A-Za-z0-9_-]{6,})/);
    if (m && m[1]) return m[1];
    return '';
  }

  // âœ… ì¬ìƒëª©ë¡ ìë™ ì¬ìƒ (DJë§Œ ì‹¤í–‰)
  function onYtEnded_(){
    try{
      // ì¬ìƒëª©ë¡ ìë™ ë„˜ê¹€ì€ DJë§Œ
      if (playingFromPlaylist_){
        if (!isDj_()) return;
        try{ setTimeout(()=>{ plPrevNext_(+1); }, 0); }catch(e){}
        return;
      }

      // ì¼ë°˜ ì¬ìƒì´ë©´ ëª¨ë‘ê°€ ë¡œì»¬ì—ì„œ ê°™ì€ ê³¡ ë°˜ë³µ(ê¸°ì¡´ loop ëŒ€ì²´)
      if (ytPlayer){
        try{ ytPlayer.seekTo(0, true); }catch(e){}
        try{ ytPlayer.playVideo(); }catch(e){}
      }
    }catch(e){}
  }



  async function bgmPlay_(){
  // ì…ë ¥ì°½ì—ì„œ ì§ì ‘ ì¬ìƒ = ì¬ìƒëª©ë¡ ëª¨ë“œ í•´ì œ
  playingFromPlaylist_ = false;
  loadYouTubeApiOnce();

  const url = $('bgmUrl').value;
  const vid = parseYouTubeId(url);
  if (!vid){
    alert('ìœ íŠœë¸Œ ë§í¬ì—ì„œ ì˜ìƒ IDë¥¼ ëª» ì°¾ì•˜ì–´. ë§í¬ë¥¼ í•œ ë²ˆë§Œ ë” í™•ì¸í•´ì¤˜!');
    return;
  }

  // DJ guard: only DJ can control BGM
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ ê¶Œí•œ í•„ìš”', `í˜„ì¬ DJ: ${(djState_?.name || 'ì—†ìŒ')}
DJë§Œ ë…¸ë˜ë¥¼ í‹€/ë°”ê¿€ ìˆ˜ ìˆì–´!`);
      return;
    }
  }

  // user gesture granted
  bgmAllowed_ = true;
  localStorage.setItem(LS_BGM_URL, url);

  const vol = Number($('bgmVol').value || 60);
  localStorage.setItem(LS_BGM_VOL, String(vol));

  // Write shared state -> everyone follows
  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.set(bgmRef, {
      kind: 'yt',
      fromPlaylist: false,
      url,
      videoId: vid,
      startedAt: Date.now(),
      pausedPos: null,
      by: myName().slice(0,12),
      state: 'playing'
    });
    // (ë…¸ë˜ ì¬ìƒ ì•Œë¦¼ì€ ì±„íŒ… ìƒë‹¨ ì´í™íŠ¸ë¡œ í‘œì‹œ)

    // Local immediate apply
    applyRemoteBgm_({ kind:'yt', url, videoId: vid, startedAt: Date.now(), by: myName().slice(0,12), state:'playing', fromPlaylist:false }, true);
  }catch(e){
    console.warn(e);
    alert('BGM ê³µìœ  ì €ì¥ ì‹¤íŒ¨! (Firebase Rules / ë¡œê·¸ì¸ ì„¤ì • í™•ì¸)');
  }
}

function getLocalPlayPosSec_(){
  try{
    const kind = String(bgmRemote_?.kind || 'yt');
    if (kind === 'file'){
      const a = ensureAudioPlayer_();
      return Number(a.currentTime || 0);
    }
    if (ytPlayer && ytPlayer.getCurrentTime) return Number(ytPlayer.getCurrentTime() || 0);
  }catch(e){}
  return 0;
}

async function bgmPause_(){
  if (!sessionId) return;

  // DJ guard: only DJ can pause
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ ê¶Œí•œ í•„ìš”', `í˜„ì¬ DJ: ${(djState_?.name || 'ì—†ìŒ')}
DJë§Œ ì¼ì‹œì •ì§€í•  ìˆ˜ ìˆì–´!`);
      return;
    }
  }

  // user gesture granted
  bgmAllowed_ = true;

  const pos = getLocalPlayPosSec_();

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.update(bgmRef, {
      state:'paused',
      pausedPos: pos,
      by: myName().slice(0,12)
    });
    // (BGM ì¼ì‹œì •ì§€ ë©”ì‹œì§€ ì œê±°: ìƒë‹¨ë°” ìƒíƒœë¡œë§Œ í‘œì‹œ)
  }catch(e){
    // fallback local
    try{ if (ytPlayer) ytPlayer.pauseVideo(); }catch(_){}
    try{ const a = ensureAudioPlayer_(); a.pause(); }catch(_){}
  }
}

async function bgmResume_(){
  if (!sessionId) return;

  // DJ guard: only DJ can resume
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ ê¶Œí•œ í•„ìš”', `í˜„ì¬ DJ: ${(djState_?.name || 'ì—†ìŒ')}
DJë§Œ ì¬ìƒ/ì¬ê°œí•  ìˆ˜ ìˆì–´!`);
      return;
    }
  }

  bgmAllowed_ = true;

  if (!bgmRemote_){
    showOverlay('ì¬ê°œ ë¶ˆê°€', 'í˜„ì¬ ê³µìœ  ì¤‘ì¸ BGMì´ ì—†ì–´.');
    return;
  }

  const pos = (typeof bgmRemote_.pausedPos === 'number') ? Number(bgmRemote_.pausedPos || 0) : getLocalPlayPosSec_();
  const startedAt = Date.now() - Math.max(0, pos) * 1000;

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.update(bgmRef, {
      state:'playing',
      startedAt,
      pausedPos: null,
      by: myName().slice(0,12)
    });
    // (BGM ì¬ê°œ ë©”ì‹œì§€ ì œê±°: ìƒë‹¨ë°” ìƒíƒœ + ì¬ìƒ ì´í™íŠ¸ë¡œ í‘œì‹œ)
  }catch(e){
    console.warn(e);
  }
}

async function setBgmFromTrack_(track, announcePrefix){
  if (!sessionId) return;

  // âœ… DJ/ì¬ìƒëª©ë¡ì—ì„œ ë°”ë¡œ ì¬ìƒë˜ë„ë¡: ìë™ì¬ìƒ ê¶Œí•œ + YT API í”„ë¦¬ë¡œë“œ
  // (ë¸Œë¼ìš°ì € ì •ì±…ìƒ ê°ì 1íšŒ ì‚¬ìš©ì ì œìŠ¤ì²˜ê°€ í•„ìš”í•˜ì§€ë§Œ, DJê°€ ëˆ„ë¥´ëŠ” ë²„íŠ¼ ìì²´ëŠ” ì œìŠ¤ì²˜ë¼ì„œ ì—¬ê¸°ì„œ í—ˆìš© ì²˜ë¦¬)
  try{
    bgmAllowed_ = true;
    setBgmState('BGM í—ˆìš©ë¨');
    loadYouTubeApiOnce();
  }catch(e){}

  // DJ guard
  if (!isDj_()){
    if (djTakeoverAllowed_()){
      await claimDj_(true);
    }
    if (!isDj_()){
      showOverlay('DJ ê¶Œí•œ í•„ìš”', `í˜„ì¬ DJ: ${(djState_?.name || 'ì—†ìŒ')}
DJë§Œ ë…¸ë˜ë¥¼ í‹€/ë°”ê¿€ ìˆ˜ ìˆì–´!`);
      return;
    }
  }

  const nm = myName().slice(0,12);

  const payload = {
    kind: track.kind || 'yt',
    fromPlaylist: true,
    state: 'playing',
    startedAt: Date.now(),
    pausedPos: null,
    by: nm
  };

  if (payload.kind === 'file'){
    payload.fileUrl = String(track.fileUrl || track.url || '');
    payload.fileName = String(track.fileName || track.title || 'MP3');
    payload.title = String(track.title || track.fileName || 'MP3');
    payload.url = payload.fileUrl;
  }else{
    payload.url = String(track.url || '');
    payload.videoId = String(track.videoId || parseYouTubeId(payload.url) || '');
    payload.title = String(track.title || '');
  }

  try{
    await window.FB.ensureAnonAuth();
    const bgmRef = window.FB.ref(window.FB.db, fbBgmPath_(sessionId));
    await window.FB.set(bgmRef, payload);
    // (ë…¸ë˜ ì¬ìƒ ì•Œë¦¼ì€ ì±„íŒ… ìƒë‹¨ ì´í™íŠ¸ë¡œ í‘œì‹œ)

    applyRemoteBgm_(payload, true);
  }catch(e){
    console.warn(e);
    alert('BGM ê³µìœ  ì €ì¥ ì‹¤íŒ¨! (Firebase Rules / ë¡œê·¸ì¸ ì„¤ì • í™•ì¸)');
  }
}



// =====================
// MP3 Upload (Firebase Storage)
// =====================
function safeFileName_(name){
  return String(name || 'audio').replace(/[^\w\-.ê°€-í£]+/g, '_').slice(0, 80);
}

async function uploadAudioFile_(file, purpose){
  if (!file) throw new Error('no file');
  await window.FB.ensureAnonAuth();

  const uid = myUid_() || 'anon';
  const fname = safeFileName_(file.name || 'audio.mp3');
  const ts = Date.now();
  const folder = purpose || 'uploads';
  const path = `rooms/${sessionId}/${folder}/${uid}/${ts}_${fname}`;

  const sref = window.FB.sRef(window.FB.storage, path);
  const meta = { contentType: file.type || 'audio/mpeg' };

  return await new Promise((resolve, reject)=>{
    const task = window.FB.uploadBytesResumable(sref, file, meta);

    // simple progress overlay
    showOverlay('ì—…ë¡œë“œ ì¤‘', 'MP3 ì—…ë¡œë“œ ì¤‘... (ì ê¹ë§Œ!)');

    task.on('state_changed',
      (snap)=>{
        const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
        const msg = `MP3 ì—…ë¡œë“œ ì¤‘... ${pct}%`;
        const el = $('ovMsg'); if (el) el.textContent = msg;
      },
      (err)=>{
        hideOverlay();
        reject(err);
      },
      async ()=>{
        try{
          const url = await window.FB.getDownloadURL(task.snapshot.ref);
          hideOverlay();
          resolve({ url, path, fileName: file.name || fname, size: file.size || 0, contentType: file.type || '' });
        }catch(e){
          hideOverlay();
          reject(e);
        }
      }
    );
  });
}

// =====================
// DJ Playlist (Firebase RTDB)
// =====================
function normalizePlaylist_(pl){
  const out = pl && typeof pl === 'object' ? pl : {};
  const items = Array.isArray(out.items) ? out.items : [];
  const curIndex = Number.isFinite(Number(out.curIndex)) ? Number(out.curIndex) : 0;
  return { items, curIndex };
}

function trackLabel_(t){
  const kind = String(t?.kind || 'yt');
  if (kind === 'file') return `ğŸ§ MP3 Â· ${t.fileName || t.title || 'MP3'}`;
  return `ğŸµ YT Â· ${t.url || ''}`;
}

function trackSub_(t){
  const kind = String(t?.kind || 'yt');
  const by = t?.by ? ` Â· ${t.by}` : '';
  const note = t?.note ? ` Â· ${t.note}` : '';
  if (kind === 'file') return `${t.fileName || 'MP3'}${by}${note}`;
  return `${t.url || ''}${by}${note}`;
}

function renderPlaylistUi_(){
  const box = $('playlistList');
  const st = $('plStatus');
  if (!box || !st) return;

  const pl = normalizePlaylist_(plRemote_);
  const items = pl.items || [];
  const cur = pl.curIndex || 0;

  st.textContent = items.length ? `${items.length}ê³¡ Â· í˜„ì¬ ${cur+1}/${items.length}` : 'ë¹„ì–´ìˆìŒ';

  box.innerHTML = '';
  if (!items.length){
    box.innerHTML = '<div class="hint">ì¬ìƒëª©ë¡ì´ ë¹„ì–´ ìˆì–´ìš”. (DJê°€ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— ìŒ“ì—¬ìš”!)</div>';
    return;
  }

  items.forEach((t, idx)=>{
    const row = document.createElement('div');
    row.className = 'plItem' + (idx === plSelIndex_ ? ' sel' : '');
    row.addEventListener('click', ()=>{ plSelIndex_ = idx; renderPlaylistUi_(); });

    const main = document.createElement('div');
    main.className = 'plMain';

    const title = document.createElement('div');
    title.className = 'plTitle';
    title.textContent = (idx === cur ? 'â–¶ï¸ ' : '') + trackLabel_(t);

    const sub = document.createElement('div');
    sub.className = 'plSub';
    sub.textContent = trackSub_(t);

    main.appendChild(title);
    main.appendChild(sub);

    const btns = document.createElement('div');
    btns.className = 'plBtns';

    if (isDj_()){
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'tinyBtn';
      del.textContent = 'ğŸ—‘';
      del.title = 'ì‚­ì œ';
      del.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        await plDeleteIndex_(idx);
      });
      btns.appendChild(del);
    }

    row.appendChild(main);
    row.appendChild(btns);
    box.appendChild(row);
  });
}

async function getPlaylistFromDb_(){
  const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(sessionId));
  const snap = await window.FB.get(plRef);
  const v = snap.exists() ? snap.val() : null;
  return normalizePlaylist_(v);
}

async function savePlaylistToDb_(pl){
  const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(sessionId));
  await window.FB.set(plRef, { ...pl, updatedAt: Date.now(), by: myName().slice(0,12) });
}

async function plAddTrack_(track){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì¬ìƒëª©ë¡ì„ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }
  await window.FB.ensureAnonAuth();
  const pl = await getPlaylistFromDb_();
  pl.items = Array.isArray(pl.items) ? pl.items : [];
  pl.items.push({ ...track, ts: Date.now(), by: myName().slice(0,12) });
  if (!Number.isFinite(pl.curIndex)) pl.curIndex = 0;
  await savePlaylistToDb_(pl);
  plSelIndex_ = pl.items.length - 1;
}

async function plDeleteIndex_(idx){
  if (!isDj_()) return;
  const pl = await getPlaylistFromDb_();
  if (!pl.items || idx < 0 || idx >= pl.items.length) return;
  pl.items.splice(idx, 1);
  if (pl.curIndex >= pl.items.length) pl.curIndex = Math.max(0, pl.items.length - 1);
  await savePlaylistToDb_(pl);
  if (plSelIndex_ >= pl.items.length) plSelIndex_ = pl.items.length - 1;
}

async function plClear_(){
  if (!isDj_()){
    showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì¬ìƒëª©ë¡ì„ ë¹„ìš¸ ìˆ˜ ìˆì–´ìš”.');
    return;
  }
  await savePlaylistToDb_({ items:[], curIndex:0 });
  plSelIndex_ = -1;
}

async function plPlayIndex_(idx){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì¬ìƒëª©ë¡ì„ ì¬ìƒí•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }
  const pl = await getPlaylistFromDb_();
  if (!pl.items || idx < 0 || idx >= pl.items.length) return;

  pl.curIndex = idx;
  await savePlaylistToDb_(pl);
  await setBgmFromTrack_(pl.items[idx], 'ğŸ¶');
}

async function plPrevNext_(dir){
  if (!sessionId) return;
  if (!isDj_()){
    showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì´ì „/ë‹¤ìŒìœ¼ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆì–´ìš”.');
    return;
  }
  const pl = await getPlaylistFromDb_();
  const n = pl.items?.length || 0;
  if (!n) return;

  let next = Number(pl.curIndex || 0) + (dir || 0);
  if (next < 0) next = n - 1;
  if (next >= n) next = 0;

  pl.curIndex = next;
  await savePlaylistToDb_(pl);
  plSelIndex_ = next;
  await setBgmFromTrack_(pl.items[next], 'ğŸ¶');
}

function initPlaylist_(roomId){
  try{ if (plUnsub_) plUnsub_(); }catch(e){}
  plUnsub_ = null;
  plRemote_ = null;
  plSelIndex_ = -1;

  try{
    const plRef = window.FB.ref(window.FB.db, fbPlaylistPath_(roomId));
    plUnsub_ = window.FB.onValue(plRef, (snap)=>{
      plRemote_ = snap.exists() ? snap.val() : null;
      renderPlaylistUi_();
    });
  }catch(e){
    console.warn('playlist subscribe failed', e);
  }
}

// =====================
// Requests (Firebase RTDB)
// =====================
function renderRequestsUi_(){
  const box = $('reqList');
  const st = $('reqStatus');
  if (!box || !st) return;

  const obj = reqRemote_ && typeof reqRemote_ === 'object' ? reqRemote_ : {};
  const keys = Object.keys(obj).sort((a,b)=> (obj[a]?.ts||0) - (obj[b]?.ts||0));
  st.textContent = keys.length ? `${keys.length}ê±´` : 'ì—†ìŒ';

  box.innerHTML = '';
  if (!keys.length){
    box.innerHTML = '<div class="hint">ì‹ ì²­ê³¡ì´ ì•„ì§ ì—†ì–´ìš” ğŸ™‚</div>';
    return;
  }

  keys.forEach((k)=>{
    const r = obj[k] || {};
    const row = document.createElement('div');
    row.className = 'reqItem';

    const main = document.createElement('div');
    main.className = 'reqMain';

    const title = document.createElement('div');
    title.className = 'reqTitle';
    title.textContent = (r.kind === 'file') ? `ğŸ§ MP3 ì‹ ì²­ Â· ${r.fileName || 'MP3'}` : `ğŸµ ì‹ ì²­ Â· ${r.url || ''}`;

    const sub = document.createElement('div');
    sub.className = 'reqSub';
    const from = r.fromName ? `from ${r.fromName}` : 'from ìµëª…';
    const note = r.note ? ` Â· ${r.note}` : '';
    sub.textContent = `${from}${note}`;

    main.appendChild(title);
    main.appendChild(sub);

    const btns = document.createElement('div');
    btns.className = 'reqBtns';

    if (isDj_()){
      const ok = document.createElement('button');
      ok.type = 'button';
      ok.className = 'tinyBtn';
      ok.textContent = 'âœ…';
      ok.title = 'ì¬ìƒëª©ë¡ì— ì¶”ê°€';
      ok.addEventListener('click', async ()=>{
        await approveRequest_(k, r);
      });

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'tinyBtn';
      del.textContent = 'ğŸ—‘';
      del.title = 'ê±°ì ˆ/ì‚­ì œ';
      del.addEventListener('click', async ()=>{
        await deleteRequest_(k);
      });

      btns.appendChild(ok);
      btns.appendChild(del);
    }

    row.appendChild(main);
    row.appendChild(btns);
    box.appendChild(row);
  });
}

function initRequests_(roomId){
  try{ if (reqUnsub_) reqUnsub_(); }catch(e){}
  reqUnsub_ = null;
  reqRemote_ = {};

  try{
    const reqRef = window.FB.ref(window.FB.db, fbRequestsPath_(roomId));
    reqUnsub_ = window.FB.onValue(reqRef, (snap)=>{
      reqRemote_ = snap.exists() ? (snap.val() || {}) : {};
      renderRequestsUi_();
    });
  }catch(e){
    console.warn('request subscribe failed', e);
  }
}

async function pushRequest_(payload){
  if (!sessionId) return;

  const nm = myName().slice(0,12) || 'ìµëª…';
  await window.FB.ensureAnonAuth();

  const reqRef = window.FB.ref(window.FB.db, fbRequestsPath_(sessionId));
  const item = {
    ...payload,
    fromUid: myUid_() || '',
    fromName: nm,
    ts: Date.now()
  };

  await window.FB.push(reqRef, item);
  $('reqUrl').value = '';
  $('reqNote').value = '';
  showOverlay('ì‹ ì²­ ì™„ë£Œ', 'ì‹ ì²­ê³¡ì´ ì ‘ìˆ˜ëì–´! DJê°€ ìŠ¹ì¸í•˜ë©´ ì¬ìƒëª©ë¡ì— ë“¤ì–´ê°€ìš”.');
}

async function deleteRequest_(key){
  if (!isDj_()) return;
  const rRef = window.FB.ref(window.FB.db, `${fbRequestsPath_(sessionId)}/${key}`);
  await window.FB.remove(rRef);
}

async function approveRequest_(key, r){
  if (!isDj_()) return;

  const track = (r.kind === 'file')
    ? { kind:'file', fileUrl: r.fileUrl || r.url || '', fileName: r.fileName || 'MP3', title: r.fileName || 'MP3', note: r.note || '' }
    : { kind:'yt', url: r.url || '', videoId: parseYouTubeId(r.url || ''), title:'', note: r.note || '' };

  await plAddTrack_(track);
  await deleteRequest_(key);
  showOverlay('ìŠ¹ì¸ ì™„ë£Œ', 'ì‹ ì²­ê³¡ì„ DJ ì¬ìƒëª©ë¡ì— ë„£ì—ˆì–´!');
}

// =====================
// UI wiring for playlist/requests
// =====================
function wirePlaylistAndRequestsUi_(){
  // =====================
  // DJ playlist (ìœ íŠœë¸Œë§Œ)
  // =====================
  $('btnPlAddYt')?.addEventListener('click', async ()=>{
    const url = ($('bgmUrl')?.value || '').trim();
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('ì¶”ê°€ ì‹¤íŒ¨', 'ìœ íŠœë¸Œ ë§í¬ê°€ í•„ìš”í•´ìš”. (BGM ì…ë ¥ì°½ì— ë§í¬ë¥¼ ë„£ê³  â€œDJ ì¬ìƒëª©ë¡ì— ì¶”ê°€â€ë¥¼ ëˆŒëŸ¬ì¤˜)');
      return;
    }
    await plAddTrack_({ kind:'yt', url, videoId: vid });
  });

  // BGM ë¸”ë¡ì—ì„œ ë°”ë¡œ â€œëª©ë¡ì¶”ê°€â€ (ê°€ê¹Œì›Œì„œ í—·ê°ˆë¦¼ ë°©ì§€)
  $('btnQuickPlAdd')?.addEventListener('click', async ()=>{
    const url = ($('bgmUrl')?.value || '').trim();
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('ì¶”ê°€ ì‹¤íŒ¨', 'ìœ íŠœë¸Œ ë§í¬ê°€ í•„ìš”í•´ìš”. (BGM ì…ë ¥ì°½ì— ë§í¬ë¥¼ ë„£ê³  â€œâ• DJ ì¬ìƒëª©ë¡ì— ì¶”ê°€â€ë¥¼ ëˆŒëŸ¬ì¤˜)');
      return;
    }
    await plAddTrack_({ kind:'yt', url, videoId: vid });
  });

  $('btnPlPrev')?.addEventListener('click', ()=> plPrevNext_(-1));
  $('btnPlNext')?.addEventListener('click', ()=> plPrevNext_(+1));

  $('btnPlAutoAll')?.addEventListener('click', async ()=>{
    // âœ… ì¬ìƒëª©ë¡ ì „ì²´ ìë™ì¬ìƒ ì‹œì‘(í˜„ì¬ curIndexë¶€í„°)
    const pl = normalizePlaylist_(plRemote_);
    const items = pl.items || [];
    if (!items.length){
      showOverlay('ì¬ìƒëª©ë¡ ë¹„ì–´ìˆìŒ', 'DJ ì¬ìƒëª©ë¡ì— ê³¡ì„ ë¨¼ì € ì¶”ê°€í•´ì¤˜!');
      return;
    }
    // DJë§Œ (plPlayIndex_ ë‚´ë¶€ì—ì„œë„ ì²´í¬í•˜ì§€ë§Œ, UXë¥¼ ìœ„í•´)
    if (!isDj_()){
      showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì¬ìƒëª©ë¡ ì „ì²´ ìë™ ì¬ìƒì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”.');
      return;
    }
    const startIdx = Number.isFinite(pl.curIndex) ? Number(pl.curIndex) : 0;
    plSelIndex_ = Math.max(0, Math.min(startIdx, items.length - 1));
    await plPlayIndex_(plSelIndex_);
    renderPlaylistUi_();
  });


  $('btnPlPlayNow')?.addEventListener('click', async ()=>{
    if (plSelIndex_ < 0){
      showOverlay('ì„ íƒ ì—†ìŒ', 'ì¬ìƒí•  ê³¡ì„ ëª©ë¡ì—ì„œ í•˜ë‚˜ ì„ íƒí•´ì¤˜!');
      return;
    }
    await plPlayIndex_(plSelIndex_);
  });

  $('btnPlDeleteSel')?.addEventListener('click', async ()=>{
    if (!isDj_()){
      showOverlay('DJë§Œ ê°€ëŠ¥', 'DJë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.');
      return;
    }
    if (plSelIndex_ < 0){
      showOverlay('ì„ íƒ ì—†ìŒ', 'ì‚­ì œí•  ê³¡ì„ ëª©ë¡ì—ì„œ í•˜ë‚˜ ì„ íƒí•´ì¤˜!');
      return;
    }
    await plDeleteIndex_(plSelIndex_);
    renderPlaylistUi_();
  });

  $('btnPlClear')?.addEventListener('click', async ()=>{
    await plClear_();
  });

  $('btnPlSyncToInput')?.addEventListener('click', ()=>{
    try{
      if (!bgmRemote_) return;
      $('bgmUrl').value = String(bgmRemote_.url || '');
      showOverlay('ë³µì‚¬ ì™„ë£Œ', 'í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë§í¬ë¥¼ ì…ë ¥ì°½ì— ë³µì‚¬í–ˆì–´!');
    }catch(e){}
  });

  // =====================
  // Song requests (ìœ íŠœë¸Œë§Œ)
  // =====================
  $('btnReqSend')?.addEventListener('click', async ()=>{
    const url = ($('reqUrl')?.value || '').trim();
    const note = ($('reqNote')?.value || '').trim();
    if (!url){
      showOverlay('ì‹ ì²­ ì‹¤íŒ¨', 'ìœ íŠœë¸Œ ë§í¬ë¥¼ ë„£ì–´ì¤˜!');
      return;
    }
    const vid = parseYouTubeId(url);
    if (!vid){
      showOverlay('ì‹ ì²­ ì‹¤íŒ¨', 'ì§€ê¸ˆì€ ìœ íŠœë¸Œ ë§í¬ë§Œ ì‹ ì²­ ê°€ëŠ¥í•´!');
      return;
    }
    await pushRequest_({ kind:'yt', url, note });
    try{ $('reqUrl').value = ''; }catch(e){}
    try{ $('reqNote').value = ''; }catch(e){}
  });
}


// mobile topbar fold (safe: only toggles CSS class)
function toggleTopbarMobile_(force){
  const isMobile = window.matchMedia && window.matchMedia('(max-width: 760px)').matches;
  if (!isMobile) return;

  const body = document.body;
  const willCollapse = (typeof force === 'boolean') ? force : !body.classList.contains('tbCollapsed');
  body.classList.toggle('tbCollapsed', willCollapse);
  try{ const side = document.querySelector('.card.side'); if(side){ side.setAttribute('aria-hidden', willCollapse ? 'true' : 'false'); } }catch(e){}

  const btn = $('btnTopbarToggle');
  if (btn) btn.textContent = willCollapse ? 'â¬‡ï¸' : 'â¬†ï¸';
  try{ localStorage.setItem('VENT_TOPBAR_COLLAPSED_V1', willCollapse ? '1' : '0'); }catch(e){}
  try{ window.syncMobileLogFit_(true); }catch(e){}
}

  // =====================
  // UI events
  // =====================
  function initUi_(){
    try{ bindOverlayUi_(); }catch(e){}
    // menu
    $('btnMenu')?.addEventListener('click', toggleMenu);
    $('btnMenuClose')?.addEventListener('click', closeMenu); 
    document.addEventListener('click', (e)=>{
      const mp = $('menuPanel');
      if (!mp) return;
      if (!mp.classList.contains('show')) return;
      if (e.target.closest('#menuPanel') || e.target.closest('#btnMenu')) return;
      closeMenu();
    });


// topbar fold (mobile only)
const tbBtn = $('btnTopbarToggle');
if (tbBtn){
  tbBtn.addEventListener('click', ()=> toggleTopbarMobile_());
  // restore
  try{
    const v = localStorage.getItem('VENT_TOPBAR_COLLAPSED_V1');
    if (v === '1') toggleTopbarMobile_(true);
  }catch(e){}
}


    // leave
    $('btnLeave')?.addEventListener('click', ()=>{
      stopAll_();
      stopPresence_();
      showOverlay('ë‚˜ê°€ê¸°', 'ì°½ì„ ë‹«ì•„ë„ ë˜ê³ , ë‹¤ì‹œ ë“¤ì–´ì˜¤ë©´ ìƒˆë¡œ ì ‘ì†í•´.');
    });

    // chat send
    $('sendBtn')?.addEventListener('click', sendChat_);
    $('msg')?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendChat_();
      }
    });

    // notice (menu + topbar pin)
    // âœ… ê³µì§€ ë³´ê¸° ë²„íŠ¼ì€ ìƒë‹¨ ğŸ“Œ(btnNoticePin)ìœ¼ë¡œ ì´ë™ â†’ ë©”ë‰´ ë²„íŠ¼ì€ ì œê±°
    $('btnNoticePin')?.addEventListener('click', openNotice_);

    // guide / typing race
    $('btnGuide')?.addEventListener('click', showGuide_);
$('btnAcid')?.addEventListener('click', (e)=>{ try{ e.preventDefault(); e.stopPropagation(); }catch(_e){}; try{ openAcidStart_(); }catch(_e){} });
    $('btnRace')?.addEventListener('click', ()=>{ try{ openRaceStart_(); }catch(e){} }); 
    $('btnRaceClear')?.addEventListener('click', ()=>{ try{ const i=$('raceInput'); if(i){ i.value=''; i.focus(); } }catch(e){} });

    // nickname profile
    const userEl = $('user');

    // restore saved nick (optional)
    try{
      const saved = localStorage.getItem(LS_LAST_NICK) || '';
      if (saved && validateNick_(saved)){
        userEl.value = saved;
        lastConfirmedNick_ = saved;
        nickConfirmed_ = true;
      }
    }catch(e){}

    const onNickInput = ()=>{
      try{ myProfile_(); }catch(e){}
      try{ setDjUi_(); }catch(e){}
    };

    // âœ… íƒ€ì´í•‘ ì¤‘ì— ì…ì¥ ë©”ì‹œì§€ ëœ¨ëŠ” ë¬¸ì œ ë°©ì§€: í™•ì •(í™•ì¸) í›„ì—ë§Œ announce
    userEl.addEventListener('input', onNickInput);
    userEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        confirmNickname_('enter');
        $('msg')?.focus();
      }
    });
    userEl.addEventListener('change', ()=> confirmNickname_('change'));
    userEl.addEventListener('blur', ()=> confirmNickname_('blur'));
// log scroll tracking (ìë™ ìŠ¤í¬ë¡¤ ì œì–´)
$('log')?.addEventListener('scroll', updateAutoScrollState_, { passive:true });
$('jumpBtn')?.addEventListener('click', ()=>{
  const log = $('log');
  autoScroll_ = true;
  unreadCount_ = 0;
  showJumpBtn_(false);
  log.scrollTop = log.scrollHeight;
});

// log size slider (desktop: height / mobile: maxHeight)
    window.isMobile_ = window.isMobile_ || (()=> (window.matchMedia && window.matchMedia('(max-width: 760px)').matches));
    const isMobile_ = window.isMobile_;

    window.syncMobileLogFit_ = function syncMobileLogFit_(forceMax){
      if(!isMobile_()) return;
      const log = $('log');
      const slider = $('logSize');
      const valEl = $('logSizeVal');
      if(!log || !slider || !valEl) return;

      // flex ë ˆì´ì•„ì›ƒì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ í• ë‹¹ë˜ëŠ” ë†’ì´ë¥¼ ì¸¡ì •
      const prevMaxH = log.style.maxHeight;
      const prevH = log.style.height;
      log.style.maxHeight = '';
      log.style.height = '';

      requestAnimationFrame(()=>{
        const rect = log.getBoundingClientRect();
        let fitH = Math.floor(rect.height || 0);
        if(!fitH || fitH < 180) fitH = 180;

        slider.max = String(Math.max(180, fitH));
        const cur = Number(slider.value || 320);

        // ì´ì „ì— 'ìë™ë§ì¶¤'(=ìµœëŒ€ê°’) ìƒíƒœì˜€ê±°ë‚˜, forceMaxë©´ ìµœëŒ€ì— ë§ì¶¤
        const wasAuto = forceMax || slider.dataset.auto === '1' || Math.abs(cur - Number(slider.max)) <= 2;
        const newVal = wasAuto ? fitH : Math.min(cur, fitH);

        slider.value = String(newVal);
        log.style.maxHeight = newVal + 'px';
        valEl.textContent = newVal + 'px';
        slider.dataset.auto = (newVal === fitH) ? '1' : '0';

        // ë³µêµ¬ê°€ í•„ìš”í•œ ê²½ìš°(íŠ¹íˆ ë°ìŠ¤í¬í†±ì—ì„œ) ëŒ€ë¹„
        if(!isMobile_()){
          log.style.maxHeight = prevMaxH;
          log.style.height = prevH;
        }
      });
    }

    $('logSize')?.addEventListener('input', ()=>{
      const slider = $('logSize');
      const v0 = Number(slider.value || 320);
      const log = $('log');
      if(!log) return;

      if(isMobile_()){
        const max = Number(slider.max || v0);
        const v = Math.min(v0, max);
        log.style.maxHeight = v + 'px';
        $('logSizeVal').textContent = v + 'px';
        slider.dataset.auto = (v === max) ? '1' : '0';
      }else{
        log.style.height = v0 + 'px';
        $('logSizeVal').textContent = v0 + 'px';
      }
    });

    // chat font slider (message bubbles)
    try{
      const fontEl = $('logFont');
      if(fontEl){
        fontEl.addEventListener('input', ()=>{
          const v = Number(fontEl.value || (isMobile_()?14:15));
          $('logFontVal').textContent = v + 'px';
          document.documentElement.style.setProperty('--chatMsgPx', v + 'px');
          localStorage.setItem(LS_CHAT_FONT, String(v));
        });
      }
    }catch(e){}

    // BGM
    $('btnBgmPlay')?.addEventListener('click', bgmPlay_);
    $('btnBgmPause')?.addEventListener('click', bgmPause_);
    $('btnBgmAllow')?.addEventListener('click', ()=>{
      bgmAllowed_ = true;
      setBgmState('BGM í—ˆìš©ë¨');
      if (bgmRemote_) applyRemoteBgm_(bgmRemote_, true);
    });

    // DJ
    $('btnDjClaim')?.addEventListener('click', ()=> claimDj_(false));
    $('btnDjTransfer')?.addEventListener('click', transferDjPick_);

    $('bgmVol')?.addEventListener('input', ()=>{
      const v = Number($('bgmVol').value || 60);
      $('bgmVolVal').textContent = String(v);
      localStorage.setItem(LS_BGM_VOL, String(v));
      try{ if (ytPlayer) ytPlayer.setVolume(v); }catch(e){}
      try{ const a = ensureAudioPlayer_(); a.volume = clamp_(v/100, 0, 1); }catch(e){}
    });

    // restore BGM settings
    const savedUrl = localStorage.getItem(LS_BGM_URL) || '';
    const savedVol = Number(localStorage.getItem(LS_BGM_VOL) || 60);
    $('bgmUrl').value = savedUrl;
    $('bgmVol').value = String(savedVol);
    $('bgmVolVal').textContent = String(savedVol);

    
    // restore chat font (message bubbles only)
    try{
      const savedFont = localStorage.getItem(LS_CHAT_FONT);
      let font = savedFont ? Number(savedFont) : (isMobile_()?14:15);
      if(!font || isNaN(font)) font = (isMobile_()?14:15);
      if($('logFont')) $('logFont').value = String(font);
      if($('logFontVal')) $('logFontVal').textContent = font + 'px';
      document.documentElement.style.setProperty('--chatMsgPx', font + 'px');
    }catch(e){}
// restore log height
    updateAutoScrollState_();
    const v = Number($('logSize').value || 320);
    $('log').style.height = v + 'px';
    $('logSizeVal').textContent = v + 'px';

    // PATCH: viewport/vh ì•ˆì •í™”
    setVhVar_();
    try{ window.syncMobileLogFit_(true); }catch(e){}
    window.addEventListener('resize', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
    window.addEventListener('orientationchange', ()=> setTimeout(()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(true); }catch(e){} }, 200));
    // iOS Safariì—ì„œ ì£¼ì†Œì°½/í‚¤ë³´ë“œ ë³€í™”ë¡œ resizeê°€ ì•ˆ ëœ¨ëŠ” ê²½ìš° ëŒ€ë¹„
    if (window.visualViewport){
      try{
        window.visualViewport.addEventListener('resize', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
        window.visualViewport.addEventListener('scroll', ()=>{ try{ setVhVar_(); }catch(e){} try{ window.syncMobileLogFit_(); }catch(e){} });
      }catch(e){}
    }

// PATCH: mini BGM + picker (ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ê¸°ëŠ¥ì€ ì‚´ì•„ì•¼ í•¨)
    try{ initMiniBgmBar_(); }catch(e){ console.error(e); }
    try{ initLogPopover_(); }catch(e){ console.error(e); }
    try{ wirePlaylistAndRequestsUi_(); }catch(e){ console.error(e); }
    try{ initPicker_(); }catch(e){ console.error(e); }

    // YouTube API preload(ê°€ë³ê²Œ)
    loadYouTubeApiOnce();
  }


  // =====================
  // PATCH: Mobile viewport stability (vh)
  // =====================
  function setVhVar_(){
  try{
    // âœ… Mobile ì£¼ì†Œì°½/í‚¤ë³´ë“œ ë³€í™”ì— ë” ê°•í•œ ë†’ì´ ê³„ì‚°
    const vv = window.visualViewport;
    const h = (vv && vv.height) ? vv.height : (window.innerHeight || 0);
    const vh = (h || 0) * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');

    // âœ… script.google.com ëª¨ë°”ì¼ ìƒë‹¨ ì•ˆë‚´ ë°°ë„ˆ(ê³ ì •)ë¡œ ê°€ë ¤ì§€ëŠ” ë¬¸ì œ ë³´ì •
    //    - í™”ë©´ (10,10) ì§€ì ì— ìˆëŠ” "ê³ ì • ìƒë‹¨ ìš”ì†Œ"ì˜ ë†’ì´ë¥¼ ì¶”ì •í•´ì„œ --chromeTopìœ¼ë¡œ ë°˜ì˜
    let topH = 0;
    try{
      const hit = document.elementFromPoint(10, 10);
      if(hit){
        let n = hit;
        for(let i=0;i<8 && n && n !== document.body && n !== document.documentElement; i++){
          if(n.closest && n.closest('.topbar')) { break; } // ìš°ë¦¬ ìƒë‹¨ë°”ëŠ” ì œì™¸
          if(n.id === 'overlay' || (n.classList && n.classList.contains('overlay'))) { break; }
          const cs = window.getComputedStyle(n);
          const rect = n.getBoundingClientRect();
          const looksFixedTop = (cs.position === 'fixed' || cs.position === 'sticky')
            && rect.top <= 0.5
            && rect.height >= 44
            && rect.width >= (window.innerWidth * 0.80);
          if(looksFixedTop){
            topH = Math.round(rect.height);
            break;
          }
          n = n.parentElement;
        }
      }
    }catch(e2){}
    document.documentElement.style.setProperty('--chromeTop', (topH || 0) + 'px');
  }catch(e){}
}
// =====================
  // PATCH: Mini BGM Bar + Volume popover
  // =====================
  function clamp_(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function showVolPopover_(){
    const pop = $('volPopover');
    const btn = $('miniVolBtn');
    if (!pop || !btn) return;
    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || 260;
    const left = clamp_(r.left + r.width/2 - w/2, 10, window.innerWidth - w - 10);
    const top = r.bottom + 8;
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');
  }

  function hideVolPopover_(){
    const pop = $('volPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }

  function toggleVolPopover_(){
    const pop = $('volPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hideVolPopover_();
    else showVolPopover_();
  }

  // Chat height popover
  function showLogPopover_(){
    const pop = $('logPopover');
    const btn = $('btnLogPopover');
    if (!pop || !btn) return;
    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || 280;
    const left = clamp_(r.left + r.width/2 - w/2, 10, window.innerWidth - w - 10);
    const top = r.bottom + 8;
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');
  }

  function hideLogPopover_(){
    const pop = $('logPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }

  function toggleLogPopover_(){
    const pop = $('logPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hideLogPopover_();
    else showLogPopover_();
  }

  function initLogPopover_(){
    const btn = $('btnLogPopover');
    if (!btn) return;

    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      toggleLogPopover_();
    });

    document.addEventListener('click', (e)=>{
      try{
        const pop = $('logPopover');
        if (!pop || !btn) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        hideLogPopover_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('logPopover')?.classList.contains('show')) showLogPopover_(); });
  }

  function setMiniTitle_(t){
    const title = $('miniBgmTitle');
    const m = $('miniBgmMarquee');
    if (!title || !m) return;
    const safe = String(t || 'BGM ì¤€ë¹„').trim() || 'BGM ì¤€ë¹„';
    m.textContent = safe + ' â€¢ ' + safe;
    requestAnimationFrame(()=>{
      try{
        title.classList.toggle('marqueeOn', m.scrollWidth > title.clientWidth + 6);
      }catch(e){}
    });
  }

  function syncMiniPlaying_(){
    try{
      const note = $('miniNote');
      if (!note) return;

      const kind = String(bgmRemote_?.kind || 'yt');

      let playing = false;
      if (kind === 'file'){
        try{
          const a = ensureAudioPlayer_();
          playing = !a.paused && !a.ended;
        }catch(e){ playing = false; }
      }else{
        playing = (typeof ytPlayer !== 'undefined' && ytPlayer && ytPlayer.getPlayerState && ytPlayer.getPlayerState() === 1);
      }

      note.classList.toggle('playing', !!playing);

      if (playing){
        if (kind === 'file'){
          const t = bgmRemote_?.title || bgmRemote_?.fileName;
          if (t) setMiniTitle_(t);
        }else{
          try{
            const data = ytPlayer.getVideoData ? ytPlayer.getVideoData() : null;
            const t = data && data.title ? data.title : '';
            if (t) setMiniTitle_(t);
          }catch(e){}
        }
      }
    }catch(e){}
  }

  function initMiniBgmBar_(){
    const bar = $('miniBgmBar');
    if (!bar) return;

    // Wire mini buttons to existing menu buttons (no new logic: ì•ˆì „!)
    $('miniPlay')?.addEventListener('click', ()=>{ try{ if (bgmRemote_ && String(bgmRemote_.state||'')==='paused') bgmResume_(); else $('btnBgmPlay').click(); }catch(e){} });
    $('miniPause')?.addEventListener('click', ()=>{ try{ $('btnBgmPause').click(); }catch(e){} });
    $('miniAllow')?.addEventListener('click', ()=>{ try{ $('btnBgmAllow').click(); }catch(e){} });

    // Volume range sync (popover -> existing range)
    const vRange = $('volRange');
    const vVal = $('volVal');

    function applyVol_(v){
      const vv = clamp_(Number(v||0),0,100);
      if (vRange) vRange.value = String(vv);
      if (vVal) vVal.textContent = String(vv);
      try{
        const base = $('bgmVol');
        if (base){
          base.value = String(vv);
          base.dispatchEvent(new Event('input', { bubbles:true }));
        }
      }catch(e){}
    }

    try{ applyVol_(Number($('bgmVol')?.value || 60)); }catch(e){}

    vRange?.addEventListener('input', ()=> applyVol_(Number(vRange.value||0)));

    $('miniVolBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggleVolPopover_(); });

    document.addEventListener('click', (e)=>{
      try{
        const pop = $('volPopover');
        const btn = $('miniVolBtn');
        if (!pop || !btn) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        hideVolPopover_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('volPopover')?.classList.contains('show')) showVolPopover_(); });

    // mini title initial
    setMiniTitle_($('bgmState')?.textContent || 'BGM ì¤€ë¹„');

    // periodically sync playing state + title
    setInterval(syncMiniPlaying_, 900);
  }

  // =====================
  // PATCH: Unified Picker (emoji/command)
  // =====================
  const PICKER_EMOJI = {"í‘œì •": ["ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ¤£", "ğŸ˜‚", "ğŸ™‚", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‡", "ğŸ¥°", "ğŸ˜", "ğŸ¤©", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜š", "ğŸ˜™", "ğŸ«¢", "ğŸ¤­", "ğŸ¤—", "ğŸ˜", "ğŸ¤ª", "ğŸ˜œ", "ğŸ˜›", "ğŸ˜‹", "ğŸ˜", "ğŸ¥²", "ğŸ«£", "ğŸ¤«", "ğŸ¤”", "ğŸ«¡", "ğŸ¤¤", "ğŸ¤ ", "ğŸ¥³", "ğŸ¥¸", "ğŸ˜", "ğŸ¤“", "ğŸ«¥", "ğŸ˜¶", "ğŸ˜‘", "ğŸ˜", "ğŸ¤¨", "ğŸ¤", "ğŸ« ", "ğŸ™ƒ", "ğŸ§", "ğŸ˜’", "ğŸ™„", "ğŸ˜¬", "ğŸ˜®â€ğŸ’¨", "ğŸ¤¥", "ğŸ«¨", "ğŸ˜Œ", "ğŸ˜”", "ğŸ¥¶", "ğŸ¥µ", "ğŸ¤§", "ğŸ¤®", "ğŸ¤¢", "ğŸ¤•", "ğŸ¤’", "ğŸ˜·", "ğŸ˜´", "ğŸ˜ª", "ğŸ¥´", "ğŸ˜µ", "ğŸ˜µâ€ğŸ’«", "ğŸ¤¯", "ğŸ¥±", "ğŸ˜•", "ğŸ«¤", "ğŸ˜Ÿ", "ğŸ™", "ğŸ˜°", "ğŸ˜¨", "ğŸ˜§", "ğŸ˜¦", "ğŸ¥¹", "ğŸ¥º", "ğŸ˜³", "ğŸ˜²", "ğŸ˜º", "ğŸ˜¸", "ğŸ˜¹", "ğŸ˜»", "ğŸ˜¼", "ğŸ˜½", "ğŸ™€", "ğŸ˜¿", "ğŸ˜¾", "ğŸ™ˆ", "ğŸ™‰", "ğŸ™Š", "ğŸ§¬", "ğŸ¦", "ğŸ¦§", "ğŸ¦®", "ğŸ¦Š", "ğŸ¦", "ğŸ¦", "ğŸ«", "ğŸ«", "ğŸ¦„", "ğŸ¦“", "ğŸ¦Œ", "ğŸ¦¬", "ğŸ¦‰", "ğŸ¦©", "ğŸ¦š", "ğŸ¦•", "ğŸ¦–", "ğŸ¦€", "ğŸª¼", "ğŸ¦", "ğŸ¦‘", "ğŸ¦‹", "ğŸª·", "ğŸ¥€", "ğŸª»", "ğŸªµ", "ğŸª", "ğŸ˜¯", "ğŸ˜®", "ğŸ˜¥", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜±", "ğŸ˜–", "ğŸ˜£", "ğŸ˜", "ğŸ˜“", "ğŸ˜©", "ğŸ˜«", "ğŸ˜¤", "ğŸ˜¡", "ğŸ˜ ", "ğŸ¤¬", "ğŸ˜ˆ", "ğŸ¥­", "ğŸ«", "ğŸ¥", "ğŸ«’", "ğŸ¥¥", "ğŸ¥¦", "ğŸ¥¬", "ğŸ¥’", "ğŸ«‘", "ğŸ¥•", "ğŸ¥”", "ğŸ¥‘", "ğŸ§„", "ğŸ§…", "ğŸ¥œ", "ğŸ«˜", "ğŸ«š", "ğŸ«›", "ğŸ¥", "ğŸ¥©", "ğŸ§€", "ğŸ§‡", "ğŸ¥", "ğŸ¥¯", "ğŸ¥¨", "ğŸ«“", "ğŸ¥–", "ğŸ¥“", "ğŸ¥ª", "ğŸ¥™", "ğŸ§†", "ğŸ¥š", "ğŸ¥˜", "ğŸ«•", "ğŸ¥£", "ğŸ¥—", "ğŸ§ˆ", "ğŸ¥«", "ğŸ§‚", "ğŸ¥®", "ğŸ¥Ÿ", "ğŸ¥ ", "ğŸ¥¡", "ğŸ¥§", "ğŸ§", "ğŸ¥›", "ğŸ«–", "ğŸ§‹", "ğŸ¥¤", "ğŸ«—", "ğŸ¥ƒ", "ğŸ¥‚", "ğŸ¥¼", "ğŸ¦º", "ğŸª®", "ğŸª“", "ğŸª›", "ğŸª ", "ğŸ§º", "ğŸ§´", "ğŸª’", "ğŸ©¹", "ğŸ©¼", "ğŸ§¼", "ğŸª£", "ğŸ«§", "ğŸª¥", "ğŸ§½", "ğŸ§¯", "ğŸ©µ", "ğŸ©·", "ğŸ©¶"], "í•˜íŠ¸": ["â˜ºï¸", "ğŸ˜¶â€ğŸŒ«ï¸", "ğŸ™‚â€â†”ï¸", "ğŸ™‚â€â†•ï¸", "â˜¹ï¸", "ğŸ»â€â„ï¸", "ğŸµï¸", "â˜€ï¸", "â˜ï¸", "â›ˆï¸", "ğŸŒ¤ï¸", "ğŸŒ¥ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "ğŸŒ¨ï¸", "ğŸŒ©ï¸", "ğŸŒªï¸", "â„ï¸", "â›±ï¸", "â˜‚ï¸", "ğŸŒ¬ï¸", "ğŸŒ«ï¸", "â˜ƒï¸", "â˜„ï¸", "ğŸŒ¶ï¸", "ğŸ’", "ğŸ’", "âœï¸", "âœ’ï¸", "âœ‚ï¸", "â›ï¸", "âš’ï¸", "ğŸ› ï¸", "ğŸ—¡ï¸", "âš”ï¸", "ğŸ’Œ", "ğŸ’˜", "ğŸ’", "ğŸ’–", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’•", "ğŸ’Ÿ", "â£ï¸", "ğŸ’™", "ğŸ’š", "ğŸ’›", "ğŸ§¡", "â¤ï¸", "â¤ï¸â€ğŸ©¹", "â¤ï¸â€ğŸ”¥", "ğŸ’”", "ğŸ’œ", "ğŸ¤", "ğŸ–¤", "ğŸ¤", "ğŸ—¯ï¸", "ğŸ—¨ï¸", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ•³ï¸", "âš ï¸", "â‰ï¸", "ã€°ï¸", "â€¼ï¸"], "ì‚¬ë¬¼": ["ğŸ‘€", "ğŸ‘„", "ğŸ’®", "ğŸ’§", "ğŸ‘¿", "ğŸ’€", "ğŸ’©", "ğŸ‘»", "ğŸ‘½", "ğŸ‘“", "ğŸ‘”", "ğŸ‘™", "ğŸ‘ ", "ğŸ‘‘", "ğŸ‘’", "ğŸ’„", "ğŸ“¢", "ğŸ“»", "ğŸ“º", "ğŸ“·", "ğŸ’£", "ğŸ’‰", "ğŸ’‹", "ğŸ’¯", "ğŸ’¢", "ğŸ’¥", "ğŸ’¦", "ğŸ’¤", "ğŸ’­", "ğŸ’¬", "ğŸ’¨", "ğŸ“µ", "ğŸ“¶"], "ë™ë¬¼": ["ğŸµ", "ğŸ’", "ğŸ¶", "ğŸ•", "ğŸ•â€ğŸ¦º", "ğŸ©", "ğŸº", "ğŸ±", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸ¯", "ğŸ…", "ğŸ†", "ğŸ´", "ğŸ", "ğŸ®", "ğŸ‚", "ğŸƒ", "ğŸ„", "ğŸ·", "ğŸ–", "ğŸ—", "ğŸ½", "ğŸ", "ğŸ", "ğŸª", "ğŸ˜", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¼", "ğŸ»", "ğŸ¨", "ğŸ”", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ§", "ğŸ¸", "ğŸ³", "ğŸ‹"], "ìì—°": ["ğŸŒ¸", "ğŸŒ¹", "ğŸŒº", "ğŸŒ»", "ğŸŒ¼", "ğŸŒ·", "ğŸ€", "ğŸ", "ğŸ‚", "ğŸ„", "ğŸ‡", "ğŸˆ", "ğŸ‰", "ğŸŠ", "ğŸ‹", "ğŸ‹â€ğŸŸ©", "ğŸŒ", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ‘", "ğŸ’", "ğŸ“", "ğŸ…", "ğŸŒ½", "ğŸ†", "ğŸŒ°", "ğŸ„â€ğŸŸ«", "ğŸ", "ğŸ—", "ğŸ–", "ğŸ”", "ğŸŸ", "ğŸ•", "ğŸ³", "ğŸ²", "ğŸ¿", "ğŸ ", "ğŸœ", "ğŸ›", "ğŸš", "ğŸ™", "ğŸ˜", "ğŸ±", "ğŸ", "ğŸ¢", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¡", "ğŸ¦", "ğŸ¬", "ğŸ«", "ğŸ°", "ğŸª", "ğŸ©", "ğŸ¨", "ğŸ§", "ğŸ­", "ğŸ¯", "ğŸ¼", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸº", "ğŸ¹", "ğŸ·"], "ë‚ ì”¨/ì²œì²´": ["ğŸŒ™", "ğŸŒ›", "ğŸŒœ", "ğŸŒ", "ğŸŒ", "ğŸŒŸ", "ğŸŒ ", "ğŸŒŒ", "â›…", "âš¡", "â˜”", "ğŸŒ‚", "ğŸŒˆ", "ğŸŒ€", "â›„", "ğŸŒŠ", "ğŸŒ­", "ğŸŒ¯", "ğŸŒ®", "â˜•", "â›”"], "ê¸°íƒ€": ["â­", "ğŸ”¥", "ğŸ”ª", "â°", "ğŸ”‘", "ğŸ”¨", "ğŸš½", "ğŸš¿", "ğŸ›’", "ğŸŸ ", "ğŸ”´", "ğŸ”˜", "ğŸ›—", "ğŸš¸", "ğŸš«", "ğŸ”", "ğŸš·", "ğŸš±", "ğŸš¯", "ğŸš­", "ğŸš³", "ğŸ”…"], "í–‰ì‚¬": ["ğŸ‚", "ğŸ€", "ğŸ’", "ğŸ¼", "ğŸ¤", "ğŸ§", "ğŸ¹"], "ê¸°í˜¸": ["â“", "â”", "â•", "â—", "âŒ"]};
  const PICKER_CMDS = ["/ì™„ê²°", "/ì¶•í•˜", "/í•˜íŠ¸", "/ë°˜ì§", "/ëˆˆê½ƒ", "/ë°•ìˆ˜", "/í™˜ì˜", "/ê³ ì¶”", "/ë½€ë½€", "/ë¶ì—…", "/ê²½ê³ ", "/ëŒ„ìŠ¤", "/ë§ˆê°", "/ì•ˆë…•", "/êµ¿ë°”ì´", "/ë„ë•", "/ì œë°œ", "/ìˆ˜ì¤", "/í˜„íƒ€", "/ê°ì„±", "/ì˜ê°", "/í‡´ê³ ", "/ë–¡ë°¥", "/ì •ì£¼í–‰", "/ì—°ì¬"];
  const LS_PICKER_FAV = 'SUDABANG_PICKER_FAV_V1';

  function safeGetLS_(k, defVal){
    try{ return localStorage.getItem(k) ?? defVal; }catch(e){ return defVal; }
  }
  function safeSetLS_(k, v){ try{ localStorage.setItem(k, v); }catch(e){} }

  function getFav_(){
    try{
      const raw = safeGetLS_(LS_PICKER_FAV, '[]');
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) return arr.slice(0, 80);
    }catch(e){}
    return [];
  }
  function setFav_(arr){ safeSetLS_(LS_PICKER_FAV, JSON.stringify(arr || [])); }

  function insertAtCursor_(ta, text){
    if (!ta) return;
    ta.focus();
    const start = (ta.selectionStart ?? ta.value.length);
    const end = (ta.selectionEnd ?? ta.value.length);
    const before = ta.value.slice(0, start);
    const after = ta.value.slice(end);
    ta.value = before + text + after;
    const pos = start + text.length;
    ta.setSelectionRange(pos, pos);
    ta.dispatchEvent(new Event('input', { bubbles:true }));
  }

  let pickerActiveTab_ = 'ì´ëª¨ì§€';

  function toggleFav_(e){
    const fav = getFav_();
    const idx = fav.indexOf(e);
    if (idx >= 0) fav.splice(idx, 1);
    else fav.unshift(e);
    setFav_(fav);
  }

  function renderPicker_(){
    const tabs = $('pickerTabs');
    const body = $('pickerBody');
    if (!tabs || !body) return;

    // âœ… ë²„íŠ¼ 3ê°œë§Œ: ì¦ê²¨ì°¾ê¸° / ëª…ë ¹ì–´ / ì´ëª¨ì§€(ì „ì²´)
    const keys = ['ì¦ê²¨ì°¾ê¸°','ëª…ë ¹ì–´','ì´ëª¨ì§€'];
    tabs.innerHTML = '';
    keys.forEach((k)=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'pickerTab' + (k === pickerActiveTab_ ? ' active' : '');
      b.textContent = k;
      b.addEventListener('click', ()=>{ pickerActiveTab_ = k; renderPicker_(); });
      tabs.appendChild(b);
    });

    // âœ… ì „ì²´ ì´ëª¨ì§€(ì¹´í…Œê³ ë¦¬ í•©ì¹˜ê³  ì¤‘ë³µ ì œê±°)
    const allEmoji = (() => {
      const seen = new Set();
      const out = [];
      Object.values(PICKER_EMOJI || {}).forEach(arr=>{
        (arr || []).forEach(e=>{
          const key = String(e);
          if (seen.has(key)) return;
          seen.add(key);
          out.push(e);
        });
      });
      return out;
    })();

    body.innerHTML = '';

    if (pickerActiveTab_ === 'ëª…ë ¹ì–´'){
      const wrap = document.createElement('div');
      wrap.className = 'cmdList';
      PICKER_CMDS.forEach((c)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'cmdBtn';
        b.textContent = c;
        b.addEventListener('click', ()=>{
          insertAtCursor_($('msg'), c + ' ');
          hidePicker_();
        });
        wrap.appendChild(b);
      });
      body.appendChild(wrap);
      return;
    }

    const list = (pickerActiveTab_ === 'ì¦ê²¨ì°¾ê¸°') ? getFav_() : allEmoji;
    const grid = document.createElement('div');
    grid.className = 'pickerGrid';

    (list || []).forEach((e)=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'emoBtn';
      b.textContent = e;
      b.title = 'í´ë¦­=ì‚½ì… Â· ìš°í´ë¦­=ì¦ê²¨ì°¾ê¸° í† ê¸€';
      b.addEventListener('click', ()=>{
        insertAtCursor_($('msg'), e);
        hidePicker_();
      });
      b.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        toggleFav_(e);
        renderPicker_();
      });
      grid.appendChild(b);
    });
    body.appendChild(grid);
  }
function placePicker_(){
    const pop = $('pickerPopover');
    const btn = $('btnPicker');
    if (!pop || !btn) return;

    const r = btn.getBoundingClientRect();
    const w = pop.offsetWidth || Math.min(520, window.innerWidth - 18);
    const h = pop.offsetHeight || 420;

    const idealTop = r.top - h - 10;
    let top = (idealTop > 10) ? idealTop : (r.bottom + 10);
    // âœ… keep inside viewport (í° í™”ë©´/ì‘ì€ í™”ë©´ ëª¨ë‘)
    top = clamp_(top, 10, Math.max(10, window.innerHeight - h - 10));

    const left = clamp_(r.left, 10, window.innerWidth - w - 10);
    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
  }

  function showPicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;

    renderPicker_();
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');

    // âœ… DOM layout ë°˜ì˜ í›„ ìœ„ì¹˜ ê³„ì‚°(ë°°í¬ í™˜ê²½ì—ì„œ ë†’ì´ 0 ë¬¸ì œ ë°©ì§€)
    requestAnimationFrame(()=>{
      placePicker_();
      
    });
  }
  function hidePicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }
  function togglePicker_(){
    const pop = $('pickerPopover');
    if (!pop) return;
    if (pop.classList.contains('show')) hidePicker_();
    else showPicker_();
  }

  function initPicker_(){
    const btn = $('btnPicker');
    if (!btn) return;
    btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); togglePicker_(); });
    $('pickerClose')?.addEventListener('click', (e)=>{ e.preventDefault(); hidePicker_(); });
    document.addEventListener('click', (e)=>{
      try{
        const pop = $('pickerPopover');
        const btn2 = $('btnPicker');
        if (!pop || !btn2) return;
        if (!pop.classList.contains('show')) return;
        if (pop.contains(e.target) || btn2.contains(e.target)) return;
        hidePicker_();
      }catch(err){}
    }, true);

    window.addEventListener('resize', ()=>{ if ($('pickerPopover')?.classList.contains('show')) placePicker_(); });

    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        hideVolPopover_();
        hideLogPopover_();
        hidePicker_();
      }
    });

    pickerActiveTab_ = 'ëª…ë ¹ì–´';
  }



// âœ… SAFETY: delegate overlay tool buttons even if some bindings fail
document.addEventListener('click', (e)=>{
  try{
    const t = e.target;
    if (!t) return;
    if (t.id === 'ovCloseBtn' || t.closest?.('#ovCloseBtn')){
      e.preventDefault(); e.stopPropagation(); hideOverlay(); return;
    }
    if (t.id === 'ovOkBtn' || t.closest?.('#ovOkBtn')){
      e.preventDefault(); e.stopPropagation(); hideOverlay(); return;
    }
  }catch(err){}
}, true);


  // =====================
  // Boot
  // =====================
  (function boot(){
    const run = async ()=>{
      try{ initUi_(); }catch(e){ console.error(e); }
      try{ startBoomCountdown_(); }catch(e){ console.error(e); }
      try{ await verifyGateTicket_(); }catch(e){ console.error(e); stopAll_(); return; }
      try{ schedulePing(200); }catch(e){ console.error(e); }
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
    else run();
  })();


</script>

</body>
</html>
